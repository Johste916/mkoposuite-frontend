import{u as T,r as c,j as e,h as m}from"./index-DYDSVKWX.js";import{g as R}from"./auth-CO9T0zV9.js";const t={wrap:"w-full px-4 md:px-6 lg:px-8 py-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-[var(--muted)]",card:"card overflow-hidden",tableWrap:"table-wrap table-frame relative overflow-x-auto",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide text-[var(--fg)]/90 font-semibold px-3 py-2 border border-[var(--border)] select-none",td:"px-3 py-2 border border-[var(--border)] text-sm text-[var(--fg)]",tdRight:"px-3 py-2 border border-[var(--border)] text-sm text-right tabular-nums text-[var(--fg)]",btn:"inline-flex items-center justify-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--chip-soft)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",primary:"inline-flex items-center justify-center rounded-lg px-3 py-2 font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",stickyTh:"sticky right-0 z-10 bg-[var(--table-head-bg)] border-l-2 border-[var(--border-strong)]",stickyTd:"sticky right-0 z-10 bg-[var(--card)]/95 backdrop-blur border-l-2 border-[var(--border-strong)]"},S=(r,a="TZS")=>`‎${a} ${Number(r||0).toLocaleString()}`,C=r=>r?new Date(r).toLocaleDateString():"—",O=r=>r.ref||r.reference||r.code||`LN-${r.id}`,E=r=>{var a,b;return((a=r.borrower)==null?void 0:a.name)||r.borrowerName||((b=r.Borrower)==null?void 0:b.name)||"—"},z=r=>r.approvedAt||r.approvalDate||r.updatedAt||r.createdAt||null;function U(){var r;try{const a=(r=R)==null?void 0:r();if(a)return String(a).toLowerCase().trim()}catch{}try{const a=JSON.parse(localStorage.getItem("user")||"{}").role;if(a)return String(a).toLowerCase().trim()}catch{}return""}function F(r){const a=String(r||"").toLowerCase().trim();return["admin","superadmin","super admin","systemadmin","system_admin","system admin","director","accountant","finance"].includes(a)}function B(){var w;const r=T(),a=U(),b=F(a),[d,p]=c.useState([]),[g,f]=c.useState(!0),[v,$]=c.useState(null),[y,j]=c.useState(null),[x,N]=c.useState(null),h=async()=>{var s,i,l,o;f(!0),N(null);try{let u;try{const n=await m.get("/loans/disbursements");u=Array.isArray(n.data)?n.data:((s=n.data)==null?void 0:s.items)||((i=n.data)==null?void 0:i.data)||[]}catch{const n=await m.get("/loans",{params:{status:"approved",pageSize:500}});u=Array.isArray(n.data)?n.data:((l=n.data)==null?void 0:l.items)||((o=n.data)==null?void 0:o.data)||[]}const D=(u||[]).filter(n=>String(n.status||"").toLowerCase()==="approved");p(D)}catch(u){console.error(u),N("Failed to load disbursement queue."),p([])}finally{f(!1),$(new Date)}};c.useEffect(()=>{h()},[]);async function k(s){var i,l;j(s);try{try{await m.post(`/loans/${s}/disburse`)}catch{try{await m.patch(`/loans/${s}/status`,{status:"disbursed"})}catch{await m.put(`/loans/${s}/status`,{status:"disbursed"})}}await h(),alert("Loan marked as disbursed.")}catch(o){console.error(o),alert(((l=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:l.error)||"Failed to disburse loan.")}finally{j(null)}}const L=c.useMemo(()=>d.reduce((s,i)=>s+Number(i.amount||0),0),[d]),A=((w=d[0])==null?void 0:w.currency)||"TZS";return e.jsxs("div",{className:t.wrap,children:[e.jsxs("div",{className:"flex items-end justify-between gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:t.h1,children:"Disbursement Queue"}),e.jsx("p",{className:t.sub,children:"Loans awaiting disbursement."}),v&&e.jsxs("p",{className:"text-xs text-[var(--muted)] mt-1",children:["Last updated ",v.toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:h,className:t.btn,title:"Refresh",children:"Refresh"})})]}),e.jsx("div",{className:t.card,children:e.jsx("div",{className:t.tableWrap,children:e.jsxs("table",{className:"min-w-[900px] w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:t.th,children:"Ref"}),e.jsx("th",{className:t.th,children:"Borrower"}),e.jsx("th",{className:t.th,children:"Amount"}),e.jsx("th",{className:t.th,children:"Approved On"}),e.jsx("th",{className:`${t.th} ${t.stickyTh}`,children:"Actions"})]})}),e.jsx("tbody",{children:g?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`${t.td} text-center py-10 text-[var(--muted)]`,children:"Loading…"})}):x?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`${t.td} text-center py-10 text-[var(--muted)]`,children:x})}):d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`${t.td} text-center py-10 text-[var(--muted)]`,children:"Empty"})}):d.map((s,i)=>e.jsxs("tr",{className:`transition-colors ${i%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)]`,children:[e.jsx("td",{className:t.td,children:O(s)}),e.jsx("td",{className:t.td,children:E(s)}),e.jsx("td",{className:t.tdRight,children:S(s.amount,s.currency||"TZS")}),e.jsx("td",{className:t.td,children:C(z(s))}),e.jsx("td",{className:`${t.td} ${t.stickyTd}`,children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:t.btn,onClick:()=>r(`/loans/${s.id}`),children:"View"}),b?e.jsx("button",{className:t.primary,disabled:y===s.id,onClick:()=>k(s.id),title:"Finalize and mark as disbursed",children:y===s.id?"Working…":"Disburse"}):e.jsx("span",{className:"text-[var(--muted)] text-xs",children:"No permission"})]})})]},s.id))}),!g&&!x&&d.length>0&&e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsxs("td",{className:t.td,colSpan:4,children:[d.length.toLocaleString()," ready for disbursement"]}),e.jsxs("td",{className:`${t.td} ${t.stickyTd} text-right`,children:["Total ",S(L,A)]})]})})]})})})]})}export{B as default};

import{u as ne,r as n,j as e,g as S}from"./index-BWN1fagU.js";const s={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-slate-700",card:"rounded-2xl border-2 border-slate-300 bg-white shadow",th:"bg-slate-100 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-2 border-slate-200 select-none",td:"px-3 py-2 border-2 border-slate-200 text-sm",btn:"inline-flex items-center rounded-lg border-2 border-slate-300 px-3 py-2 hover:bg-slate-50 font-semibold",btnPrimary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-3 py-2 font-semibold hover:bg-indigo-700",field:"h-11 w-full rounded-lg border-2 border-slate-300 bg-white text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600"},x=i=>Number(i||0).toLocaleString(),re=({title:i,desc:c,control:u})=>e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border-2 border-slate-300 bg-white px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:i}),c&&e.jsx("p",{className:"text-[12px] text-slate-600",children:c})]}),u]}),K=({status:i})=>{const c=String(i||"").toLowerCase(),u=c==="overdue"?"bg-rose-600 text-white":c==="paid"||c==="closed"?"bg-emerald-100 text-emerald-800 ring-2 ring-emerald-300":c==="partial"?"bg-amber-50 text-amber-800 ring-2 ring-amber-300":"bg-slate-100 text-slate-800 ring-2 ring-slate-300";return e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold capitalize ${u}`,children:i||"—"})},ie=["pending","approved","rejected","disbursed","closed"];function de(){var J;const i=ne(),[c,u]=n.useState(!1),[Q,P]=n.useState(!1),[G,H]=n.useState([]),[W,X]=n.useState([]),[w,D]=n.useState(""),[C,E]=n.useState(""),[f,I]=n.useState("active"),[j,T]=n.useState(""),[b,_]=n.useState("next_30_days"),[g,B]=n.useState(!1),[O,M]=n.useState([]),[N,y]=n.useState(1),[R,Z]=n.useState(0),[v,Y]=n.useState(10),[h,k]=n.useState(!1),[a,ee]=n.useState(null),[z,F]=n.useState([]),[q,U]=n.useState([]),[$,V]=n.useState(!1),o=n.useRef(null),te=15e3,A=n.useMemo(()=>Math.max(1,Math.ceil(Number(R||0)/Number(v||1))),[R,v]),se=async()=>{var t,l;P(!0);try{const[r,d]=await Promise.all([S.get("/branches"),S.get("/users",{params:{role:"loan_officer",pageSize:500}})]);H(Array.isArray(r.data)?r.data:((t=r.data)==null?void 0:t.items)||[]),X(Array.isArray(d.data)?d.data:((l=d.data)==null?void 0:l.items)||[])}catch{}finally{P(!1)}},p=async()=>{u(!0);try{const t={page:N,pageSize:v};w&&(t.branchId=w),C&&(t.officerId=C),j!=null&&j.trim()&&(t.q=j.trim()),b&&b!=="all"&&(t.dueRange=b),!g&&ie.includes(String(f))&&(t.status=f);const{data:l}=await S.get("/loans",{params:t});let r=Array.isArray(l)?l:(l==null?void 0:l.items)||[];if(!g){const d=String(f).toLowerCase();d==="active"?r=r.filter(m=>String(m.status||m.state||"").toLowerCase()==="disbursed"):d==="delinquent"?r=r.filter(m=>String(m.nextDueStatus||"").toLowerCase()==="overdue"||Number(m.dpd||0)>0||Number(m.arrears||0)>0):d==="closed"&&(r=r.filter(m=>String(m.status||"").toLowerCase()==="closed"))}M(r),Z(Number((l==null?void 0:l.total)||r.length||0))}catch{M([]),Z(0)}finally{u(!1)}},L=async t=>{if(t){V(!0);try{const[l,r]=await Promise.all([S.get(`/loans/${t}/schedule`),S.get(`/loans/${t}/repayments`)]);F(Array.isArray(l.data)?l.data:[]),U(Array.isArray(r.data)?r.data:[])}catch{F([]),U([])}finally{V(!1)}}},ae=async t=>{ee(t),k(!0),await L(t.id),o.current&&clearInterval(o.current),o.current=setInterval(()=>{L(t.id)},te)};n.useEffect(()=>(!h&&o.current&&(clearInterval(o.current),o.current=null),()=>{o.current&&(clearInterval(o.current),o.current=null)}),[h]),n.useEffect(()=>{const t=()=>{document.visibilityState==="visible"&&(p(),h&&(a!=null&&a.id)&&L(a.id))};return document.addEventListener("visibilitychange",t),window.addEventListener("focus",t),()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("focus",t)}},[h,a==null?void 0:a.id]),n.useEffect(()=>{const t=l=>{var d;const r=(d=l==null?void 0:l.detail)==null?void 0:d.loanId;p(),h&&(a!=null&&a.id)&&r&&Number(a.id)===Number(r)&&L(r)};return window.addEventListener("repayment:posted",t),()=>window.removeEventListener("repayment:posted",t)},[h,a==null?void 0:a.id]),n.useEffect(()=>{se()},[]),n.useEffect(()=>{p()},[N,v,w,C,f,b,g]);const le=t=>{var l;(l=t==null?void 0:t.preventDefault)==null||l.call(t),y(1),p()};return e.jsxs("div",{className:s.page,children:[e.jsxs("div",{className:`${s.card} p-4 md:p-5 mb-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between`,children:[e.jsxs("div",{children:[e.jsx("h1",{className:s.h1,children:"Repayment Schedule"}),e.jsx("p",{className:s.sub,children:"Browse upcoming installments, see overdue items, and post manual repayments."})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:s.btn,onClick:()=>p(),disabled:c||Q,title:"Refresh list",children:c?"Refreshing…":"Refresh"}),e.jsx("button",{className:s.btn,onClick:()=>i("/repayments/receipts"),title:"Open receipts list",children:"Receipts"}),e.jsx("button",{className:s.btn,onClick:()=>i("/repayments/charts"),title:"Open charts",children:"Charts"}),e.jsx("button",{className:s.btnPrimary,onClick:()=>i("/repayments/new"),children:"Manual Repayment"})]})]}),e.jsxs("div",{className:`${s.card} p-4 md:p-5 mb-6`,children:[e.jsx("h2",{className:"text-xl font-bold tracking-tight mb-3",children:"Filters"}),e.jsxs("form",{onSubmit:le,className:"grid md:grid-cols-6 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-[12px] font-semibold text-slate-600",children:"Search (Borrower / Loan Ref)"}),e.jsx("input",{className:s.field,placeholder:"e.g., Juma / L-000123",value:j,onChange:t=>T(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[12px] font-semibold text-slate-600",children:"Branch"}),e.jsxs("select",{className:s.field,value:w,onChange:t=>D(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),G.map(t=>e.jsx("option",{value:String(t.id),children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[12px] font-semibold text-slate-600",children:"Loan Officer"}),e.jsxs("select",{className:s.field,value:C,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),W.map(t=>e.jsx("option",{value:String(t.id),children:t.name||`${t.firstName||""} ${t.lastName||""}`.trim()||t.email},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[12px] font-semibold text-slate-600",children:"Due Range"}),e.jsxs("select",{className:s.field,value:b,onChange:t=>_(t.target.value),children:[e.jsx("option",{value:"next_7_days",children:"Next 7 days"}),e.jsx("option",{value:"next_30_days",children:"Next 30 days"}),e.jsx("option",{value:"overdue",children:"Overdue only"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{className:`${g?"opacity-60 pointer-events-none":""}`,children:[e.jsx("label",{className:"text-[12px] font-semibold text-slate-600",children:"Status"}),e.jsxs("select",{className:s.field,value:f,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"delinquent",children:"Delinquent"}),e.jsx("option",{value:"closed",children:"Closed"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(re,{title:"Include Closed",control:e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",className:"h-5 w-5",checked:g,onChange:t=>B(t.target.checked)})})})}),e.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2 pt-1",children:[e.jsx("button",{type:"button",className:s.btn,onClick:()=>{D(""),E(""),I("active"),_("next_30_days"),B(!1),T(""),y(1),p()},children:"Reset"}),e.jsx("button",{type:"submit",className:s.btnPrimary,children:"Search"})]})]})]}),e.jsxs("div",{className:`${s.card} p-4 md:p-5 space-y-4`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold tracking-tight",children:"Loans"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-slate-700",children:"Page size"}),e.jsx("select",{className:"h-9 rounded-lg border-2 border-slate-300 bg-white px-2 text-sm outline-none",value:String(v),onChange:t=>{Y(Number(t.target.value)),y(1)},children:[10,20,50].map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm border-separate border-spacing-0",children:[e.jsx("thead",{children:e.jsx("tr",{children:["Loan Ref","Borrower","Outstanding","Next Due","Officer","Status","Actions"].map((t,l)=>e.jsx("th",{className:`${s.th} ${l===6?"text-right":""}`,children:t},t))})}),e.jsxs("tbody",{children:[!c&&O.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:`${s.td} text-center py-10 text-slate-600`,children:"No loans found."})}),O.map(t=>{var l,r;return e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:s.td,children:t.reference||`L-${t.id}`}),e.jsx("td",{className:s.td,children:t.borrowerName||((l=t.Borrower)==null?void 0:l.name)}),e.jsxs("td",{className:s.td,children:[t.currency||"TZS"," ",x(t.outstanding??t.balance??0)]}),e.jsx("td",{className:s.td,children:t.nextDueDate?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.nextDueDate}),t.nextDueStatus&&e.jsx(K,{status:t.nextDueStatus})]}):"—"}),e.jsx("td",{className:s.td,children:t.officerName||((r=t.officer)==null?void 0:r.name)||"—"}),e.jsx("td",{className:s.td,children:t.state||t.status||"active"}),e.jsx("td",{className:`${s.td} text-right`,children:e.jsxs("div",{className:"inline-flex gap-2",children:[e.jsx("button",{className:s.btn,onClick:()=>ae(t),children:"View Schedule"}),e.jsx("button",{className:s.btnPrimary,onClick:()=>i(`/repayments/new?loanId=${t.id}`),children:"Add Repayment"})]})})]},t.id)}),c&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:`${s.td} py-8 text-center text-slate-600`,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between px-1 py-2 border-t-2 border-slate-300",children:[e.jsxs("p",{className:"text-sm text-slate-700",children:["Page ",N," of ",A," • ",R," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:`${s.btn} disabled:opacity-60`,disabled:N<=1,onClick:()=>y(t=>Math.max(1,t-1)),children:"Prev"}),e.jsx("button",{className:`${s.btn} disabled:opacity-60`,disabled:N>=A,onClick:()=>y(t=>Math.min(A,t+1)),children:"Next"})]})]})]}),h&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>k(!1)}),e.jsxs("div",{className:"absolute inset-y-0 right-0 w-full sm:max-w-3xl bg-white shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b-2 border-slate-300",children:[e.jsx("h3",{className:"text-xl font-bold tracking-tight",children:"Loan Schedule"}),e.jsx("button",{className:s.btn,onClick:()=>k(!1),children:"Close"})]}),a?e.jsxs("div",{className:"p-4 md:p-5 space-y-5",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold tracking-tight",children:a.reference||`L-${a.id}`}),e.jsxs("p",{className:"text-sm text-slate-700",children:[a.borrowerName||((J=a.Borrower)==null?void 0:J.name)," •"," ",a.currency||"TZS"," ",x(a.principal||a.amount||0)]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("button",{className:s.btnPrimary,onClick:()=>i(`/repayments/new?loanId=${a.id}`),children:"Add Repayment"}),e.jsx("button",{className:s.btn,onClick:()=>window.open(`/loans/${a.id}`,"_blank"),children:"Open Loan"})]})]}),e.jsxs("div",{className:`${s.card} p-3 md:p-4`,children:[e.jsx("h5",{className:"font-semibold mb-2",children:"Installments"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm border-separate border-spacing-0",children:[e.jsx("thead",{children:e.jsx("tr",{children:["#","Due Date","Principal","Interest","Fees","Total","Paid","Penalty","Status"].map(t=>e.jsx("th",{className:s.th,children:t},t))})}),e.jsxs("tbody",{children:[$&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:`${s.td} text-center py-8 text-slate-600`,children:"Loading…"})}),!$&&z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:`${s.td} text-center py-8 text-slate-600`,children:"No schedule entries."})}),z.map((t,l)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:s.td,children:t.period??l+1}),e.jsx("td",{className:s.td,children:t.dueDate}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.principal)}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.interest)}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.fees)}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.total)}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.paid)}),e.jsx("td",{className:s.td,children:t.penalty?`${a.currency||"TZS"} ${x(t.penalty)}`:"—"}),e.jsx("td",{className:s.td,children:e.jsx(K,{status:t.status||"upcoming"})})]},`${t.period}-${t.dueDate}`))]})]})})]}),e.jsxs("div",{className:`${s.card} p-3 md:p-4`,children:[e.jsx("h5",{className:"font-semibold mb-2",children:"Repayments"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm border-separate border-spacing-0",children:[e.jsx("thead",{children:e.jsx("tr",{children:["Date","Amount","Method","Reference","Posted By"].map(t=>e.jsx("th",{className:s.th,children:t},t))})}),e.jsxs("tbody",{children:[$&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`${s.td} text-center py-8 text-slate-600`,children:"Loading…"})}),!$&&q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`${s.td} text-center py-8 text-slate-600`,children:"No repayments yet."})}),q.map(t=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:s.td,children:t.date}),e.jsx("td",{className:s.td,children:(a.currency||"TZS")+" "+x(t.amount||0)}),e.jsx("td",{className:s.td,children:t.method||"—"}),e.jsx("td",{className:s.td,children:t.ref||t.reference||"—"}),e.jsx("td",{className:s.td,children:t.postedBy||"—"})]},t.id))]})]})})]})]}):e.jsx("div",{className:"p-4 text-sm text-slate-600",children:"No loan selected."})]})]})]})}export{de as default};

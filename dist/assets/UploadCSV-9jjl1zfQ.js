import{r as v,j as e,g as $}from"./index-DUtn1vUj.js";function H(l){const u=[];let a=[],s="",h=!1;for(let t=0;t<l.length;t+=1){const r=l[t];h?r==='"'?l[t+1]==='"'?(s+='"',t+=1):h=!1:s+=r:r==='"'?h=!0:r===","?(a.push(s),s=""):r===`
`?(a.push(s),u.push(a),a=[],s=""):r==="\r"?(l[t+1]===`
`&&(t+=1),a.push(s),u.push(a),a=[],s=""):s+=r}if((s.length>0||a.length>0)&&(a.push(s),u.push(a)),!u.length)return{headers:[],rows:[]};const b=u[0].map(t=>String(t||"").trim()),m=u.slice(1).filter(t=>t.some(r=>String(r||"").trim().length));return{headers:b,rows:m}}const q=new Set(["deposit","withdrawal","charge","interest"]);function Q(l){return String(l||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"")}function Y(l,u){const a=l.map(Q),s=(...k)=>{for(const L of k){const I=a.indexOf(L);if(I!==-1)return u[I]}},h=s("borrowerid","borrower_id","borrower"),b=String(s("type","trx_type")||"").toLowerCase(),m=s("amount","amt","value","total"),t=s("date","trx_date","transaction_date"),r=s("notes","note","description","memo"),w=String(s("reversed","is_reversed")||"").toLowerCase(),g=h?Number(String(h).trim()):null,S=q.has(b)?b:null;let N=null;if(m!=null&&String(m).trim().length){const k=String(m).replace(/,/g,"");N=Number(k)}const R=t?String(t).slice(0,10):null,V=r?String(r):null;return{borrowerId:g,type:S,amount:N,date:R,notes:V,reversed:w==="true"||w==="1"||w==="yes"}}function J(){var P;const[l,u]=v.useState(null),[a,s]=v.useState([]),[h,b]=v.useState([]),[m,t]=v.useState(""),[r,w]=v.useState(!1),[g,S]=v.useState(null),N=v.useMemo(()=>!!l&&!r,[l,r]),R=async o=>{var x;t(""),b([]),s([]),S(null);const n=((x=o.target.files)==null?void 0:x[0])||null;if(u(n),!!n)try{const i=await n.text(),{headers:f,rows:p}=H(i);if(!f.length){t("No headers found in CSV.");return}b(f),s(p.slice(0,10))}catch(i){t((i==null?void 0:i.message)||"Failed to read CSV.")}},V=async o=>{if(o.preventDefault(),!!l){w(!0),S(null),t("");try{const n=await l.text(),{headers:x,rows:i}=H(n);if(!x.length||!i.length){t("CSV appears to be empty."),w(!1);return}const f=i.map(c=>Y(x,c)),p=[],C=[];for(let c=0;c<f.length;c+=1){const d=f[c],j=[];if(d.borrowerId||j.push("borrowerId"),d.type||j.push("type"),Number.isFinite(d.amount)&&d.amount>0||j.push("amount"),d.date||j.push("date"),j.length){C.push({index:c+2,reason:`Missing/invalid: ${j.join(", ")}`});continue}p.push({borrowerId:d.borrowerId,type:d.type,amount:d.amount,date:d.date,notes:d.notes||null,...d.reversed?{reversed:!0}:{}})}const _=25,F=[],U=[];for(let c=0;c<p.length;c+=_){const d=p.slice(c,c+_);(await Promise.allSettled(d.map(y=>$._post("/savings-transactions",y)))).forEach((y,T)=>{var A,D,M,z,B;if(y.status==="fulfilled")F.push(c+T);else{const O=((M=(D=(A=y.reason)==null?void 0:A.response)==null?void 0:D.data)==null?void 0:M.error)||((z=y.reason)==null?void 0:z.normalizedMessage)||((B=y.reason)==null?void 0:B.message)||"Failed";U.push({index:c+T,reason:O})}})}S({inserted:F.length,failed:U.length+C.length,rejects:C.concat(U)})}catch(n){t((n==null?void 0:n.message)||"Failed to process CSV.")}finally{w(!1)}}},E=()=>{const o=["borrowerId","type","amount","date","notes"],n=[["101","deposit","5000","2025-08-01","opening balance"],["101","withdrawal","1000","2025-08-03",""],["102","interest","55.75","2025-08-05","monthly interest"],["102","charge","10","2025-08-05","ledger fee"]],x=o.join(",")+`
`+n.map(C=>C.map(_=>`"${String(_).replace(/"/g,'""')}"`).join(",")).join(`
`),i=new Blob([x],{type:"text/csv;charset=utf-8"}),f=URL.createObjectURL(i),p=document.createElement("a");p.href=f,p.download="savings_transactions_template.csv",p.click(),URL.revokeObjectURL(f)};return e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow p-4",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Upload Savings Transactions (CSV)"}),e.jsxs("p",{className:"text-xs opacity-70",children:["Allowed types: ",e.jsx("code",{children:"deposit"}),", ",e.jsx("code",{children:"withdrawal"}),", ",e.jsx("code",{children:"charge"}),", ",e.jsx("code",{children:"interest"}),". Required columns: ",e.jsx("code",{children:"borrowerId"}),", ",e.jsx("code",{children:"type"}),", ",e.jsx("code",{children:"amount"}),", ",e.jsx("code",{children:"date"}),"."]})]}),e.jsx("button",{type:"button",onClick:E,className:"px-3 py-2 rounded bg-slate-700 text-white hover:bg-slate-800 text-sm",children:"Download template"})]}),m?e.jsxs("div",{className:"mb-3 text-sm text-rose-600 dark:text-rose-300",children:["Error: ",String(m)]}):null,e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"CSV file"}),e.jsx("input",{type:"file",accept:".csv,text/csv",className:"w-full px-3 py-2 border rounded-md dark:bg-slate-700 dark:border-slate-600",onChange:R})]}),h.length?e.jsx("div",{className:"border rounded-md overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-700",children:e.jsx("tr",{children:h.map(o=>e.jsx("th",{className:"px-2 py-1 border-b text-left",children:o},o))})}),e.jsx("tbody",{children:a.map((o,n)=>e.jsx("tr",{className:"odd:bg-white even:bg-slate-50/40 dark:odd:bg-slate-800 dark:even:bg-slate-700/40",children:h.map((x,i)=>e.jsx("td",{className:"px-2 py-1 border-b",children:o[i]??""},i))},n))})]})}):null,e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{type:"submit",disabled:!N,className:`px-4 py-2 rounded text-white ${N?"bg-blue-600 hover:bg-blue-700":"bg-blue-300 cursor-not-allowed"}`,children:r?"Uploading…":"Upload CSV"})})]}),g?e.jsxs("div",{className:"mt-4 text-sm",children:[e.jsxs("div",{className:"mb-1",children:["Inserted: ",e.jsx("b",{children:g.inserted})]}),e.jsxs("div",{className:"mb-2",children:["Failed: ",e.jsx("b",{children:g.failed})]}),(P=g.rejects)!=null&&P.length?e.jsxs("details",{className:"mt-2",children:[e.jsx("summary",{className:"cursor-pointer",children:"View errors"}),e.jsxs("ul",{className:"mt-2 list-disc pl-5 space-y-1",children:[g.rejects.slice(0,150).map((o,n)=>e.jsxs("li",{children:["Row ",o.index,": ",o.reason]},n)),g.rejects.length>150?e.jsx("li",{children:"…and more"}):null]})]}):null]}):null]})}export{J as default};

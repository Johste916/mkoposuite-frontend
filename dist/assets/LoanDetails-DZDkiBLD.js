import{i as rt,u as lt,r as i,j as e,L as ee,g as d}from"./index-DFbhZsgs.js";const m=(n,x="TZS")=>`‎${x} ${Number(n||0).toLocaleString()}`,z=n=>n?new Date(n).toLocaleDateString():"N/A",it=n=>n?new Date(n).toLocaleString():"",Ae=n=>{if(!n)return"";const x=new Date(n);return Number.isNaN(x.getTime())?String(n).slice(0,10):x.toISOString().slice(0,10)},dt={pending:"bg-yellow-100 text-yellow-800 ring-yellow-200",approved:"bg-blue-100 text-blue-800 ring-blue-200",rejected:"bg-gray-200 text-gray-700 ring-gray-300",disbursed:"bg-indigo-100 text-indigo-800 ring-indigo-200",active:"bg-emerald-100 text-emerald-800 ring-emerald-200",closed:"bg-slate-200 text-slate-700 ring-slate-300"},$e="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold ring-1 ring-inset",Ee="inline-flex items-center gap-1 text-blue-700 font-semibold underline underline-offset-4 decoration-2 hover:text-blue-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 rounded",ot=()=>{try{return(JSON.parse(localStorage.getItem("user")||"{}").role||"").toLowerCase()}catch{return""}},A=n=>n==="admin"||n==="director"||n==="superadmin",ct=n=>["branch_manager","manager","bm"].includes(n)||A(n),mt=n=>["compliance","compliance_officer","legal"].includes(n)||A(n),xt=n=>["accountant","finance"].includes(n)||A(n),ut=n=>["loan_officer","officer"].includes(n)&&!A(n);function pt(n){if(!n)return"";const x=String(n).toLowerCase();return x==="pending"?"submitted":x==="approved"?"accounting":""}function ht(n=[],x=0){let s=Number(x||0),k=0,o=0,$=0,h=0;for(const y of n){const W=Number(y.fee??y.fees??0),R=Number(y.penalty??0),f=Number(y.interest??0),D=Number(y.principal??0);if(s<=0)break;const U=Math.min(s,W);if(h+=U,s-=U,s<=0)break;const E=Math.min(s,R);if($+=E,s-=E,s<=0)break;const Z=Math.min(s,f);if(o+=Z,s-=Z,s<=0)break;const O=Math.min(s,D);k+=O,s-=O}return{paidPrincipal:k,paidInterest:o,paidPenalty:$,paidFees:h}}const te=({title:n,subtitle:x,right:s,children:k,dense:o=!1})=>e.jsxs("div",{className:"bg-white border-2 border-slate-300 rounded-2xl shadow-md",children:[e.jsxs("div",{className:`px-6 ${o?"py-3":"py-4"} border-b-2 border-slate-200 bg-slate-50 flex items-center justify-between`,children:[e.jsxs("div",{children:[n&&e.jsx("h3",{className:"text-lg md:text-xl font-semibold tracking-tight",children:n}),x&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:x})]}),s]}),e.jsx("div",{className:`px-6 ${o?"py-4":"py-6"} text-[15px]`,children:k})]}),w=({children:n})=>e.jsx("div",{className:"text-[12px] uppercase tracking-wide text-gray-600",children:n});function yt(){var ke;const{id:n}=rt(),x=lt(),[s,k]=i.useState(null),[o,$]=i.useState(null),[h,y]=i.useState([]),[W,R]=i.useState([]),[f,D]=i.useState(null),[U,E]=i.useState(!0),[Z,O]=i.useState(!0),[Oe,oe]=i.useState(!0),[Ie,ce]=i.useState(!1),[me,xe]=i.useState(null),[u,I]=i.useState(""),[L,ue]=i.useState(""),[g,V]=i.useState(!1),[se,ae]=i.useState(""),[Te,J]=i.useState(!1),[pe,he]=i.useState(!1),[M,T]=i.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[_e,ne]=i.useState(!1),[Be,G]=i.useState(!1),[p,_]=i.useState({amount:"",interestRate:"",termMonths:"",startDate:""}),[ge,be]=i.useState(!1),[qe,H]=i.useState(!1),[j,K]=i.useState({termMonths:"",startDate:"",previewOnly:!1}),[ye,fe]=i.useState(!1),c=(s==null?void 0:s.currency)||"TZS",ze=dt[s==null?void 0:s.status]||"bg-slate-100 text-slate-800 ring-slate-200",P=ot(),re=ct(P),je=mt(P),We=xt(P),Ue=ut(P),Ze=A(P)||re||je,Ve=A(P)||re,F=(s==null?void 0:s.workflowStage)||pt(s==null?void 0:s.status),Ne=Ue&&["changes_requested","bm_changes_requested","compliance_changes_requested","returned_to_officer","request_changes"].includes(F),Q=re&&["submitted","bm_review","changes_resubmitted"].includes(F),ve=je&&["compliance","compliance_review"].includes(F),we=We&&((s==null?void 0:s.status)==="approved"||F==="accounting"),Se=i.useRef(null),b=async()=>{E(!0),xe(null);try{const{data:t}=await d.get(`/loans/${n}`);k(t),ue(String((t==null?void 0:t.amount)??""));const a=[d.get(`/repayments/loan/${n}`).then(l=>y(l.data||[])).catch(()=>y([])).finally(()=>O(!1)),d.get(`/comments/loan/${n}`).then(l=>R(Array.isArray(l.data)?l.data:[])).catch(l=>{var r;console.warn("Comments fetch failed:",((r=l==null?void 0:l.response)==null?void 0:r.data)||(l==null?void 0:l.message)),R([])}).finally(()=>oe(!1))];t!=null&&t.productId&&a.push(d.get(`/loan-products/${t.productId}`).then(l=>$(l.data)).catch(()=>$(null))),ce(!0),a.push(d.get(`/loans/${n}/schedule`).then(l=>D(l.data||null)).catch(()=>D(null)).finally(()=>ce(!1))),await Promise.all(a)}catch(t){console.error(t),xe("Failed to fetch loan.")}finally{E(!1)}};i.useEffect(()=>{Se.current!==n&&(Se.current=n,D(null),I(""),ae(""),O(!0),oe(!0),b())},[n]),i.useEffect(()=>{const t=()=>b();return window.addEventListener("focus",t),()=>window.removeEventListener("focus",t)},[]),i.useEffect(()=>{const t=a=>{var l;String((l=a==null?void 0:a.detail)==null?void 0:l.id)===String(n)&&b()};return window.addEventListener("loan:updated",t),()=>window.removeEventListener("loan:updated",t)},[n]);async function B(t){try{await d.post("/comments",{loanId:n,content:t});const a=await d.get(`/comments/loan/${n}`);R(Array.isArray(a.data)?a.data:[])}catch{}}async function X(t,a={}){V(!0);try{await d.post(`/loans/${n}/workflow`,{action:t,comment:(u==null?void 0:u.trim())||void 0,suggestedAmount:a.suggestedAmount!=null&&a.suggestedAmount!==""?Number(a.suggestedAmount):void 0}),await b(),I(""),alert("Action applied.")}catch{try{t==="bm_approve"||t==="compliance_approve"?(await d.patch(`/loans/${n}/status`,{status:"approved"}),u.trim()&&await B(u.trim())):t==="reject"?(await d.patch(`/loans/${n}/status`,{status:"rejected"}),u.trim()&&await B(u.trim())):t==="request_changes"?u.trim()&&await B(`Changes requested: ${u.trim()}`):t==="resubmit"&&(await d.patch(`/loans/${n}/status`,{status:"pending"}),u.trim()&&await B(`Resubmitted: ${u.trim()}`)),await b(),I(""),alert("Action applied (fallback).")}catch(r){console.error(r),alert("Failed to apply action.")}}finally{V(!1)}}async function Je(){if(!L||Number(L)<=0){alert("Enter a valid amount.");return}V(!0);try{await d.patch(`/loans/${n}`,{amount:Number(L)}),u.trim()&&await B(`Suggested amount: ${m(L,c)} — ${u.trim()}`),await b(),alert("Suggestion saved.")}catch(t){console.error(t),alert("Failed to save suggestion.")}finally{V(!1)}}const Ge=async()=>{const t=(s==null?void 0:s.outstanding)??0;if(!(t>0&&!window.confirm("Outstanding > 0. Close anyway?")))try{await d.patch(`/loans/${n}/status`,{status:"closed",override:t>0}),await b(),alert("Loan closed.")}catch(a){console.error(a),alert("Failed to close loan.")}},He=async()=>{if(se.trim())try{const t=await d.post("/comments",{loanId:n,content:se});R(a=>[t.data,...a]),ae("")}catch(t){console.error(t),alert("Failed to add comment.")}},Ke=async()=>{const t=Number(M.amount);if(!t||t<=0)return alert("Enter a valid amount.");he(!0);try{if(await d.post("/repayments",{loanId:n,...M,amount:t}),s!=null&&s.status&&!["active","closed"].includes(String(s.status).toLowerCase()))try{await d.patch(`/loans/${n}/status`,{status:"active"})}catch{}await b(),J(!1),T({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:n}})),alert("Repayment posted.")}catch(a){console.error(a),alert("Failed to post repayment.")}finally{he(!1)}},Qe=()=>{_({amount:(s==null?void 0:s.amount)??"",interestRate:(s==null?void 0:s.interestRate)??"",termMonths:(s==null?void 0:s.termMonths)??(s==null?void 0:s.durationMonths)??"",startDate:Ae((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate))}),G(!0)},Xe=async()=>{var a,l;const t={amount:p.amount===""?void 0:Number(p.amount),interestRate:p.interestRate===""?void 0:Number(p.interestRate),termMonths:p.termMonths===""?void 0:Number(p.termMonths),startDate:p.startDate||void 0};if(Number.isFinite(t.amount)&&t.amount<=0)return alert("Amount must be > 0");if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");be(!0);try{await d.patch(`/loans/${n}`,t),G(!1),await b(),alert("Loan updated.")}catch(r){console.error(r),alert(((l=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to update loan.")}finally{be(!1)}},Ye=async()=>{var t,a;if(window.confirm("This will permanently delete this loan. Continue?"))try{await d.delete(`/loans/${n}`),alert("Loan deleted."),x("/loans")}catch(l){console.error(l),alert(((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to delete loan.")}},et=()=>{K({termMonths:(s==null?void 0:s.termMonths)??"",startDate:Ae((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate)),previewOnly:!1}),H(!0)},tt=async()=>{var a,l;const t={termMonths:j.termMonths===""?void 0:Number(j.termMonths),startDate:j.startDate||void 0,previewOnly:!!j.previewOnly};if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");fe(!0);try{const{data:r}=await d.post(`/loans/${n}/reschedule`,t);Array.isArray(r==null?void 0:r.schedule)&&D(r.schedule),H(!1),await b(),alert((r==null?void 0:r.message)||"Schedule updated.")}catch(r){console.error(r),alert(((l=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to reschedule.")}finally{fe(!1)}},st=async()=>{var t,a,l;if(window.confirm("Reissue creates a new pending loan cloned from this one. Continue?"))try{const{data:r}=await d.post(`/loans/${n}/reissue`),q=((t=r==null?void 0:r.loan)==null?void 0:t.id)||(r==null?void 0:r.id);alert("New loan created."),q&&x(`/loans/${q}`)}catch(r){console.error(r),alert(((l=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to reissue loan.")}},N=i.useMemo(()=>{const t=Array.isArray(f)?f:[],a=v=>t.reduce((ie,de)=>ie+Number((de==null?void 0:de[v])||0),0),l=a("principal"),r=a("interest"),q=a("penalty"),Re=a("fee")+a("fees"),De=a("total")||l+r+q+Re,le=h.reduce((v,ie)=>v+Number(ie.amount||0),0),Le=a("paidPrincipal")||0,Me=a("paidInterest")||0,Pe=a("paidPenalty")||0,Fe=a("paidFees")+a("paidFee")||0,at=Le+Me+Pe+Fe>0?{paidPrincipal:Le,paidInterest:Me,paidPenalty:Pe,paidFees:Fe}:ht(t,le),nt=Math.max(De-le,0),C=t.find(v=>v.paid||v.settled?!1:Number(v.balance??Number(v.total||0))>0)||null;return{principal:l,interest:r,penalty:q,fees:Re,total:De,totalPaid:le,outstanding:nt,...at,nextDue:C?{idx:C.installment??C.period??t.indexOf(C)+1,date:C.dueDate||C.date||null,amount:Number(C.total??0)}:null}},[f,h]),Ce=(s==null?void 0:s.outstanding)??N.outstanding??null,S=N.nextDue,Y=i.useMemo(()=>{const t=h.length||0,a=h.reduce((l,r)=>l+Number(r.amount||0),0);return{count:t,sum:a}},[h]);return U?e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6",children:"Loading loan…"}):me?e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6 text-red-600",children:me}):s?e.jsxs("div",{className:"max-w-screen-2xl mx-auto px-6 py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Loan Details"}),e.jsx("span",{className:`${$e} ${ze}`,children:s.status}),F&&e.jsxs("span",{className:`${$e} bg-indigo-50 text-indigo-700 ring-indigo-200`,children:["Stage: ",F.replaceAll("_"," ")]})]}),e.jsx("button",{onClick:()=>x(-1),className:Ee,children:"← Back"})]}),e.jsxs(te,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx(w,{children:"Borrower"}),e.jsxs(ee,{className:`${Ee} text-lg md:text-xl`,to:`/borrowers/${s.borrowerId}`,children:[((ke=s.Borrower)==null?void 0:ke.name)||s.borrowerName||"N/A"," ",e.jsx("span",{children:"›"})]})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Amount"}),e.jsx("div",{className:"text-2xl font-semibold",children:m(s.amount,c)})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Interest"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-medium",children:[s.interestRate,"%"]})," ",e.jsxs("span",{className:"text-gray-600",children:["· ",s.interestMethod]})]})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Term"}),e.jsxs("div",{className:"text-base",children:[s.termMonths||s.durationMonths," months"]})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Start / Release"}),e.jsx("div",{className:"text-base",children:z(s.startDate||s.releaseDate)})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Outstanding"}),e.jsx("div",{className:"text-2xl font-semibold",children:Ce==null?"—":m(Ce,c)})]}),e.jsxs("div",{children:[e.jsx(w,{children:"Next Due"}),e.jsx("div",{className:"text-base",children:S?e.jsxs(e.Fragment,{children:[z(S.date)," ·"," ",e.jsx("span",{className:"font-medium",children:m(S.amount,c)})]}):"—"})]}),o&&e.jsxs("div",{className:"md:col-span-2 lg:col-span-3 xl:col-span-4",children:[e.jsx(w,{children:"Product"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-semibold",children:[o.name,o.code?` (${o.code})`:""]}),e.jsxs("div",{className:"text-gray-600 text-sm",children:["Defaults: ",o.interestMethod," @"," ",o.interestRate??o.defaultInterestRate,"% · Limits:"," ",m(o.minPrincipal,c)," –"," ",m(o.maxPrincipal,c),","," ",o.minTermMonths,"-",o.maxTermMonths," months"]})]})]})]}),e.jsx("div",{className:"mt-6 grid sm:grid-cols-3 lg:grid-cols-6 gap-4 text-sm",children:[["Paid Principal",N.paidPrincipal],["Paid Interest",N.paidInterest],["Paid Penalties",N.paidPenalty],["Paid Fees",N.paidFees],["Total Paid",N.totalPaid],["Total Scheduled",N.total]].map(([t,a])=>e.jsxs("div",{className:"rounded-xl border-2 border-slate-200 p-3",children:[e.jsx("div",{className:"text-gray-500 text-[12px]",children:t}),e.jsx("div",{className:"font-semibold text-base",children:m(a,c)})]},t))})]}),(Ne||Q||ve||we)&&e.jsxs(te,{dense:!0,children:[Ne&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Changes Requested"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Update the application and attach missing documents, then ",e.jsx("strong",{children:"Resubmit"}),". Add a short note if helpful."]}),e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment (optional)"}),e.jsx("textarea",{value:u,onChange:t=>I(t.target.value),className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"What did you fix / add?"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>X("resubmit"),disabled:g,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",title:"Send for review again",children:g?"Submitting…":"Resubmit for Review"}),e.jsx(ee,{to:"/loans/applications",className:"px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",title:"Open applications to edit details/attachments",children:"Edit Application"})]})]}),(Q||ve)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-semibold",children:Q?"Branch Manager Review":"Compliance Review"})}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Suggested Principal"}),e.jsx("input",{type:"number",className:"border rounded-lg px-3 py-2 w-full",value:L,onChange:t=>ue(t.target.value),min:"0",step:"0.01"}),e.jsx("p",{className:"text-[11px] text-gray-500 mt-1",children:"Save a suggestion or approve with a different amount."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment"}),e.jsx("textarea",{className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"Why approving / changes / rejection?",value:u,onChange:t=>I(t.target.value)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>X(Q?"bm_approve":"compliance_approve",{suggestedAmount:L}),disabled:g,className:"bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 disabled:opacity-60",children:g?"Working…":"Approve"}),e.jsx("button",{onClick:()=>X("request_changes"),disabled:g,className:"bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 disabled:opacity-60",title:"Send back to Loan Officer with requested changes",children:g?"Working…":"Request Changes"}),e.jsx("button",{onClick:()=>X("reject"),disabled:g,className:"bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 disabled:opacity-60",children:g?"Working…":"Reject"}),e.jsx("button",{onClick:Je,disabled:g,className:"px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50 disabled:opacity-60",children:g?"Saving…":"Save Suggestion"})]})]}),we&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"This loan is approved. Proceed to disbursement to finalize payout."}),e.jsx(ee,{to:`/loans/${n}/disburse`,className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700",children:"Disburse"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 md:gap-3",children:[e.jsx(ee,{to:"/loans",className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Back to Loans"}),e.jsx("button",{onClick:()=>ne(!0),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"View Schedule"}),e.jsx("a",{href:`/api/loans/${n}/schedule/export.csv`,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",target:"_blank",rel:"noreferrer",children:"Export CSV"}),e.jsx("a",{href:`/api/loans/${n}/schedule/export.pdf`,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",target:"_blank",rel:"noreferrer",children:"Export PDF"}),e.jsx("button",{onClick:()=>J(!0),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Post Repayment"}),Ze&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Qe,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Edit Loan"}),e.jsx("button",{onClick:et,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Reschedule"})]}),e.jsx("button",{onClick:st,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Reissue"}),Ve&&e.jsx("button",{onClick:Ye,className:"bg-red-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-700",children:"Delete"}),s.status!=="closed"&&e.jsx("button",{onClick:Ge,className:"bg-red-50 text-red-700 px-3 md:px-4 py-2 rounded-lg border-2 border-red-200 hover:bg-red-100",children:"Close Loan"})]}),e.jsx(te,{title:"Repayments",right:e.jsxs("div",{className:"text-xs text-gray-500",children:[Y.count," record",Y.count===1?"":"s"," · Total"," ",e.jsx("span",{className:"font-semibold",children:m(Y.sum,c)})]}),children:Z?e.jsx("p",{children:"Loading repayments…"}):h.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"No repayments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-base",children:[e.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10",children:e.jsxs("tr",{className:"text-left",children:[e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"#"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Date"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Amount"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Method"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Notes"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:h.map((t,a)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:a+1}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:z(t.date)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.amount,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-700 ring-1 ring-slate-200",children:t.method||"—"})}),e.jsx("td",{className:"px-3 py-2",children:t.notes||"—"})]},t.id||a))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-slate-50",children:[e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200 text-sm font-medium",colSpan:2,children:"Total"}),e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200 text-right text-base font-semibold",children:m(Y.sum,c)}),e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200",colSpan:2})]})})]})})}),e.jsxs(te,{title:"Comments",children:[Oe?e.jsx("p",{children:"Loading comments…"}):W.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-72 overflow-auto pr-1",children:W.map((t,a)=>{var l,r;return e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-semibold select-none",children:(((l=t.author)==null?void 0:l.name)||"U").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"flex-1 border-b pb-2",children:[e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{className:"font-medium text-gray-700",children:((r=t.author)==null?void 0:r.name)||"User"}),e.jsx("span",{children:it(t.createdAt)})]}),e.jsx("p",{className:"text-sm mt-0.5",children:t.content})]})]},t.id||a)})}),e.jsxs("div",{className:"mt-4 flex items-start gap-2",children:[e.jsx("textarea",{value:se,onChange:t=>ae(t.target.value),className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"Add a comment"}),e.jsx("button",{onClick:He,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Post"})]})]}),Te&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Post Repayment"}),e.jsx("button",{onClick:()=>J(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:M.amount,onChange:t=>T(a=>({...a,amount:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Date"}),e.jsx("input",{type:"date",value:M.date,onChange:t=>T(a=>({...a,date:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Method"}),e.jsxs("select",{value:M.method,onChange:t=>T(a=>({...a,method:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:M.notes,onChange:t=>T(a=>({...a,notes:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",placeholder:"Receipt no., reference, etc."})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>J(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:Ke,disabled:pe,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",children:pe?"Posting…":"Post"})]})]})}),_e&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-5xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Repayment Schedule"}),e.jsx("button",{onClick:()=>ne(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),Ie?e.jsx("p",{children:"Loading schedule…"}):!Array.isArray(f)||f.length===0?e.jsx("p",{children:"No schedule available."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 text-sm text-gray-600",children:["Next installment: ",S?e.jsxs(e.Fragment,{children:[e.jsxs("b",{children:["#",S.idx]})," on ",z(S.date)," — ",e.jsx("b",{children:m(S.amount,c)})]}):"—"]}),e.jsx("div",{className:"max-h-[70vh] overflow-auto",children:e.jsxs("table",{className:"min-w-full text-base",children:[e.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10",children:e.jsxs("tr",{className:"text-left",children:[e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"#"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Due Date"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Principal"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Interest"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Penalty"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Fees"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Total"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Balance"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:f.map((t,a)=>{const l=t.total??Number(t.principal||0)+Number(t.interest||0)+Number(t.penalty||0)+Number(t.fee??t.fees??0),r=t.paid||t.settled;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:a+1}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:z(t.dueDate)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.principal,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.interest,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.penalty||0,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.fee??t.fees??0,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(l,c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:m(t.balance??(r?0:l),c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:r?e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200",children:"Settled"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-amber-200",children:"Pending"})})]},t.id||a)})})]})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{onClick:()=>ne(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Close"})})]})}),Be&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Edit Loan"}),e.jsx("button",{onClick:()=>G(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:p.amount,onChange:t=>_(a=>({...a,amount:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Interest Rate (%)"}),e.jsx("input",{type:"number",value:p.interestRate,onChange:t=>_(a=>({...a,interestRate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Term (months)"}),e.jsx("input",{type:"number",value:p.termMonths,onChange:t=>_(a=>({...a,termMonths:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Start Date"}),e.jsx("input",{type:"date",value:p.startDate,onChange:t=>_(a=>({...a,startDate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>G(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:Xe,disabled:ge,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:ge?"Saving…":"Save"})]})]})}),qe&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Reschedule Loan"}),e.jsx("button",{onClick:()=>H(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"New Term (months)"}),e.jsx("input",{type:"number",value:j.termMonths,onChange:t=>K(a=>({...a,termMonths:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"New Start Date"}),e.jsx("input",{type:"date",value:j.startDate,onChange:t=>K(a=>({...a,startDate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:j.previewOnly,onChange:t=>K(a=>({...a,previewOnly:t.target.checked}))}),"Preview only (don’t save)"]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>H(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:tt,disabled:ye,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:ye?"Working…":j.previewOnly?"Preview":"Reschedule"})]})]})})]}):e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6",children:"Loan not found."})}export{yt as default};

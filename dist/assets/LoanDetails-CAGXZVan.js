import{e as U,u as W,r as n,j as e,L as F,c as o}from"./index-BamHWsKW.js";const c=(l,b="TZS")=>`‎${b} ${Number(l||0).toLocaleString()}`,v=l=>l?new Date(l).toLocaleDateString():"N/A",X=l=>l?new Date(l).toLocaleString():"",_={pending:"bg-yellow-100 text-yellow-800",approved:"bg-blue-100 text-blue-800",rejected:"bg-gray-200 text-gray-700",disbursed:"bg-indigo-100 text-indigo-800",active:"bg-emerald-100 text-emerald-800",closed:"bg-slate-200 text-slate-700"};function se(){var T;const{id:l}=U(),b=W(),[t,B]=n.useState(null),[r,w]=n.useState(null),[C,S]=n.useState([]),[k,j]=n.useState([]),[h,y]=n.useState(null),[O,L]=n.useState(!0),[E,Z]=n.useState(!0),[z,V]=n.useState(!0),[Y,R]=n.useState(!1),[D,P]=n.useState(null),[g,$]=n.useState(""),[q,p]=n.useState(!1),[G,N]=n.useState(!1),[x,m]=n.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[M,I]=n.useState(!1),d=(t==null?void 0:t.currency)||"TZS",H=_[t==null?void 0:t.status]||"bg-slate-100 text-slate-800",f=async()=>{L(!0),P(null);try{const{data:s}=await o.get(`/loans/${l}`);B(s);const a=[o.get(`/repayments/loan/${l}`).then(i=>S(i.data||[])).catch(()=>S([])).finally(()=>Z(!1)),o.get(`/comments/loan/${l}`).then(i=>j(i.data||[])).catch(()=>j([])).finally(()=>V(!1))];s!=null&&s.productId&&a.push(o.get(`/loan-products/${s.productId}`).then(i=>w(i.data)).catch(()=>w(null))),await Promise.all(a)}catch(s){console.error(s),P("Failed to fetch loan.")}finally{L(!1)}};n.useEffect(()=>{y(null),f()},[l]);const u=async(s,a={})=>{if(s==="disbursed"&&(t==null?void 0:t.status)!=="approved"){alert("You can disburse only after the loan is approved.");return}if(s==="closed"&&((t==null?void 0:t.outstanding)??0)>0){if(!confirm("Outstanding > 0. Close anyway?"))return;a.override=!0}if(confirm(`Mark this loan as ${s}?`))try{await o.patch(`/loans/${l}/status`,{status:s,...a}),await f(),alert(`Loan marked as ${s}.`)}catch(i){console.error(i),alert(`Failed to update status to ${s}.`)}},J=async()=>{if(g.trim())try{const s=await o.post("/comments",{loanId:l,content:g});j(a=>[s.data,...a]),$("")}catch(s){console.error(s),alert("Failed to add comment.")}},K=async()=>{if(N(!0),!h){R(!0);try{const s=await o.get(`/loans/${l}/schedule`);y(s.data||[])}catch(s){console.error(s),y(null)}finally{R(!1)}}},Q=async()=>{const s=Number(x.amount);if(!s||s<=0)return alert("Enter a valid amount.");I(!0);try{await o.post("/repayments",{loanId:l,...x,amount:s}),await f(),p(!1),m({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),alert("Repayment posted.")}catch(a){console.error(a),alert("Failed to post repayment.")}finally{I(!1)}};if(O)return e.jsx("div",{className:"p-4",children:"Loading loan…"});if(D)return e.jsx("div",{className:"p-4 text-red-600",children:D});if(!t)return e.jsx("div",{className:"p-4",children:"Loan not found."});const A=(t==null?void 0:t.outstanding)??null;return e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Loan Details"}),e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${H}`,children:t.status})]}),e.jsx("button",{onClick:()=>b(-1),className:"text-blue-600 hover:underline",children:"← Back"})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap gap-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Borrower"}),e.jsx(F,{className:"text-blue-600 hover:underline",to:`/borrowers/${t.borrowerId}`,children:((T=t.Borrower)==null?void 0:T.name)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Amount"}),e.jsx("div",{className:"font-semibold",children:c(t.amount,d)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Interest"}),e.jsxs("div",{children:[t.interestRate,"% · ",t.interestMethod]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Term"}),e.jsxs("div",{children:[t.termMonths," months"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Start Date"}),e.jsx("div",{children:v(t.startDate)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Outstanding"}),e.jsx("div",{className:"font-semibold",children:A==null?"—":c(A,d)})]})]}),r&&e.jsxs("div",{className:"mt-4 text-sm text-gray-700",children:[e.jsxs("div",{className:"font-semibold",children:["Product: ",r.name,r.code?` (${r.code})`:""]}),e.jsxs("div",{children:["Defaults: ",r.interestMethod," @ ",r.interestRate??r.defaultInterestRate,"% · Limits:"," ",c(r.minPrincipal,d)," – ",c(r.maxPrincipal,d),","," ",r.minTermMonths,"-",r.maxTermMonths," months"]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(F,{to:"/loans",className:"px-3 py-2 rounded border",children:"Back to Loans"}),t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>u("approved"),className:"bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700",children:"Approve"}),e.jsx("button",{onClick:()=>u("rejected"),className:"bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700",children:"Reject"})]}),(t.status==="approved"||t.status==="disbursed")&&e.jsx("button",{onClick:()=>u("disbursed"),className:"bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700",children:"Disburse"}),t.status!=="closed"&&e.jsx("button",{onClick:()=>u("closed"),className:"bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700",children:"Close"}),e.jsx("button",{onClick:K,className:"px-3 py-2 rounded border hover:bg-gray-50",children:"View Schedule"}),e.jsx("button",{onClick:()=>p(!0),className:"px-3 py-2 rounded border hover:bg-gray-50",children:"Post Repayment"})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Repayments"}),E?e.jsx("p",{children:"Loading repayments…"}):C.length===0?e.jsx("p",{children:"No repayments found."}):e.jsxs("table",{className:"min-w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"Date"}),e.jsx("th",{className:"border px-2 py-1",children:"Amount"}),e.jsx("th",{className:"border px-2 py-1",children:"Method"}),e.jsx("th",{className:"border px-2 py-1",children:"Notes"})]})}),e.jsx("tbody",{children:C.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:v(s.date)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.amount,d)}),e.jsx("td",{className:"border px-2 py-1",children:s.method||"—"}),e.jsx("td",{className:"border px-2 py-1",children:s.notes||"—"})]},s.id||a))})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comments"}),z?e.jsx("p",{children:"Loading comments…"}):k.length===0?e.jsx("p",{children:"No comments yet."}):e.jsx("div",{className:"space-y-2 mb-3 max-h-64 overflow-auto pr-1",children:k.map((s,a)=>e.jsxs("div",{className:"text-sm border-b pb-1",children:[e.jsx("p",{children:s.content}),e.jsx("span",{className:"text-gray-400 text-xs",children:X(s.createdAt)})]},s.id||a))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:g,onChange:s=>$(s.target.value),className:"border rounded px-2 py-1 w-full",placeholder:"Add a comment"}),e.jsx("button",{onClick:J,className:"bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700",children:"Post"})]})]}),q&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Post Repayment"}),e.jsx("button",{onClick:()=>p(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:x.amount,onChange:s=>m(a=>({...a,amount:s.target.value})),className:"border rounded px-2 py-1 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Date"}),e.jsx("input",{type:"date",value:x.date,onChange:s=>m(a=>({...a,date:s.target.value})),className:"border rounded px-2 py-1 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Method"}),e.jsxs("select",{value:x.method,onChange:s=>m(a=>({...a,method:s.target.value})),className:"border rounded px-2 py-1 w-full",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:x.notes,onChange:s=>m(a=>({...a,notes:s.target.value})),className:"border rounded px-2 py-1 w-full",placeholder:"Receipt no., reference, etc."})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>p(!1),className:"px-3 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:Q,disabled:M,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-60",children:M?"Posting…":"Post"})]})]})}),G&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Repayment Schedule"}),e.jsx("button",{onClick:()=>N(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),Y?e.jsx("p",{children:"Loading schedule…"}):!h||h.length===0?e.jsx("p",{children:"No schedule available."}):e.jsx("div",{className:"max-h-[60vh] overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"#"}),e.jsx("th",{className:"border px-2 py-1",children:"Due Date"}),e.jsx("th",{className:"border px-2 py-1",children:"Principal"}),e.jsx("th",{className:"border px-2 py-1",children:"Interest"}),e.jsx("th",{className:"border px-2 py-1",children:"Penalty"}),e.jsx("th",{className:"border px-2 py-1",children:"Total"}),e.jsx("th",{className:"border px-2 py-1",children:"Balance"})]})}),e.jsx("tbody",{children:h.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:a+1}),e.jsx("td",{className:"border px-2 py-1",children:v(s.dueDate)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.principal,d)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.interest,d)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.penalty||0,d)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.total,d)}),e.jsx("td",{className:"border px-2 py-1",children:c(s.balance,d)})]},s.id||a))})]})}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{onClick:()=>N(!1),className:"px-3 py-2 rounded border",children:"Close"})})]})})]})}export{se as default};

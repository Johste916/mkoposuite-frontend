import{u as Y,r as a,j as t,L as q,b as p}from"./index-XcKfUCi2.js";import{E as z}from"./jspdf.es.min-B66sycfS.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as G}from"./index-BxMydttn.js";const X=()=>{const S=Y(),[j,D]=a.useState([]),[A,k]=a.useState([]),[m,B]=a.useState([]),[C,N]=a.useState(!1),[i,P]=a.useState(""),[h,L]=a.useState("all"),[u,F]=a.useState(""),[x,R]=a.useState(""),[c,$]=a.useState(""),[l,I]=a.useState(""),v=async()=>{N(!0);try{const e=await p.get("/loans");D(e.data||[])}catch{alert("Failed to load loans")}finally{N(!1)}},M=async()=>{try{const e=await p.get("/branches");k(Array.isArray(e.data)?e.data:[])}catch{}},E=async()=>{try{const e=await p.get("/loan-products");B(Array.isArray(e.data)?e.data:e.data.items||[])}catch{}};a.useEffect(()=>{v(),M(),E()},[]);const b=a.useMemo(()=>Object.fromEntries((m||[]).map(e=>[String(e.id),e])),[m]),T=e=>{const s=e.startDate||e.createdAt;if(!s||!c&&!l)return!0;const r=new Date(s);if(c&&r<new Date(c))return!1;if(l){const n=new Date(l);if(n.setHours(23,59,59,999),r>n)return!1}return!0},d=a.useMemo(()=>(j||[]).filter(e=>{var w,f;const s=h==="all"||e.status===h,r=(((w=e.Borrower)==null?void 0:w.name)||"").toLowerCase().includes(i.toLowerCase())||String(e.id||"").includes(i.trim()),n=!u||String(e.branchId||((f=e.branch)==null?void 0:f.id))===String(u),U=!x||String(e.productId)===String(x);return s&&r&&n&&U&&T(e)}),[j,h,i,u,x,c,l]),o=a.useMemo(()=>{const e=d.reduce((r,n)=>r+Number(n.amount||0),0),s=r=>d.filter(n=>n.status===r).length;return{total:d.length,totalPrincipal:e,pending:s("pending"),approved:s("approved"),disbursed:s("disbursed"),active:s("active"),closed:s("closed"),rejected:s("rejected")}},[d]),g=async(e,s)=>{try{await p.patch(`/loans/${e}/${s}`),v()}catch{alert(`Failed to ${s} loan`)}},y=a.useMemo(()=>d.map(e=>{var s,r,n;return{id:e.id,borrower:((s=e.Borrower)==null?void 0:s.name)||"",product:((r=b[String(e.productId)])==null?void 0:r.name)||"",amount:e.amount,rate:e.interestRate,termMonths:e.termMonths,branch:((n=e.branch)==null?void 0:n.name)||"",status:e.status,startDate:e.startDate}}),[d,b]),V=[{label:"Loan ID",key:"id"},{label:"Borrower",key:"borrower"},{label:"Product",key:"product"},{label:"Amount",key:"amount"},{label:"Rate (%)",key:"rate"},{label:"Term (months)",key:"termMonths"},{label:"Branch",key:"branch"},{label:"Status",key:"status"},{label:"Start Date",key:"startDate"}],H=()=>{const e=new z;e.text("Loans Report",14,16),e.autoTable({startY:20,head:[["ID","Borrower","Product","Amount","Rate","Term","Branch","Status"]],body:y.map(s=>[s.id,s.borrower,s.product,s.amount,s.rate,s.termMonths,s.branch,s.status])}),e.save("loans.pdf")},O=e=>{const s="px-2 py-1 rounded text-xs font-semibold";switch(e){case"pending":return`${s} bg-yellow-100 text-yellow-700`;case"approved":return`${s} bg-green-100 text-green-700`;case"rejected":return`${s} bg-red-100 text-red-700`;case"disbursed":case"active":return`${s} bg-blue-100 text-blue-700`;case"closed":return`${s} bg-gray-100 text-gray-700`;default:return`${s} bg-gray-200 text-gray-600`}};return t.jsxs("div",{className:"p-4 space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl font-bold",children:"All Loans"}),t.jsx(q,{className:"text-blue-600 underline text-sm",to:"/loans/applications",children:"New Application"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Total"}),t.jsx("p",{className:"text-lg font-semibold",children:o.total})]}),t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Principal"}),t.jsx("p",{className:"text-lg font-semibold",children:o.totalPrincipal})]}),t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Pending"}),t.jsx("p",{className:"text-lg font-semibold",children:o.pending})]}),t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Approved"}),t.jsx("p",{className:"text-lg font-semibold",children:o.approved})]}),t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Disbursed"}),t.jsx("p",{className:"text-lg font-semibold",children:o.disbursed})]}),t.jsxs("div",{className:"bg-white rounded shadow p-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Active"}),t.jsx("p",{className:"text-lg font-semibold",children:o.active})]})]}),t.jsxs("div",{className:"bg-white rounded shadow p-4 grid grid-cols-1 md:grid-cols-6 gap-3",children:[t.jsx("input",{type:"text",placeholder:"Search borrower or loan ID…",value:i,onChange:e=>P(e.target.value),className:"border px-3 py-2 rounded md:col-span-2"}),t.jsxs("select",{value:h,onChange:e=>L(e.target.value),className:"border px-3 py-2 rounded",children:[t.jsx("option",{value:"all",children:"All Statuses"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"approved",children:"Approved"}),t.jsx("option",{value:"disbursed",children:"Disbursed"}),t.jsx("option",{value:"active",children:"Active"}),t.jsx("option",{value:"rejected",children:"Rejected"}),t.jsx("option",{value:"closed",children:"Closed"})]}),t.jsxs("select",{value:u,onChange:e=>F(e.target.value),className:"border px-3 py-2 rounded",children:[t.jsx("option",{value:"",children:"All Branches"}),A.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:x,onChange:e=>R(e.target.value),className:"border px-3 py-2 rounded",children:[t.jsx("option",{value:"",children:"All Products"}),m.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("input",{type:"date",value:c,onChange:e=>$(e.target.value),className:"border px-3 py-2 rounded"}),t.jsx("input",{type:"date",value:l,onChange:e=>I(e.target.value),className:"border px-3 py-2 rounded"}),t.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[t.jsx(G,{data:y,headers:V,filename:"loans.csv",className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",children:"Export CSV"}),t.jsx("button",{onClick:H,className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Export PDF"})]})]}),t.jsx("div",{className:"overflow-x-auto",children:C?t.jsx("p",{children:"Loading loans…"}):d.length===0?t.jsx("p",{children:"No loans found."}):t.jsxs("table",{className:"min-w-full bg-white rounded shadow border text-sm",children:[t.jsx("thead",{className:"bg-gray-200",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-2 border",children:"ID"}),t.jsx("th",{className:"p-2 border",children:"Borrower"}),t.jsx("th",{className:"p-2 border",children:"Product"}),t.jsx("th",{className:"p-2 border",children:"Amount"}),t.jsx("th",{className:"p-2 border",children:"Rate (%)"}),t.jsx("th",{className:"p-2 border",children:"Term"}),t.jsx("th",{className:"p-2 border",children:"Branch"}),t.jsx("th",{className:"p-2 border",children:"Start Date"}),t.jsx("th",{className:"p-2 border",children:"Status"}),t.jsx("th",{className:"p-2 border",children:"Actions"})]})}),t.jsx("tbody",{children:d.map(e=>{var s,r,n;return t.jsxs("tr",{children:[t.jsx("td",{className:"border px-2",children:e.id}),t.jsx("td",{className:"border px-2",children:((s=e.Borrower)==null?void 0:s.name)||"N/A"}),t.jsx("td",{className:"border px-2",children:((r=b[String(e.productId)])==null?void 0:r.name)||"—"}),t.jsx("td",{className:"border px-2",children:e.amount}),t.jsx("td",{className:"border px-2",children:e.interestRate}),t.jsx("td",{className:"border px-2",children:e.termMonths}),t.jsx("td",{className:"border px-2",children:((n=e.branch)==null?void 0:n.name)||"—"}),t.jsx("td",{className:"border px-2",children:e.startDate||"—"}),t.jsx("td",{className:"border px-2",children:t.jsx("span",{className:O(e.status),children:e.status})}),t.jsxs("td",{className:"border px-2 space-x-2",children:[t.jsx("button",{onClick:()=>S(`/loans/${e.id}`),className:"text-indigo-600 hover:underline",children:"View"}),e.status==="pending"&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>g(e.id,"approve"),className:"text-green-600 hover:underline",children:"Approve"}),t.jsx("button",{onClick:()=>g(e.id,"reject"),className:"text-red-600 hover:underline",children:"Reject"})]}),e.status==="approved"&&t.jsx("button",{onClick:()=>g(e.id,"disburse"),className:"text-blue-600 hover:underline",children:"Disburse"})]})]},e.id)})})]})})]})};export{X as default};

import{d as C,u as D,r as o,b as u,j as e,L as h}from"./index-Iq-s2r8X.js";import{W as L}from"./wallet-B2TSzSBj.js";import{C as B,S as I}from"./save-BHAP6wDs.js";import"./createLucideIcon-B8X5gIaY.js";const i="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 transition-all",$="bg-white rounded-2xl shadow-sm ring-1 ring-indigo-950/5 p-4 md:p-6",A=[{value:"cash",label:"Cash"},{value:"bank",label:"Bank"},{value:"mobile_money",label:"Mobile Money"},{value:"other",label:"Other"}];function R(){var f;const{id:l}=C(),v=D(),m=(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}})(),p=((m==null?void 0:m.role)||"").toLowerCase(),b=p==="admin"||p==="accountant",[c,N]=o.useState(null),[y,w]=o.useState([]),[g,j]=o.useState(!1),x=o.useRef(null),[s,r]=o.useState({method:"cash",bankId:"",reference:"",amount:"",date:new Date().toISOString().slice(0,10),note:""});o.useEffect(()=>{(async()=>{var a,d;try{const[n,t]=await Promise.all([u.get(`/loans/${l}`),u.get("/banks").catch(()=>({data:[]}))]);N(n.data||null),w(Array.isArray(t.data)?t.data:((a=t.data)==null?void 0:a.items)||[]),(d=n.data)!=null&&d.amount&&!s.amount&&r(S=>({...S,amount:String(n.data.amount)}))}catch(n){console.warn(n)}})()},[l]);const k=async a=>{var d,n;if(a.preventDefault(),!!b){j(!0);try{const t=new FormData;t.append("method",s.method),t.append("bankId",s.method==="bank"&&s.bankId||""),t.append("reference",s.reference||""),t.append("amount",s.amount||""),t.append("date",s.date||""),t.append("note",s.note||""),(n=(d=x.current)==null?void 0:d.files)!=null&&n[0]&&t.append("attachment",x.current.files[0]),await u.post(`/loans/${l}/disburse`,t,{headers:{"Content-Type":"multipart/form-data"}}),alert("Loan disbursed"),v(`/loans/${l}`)}catch(t){console.error(t),alert("Failed to disburse")}finally{j(!1)}}};return b?e.jsxs("div",{className:"p-4 md:p-6 lg:p-8",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight",children:"Disburse Loan"}),c&&e.jsxs("p",{className:"text-sm text-gray-500",children:["Borrower: ",e.jsx("b",{children:((f=c.Borrower)==null?void 0:f.name)||c.borrowerName||"—"})," • Amount: ",e.jsx("b",{children:Number(c.amount||0).toLocaleString()})]})]}),e.jsx(h,{to:`/loans/${l}`,className:"text-indigo-600 hover:underline text-sm",children:"Back to Loan"})]}),e.jsxs("form",{onSubmit:k,className:"max-w-3xl",children:[e.jsxs("section",{className:$,children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full border text-indigo-700 bg-indigo-50 border-indigo-200",children:[e.jsx(L,{className:"h-4 w-4"})," Disbursement Details"]})}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Method"}),e.jsx("select",{className:i,value:s.method,onChange:a=>r({...s,method:a.target.value}),children:A.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",className:i,value:s.amount,onChange:a=>r({...s,amount:a.target.value})})]}),s.method==="bank"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Bank"}),e.jsxs("select",{className:i,value:s.bankId,onChange:a=>r({...s,bankId:a.target.value}),children:[e.jsx("option",{value:"",children:"Select bank…"}),y.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Reference"}),e.jsx("input",{className:i,value:s.reference,onChange:a=>r({...s,reference:a.target.value}),placeholder:"Txn ref / slip #"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-gray-600 flex items-center gap-1",children:[e.jsx(B,{className:"h-3.5 w-3.5"})," Date"]}),e.jsx("input",{type:"date",className:i,value:s.date,onChange:a=>r({...s,date:a.target.value})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Note (optional)"}),e.jsx("textarea",{className:`${i} min-h-[84px]`,value:s.note,onChange:a=>r({...s,note:a.target.value})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Upload slip / proof (optional)"}),e.jsx("input",{ref:x,type:"file",className:i})]})]})]}),e.jsx("div",{className:"sticky bottom-0 inset-x-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 border-t mt-6",children:e.jsxs("div",{className:"max-w-3xl px-4 py-3 ml-0 flex justify-end gap-3",children:[e.jsx(h,{to:`/loans/${l}`,className:"px-4 py-2 rounded-xl border hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:g,className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm",children:[e.jsx(I,{className:"h-4 w-4"}),g?"Disbursing…":"Disburse"]})]})})]})]}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"max-w-2xl mx-auto bg-white border rounded-xl p-6",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["You don’t have permission to disburse loans. This page is available to ",e.jsx("b",{children:"Admin"})," and ",e.jsx("b",{children:"Accountant"})," roles."]}),e.jsx(h,{to:`/loans/${l}`,className:"text-indigo-600 underline text-sm mt-3 inline-block",children:"Back to loan"})]})})}export{R as default};

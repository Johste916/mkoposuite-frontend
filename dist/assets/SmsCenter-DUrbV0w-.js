import{r,g as ae,j as s}from"./index-x5m31TRy.js";const se=new Intl.NumberFormat,te=d=>d?new Date(d).toLocaleString():"—",k=d=>ae.getFirst(d),b=(d,l)=>ae.postFirst(d,l),Fe=`@£$¥èéùìòÇ
Øø\rÅåΔ_ΦΓΛΩΠΨΣΘΞ\x1BÆæßÉ !"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ\`¿abcdefghijklmnopqrstuvwxyzäöñü^{}\\[~]|€`;function Te(d=""){for(const l of String(d))if(!Fe.includes(l))return!0;return!1}function D(d){const l=Te(d),x=String(d||"").length;if(x===0)return{uni:l,segs:0,per:l?70:160,left:l?70:160};if(!l){if(x<=160)return{uni:l,segs:1,per:160,left:160-x};const I=Math.ceil(x/153),u=x%153;return{uni:l,segs:I,per:153,left:u===0?0:153-u}}if(x<=70)return{uni:l,segs:1,per:70,left:70-x};const m=Math.ceil(x/67),f=x%67;return{uni:l,segs:m,per:67,left:f===0?0:67-f}}const $e=(d,l={})=>String(d||"").replace(/\{\{(\w+)\}\}/g,(x,m)=>m in l?String(l[m]):"");function Ee(){const[d,l]=r.useState(!1),[x,m]=r.useState(""),[f,I]=r.useState({allowBodySender:!1,defaultSender:""}),[u,V]=r.useState(null),[q,L]=r.useState([]),ne=["Single","Borrowers","CRM Groups","CSV Upload"],[N,re]=r.useState(0),[U,oe]=r.useState(""),[B,O]=r.useState(""),[P,le]=r.useState(""),[E,ie]=r.useState(""),[H,R]=r.useState([]),[S,G]=r.useState([]),[M,ce]=r.useState("Hello {{name}}, …"),[Q,de]=r.useState(""),[_,me]=r.useState(""),[z,ue]=r.useState(""),[J,xe]=r.useState(!1),[K,pe]=r.useState(""),[F,he]=r.useState("Dear {{name}}, …"),[W,fe]=r.useState(""),[X,Y]=r.useState(null),[T,ge]=r.useState("Hello {{name}}, …"),[Z,ve]=r.useState("");async function Se(){try{const e=await k(["/sms/capabilities","/communications/sms/capabilities","/notifications/sms/capabilities"]);I(e||{allowBodySender:!1,defaultSender:""})}catch{I({allowBodySender:!1,defaultSender:""})}}async function ee(){m("");try{const e=await k(["/sms/balance","/billing/sms/balance","/notifications/sms/balance"]);V(e||null)}catch{V(null)}}async function j(){try{const e=await k(["/sms/messages","/notifications/sms/messages","/communications/sms"]),t=Array.isArray(e)?e:e.items||e.messages||[];L(t.slice(0,100))}catch{L([])}}r.useEffect(()=>{Se(),ee(),j()},[]),r.useEffect(()=>{const e=setTimeout(async()=>{const t=E.trim();if(!t)return R([]);try{const n=await k([`/sms/recipients/borrowers?q=${encodeURIComponent(t)}&limit=20`,`/borrowers/search?q=${encodeURIComponent(t)}&limit=20`,`/borrowers?search=${encodeURIComponent(t)}&limit=20`])||{},i=(n.items||n.results||n.rows||[]).map(o=>({id:o.id??o.borrowerId??o._id??`${o.phone||o.msisdn}-${o.id||""}`,name:o.name||[o.firstName,o.lastName].filter(Boolean).join(" ")||o.fullName||"—",phone:o.phone||o.msisdn||o.mobile||o.phoneNumber||"",branchId:o.branchId??null}));R(i.filter(o=>o.phone))}catch{R([])}},300);return()=>clearTimeout(e)},[E]);const je=r.useMemo(()=>{if(!u)return"—";if(u.ok===!1)return u.error||"N/A";const e=u.creditsRounded??u.credits??(()=>{const c=u.raw||"",i=String(c).split(","),o=Number(i[1]);return Number.isFinite(o)?o:null})();if(e==null)return"Unknown";const t=u.estSegmentsLeft!=null?` (~${se.format(Math.floor(u.estSegmentsLeft))} SMS)`:"",n=u.unit||"credits";return`${se.format(Number(e.toFixed?e.toFixed(2):e))} ${n}${t}`},[u]),be=r.useMemo(()=>D(B),[B]),Ne=r.useMemo(()=>D(M),[M]),ye=r.useMemo(()=>D(F),[F]),we=r.useMemo(()=>D(T),[T]);async function Ce(){const e=U.trim(),t=B.trim();if(!e||!t)return m("Phone and message are required.");l(!0),m("");try{const n=f.allowBodySender&&P||void 0,c=await b(["/sms/send","/communications/sms/send","/notifications/sms"],{to:e,message:t,text:t,from:n,senderId:n});if(c&&c.ok===!1)throw new Error(c.error||"Send failed");O(""),await j()}catch(n){m((n==null?void 0:n.message)||"Failed to send SMS.")}finally{l(!1)}}async function ke(){if(!S.length)return m("Pick at least one borrower.");const e=M.trim();if(!e)return m("Message is required.");l(!0),m("");try{const t=f.allowBodySender&&Q||void 0,n=S.map(i=>{const o=i.name||"",[y,...v]=o.split(" ");return{to:i.phone,vars:{name:o,firstName:y,lastName:v.join(" ")},from:t}}),c=await b(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:n,template:e,defaultFrom:t});if(!c||c.ok===!1)for(const i of n)await b(["/sms/send","/communications/sms/send","/notifications/sms"],{to:i.to,message:$e(e,i.vars||{}),from:t,senderId:t});G([]),await j()}catch(t){m((t==null?void 0:t.message)||"Bulk send failed.")}finally{l(!1)}}async function Ie(){const e=F.trim();if(!e)return m("Template is required.");l(!0),m("");const t={branchId:_||void 0,loanStatus:z||void 0,overdueOnly:!!J,officerId:K||void 0,limit:500},n=f.allowBodySender&&W||void 0;try{try{const a=await b(["/sms/to-segment"],{filter:t,template:e,from:n});if(a&&a.ok){await j(),l(!1);return}}catch{}const c=new URLSearchParams({limit:"500",branchId:t.branchId||""}).toString(),i=await k([`/sms/recipients/borrowers?${c}`,`/borrowers?${c}`])||{},v=(i.items||i.results||i.rows||[]||[]).map(a=>({name:a.name||[a.firstName,a.lastName].filter(Boolean).join(" "),phone:a.phone||a.msisdn||a.mobile})).filter(a=>a.phone).map(a=>{const[g,...p]=(a.name||"").split(" ");return{to:a.phone,vars:{name:a.name,firstName:g,lastName:p.join(" ")},from:n}});if(!v.length)throw new Error("No recipients matched the selected filters.");await b(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:v,template:e,defaultFrom:n}),await j()}catch(c){m((c==null?void 0:c.message)||"Segment send failed.")}finally{l(!1)}}async function Be(){if(!X)return m("Choose a CSV first.");l(!0),m("");try{const t=(await X.text()).split(/\r?\n/).filter(a=>a.trim().length);if(t.length===0)throw new Error("Empty CSV.");const n=a=>{const g=[];let p="",h=!1;for(let w=0;w<a.length;w++){const C=a[w];if(C==='"')h=!h;else if(C===","&&!h){g.push(p),p="";continue}p+=C}return g.push(p),g},c=n(t[0]).map(a=>a.trim().replace(/^"|"$/g,"")),i=(a,g)=>{const p=c.findIndex(h=>h.toLowerCase()===g.toLowerCase());return p<0?"":(a[p]||"").replace(/^"|"$/g,"").trim()},o=t.slice(1).map(a=>n(a)),y=f.allowBodySender&&Z||void 0,v=o.map(a=>{const g=i(a,"phone")||i(a,"msisdn")||i(a,"number"),p=i(a,"message"),h=i(a,"name"),w=i(a,"firstName")||(h?h.split(" ")[0]:""),C=i(a,"lastName")||(h?h.split(" ").slice(1).join(" "):"");return{to:g,message:p||void 0,vars:{name:h,firstName:w,lastName:C},from:y}}).filter(a=>a.to);if(!v.length)throw new Error("No valid rows (need a 'phone' column).");await b(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:v,template:T||void 0,defaultFrom:y}),Y(null),await j()}catch(e){m((e==null?void 0:e.message)||"CSV upload failed.")}finally{l(!1)}}function Me(){return s.jsx("div",{className:"rounded-2xl border p-4 shadow-sm bg-white",children:s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-500",children:"Balance"}),s.jsx("div",{className:"text-2xl font-semibold",children:je}),(u==null?void 0:u.checkedAt)&&s.jsxs("div",{className:"text-xs text-gray-400",children:["Checked ",te(u.checkedAt)]})]}),s.jsx("button",{onClick:ee,className:"px-3 py-2 rounded-xl border hover:bg-gray-50",children:"Refresh"})]})})}const $=({label:e})=>f.allowBodySender?s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:`${e} (optional)`,value:e.includes("Single")?P:e.includes("Borrower")?Q:e.includes("CSV")?Z:W,onChange:t=>{const n=t.target.value;e.includes("Single")?le(n):e.includes("Borrower")?de(n):e.includes("CSV")?ve(n):fe(n)}}):s.jsxs("div",{className:"text-xs text-gray-500",children:["Sender: ",s.jsx("span",{className:"font-medium",children:f.defaultSender||"System"})," (locked)"]}),A=({info:e})=>s.jsxs("div",{className:"text-xs text-gray-500",children:[e.uni?"Unicode":"GSM-7"," • ",e.segs," segment",e.segs===1?"":"s"," • ",e.left," chars left"]});return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 p-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"SMS Center"}),s.jsx(Me,{}),s.jsxs("div",{className:"rounded-2xl border bg-white",children:[s.jsx("div",{className:"grid grid-cols-4 text-sm font-medium border-b",children:ne.map((e,t)=>s.jsx("button",{className:`px-4 py-3 text-left ${t===N?"bg-gray-50 border-b-2 border-black":""}`,onClick:()=>re(t),children:e},e))}),N===0&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:"Phone number (e.g. 0784…, +255…)",value:U,onChange:e=>oe(e.target.value)}),s.jsx($,{label:"Single Sender ID"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Message text",value:B,onChange:e=>O(e.target.value)}),s.jsx(A,{info:be})]}),s.jsx("button",{disabled:d,onClick:Ce,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:d?"Sending…":"Send"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Tip: avoid emojis to keep it single-segment (GSM-7)."})]}),N===1&&s.jsxs("div",{className:"p-4 space-y-4",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Search borrowers by name, phone, NID, account…",value:E,onChange:e=>ie(e.target.value)}),s.jsx($,{label:"Borrower Sender ID"})]}),H.length>0&&s.jsx("div",{className:"max-h-52 overflow-auto border rounded-xl",children:H.map(e=>{const t=S.some(n=>n.id===e.id);return s.jsxs("label",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:()=>G(n=>t?n.filter(c=>c.id!==e.id):[...n,e])}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.phone})]})]},e.id)})}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Hello {{name}}, your loan is due…",value:M,onChange:e=>ce(e.target.value)}),s.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[s.jsxs("span",{children:["Variables: ","{{name}}"," ","{{firstName}}"," ","{{lastName}}"]}),s.jsx(A,{info:Ne})]})]}),s.jsxs("button",{disabled:d||S.length===0,onClick:ke,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:["Send to ",S.length," borrower",S.length===1?"":"s"]})]}),N===2&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-5 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Branch ID",value:_,onChange:e=>me(e.target.value)}),s.jsxs("select",{className:"rounded-xl border p-2",value:z,onChange:e=>ue(e.target.value),children:[s.jsx("option",{value:"",children:"Any status"}),s.jsx("option",{value:"active",children:"Active"}),s.jsx("option",{value:"closed",children:"Closed"}),s.jsx("option",{value:"defaulted",children:"Defaulted"})]}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:J,onChange:e=>xe(e.target.checked)}),"In arrears"]}),s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Loan officer (ID/name)",value:K,onChange:e=>pe(e.target.value)}),s.jsx($,{label:"Segment Sender ID"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Dear {{name}}, …",value:F,onChange:e=>he(e.target.value)}),s.jsx(A,{info:ye})]}),s.jsx("button",{disabled:d,onClick:Ie,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Send to group"}),s.jsx("div",{className:"text-xs text-gray-500",children:"Server tries to honor CRM filters (status, arrears, officer). If not supported in this environment, the app falls back to a basic borrower list."})]}),N===3&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 items-center",children:[s.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var t;return Y(((t=e.target.files)==null?void 0:t[0])||null)}}),s.jsx($,{label:"CSV Sender ID"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-24",placeholder:"Optional template (uses CSV column names: Hello {{name}})",value:T,onChange:e=>ge(e.target.value)}),s.jsx(A,{info:we})]}),s.jsxs("div",{className:"text-xs text-gray-500",children:["CSV columns: ",s.jsx("code",{children:"phone"}),", ",s.jsx("code",{children:"message"})," (optional), ",s.jsx("code",{children:"name"}),", ",s.jsx("code",{children:"firstName"}),", ",s.jsx("code",{children:"lastName"}),"…"]}),s.jsx("button",{disabled:d,onClick:Be,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Upload & Send"})]})]}),x?s.jsx("div",{className:"rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm",children:x}):null,s.jsxs("div",{className:"rounded-2xl border bg-white p-4",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Recent Messages"}),q.length===0?s.jsx("div",{className:"text-gray-500 text-sm",children:"No messages yet."}):s.jsx("div",{className:"divide-y",children:q.map((e,t)=>s.jsxs("div",{className:"py-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("div",{className:"font-medium",children:e.to||e.phone||e.msisdn}),s.jsx("div",{className:`text-xs ${(e.status||"").includes("fail")?"text-rose-600":(e.status||"").includes("queued")?"text-emerald-600":"text-gray-500"}`,children:e.status||e.deliveryStatus||"—"})]}),s.jsx("div",{className:"text-gray-600",children:e.message||e.text||e.body||""}),s.jsx("div",{className:"text-xs text-gray-400",children:te(e.at||e.createdAt||e.sentAt||e.timestamp)})]},e.id||e.messageId||t))})]})]})}export{Ee as default};

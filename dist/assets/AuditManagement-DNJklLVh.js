import{r as i,j as e,h as c}from"./index-D7WBPAut.js";function M(){var f,v,w,S,L,A;const[g,x]=i.useState([]),[C,j]=i.useState(0),[o,k]=i.useState(""),[u,N]=i.useState(""),[F,b]=i.useState(!1),[l,y]=i.useState(null),h=s=>Array.isArray(s)?s:s&&Array.isArray(s.items)?s.items:[],m=async()=>{var s,r,t;b(!0),N("");try{const[a,d]=await Promise.all([c.get("/admin/audit?limit=200"),c.get("/admin/audit/summary")]);x(h(a.data)),j(((s=a.data)==null?void 0:s.total)??h(a.data).length??0),y(d.data||null)}catch(a){N(((t=(r=a==null?void 0:a.response)==null?void 0:r.data)==null?void 0:t.error)||a.message||"Failed to load audits"),x([]),y(null),j(0)}finally{b(!1)}};i.useEffect(()=>{m()},[]);const p=i.useMemo(()=>{const s=h(g),r=o.toLowerCase().trim();return r?s.filter(t=>{var a,d;return[(a=t==null?void 0:t.User)==null?void 0:a.name,(d=t==null?void 0:t.Branch)==null?void 0:d.name,t==null?void 0:t.category,t==null?void 0:t.message,t==null?void 0:t.ip,t==null?void 0:t.action].some(O=>String(O||"").toLowerCase().includes(r))}):s},[g,o]),D=async s=>{var r,t;try{await c.post(`/admin/audit/${s}/reverse`),await m()}catch(a){alert(((t=(r=a==null?void 0:a.response)==null?void 0:r.data)==null?void 0:t.error)||a.message||"Failed to reverse entry")}},E=async s=>{var r,t;if(confirm("Delete this audit entry?"))try{await c.delete(`/admin/audit/${s}`),await m()}catch(a){alert(((t=(r=a==null?void 0:a.response)==null?void 0:r.data)==null?void 0:t.error)||a.message||"Failed to delete entry")}},n=({label:s,value:r})=>e.jsxs("div",{className:"rounded-2xl border p-3 bg-white dark:bg-slate-900",children:[e.jsx("div",{className:"text-xs text-slate-500",children:s}),e.jsx("div",{className:"text-xl font-semibold",children:r})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Audit Management"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Track logins, actions, and changes. Linked to dashboard activity widgets."})]}),e.jsx("input",{className:"rounded border px-3 py-2 text-sm w-full md:w-96",value:o,onChange:s=>k(s.target.value),placeholder:"Search audit…"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[e.jsx(n,{label:"Events (30d)",value:((f=l==null?void 0:l.totals)==null?void 0:f.all)??0}),e.jsx(n,{label:"Creates",value:((v=l==null?void 0:l.totals)==null?void 0:v.create)??0}),e.jsx(n,{label:"Updates",value:((w=l==null?void 0:l.totals)==null?void 0:w.update)??0}),e.jsx(n,{label:"Deletes",value:((S=l==null?void 0:l.totals)==null?void 0:S.delete)??0}),e.jsx(n,{label:"Logins (OK)",value:((L=l==null?void 0:l.totals)==null?void 0:L.loginSuccess)??0}),e.jsx(n,{label:"Logins (Failed)",value:((A=l==null?void 0:l.totals)==null?void 0:A.loginFailed)??0})]}),u&&e.jsx("div",{className:"text-sm text-rose-600",children:u}),e.jsx("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4",children:F?e.jsx("div",{className:"text-sm text-slate-500",children:"Loading…"}):p.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:"No entries."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-500 mb-2",children:["Showing ",p.length," of ",C," events"]}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left",children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"py-2 pr-3",children:"Time"}),e.jsx("th",{className:"py-2 pr-3",children:"Branch"}),e.jsx("th",{className:"py-2 pr-3",children:"Staff"}),e.jsx("th",{className:"py-2 pr-3",children:"Category"}),e.jsx("th",{className:"py-2 pr-3",children:"Message"}),e.jsx("th",{className:"py-2 pr-3",children:"Action"}),e.jsx("th",{className:"py-2 pr-3",children:"IP"}),e.jsx("th",{className:"py-2 pr-3",children:"Ops"})]})}),e.jsx("tbody",{children:p.map(s=>{var r,t;return e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"py-2 pr-3",children:new Date(s.createdAt||s.ts||Date.now()).toLocaleString()}),e.jsx("td",{className:"py-2 pr-3",children:((r=s==null?void 0:s.Branch)==null?void 0:r.name)||"-"}),e.jsx("td",{className:"py-2 pr-3",children:((t=s==null?void 0:s.User)==null?void 0:t.name)||"-"}),e.jsx("td",{className:"py-2 pr-3",children:s.category||"-"}),e.jsx("td",{className:"py-2 pr-3",children:(()=>{try{const a=typeof s.message=="string"?JSON.parse(s.message):s.message;return a!=null&&a.body?JSON.stringify(a.body).slice(0,90)+(JSON.stringify(a.body).length>90?"…":""):s.message||"-"}catch{return s.message||"-"}})()}),e.jsx("td",{className:"py-2 pr-3",children:s.action||"-"}),e.jsx("td",{className:"py-2 pr-3",children:s.ip||"-"}),e.jsx("td",{className:"py-2 pr-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 rounded bg-slate-100",onClick:()=>D(s.id),children:"Reverse"}),e.jsx("button",{className:"px-2 py-1 rounded bg-rose-50 text-rose-700",onClick:()=>E(s.id),children:"Delete"})]})})]},s.id)})})]})})]})})]})}export{M as default};

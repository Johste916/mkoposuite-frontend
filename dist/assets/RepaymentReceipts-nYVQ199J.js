import{r,j as e,c as E}from"./index-DzNpvMXd.js";import{E as J}from"./jspdf.es.min-CFKAXqNY.js";import K from"./html2canvas.esm-CBrSDip1.js";const o=u=>Number(u||0).toLocaleString();function te(){var F,$,B;const[u,T]=r.useState(""),[g,I]=r.useState(()=>new Date(new Date().setDate(new Date().getDate()-30)).toISOString().slice(0,10)),[j,Z]=r.useState(()=>new Date().toISOString().slice(0,10)),[v,H]=r.useState([]),[D,U]=r.useState(0),[N,b]=r.useState(1),[f,W]=r.useState(20),[S,A]=r.useState(!1),[_,k]=r.useState(!1),[t,G]=r.useState(null),L=r.useRef(null),P=r.useMemo(()=>Math.max(1,Math.ceil(Number(D||0)/Number(f||1))),[D,f]),R=async()=>{A(!0);try{const s={page:N,pageSize:f};u.trim()&&(s.q=u.trim()),g&&(s.dateFrom=g),j&&(s.dateTo=j);const{data:a}=await E.get("/repayments",{params:s}),n=Array.isArray(a)?a:(a==null?void 0:a.items)||[];H(n),U(Number((a==null?void 0:a.total)||n.length||0))}catch(s){console.error(s),alert("Failed to load receipts")}finally{A(!1)}};r.useEffect(()=>{R()},[N,f,g,j]);const V=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),b(1),R()},q=async s=>{try{const{data:a}=await E.get(`/repayments/${s.id}`);G(a||null),k(!0)}catch(a){console.error(a),alert("Failed to load receipt")}},Q=()=>{if(!v.length)return alert("Nothing to export");const a=[["Receipt No","Date","Loan Ref","Borrower","Method","Amount","Reference"].join(","),...v.map(l=>{var d,i,x,y,C,w,p;return[l.receiptNo||`RCPT-${l.id}`,l.date||l.createdAt||"",((d=l.Loan)==null?void 0:d.reference)||((i=l.loan)==null?void 0:i.reference)||`L-${((x=l.Loan)==null?void 0:x.id)||((y=l.loan)==null?void 0:y.id)||""}`,`"${(((w=(C=l.Loan)==null?void 0:C.Borrower)==null?void 0:w.fullName)||((p=l.loan)==null?void 0:p.borrowerName)||"").replace(/"/g,'""')}"`,l.method||"cash",l.amount,l.reference||""].join(",")})].join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(n),c=document.createElement("a");c.href=m,c.download=`repayment-receipts_${g}_to_${j}.csv`,c.click(),URL.revokeObjectURL(m)},Y=async()=>{if(!L.current)return;const s=L.current,a=s.style.backgroundColor;s.style.backgroundColor="#ffffff";const n=await K(s,{scale:2,backgroundColor:"#ffffff",useCORS:!0,windowWidth:s.scrollWidth,windowHeight:s.scrollHeight});s.style.backgroundColor=a||"";const m=n.toDataURL("image/png"),c=new J("p","mm","a4"),l=c.internal.pageSize.getWidth(),d=c.internal.pageSize.getHeight(),i=l,x=n.height*i/n.width;let y=0;if(x<=d)c.addImage(m,"PNG",0,0,i,x);else{let w=x;const p=n.width*d/l,h=document.createElement("canvas"),M=h.getContext("2d");h.width=n.width,h.height=p;let O=0;for(;w>0;){M.clearRect(0,0,h.width,h.height),M.drawImage(n,0,O,n.width,p,0,0,h.width,h.height);const z=h.toDataURL("image/png");y===0||c.addPage(),c.addImage(z,"PNG",0,0,i,d),O+=p,w-=d,y+=d}}const C=`receipt_${(t==null?void 0:t.receiptNo)||(t==null?void 0:t.id)}.pdf`;c.save(C)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5 flex items-center justify-between",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Receipts"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:R,disabled:S,className:"px-3 py-2 rounded border",children:S?"Refreshing…":"Refresh"}),e.jsx("button",{onClick:Q,className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Export CSV"})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5",children:e.jsxs("form",{onSubmit:V,className:"grid md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Search"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Borrower / Loan Ref / Receipt",value:u,onChange:s=>T(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"From"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:g,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"To"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:j,onChange:s=>Z(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Page size"}),e.jsx("select",{className:"w-full border rounded px-3 py-2",value:f,onChange:s=>{W(Number(s.target.value)),b(1)},children:[20,50,100].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"md:col-span-2 flex items-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border",onClick:()=>{T(""),I(new Date(new Date().setDate(new Date().getDate()-30)).toISOString().slice(0,10)),Z(new Date().toISOString().slice(0,10)),b(1),R()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Search"})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-0 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Receipt No"}),e.jsx("th",{className:"p-3",children:"Date"}),e.jsx("th",{className:"p-3",children:"Loan Ref"}),e.jsx("th",{className:"p-3",children:"Borrower"}),e.jsx("th",{className:"p-3",children:"Method"}),e.jsx("th",{className:"p-3",children:"Amount"}),e.jsx("th",{className:"p-3 text-right",children:"Action"})]})}),e.jsxs("tbody",{children:[!S&&v.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-gray-500",colSpan:7,children:"No data."})}),v.map(s=>{var a,n,m,c,l,d,i;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.receiptNo||`RCPT-${s.id}`}),e.jsx("td",{className:"p-3",children:s.date||s.createdAt||""}),e.jsx("td",{className:"p-3",children:((a=s.Loan)==null?void 0:a.reference)||((n=s.loan)==null?void 0:n.reference)||`L-${((m=s.Loan)==null?void 0:m.id)||((c=s.loan)==null?void 0:c.id)||""}`}),e.jsx("td",{className:"p-3",children:((d=(l=s.Loan)==null?void 0:l.Borrower)==null?void 0:d.fullName)||((i=s.loan)==null?void 0:i.borrowerName)||"—"}),e.jsx("td",{className:"p-3 capitalize",children:s.method||"cash"}),e.jsxs("td",{className:"p-3",children:[s.currency||"TZS"," ",o(s.amount)]}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>q(s),children:"View"})})]},s.id)}),S&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:7,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 border-t",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Page ",N," of ",P," • ",D," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:N<=1,onClick:()=>b(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:N>=P,onClick:()=>b(s=>Math.min(P,s+1)),children:"Next"})]})]})]}),_&&t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>k(!1)}),e.jsxs("div",{ref:L,className:"relative bg-white w-full max-w-2xl rounded-lg shadow-lg p-6 print:bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Receipt #",t.receiptNo||t.id]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>window.print(),children:"Print"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:Y,children:"Download PDF"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white",onClick:()=>k(!1),children:"Close"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"})," ",t.date]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Method:"})," ",t.method||"cash"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Reference:"})," ",t.reference||"—"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Notes:"})," ",t.notes||"—"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-gray-500",children:"Amount"}),e.jsxs("p",{className:"text-xl font-semibold",children:[t.currency||"TZS"," ",o(t.amount)]})]})]}),e.jsxs("div",{className:"my-4 border-t pt-4 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Loan:"})," ",(F=t.loan)==null?void 0:F.reference]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Borrower:"})," ",($=t.loan)==null?void 0:$.borrowerName]})]}),!!((B=t==null?void 0:t.allocation)!=null&&B.length)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 text-left",children:[e.jsx("th",{className:"p-2",children:"Period"}),e.jsx("th",{className:"p-2",children:"Principal"}),e.jsx("th",{className:"p-2",children:"Interest"}),e.jsx("th",{className:"p-2",children:"Fees"}),e.jsx("th",{className:"p-2",children:"Penalties"})]})}),e.jsx("tbody",{children:t.allocation.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(s.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(s.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(s.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(s.penalties)]})]},a))}),t.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t font-medium",children:[e.jsx("td",{className:"p-2",children:"Totals"}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(t.totals.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(t.totals.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(t.totals.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",o(t.totals.penalties)]})]})})]})})]})]})]})]})}export{te as default};

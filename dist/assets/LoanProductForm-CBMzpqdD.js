import{u as $,i as z,r as _,g as T,j as e}from"./index-iSlS6Tx9.js";function C({name:u,value:l,onChange:h,placeholder:k="0",...w}){const S=j=>{const d=String(j??"").replace(/[^\d.-]/g,"");if(d===""||d==="-")return d;const N=Number(d);return Number.isFinite(N)?new Intl.NumberFormat().format(N):d},P=j=>{const d=S(j.target.value);h({target:{name:u,value:d}})};return e.jsx("input",{name:u,value:l,onChange:P,inputMode:"numeric",placeholder:k,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",...w})}const y=u=>{if(u===""||u==null)return null;const l=Number(String(u).replace(/[,\s]/g,""));return Number.isFinite(l)?l:null},E=["days","weeks","months","years"],A=u=>{const l=String(u||"").toLowerCase();return E.includes(l)?l:l==="day"?"days":l==="week"?"weeks":l==="month"?"months":l==="year"?"years":"months"};function q(){const u=$(),{id:l}=z(),h=!!l,[k,w]=_.useState(!1),[S,P]=_.useState(h),[j,d]=_.useState(""),[N,F]=_.useState(null),[t,U]=_.useState({name:"",code:"",interestRate:"",interestPeriod:"monthly",term:"",termUnit:"months",principalMin:"",principalMax:"",feeType:"amount",fees:"",feePercent:"",active:!0}),M=()=>{var s;const n=localStorage.getItem("token")||localStorage.getItem("jwt")||localStorage.getItem("access_token")||localStorage.getItem("authToken")||localStorage.getItem("accessToken");let r="";try{const o=localStorage.getItem("tenant");o&&(r=((s=JSON.parse(o))==null?void 0:s.id)||"")}catch{}r=r||localStorage.getItem("tenantId")||"";const a=localStorage.getItem("activeBranchId")||"",i={"Content-Type":"application/json",Accept:"application/json"};return n&&(i.Authorization=n.startsWith("Bearer ")?n:`Bearer ${n}`),r&&(i["x-tenant-id"]=r),a&&(i["x-branch-id"]=String(a)),i},I=n=>{var a,i;const r=(a=n==null?void 0:n.response)==null?void 0:a.data;return typeof r=="string"?r:r!=null&&r.message?r.message:r!=null&&r.error?r.error:((i=n==null?void 0:n.response)==null?void 0:i.statusText)||(n==null?void 0:n.message)||"Server error"},x=n=>{if(n===""||n==null)return null;const r=Number(String(n).replace(/,/g,""));return Number.isFinite(r)?r:null},p=n=>{const{name:r,value:a,type:i,checked:s}=n.target;U(o=>({...o,[r]:i==="checkbox"?s:a}))};_.useEffect(()=>{let n=!1;return(async()=>{if(h)try{P(!0);const{data:r}=await T.get(`/loan-products/${l}`,{headers:M()});if(n)return;const a=(...b)=>{for(const m of b){const g=r==null?void 0:r[m];if(g!=null&&g!=="")return g}};let i=a("term","term_value","tenor","tenure","duration","period_count","loanTerm","repayment_term"),s=a("termUnit","term_unit","termType","term_type","unit","duration_unit","tenor_unit","tenure_unit","period_unit","loanTermUnit","repayment_term_unit");if(i===void 0){for(const[b,m]of Object.entries(r))if(typeof m=="number"&&Number.isInteger(m)&&m>=0&&m<=480&&/(term|tenor|tenure|duration|period)/i.test(b)){i=m;break}}if(s===void 0)for(const[b,m]of Object.entries(r)){const g=String(m||"").toLowerCase();if(typeof m=="string"&&(E.includes(g)||/(day|week|month|year)/i.test(g))&&/(term|tenor|tenure|duration|period|unit|type)/i.test(b)){s=g;break}}const o=a("feePercent","fee_percent","fees_percent","feeRate","rate_fee"),f=a("fees","fees_total","fee","fee_amount"),c=o!=null?"percent":"amount",v=a("active","isActive","enabled","is_enabled")??String(a("status")||"").toLowerCase()==="active";U({name:String(a("name")||""),code:String(a("code")||""),interestRate:String(a("interestRate","interest_rate","rate_percent","")||""),interestPeriod:String(a("interestPeriod","interest_period","period","periodicity","monthly")||"monthly").toLowerCase(),term:i!==void 0?String(i):"",termUnit:A(s),principalMin:new Intl.NumberFormat().format(Number(a("principalMin","principal_min","min_amount","minimum_principal","minPrincipal",0))),principalMax:new Intl.NumberFormat().format(Number(a("principalMax","principal_max","max_amount","maximum_principal","maxPrincipal",0))),feeType:c,fees:c==="amount"?new Intl.NumberFormat().format(Number(f||0)):"",feePercent:c==="percent"?String(o):"",active:!!v})}catch(r){d(I(r)||"Failed to load product")}finally{n||P(!1)}})(),()=>{n=!0}},[l,h]);const R=(n="lower")=>{const r=String(t.interestPeriod||"monthly").toLowerCase(),a=n==="upper"?r.toUpperCase():n==="capital"?r.charAt(0).toUpperCase()+r.slice(1):r,i=A(t.termUnit),s=n==="upper"?i.toUpperCase():n==="capital"?i.charAt(0).toUpperCase()+i.slice(1):i,o=y(t.principalMin)??0,f=y(t.principalMax)??0,c=t.feeType==="percent",v=y(t.fees)??0,b=Number(t.feePercent||0),m={name:(t.name||"").trim(),code:(t.code||"").trim()||null,interestRate:x(t.interestRate)??0,interest_rate:x(t.interestRate)??0,interestPeriod:a,interest_period:a,period:a,periodicity:a,term:x(t.term)??0,term_value:x(t.term)??0,duration:x(t.term)??0,tenor:x(t.term)??0,tenure:x(t.term)??0,termUnit:s,term_unit:s,termType:s,term_type:s,duration_unit:s,tenor_unit:s,tenure_unit:s,period_unit:s,principalMin:o,principal_min:o,min_amount:o,minimum_principal:o,minPrincipal:o,principalMax:f,principal_max:f,max_amount:f,maximum_principal:f,maxPrincipal:f,active:!!t.active,isActive:!!t.active,status:t.active?"active":"inactive"};return c?{...m,feePercent:b,fee_percent:b,fees_percent:b,feeRate:b,rate_fee:b,fees:0,fees_total:0,fee:0,fee_amount:0}:{...m,fees:v,fees_total:v,fee:v,fee_amount:v,feePercent:0,fee_percent:0,fees_percent:0,feeRate:0,rate_fee:0}},B=()=>{const n=y(t.principalMin)??0,r=y(t.principalMax)??0,a=x(t.term)??0,i=t.feeType==="percent",s=y(t.fees)??0,o=Number(t.feePercent||0);return{name:(t.name||"").trim(),code:(t.code||"").trim()||null,interest_rate:x(t.interestRate)??0,min_term_months:a||0,max_term_months:a||0,min_principal:n,max_principal:r,fees:i?0:s,penalty_rate:0,interest_method:"flat",status:t.active?"active":"inactive",fee_percent:i?o:0,eligibility:null}},L=async(n,r)=>{var a,i;try{return{ok:!0,res:await T.post("/loan-products",n,{headers:M()}),label:r,payload:n}}catch(s){return{ok:!1,label:r,payload:n,error:I(s),status:(a=s==null?void 0:s.response)==null?void 0:a.status,response:(i=s==null?void 0:s.response)==null?void 0:i.data}}},O=async()=>{var a,i;if(h){const s=["lower","upper","capital"],o=[];for(const f of s)try{const c=R(f);return await T.put(`/loan-products/${l}`,c,{headers:M()})}catch(c){o.push({v:f,status:(a=c==null?void 0:c.response)==null?void 0:a.status,error:I(c),response:(i=c==null?void 0:c.response)==null?void 0:i.data})}throw o}const n=await L(B(),"legacy");if(n.ok)return n.res;const r=[];for(const s of["lower","upper","capital"]){const o=await L(R(s),`modern-${s}`);if(o.ok)return o.res;r.push(o)}throw[n,...r]},W=async n=>{var i;n.preventDefault(),d(""),F(null);const r=y(t.principalMin)??0,a=y(t.principalMax)??0;if(!((i=t.name)!=null&&i.trim()))return d("Name is required");if(a&&r&&a<r)return d("Principal Max cannot be less than Principal Min");if(t.feeType==="percent"&&(Number(t.feePercent)<0||Number(t.feePercent)>100))return d("Fee % must be between 0 and 100");w(!0);try{await O(),u("/loans/products",{replace:!0})}catch(s){d("Failed to save product"),F(s)}finally{w(!1)}};return e.jsxs("div",{className:"max-w-5xl",children:[e.jsx("h1",{className:"text-xl font-semibold mb-4",children:h?"Edit Loan Product":"New Loan Product"}),j&&e.jsx("div",{className:"mb-3 rounded-md border border-rose-300 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:j}),N&&e.jsxs("details",{open:!0,className:"mb-3 rounded-md border border-amber-300 bg-amber-50 text-amber-800 px-3 py-2 text-xs",children:[e.jsx("summary",{className:"cursor-pointer select-none",children:"Show attempts"}),e.jsx("pre",{className:"overflow-auto whitespace-pre-wrap",children:JSON.stringify(N,null,2)})]}),e.jsxs("form",{onSubmit:W,className:"space-y-4 rounded-2xl border border-slate-300 dark:border-slate-800 p-5 bg-white dark:bg-slate-900 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Name"}),e.jsx("input",{name:"name",value:t.name,onChange:p,required:!0,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",placeholder:"e.g. Express Loan"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Code"}),e.jsx("input",{name:"code",value:t.code,onChange:p,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",placeholder:"e.g. 001"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Interest Rate (%)"}),e.jsx("input",{name:"interestRate",value:t.interestRate,onChange:p,type:"number",step:"0.01",min:"0",className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",placeholder:"e.g. 10"}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Will display with 2 decimals (e.g. 10.00)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Interest Period"}),e.jsxs("select",{name:"interestPeriod",value:t.interestPeriod,onChange:p,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 capitalize",children:[e.jsx("option",{value:"weekly",children:"Weekly"}),e.jsx("option",{value:"monthly",children:"Monthly"}),e.jsx("option",{value:"yearly",children:"Yearly"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Term"}),e.jsx("input",{name:"term",value:t.term,onChange:p,type:"number",min:"0",className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",placeholder:"e.g. 12"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Term Unit"}),e.jsxs("select",{name:"termUnit",value:t.termUnit,onChange:p,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 capitalize",children:[e.jsx("option",{value:"days",children:"Days"}),e.jsx("option",{value:"weeks",children:"Weeks"}),e.jsx("option",{value:"months",children:"Months"}),e.jsx("option",{value:"years",children:"Years"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Principal Min"}),e.jsx(C,{name:"principalMin",value:t.principalMin,onChange:p,placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Principal Max"}),e.jsx(C,{name:"principalMax",value:t.principalMax,onChange:p,placeholder:"0"})]}),e.jsxs("div",{className:"md:col-span-2 grid grid-cols-1 md:grid-cols-[200px_1fr] gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Fee Type"}),e.jsxs("select",{name:"feeType",value:t.feeType,onChange:p,className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2",children:[e.jsx("option",{value:"amount",children:"Amount (TZS)"}),e.jsx("option",{value:"percent",children:"Percentage (%)"})]})]}),t.feeType==="percent"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Fee (%)"}),e.jsx("input",{name:"feePercent",value:t.feePercent,onChange:p,type:"number",min:"0",max:"100",step:"0.01",placeholder:"e.g. 2.5",className:"w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2"})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Fee (Amount)"}),e.jsx(C,{name:"fees",value:t.fees,onChange:p,placeholder:"0"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("input",{id:"active",name:"active",type:"checkbox",checked:!!t.active,onChange:p,className:"h-5 w-5"}),e.jsx("label",{htmlFor:"active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx("button",{type:"submit",disabled:k||S,className:"px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:k?"Saving...":h?"Update Product":"Create Product"}),e.jsx("button",{type:"button",onClick:()=>u(-1),className:"px-3 py-2 rounded-md border border-slate-300 dark:border-slate-700",children:"Cancel"})]})]})]})}export{q as default};

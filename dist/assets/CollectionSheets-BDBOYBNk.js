import{r as a,j as e,L as T,b as se,x as ae}from"./index-Ctyu1vaI.js";import{u as le,L as re}from"./ListShell-PqtDwcn-.js";function oe(){const{pathname:s}=ae();return s.endsWith("/daily")?"daily":s.endsWith("/missed")?"missed":s.endsWith("/past-maturity")?"past-maturity":""}function ne(){var s;try{const o=localStorage.getItem("auth")||localStorage.getItem("user")||"",l=o?JSON.parse(o):{};return(l==null?void 0:l.role)||((s=l==null?void 0:l.user)==null?void 0:s.role)||"user"}catch{return"user"}}const ce=new Set(["admin","director","branch_manager"]),ie=new Set(["admin","director","branch_manager","comms"]);function de({summary:s}){if(!s)return null;const{total:o=0,byStatus:l={},byType:c={}}=s;return e.jsxs("div",{className:"mb-3 grid gap-2 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Total sheets"}),e.jsx("div",{className:"text-xl font-semibold",children:o})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"By status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.keys(l).length===0&&e.jsx("span",{className:"text-xs text-slate-400",children:"n/a"}),Object.entries(l).map(([r,h])=>e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border",children:[r,": ",h]},r))]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"By type"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.keys(c).length===0&&e.jsx("span",{className:"text-xs text-slate-400",children:"n/a"}),Object.entries(c).map(([r,h])=>e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border",children:[r,": ",h]},r))]})]})]})}function ue({open:s,onClose:o,children:l,title:c="Dialog"}){return s?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:o}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 w-full max-w-lg rounded-xl shadow-xl border",children:[e.jsx("div",{className:"p-3 border-b font-semibold",children:c}),e.jsx("div",{className:"p-4",children:l}),e.jsx("div",{className:"p-3 border-t text-right",children:e.jsx("button",{onClick:o,className:"px-3 py-1 text-sm border rounded hover:bg-gray-50",children:"Close"})})]})})]}):null}function pe(){const s=oe(),o=ne(),l=ce.has(o),c=ie.has(o),[r,h]=a.useState(""),[i,E]=a.useState(""),[d,B]=a.useState(""),[u,P]=a.useState(""),[m,_]=a.useState(""),[x,R]=a.useState(""),[y,w]=a.useState({}),[D,v]=a.useState(!1),[b,I]=a.useState("collector"),[S,C]=a.useState(""),[k,O]=a.useState(""),[L,F]=a.useState(!1),[M,f]=a.useState(""),$=a.useMemo(()=>{switch(s){case"daily":return"Showing today’s collection sheets.";case"missed":return"Sheets scheduled before today and not completed.";case"past-maturity":return"Sheets older than 30 days and not completed.";default:return"All collection sheets. Use filters to narrow results."}},[s]),A=a.useMemo(()=>{const t=new URLSearchParams;t.set("withSummary","1"),s&&t.set("scope",s),r&&t.set("status",r),i&&t.set("type",i),d&&t.set("dateFrom",d),u&&t.set("dateTo",u),m&&t.set("collector",m),x&&t.set("loanOfficer",x);const p=t.toString();return p?`/api/collections?${p}`:"/api/collections"},[s,r,i,d,u,m,x]),{rows:W,total:U,page:Y,setPage:q,limit:G,setLimit:z,q:j,setQ:H,loading:J,error:Q,summary:V}=le({url:A}),K=[{key:"__select__",title:"",render:t=>e.jsx("input",{type:"checkbox",checked:!!y[t.id],onChange:p=>w(n=>({...n,[t.id]:p.target.checked}))}),width:30},{key:"date",title:"Date"},{key:"type",title:"Type"},{key:"collector",title:"Collector"},{key:"loanOfficer",title:"Loan Officer"},{key:"status",title:"Status"},...l?[{key:"__actions__",title:"Actions",render:t=>e.jsx(T,{to:`/collections/${t.id}/edit`,className:"text-blue-600 hover:underline text-sm",children:"Edit"})}]:[]],X=a.useMemo(()=>{const t=new URLSearchParams;return s&&t.set("scope",s),j&&t.set("q",j),r&&t.set("status",r),i&&t.set("type",i),d&&t.set("dateFrom",d),u&&t.set("dateTo",u),m&&t.set("collector",m),x&&t.set("loanOfficer",x),t.set("export","csv"),`/api/collections?${t.toString()}`},[s,j,r,i,d,u,m,x]),Z=a.useMemo(()=>{switch(s){case"daily":return"Daily Collection Sheet";case"missed":return"Missed Repayment Sheet";case"past-maturity":return"Past Maturity Loans";default:return"Collection Sheets"}},[s]),N=a.useMemo(()=>Object.entries(y).filter(([,t])=>t).map(([t])=>t),[y]),ee=async()=>{var t,p;if(!c){f("You do not have permission to send SMS.");return}if(b!=="custom"&&N.length===0){f("Select at least one row.");return}if(!S.trim()){f("Message cannot be empty.");return}F(!0);try{const n={ids:N,to:b,message:S,customPhones:b==="custom"?k.split(/[,\s;]+/).map(te=>te.trim()).filter(Boolean):void 0},g=await se.post("/api/collections/bulk-sms",n);f(`Sent: ${g.data.sent} / ${g.data.total}${g.data.failed?`, failed: ${g.data.failed}`:""}`),v(!1),w({}),C(""),O("")}catch(n){f(((p=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:p.error)||n.message)}finally{F(!1)}};return e.jsxs(e.Fragment,{children:[M&&e.jsx("div",{className:"mb-2 text-sm p-2 rounded border bg-emerald-50 text-emerald-700",children:M}),e.jsx(de,{summary:V}),e.jsx(re,{title:Z,subtitle:e.jsx("span",{className:"text-xs text-slate-500",children:$}),q:j,setQ:H,columns:K,rows:W,loading:J,error:Q,page:Y,setPage:q,limit:G,setLimit:z,total:U,toolbar:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 w-full",children:[l&&e.jsx(T,{to:"/collections/new",className:"mr-3 border rounded px-3 py-1 text-sm bg-blue-600 text-white hover:bg-blue-700",children:"+ New Collection Sheet"}),e.jsx("label",{className:"text-sm",children:"Status"}),e.jsxs("select",{className:"border rounded px-2 py-1",value:r,onChange:t=>h(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"pending",children:"pending"}),e.jsx("option",{value:"completed",children:"completed"}),e.jsx("option",{value:"cancelled",children:"cancelled"})]}),e.jsx("label",{className:"text-sm ml-3",children:"Type"}),e.jsxs("select",{className:"border rounded px-2 py-1",value:i,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"FIELD",children:"FIELD"}),e.jsx("option",{value:"OFFICE",children:"OFFICE"}),e.jsx("option",{value:"AGENCY",children:"AGENCY"})]}),e.jsx("label",{className:"text-sm ml-3",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:d,onChange:t=>B(t.target.value)}),e.jsx("label",{className:"text-sm",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:u,onChange:t=>P(t.target.value)}),e.jsx("input",{placeholder:"Collector",className:"border rounded px-2 py-1 ml-3",value:m,onChange:t=>_(t.target.value)}),e.jsx("input",{placeholder:"Loan Officer",className:"border rounded px-2 py-1",value:x,onChange:t=>R(t.target.value)}),e.jsx("a",{href:X,className:"ml-auto inline-flex items-center border rounded px-3 py-1 text-sm hover:bg-gray-50",children:"Export CSV"}),c&&e.jsx("button",{type:"button",onClick:()=>v(!0),className:"border rounded px-3 py-1 text-sm bg-emerald-600 text-white hover:bg-emerald-700",children:"Bulk SMS"})]})}),e.jsx(ue,{open:D,onClose:()=>v(!1),title:"Send Bulk SMS",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:["Selected rows: ",e.jsx("b",{children:N.length})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Recipients"}),e.jsxs("select",{className:"border rounded w-full px-2 py-1",value:b,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"collector",children:"Collectors (from selected rows)"}),e.jsx("option",{value:"loanOfficer",children:"Loan Officers (from selected rows)"}),e.jsx("option",{value:"custom",children:"Custom phone numbers…"})]})]}),b==="custom"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Phone numbers (comma/space separated, E.164 or local)"}),e.jsx("textarea",{className:"border rounded w-full px-2 py-1 h-20",value:k,onChange:t=>O(t.target.value),placeholder:"+2557..., 0712..., 2557..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded w-full px-2 py-1 h-28",value:S,onChange:t=>C(t.target.value),placeholder:"Your message…"})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{disabled:L,onClick:ee,className:"border rounded px-3 py-1 text-sm bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50",children:L?"Sending…":"Send SMS"})})]})})]})}export{pe as default};

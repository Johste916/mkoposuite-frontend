import{r as n,j as t,y as E,h as w}from"./index-DOOrcP1L.js";const l={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900 dark:text-slate-100",h1:"text-3xl font-extrabold tracking-tight",card:"rounded-2xl border-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow",th:"bg-slate-50 dark:bg-slate-800 text-left text-[12px] uppercase tracking-wide text-slate-700 dark:text-slate-300 font-semibold px-3 py-2 border-b border-slate-200 dark:border-slate-700",td:"px-3 py-2 border-b border-slate-200 dark:border-slate-700 text-sm",btn:"inline-flex items-center rounded-lg border-2 border-slate-300 dark:border-slate-700 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-800 font-semibold"};function B(){const[N,u]=n.useState(!1),[v,b]=n.useState(!1),[x,S]=n.useState([]),[d,C]=n.useState([]),[y,h]=n.useState({}),[f,A]=n.useState(""),p=async()=>{var s,a;u(!0);try{const{data:e}=await w.get("/permissions/matrix"),r=Array.isArray(e==null?void 0:e.roles)?e.roles:[],o=Array.isArray(e==null?void 0:e.catalog)?e.catalog:[],i=typeof(e==null?void 0:e.matrix)=="object"&&(e!=null&&e.matrix)?e.matrix:{},c=Object.fromEntries(r.map(m=>[String(m.name).toLowerCase(),m.id])),j={};for(const[m,k]of Object.entries(i)){const z=Array.isArray(k)?k:[];j[m]=z.map(F=>c[String(F).toLowerCase()]).filter(Boolean)}C(r),S(o),h(j)}catch(e){console.error(e),alert(((a=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:a.error)||"Failed to load permission matrix")}finally{u(!1)}};n.useEffect(()=>{p()},[]);const g=n.useMemo(()=>{const s=f.trim().toLowerCase();return s?x.map(a=>({...a,actions:a.actions.filter(e=>e.key.toLowerCase().includes(s)||e.label.toLowerCase().includes(s))})).filter(a=>a.actions.length):x},[x,f]),L=(s,a)=>{h(e=>{const r=new Set(e[s]||[]);return r.has(a)?r.delete(a):r.add(a),{...e,[s]:Array.from(r)}})},$=(s,a)=>{h(e=>{const r={...e};for(const o of g)for(const i of o.actions){const c=new Set(r[i.key]||[]);a?c.add(s):c.delete(s),r[i.key]=Array.from(c)}return r})},R=async s=>{var e,r;const a=[];for(const o of x)for(const i of o.actions)new Set(y[i.key]||[]).has(s.id)&&a.push(i.key);if(!(!a.length&&!window.confirm(`You are removing all permissions for ${s.name}. Continue?`))){b(!0);try{await w.put(`/permissions/role/${s.id}`,{actions:a,mode:"replace"}),alert(`Saved permissions for role: ${s.name}`),await p()}catch(o){console.error(o),alert(((r=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:r.error)||"Failed to save")}finally{b(!1)}}};return t.jsxs("div",{className:l.page,children:[t.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4",children:[t.jsx("h1",{className:l.h1,children:"Permission Matrix"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:f,onChange:s=>A(s.target.value),placeholder:"Filter actions…",className:"h-10 w-64 rounded-lg border-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600"}),t.jsx("button",{onClick:p,className:l.btn,children:"Refresh"})]})]}),t.jsx("div",{className:`${l.card} overflow-auto`,children:t.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[t.jsx("thead",{className:"sticky top-0 z-10",children:t.jsxs("tr",{children:[t.jsx("th",{className:l.th,style:{position:"sticky",left:0,zIndex:11},children:"Feature / Action"}),d.map(s=>t.jsx("th",{className:`${l.th} text-center`,children:t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:"font-bold",children:s.name}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("label",{className:"text-[11px] opacity-70",children:[t.jsx("input",{type:"checkbox",onChange:a=>$(s.id,a.target.checked)})," ","All"]}),t.jsx("button",{className:"text-[11px] underline",onClick:()=>R(s),disabled:v,title:"Save only this role",children:"Save"})]})]})},s.id))]})}),t.jsx("tbody",{children:N?t.jsx("tr",{children:t.jsx("td",{className:l.td,colSpan:1+d.length,children:"Loading…"})}):g.length===0?t.jsx("tr",{children:t.jsx("td",{className:l.td,colSpan:1+d.length,children:"No actions match your filter."})}):g.map(s=>t.jsxs(E.Fragment,{children:[t.jsx("tr",{children:t.jsx("td",{className:`${l.td} font-semibold text-slate-700 dark:text-slate-200`,style:{position:"sticky",left:0,zIndex:10},colSpan:1+d.length,children:s.group})}),s.actions.map(a=>t.jsxs("tr",{className:"hover:bg-slate-50 dark:hover:bg-slate-800/60",children:[t.jsxs("td",{className:l.td,style:{position:"sticky",left:0,zIndex:9},title:a.key,children:[t.jsx("div",{className:"font-medium",children:a.label}),t.jsx("div",{className:"text-xs opacity-70",children:a.key})]}),d.map(e=>{const o=new Set(y[a.key]||[]).has(e.id);return t.jsx("td",{className:`${l.td} text-center`,children:t.jsx("input",{type:"checkbox",checked:o,onChange:()=>L(a.key,e.id)})},`${a.key}:${e.id}`)})]},a.key))]},s.group))})]})}),t.jsx("div",{className:"mt-4 text-sm opacity-80",children:"Tip: Use “All” under a role to toggle a whole column, then click “Save” for that role."})]})}export{B as default};

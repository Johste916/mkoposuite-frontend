import{r as c,h as v,j as n}from"./index-DYDSVKWX.js";import{B as H}from"./BorrowerAutoComplete-DlgnNQLe.js";const J=()=>(typeof v.getTenantId=="function"?v.getTenantId():null)||localStorage.getItem("activeTenantId")||null,K="00000000-0000-0000-0000-000000000000",Q=t=>!!t&&t!==K&&t!=="null"&&t!=="undefined",W=t=>t?{headers:{"x-tenant-id":t}}:{};function f(t){const o=(t||"").replace(/^\/+/,"");return Array.from(new Set([`/${o}`,`/api/${o}`,`/api/v1/${o}`,`/v1/${o}`]))}async function D(t=[],o={}){let s;for(const r of t)try{const u=await v.get(r,o);return u==null?void 0:u.data}catch(u){s=u}throw s||new Error("No endpoint succeeded")}async function N(t=[],o={},s={}){let r;for(const u of t)try{const p=await v.post(u,o,s);return p==null?void 0:p.data}catch(p){r=p}throw r||new Error("No endpoint succeeded")}function X(t){return(Array.isArray(t)?t:(t==null?void 0:t.items)||(t==null?void 0:t.rows)||(t==null?void 0:t.data)||[]).map(s=>({id:s.id??s._id??s.branchId??s.code??String(s.name||"branch"),name:s.name??s.title??s.label??String(s.code||"—")}))}function Z(t){return(Array.isArray(t)?t:(t==null?void 0:t.items)||(t==null?void 0:t.rows)||(t==null?void 0:t.data)||(t==null?void 0:t.results)||[]).map(s=>({id:s.id??s._id??s.userId??s.uuid??String(s.email||s.phone||"user"),name:s.name||[s.firstName,s.lastName].filter(Boolean).join(" ").trim()||s.username||s.email||s.phone||"—",roles:(s.roles||s.Roles||[]).map(r=>((r==null?void 0:r.name)||(r==null?void 0:r.code)||"").toString().toLowerCase()),title:(s.title||s.jobTitle||"").toString().toLowerCase()}))}const ee=t=>/loan.*officer|credit.*officer|field.*officer/i.test([...t.roles||[],t.title||""].join(" ")),te=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],i={container:"w-full px-4 md:px-6 lg:px-8 py-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-3xl font-extrabold tracking-tight mb-4",card:"rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow p-4",label:"block text-xs uppercase tracking-wide text-[var(--muted)] mb-1 font-semibold",input:"h-10 w-full rounded-lg border-2 px-3 outline-none focus:ring-2 focus:ring-[var(--ring)] bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)]",textarea:"w-full rounded-lg border-2 px-3 py-2 outline-none focus:ring-2 focus:ring-[var(--ring)] bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)]",primary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold hover:bg-indigo-700 disabled:opacity-60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",btn:"inline-flex items-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 hover:bg-[var(--kpi-bg)]",chip:"inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-bold bg-[var(--chip-soft)] text-[var(--fg)] ring-1 ring-[var(--border)]"};function ae(){const t=c.useMemo(()=>J(),[]),o=Q(t)?t:null,s=W(o),[r,u]=c.useState({name:"",branchId:"",meetingDay:"",loanOfficerId:"",notes:""}),[p,S]=c.useState([]),[I,A]=c.useState([]),[M,O]=c.useState(!0),[$,T]=c.useState(!0),[b,E]=c.useState(null),[h,y]=c.useState([]),[B,C]=c.useState(!1),[k,j]=c.useState(""),x=e=>u(a=>({...a,[e.target.name]:e.target.value}));c.useEffect(()=>{const e=new AbortController;return(async()=>{try{O(!0);const a=[o&&`tenants/${o}/branches`,"branches","org/branches"].filter(Boolean).flatMap(f),d=await D(a,{...s,signal:e.signal});S(X(d))}catch{S([])}finally{O(!1)}})(),()=>e.abort()},[o]),c.useEffect(()=>{const e=new AbortController;return(async()=>{try{T(!0);const a=[o&&`tenants/${o}/users?role=loan_officer`,"users?role=loan_officer","users?role=officer",o&&`tenants/${o}/users`,"users","admin/staff?role=loan_officer","admin/staff"].filter(Boolean).flatMap(f),d=await D(a,{...s,signal:e.signal}),g=Z(d),l=g.filter(ee);A(l.length?l:g)}catch{A([])}finally{T(!1)}})(),()=>e.abort()},[o]);const L=c.useMemo(()=>p.map(e=>({value:String(e.id),label:e.name||String(e.id)})),[p]),_=c.useMemo(()=>I.map(e=>({value:String(e.id),label:e.name||String(e.id)})),[I]);function G(){b!=null&&b.id&&(y(e=>e.some(a=>String(a.id)===String(b.id))?e:[...e,b]),E(null))}function w(e){y(a=>a.filter(d=>String(d.id)!==String(e)))}function P(e){var d;const a=(e==null?void 0:e.data)||e||{};return a.id||a.groupId||a._id||a.uuid||a.code||a.slug||Array.isArray(a.items)&&((d=a.items[0])==null?void 0:d.id)||null}async function U(e){if(!e||!h.length)return;const a=h.map(m=>m.id),d=[{borrowerIds:a},{members:a},{memberIds:a},{borrowers:a},{items:a}],g=[...f(`groups/${e}/members/bulk`),...f(`borrowers/groups/${e}/members/bulk`),...f(`loan-groups/${e}/members/bulk`),...f(`groups/${e}/members/import`)];for(const m of d)try{await N(g,m,s);return}catch{}const l=[...f(`groups/${e}/members`),...f(`borrowers/groups/${e}/members`),...f(`loan-groups/${e}/members`)];for(const m of a)try{await N(l,{borrowerId:m},s)}catch{}}const F=async e=>{var a,d,g;e.preventDefault(),C(!0),j("");try{const l=(r.loanOfficerId||"").trim()||null,m=h.map(z=>z.id),R={name:r.name.trim(),branchId:((a=r.branchId)==null?void 0:a.trim())||null,meetingDay:r.meetingDay?String(r.meetingDay).toLowerCase():null,loanOfficerId:l,loan_officer_id:l,notes:r.notes||null,members:m,memberIds:m,borrowers:m,groupMembers:m},V=[o&&`tenants/${o}/groups`,"groups","borrowers/groups","borrower-groups"].filter(Boolean).flatMap(f),q=await N(V,R,s),Y=P(q);await U(Y),j("✅ Group created."),u({name:"",branchId:"",meetingDay:"",loanOfficerId:"",notes:""}),y([])}catch(l){const m=((g=(d=l==null?void 0:l.response)==null?void 0:d.data)==null?void 0:g.error)||(l==null?void 0:l.message)||"Failed to create group.";j(`❌ ${m}`)}finally{C(!1)}};return n.jsxs("div",{className:i.container,children:[n.jsx("h1",{className:i.h1,children:"Add Group"}),n.jsx("form",{onSubmit:F,className:i.card,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Name"}),n.jsx("input",{name:"name",value:r.name,onChange:x,required:!0,className:i.input,placeholder:"Group name"})]}),n.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Branch"}),n.jsxs("select",{name:"branchId",value:r.branchId,onChange:x,className:i.input,disabled:M||!L.length,children:[n.jsx("option",{value:"",children:M?"Loading…":"(Select branch)"}),L.map(e=>n.jsx("option",{value:e.value,children:e.label},e.value))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Loan Officer"}),n.jsxs("select",{name:"loanOfficerId",value:r.loanOfficerId,onChange:x,className:i.input,disabled:$||!_.length,children:[n.jsx("option",{value:"",children:$?"Loading…":"(None yet)"}),_.map(e=>n.jsx("option",{value:e.value,children:e.label},e.value))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Meeting Day"}),n.jsxs("select",{name:"meetingDay",value:r.meetingDay,onChange:x,className:i.input,children:[n.jsx("option",{value:"",children:"(None)"}),te.map(e=>n.jsx("option",{value:e,children:e[0].toUpperCase()+e.slice(1)},e))]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Add Members (optional)"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"flex-1",children:n.jsx(H,{value:b,onChange:(e,a)=>E(a),placeholder:"Search borrower…"})}),n.jsx("button",{type:"button",className:i.btn,onClick:G,children:"Add"})]}),h.length>0&&n.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:h.map(e=>n.jsxs("span",{className:i.chip,children:[e.name||e.id,n.jsx("button",{type:"button",className:"ml-2 underline",onClick:()=>w(e.id),children:"remove"})]},e.id))})]}),n.jsxs("div",{children:[n.jsx("label",{className:i.label,children:"Notes"}),n.jsx("textarea",{name:"notes",value:r.notes,onChange:x,rows:3,className:i.textarea,placeholder:"Optional notes about this group"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{type:"submit",disabled:B,className:i.primary,children:B?"Saving…":"Create Group"}),k&&n.jsx("div",{className:"text-sm",children:k})]})]})})]})}export{ae as default};

import{i as E,u as I,r as d,g,j as e,L as v}from"./index-CeHYLxUd.js";import{W as A}from"./wallet-BLH_Qhjn.js";import{C as P}from"./calendar-CkHq3q9Z.js";import{S as M}from"./save-Dz-0JhTG.js";import"./createLucideIcon-BzVCG4Pe.js";const r={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900 dark:text-slate-100",h1:"text-3xl md:text-4xl font-black tracking-tight",sub:"text-sm text-slate-700 dark:text-slate-300",card:"rounded-2xl border-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-5 md:p-6 shadow-sm",label:"text-xs font-semibold uppercase tracking-wide text-slate-700 dark:text-slate-300",input:"w-full rounded-lg border-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-600 transition",badge:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full border-2 border-indigo-300 text-indigo-800 bg-indigo-50 dark:border-indigo-900/50 dark:text-indigo-300 dark:bg-indigo-950/30",btnGhost:"px-4 py-2 rounded-xl border-2 border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition",btnPrimary:"inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-700 text-white hover:bg-indigo-800 disabled:opacity-60 disabled:cursor-not-allowed shadow",alert:"rounded-xl border-2 border-rose-300 bg-rose-50 text-rose-800 dark:border-rose-900/60 dark:bg-rose-950/30 dark:text-rose-300 px-3 py-2 text-sm",divider:"border-t-2 border-slate-300 dark:border-slate-700"},O=[{value:"cash",label:"Cash"},{value:"bank",label:"Bank"},{value:"mobile_money",label:"Mobile Money"},{value:"other",label:"Other"}],R=s=>Array.isArray(s)?s:Array.isArray(s==null?void 0:s.items)?s.items:Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.results)?s.results:[],$=s=>{var m,x;const l=(m=s==null?void 0:s.response)==null?void 0:m.data;return typeof l=="string"?l:l!=null&&l.message?l.message:l!=null&&l.error?l.error:((x=s==null?void 0:s.response)==null?void 0:x.statusText)||(s==null?void 0:s.message)||"Server error"},C=(s,l="TZS")=>`‎${l} ${Number(s||0).toLocaleString()}`;function z(){var y,w,S;const{id:s}=E(),l=I(),m=d.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},[]),x=((m==null?void 0:m.role)||"").toLowerCase(),j=x==="admin"||x==="accountant",[n,D]=d.useState(null),[L,B]=d.useState([]),[f,N]=d.useState(!1),[k,p]=d.useState(""),h=d.useRef(null),[t,c]=d.useState({method:"cash",bankId:"",reference:"",amount:"",date:new Date().toISOString().slice(0,10),note:""});d.useEffect(()=>{(async()=>{try{const[a,u]=await Promise.all([g.get(`/loans/${s}`),g.get("/banks").catch(()=>({data:[]}))]),i=(a==null?void 0:a.data)||null;D(i),B(R(u==null?void 0:u.data)),i!=null&&i.amount&&!t.amount&&c(o=>({...o,amount:String(i.amount)}))}catch(a){p($(a))}})()},[s]);const T=async a=>{var u,i;if(a.preventDefault(),!!j){if(!t.amount||Number(t.amount)<=0)return alert("Enter a valid amount to disburse.");N(!0),p("");try{const o=new FormData;o.append("method",t.method),o.append("bankId",t.method==="bank"&&t.bankId||""),o.append("reference",t.reference||""),o.append("amount",t.amount||""),o.append("date",t.date||""),o.append("note",t.note||""),(i=(u=h.current)==null?void 0:u.files)!=null&&i[0]&&o.append("attachment",h.current.files[0]),await g.post(`/loans/${s}/disburse`,o,{headers:{"Content-Type":"multipart/form-data"}}),alert("Loan disbursed"),l(`/loans/${s}`)}catch(o){p($(o))}finally{N(!1)}}};return j?e.jsxs("div",{className:r.page,children:[e.jsxs("div",{className:"mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:r.h1,children:"Disburse Loan"}),n&&e.jsxs("p",{className:r.sub,children:["Borrower: ",e.jsx("b",{children:((y=n.Borrower)==null?void 0:y.name)||n.borrowerName||"—"})," • Amount: ",e.jsx("b",{children:C(n.amount,n.currency||"TZS")})]})]}),e.jsx(v,{to:`/loans/${s}`,className:"text-indigo-700 hover:underline text-sm font-semibold",children:"Back to Loan"})]}),k&&e.jsx("div",{className:`${r.alert} mb-4`,children:k}),e.jsxs("form",{onSubmit:T,className:"w-full",children:[n&&e.jsxs("section",{className:`${r.card} mb-6`,children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("span",{className:r.badge,children:[e.jsx(A,{className:"h-4 w-4"})," Loan Snapshot"]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 divide-y-2 sm:divide-y-0 sm:divide-x-2 divide-slate-300 dark:divide-slate-700 rounded-lg overflow-hidden border-2 border-slate-200 dark:border-slate-800",children:[e.jsx(b,{label:"Borrower",value:((w=n.Borrower)==null?void 0:w.name)||n.borrowerName||"—"}),e.jsx(b,{label:"Product",value:((S=n.Product)==null?void 0:S.name)||n.productName||"—"}),e.jsx(b,{label:"Approved Amount",value:C(n.amount,n.currency||"TZS")}),e.jsx(b,{label:"Status",value:(n.status||"—").replaceAll("_"," ")})]})]}),e.jsxs("section",{className:r.card,children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("span",{className:r.badge,children:[e.jsx(A,{className:"h-4 w-4"})," Disbursement Details"]})}),e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsx("label",{className:r.label,children:"Method"}),e.jsx("select",{className:r.input,value:t.method,onChange:a=>c({...t,method:a.target.value}),children:O.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsx("label",{className:r.label,children:"Amount"}),e.jsx("input",{type:"number",className:r.input,value:t.amount,onChange:a=>c({...t,amount:a.target.value})})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsxs("label",{className:`${r.label} flex items-center gap-1`,children:[e.jsx(P,{className:"h-3.5 w-3.5"})," Date"]}),e.jsx("input",{type:"date",className:r.input,value:t.date,onChange:a=>c({...t,date:a.target.value})})]}),t.method==="bank"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-span-12 md:col-span-6",children:[e.jsx("label",{className:r.label,children:"Bank"}),e.jsxs("select",{className:r.input,value:t.bankId,onChange:a=>c({...t,bankId:a.target.value}),children:[e.jsx("option",{value:"",children:"Select bank…"}),L.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{className:"col-span-12 md:col-span-6",children:[e.jsx("label",{className:r.label,children:"Reference"}),e.jsx("input",{className:r.input,value:t.reference,onChange:a=>c({...t,reference:a.target.value}),placeholder:"Txn ref / slip #"})]})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx("label",{className:r.label,children:"Note (optional)"}),e.jsx("textarea",{className:`${r.input} min-h-[110px]`,value:t.note,onChange:a=>c({...t,note:a.target.value})})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx("label",{className:r.label,children:"Upload slip / proof (optional)"}),e.jsx("input",{ref:h,type:"file",className:r.input})]})]})]}),e.jsxs("div",{className:"sticky bottom-0 inset-x-0 z-30 bg-white/95 dark:bg-slate-900/95 backdrop-blur",children:[e.jsx("div",{className:`${r.divider}`}),e.jsxs("div",{className:"px-4 md:px-6 lg:px-10 py-3 w-full flex justify-end gap-3",children:[e.jsx(v,{to:`/loans/${s}`,className:r.btnGhost,children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:f,className:r.btnPrimary,children:[e.jsx(M,{className:"h-4 w-4"}),f?"Disbursing…":"Disburse"]})]})]})]})]}):e.jsx("div",{className:r.page,children:e.jsxs("div",{className:r.card,children:[e.jsxs("p",{className:"text-sm",children:["You don’t have permission to disburse loans. This page is available to ",e.jsx("b",{children:"Admin"})," and ",e.jsx("b",{children:"Accountant"})," roles."]}),e.jsx("div",{className:"mt-4",children:e.jsx(v,{to:`/loans/${s}`,className:"text-indigo-700 hover:underline text-sm font-semibold",children:"Back to loan"})})]})})}function b({label:s,value:l}){return e.jsxs("div",{className:"p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-400",children:s}),e.jsx("div",{className:"text-base font-semibold text-slate-900 dark:text-white break-words",children:l??"—"})]})}export{z as default};

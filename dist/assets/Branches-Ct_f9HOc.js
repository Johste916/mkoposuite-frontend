import{r as l,g as G,j as e,v as os}from"./index-BVbJtkKt.js";const P=(s,t)=>s?["admin","director","super_admin","system_admin"].includes((s.role||"").toLowerCase())?!0:Array.isArray(s.permissions)&&s.permissions.includes(t):!1;async function T(s,t={}){try{const a=await G.get(s,t);return{ok:!0,data:a==null?void 0:a.data}}catch(a){return{ok:!1,error:a}}}async function _(s,t={},a={}){try{const c=await G.post(s,t,a);return{ok:!0,data:c==null?void 0:c.data}}catch(c){return{ok:!1,error:c}}}async function xe(s,t={},a={}){try{const c=await G.put(s,t,a);return{ok:!0,data:c==null?void 0:c.data}}catch(c){return{ok:!1,error:c}}}async function q(s,t={}){try{const a=await G.delete(s,t);return{ok:!0,data:a==null?void 0:a.data}}catch(a){return{ok:!1,error:a}}}async function xs(s){var t,a;for(const c of s){const h=await T(c,{params:{limit:1}});if(h.ok)return c;const f=(a=(t=h==null?void 0:h.error)==null?void 0:t.response)==null?void 0:a.status;if(f===401||f===403)return c}return null}const Ze=s=>String(s||"").replace(/\D+/g,""),qe=s=>{const t=String(s??"").trim();if(!t||!/^-?\d+$/.test(t))return null;const a=Number(t);return Number.isFinite(a)?a:null},W=s=>{const t=String(s??"").trim();return t.length?t:null};function ce(s){return s?Array.isArray(s)?s:s.items||s.rows||s.data||s.users||s.staff||s.borrowers||[]:[]}function Fe(s){var f;const t=(s==null?void 0:s.User)||(s==null?void 0:s.user)||s,a=(t==null?void 0:t.id)??(s==null?void 0:s.userId)??(s==null?void 0:s.id),c=(t==null?void 0:t.role)||(Array.isArray(t==null?void 0:t.Roles)?t.Roles.map(w=>w==null?void 0:w.name).filter(Boolean).join(", "):void 0)||(s==null?void 0:s.role)||((f=s==null?void 0:s.Role)==null?void 0:f.name),h=(t==null?void 0:t.name)||[t==null?void 0:t.firstName,t==null?void 0:t.lastName].filter(Boolean).join(" ").trim()||(s==null?void 0:s.name);return{id:a,name:h||"—",email:(t==null?void 0:t.email)||(s==null?void 0:s.email)||"—",role:c||"—"}}function ms(s){const t=(s==null?void 0:s.Borrower)||(s==null?void 0:s.borrower)||s;return{id:(t==null?void 0:t.id)??(s==null?void 0:s.borrowerId)??(s==null?void 0:s.id),name:(t==null?void 0:t.name)||(t==null?void 0:t.fullName)||(s==null?void 0:s.name)||"—",phone:(t==null?void 0:t.phone)||(s==null?void 0:s.phone)||"—",nationalId:(t==null?void 0:t.nationalId)||(s==null?void 0:s.nationalId)||"—",status:(t==null?void 0:t.status)||(s==null?void 0:s.status)||"—"}}function Ns(){const[s,t]=l.useState(null),[a,c]=l.useState("overview"),h=l.useMemo(()=>["/branches","/org/branches"],[]),[f,w]=l.useState(null),[$,m]=l.useState(!1),[j,S]=l.useState({branchId:"",focus:""});return l.useEffect(()=>{(async()=>{const v=await xs(h);v?(w(v),m(!1)):m(!0)})()},[h]),l.useEffect(()=>{(async()=>{try{const{data:v}=await G.get("/auth/me");t(v)}catch{}})()},[]),s?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Branches"}),e.jsx("p",{className:"text-xs text-slate-500",children:"View branches and perform common operations."}),$&&e.jsx("div",{className:"mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 inline-block",children:"Branches API not enabled on this backend. Listing/creating and assignments are disabled."})]}),e.jsxs("div",{className:"flex gap-2 rounded-lg border border-slate-200 bg-white p-1",children:[e.jsx(ne,{label:"Overview",id:"overview",tab:a,setTab:c}),P(s,"branches:manage")&&e.jsx(ne,{label:"Add",id:"add",tab:a,setTab:c}),P(s,"branches:assign")&&e.jsx(ne,{label:"Assign",id:"assign",tab:a,setTab:c}),e.jsx(ne,{label:"Reports",id:"reports",tab:a,setTab:c})]})]}),a==="overview"&&e.jsx(ps,{me:s,branchesBase:f,apiUnavailable:$,setTab:c,setReportInit:S}),a==="add"&&P(s,"branches:manage")&&e.jsx(fs,{branchesBase:f,apiUnavailable:$}),a==="assign"&&P(s,"branches:assign")&&e.jsx(js,{branchesBase:f,apiUnavailable:$}),a==="reports"&&e.jsx(ys,{branchesBase:f,apiUnavailable:$,initialBranchId:j.branchId,initialFocus:j.focus})]}):e.jsx("div",{className:"p-4",children:"Loading…"})}function Z({className:s="",children:t,...a}){return e.jsx("button",{...a,className:["px-3 py-2 rounded-lg text-sm font-medium","bg-indigo-600 text-white border border-indigo-600","hover:bg-indigo-700","disabled:opacity-60 disabled:hover:bg-indigo-600","focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-1",s].join(" "),children:t})}function L({className:s="",children:t,...a}){return e.jsx("button",{...a,className:["px-3 py-2 rounded-lg text-sm font-medium","bg-white text-slate-800 border border-slate-300 hover:bg-slate-50","focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 focus-visible:ring-offset-1","disabled:opacity-60",s].join(" "),children:t})}function He({className:s="",children:t,...a}){return e.jsx("button",{...a,className:["px-3 py-2 rounded-lg text-sm font-medium","bg-red-600 text-white border border-red-600 hover:bg-red-700","focus:outline-none focus-visible:ring-2 focus-visible:ring-red-300 focus-visible:ring-offset-1","disabled:opacity-60",s].join(" "),children:t})}function ne({label:s,id:t,tab:a,setTab:c}){const h=a===t;return e.jsx("button",{onClick:()=>c(t),"aria-current":h?"page":void 0,className:["px-3 py-1.5 text-sm rounded-md transition-colors","focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-1",h?"bg-indigo-600 text-white shadow-sm":"text-slate-700 hover:bg-slate-100"].join(" "),children:s})}function me({children:s}){return typeof document>"u"?null:os.createPortal(s,document.body)}function us(s,t){l.useEffect(()=>{const a=c=>{s.some(f=>f.current&&f.current.contains(c.target))||t()};return document.addEventListener("mousedown",a,!0),document.addEventListener("touchstart",a,{passive:!0,capture:!0}),()=>{document.removeEventListener("mousedown",a,!0),document.removeEventListener("touchstart",a,!0)}},[s,t])}function hs({actions:s=[]}){const[t,a]=l.useState(!1),c=l.useRef(null),h=l.useRef(null),[f,w]=l.useState({top:0,left:0}),$=()=>{var y;const m=(y=c.current)==null?void 0:y.getBoundingClientRect();if(!m)return;const j=200,S=6;let v=Math.min(Math.max(8,m.right-j),window.innerWidth-j-8),I=m.bottom+S;const k=8+s.length*36;I+k>window.innerHeight-8&&(I=Math.max(8,m.top-S-k)),w({top:I,left:v})};return l.useLayoutEffect(()=>{if(!t)return;$();const m=()=>$(),j=()=>$();return window.addEventListener("scroll",m,!0),window.addEventListener("resize",j),()=>{window.removeEventListener("scroll",m,!0),window.removeEventListener("resize",j)}},[t,s.length]),us([c,h],()=>a(!1)),l.useEffect(()=>{if(!t)return;const m=j=>j.key==="Escape"&&a(!1);return document.addEventListener("keydown",m),()=>document.removeEventListener("keydown",m)},[t]),e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:c,className:"px-2 py-1 border rounded hover:bg-gray-50",onClick:()=>a(m=>!m),"aria-label":"Actions",title:"Actions",children:"⋮"}),t&&e.jsxs(me,{children:[e.jsx("div",{className:"fixed inset-0 z-50",style:{background:"transparent"},onClick:()=>a(!1)}),e.jsx("div",{ref:h,className:"fixed z-[60] min-w-[200px] bg-white border shadow-lg rounded-md",style:{top:f.top,left:f.left},onClick:m=>m.stopPropagation(),children:s.map((m,j)=>e.jsx("button",{onClick:()=>{var S;m.disabled||(a(!1),(S=m.onClick)==null||S.call(m))},disabled:m.disabled,className:`w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${m.danger?"text-red-700":""} disabled:opacity-50`,children:m.label},j))})]})]})}function ps({me:s,branchesBase:t,apiUnavailable:a,setTab:c,setReportInit:h}){var we,ke,Ce,$e,Ae,Ee,Ie,Oe,De,Le,Re,Pe,Te,ze,Me,Ue,Be;const[f,w]=l.useState([]),[$,m]=l.useState(""),[j,S]=l.useState(""),[v,I]=l.useState(!1),[k,y]=l.useState(!1),[b,i]=l.useState(null),[x,d]=l.useState(!1),[o,p]=l.useState(null),[u,A]=l.useState(!1),[z,U]=l.useState(null),[le,ue]=l.useState(!1),[R,_e]=l.useState(null),[Q,re]=l.useState([]),[he,pe]=l.useState(""),[X,J]=l.useState(new Set),[Ve,fe]=l.useState(!1),[B,Ke]=l.useState(null),[Y,ge]=l.useState([]),[ie,je]=l.useState(""),[ee,se]=l.useState(new Set),[Ge,F]=l.useState(!1),[O,Qe]=l.useState(null),[D,ye]=l.useState(null),[be,Ne]=l.useState(""),[Xe,ve]=l.useState(!1),[Je,Ye]=l.useState(null),V=async()=>{var r,g,N,E;if(!t){w([]),S(a?"":"Detecting endpoint…");return}I(!0),S("");const n=await T(t,{params:{q:$}});if(I(!1),n.ok){const C=n.data,H=Array.isArray(C==null?void 0:C.items)?C.items:Array.isArray(C)?C:(C==null?void 0:C.rows)||(C==null?void 0:C.data)||[];w(H)}else S(((N=(g=(r=n==null?void 0:n.error)==null?void 0:r.response)==null?void 0:g.data)==null?void 0:N.error)||((E=n==null?void 0:n.error)==null?void 0:E.message)||"Failed to load branches."),w([])};l.useEffect(()=>{V()},[t]);const es=n=>{i({id:n.id,name:n.name||"",code:n.code??"",phone:n.phone??"",address:n.address??"",managerId:n.managerId??n.manager??""}),y(!0)},ss=n=>{p(n),d(!0)},ts=n=>{U(n),A(!0)},ns=n=>{Ye(n),ve(!0)},te=async n=>{var g,N,E,C;if(_e(n),ue(!0),re([]),pe(""),J(new Set),!t||!(n!=null&&n.id))return;let r=await T(`${t}/${n.id}/staff`);if(r.ok){const H=ce(r.data);re(H.map(Fe).filter(K=>K.id!=null));return}if(r=await T("/users",{params:{branchId:n==null?void 0:n.id,limit:1e3}}),r.ok){const H=ce(r.data);re(H.map(Fe).filter(K=>K.id!=null))}else pe(((E=(N=(g=r==null?void 0:r.error)==null?void 0:g.response)==null?void 0:N.data)==null?void 0:E.error)||((C=r==null?void 0:r.error)==null?void 0:C.message)||"Failed to load staff.")},de=async n=>{var g,N,E,C;Ke(n),fe(!0),ge([]),je(""),se(new Set);let r=await T(`${t}/${n==null?void 0:n.id}/borrowers`);if(r.ok||(r=await T("/borrowers",{params:{branchId:n==null?void 0:n.id,limit:1e3}})),r.ok){const H=ce(r.data);ge(H.map(ms).filter(K=>K.id!=null))}else je(((E=(N=(g=r==null?void 0:r.error)==null?void 0:g.response)==null?void 0:N.data)==null?void 0:E.error)||((C=r==null?void 0:r.error)==null?void 0:C.message)||"Borrowers endpoint not available.")},Se=(n,r,g)=>{const N=new Set(n);N.has(r)?N.delete(r):N.add(r),g(N)},as=async()=>{var g,N,E,C;if(!t||!(b!=null&&b.id))return;const n={name:W(b.name),code:b.code==null?null:String(b.code).trim(),phone:W(Ze(b.phone)),address:W(b.address),...b.managerId!==""?{managerId:b.managerId}:{}},r=await xe(`${t}/${b.id}`,n);r.ok?(y(!1),i(null),V()):alert(((E=(N=(g=r==null?void 0:r.error)==null?void 0:g.response)==null?void 0:N.data)==null?void 0:E.error)||((C=r==null?void 0:r.error)==null?void 0:C.message)||"Failed to update branch.")},ls=async()=>{var r,g,N,E;if(!t||!(o!=null&&o.id))return;const n=await q(`${t}/${o.id}`);n.ok||alert(((N=(g=(r=n==null?void 0:n.error)==null?void 0:r.response)==null?void 0:g.data)==null?void 0:N.error)||((E=n==null?void 0:n.error)==null?void 0:E.message)||"Failed to disable branch."),d(!1),p(null),V()},rs=async()=>{var r,g,N,E;if(!t||!(z!=null&&z.id))return;const n=await q(`${t}/${z.id}`,{params:{force:1,hard:1},headers:{"X-Force-Delete":"1"},data:{force:!0}});n.ok||alert(((N=(g=(r=n==null?void 0:n.error)==null?void 0:r.response)==null?void 0:g.data)==null?void 0:N.error)||((E=n==null?void 0:n.error)==null?void 0:E.message)||"Failed to delete branch."),A(!1),U(null),V()},is=async n=>{var g,N,E,C;if(Qe(n),F(!0),ye(null),Ne(""),!t||!(n!=null&&n.id))return;const r=await T(`${t}/${n.id}/overview`);r.ok?ye(r.data):Ne(((E=(N=(g=r==null?void 0:r.error)==null?void 0:g.response)==null?void 0:N.data)==null?void 0:E.error)||((C=r==null?void 0:r.error)==null?void 0:C.message)||"Failed to load overview.")},ds=async()=>{const n=[...X];if(!n.length||!t||!(R!=null&&R.id))return;if(!(await _(`${t}/${R.id}/unassign-staff`,{userIds:n})).ok)for(const g of n){let N=await q(`${t}/${R.id}/staff/${g}`);N.ok||(N=await q(`${t}/${R.id}/staff`,{params:{userId:g}}))}te(R)},cs=async()=>{const n=[...ee];if(!n.length||!t||!(B!=null&&B.id))return;if(!(await _(`${t}/${B.id}/unassign-borrowers`,{borrowerIds:n})).ok)for(const g of n)await xe(`/borrowers/${g}`,{branchId:null});de(B)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl p-3 flex gap-3 items-end",children:[e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-0.5",children:"Search"}),e.jsx("span",{className:"pointer-events-none absolute left-2 top-[30px]",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true",children:e.jsx("path",{d:"M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"})})}),e.jsx("input",{className:`border border-slate-300 rounded-lg pl-8 pr-3 py-2 text-sm placeholder:text-slate-400\r
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400`,value:$,onChange:n=>m(n.target.value),placeholder:"name, code, phone…"})]}),e.jsx(Z,{onClick:V,disabled:!t||v,children:v?"Loading…":"Apply"})]}),j&&e.jsx("div",{className:"text-sm text-red-600",children:j}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Code"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"Address"}),e.jsx("th",{className:"py-2 px-3",children:"Manager"}),e.jsx("th",{className:"py-2 px-3 w-1",children:"Actions"})]})}),e.jsx("tbody",{children:f.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-3 text-gray-500",children:t?"No branches yet.":"Waiting for endpoint…"})}):f.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:n.name}),e.jsx("td",{className:"py-2 px-3",children:n.code??"—"}),e.jsx("td",{className:"py-2 px-3",children:n.phone??"—"}),e.jsx("td",{className:"py-2 px-3",children:n.address??"—"}),e.jsx("td",{className:"py-2 px-3",children:n.managerName||n.manager_id||n.managerId||"—"}),e.jsx("td",{className:"py-2 px-3",children:e.jsx(hs,{actions:[{label:"Overview",onClick:()=>is(n)},{label:"Staff",onClick:()=>te(n)},{label:"Borrowers",onClick:()=>de(n)},P({...s},"branches:assign")?{label:"Assign…",onClick:()=>ns(n)}:{label:"Assign…",disabled:!0},P({...s},"branches:manage")?{label:"Edit",onClick:()=>es(n)}:{label:"Edit",disabled:!0},P({...s},"branches:manage")?{label:"Disable",onClick:()=>ss(n),danger:!0}:{label:"Disable",disabled:!0},P({...s},"branches:manage")?{label:"Delete",onClick:()=>ts(n),danger:!0}:{label:"Delete",disabled:!0}]})})]},n.id??n.code??Math.random()))})]})}),k&&e.jsxs(oe,{onClose:()=>y(!1),title:"Edit Branch",children:[e.jsx("div",{className:"grid gap-2",children:["name","code","phone","address","managerId"].map(n=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:n==="managerId"?"Manager ID":n}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:(b==null?void 0:b[n])??"",onChange:r=>i(g=>({...g,[n]:r.target.value})),placeholder:n==="code"?"e.g. 1":n==="phone"?"digits only":""})]},n))}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx(L,{onClick:()=>y(!1),children:"Cancel"}),e.jsx(Z,{onClick:as,children:"Save"})]})]}),x&&e.jsxs(oe,{onClose:()=>d(!1),title:"Disable Branch",children:[e.jsxs("p",{className:"text-sm",children:["This will ",e.jsx("b",{children:"soft-delete"})," the branch (disable). Continue?"]}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx(L,{onClick:()=>d(!1),children:"Cancel"}),e.jsx(He,{onClick:ls,children:"Disable"})]})]}),u&&e.jsxs(oe,{onClose:()=>A(!1),title:"Delete Branch",children:[e.jsxs("p",{className:"text-sm",children:["This will ",e.jsx("b",{children:"permanently delete"})," the branch. Continue?"]}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx(L,{onClick:()=>A(!1),children:"Cancel"}),e.jsx(He,{onClick:rs,children:"Delete"})]})]}),le&&e.jsxs(ae,{title:`Staff • ${(R==null?void 0:R.name)||""}`,onClose:()=>ue(!1),full:!0,children:[he&&e.jsx("div",{className:"text-sm text-red-600 mb-2",children:he}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[Q.length," staff"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{className:"px-2 py-1",onClick:()=>J(new Set(Q.map(n=>n.id))),children:"Select all"}),e.jsx(L,{className:"px-2 py-1",onClick:()=>J(new Set),children:"Clear"}),e.jsx(L,{className:"px-2 py-1 disabled:opacity-50",disabled:X.size===0||!P({...s},"branches:assign"),onClick:ds,children:"Unassign selected"})]})]}),e.jsx("div",{className:"border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Pick"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"}),e.jsx("th",{className:"py-2 px-3 w-1",children:"Single"})]})}),e.jsx("tbody",{children:(Q||[]).length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-gray-500",children:"No staff assigned."})}):Q.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:X.has(n.id),onChange:()=>Se(X,n.id,J)})}),e.jsx("td",{className:"py-2 px-3",children:n.name||"—"}),e.jsx("td",{className:"py-2 px-3",children:n.email||"—"}),e.jsx("td",{className:"py-2 px-3",children:n.role||"—"}),e.jsx("td",{className:"py-2 px-3",children:e.jsx(L,{className:"px-2 py-1",onClick:async()=>{let r=await q(`${t}/${R.id}/staff/${n.id}`);r.ok||(r=await q(`${t}/${R.id}/staff`,{params:{userId:n.id}})),te(R)},disabled:!P({...s},"branches:assign"),children:"Unassign"})})]},n.id))})]})})]}),Ve&&e.jsxs(ae,{title:`Borrowers • ${(B==null?void 0:B.name)||""}`,onClose:()=>fe(!1),full:!0,children:[ie&&e.jsx("div",{className:"text-sm text-amber-700 mb-2",children:ie}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[Y.length," borrowers"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{className:"px-2 py-1",onClick:()=>se(new Set(Y.map(n=>n.id))),children:"Select all"}),e.jsx(L,{className:"px-2 py-1",onClick:()=>se(new Set),children:"Clear"}),e.jsx(L,{className:"px-2 py-1 disabled:opacity-50",disabled:ee.size===0||!P({...s},"branches:assign"),onClick:cs,children:"Unassign selected"})]})]}),e.jsx("div",{className:"border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Pick"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"National ID"}),e.jsx("th",{className:"py-2 px-3",children:"Status"})]})}),e.jsx("tbody",{children:(Y||[]).length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-gray-500",children:ie?"Endpoint not available.":"No borrowers found."})}):Y.map(n=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:ee.has(n.id),onChange:()=>Se(ee,n.id,se)})}),e.jsx("td",{className:"py-2 px-3",children:n.name||"—"}),e.jsx("td",{className:"py-2 px-3",children:n.phone||"—"}),e.jsx("td",{className:"py-2 px-3",children:n.nationalId||"—"}),e.jsx("td",{className:"py-2 px-3",children:n.status||"—"})]},n.id))})]})})]}),Ge&&e.jsxs(ae,{title:`Overview • ${(O==null?void 0:O.name)||""}`,onClose:()=>F(!1),wide:!0,children:[be&&e.jsx("div",{className:"text-sm text-red-600 mb-2",children:be}),D?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(M,{title:"Staff",value:((we=D.kpis)==null?void 0:we.staffCount)??"—",tone:"indigo",onClick:()=>{F(!1),te(O)}}),e.jsx(M,{title:"Borrowers",value:((ke=D.kpis)==null?void 0:ke.borrowers)??"—",tone:"blue",onClick:()=>{F(!1),de(O)}}),e.jsx(M,{title:"Loans Out",value:(($e=(Ce=D.kpis)==null?void 0:Ce.loans)==null?void 0:$e.total)!=null?`TZS ${Number(D.kpis.loans.total).toLocaleString()}`:"—",tone:"emerald",onClick:()=>{h({branchId:O==null?void 0:O.id,focus:"loans"}),F(!1),c("reports")}}),e.jsx(M,{title:"Outstanding",value:((Ee=(Ae=D.kpis)==null?void 0:Ae.loans)==null?void 0:Ee.outstanding)!=null?`TZS ${Number(D.kpis.loans.outstanding).toLocaleString()}`:"—",tone:"amber",onClick:()=>{h({branchId:O==null?void 0:O.id,focus:"outstanding"}),F(!1),c("reports")}}),e.jsx(M,{title:"Collections (30d)",value:((Oe=(Ie=D.kpis)==null?void 0:Ie.collections)==null?void 0:Oe.last30Days)!=null?`TZS ${Number(D.kpis.collections.last30Days).toLocaleString()}`:"—",tone:"indigo",onClick:()=>{h({branchId:O==null?void 0:O.id,focus:"collections"}),F(!1),c("reports")}}),e.jsx(M,{title:"Expenses (this month)",value:((Le=(De=D.kpis)==null?void 0:De.expenses)==null?void 0:Le.thisMonth)!=null?`TZS ${Number(D.kpis.expenses.thisMonth).toLocaleString()}`:"—",tone:"rose",onClick:()=>{h({branchId:O==null?void 0:O.id,focus:"expenses"}),F(!1),c("reports")}})]}),e.jsxs("div",{className:"bg-white border rounded-xl p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"Branch"}),e.jsxs("div",{className:"grid sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Name:"})," ",((Re=D.branch)==null?void 0:Re.name)||"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Code:"})," ",((Pe=D.branch)==null?void 0:Pe.code)??"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Phone:"})," ",((Te=D.branch)==null?void 0:Te.phone)||"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Address:"})," ",((ze=D.branch)==null?void 0:ze.address)||"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Created:"})," ",((Ue=(Me=D.branch)==null?void 0:Me.createdAt)==null?void 0:Ue.slice(0,10))||"—"]}),e.jsxs("div",{children:[e.jsx("b",{children:"Tenant ID:"})," ",((Be=D.branch)==null?void 0:Be.tenantId)||"—"]})]})]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Loading…"})]}),Xe&&e.jsx(gs,{me:s,branchesBase:t,branch:Je,onClose:()=>ve(!1)})]})}function fs({branchesBase:s,apiUnavailable:t}){const[a,c]=l.useState({name:"",code:"",phone:"",address:""}),[h,f]=l.useState(!1),[w,$]=l.useState(""),[m,j]=l.useState(""),[S,v]=l.useState(""),I=async()=>{var b,i,x;if(!s){j(t?"Branches API not available.":"Detecting endpoint…");return}f(!0),j(""),$(""),v("");const k={name:W(a.name),code:a.code==null?null:String(a.code).trim(),phone:W(Ze(a.phone)),address:W(a.address)},y=await _(s,k);if(f(!1),y.ok)$("Branch created."),c({name:"",code:"",phone:"",address:""});else{const d=(i=(b=y==null?void 0:y.error)==null?void 0:b.response)==null?void 0:i.data;v((d==null?void 0:d.requestId)||""),j((d==null?void 0:d.error)||(d==null?void 0:d.message)||((x=y==null?void 0:y.error)==null?void 0:x.message)||"Failed to create branch")}};return e.jsxs("div",{className:"bg-white border rounded-xl p-3 grid gap-2 md:grid-cols-4 items-end",children:[["name","code","phone","address"].map(k=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:k}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:a[k],onChange:y=>c(b=>({...b,[k]:y.target.value})),placeholder:k==="code"?"e.g. 1":k==="phone"?"digits only":""})]},k)),e.jsx(Z,{onClick:I,disabled:h||!s,children:h?"Saving…":"Create"}),w&&e.jsx("div",{className:"text-sm text-emerald-700",children:w}),(m||S)&&e.jsxs("div",{className:"text-sm text-red-600 col-span-full",children:[m," ",S?e.jsxs("span",{className:"text-xs opacity-80",children:["(requestId: ",S,")"]}):null]})]})}function gs({me:s,branchesBase:t,branch:a,onClose:c}){const[h,f]=l.useState([]),[w,$]=l.useState([]),[m,j]=l.useState(new Set),[S,v]=l.useState(new Set),[I,k]=l.useState(""),[y,b]=l.useState("");l.useEffect(()=>{(async()=>{const[o,p]=await Promise.all([T("/users",{params:{limit:1e3}}),T("/borrowers",{params:{limit:1e3}})]);if(o.ok){const u=o.data,A=(u==null?void 0:u.items)||(u==null?void 0:u.rows)||(u==null?void 0:u.data)||u||[];f(A)}if(p.ok){const u=p.data,A=(u==null?void 0:u.items)||(u==null?void 0:u.rows)||(u==null?void 0:u.data)||u||[];$(A)}})()},[]);const i=async()=>{var u,A,z,U;if(!t||!(a!=null&&a.id))return;const o=[...m],p=await _(`${t}/${a.id}/assign-staff`,{userIds:o});p.ok?(k(`Assigned ${o.length} staff.`),b("")):b(((z=(A=(u=p==null?void 0:p.error)==null?void 0:u.response)==null?void 0:A.data)==null?void 0:z.error)||((U=p==null?void 0:p.error)==null?void 0:U.message)||"Failed to assign staff.")},x=async()=>{var u,A,z,U;if(!t||!(a!=null&&a.id))return;const o=[...S];let p=await _(`${t}/${a.id}/assign-borrowers`,{borrowerIds:o});if(!p.ok){for(const le of o)await xe(`/borrowers/${le}`,{branchId:a.id});p={ok:!0}}p.ok?(k(`Assigned ${o.length} borrowers.`),b("")):b(((z=(A=(u=p==null?void 0:p.error)==null?void 0:u.response)==null?void 0:A.data)==null?void 0:z.error)||((U=p==null?void 0:p.error)==null?void 0:U.message)||"Failed to assign borrowers.")},d=(o,p,u)=>{const A=new Set(o);A.has(p)?A.delete(p):A.add(p),u(A)};return e.jsxs(ae,{title:`Assign • ${(a==null?void 0:a.name)||""}`,onClose:c,wide:!0,children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium",children:"Staff"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{className:"px-2 py-1",onClick:()=>j(new Set(h.map(o=>o.id))),children:"Select all"}),e.jsx(L,{className:"px-2 py-1",onClick:()=>j(new Set),children:"Clear"}),e.jsx(Z,{className:"px-2 py-1",disabled:!P({...s},"branches:assign")||m.size===0,onClick:i,children:"Assign selected"})]})]}),e.jsx("div",{className:"border rounded-xl overflow-x-auto max-h-[45vh]",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Pick"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"})]})}),e.jsx("tbody",{children:h.map(o=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:m.has(o.id),onChange:()=>d(m,o.id,j)})}),e.jsx("td",{className:"py-2 px-3",children:o.name||`${o.firstName||""} ${o.lastName||""}`.trim()}),e.jsx("td",{className:"py-2 px-3",children:o.email}),e.jsx("td",{className:"py-2 px-3",children:o.role||(o.Roles||[]).map(p=>p.name).join(", ")||"—"})]},o.id))})]})})]}),e.jsxs("div",{className:"bg-white border rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium",children:"Borrowers"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{className:"px-2 py-1",onClick:()=>v(new Set(w.map(o=>o.id))),children:"Select all"}),e.jsx(L,{className:"px-2 py-1",onClick:()=>v(new Set),children:"Clear"}),e.jsx(Z,{className:"px-2 py-1",disabled:!P({...s},"branches:assign")||S.size===0,onClick:x,children:"Assign selected"})]})]}),e.jsx("div",{className:"border rounded-xl overflow-x-auto max-h-[45vh]",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Pick"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"National ID"})]})}),e.jsx("tbody",{children:w.map(o=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:S.has(o.id),onChange:()=>d(S,o.id,v)})}),e.jsx("td",{className:"py-2 px-3",children:o.name||o.fullName||"—"}),e.jsx("td",{className:"py-2 px-3",children:o.phone||"—"}),e.jsx("td",{className:"py-2 px-3",children:o.nationalId||"—"})]},o.id))})]})})]})]}),(I||y)&&e.jsx("div",{className:`mt-3 text-sm ${y?"text-red-600":"text-emerald-700"}`,children:y||I})]})}function js({branchesBase:s,apiUnavailable:t}){const[a,c]=l.useState([]),[h,f]=l.useState([]),[w,$]=l.useState(""),[m,j]=l.useState([]),[S,v]=l.useState(""),[I,k]=l.useState("");l.useEffect(()=>{(async()=>{if(!s)return;const[i,x]=await Promise.all([T(s),T("/users",{params:{limit:1e3}})]);if(i.ok){const d=i.data,o=Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d)?d:(d==null?void 0:d.rows)||(d==null?void 0:d.data)||[];c(o)}if(x.ok){const d=x.data,o=(d==null?void 0:d.items)||(d==null?void 0:d.rows)||(d==null?void 0:d.data)||d||[];f(o)}})()},[s]);const y=i=>j(x=>x.includes(i)?x.filter(d=>d!==i):[...x,i]),b=async()=>{var d,o,p,u;if(v(""),k(""),!s){k(t?"Branches API not available.":"Detecting endpoint…");return}const i=qe(w);if(i==null){k("Invalid branch selected.");return}const x=await _(`${s}/${i}/assign-staff`,{userIds:m});x.ok?v("Assigned successfully."):k(((p=(o=(d=x==null?void 0:x.error)==null?void 0:d.response)==null?void 0:o.data)==null?void 0:p.error)||((u=x==null?void 0:x.error)==null?void 0:u.message)||"Failed to assign staff.")};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:w,onChange:i=>$(i.target.value),disabled:!s,children:[e.jsx("option",{value:"",children:"Select branch"}),a.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id??i.code))]})]}),e.jsxs(Z,{onClick:b,disabled:!w||m.length===0||!s,children:["Assign ",m.length?`(${m.length})`:""]}),S&&e.jsx("div",{className:"text-sm text-emerald-700",children:S}),I&&e.jsx("div",{className:"text-sm text-red-600",children:I})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"})]})}),e.jsx("tbody",{children:h.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"p-3 text-gray-500",children:s?"No users.":"Waiting for endpoint…"})}):h.map(i=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:m.includes(i.id),onChange:()=>y(i.id)})}),e.jsx("td",{className:"py-2 px-3",children:i.name||`${i.firstName||""} ${i.lastName||""}`.trim()}),e.jsx("td",{className:"py-2 px-3",children:i.email}),e.jsx("td",{className:"py-2 px-3",children:i.role||(i.Roles||[]).map(x=>x.name).join(", ")||"—"})]},i.id))})]})})]})}function ys({branchesBase:s,apiUnavailable:t,initialBranchId:a=""}){const[c,h]=l.useState([]),[f,w]=l.useState(a||""),[$,m]=l.useState(""),[j,S]=l.useState(""),[v,I]=l.useState(null),[k,y]=l.useState("");l.useEffect(()=>{a&&w(String(a))},[a]),l.useEffect(()=>{(async()=>{if(!s)return;const i=await T(s);if(i.ok){const x=i.data,d=Array.isArray(x==null?void 0:x.items)?x.items:Array.isArray(x)?x:(x==null?void 0:x.rows)||(x==null?void 0:x.data)||[];h(d)}})()},[s]);const b=async()=>{var d,o,p,u,A;if(y(""),I(null),!s){y(t?"Branches API not available.":"Detecting endpoint…");return}const i=qe(f);if(i==null){y("Please select a branch to run the report.");return}const x=await T(`${s}/${i}/report`,{params:{from:$,to:j}});x.ok?I(((d=x.data)==null?void 0:d.kpis)||x.data||null):y(((u=(p=(o=x==null?void 0:x.error)==null?void 0:o.response)==null?void 0:p.data)==null?void 0:u.error)||((A=x==null?void 0:x.error)==null?void 0:A.message)||"Failed to load report.")};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:f,onChange:i=>w(i.target.value),disabled:!s,children:[e.jsx("option",{value:"",children:"Select"}),c.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id??i.code))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:$,onChange:i=>m(i.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:j,onChange:i=>S(i.target.value)})]}),e.jsx(Z,{onClick:b,disabled:!s,children:"Run"})]}),k&&e.jsx("div",{className:"text-sm text-red-600",children:k}),v&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(M,{title:"Staff",value:v.staffCount,tone:"indigo"}),e.jsx(M,{title:"Expenses",value:`TZS ${Number(v.expenses||0).toLocaleString()}`,tone:"amber"}),e.jsx(M,{title:"Loans Out",value:`TZS ${Number(v.loansOut||v.disbursed||0).toLocaleString()}`,tone:"emerald"}),e.jsx(M,{title:"Collections",value:`TZS ${Number(v.collections||v.collected||0).toLocaleString()}`,tone:"blue"})]})]})}function M({title:s,value:t,tone:a="indigo",onClick:c}){const h={indigo:"text-indigo-600 bg-indigo-50",amber:"text-amber-600 bg-amber-50",emerald:"text-emerald-600 bg-emerald-50",blue:"text-blue-600 bg-blue-50",rose:"text-rose-600 bg-rose-50"}[a]||"text-slate-600 bg-slate-50",f=typeof c=="function";return e.jsxs("button",{type:"button",onClick:c,disabled:!f,className:["bg-white border rounded-xl p-3 flex items-center gap-3 text-left w-full",f?"hover:shadow-sm hover:border-indigo-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400":"",f?"transition":"cursor-default"].join(" "),"aria-label":f?`Open ${s}`:void 0,children:[e.jsx("span",{className:`px-2 py-1 rounded ${h}`,children:s}),e.jsx("span",{className:"font-semibold",children:t??"—"})]})}function We(){l.useEffect(()=>{const{body:s}=document,t=s.style.overflow;return s.style.overflow="hidden",()=>{s.style.overflow=t||""}},[])}function oe({title:s,children:t,onClose:a}){return We(),e.jsx(me,{children:e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl border shadow p-4 w-full max-w-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold",children:s}),e.jsx("button",{onClick:a,className:"text-sm px-2 py-1 border rounded",children:"✕"})]}),t]})})})}function ae({title:s,children:t,onClose:a,wide:c=!1,full:h=!1}){return We(),e.jsx(me,{children:e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:a}),e.jsxs("div",{className:h?"absolute inset-0 w-full h-full bg-white p-4 overflow-auto":`absolute right-0 top-0 h-full w-full ${c?"max-w-5xl":"max-w-3xl"} bg-white border-l shadow-xl p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold",children:s}),e.jsx("button",{onClick:a,className:"text-sm px-2 py-1 border rounded",children:"✕"})]}),t]})]})})}export{Ns as default};

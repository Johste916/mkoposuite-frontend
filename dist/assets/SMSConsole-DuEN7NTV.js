import{r as l,j as s,g as J}from"./index-Bh87i4em.js";const _=new Intl.NumberFormat,z=d=>d?new Date(d).toLocaleString():"—";async function j(d){return J.getFirst(d)}async function v(d,m){return J.postFirst(d,m)}function be(){const[d,m]=l.useState(!1),[$,c]=l.useState(""),[i,M]=l.useState(null),[A,E]=l.useState([]),K=["Single","Borrowers","Segments/Groups","CSV Upload"],[b,W]=l.useState(0),[L,X]=l.useState(""),[q,D]=l.useState(""),[y,Y]=l.useState(""),[S,Z]=l.useState(""),[R,w]=l.useState([]),[g,U]=l.useState([]),[O,ee]=l.useState("Hello {{name}}, …"),[k,se]=l.useState(""),[C,te]=l.useState(""),[F,ae]=l.useState(!0),[I,ne]=l.useState(!1),[V,re]=l.useState("Dear {{name}}, …"),[N,oe]=l.useState(""),[P,H]=l.useState(null),[G,le]=l.useState("Hello {{name}}, …"),[T,ie]=l.useState("");async function Q(){c("");try{const e=await j(["/sms/balance","/billing/sms/balance","/notifications/sms/balance"]);M(e||null)}catch{M(null)}}async function f(){try{const e=await j(["/sms/messages","/notifications/sms/messages","/communications/sms"]),t=Array.isArray(e)?e:e.items||e.messages||[];E(t.slice(0,100))}catch{E([])}}l.useEffect(()=>{Q(),f()},[]),l.useEffect(()=>{const e=setTimeout(async()=>{const t=S.trim();if(!t){w([]);return}try{const o=await j([`/sms/recipients/borrowers?q=${encodeURIComponent(t)}&limit=20`,`/borrowers/search?q=${encodeURIComponent(t)}&limit=20`,`/borrowers?search=${encodeURIComponent(t)}&limit=20`])||{},u=(o.items||o.results||o.rows||[]).map(r=>({id:r.id??r.borrowerId??r._id??`${r.phone||r.msisdn}-${r.id||""}`,name:r.name||[r.firstName,r.lastName].filter(Boolean).join(" ")||r.fullName||"—",phone:r.phone||r.msisdn||r.mobile||r.phoneNumber||"",branchId:r.branchId??null}));w(u.filter(r=>r.phone))}catch{w([])}},300);return()=>clearTimeout(e)},[S]);const ce=l.useMemo(()=>{if(!i)return"—";if(i.error==="Unauthorized"||i.status===401)return"Sign in again";if(i.ok===!1)return i.error||"N/A";const e=i.creditsRounded??i.credits??(()=>{const n=i.raw||"",u=String(n).split(","),r=Number(u[1]);return Number.isFinite(r)?r:null})();if(e==null)return"Unknown";const t=i.estSegmentsLeft!=null?`  (~${_.format(Math.floor(i.estSegmentsLeft))} SMS)`:"",o=i.unit||"credits";return`${_.format(Number(e.toFixed?e.toFixed(2):e))} ${o}${t}`},[i]),de=(e,t={})=>String(e||"").replace(/\{\{(\w+)\}\}/g,(o,n)=>n in t?String(t[n]):"");async function me(){const e=L.trim(),t=q.trim();if(!e||!t)return c("Phone and message are required.");m(!0),c("");try{const n=await v(["/sms/send","/communications/sms/send","/notifications/sms"],{to:e,message:t,text:t,senderId:y||void 0,from:y||void 0});if(n&&n.ok===!1)throw new Error(n.error||"Send failed");D(""),await f()}catch(o){c((o==null?void 0:o.message)||"Failed to send SMS.")}finally{m(!1)}}async function ue(){if(!g.length)return c("Pick at least one borrower.");const e=O.trim();if(!e)return c("Message is required.");m(!0),c("");try{const t=g.map(n=>{const u=n.name||"",[r,...a]=u.split(" "),h=a.join(" "),p={name:u,firstName:r,lastName:h};return{to:n.phone,vars:p,from:k||void 0}}),o=await v(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:t,template:e,defaultFrom:k||void 0});if(!o||o.ok===!1)for(const n of t){const u={to:n.to,message:de(e,n.vars||{}),from:n.from,senderId:n.from};await v(["/sms/send","/communications/sms/send","/notifications/sms"],u)}U([]),await f()}catch(t){c((t==null?void 0:t.message)||"Bulk send failed.")}finally{m(!1)}}async function xe(){const e=V.trim();if(!e)return c("Template is required.");m(!0),c("");try{try{const a=await v(["/sms/to-segment"],{filter:{branchId:C||void 0,hasActiveLoan:!!F,overdueOnly:!!I},template:e,from:N||void 0});if(a&&a.ok){await f(),m(!1);return}}catch{}const t=new URLSearchParams({branchId:C||"",active:String(!!F),overdueOnly:String(!!I),limit:"500"}).toString(),o=await j([`/sms/recipients/borrowers?${t}`,`/borrowers/search?${t}`,`/borrowers?${t}`])||{},r=(o.items||o.results||o.rows||[]||[]).map(a=>({name:a.name||[a.firstName,a.lastName].filter(Boolean).join(" "),phone:a.phone||a.msisdn||a.mobile})).filter(a=>a.phone).map(a=>{const h=a.name||"",[p,...x]=h.split(" "),B=x.join(" ");return{to:a.phone,vars:{name:h,firstName:p,lastName:B},from:N||void 0}});if(!r.length)throw new Error("No recipients matched the selected filters.");await v(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:r,template:e,defaultFrom:N||void 0}),await f()}catch(t){c((t==null?void 0:t.message)||"Segment send failed.")}finally{m(!1)}}async function he(){if(!P)return c("Choose a CSV first.");m(!0),c("");try{const t=(await P.text()).split(/\r?\n/).filter(a=>a.trim().length);if(t.length===0)throw new Error("Empty CSV.");const o=t[0].split(",").map(a=>a.trim().replace(/^"|"$/g,"")),n=(a,h)=>{const p=o.findIndex(x=>x.toLowerCase()===h.toLowerCase());return p<0?"":(a[p]||"").replace(/^"|"$/g,"").trim()},r=t.slice(1).map(a=>a.split(",")).map(a=>{const h=n(a,"phone")||n(a,"msisdn")||n(a,"number"),p=n(a,"message"),x=n(a,"name"),B=n(a,"firstName")||(x?x.split(" ")[0]:""),ge=n(a,"lastName")||(x?x.split(" ").slice(1).join(" "):"");return{to:h,message:p||void 0,vars:{name:x,firstName:B,lastName:ge},from:T||void 0}}).filter(a=>a.to);if(!r.length)throw new Error("No valid rows (need a 'phone' column).");await v(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:r,template:G||void 0,defaultFrom:T||void 0}),H(null),await f()}catch(e){c((e==null?void 0:e.message)||"CSV upload failed.")}finally{m(!1)}}function pe(){return s.jsx("div",{className:"rounded-2xl border p-4 shadow-sm bg-white",children:s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-500",children:"Balance"}),s.jsx("div",{className:"text-2xl font-semibold",children:ce}),(i==null?void 0:i.checkedAt)&&s.jsxs("div",{className:"text-xs text-gray-400",children:["Checked ",z(i.checkedAt)]})]}),s.jsx("button",{onClick:Q,className:"px-3 py-2 rounded-xl border hover:bg-gray-50",children:"Refresh"})]})})}return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 p-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"SMS Console"}),s.jsx(pe,{}),s.jsxs("div",{className:"rounded-2xl border bg-white",children:[s.jsx("div",{className:"grid grid-cols-4 text-sm font-medium border-b",children:K.map((e,t)=>s.jsx("button",{className:`px-4 py-3 text-left ${t===b?"bg-gray-50 border-b-2 border-black":""}`,onClick:()=>W(t),children:e},e))}),b===0&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:"Phone number (e.g. 0784…, +255…)",value:L,onChange:e=>X(e.target.value)}),s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:"Sender ID (optional)",value:y,onChange:e=>Y(e.target.value)})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Message text",value:q,onChange:e=>D(e.target.value)}),s.jsx("button",{disabled:d,onClick:me,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:d?"Sending…":"Send"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Tip: GSM-7 texts are cheaper—avoid emojis to keep it single-segment."})]}),b===1&&s.jsxs("div",{className:"p-4 space-y-4",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Search borrowers by name or phone…",value:S,onChange:e=>Z(e.target.value)}),s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Sender ID (optional)",value:k,onChange:e=>se(e.target.value)})]}),R.length>0&&s.jsx("div",{className:"max-h-52 overflow-auto border rounded-xl",children:R.map(e=>{const t=g.some(o=>o.id===e.id);return s.jsxs("label",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:()=>U(o=>t?o.filter(n=>n.id!==e.id):[...o,e])}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.phone})]})]},e.id)})}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Hello {{name}}, your loan is due…",value:O,onChange:e=>ee(e.target.value)}),s.jsxs("div",{className:"text-xs text-gray-500",children:["Variables: ","{{name}}"," ","{{firstName}}"," ","{{lastName}}","."]}),s.jsxs("button",{disabled:d||g.length===0,onClick:ue,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:["Send to ",g.length," borrower",g.length===1?"":"s"]})]}),b===2&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-4 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Branch ID (optional)",value:C,onChange:e=>te(e.target.value)}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:F,onChange:e=>ae(e.target.checked)}),"Active loans"]}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:I,onChange:e=>ne(e.target.checked)}),"Overdue only"]}),s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Sender ID (optional)",value:N,onChange:e=>oe(e.target.value)})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Dear {{name}}, …",value:V,onChange:e=>re(e.target.value)}),s.jsx("button",{disabled:d,onClick:xe,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Send to segment"}),s.jsxs("div",{className:"text-xs text-gray-500",children:["If your server doesn’t expose ",s.jsx("code",{children:"/sms/to-segment"}),", this will fetch borrowers client-side then send in bulk."]})]}),b===3&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 items-center",children:[s.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var t;return H(((t=e.target.files)==null?void 0:t[0])||null)}}),s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Sender ID (optional)",value:T,onChange:e=>ie(e.target.value)})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-24",placeholder:"Optional template (uses CSV column names: e.g. Hello {{name}})",value:G,onChange:e=>le(e.target.value)}),s.jsxs("div",{className:"text-xs text-gray-500",children:["CSV columns: ",s.jsx("code",{children:"phone"}),", ",s.jsx("code",{children:"message"})," (optional),"," ",s.jsx("code",{children:"name"}),", ",s.jsx("code",{children:"firstName"}),", ",s.jsx("code",{children:"lastName"}),"…"]}),s.jsx("button",{disabled:d,onClick:he,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Upload & Send"})]})]}),$?s.jsx("div",{className:"rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm",children:$}):null,s.jsxs("div",{className:"rounded-2xl border bg-white p-4",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Recent Messages"}),A.length===0?s.jsx("div",{className:"text-gray-500 text-sm",children:"No messages yet."}):s.jsx("div",{className:"divide-y",children:A.map((e,t)=>s.jsxs("div",{className:"py-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("div",{className:"font-medium",children:e.to||e.phone||e.msisdn}),s.jsx("div",{className:`text-xs ${(e.status||"").includes("fail")?"text-rose-600":(e.status||"").includes("queued")?"text-emerald-600":"text-gray-500"}`,children:e.status||e.deliveryStatus||"—"})]}),s.jsx("div",{className:"text-gray-600",children:e.message||e.text||e.body||""}),s.jsx("div",{className:"text-xs text-gray-400",children:z(e.at||e.createdAt||e.sentAt||e.timestamp)})]},e.id||e.messageId||t))})]})]})}export{be as default};

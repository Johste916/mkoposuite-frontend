import{u as B,r as i,h as V,j as e}from"./index-DYDSVKWX.js";import{C as q}from"./index-Bcw_75fU.js";const r={wrap:"w-full px-4 md:px-6 lg:px-8 py-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-[var(--muted)]",controls:"card p-3 mb-4 flex flex-col gap-2 md:flex-row md:items-end md:justify-between",line:"flex flex-col sm:flex-row sm:items-center gap-2",input:"h-10 rounded-lg border-2 border-[var(--border-strong)] bg-[var(--card)] px-3 text-[var(--fg)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",btn:"inline-flex items-center justify-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--chip-soft)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",primary:"inline-flex items-center justify-center rounded-lg px-3 py-2 font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",card:"card overflow-hidden",tableWrap:"table-wrap table-frame relative overflow-x-auto",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide text-[var(--fg)]/90 font-semibold px-3 py-2 border border-[var(--border)] select-none",td:"px-3 py-2 border border-[var(--border)] text-sm text-[var(--fg)]",tdRight:"px-3 py-2 border border-[var(--border)] text-sm text-right tabular-nums text-[var(--fg)]",foot:"px-3 py-2 border-t-2 border-[var(--border-strong)] text-sm flex items-center justify-between"},m=(s,n="TZS")=>`‎${n} ${Number(s||0).toLocaleString()}`,P=s=>s?new Date(s).toISOString().slice(0,10):"—",j=s=>s.reference||s.ref||s.code||`LN-${s.id}`,k=s=>{var n,c;return((n=s.borrower)==null?void 0:n.name)||s.borrowerName||((c=s.Borrower)==null?void 0:c.name)||"—"},C=s=>{var n,c;return((n=s.product)==null?void 0:n.name)||((c=s.Product)==null?void 0:c.name)||s.productName||"—"},O=s=>{var n,c,o;return((n=s.officer)==null?void 0:n.name)||((c=s.loanOfficer)==null?void 0:c.name)||((o=s.Officer)==null?void 0:o.name)||s.officerName||"—"},T=s=>s.disbursementDate||s.disbursedAt||s.disbursed_on||s.updatedAt||s.createdAt,$=s=>s.disbursementMethod||s.method||"—",g=s=>Number(s.amount??s.principal??s.principalAmount??0);function N(s){var f,h,d,x,p,b;const n=g(s),c=s.feeType||((f=s.Product)==null?void 0:f.feeType)||((h=s.product)==null?void 0:h.feeType),o=Number(s.feeAmount??((d=s.Product)==null?void 0:d.feeAmount)??((x=s.product)==null?void 0:x.feeAmount)??0),v=Number(s.feePercent??((p=s.Product)==null?void 0:p.feePercent)??((b=s.product)==null?void 0:b.feePercent)??0);return c==="percent"?n*v/100:c==="amount"?o:0}const L=s=>Math.max(0,g(s)-N(s));function W(){var D;const s=B(),[n,c]=i.useState(""),[o,v]=i.useState(""),[f,h]=i.useState(""),[d,x]=i.useState([]),[p,b]=i.useState(!0),[y,A]=i.useState(null),[R,F]=i.useState(null);i.useEffect(()=>{u()},[]);async function u(){A(null),b(!0);try{const t=await V.getFirst(["/loans/reports/disbursements/list","/loans/disbursements","/loans?status=disbursed"],{params:{pageSize:500,from:o,to:f,q:n}}),a=(Array.isArray(t)?t:(t==null?void 0:t.items)||(t==null?void 0:t.data)||(t==null?void 0:t.rows)||[]).filter(E=>String(E.status||"").toLowerCase()==="disbursed");x(a)}catch(t){console.error(t),A((t==null?void 0:t.normalizedMessage)||"Failed to load disbursements."),x([])}finally{b(!1),F(new Date)}}const l=i.useMemo(()=>{if(!n)return d;const t=n.toLowerCase();return d.filter(a=>String(j(a)).toLowerCase().includes(t)||k(a).toLowerCase().includes(t)||C(a).toLowerCase().includes(t)||O(a).toLowerCase().includes(t))},[d,n]),w=i.useMemo(()=>({principal:l.reduce((t,a)=>t+g(a),0),fees:l.reduce((t,a)=>t+N(a),0),net:l.reduce((t,a)=>t+L(a),0)}),[l]),S=((D=d[0])==null?void 0:D.currency)||"TZS",M=[{label:"Ref",key:"ref"},{label:"Borrower",key:"borrower"},{label:"Product",key:"product"},{label:"Principal",key:"principal"},{label:"Fees",key:"fees"},{label:"Net Disbursed",key:"net"},{label:"Currency",key:"currency"},{label:"Officer",key:"officer"},{label:"Disbursed On",key:"date"},{label:"Method",key:"method"}],Z=l.map(t=>({ref:j(t),borrower:k(t),product:C(t),principal:g(t),fees:N(t),net:L(t),currency:t.currency||"TZS",officer:O(t),date:P(T(t)),method:$(t)}));return e.jsxs("div",{className:r.wrap,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("h1",{className:r.h1,children:"Disbursement Report"}),e.jsxs("p",{className:r.sub,children:["All loans marked ",e.jsx("strong",{children:"Disbursed"})," with fees and net amounts.",R&&e.jsxs(e.Fragment,{children:[" · ",e.jsxs("span",{children:["Last updated ",R.toLocaleString()]})]})]})]}),e.jsxs("div",{className:r.controls,children:[e.jsxs("div",{className:r.line,children:[e.jsx("input",{className:r.input,placeholder:"Search ref / borrower / product / officer…",value:n,onChange:t=>c(t.target.value),onKeyDown:t=>t.key==="Enter"&&u()}),e.jsx("input",{type:"date",className:r.input,value:o,onChange:t=>v(t.target.value)}),e.jsx("input",{type:"date",className:r.input,value:f,onChange:t=>h(t.target.value)}),e.jsx("button",{className:r.btn,onClick:u,children:"Apply Filters"}),e.jsx("button",{className:r.btn,onClick:()=>{c(""),v(""),h(""),u()},children:"Reset"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:r.btn,onClick:u,children:"Refresh"}),e.jsx(q,{data:Z,headers:M,filename:"disbursements.csv",className:r.primary,children:"Export CSV"})]})]}),e.jsxs("div",{className:r.card,children:[e.jsx("div",{className:r.tableWrap,children:e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:r.th,children:"Ref"}),e.jsx("th",{className:r.th,children:"Borrower"}),e.jsx("th",{className:r.th,children:"Product"}),e.jsx("th",{className:r.th,children:"Principal"}),e.jsx("th",{className:r.th,children:"Fees"}),e.jsx("th",{className:r.th,children:"Net Disbursed"}),e.jsx("th",{className:r.th,children:"Currency"}),e.jsx("th",{className:r.th,children:"Officer"}),e.jsx("th",{className:r.th,children:"Disbursed On"}),e.jsx("th",{className:r.th,children:"Method"}),e.jsx("th",{className:r.th,children:"Actions"})]})}),e.jsx("tbody",{children:p?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:`${r.td} text-center py-10 text-[var(--muted)]`,children:"Loading…"})}):y?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:`${r.td} text-center py-10`,children:e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("span",{className:"text-[var(--muted)]",children:y}),e.jsx("button",{className:r.btn,onClick:u,children:"Retry"})]})})}):l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:`${r.td} text-center py-10 text-[var(--muted)]`,children:"No disbursements match your filters."})}):l.map((t,a)=>e.jsxs("tr",{className:`transition-colors ${a%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)]`,children:[e.jsx("td",{className:r.td,children:j(t)}),e.jsx("td",{className:r.td,children:k(t)}),e.jsx("td",{className:r.td,children:C(t)}),e.jsx("td",{className:r.tdRight,children:m(g(t),t.currency||"TZS")}),e.jsx("td",{className:r.tdRight,children:m(N(t),t.currency||"TZS")}),e.jsx("td",{className:r.tdRight,children:m(L(t),t.currency||"TZS")}),e.jsx("td",{className:r.td,children:t.currency||"TZS"}),e.jsx("td",{className:r.td,children:O(t)}),e.jsx("td",{className:r.td,children:P(T(t))}),e.jsx("td",{className:r.td,children:$(t)}),e.jsx("td",{className:r.td,children:e.jsx("button",{className:r.btn,onClick:()=>s(`/loans/${t.id}`),title:"Open loan",children:"View"})})]},t.id||`${j(t)}-${a}`))})]})}),!p&&!y&&e.jsxs("div",{className:r.foot,children:[e.jsxs("span",{children:[l.length.toLocaleString()," disbursement(s)"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{children:["Principal ",m(w.principal,S)]}),e.jsxs("span",{children:["Fees ",m(w.fees,S)]}),e.jsx("span",{children:e.jsxs("strong",{children:["Net ",m(w.net,S)]})})]})]})]})]})}export{W as default};

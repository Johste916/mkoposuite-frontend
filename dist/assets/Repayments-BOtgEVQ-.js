import{u as le,r as l,j as e,g as b}from"./index-8DtxmKky.js";const o=n=>Number(n||0).toLocaleString(),re=({title:n,desc:d,control:v})=>e.jsxs("div",{className:"flex items-center justify-between border rounded-xl p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n}),d&&e.jsx("p",{className:"text-sm text-gray-500",children:d})]}),v]}),J=({status:n})=>{const d=n==="overdue"?"bg-red-600 text-white":n==="paid"||n==="closed"?"bg-green-100 text-green-800 border border-green-300":n==="partial"?"bg-yellow-50 text-yellow-800 border border-yellow-300":"bg-gray-100 text-gray-800 border";return e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs capitalize ${d}`,children:n||"—"})},ne=["pending","approved","rejected","disbursed","closed"];function de(){var V;const n=le(),[d,v]=l.useState(!1),[K,D]=l.useState(!1),[Q,G]=l.useState([]),[H,W]=l.useState([]),[S,E]=l.useState(""),[w,I]=l.useState(""),[u,P]=l.useState("active"),[p,$]=l.useState(""),[j,T]=l.useState("next_30_days"),[N,_]=l.useState(!1),[B,O]=l.useState([]),[f,g]=l.useState(1),[R,M]=l.useState(0),[y,X]=l.useState(10),[h,k]=l.useState(!1),[t,Y]=l.useState(null),[Z,z]=l.useState([]),[F,q]=l.useState([]),[C,U]=l.useState(!1),i=l.useRef(null),ee=15e3,A=l.useMemo(()=>Math.max(1,Math.ceil(Number(R||0)/Number(y||1))),[R,y]),se=async()=>{var s,a;D(!0);try{const[r,c]=await Promise.all([b.get("/branches"),b.get("/users",{params:{role:"loan_officer",pageSize:500}})]);G(Array.isArray(r.data)?r.data:((s=r.data)==null?void 0:s.items)||[]),W(Array.isArray(c.data)?c.data:((a=c.data)==null?void 0:a.items)||[])}catch{}finally{D(!1)}},m=async()=>{v(!0);try{const s={page:f,pageSize:y};S&&(s.branchId=S),w&&(s.officerId=w),p!=null&&p.trim()&&(s.q=p.trim()),j&&j!=="all"&&(s.dueRange=j),!N&&ne.includes(String(u))&&(s.status=u);const{data:a}=await b.get("/loans",{params:s});let r=Array.isArray(a)?a:(a==null?void 0:a.items)||[];if(!N){const c=String(u).toLowerCase();c==="active"?r=r.filter(x=>String(x.status||x.state||"").toLowerCase()==="disbursed"):c==="delinquent"?r=r.filter(x=>String(x.nextDueStatus||"").toLowerCase()==="overdue"||Number(x.dpd||0)>0||Number(x.arrears||0)>0):c==="closed"&&(r=r.filter(x=>String(x.status||"").toLowerCase()==="closed"))}O(r),M(Number((a==null?void 0:a.total)||r.length||0))}catch{O([]),M(0)}finally{v(!1)}},L=async s=>{if(s){U(!0);try{const[a,r]=await Promise.all([b.get(`/loans/${s}/schedule`),b.get(`/loans/${s}/repayments`)]);z(Array.isArray(a.data)?a.data:[]),q(Array.isArray(r.data)?r.data:[])}catch{z([]),q([])}finally{U(!1)}}},te=async s=>{Y(s),k(!0),await L(s.id),i.current&&clearInterval(i.current),i.current=setInterval(()=>{L(s.id)},ee)};l.useEffect(()=>(!h&&i.current&&(clearInterval(i.current),i.current=null),()=>{i.current&&(clearInterval(i.current),i.current=null)}),[h]),l.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&(m(),h&&(t!=null&&t.id)&&L(t.id))};return document.addEventListener("visibilitychange",s),window.addEventListener("focus",s),()=>{document.removeEventListener("visibilitychange",s),window.removeEventListener("focus",s)}},[h,t==null?void 0:t.id]),l.useEffect(()=>{const s=a=>{var c;const r=(c=a==null?void 0:a.detail)==null?void 0:c.loanId;m(),h&&(t!=null&&t.id)&&r&&Number(t.id)===Number(r)&&L(r)};return window.addEventListener("repayment:posted",s),()=>window.removeEventListener("repayment:posted",s)},[h,t==null?void 0:t.id]),l.useEffect(()=>{se()},[]),l.useEffect(()=>{m()},[f,y,S,w,u,j,N]);const ae=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),g(1),m()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Schedule"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Browse upcoming installments, see overdue items, and post manual repayments."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50 disabled:opacity-60",onClick:()=>m(),disabled:d||K,children:d?"Refreshing…":"Refresh"}),e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>n("/repayments/receipts"),title:"Open receipts list",children:"Receipts"}),e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>n("/repayments/charts"),title:"Open charts",children:"Charts"}),e.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n("/repayments/new"),children:"Manual Repayment"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Filters"}),e.jsxs("form",{onSubmit:ae,className:"grid md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"space-y-1 md:col-span-2",children:[e.jsx("label",{className:"text-sm",children:"Search (Borrower / Loan Ref)"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"e.g., Juma / L-000123",value:p,onChange:s=>$(s.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Branch"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:S,onChange:s=>E(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),Q.map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Loan Officer"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:w,onChange:s=>I(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),H.map(s=>e.jsx("option",{value:String(s.id),children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()||s.email},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Due Range"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:j,onChange:s=>T(s.target.value),children:[e.jsx("option",{value:"next_7_days",children:"Next 7 days"}),e.jsx("option",{value:"next_30_days",children:"Next 30 days"}),e.jsx("option",{value:"overdue",children:"Overdue only"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{className:`${N?"opacity-60 pointer-events-none":""} space-y-1`,children:[e.jsx("label",{className:"text-sm",children:"Status"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:u,onChange:s=>P(s.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"delinquent",children:"Delinquent"}),e.jsx("option",{value:"closed",children:"Closed"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(re,{title:"Include Closed",control:e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",checked:N,onChange:s=>_(s.target.checked)})})})}),e.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>{E(""),I(""),P("active"),T("next_30_days"),_(!1),$(""),g(1),m()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Search"})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loans"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Page size"}),e.jsx("select",{className:"border rounded px-2 py-1 text-sm",value:String(y),onChange:s=>{X(Number(s.target.value)),g(1)},children:[10,20,50].map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Loan Ref"}),e.jsx("th",{className:"text-left p-3",children:"Borrower"}),e.jsx("th",{className:"text-left p-3",children:"Outstanding"}),e.jsx("th",{className:"text-left p-3",children:"Next Due"}),e.jsx("th",{className:"text-left p-3",children:"Officer"}),e.jsx("th",{className:"text-left p-3",children:"Status"}),e.jsx("th",{className:"text-right p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[!d&&B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4 text-gray-500",children:"No loans found."})}),B.map(s=>{var a,r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.reference||`L-${s.id}`}),e.jsx("td",{className:"p-3",children:s.borrowerName||((a=s.Borrower)==null?void 0:a.name)}),e.jsxs("td",{className:"p-3",children:[s.currency||"TZS"," ",o(s.outstanding??s.balance??0)]}),e.jsx("td",{className:"p-3",children:s.nextDueDate?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.nextDueDate}),s.nextDueStatus&&e.jsx(J,{status:s.nextDueStatus})]}):"—"}),e.jsx("td",{className:"p-3",children:s.officerName||((r=s.officer)==null?void 0:r.name)||"—"}),e.jsx("td",{className:"p-3",children:s.state||s.status||"active"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>te(s),children:"View Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${s.id}`),children:"Add Repayment"})]})})]},s.id)}),d&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4",children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Page ",f," of ",A," • ",R," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:f<=1,onClick:()=>g(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:f>=A,onClick:()=>g(s=>Math.min(A,s+1)),children:"Next"})]})]})]}),h&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>k(!1)}),e.jsxs("div",{className:"absolute inset-y-0 right-0 w-full sm:max-w-3xl bg-white dark:bg-gray-900 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loan Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>k(!1),children:"Close"})]}),t?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-lg font-semibold",children:t.reference||`L-${t.id}`}),e.jsxs("p",{className:"text-sm text-gray-600",children:[t.borrowerName||((V=t.Borrower)==null?void 0:V.name)," •"," ",t.currency||"TZS"," ",o(t.principal||t.amount||0)]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${t.id}`),children:"Add Repayment"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>window.open(`/loans/${t.id}`,"_blank"),children:"Open Loan"})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Installments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"#"}),e.jsx("th",{className:"text-left p-3",children:"Due Date"}),e.jsx("th",{className:"text-left p-3",children:"Principal"}),e.jsx("th",{className:"text-left p-3",children:"Interest"}),e.jsx("th",{className:"text-left p-3",children:"Fees"}),e.jsx("th",{className:"text-left p-3",children:"Total"}),e.jsx("th",{className:"text-left p-3",children:"Paid"}),e.jsx("th",{className:"text-left p-3",children:"Penalty"}),e.jsx("th",{className:"text-left p-3",children:"Status"})]})}),e.jsxs("tbody",{children:[C&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4",children:"Loading…"})}),!C&&Z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500",children:"No schedule entries."})}),Z.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.period??a+1}),e.jsx("td",{className:"p-3",children:s.dueDate}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.principal)]}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.interest)]}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.fees)]}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.total)]}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.paid)]}),e.jsx("td",{className:"p-3",children:s.penalty?`${t.currency||"TZS"} ${o(s.penalty)}`:"—"}),e.jsx("td",{className:"p-3",children:e.jsx(J,{status:s.status||"upcoming"})})]},`${s.period}-${s.dueDate}`))]})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Repayments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Amount"}),e.jsx("th",{className:"text-left p-3",children:"Method"}),e.jsx("th",{className:"text-left p-3",children:"Reference"}),e.jsx("th",{className:"text-left p-3",children:"Posted By"})]})}),e.jsxs("tbody",{children:[C&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4",children:"Loading…"})}),!C&&F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-gray-500",children:"No repayments yet."})}),F.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.date}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(s.amount||0)]}),e.jsx("td",{className:"p-3",children:s.method||"—"}),e.jsx("td",{className:"p-3",children:s.ref||s.reference||"—"}),e.jsx("td",{className:"p-3",children:s.postedBy||"—"})]},s.id))]})]})})]})]}):e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"No loan selected."})]})]})]})}export{de as default};

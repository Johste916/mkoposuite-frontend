import{r as a,b as c,j as e,L as u}from"./index-Iq-s2r8X.js";const k=l=>{var n;return!!l&&(l.role==="admin"||l.role==="director"||((n=l.permissions)==null?void 0:n.includes("payroll:read_all")))};function $(){const[l,n]=a.useState(null),[i,m]=a.useState([]),[v,y]=a.useState(!0),[j,S]=a.useState(""),[g,w]=a.useState(""),[p,L]=a.useState(""),[E,I]=a.useState([]),[o,P]=a.useState(null),[b,N]=a.useState(""),d=a.useMemo(()=>k(l),[l]);a.useEffect(()=>{let s=!1;return(async()=>{try{const[{data:r},{data:t}]=await Promise.all([c.get("/auth/me"),c.get("/hr/employees",{params:{limit:500}})]);if(s)return;n(r),I((t==null?void 0:t.items)||[])}catch{}})(),()=>s=!0},[]);const f=async()=>{var s,r;y(!0),N("");try{const t={from:j||void 0,to:g||void 0};d||(t.scope="me"),d&&p&&(t.employeeId=p);const[{data:h},{data:T}]=await Promise.all([c.get("/hr/payroll/runs",{params:t}),c.get("/hr/payroll/stats",{params:t})]);m((h==null?void 0:h.items)||[]),P(T||null)}catch(t){N(((r=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:r.message)||(t==null?void 0:t.message)||"Failed to load payroll. If this is a fresh environment, run backend DB migrations.")}finally{y(!1)}};return a.useEffect(()=>{f()},[d]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"View Payroll"}),e.jsx("div",{className:"flex gap-2",children:d&&e.jsx(u,{to:"/payroll/add",className:"px-3 py-2 text-sm border rounded-lg bg-white hover:bg-gray-50",children:"Run Payroll"})})]}),e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:j,onChange:s=>S(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:g,onChange:s=>w(s.target.value)})]}),d&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Employee"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:p,onChange:s=>L(s.target.value),children:[e.jsx("option",{value:"",children:"All employees"}),E.map(s=>e.jsxs("option",{value:s.id,children:[s.firstName," ",s.lastName," ",s.staffNo?`(${s.staffNo})`:""]},s.id))]})]}),e.jsx("button",{onClick:f,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Apply"})]}),o&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(x,{title:"Employees",value:o.employees,tone:"indigo"}),e.jsx(x,{title:"On Leave",value:o.onLeave,tone:"amber"}),e.jsx(x,{title:"Active Contracts",value:o.activeContracts,tone:"emerald"}),e.jsx(x,{title:"This Period Net",value:`TZS ${Number(o.netThisPeriod||0).toLocaleString()}`,tone:"blue"})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Period"}),e.jsx("th",{className:"py-2 px-3",children:"Employee"}),e.jsx("th",{className:"py-2 px-3",children:"Gross"}),e.jsx("th",{className:"py-2 px-3",children:"Deductions"}),e.jsx("th",{className:"py-2 px-3",children:"Net"}),e.jsx("th",{className:"py-2 px-3",children:"Status"}),e.jsx("th",{className:"py-2 px-3",children:"Actions"})]})}),e.jsx("tbody",{children:v?e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-gray-500",colSpan:7,children:"Loading…"})}):b?e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-red-600",colSpan:7,children:b})}):i.length===0?e.jsx("tr",{children:e.jsx("td",{className:"p-3 text-gray-500",colSpan:7,children:"No payroll found."})}):i.map(s=>{var r;return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:s.periodLabel||`${s.periodFrom} → ${s.periodTo}`}),e.jsx("td",{className:"py-2 px-3",children:((r=s.employee)==null?void 0:r.name)||s.employeeName}),e.jsxs("td",{className:"py-2 px-3",children:["TZS ",Number(s.gross||0).toLocaleString()]}),e.jsxs("td",{className:"py-2 px-3",children:["TZS ",Number(s.deductions||0).toLocaleString()]}),e.jsxs("td",{className:"py-2 px-3 font-medium",children:["TZS ",Number(s.net||0).toLocaleString()]}),e.jsx("td",{className:"py-2 px-3",children:s.status||"finalized"}),e.jsx("td",{className:"py-2 px-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{className:"text-blue-600 underline text-xs",href:s.payslipUrl||"#",target:"_blank",rel:"noreferrer",children:"Payslip"}),d&&e.jsxs(e.Fragment,{children:[e.jsx(u,{className:"text-xs border rounded px-2 py-0.5",to:`/payroll/report?runId=${s.runId||s.batchId}`,children:"Run report"}),e.jsx(u,{className:"text-xs border rounded px-2 py-0.5",to:`/payroll/add?clone=${s.runId||s.batchId}`,children:"Clone"})]})]})})]},s.id)})})]})})]})}function x({title:l,value:n,tone:i="indigo"}){const m={indigo:"text-indigo-600 bg-indigo-50",amber:"text-amber-600 bg-amber-50",emerald:"text-emerald-600 bg-emerald-50",blue:"text-blue-600 bg-blue-50"}[i]||"text-slate-600 bg-slate-50";return e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex items-center gap-3",children:[e.jsx("div",{className:`px-2 py-1 rounded ${m}`,children:l}),e.jsx("div",{className:"font-semibold",children:n??"—"})]})}export{$ as default};

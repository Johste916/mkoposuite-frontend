import{r as o,j as n,g as L}from"./index-8DtxmKky.js";function c(e){const t=(e.startsWith("/")?e:`/${e}`).replace(/^\/api\//,"/"),r=t.startsWith("/api/")?t:`/api${t}`;return Array.from(new Set([t,r]))}async function D(e=[],i={}){let t;for(const r of e)try{const l=await L.get(r,i);return l==null?void 0:l.data}catch(l){t=l}throw t||new Error("No endpoint succeeded")}async function G(e=[],i={},t={}){let r;for(const l of e)try{const d=await L.post(l,i,t);return d==null?void 0:d.data}catch(d){r=d}throw r||new Error("No endpoint succeeded")}function B(e){return(Array.isArray(e)?e:(e==null?void 0:e.items)||(e==null?void 0:e.rows)||(e==null?void 0:e.data)||[]).map(t=>({id:t.id??t._id??t.branchId??t.code??String(t.name||"branch"),name:t.name??t.title??t.label??String(t.code||"—")}))}function M(e){return(Array.isArray(e)?e:(e==null?void 0:e.items)||(e==null?void 0:e.rows)||(e==null?void 0:e.data)||[]).map(t=>({id:t.id??t._id??t.userId??String(t.email||t.phone||"user"),name:t.name||[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||t.username||t.email||t.phone||"—",roles:(t.roles||t.Roles||[]).map(r=>(r.name||r.code||"").toString().toLowerCase()),title:(t.title||t.jobTitle||"").toString().toLowerCase()}))}function _(e){const i=[...e.roles||[],e.title||""].join(" ");return/loan.*officer|credit.*officer|field.*officer/i.test(i)}const T=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],s={container:"w-full px-4 md:px-6 lg:px-8 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight mb-4",card:"rounded-2xl border-2 border-slate-300 bg-white shadow p-4",label:"block text-xs uppercase tracking-wide text-slate-600 mb-1 font-semibold",input:"h-10 w-full rounded-lg border-2 border-slate-300 px-3 outline-none focus:ring-2 focus:ring-indigo-500/40",textarea:"w-full rounded-lg border-2 border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500/40",primary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold hover:bg-indigo-700 disabled:opacity-60"},$=()=>{const[e,i]=o.useState({name:"",branchId:"",meetingDay:"",officerId:"",notes:""}),[t,r]=o.useState([]),[l,d]=o.useState([]),[x,b]=o.useState(!0),[y,j]=o.useState(!0),[v,N]=o.useState(!1),[S,g]=o.useState(""),f=a=>i(m=>({...m,[a.target.name]:a.target.value}));o.useEffect(()=>{const a=new AbortController;return(async()=>{try{b(!0);const m=await D([...c("branches"),...c("org/branches")],{signal:a.signal});r(B(m))}catch{r([])}finally{b(!1)}})(),()=>a.abort()},[]),o.useEffect(()=>{const a=new AbortController;return(async()=>{try{j(!0);const m=await D([...c("users?role=loan_officer"),...c("admin/staff?role=loan_officer"),...c("users"),...c("admin/staff")],{signal:a.signal}),p=M(m),h=p.filter(_);d(h.length?h:p)}catch{d([])}finally{j(!1)}})(),()=>a.abort()},[]);const I=o.useMemo(()=>t.map(a=>({value:String(a.id),label:a.name||String(a.id)})),[t]),A=o.useMemo(()=>l.map(a=>({value:String(a.id),label:a.name||String(a.id)})),[l]),O=async a=>{var m,p,h,E;a.preventDefault(),N(!0),g("");try{const u={name:e.name.trim(),branchId:((m=e.branchId)==null?void 0:m.trim())||null,meetingDay:e.meetingDay?String(e.meetingDay).toLowerCase():null,officerId:((p=e.officerId)==null?void 0:p.trim())||null,notes:e.notes||null};await G([...c("borrowers/groups"),...c("groups"),...c("borrower-groups")],u),g("✅ Group created."),i({name:"",branchId:"",meetingDay:"",officerId:"",notes:""})}catch(u){const C=((E=(h=u==null?void 0:u.response)==null?void 0:h.data)==null?void 0:E.error)||(u==null?void 0:u.message)||"Failed to create group.";g(`❌ ${C}`)}finally{N(!1)}};return n.jsxs("div",{className:s.container,children:[n.jsx("h1",{className:s.h1,children:"Add Group"}),n.jsx("form",{onSubmit:O,className:s.card,children:n.jsxs("div",{className:"space-y-4",children:[n.jsxs("div",{children:[n.jsx("label",{className:s.label,children:"Name"}),n.jsx("input",{name:"name",value:e.name,onChange:f,required:!0,className:s.input,placeholder:"Group name"})]}),n.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[n.jsxs("div",{children:[n.jsx("label",{className:s.label,children:"Branch"}),n.jsxs("select",{name:"branchId",value:e.branchId,onChange:f,className:s.input,disabled:x||!I.length,children:[n.jsx("option",{value:"",children:x?"Loading…":"(Select branch)"}),I.map(a=>n.jsx("option",{value:a.value,children:a.label},a.value))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:s.label,children:"Loan Officer"}),n.jsxs("select",{name:"officerId",value:e.officerId,onChange:f,className:s.input,disabled:y||!A.length,children:[n.jsx("option",{value:"",children:y?"Loading…":"(None yet)"}),A.map(a=>n.jsx("option",{value:a.value,children:a.label},a.value))]})]}),n.jsxs("div",{children:[n.jsx("label",{className:s.label,children:"Meeting Day"}),n.jsxs("select",{name:"meetingDay",value:e.meetingDay,onChange:f,className:s.input,children:[n.jsx("option",{value:"",children:"(None)"}),T.map(a=>n.jsx("option",{value:a,children:a[0].toUpperCase()+a.slice(1)},a))]})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:s.label,children:"Notes"}),n.jsx("textarea",{name:"notes",value:e.notes,onChange:f,rows:3,className:s.textarea,placeholder:"Optional notes about this group"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("button",{type:"submit",disabled:v,className:s.primary,children:v?"Saving…":"Create Group"}),S&&n.jsx("div",{className:"text-sm",children:S})]})]})})]})};export{$ as default};

import{u as D,r as c,j as t,L as F,c as d}from"./index-Bf5_G04H.js";const p=s=>Array.isArray(s)?s:Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.items)?s.items:Array.isArray(s==null?void 0:s.data)?s.data:Array.isArray(s==null?void 0:s.results)?s.results:Array.isArray(s==null?void 0:s.borrowers)?s.borrowers:[];function E(){const s=D(),[v,N]=c.useState([]),[w,h]=c.useState([]),[A,x]=c.useState([]),[u,b]=c.useState([]),[M,j]=c.useState(!1),[y,S]=c.useState(""),[r,i]=c.useState({productId:"",amount:"",interestRate:"",termMonths:"",interestMethod:"flat",borrowerId:"",branchId:"",startDate:"",endDate:""}),m=async()=>{j(!0);try{const e=await d.get("/loans"),o=p(e.data);N(o.filter(n=>(n==null?void 0:n.status)==="pending"))}catch{alert("Failed to load applications")}finally{j(!1)}},I=async()=>{try{const e=await d.get("/borrowers");h(p(e.data))}catch{h([])}},C=async()=>{try{const e=await d.get("/branches");x(p(e.data))}catch{x([])}},R=async()=>{try{const e=await d.get("/loan-products");b(p(e.data))}catch{b([])}};c.useEffect(()=>{m(),I(),C(),R()},[]);const a=c.useMemo(()=>u.find(e=>String(e.id)===String(r.productId)),[u,r.productId]),B=()=>{if(!r.borrowerId)return alert("Select a borrower"),!1;const e=Number(r.amount||0),o=Number(r.termMonths||0);if(e<=0)return alert("Enter amount"),!1;if(o<=0)return alert("Enter term months"),!1;if(a){if(a.minPrincipal&&e<Number(a.minPrincipal))return alert(`Amount must be at least ${a.minPrincipal}`),!1;if(a.maxPrincipal&&e>Number(a.maxPrincipal))return alert(`Amount must not exceed ${a.maxPrincipal}`),!1;if(a.minTermMonths&&o<Number(a.minTermMonths))return alert(`Term must be at least ${a.minTermMonths} months`),!1;if(a.maxTermMonths&&o>Number(a.maxTermMonths))return alert(`Term must not exceed ${a.maxTermMonths} months`),!1}else if(!r.interestRate)return alert("Enter interest rate or select a product"),!1;return!0},T=async e=>{if(e.preventDefault(),!!B())try{await d.post("/loans",r),g(),m(),alert("Application submitted.")}catch{alert("Failed to submit application")}},L=async e=>{try{await d.patch(`/loans/${e}/approve`)}catch{try{await d.patch(`/loans/${e}/status`,{status:"approved"})}catch{return alert("Failed to approve")}}m()},$=async e=>{try{await d.patch(`/loans/${e}/reject`)}catch{try{await d.patch(`/loans/${e}/status`,{status:"rejected"})}catch{return alert("Failed to reject")}}m()},g=()=>{i({productId:"",amount:"",interestRate:"",termMonths:"",interestMethod:"flat",borrowerId:"",branchId:"",startDate:"",endDate:""})},f=(v??[]).filter(e=>{var o;return(((o=e==null?void 0:e.Borrower)==null?void 0:o.name)||"").toLowerCase().includes(y.toLowerCase())});return t.jsxs("div",{className:"p-4 space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl font-bold",children:"Loan Applications"}),t.jsx(F,{className:"text-blue-600 underline text-sm",to:"/loans",children:"Back to Loans"})]}),t.jsxs("form",{onSubmit:T,className:"grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded shadow",children:[t.jsxs("select",{value:r.productId,onChange:e=>{const o=e.target.value,n=u.find(l=>String(l.id)===String(o));i(l=>({...l,productId:o,interestMethod:l.interestMethod||(n==null?void 0:n.interestMethod)||"flat",interestRate:l.interestRate||(n==null?void 0:n.interestRate)||(n==null?void 0:n.defaultInterestRate)||""}))},className:"border px-4 py-2 rounded",children:[t.jsx("option",{value:"",children:"Select Product (optional)"}),(u??[]).map(e=>t.jsxs("option",{value:e.id,children:[e.name," ",e.code?`(${e.code})`:""]},e.id))]}),t.jsx("input",{type:"number",placeholder:"Amount",value:r.amount,min:(a==null?void 0:a.minPrincipal)??0,max:(a==null?void 0:a.maxPrincipal)??void 0,onChange:e=>i({...r,amount:e.target.value}),required:!0,className:"border px-4 py-2 rounded"}),t.jsx("input",{type:"number",placeholder:"Term (Months)",value:r.termMonths,min:(a==null?void 0:a.minTermMonths)??1,max:(a==null?void 0:a.maxTermMonths)??void 0,onChange:e=>i({...r,termMonths:e.target.value}),required:!0,className:"border px-4 py-2 rounded"}),!r.productId&&t.jsxs(t.Fragment,{children:[t.jsx("input",{type:"number",placeholder:"Interest Rate (%)",value:r.interestRate,onChange:e=>i({...r,interestRate:e.target.value}),required:!0,className:"border px-4 py-2 rounded"}),t.jsxs("select",{value:r.interestMethod,onChange:e=>i({...r,interestMethod:e.target.value}),className:"border px-4 py-2 rounded",children:[t.jsx("option",{value:"flat",children:"Flat"}),t.jsx("option",{value:"reducing",children:"Reducing Balance"})]})]}),t.jsxs("select",{value:r.borrowerId,onChange:e=>i({...r,borrowerId:e.target.value}),required:!0,className:"border px-4 py-2 rounded",children:[t.jsx("option",{value:"",children:"Select Borrower"}),(w??[]).map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:r.branchId,onChange:e=>i({...r,branchId:e.target.value}),className:"border px-4 py-2 rounded",children:[t.jsx("option",{value:"",children:"Select Branch"}),(A??[]).map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("input",{type:"date",value:r.startDate,onChange:e=>i({...r,startDate:e.target.value}),required:!0,className:"border px-4 py-2 rounded"}),t.jsx("input",{type:"date",value:r.endDate,onChange:e=>i({...r,endDate:e.target.value}),className:"border px-4 py-2 rounded"}),t.jsxs("div",{className:"col-span-full flex gap-2",children:[t.jsx("button",{type:"submit",className:"bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700",children:"Submit Application"}),t.jsx("button",{type:"button",onClick:g,className:"px-4 py-2 rounded border",children:"Reset"})]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"font-semibold",children:"Pending Applications"}),t.jsx("input",{value:y,onChange:e=>S(e.target.value),placeholder:"Search borrower...",className:"border px-3 py-2 rounded"})]}),t.jsx("div",{className:"overflow-x-auto",children:M?t.jsx("p",{children:"Loading applications..."}):f.length===0?t.jsx("p",{children:"No pending applications."}):t.jsxs("table",{className:"min-w-full bg-white rounded shadow border text-sm",children:[t.jsx("thead",{className:"bg-gray-100",children:t.jsxs("tr",{children:[t.jsx("th",{className:"border px-2 py-1",children:"Borrower"}),t.jsx("th",{className:"border px-2 py-1",children:"Amount"}),t.jsx("th",{className:"border px-2 py-1",children:"Rate"}),t.jsx("th",{className:"border px-2 py-1",children:"Term"}),t.jsx("th",{className:"border px-2 py-1",children:"Branch"}),t.jsx("th",{className:"border px-2 py-1",children:"Actions"})]})}),t.jsx("tbody",{children:f.map(e=>{var o,n;return t.jsxs("tr",{children:[t.jsx("td",{className:"border px-2",children:((o=e==null?void 0:e.Borrower)==null?void 0:o.name)||"N/A"}),t.jsx("td",{className:"border px-2",children:e==null?void 0:e.amount}),t.jsx("td",{className:"border px-2",children:e==null?void 0:e.interestRate}),t.jsx("td",{className:"border px-2",children:e==null?void 0:e.termMonths}),t.jsx("td",{className:"border px-2",children:((n=e==null?void 0:e.branch)==null?void 0:n.name)||"â€”"}),t.jsxs("td",{className:"border px-2 space-x-2",children:[t.jsx("button",{onClick:()=>s(`/loans/${e.id}`),className:"text-indigo-600 hover:underline",children:"View"}),t.jsx("button",{onClick:()=>L(e.id),className:"text-green-600 hover:underline",children:"Approve"}),t.jsx("button",{onClick:()=>$(e.id),className:"text-red-600 hover:underline",children:"Reject"})]})]},e.id)})})]})})]})}export{E as default};

import{u as V,f as J,r as p,j as e,b as P}from"./index-BZcNchgU.js";const o=c=>Number(c||0).toLocaleString();function U(c=[],i=0,x="oldest_due_first",b="penalties,interest,fees,principal",v=!1){const N=Number(i||0);if(!N||c.length===0)return{allocations:[],totals:{principal:0,interest:0,fees:0,penalties:0}};let m;x==="principal_first"?m=["principal","interest","fees","penalties"]:x==="interest_first"?m=["interest","fees","penalties","principal"]:x==="fees_first"?m=["fees","interest","penalties","principal"]:x==="custom"?m=b.split(",").map(n=>n.trim()).filter(Boolean):m=["penalties","interest","fees","principal"],v&&(m=m.filter(n=>n!=="penalties"));const D=c.map((n,u)=>{const g=Math.max(0,Number(n.principal??0)-Number(n.principalPaid??0)),h=Math.max(0,Number(n.interest??0)-Number(n.interestPaid??0)),s=Math.max(0,Number(n.fees??0)-Number(n.feesPaid??0)),j=Math.max(0,Number(n.penalties??n.penalty??0)-Number(n.penaltiesPaid??0));let d={principal:Number.isFinite(g)?g:0,interest:Number.isFinite(h)?h:0,fees:Number.isFinite(s)?s:0,penalties:v?0:Number.isFinite(j)?j:0};const y=Math.max(0,Number(n.total||0)-Number(n.paid||0)),C=Object.values(d).reduce((L,I)=>L+I,0);return y>0&&C===0&&(d.interest=Math.min(y,Number(n.interest||0)),d.principal=Math.max(0,y-d.interest)),{period:n.period??u+1,remaining:d}});let w=N;const a=[],S={principal:0,interest:0,fees:0,penalties:0};for(const n of D){if(w<=0)break;const u={period:n.period,principal:0,interest:0,fees:0,penalties:0};for(const g of m){if(w<=0)break;const h=Math.max(0,n.remaining[g]||0);if(!h)continue;const s=Math.min(h,w);u[g]+=s,S[g]+=s,w-=s}(u.principal||u.interest||u.fees||u.penalties)&&a.push(u)}return{allocations:a,totals:S}}const W=(c=[])=>{for(const i of c){const x=Number(i.principal||0)+Number(i.interest||0)+Number(i.fees||0)+Number(i.penalties??i.penalty??0),b=Number(i.total??x),v=Number(i.paid||0),N=Math.max(0,b-v);if(!(String(i.status||"").toLowerCase()==="paid")&&N>0)return{amount:N,dueDate:i.dueDate,period:i.period}}return null},G=c=>{if(!c)return"";if(typeof c=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(c))return c;const i=new Date(c);return isNaN(i.getTime())?"":new Date(i.getTime()-i.getTimezoneOffset()*6e4).toISOString().slice(0,10)};function K(){var A,F;const c=V(),[i]=J(),x=i.get("loanId"),[b,v]=p.useState(""),[N,m]=p.useState(!1),[D,w]=p.useState([]),[a,S]=p.useState(null),[n,u]=p.useState([]),[g,h]=p.useState(!1),[s,j]=p.useState({loanId:"",date:new Date().toISOString().slice(0,10),amount:"",method:"cash",reference:"",notes:"",allocateStrategy:"oldest_due_first",customOrder:"penalties,interest,fees,principal",waivePenalties:!1,issueReceipt:!0}),[d,y]=p.useState(null),[C,L]=p.useState(!1),[I,M]=p.useState(!1),T=p.useMemo(()=>s.loanId&&Number(s.amount)>0&&s.date,[s.loanId,s.amount,s.date]),k=t=>{const{name:r,value:l,type:f,checked:z}=t.target;j(Q=>({...Q,[r]:f==="checkbox"?z:f==="number"?Number(l):l}))},O=t=>r=>j(l=>({...l,[t]:r})),Z=async t=>{var r;if((r=t==null?void 0:t.preventDefault)==null||r.call(t),!!b.trim()){m(!0);try{const{data:l}=await P.get("/loans",{params:{q:b.trim(),page:1,pageSize:10}}),f=Array.isArray(l)?l:(l==null?void 0:l.items)||[];w(f)}catch{alert("Search failed")}finally{m(!1)}}},_=async t=>{S(t),j(r=>({...r,loanId:t.id,reference:t.reference||r.reference})),await R(t.id),y(null)},R=async t=>{h(!0);try{const{data:r}=await P.get(`/loans/${t}/schedule`);u(Array.isArray(r)?r:[])}catch{u([])}finally{h(!1)}},$=async t=>{if(t){h(!0);try{const{data:r}=await P.get(`/loans/${t}`);r?(S(r),j(l=>({...l,loanId:r.id,reference:r.reference||l.reference})),await R(r.id)):alert("Loan not found")}catch{alert("Failed to load loan")}finally{h(!1)}}};p.useEffect(()=>{x&&$(x)},[x]);const B=()=>{if(!(n!=null&&n.length)){alert("Load a loan first");return}const t=W(n);if(!t){alert("No unpaid installment found");return}const r=G(t.dueDate);j(l=>({...l,amount:Number(t.amount).toFixed(2),date:r||l.date}))},E=async()=>{if(T){L(!0);try{const t={loanId:s.loanId,amount:Number(s.amount),date:s.date,strategy:s.allocateStrategy,customOrder:s.allocateStrategy==="custom"?s.customOrder:void 0,waivePenalties:!!s.waivePenalties},{data:r}=await P.post("/repayments/preview-allocation",t);y(r||null)}catch{const t=U(n,Number(s.amount),s.allocateStrategy,s.customOrder,!!s.waivePenalties);y(t),alert("Server preview unavailable — used local preview.")}finally{L(!1)}}},q=async()=>{var t,r;if(!T)return alert("Fill amount, date, and select a loan");M(!0);try{const l={loanId:s.loanId,amount:Number(s.amount),date:s.date,method:s.method,reference:s.reference||void 0,notes:s.notes||void 0,strategy:s.allocateStrategy,customOrder:s.allocateStrategy==="custom"?s.customOrder:void 0,waivePenalties:!!s.waivePenalties,issueReceipt:!!s.issueReceipt},{data:f}=await P.post("/repayments/manual",l);f!=null&&f.repaymentId?(alert("Repayment posted"),c("/repayments/receipts")):(alert("Repayment posted"),c("/repayments"))}catch(l){const f=((r=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:r.error)||"Failed to post repayment";alert(f)}finally{M(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg border shadow",children:e.jsxs("div",{className:"p-6 flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Manual Repayment"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Search a loan, enter payment details, preview allocation, and post."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{className:"inline-flex items-center rounded-md px-3 py-2 text-sm border hover:bg-gray-50 dark:hover:bg-gray-700",onClick:()=>c("/repayments"),children:"Back to Schedule"})})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg border shadow",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Select Loan"}),e.jsxs("form",{onSubmit:Z,className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Search (Borrower / Loan Ref / Phone)"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900",value:b,onChange:t=>v(t.target.value),placeholder:"e.g., Juma / L-000123 / +2557…"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"submit",disabled:N,className:"inline-flex items-center rounded-md px-3 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:N?"Searching…":"Search"})})]}),D.length>0&&e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Loan Ref"}),e.jsx("th",{className:"p-3",children:"Borrower"}),e.jsx("th",{className:"p-3",children:"Outstanding"}),e.jsx("th",{className:"p-3",children:"Next Due"}),e.jsx("th",{className:"p-3 text-right",children:"Action"})]})}),e.jsx("tbody",{children:D.map(t=>{var r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:t.reference||`L-${t.id}`}),e.jsx("td",{className:"p-3",children:t.borrowerName||((r=t.Borrower)==null?void 0:r.name)}),e.jsxs("td",{className:"p-3",children:[t.currency||"TZS"," ",o(t.outstanding??t.balance??0)]}),e.jsx("td",{className:"p-3",children:t.nextDueDate||"—"}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("button",{className:"inline-flex items-center rounded-md px-3 py-1.5 text-sm border hover:bg-gray-50 dark:hover:bg-gray-700",onClick:()=>_(t),children:"Select"})})]},t.id)})})]})}),a&&e.jsxs("div",{className:"border rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.borrowerName||((A=a.Borrower)==null?void 0:A.name)}),e.jsx("p",{className:"text-sm text-gray-500",children:a.reference||`L-${a.id}`})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Outstanding"}),e.jsxs("p",{className:"font-semibold",children:[a.currency||"TZS"," ",o(a.outstanding??a.balance??0)]})]})]}),e.jsx("hr",{className:"my-3"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"#"}),e.jsx("th",{className:"p-3",children:"Due Date"}),e.jsx("th",{className:"p-3",children:"Total"}),e.jsx("th",{className:"p-3",children:"Paid"}),e.jsx("th",{className:"p-3",children:"Penalty"}),e.jsx("th",{className:"p-3",children:"Status"})]})}),e.jsxs("tbody",{children:[g&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-4",children:"Loading schedule…"})}),!g&&n.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-4 text-gray-500",children:"No schedule items."})}),n.map((t,r)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:t.period??r+1}),e.jsx("td",{className:"p-3",children:t.dueDate}),e.jsxs("td",{className:"p-3",children:[a.currency||"TZS"," ",o(t.total)]}),e.jsxs("td",{className:"p-3",children:[a.currency||"TZS"," ",o(t.paid)]}),e.jsx("td",{className:"p-3",children:t.penalty?`${a.currency||"TZS"} ${o(t.penalty)}`:"—"}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs ${t.status==="overdue"?"bg-red-600 text-white":"border"}`,children:(t.status||"upcoming").toString()})})]},`${t.period}-${t.dueDate}`))]})]})})]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg border shadow",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Payment Details"}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Date"}),e.jsx("input",{type:"date",name:"date",value:s.date,onChange:k,className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Amount"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",min:"0.01",step:"0.01",name:"amount",value:s.amount,onChange:k,className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900"}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-md px-3 py-2 text-sm border hover:bg-gray-50 dark:hover:bg-gray-700",onClick:B,children:"Use Next Due Amount"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Method"}),e.jsxs("select",{value:s.method,onChange:t=>O("method")(t.target.value),className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile_money",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"adjustment",children:"Adjustment"})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-3",children:[e.jsx("label",{className:"text-sm font-medium",children:"Reference (optional)"}),e.jsx("input",{name:"reference",value:s.reference,onChange:k,placeholder:"e.g., MPESA-123ABC / BankTxn#...",className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900"})]}),e.jsxs("div",{className:"space-y-2 md:col-span-3",children:[e.jsx("label",{className:"text-sm font-medium",children:"Notes (optional)"}),e.jsx("textarea",{rows:2,name:"notes",value:s.notes,onChange:k,className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900"})]})]}),e.jsx("hr",{}),e.jsx("h4",{className:"font-medium",children:"Allocation Strategy"}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Strategy"}),e.jsxs("select",{value:s.allocateStrategy,onChange:t=>O("allocateStrategy")(t.target.value),className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900",children:[e.jsx("option",{value:"oldest_due_first",children:"Oldest Due First"}),e.jsx("option",{value:"principal_first",children:"Principal First"}),e.jsx("option",{value:"interest_first",children:"Interest First"}),e.jsx("option",{value:"fees_first",children:"Fees First"}),e.jsx("option",{value:"custom",children:"Custom Order"})]})]}),e.jsxs("div",{className:`${s.allocateStrategy==="custom"?"":"opacity-60 pointer-events-none"} space-y-2 md:col-span-2`,children:[e.jsx("label",{className:"text-sm font-medium",children:"Custom Order"}),e.jsx("input",{name:"customOrder",value:s.customOrder,onChange:k,placeholder:"penalties,interest,fees,principal",className:"w-full border rounded px-3 py-2 text-sm dark:bg-gray-900"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Comma-separated among: penalties, interest, fees, principal."})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"Options"}),e.jsxs("div",{className:"flex gap-6 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:!!s.waivePenalties,onChange:t=>O("waivePenalties")(t.target.checked)}),"Waive penalties"]}),e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:!!s.issueReceipt,onChange:t=>O("issueReceipt")(t.target.checked)}),"Issue receipt"]})]})]})}),e.jsxs("div",{className:"md:col-span-3 flex justify-end gap-2",children:[e.jsx("button",{type:"button",disabled:!T||C,onClick:E,className:"inline-flex items-center rounded-md px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 disabled:opacity-60",children:C?"Previewing…":"Preview Allocation"}),e.jsx("button",{type:"button",disabled:!T||I,onClick:q,className:"inline-flex items-center rounded-md px-3 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:I?"Posting…":"Post Repayment"})]})]}),d&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Allocation Preview"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Period"}),e.jsx("th",{className:"p-3",children:"Principal"}),e.jsx("th",{className:"p-3",children:"Interest"}),e.jsx("th",{className:"p-3",children:"Fees"}),e.jsx("th",{className:"p-3",children:"Penalties"})]})}),e.jsx("tbody",{children:(F=d.allocations)!=null&&F.length?d.allocations.map(t=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:t.period}),e.jsxs("td",{className:"p-3",children:[(a==null?void 0:a.currency)||"TZS"," ",o(t.principal)]}),e.jsxs("td",{className:"p-3",children:[(a==null?void 0:a.currency)||"TZS"," ",o(t.interest)]}),e.jsxs("td",{className:"p-3",children:[(a==null?void 0:a.currency)||"TZS"," ",o(t.fees)]}),e.jsxs("td",{className:"p-3",children:[(a==null?void 0:a.currency)||"TZS"," ",o(t.penalties)]})]},t.period)):e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-gray-500",children:"No allocation details."})})}),d.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 font-medium",children:"Totals"}),e.jsxs("td",{className:"p-3 font-medium",children:[(a==null?void 0:a.currency)||"TZS"," ",o(d.totals.principal)]}),e.jsxs("td",{className:"p-3 font-medium",children:[(a==null?void 0:a.currency)||"TZS"," ",o(d.totals.interest)]}),e.jsxs("td",{className:"p-3 font-medium",children:[(a==null?void 0:a.currency)||"TZS"," ",o(d.totals.fees)]}),e.jsxs("td",{className:"p-3 font-medium",children:[(a==null?void 0:a.currency)||"TZS"," ",o(d.totals.penalties)]})]})})]})})]})]})})]})}export{K as default};

import{k as ls,u as os,r as c,j as e,L as se,h as o}from"./index-BdJ97RMf.js";import{c as us,f as j,b as te,d as ms,e as hs,n as xs,g as Be}from"./loanSchedule-DYJ3SA-o.js";const i={page:"w-full px-4 md:px-6 py-6 space-y-6 bg-[var(--bg)] text-[var(--fg)]",sub:"text-sm text-[var(--muted)]",card:"card rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",cardHead:"px-6 py-4 border-b-2 border-[var(--border)] bg-[var(--table-head-bg)] flex items-center justify-between rounded-t-2xl",cardBody:"px-6 py-6",cardBodyDense:"px-6 py-4",label:"text-[12px] uppercase tracking-wide text-[var(--muted)] font-semibold",actionLink:"inline-flex items-center gap-1 font-extrabold text-[var(--primary)] underline underline-offset-4 decoration-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",chip:"inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-[11px] font-extrabold uppercase ring-2 ring-[var(--border)] bg-[var(--badge-bg)] text-[var(--badge-fg)]",btn:"inline-flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-semibold border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--chip-soft)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",primary:"inline-flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-0 disabled:opacity-60",input:"w-full rounded-lg border-2 px-3 py-2 outline-none bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)] placeholder:text-[var(--input-placeholder)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",tableWrap:"overflow-x-auto rounded-xl border-2 border-[var(--border-strong)] bg-[var(--card)]",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide font-semibold px-3 py-2 border border-[var(--border)] text-[var(--fg)]/90",td:"px-3 py-2 border border-[var(--border)] text-sm text-[var(--fg)]"},W=({title:n,subtitle:l,right:s,children:$,dense:m=!1})=>e.jsxs("div",{className:i.card,children:[(n||l||s)&&e.jsxs("div",{className:i.cardHead,children:[e.jsxs("div",{className:"min-w-0",children:[n&&e.jsx("h3",{className:"text-xl md:text-2xl font-extrabold tracking-tight",children:n}),l&&e.jsx("div",{className:i.sub,children:l})]}),s]}),e.jsx("div",{className:m?i.cardBodyDense:i.cardBody,children:$})]}),b=({children:n})=>e.jsx("div",{className:i.label,children:n}),fs=()=>{try{return(JSON.parse(localStorage.getItem("user")||"{}").role||"").toLowerCase()}catch{return""}},R=n=>n==="admin"||n==="director"||n==="superadmin",ps=n=>["branch_manager","manager","bm"].includes(n)||R(n),gs=n=>["compliance","compliance_officer","legal"].includes(n)||R(n),bs=n=>["accountant","finance"].includes(n)||R(n),vs=n=>["loan_officer","officer"].includes(n)&&!R(n);function js(n){if(!n)return"";const l=String(n).toLowerCase();return l==="pending"?"submitted":l==="approved"?"accounting":""}function Ns(n=""){const l=String(n).toLowerCase();return["approved","disbursed","active"].includes(l)?"bg-emerald-600 text-white ring-0":["pending","submitted"].includes(l)?"bg-amber-500 text-white ring-0":["rejected"].includes(l)?"bg-rose-600 text-white ring-0":["closed"].includes(l)?"bg-slate-700 text-white ring-0":""}function ae(n){if(n===""||n==null)return;if(typeof n=="number")return n;const l=String(n).trim();return/^\d+$/.test(l)?Number(l):l}async function ys({id:n,payload:l}){const s={};l.officerId!==void 0&&(s.loanOfficerId=ae(l.officerId)),l.branchId!==void 0&&(s.branchId=ae(l.branchId)),l.borrowerId!==void 0&&(s.borrowerId=ae(l.borrowerId));for(const $ of Object.keys(s))s[$]===void 0&&delete s[$];Object.keys(s).length&&await o.patch(`/loans/${n}`,s)}function zs(){var ke,Ce,Oe,Re,$e,Le,Ae;const{id:n}=ls(),l=os(),[s,$]=c.useState(null),[m,ne]=c.useState(null),[C,re]=c.useState([]),[ws,z]=c.useState([]),[v,V]=c.useState(null),[u,H]=c.useState(null),[N,U]=c.useState(null),[G,ie]=c.useState([]),[J,ce]=c.useState([]),[Z,D]=c.useState(!1),[S,K]=c.useState({officerId:"",branchId:""}),[de,le]=c.useState(!1),[Ee,oe]=c.useState(!0),[Fe,ue]=c.useState(!0),[Ss,me]=c.useState(!0),[Is,he]=c.useState(!1),[xe,fe]=c.useState(null),[h,E]=c.useState(""),[L,pe]=c.useState(""),[x,A]=c.useState(!1),[ks,De]=c.useState(""),[Cs,Pe]=c.useState(!1),[Os,Rs]=c.useState(!1),[$s,Ls]=c.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[As,_e]=c.useState(!1),[Bs,Me]=c.useState(!1),[Es,Te]=c.useState({amount:"",interestRate:"",termMonths:"",startDate:""}),[Fs,Ds]=c.useState(!1),[Ps,qe]=c.useState(!1),[_s,We]=c.useState({termMonths:"",startDate:"",previewOnly:!1}),[Ms,Ts]=c.useState(!1),f=(s==null?void 0:s.currency)||"TZS",ze=i.chip,O=fs(),P=ps(O),ge=gs(O),Ve=bs(O),He=vs(O),Ue=R(O)||P||ge,Ge=R(O)||P,B=(s==null?void 0:s.workflowStage)||js(s==null?void 0:s.status),be=He&&["changes_requested","bm_changes_requested","compliance_changes_requested","returned_to_officer","request_changes"].includes(B),_=P&&["submitted","bm_review","changes_resubmitted"].includes(B),ve=ge&&["compliance","compliance_review"].includes(B),je=Ve&&((s==null?void 0:s.status)==="approved"||B==="accounting"),Ne=c.useRef(null),Je=async()=>{var t,r;try{const d=await o.get("/users",{params:{role:"loan_officer",pageSize:500}}),a=Array.isArray(d.data)?d.data:((t=d.data)==null?void 0:t.items)||[];ie(a)}catch{ie([])}try{const d=await o.get("/branches",{params:{pageSize:500}}),a=Array.isArray(d.data)?d.data:((r=d.data)==null?void 0:r.items)||[];ce(a)}catch{ce([])}},y=async()=>{var t,r,d;oe(!0),fe(null);try{const{data:a}=await o.get(`/loans/${n}`);$(a),pe(String((a==null?void 0:a.amount)??""));const k=(a==null?void 0:a.borrowerId)??((t=a==null?void 0:a.Borrower)==null?void 0:t.id)??((r=a==null?void 0:a.borrower)==null?void 0:r.id);if(k)try{const g=await o.get(`/borrowers/${k}`);H(g.data||null)}catch{H(null)}else H(null);const p=(a==null?void 0:a.officerId)??(a==null?void 0:a.loanOfficerId)??(a==null?void 0:a.assignedOfficerId)??(a==null?void 0:a.disbursedBy)??(a==null?void 0:a.disbursed_by)??((d=a==null?void 0:a.officer)==null?void 0:d.id);if(p)try{const g=await o.get(`/users/${p}`);U(g.data||null)}catch{U(null)}else U(null);const ee=[o.get(`/repayments/loan/${n}`).then(g=>re(g.data||[])).catch(()=>re([])).finally(()=>ue(!1)),o.get(`/comments/loan/${n}`).then(g=>z(Array.isArray(g.data)?g.data:[])).catch(()=>z([])).finally(()=>me(!1))];a!=null&&a.productId&&ee.push(o.get(`/loan-products/${a.productId}`).then(g=>ne(g.data)).catch(()=>ne(null))),he(!0),ee.push(o.get(`/loans/${n}/schedule`).then(g=>V(xs(g.data))).catch(()=>V(null)).finally(()=>he(!1))),await Promise.all(ee),K({officerId:p?String(p):"",branchId:a!=null&&a.branchId?String(a.branchId):""})}catch(a){console.error(a),fe("Failed to fetch loan.")}finally{oe(!1)}};c.useEffect(()=>{Ne.current!==n&&(Ne.current=n,V(null),E(""),De(""),ue(!0),me(!0),Je(),y())},[n]),c.useEffect(()=>{const t=()=>y();return window.addEventListener("focus",t),()=>window.removeEventListener("focus",t)},[]),c.useEffect(()=>{const t=r=>{var d;String((d=r==null?void 0:r.detail)==null?void 0:d.id)===String(n)&&y()};return window.addEventListener("loan:updated",t),()=>window.removeEventListener("loan:updated",t)},[n]);async function F(t){try{await o.post("/comments",{loanId:n,content:t});const r=await o.get(`/comments/loan/${n}`);z(Array.isArray(r.data)?r.data:[])}catch{}}async function M(t,r={}){A(!0);try{await o.post(`/loans/${n}/workflow`,{action:t,comment:(h==null?void 0:h.trim())||void 0,suggestedAmount:r.suggestedAmount!=null&&r.suggestedAmount!==""?Number(r.suggestedAmount):void 0}),await y(),E(""),alert("Action applied.")}catch{try{t==="bm_approve"||t==="compliance_approve"?(await o.patch(`/loans/${n}/status`,{status:"approved"}),h.trim()&&await F(h.trim())):t==="reject"?(await o.patch(`/loans/${n}/status`,{status:"rejected"}),h.trim()&&await F(h.trim())):t==="request_changes"?h.trim()&&await F(`Changes requested: ${h.trim()}`):t==="resubmit"&&(await o.patch(`/loans/${n}/status`,{status:"pending"}),h.trim()&&await F(`Resubmitted: ${h.trim()}`)),await y(),E(""),alert("Action applied (fallback).")}catch(a){console.error(a),alert("Failed to apply action.")}}finally{A(!1)}}async function Ze(){var t,r;A(!0);try{try{await o.post(`/loans/${n}/disburse`)}catch{try{await o.patch(`/loans/${n}/status`,{status:"disbursed"})}catch{await o.put(`/loans/${n}/status`,{status:"disbursed"})}}await y(),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:n}})),alert("Loan disbursed.")}catch(d){console.error(d),alert(((r=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:r.error)||"Failed to disburse loan.")}finally{A(!1)}}async function Ke(){if(!L||Number(L)<=0){alert("Enter a valid amount.");return}A(!0);try{await o.patch(`/loans/${n}`,{amount:Number(L)}),h.trim()&&await F(`Suggested amount: ${j(L,f)} â€” ${h.trim()}`),await y(),alert("Suggestion saved.")}catch(t){console.error(t),alert("Failed to save suggestion.")}finally{A(!1)}}const Qe=async()=>{const t=Number(T||0);if(!(t>0&&!window.confirm("Outstanding > 0. Close anyway?")))try{await o.patch(`/loans/${n}/status`,{status:"closed",override:t>0}),await y(),alert("Loan closed.")}catch(r){console.error(r),alert("Failed to close loan.")}},Xe=()=>{Te({amount:(s==null?void 0:s.amount)??"",interestRate:(s==null?void 0:s.interestRate)??"",termMonths:(s==null?void 0:s.termMonths)??(s==null?void 0:s.durationMonths)??"",startDate:Be((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate))}),Me(!0)},Ye=async()=>{var t,r;if(window.confirm("This will permanently delete this loan. Continue?"))try{await o.delete(`/loans/${n}`),alert("Loan deleted."),l("/loans")}catch(d){console.error(d),alert(((r=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:r.error)||"Failed to delete loan.")}},es=()=>{We({termMonths:(s==null?void 0:s.termMonths)??"",startDate:Be((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate)),previewOnly:!1}),qe(!0)},ss=async()=>{var d,a,k;const t=(s==null?void 0:s.officerId)??(s==null?void 0:s.loanOfficerId)??(s==null?void 0:s.assignedOfficerId)??(s==null?void 0:s.disbursedBy)??(s==null?void 0:s.disbursed_by)??((d=s==null?void 0:s.officer)==null?void 0:d.id)??"",r={};if(S.officerId!==""&&String(S.officerId)!==String(t)&&(r.officerId=S.officerId),S.branchId!==""&&String(S.branchId)!==String((s==null?void 0:s.branchId)??"")&&(r.branchId=S.branchId),!Object.keys(r).length){D(!1);return}le(!0);try{await ys({id:n,payload:r}),D(!1),await y(),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:n}})),alert("Assignment saved.")}catch(p){console.error(p),alert(((k=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:k.error)||(p==null?void 0:p.message)||"Failed to save assignment.")}finally{le(!1)}},ts=async()=>{var t,r,d;if(window.confirm("Reissue creates a new pending loan cloned from this one. Continue?"))try{const{data:a}=await o.post(`/loans/${n}/reissue`),k=((t=a==null?void 0:a.loan)==null?void 0:t.id)||(a==null?void 0:a.id);alert("New loan created."),k&&l(`/loans/${k}`)}catch(a){console.error(a),alert(((d=(r=a==null?void 0:a.response)==null?void 0:r.data)==null?void 0:d.error)||"Failed to reissue loan.")}},I=c.useMemo(()=>us(v||[],C||[]),[v,C]),Q=Array.isArray(v)&&v.length>0,T=(s==null?void 0:s.status)==="closed"?0:Q?I.outstanding:(s==null?void 0:s.outstanding)??null,X=Q?I.nextDue:null,q=c.useMemo(()=>{const t=C.length||0,r=C.reduce((d,a)=>d+Number(a.amount||0),0);return{count:t,sum:r}},[C]),as=(s==null?void 0:s.status)!=="closed"&&Number(T||0)>0,ns=c.useMemo(()=>{const t={};for(const r of G||[]){const d=r.name||r.email||r.phone||"";d&&(t[String(r.id)]={name:d,phone:r.phone||"",email:r.email||""})}return t},[G]),rs=c.useMemo(()=>{const t={};for(const r of J||[])t[String(r.id)]=r.name||r.code||`Branch ${r.id}`;return t},[J]),ye=(s==null?void 0:s.officerId)??(s==null?void 0:s.loanOfficerId)??(s==null?void 0:s.assignedOfficerId)??(s==null?void 0:s.disbursedBy)??(s==null?void 0:s.disbursed_by)??((ke=s==null?void 0:s.officer)==null?void 0:ke.id)??"",Y=((Ce=s==null?void 0:s.officer)==null?void 0:Ce.name)||(s==null?void 0:s.officerName)||(s==null?void 0:s.loanOfficerName)||(s==null?void 0:s.disbursedByName)||(s==null?void 0:s.disbursed_by_name)||"",w=ye?ns[String(ye)]:null,is=(N==null?void 0:N.name)||(Y&&!/^Officer\s*#\s*/i.test(Y)?Y:"")||(w==null?void 0:w.name)||"â€”",we=(N==null?void 0:N.phone)||(w==null?void 0:w.phone)||"",Se=(N==null?void 0:N.email)||(w==null?void 0:w.email)||"",Ie=(s==null?void 0:s.branchId)??((Oe=s==null?void 0:s.Branch)==null?void 0:Oe.id)??((Re=s==null?void 0:s.branch)==null?void 0:Re.id)??"",cs=(s==null?void 0:s.branchName)||(($e=s==null?void 0:s.Branch)==null?void 0:$e.name)||((Le=s==null?void 0:s.branch)==null?void 0:Le.name)||(Ie?rs[String(Ie)]:"")||"â€”",ds=(u==null?void 0:u.name)||((Ae=s==null?void 0:s.Borrower)==null?void 0:Ae.name)||(s==null?void 0:s.borrowerName)||"â€”";return Ee?e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:"Loading loanâ€¦"}):xe?e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:xe}):s?e.jsxs("div",{className:i.page,children:[e.jsxs("div",{className:"text-xs text-[var(--muted)] mb-1",children:["Loans ",e.jsx("span",{className:"opacity-60",children:"â€º"})," #",n]}),e.jsxs(W,{title:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-2xl md:text-3xl lg:text-4xl font-extrabold tracking-tight truncate",children:ds}),e.jsx("span",{className:`${ze} ${Ns(s.status)} text-[12px] md:text-[12px]`,"aria-label":`status ${s.status}`,children:s.status}),B?e.jsxs("span",{className:`${i.chip} text-[11px]`,"aria-label":"workflow stage",children:["Stage: ",B.replaceAll("_"," ")]}):null]}),subtitle:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[13px]",children:[e.jsxs("span",{className:"font-semibold",children:["Loan #",n]}),m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-50",children:"â€¢"}),e.jsxs("span",{className:"font-semibold",children:["Product: ",m.code||m.name]})]}):null,s.accountNumber?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"opacity-50",children:"â€¢"}),e.jsxs("span",{className:"font-semibold",children:["Acct: ",s.accountNumber]})]}):null]}),right:e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("button",{onClick:()=>l(-1),className:i.actionLink,"aria-label":"Go back",children:"â† Back"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Officer"}),Z?e.jsxs("select",{className:i.input,value:S.officerId,onChange:t=>K(r=>({...r,officerId:t.target.value})),"aria-label":"Select loan officer",children:[e.jsx("option",{value:"",children:"â€” Select Officer â€”"}),G.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email||`Officer #${t.id}`},t.id))]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-lg font-extrabold",children:is}),e.jsxs("div",{className:"text-sm space-y-0.5",children:[we?e.jsxs("div",{children:["ðŸ“ž ",we]}):null,Se?e.jsxs("div",{children:["âœ‰ï¸ ",Se]}):null]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Branch"}),Z?e.jsxs("select",{className:i.input,value:S.branchId,onChange:t=>K(r=>({...r,branchId:t.target.value})),"aria-label":"Select branch",children:[e.jsx("option",{value:"",children:"â€” Select Branch â€”"}),J.map(t=>e.jsx("option",{value:t.id,children:t.name||t.code||`Branch #${t.id}`},t.id))]}):e.jsx("div",{className:"text-lg font-extrabold",children:cs})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Borrower Contacts"}),e.jsxs("div",{className:"text-base space-y-1",children:[u!=null&&u.phone?e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{children:"ðŸ“ž"}),e.jsx("a",{className:"underline underline-offset-4 decoration-1",href:`tel:${u.phone}`,children:u.phone})]}):e.jsx("div",{className:"text-sm text-[var(--muted)]",children:"â€”"}),u!=null&&u.nationalId?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"ID:"}),e.jsx("span",{children:u.nationalId})]}):null,u!=null&&u.email?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"âœ‰ï¸"}),e.jsx("a",{className:"underline underline-offset-4 decoration-1 break-all",href:`mailto:${u.email}`,children:u.email})]}):null,s.borrowerId?e.jsx("div",{className:"pt-1",children:e.jsxs(se,{className:`${i.actionLink} text`,to:`/borrowers/${s.borrowerId}`,title:"BORROWER PROFILE",children:["BORROWER PROFILE ",e.jsx("span",{})]})}):null]})]})]}),(P||R(O))&&e.jsx("div",{className:"mt-6 flex flex-wrap gap-2",children:Z?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>D(!1),className:i.btn,children:"Cancel"}),e.jsx("button",{onClick:ss,disabled:de,className:i.primary,children:de?"Savingâ€¦":"Save Assignment"})]}):e.jsx("button",{onClick:()=>D(!0),className:i.btn,children:"Edit Assignment"})})]}),e.jsxs(W,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6",children:[e.jsxs("div",{children:[e.jsx(b,{children:"Amount"}),e.jsx("div",{className:"text-2xl font-extrabold",children:j(s.amount,f)})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Interest"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-bold",children:[s.interestRate,"%"]})," ",e.jsxs("span",{children:["Â· ",s.interestMethod||"â€”"]})]})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Term"}),e.jsxs("div",{className:"text-base font-semibold",children:[s.termMonths||s.durationMonths," months"]})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Start / Release"}),e.jsx("div",{className:"text-base font-semibold",children:te(s.startDate||s.releaseDate)})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Repayment Frequency"}),e.jsx("div",{className:"text-base font-semibold capitalize",children:s.repaymentFrequency||s.frequency||"â€”"})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Outstanding"}),e.jsx("div",{className:"text-2xl font-extrabold",children:T==null?"â€”":j(T,f)})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Next Due"}),e.jsx("div",{className:"text-base font-semibold",children:X?e.jsxs(e.Fragment,{children:[te(X.date)," Â·"," ",e.jsx("span",{className:"font-extrabold",children:j(X.amount,f)})]}):"â€”"})]}),m&&e.jsxs("div",{className:"md:col-span-2 lg:col-span-3 xl:col-span-4 min-w-0",children:[e.jsx(b,{children:"Product"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-extrabold",children:[m.name,m.code?` (${m.code})`:""]}),e.jsxs("div",{className:"text-sm mt-0.5",children:["Defaults: ",m.interestMethod," @ ",m.interestRate??m.defaultInterestRate,"% Â· Limits:"," ",j(m.minPrincipal,f)," â€“ ",j(m.maxPrincipal,f),", ",m.minTermMonths,"-",m.maxTermMonths," months"]})]})]})]}),e.jsx("div",{className:"mt-6 grid sm:grid-cols-3 lg:grid-cols-6 gap-4 text-sm",children:[["Paid Principal",I.paidPrincipal],["Paid Interest",I.paidInterest],["Paid Penalties",I.paidPenalty],["Paid Fees",I.paidFees],["Total Paid",I.totalPaid],["Total Scheduled",I.scheduledTotal]].map(([t,r])=>e.jsxs("div",{className:"rounded-xl border-2 border-[var(--border-strong)] p-3 bg-[var(--card)] shadow-sm",children:[e.jsx("div",{className:i.label,children:t}),e.jsx("div",{className:"font-bold text-lg",children:Q?j(r,f):"â€”"})]},t))})]}),(be||_||ve||je)&&e.jsxs(W,{dense:!0,children:[be&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-extrabold",children:"Changes Requested"}),e.jsxs("p",{className:"text-sm",children:["Update the application and attach missing documents, then ",e.jsx("strong",{children:"Resubmit"}),". Add a short note if helpful."]}),e.jsx("label",{className:"block text-xs font-semibold",children:"Comment (optional)"}),e.jsx("textarea",{value:h,onChange:t=>E(t.target.value),className:`${i.input} min-h-[44px]`,placeholder:"What did you fix / add?"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>M("resubmit"),disabled:x,className:i.primary,title:"Send for review again",children:x?"Submittingâ€¦":"Resubmit for Review"}),e.jsx(se,{to:"/loans/applications",className:i.btn,title:"Open applications to edit details/attachments",children:"Edit Application"})]})]}),(_||ve)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-extrabold",children:_?"Branch Manager Review":"Compliance Review"})}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold",children:"Suggested Principal"}),e.jsx("input",{type:"number",className:i.input,value:L,onChange:t=>pe(t.target.value),min:"0",step:"0.01"}),e.jsx("p",{className:"text-[11px] text-[var(--muted)] mt-1",children:"Save a suggestion or approve with a different amount."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold",children:"Comment"}),e.jsx("textarea",{className:`${i.input} min-h-[44px]`,placeholder:"Why approving / changes / rejection?",value:h,onChange:t=>E(t.target.value)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>M(_?"bm_approve":"compliance_approve",{suggestedAmount:L}),disabled:x,className:i.primary,children:x?"Workingâ€¦":"Approve"}),e.jsx("button",{onClick:()=>M("request_changes"),disabled:x,className:i.btn,title:"Send back to Loan Officer with requested changes",children:x?"Workingâ€¦":"Request Changes"}),e.jsx("button",{onClick:()=>M("reject"),disabled:x,className:i.btn,children:x?"Workingâ€¦":"Reject"}),e.jsx("button",{onClick:Ke,disabled:x,className:i.btn,children:x?"Savingâ€¦":"Save Suggestion"})]})]}),je&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm",children:"This loan is approved. Proceed to disbursement to finalize payout."}),e.jsx("button",{onClick:Ze,className:i.primary,disabled:x,children:x?"Workingâ€¦":"Disburse"})]})]}),e.jsx("div",{className:"ms-sticky-actions",children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(se,{to:"/loans",className:i.btn,children:"Back to Loans"}),e.jsx("button",{onClick:()=>_e(!0),className:i.btn,children:"View Schedule"}),e.jsx("button",{onClick:()=>ms({loan:s,schedule:v||[],currency:f}),className:i.btn,disabled:!Array.isArray(v)||!v.length,children:"Export CSV"}),e.jsx("button",{onClick:()=>hs({loan:s,schedule:v||[],currency:f}),className:i.btn,disabled:!Array.isArray(v)||!v.length,children:"Export PDF"}),as&&e.jsx("button",{onClick:()=>Pe(!0),className:i.btn,children:"Post Repayment"}),Ue&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Xe,className:i.btn,children:"Edit Loan"}),e.jsx("button",{onClick:es,className:i.btn,children:"Reschedule"})]}),e.jsx("button",{onClick:ts,className:i.btn,children:"Reissue"}),Ge&&e.jsx("button",{onClick:Ye,className:"px-3 md:px-4 py-2 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 shadow-sm","aria-label":"Delete loan",children:"Delete"}),s.status!=="closed"&&e.jsx("button",{onClick:Qe,className:i.btn,children:"Close Loan"})]})}),e.jsx(W,{title:"Repayments",right:e.jsxs("div",{className:"text-sm font-semibold",children:[q.count," record",q.count===1?"":"s"," Â· Total"," ",e.jsx("span",{className:"font-extrabold",children:j(q.sum,f)})]}),children:Fe?e.jsx("p",{children:"Loading repaymentsâ€¦"}):C.length===0?e.jsx("div",{className:"text-sm",children:"No repayments found."}):e.jsx("div",{className:i.tableWrap,children:e.jsxs("table",{className:"min-w-full table-fixed",children:[e.jsx("thead",{children:e.jsx("tr",{className:"text-left sticky top-0 z-10",children:["#","Date","Amount","Method","Notes"].map(t=>e.jsx("th",{className:i.th,children:t},t))})}),e.jsx("tbody",{children:C.map((t,r)=>e.jsxs("tr",{className:`${r%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)] transition-colors`,children:[e.jsx("td",{className:i.td,children:r+1}),e.jsx("td",{className:i.td,children:te(t.paymentDate||t.date||t.createdAt)}),e.jsx("td",{className:`${i.td} text-right tabular-nums`,children:j(t.amount,f)}),e.jsx("td",{className:i.td,children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-bold bg-[var(--badge-bg)] text-[var(--badge-fg)] ring-1 ring-[var(--border)]",children:t.method||"â€”"})}),e.jsx("td",{className:`${i.td} break-words`,children:t.notes||"â€”"})]},t.id||r))}),e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{className:`${i.td} font-bold`,colSpan:2,children:"Total"}),e.jsx("td",{className:`${i.td} text-right text-base font-extrabold`,children:j(q.sum,f)}),e.jsx("td",{className:i.td,colSpan:2})]})})]})})})]}):e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:"Loan not found."})}export{zs as default};

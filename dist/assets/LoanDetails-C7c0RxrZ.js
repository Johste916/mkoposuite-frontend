import{d as je,u as ye,r as l,j as e,L as R,b as i}from"./index-BuFaVkfx.js";const d=(s,x="TZS")=>`‎${x} ${Number(s||0).toLocaleString()}`,B=s=>s?new Date(s).toLocaleDateString():"N/A",fe=s=>s?new Date(s).toLocaleString():"",ve={pending:"bg-yellow-100 text-yellow-800",approved:"bg-blue-100 text-blue-800",rejected:"bg-gray-200 text-gray-700",disbursed:"bg-indigo-100 text-indigo-800",active:"bg-emerald-100 text-emerald-800",closed:"bg-slate-200 text-slate-700"},H="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold",Ne=()=>{try{return(JSON.parse(localStorage.getItem("user")||"{}").role||"").toLowerCase()}catch{return""}},A=s=>s==="admin"||s==="director"||s==="superadmin",we=s=>["branch_manager","manager","bm"].includes(s)||A(s),Se=s=>["compliance","compliance_officer","legal"].includes(s)||A(s),Ce=s=>["accountant","finance"].includes(s)||A(s),ke=s=>["loan_officer","officer"].includes(s)&&!A(s);function Le(s){if(!s)return"";const x=String(s).toLowerCase();return x==="pending"?"submitted":x==="approved"?"accounting":""}function Ae(){var G;const{id:s}=je(),x=ye(),[a,K]=l.useState(null),[o,I]=l.useState(null),[F,T]=l.useState([]),[q,v]=l.useState([]),[N,$]=l.useState(null),[Q,E]=l.useState(!0),[X,ee]=l.useState(!0),[te,se]=l.useState(!0),[ae,W]=l.useState(!1),[z,Z]=l.useState(null),[r,j]=l.useState(""),[u,J]=l.useState(""),[m,w]=l.useState(!1),[_,D]=l.useState(""),[ne,S]=l.useState(!1),[U,V]=l.useState(!1),[h,y]=l.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[le,M]=l.useState(!1),c=(a==null?void 0:a.currency)||"TZS",re=ve[a==null?void 0:a.status]||"bg-slate-100 text-slate-800",C=Ne(),ie=we(C),oe=Se(C),ce=Ce(C),de=ke(C),p=(a==null?void 0:a.workflowStage)||Le(a==null?void 0:a.status),me=de&&["changes_requested","bm_changes_requested","compliance_changes_requested","returned_to_officer","request_changes"].includes(p),k=ie&&["submitted","bm_review","changes_resubmitted"].includes(p),P=oe&&["compliance","compliance_review"].includes(p),O=ce&&((a==null?void 0:a.status)==="approved"||p==="accounting"),g=async()=>{E(!0),Z(null);try{const{data:t}=await i.get(`/loans/${s}`);K(t),J(String((t==null?void 0:t.amount)??""));const n=[i.get(`/repayments/loan/${s}`).then(b=>T(b.data||[])).catch(()=>T([])).finally(()=>ee(!1)),i.get(`/comments/loan/${s}`).then(b=>v(b.data||[])).catch(()=>v([])).finally(()=>se(!1))];t!=null&&t.productId&&n.push(i.get(`/loan-products/${t.productId}`).then(b=>I(b.data)).catch(()=>I(null))),await Promise.all(n)}catch(t){console.error(t),Z("Failed to fetch loan.")}finally{E(!1)}};l.useEffect(()=>{$(null),j(""),D(""),g()},[s]);async function f(t){try{await i.post("/comments",{loanId:s,content:t});const n=await i.get(`/comments/loan/${s}`);v(n.data||[])}catch{}}async function L(t,n={}){w(!0);try{await i.post(`/loans/${s}/workflow`,{action:t,comment:(r==null?void 0:r.trim())||void 0,suggestedAmount:n.suggestedAmount!=null&&n.suggestedAmount!==""?Number(n.suggestedAmount):void 0}),await g(),j(""),alert("Action applied.")}catch{try{t==="bm_approve"||t==="compliance_approve"?(await i.patch(`/loans/${s}/status`,{status:"approved"}),r.trim()&&await f(r.trim())):t==="reject"?(await i.patch(`/loans/${s}/status`,{status:"rejected"}),r.trim()&&await f(r.trim())):t==="request_changes"?r.trim()&&await f(`Changes requested: ${r.trim()}`):t==="resubmit"&&(await i.patch(`/loans/${s}/status`,{status:"pending"}),r.trim()&&await f(`Resubmitted: ${r.trim()}`)),await g(),j(""),alert("Action applied (fallback).")}catch(be){console.error(be),alert("Failed to apply action.")}}finally{w(!1)}}async function xe(){if(!u||Number(u)<=0){alert("Enter a valid amount.");return}w(!0);try{await i.patch(`/loans/${s}`,{amount:Number(u)}),r.trim()&&await f(`Suggested amount: ${d(u,c)} — ${r.trim()}`),await g(),alert("Suggestion saved.")}catch(t){console.error(t),alert("Failed to save suggestion.")}finally{w(!1)}}const ue=async()=>{const t=(a==null?void 0:a.outstanding)??0;if(!(t>0&&!window.confirm("Outstanding > 0. Close anyway?")))try{await i.patch(`/loans/${s}/status`,{status:"closed",override:t>0}),await g(),alert("Loan closed.")}catch(n){console.error(n),alert("Failed to close loan.")}},he=async()=>{if(_.trim())try{const t=await i.post("/comments",{loanId:s,content:_});v(n=>[t.data,...n]),D("")}catch(t){console.error(t),alert("Failed to add comment.")}},pe=async()=>{if(M(!0),!N){W(!0);try{const t=await i.get(`/loans/${s}/schedule`);$(t.data||[])}catch(t){console.error(t),$(null)}finally{W(!1)}}},ge=async()=>{const t=Number(h.amount);if(!t||t<=0)return alert("Enter a valid amount.");V(!0);try{await i.post("/repayments",{loanId:s,...h,amount:t}),await g(),S(!1),y({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),alert("Repayment posted.")}catch(n){console.error(n),alert("Failed to post repayment.")}finally{V(!1)}};if(Q)return e.jsx("div",{className:"p-4",children:"Loading loan…"});if(z)return e.jsx("div",{className:"p-4 text-red-600",children:z});if(!a)return e.jsx("div",{className:"p-4",children:"Loan not found."});const Y=(a==null?void 0:a.outstanding)??null;return e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Loan Details"}),e.jsx("span",{className:`${H} ${re}`,children:a.status}),p&&e.jsxs("span",{className:`${H} bg-indigo-50 text-indigo-700 border border-indigo-200`,children:["Stage: ",p.replaceAll("_"," ")]})]}),e.jsx("button",{onClick:()=>x(-1),className:"text-blue-600 hover:underline",children:"← Back"})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap gap-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Borrower"}),e.jsx(R,{className:"text-blue-600 hover:underline",to:`/borrowers/${a.borrowerId}`,children:((G=a.Borrower)==null?void 0:G.name)||a.borrowerName||"N/A"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Amount"}),e.jsx("div",{className:"font-semibold",children:d(a.amount,c)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Interest"}),e.jsxs("div",{children:[a.interestRate,"% · ",a.interestMethod]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Term"}),e.jsxs("div",{children:[a.termMonths||a.durationMonths," months"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Start / Release"}),e.jsx("div",{children:B(a.startDate||a.releaseDate)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Outstanding"}),e.jsx("div",{className:"font-semibold",children:Y==null?"—":d(Y,c)})]})]}),o&&e.jsxs("div",{className:"mt-4 text-sm text-gray-700",children:[e.jsxs("div",{className:"font-semibold",children:["Product: ",o.name,o.code?` (${o.code})`:""]}),e.jsxs("div",{children:["Defaults: ",o.interestMethod," @"," ",o.interestRate??o.defaultInterestRate,"% · Limits:"," ",d(o.minPrincipal,c)," –"," ",d(o.maxPrincipal,c),","," ",o.minTermMonths,"-",o.maxTermMonths," months"]})]})]}),me&&e.jsxs("div",{className:"bg-white p-4 rounded shadow border space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Changes Requested"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Your Branch Manager / Compliance requested changes. Update the application and attach missing documents, then"," ",e.jsx("strong",{children:"Resubmit"}),". Add a short note if helpful."]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment (optional)"}),e.jsx("textarea",{value:r,onChange:t=>j(t.target.value),className:"border rounded px-3 py-2 w-full min-h-[44px]",placeholder:"What did you fix / add?"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>L("resubmit"),disabled:m,className:"bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 disabled:opacity-60",title:"Send for review again",children:m?"Submitting…":"Resubmit for Review"}),e.jsx(R,{to:"/loans/applications",className:"px-3 py-2 rounded border hover:bg-gray-50",title:"Open applications to edit details/attachments",children:"Edit Application"})]})]}),(k||P||O)&&e.jsxs("div",{className:"bg-white p-4 rounded shadow space-y-3 border",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:k?"Branch Manager Review":P?"Compliance Review":"Accounting / Disbursement"}),O&&e.jsx(R,{to:`/loans/${s}/disburse`,className:"inline-flex items-center gap-2 px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700",children:"Disburse"})]}),(k||P)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Suggested Principal Amount"}),e.jsx("input",{type:"number",className:"border rounded px-3 py-2 w-full",value:u,onChange:t=>J(t.target.value),min:"0",step:"0.01"}),e.jsx("p",{className:"text-[11px] text-gray-500 mt-0.5",children:"Save a suggestion or approve with a different amount."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment"}),e.jsx("textarea",{className:"border rounded px-3 py-2 w-full min-h-[44px]",placeholder:"Why approving / changes / rejection?",value:r,onChange:t=>j(t.target.value)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>L(k?"bm_approve":"compliance_approve",{suggestedAmount:u}),disabled:m,className:"bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700 disabled:opacity-60",children:m?"Working…":"Approve"}),e.jsx("button",{onClick:()=>L("request_changes"),disabled:m,className:"bg-amber-600 text-white px-3 py-2 rounded hover:bg-amber-700 disabled:opacity-60",title:"Send back to Loan Officer with requested changes",children:m?"Working…":"Request Changes"}),e.jsx("button",{onClick:()=>L("reject"),disabled:m,className:"bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800 disabled:opacity-60",children:m?"Working…":"Reject"}),e.jsx("button",{onClick:xe,disabled:m,className:"px-3 py-2 rounded border hover:bg-gray-50 disabled:opacity-60",children:m?"Saving…":"Save Suggestion"})]})]}),O&&e.jsx("p",{className:"text-sm text-gray-600",children:"This loan is approved. Proceed to disbursement to finalize payout."})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(R,{to:"/loans",className:"px-3 py-2 rounded border",children:"Back to Loans"}),e.jsx("button",{onClick:pe,className:"px-3 py-2 rounded border hover:bg-gray-50",children:"View Schedule"}),e.jsx("button",{onClick:()=>S(!0),className:"px-3 py-2 rounded border hover:bg-gray-50",children:"Post Repayment"}),a.status!=="closed"&&e.jsx("button",{onClick:ue,className:"bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700",children:"Close Loan"})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Repayments"}),X?e.jsx("p",{children:"Loading repayments…"}):F.length===0?e.jsx("p",{children:"No repayments found."}):e.jsxs("table",{className:"min-w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"Date"}),e.jsx("th",{className:"border px-2 py-1",children:"Amount"}),e.jsx("th",{className:"border px-2 py-1",children:"Method"}),e.jsx("th",{className:"border px-2 py-1",children:"Notes"})]})}),e.jsx("tbody",{children:F.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:B(t.date)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.amount,c)}),e.jsx("td",{className:"border px-2 py-1",children:t.method||"—"}),e.jsx("td",{className:"border px-2 py-1",children:t.notes||"—"})]},t.id||n))})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded shadow",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Comments"}),te?e.jsx("p",{children:"Loading comments…"}):q.length===0?e.jsx("p",{children:"No comments yet."}):e.jsx("div",{className:"space-y-2 mb-3 max-h-64 overflow-auto pr-1",children:q.map((t,n)=>e.jsxs("div",{className:"text-sm border-b pb-1",children:[e.jsx("p",{children:t.content}),e.jsx("span",{className:"text-gray-400 text-xs",children:fe(t.createdAt)})]},t.id||n))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:_,onChange:t=>D(t.target.value),className:"border rounded px-2 py-1 w-full",placeholder:"Add a comment"}),e.jsx("button",{onClick:he,className:"bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700",children:"Post"})]})]}),ne&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Post Repayment"}),e.jsx("button",{onClick:()=>S(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:h.amount,onChange:t=>y(n=>({...n,amount:t.target.value})),className:"border rounded px-2 py-1 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Date"}),e.jsx("input",{type:"date",value:h.date,onChange:t=>y(n=>({...n,date:t.target.value})),className:"border rounded px-2 py-1 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Method"}),e.jsxs("select",{value:h.method,onChange:t=>y(n=>({...n,method:t.target.value})),className:"border rounded px-2 py-1 w-full",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:h.notes,onChange:t=>y(n=>({...n,notes:t.target.value})),className:"border rounded px-2 py-1 w-full",placeholder:"Receipt no., reference, etc."})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>S(!1),className:"px-3 py-2 rounded border",children:"Cancel"}),e.jsx("button",{onClick:ge,disabled:U,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-60",children:U?"Posting…":"Post"})]})]})}),le&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Repayment Schedule"}),e.jsx("button",{onClick:()=>M(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),ae?e.jsx("p",{children:"Loading schedule…"}):!N||N.length===0?e.jsx("p",{children:"No schedule available."}):e.jsx("div",{className:"max-h-[60vh] overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"#"}),e.jsx("th",{className:"border px-2 py-1",children:"Due Date"}),e.jsx("th",{className:"border px-2 py-1",children:"Principal"}),e.jsx("th",{className:"border px-2 py-1",children:"Interest"}),e.jsx("th",{className:"border px-2 py-1",children:"Penalty"}),e.jsx("th",{className:"border px-2 py-1",children:"Total"}),e.jsx("th",{className:"border px-2 py-1",children:"Balance"})]})}),e.jsx("tbody",{children:N.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:n+1}),e.jsx("td",{className:"border px-2 py-1",children:B(t.dueDate)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.principal,c)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.interest,c)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.penalty||0,c)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.total,c)}),e.jsx("td",{className:"border px-2 py-1",children:d(t.balance,c)})]},t.id||n))})]})}),e.jsx("div",{className:"mt-3 flex justify-end",children:e.jsx("button",{onClick:()=>M(!1),className:"px-3 py-2 rounded border",children:"Close"})})]})})]})}export{Ae as default};

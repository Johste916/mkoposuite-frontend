import{r as y,j as s}from"./index-iSlS6Tx9.js";import{a as p}from"./index-CGRxQRNG.js";const u="/admin/report-subscriptions";function C(e){const t=e==null?void 0:e.data;if(Array.isArray(t))return{rows:t,meta:{total:t.length,page:1,limit:t.length}};const a=(t==null?void 0:t.data)??[],l=(t==null?void 0:t.meta)??{total:a.length,page:1,limit:a.length};return{rows:a,meta:l}}const b=e=>encodeURIComponent(String(e)),j={listDefs:()=>p.get(`${u}/defs`).then(e=>{const t=e==null?void 0:e.data;return Array.isArray(t)?t:(t==null?void 0:t.data)??[]}),listSubs:(e={})=>p.get(`${u}`,{params:e}).then(t=>{const a=C(t);return Array.isArray(t==null?void 0:t.data)?(a.rows.meta=a.meta,a.rows):t.data}),createSub:e=>p.post(`${u}`,e).then(t=>t.data),deleteSub:e=>p.delete(`${u}/${b(e)}`).then(t=>t.data??{ok:!0}),runNow:e=>p.post(`${u}/${b(e)}/run`).then(t=>t.data),listSubscriptions:(e={})=>p.get(`${u}`,{params:e}).then(t=>C(t)),getSubscription:e=>p.get(`${u}/${b(e)}`).then(t=>t.data),createSubscription:e=>p.post(`${u}`,e).then(t=>t.data),updateSubscription:(e,t)=>p.put(`${u}/${b(e)}`,t).then(a=>a.data),deleteSubscription:e=>p.delete(`${u}/${b(e)}`).then(t=>t.data??{ok:!0}),listTemplates:()=>p.get(`${u}/defs`).then(e=>{const t=e==null?void 0:e.data;return Array.isArray(t)?t:(t==null?void 0:t.data)??[]}),testSend:e=>p.post(`${u}/${b(e)}/test`).then(t=>t.data)};async function c({method:e="get",paths:t=[],body:a,params:l}){var g;let m;for(const x of t)try{return(e==="get"||e==="delete"?await p[e](x,{params:l}):await p[e](x,a,{params:l})).data}catch(h){if(m=h,((g=h==null?void 0:h.response)==null?void 0:g.status)===401)throw h}throw m||new Error("All paths failed")}function A(e){if(Array.isArray(e)){const l=e;return l.meta={page:1,limit:l.length,total:l.length},l}const t=(e==null?void 0:e.data)??[],a=(e==null?void 0:e.meta)??{page:1,limit:t.length,total:t.length};return t.meta=a,t}const k={listRoles:()=>c({paths:["/roles"]}),createRole:e=>c({method:"post",paths:["/roles"],body:e}),updateRole:(e,t)=>c({method:"put",paths:[`/roles/${encodeURIComponent(e)}`],body:t}),deleteRole:e=>c({method:"delete",paths:[`/roles/${encodeURIComponent(e)}`]}),listUsers:(e={})=>c({paths:["/admin/staff","/staff","/users"],params:e}).then(A),getUser:e=>c({paths:[`/admin/staff/${encodeURIComponent(e)}`,`/staff/${encodeURIComponent(e)}`,`/users/${encodeURIComponent(e)}`]}),createUser:e=>{const t=e.roleIds??(e.roleId?[e.roleId]:[]),a=e.branchId??(Array.isArray(e.branchIds)?e.branchIds[0]:void 0),l={...e,roleIds:t,branchId:a};return delete l.roleId,delete l.branchIds,c({method:"post",paths:["/admin/staff","/staff","/users"],body:l})},updateUser:(e,t)=>{const a=t.roleIds??(t.roleId?[t.roleId]:void 0),l=t.branchId??(Array.isArray(t.branchIds)?t.branchIds[0]:void 0),m={...t,...a?{roleIds:a}:{},...l!==void 0?{branchId:l}:{}};return delete m.roleId,delete m.branchIds,c({method:"put",paths:[`/admin/staff/${encodeURIComponent(e)}`,`/staff/${encodeURIComponent(e)}`,`/users/${encodeURIComponent(e)}`],body:m})},resetUserPassword:(e,t)=>c({method:"patch",paths:[`/admin/staff/${encodeURIComponent(e)}/password`,`/staff/${encodeURIComponent(e)}/password`,`/users/${encodeURIComponent(e)}/password`],body:{password:t}}),toggleUserStatus:(e,t)=>c({method:"patch",paths:[`/admin/staff/${encodeURIComponent(e)}/status`,`/staff/${encodeURIComponent(e)}/status`,`/users/${encodeURIComponent(e)}/status`],body:{isActive:t}}),assignUserBranches:(e,t=[])=>c({method:"put",paths:[`/admin/staff/${encodeURIComponent(e)}/branches`,`/staff/${encodeURIComponent(e)}/branches`,`/users/${encodeURIComponent(e)}/branches`],body:{branchIds:t}}),listPermissions:()=>c({paths:["/permissions","/admin/permissions"]}),updatePermission:(e,t,a="")=>c({method:"put",paths:[`/permissions/${encodeURIComponent(e)}`,`/admin/permissions/${encodeURIComponent(e)}`],body:{roles:t,description:a}}),listAudit:e=>c({paths:["/admin/audit","/audit-logs"],params:e}),listBranches:()=>c({paths:["/branches","/org/branches"]}),can:(e,t,a)=>{if(!e)return!1;const l=String(e.role||"").toLowerCase();if(l==="admin"||l==="director")return!0;if(!Array.isArray(a))return!1;const m=a.find(x=>x.action===t);return m?(Array.isArray(m.roles)?m.roles.map(x=>String(x).toLowerCase()):[]).includes(l):!1}};function q(){const[e,t]=y.useState([]),[a,l]=y.useState([]),[m,g]=y.useState([]),[x,h]=y.useState(""),[N,v]=y.useState(!1),I={name:"",reportKey:"",frequency:"daily",timeOfDay:"09:00",dayOfWeek:1,dayOfMonth:1,monthOfYear:1,cron:"",format:"csv",filters:{},recipientsType:"role",roleId:"",userId:"",emails:[],active:!0},[o,i]=y.useState(I),S=async()=>{var n,r;try{h("");const[d,f,U]=await Promise.all([j.listDefs(),j.listSubs(),k.listRoles()]);t(d||[]),l(f||[]),g(U||[])}catch(d){h(((r=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:r.error)||"Failed to load")}};y.useEffect(()=>{S()},[]);const $=async()=>{var n,r;try{v(!0),h("");const d={...o,roleId:o.recipientsType==="role"&&Number(o.roleId)||null,userId:o.recipientsType==="user"&&Number(o.userId)||null},f=await j.createSub(d);l([f,...a]),i(I)}catch(d){h(((r=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:r.error)||"Failed to create subscription")}finally{v(!1)}},w=async n=>{confirm("Delete this subscription?")&&(await j.deleteSub(n),l(a.filter(r=>r.id!==n)))},R=async n=>{var r,d;try{await j.runNow(n),alert("Sent!")}catch(f){alert(((d=(r=f==null?void 0:f.response)==null?void 0:r.data)==null?void 0:d.error)||"Failed to send")}};return s.jsxs("div",{className:"space-y-4",children:[s.jsxs("header",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4",children:[s.jsx("h1",{className:"text-xl font-semibold",children:"Staff Email Notifications"}),s.jsx("p",{className:"text-sm text-slate-500",children:"Schedule reports to be emailed to staff by role or recipients."})]}),x&&s.jsx("div",{className:"text-sm text-rose-600",children:x}),s.jsxs("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 grid grid-cols-1 md:grid-cols-6 gap-2",children:[s.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"Name",value:o.name,onChange:n=>i(r=>({...r,name:n.target.value}))}),s.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:o.reportKey,onChange:n=>i(r=>({...r,reportKey:n.target.value})),children:[s.jsx("option",{value:"",children:"Select report…"}),e.map(n=>s.jsx("option",{value:n.key,children:n.name},n.key))]}),s.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:o.format,onChange:n=>i(r=>({...r,format:n.target.value})),children:[s.jsx("option",{value:"csv",children:"CSV"}),s.jsx("option",{value:"xlsx",disabled:!0,children:"Excel (soon)"}),s.jsx("option",{value:"pdf",disabled:!0,children:"PDF (soon)"})]}),s.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[s.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:o.frequency,onChange:n=>i(r=>({...r,frequency:n.target.value})),children:[s.jsx("option",{children:"daily"}),s.jsx("option",{children:"weekly"}),s.jsx("option",{children:"monthly"}),s.jsx("option",{children:"quarterly"}),s.jsx("option",{children:"semiannual"}),s.jsx("option",{children:"annual"}),s.jsx("option",{children:"custom"})]}),s.jsx("input",{className:"rounded border px-3 py-2 text-sm",placeholder:"HH:mm",value:o.timeOfDay,onChange:n=>i(r=>({...r,timeOfDay:n.target.value}))}),o.frequency==="weekly"&&s.jsx("select",{className:"rounded border px-3 py-2 text-sm",value:o.dayOfWeek,onChange:n=>i(r=>({...r,dayOfWeek:Number(n.target.value)})),children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((n,r)=>s.jsx("option",{value:r,children:n},r))}),["monthly","quarterly","semiannual","annual"].includes(o.frequency)&&s.jsx("input",{type:"number",min:"1",max:"28",className:"rounded border px-3 py-2 text-sm",value:o.dayOfMonth,onChange:n=>i(r=>({...r,dayOfMonth:Number(n.target.value)})),placeholder:"Day of month"}),o.frequency==="annual"&&s.jsx("input",{type:"number",min:"1",max:"12",className:"rounded border px-3 py-2 text-sm",value:o.monthOfYear,onChange:n=>i(r=>({...r,monthOfYear:Number(n.target.value)})),placeholder:"Month (1..12)"}),o.frequency==="custom"&&s.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"CRON expression",value:o.cron,onChange:n=>i(r=>({...r,cron:n.target.value}))})]}),s.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[s.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:o.recipientsType,onChange:n=>i(r=>({...r,recipientsType:n.target.value})),children:[s.jsx("option",{value:"role",children:"By role"}),s.jsx("option",{value:"user",children:"Specific user (ID)"}),s.jsx("option",{value:"emails",children:"Custom emails"})]}),o.recipientsType==="role"&&s.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:o.roleId,onChange:n=>i(r=>({...r,roleId:n.target.value})),children:[s.jsx("option",{value:"",children:"Select role…"}),m.map(n=>s.jsx("option",{value:n.id,children:n.name},n.id))]}),o.recipientsType==="user"&&s.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"User ID",value:o.userId,onChange:n=>i(r=>({...r,userId:n.target.value}))}),o.recipientsType==="emails"&&s.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-3",placeholder:"email1@example.com, email2@example.com",value:o.emails.join(", "),onChange:n=>i(r=>({...r,emails:n.target.value.split(",").map(d=>d.trim()).filter(Boolean)}))}),s.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:!!o.active,onChange:n=>i(r=>({...r,active:n.target.checked}))}),"Active"]}),s.jsx("div",{className:"md:col-span-2 flex justify-end",children:s.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white",disabled:N,onClick:$,children:N?"Saving…":"Create subscription"})})]})]}),s.jsx("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 overflow-auto",children:a.length===0?s.jsx("div",{className:"text-sm text-slate-500",children:"No subscriptions yet."}):s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"text-left text-slate-500",children:s.jsxs("tr",{children:[s.jsx("th",{className:"py-2 pr-4",children:"Name"}),s.jsx("th",{className:"py-2 pr-4",children:"Report"}),s.jsx("th",{className:"py-2 pr-4",children:"When"}),s.jsx("th",{className:"py-2 pr-4",children:"Recipients"}),s.jsx("th",{className:"py-2 pr-4",children:"Last / Next"}),s.jsx("th",{className:"py-2 pr-4",children:"Ops"})]})}),s.jsx("tbody",{children:a.map(n=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"py-2 pr-4",children:n.name}),s.jsx("td",{className:"py-2 pr-4",children:s.jsx("code",{className:"text-xs",children:n.reportKey})}),s.jsxs("td",{className:"py-2 pr-4",children:[n.frequency," @ ",n.timeOfDay]}),s.jsx("td",{className:"py-2 pr-4",children:n.recipientsType==="role"?`role #${n.roleId}`:n.recipientsType==="user"?`user #${n.userId}`:(n.emails||[]).join(", ")}),s.jsx("td",{className:"py-2 pr-4",children:s.jsxs("div",{className:"text-xs",children:[s.jsxs("div",{children:["Last: ",n.lastRunAt?new Date(n.lastRunAt).toLocaleString():"—"]}),s.jsxs("div",{children:["Next: ",n.nextRunAt?new Date(n.nextRunAt).toLocaleString():"—"]})]})}),s.jsx("td",{className:"py-2 pr-4",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"px-2 py-1 rounded border",onClick:()=>R(n.id),children:"Send now"}),s.jsx("button",{className:"px-2 py-1 rounded border text-rose-700",onClick:()=>w(n.id),children:"Delete"})]})})]},n.id))})]})})]})}export{q as default};

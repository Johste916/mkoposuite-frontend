import{r as c,j as e}from"./index-B6fIVZFR.js";import{r as v}from"./repayments-BCQdLO5l.js";import"./index-C31NoF4Q.js";const y={posted:"repayment:posted",approved:"repayment:approved",rejected:"repayment:rejected",bulk:"repayment:bulk-posted"},w=(d,r)=>{try{window.dispatchEvent(new CustomEvent(d,{detail:r}))}catch{}},R=()=>new Date().toISOString().slice(0,10),h=()=>({loanId:"",loanReference:"",amount:"",date:R(),method:"cash",reference:"",notes:""});function E(){const[d,r]=c.useState([h()]),[u,x]=c.useState(!1),[j,i]=c.useState(null),[b,m]=c.useState(""),l=(s,n,a)=>r(t=>t.map((o,p)=>p===s?{...o,[n]:a}:o)),N=()=>r(s=>[...s,h()]),g=s=>r(n=>n.filter((a,t)=>t!==s)),f=async()=>{var n,a;const s=d.map(t=>({loanId:t.loanId?Number(t.loanId):void 0,loanReference:t.loanReference||void 0,amount:Number(t.amount||0),date:t.date,method:t.method||"cash",reference:t.reference||void 0,notes:t.notes||void 0})).filter(t=>(t.loanId||t.loanReference)&&t.amount>0&&t.date);if(!s.length)return alert("Fill at least one valid row (loanId or loanReference, amount, date).");x(!0),m(""),i(null);try{const{data:t}=await v.createBulk(s);i(t||{ok:!0});const o=Array.isArray(t==null?void 0:t.items)?t.items.map(p=>p.loanId).filter(Boolean):[];w(y.bulk,{loanIds:o})}catch(t){m(((a=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:a.error)||"Bulk posting failed")}finally{x(!1)}};return e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Add Bulk Repayments"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["Each row must include ",e.jsx("code",{children:"loanId"})," ",e.jsx("em",{children:"or"})," ",e.jsx("code",{children:"loanReference"}),", plus ",e.jsx("code",{children:"amount"})," and ",e.jsx("code",{children:"date"}),"."]}),e.jsx("div",{className:"overflow-x-auto border rounded-xl mt-4",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"p-3 text-left",children:"Loan ID"}),e.jsx("th",{className:"p-3 text-left",children:"Loan Ref"}),e.jsx("th",{className:"p-3 text-left",children:"Date"}),e.jsx("th",{className:"p-3 text-left",children:"Amount"}),e.jsx("th",{className:"p-3 text-left",children:"Method"}),e.jsx("th",{className:"p-3 text-left",children:"Reference"}),e.jsx("th",{className:"p-3 text-left",children:"Notes"}),e.jsx("th",{className:"p-3 text-right",children:"Actions"})]})}),e.jsxs("tbody",{children:[d.map((s,n)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:e.jsx("input",{className:"border rounded px-2 py-1 w-28",value:s.loanId,onChange:a=>l(n,"loanId",a.target.value),placeholder:"123"})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{className:"border rounded px-2 py-1 w-36",value:s.loanReference,onChange:a=>l(n,"loanReference",a.target.value),placeholder:"LN-…"})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:s.date,onChange:a=>l(n,"date",a.target.value)})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",min:"0.01",step:"0.01",className:"border rounded px-2 py-1 w-28",value:s.amount,onChange:a=>l(n,"amount",a.target.value),placeholder:"0.00"})}),e.jsx("td",{className:"p-2",children:e.jsxs("select",{className:"border rounded px-2 py-1",value:s.method,onChange:a=>l(n,"method",a.target.value),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile"}),e.jsx("option",{value:"bank",children:"Bank"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"adjustment",children:"Adjustment"})]})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{className:"border rounded px-2 py-1",value:s.reference,onChange:a=>l(n,"reference",a.target.value),placeholder:"MPESA-… / Bank txn"})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{className:"border rounded px-2 py-1 w-64",value:s.notes,onChange:a=>l(n,"notes",a.target.value),placeholder:"optional"})}),e.jsx("td",{className:"p-2 text-right",children:e.jsx("button",{className:"px-2 py-1 rounded border hover:bg-gray-50",onClick:()=>g(n),disabled:d.length===1,children:"Remove"})})]},n)),e.jsx("tr",{className:"border-t",children:e.jsx("td",{colSpan:8,className:"p-3",children:e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:N,children:"+ Add Row"})})})]})]})}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("button",{onClick:f,disabled:u,className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:u?"Submitting…":"Submit Bulk"}),e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>{r([h()]),i(null),m("")},children:"Reset"})]}),b&&e.jsx("div",{className:"mt-4 p-3 rounded bg-red-50 text-red-700 text-sm border border-red-200",children:b}),j&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-semibold",children:"Result"}),e.jsx("pre",{className:"mt-2 p-3 text-sm bg-gray-50 dark:bg-gray-900 rounded border overflow-auto",children:JSON.stringify(j,null,2)})]})]})})}export{E as default};

import{r as i,b as L,j as s,E as te,G as se,F as re}from"./index-BZcNchgU.js";const v=e=>String(e||"").replace(/[_\-]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,l=>l.toUpperCase()),J=e=>`TZS ${Number(e||0).toLocaleString()}`,oe=e=>typeof e=="number"?`${(e>1?e:e*100).toFixed(2)}%`:String(e??""),G=e=>Object.prototype.toString.call(e)==="[object Object]";function M(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function le(e){if(!e||!e.length)return"";const l=Array.from(e.reduce((c,a)=>(Object.keys(a||{}).forEach(u=>c.add(u)),c),new Set)),r=c=>{const a=M(c);return/[,"\n]/.test(a)?`"${a.replace(/"/g,'""')}"`:a};return[l.join(","),...e.map(c=>l.map(a=>r(c[a])).join(","))].join(`
`)}function ne(e){var r;const l=(e==null?void 0:e.columns)||((r=e==null?void 0:e.table)==null?void 0:r.columns);return l&&Array.isArray(l)?l.map(c=>typeof c=="string"?{key:c,label:v(c)}:c):null}function ae(e={}){const l=[];for(const[r,c]of Object.entries(e)){const a={metric:v(r),value:c},u=r.toLowerCase();/(amount|total|balance|olp|deferred|accrued|received|disbursed)/.test(u)&&typeof c=="number"&&(a.currency=!0),/(par|ratio|yield|efficiency|achievement)/.test(u)&&typeof c=="number"&&(a.percent=!0),l.push(a)}return{columns:[{key:"metric",label:"Metric"},{key:"value",label:"Value"}],rows:l}}function ce(e=[]){const l=e.map(r=>({metric:(r==null?void 0:r.title)??"—",value:(r==null?void 0:r.value)??0,currency:!!(r!=null&&r.currency),percent:!!(r!=null&&r.percent)}));return{columns:[{key:"metric",label:"Metric"},{key:"value",label:"Value"}],rows:l}}function ie(e,l){var b,h,g,y,j;let r=[],c={},a=ne(e)||(Array.isArray(l)?l.slice():[]);const u=((b=e==null?void 0:e.table)==null?void 0:b.period)??(e==null?void 0:e.period),k=((h=e==null?void 0:e.table)==null?void 0:h.scope)??(e==null?void 0:e.scope),N=((g=e==null?void 0:e.table)==null?void 0:g.welcome)??(e==null?void 0:e.welcome),S=((y=e==null?void 0:e.table)==null?void 0:y.asOf)??(e==null?void 0:e.asOf);if(c={...e,period:u,scope:k,welcome:N,asOf:S},Array.isArray((j=e==null?void 0:e.table)==null?void 0:j.rows))r=e.table.rows;else if(Array.isArray(e==null?void 0:e.cards)){const x=ce(e.cards);r=x.rows,a.length||(a=x.columns)}else if(G(e==null?void 0:e.summary)){const x=ae(e.summary);r=x.rows,a.length||(a=x.columns)}else if(Array.isArray(e==null?void 0:e.rows))r=e.rows;else if(Array.isArray(e==null?void 0:e.items))r=e.items;else if(Array.isArray(e==null?void 0:e.buckets))r=e.buckets;else if(e&&typeof e=="object"){const x=new Set(["rows","items","buckets","table","columns","summary","period","scope","welcome","asOf","cards","trends","totals","ratios"]);r=Object.entries(e).filter(([m])=>!x.has(m)).map(([m,f])=>({metric:v(m),value:f})),a.length||(a=[{key:"metric",label:"Metric"},{key:"value",label:"Value",fmt:m=>typeof m=="number"?J(m):M(m)}])}return!a.length&&(r!=null&&r.length)&&G(r[0])&&(a=Object.keys(r[0]).slice(0,12).map(p=>({key:p,label:v(p)}))),{rows:Array.isArray(r)?r:[],columns:a,meta:c}}function de(e,l){if(l!=null&&l.scope&&String(l.scope).trim())return String(l.scope);const r=[];if(r.push(e.branchId?`Branch #${e.branchId}`:"All branches"),r.push(e.officerId?`Officer #${e.officerId}`:"All officers"),r.push(e.borrowerId?`Borrower #${e.borrowerId}`:"All borrowers"),e.startDate||e.endDate){const c=e.startDate||"…",a=e.endDate||"…";r.push(`${c} → ${a}`)}else r.push("All time");return r.join(" · ")}function xe({title:e="Report",endpoint:l,columns:r=[],exportCsvPath:c="",mode:a="auto",filters:u={date:!0,branch:!0,officer:!0,borrower:!0},extraParams:k={},onAfterLoad:N}){const[S,b]=i.useState(!1),[h,g]=i.useState(""),[y,j]=i.useState(null),x=new Date().toISOString().slice(0,10),[p,m]=i.useState(""),[f,V]=i.useState(""),[C,T]=i.useState(""),[$,U]=i.useState(""),[_,z]=i.useState(""),[A,I]=i.useState(""),[X,H]=i.useState([]),[Z,K]=i.useState([]),[P,E]=i.useState([]),O=i.useRef(!0);i.useEffect(()=>()=>{O.current=!1},[]),i.useEffect(()=>{(async()=>{try{const{data:t}=await L.get("/reports/filters");H((t==null?void 0:t.branches)||[]),K((t==null?void 0:t.officers)||[])}catch{}})()},[]),i.useEffect(()=>{const t=A.trim();if(!t){E([]);return}const d=setTimeout(async()=>{try{const{data:n}=await L.get("/borrowers/search",{params:{q:t}});E(Array.isArray(n)?n.slice(0,8):[])}catch{E([])}},250);return()=>clearTimeout(d)},[A]);const D=i.useMemo(()=>({...k,startDate:u.date&&p||void 0,endDate:u.date&&f||void 0,branchId:u.branch&&C||void 0,officerId:u.officer&&$||void 0,borrowerId:u.borrower&&_||void 0}),[k,p,f,C,$,_,u]),B=async()=>{var t,d;if(l){b(!0),g("");try{const{data:n}=await L.get(l,{params:D});if(!O.current)return;j(n),typeof N=="function"&&N(n)}catch(n){if(!O.current)return;console.error("Report load error:",n),g(((d=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:d.error)||(n==null?void 0:n.message)||"Failed to load report"),j({table:{rows:[]}})}finally{O.current&&b(!1)}}};i.useEffect(()=>{B()},[l]);const{rows:R,columns:Q,meta:o}=i.useMemo(()=>ie(y,r),[y,r]),W=i.useMemo(()=>de(D,o),[D,o]),Y=(t,d)=>{const n=d==null?void 0:d[t.key],q=(d==null?void 0:d.currency)&&(t.key==="value"||/amount|total|balance|olp/i.test(t.key)),F=(d==null?void 0:d.percent)&&(t.key==="value"||/par|ratio|yield|efficiency|achievement/i.test(t.key));return t.fmt?t.fmt(n,d):F?oe(Number(n||0)):q&&typeof n=="number"?J(n):M(n)},w=()=>{if(c){const F=`https://mkoposuite-backend-42w2.onrender.com/api${c}`;window.open(F,"_blank","noopener,noreferrer");return}const t=le(R),d=new Blob([t],{type:"text/csv"}),n=document.createElement("a");n.href=URL.createObjectURL(d),n.download=`${e.replace(/\s+/g,"_").toLowerCase()}_${new Date().toISOString().slice(0,10)}.csv`,n.click()},ee=()=>{m(""),V(""),T(""),U(""),z(""),I("")};return s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-bold",children:e}),s.jsx("div",{className:"text-[12px] text-slate-500",children:W}),(o==null?void 0:o.welcome)&&s.jsx("div",{className:"text-[12px] text-emerald-700 dark:text-emerald-400 mt-1",children:o.welcome}),((o==null?void 0:o.asOf)||(o==null?void 0:o.period))&&s.jsxs("div",{className:"text-[12px] text-slate-500 mt-1",children:[o!=null&&o.asOf?`As Of: ${String(o.asOf).slice(0,10)}`:"",o!=null&&o.asOf&&(o!=null&&o.period)?" · ":"",o!=null&&o.period?`Period: ${o.period}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:B,className:"inline-flex items-center gap-2 h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",title:"Refresh",children:[s.jsx(te,{className:S?"animate-spin":""}),"Refresh"]}),s.jsxs("button",{onClick:w,className:"inline-flex items-center gap-2 h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export CSV",children:[s.jsx(se,{})," Export"]})]})]})}),a!=="snapshot"&&s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3",children:[u.date&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Start"}),s.jsx("input",{type:"date",value:p,onChange:t=>m(t.target.value),max:f||new Date().toISOString().slice(0,10),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"End"}),s.jsx("input",{type:"date",value:f,onChange:t=>V(t.target.value),min:p||"",max:x,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]})]}),u.branch&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Branch"}),s.jsxs("select",{value:C,onChange:t=>T(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),X.map(t=>s.jsx("option",{value:t.id,children:t.name||`#${t.id}`},t.id))]})]}),u.officer&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Officer"}),s.jsxs("select",{value:$,onChange:t=>U(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),(Array.isArray(Z)?Z:[]).map(t=>s.jsx("option",{value:t.id,children:t.name||t.email||`#${t.id}`},t.id))]})]}),u.borrower&&s.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Borrower"}),s.jsxs("div",{className:"relative flex-1",children:[s.jsx(re,{className:"absolute left-3 top-3 text-slate-400"}),s.jsx("input",{value:A,onChange:t=>I(t.target.value),placeholder:"Type to search borrowers…",className:"w-full pl-9 pr-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"}),A&&P.length>0&&s.jsx("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-slate-900 border rounded shadow max-h-56 overflow-auto",children:P.map(t=>s.jsxs("button",{type:"button",onClick:()=>{z(String(t.id)),I(t.name||t.phone||t.email||`Borrower #${t.id}`)},className:"w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800",children:[t.name||`Borrower #${t.id}`," ",s.jsx("span",{className:"opacity-60",children:t.phone||t.email||""})]},t.id))})]}),s.jsx("button",{onClick:()=>B(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),s.jsx("button",{onClick:ee,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]})}),s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:h?s.jsx("div",{className:"text-red-600 text-sm",children:h}):S?s.jsx("div",{className:"text-slate-500 text-sm",children:"Loading…"}):R.length===0?s.jsx("div",{className:"text-slate-500 text-sm",children:"No data."}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200",children:s.jsx("tr",{children:Q.map(t=>s.jsx("th",{className:"px-3 py-2 text-left font-semibold",children:t.label||v(t.key)},t.key))})}),s.jsx("tbody",{children:R.map((t,d)=>s.jsx("tr",{className:"border-t border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/40",children:Q.map(n=>s.jsx("td",{className:"px-3 py-2",children:Y(n,t)},n.key))},d))})]})})}),((o==null?void 0:o.period)||(o==null?void 0:o.scope))&&s.jsxs("div",{className:"text-[12px] text-slate-500",children:[o!=null&&o.period?`Period: ${o.period}`:""," ",o!=null&&o.scope?`· Scope: ${o.scope}`:""]})]})}export{xe as R};

import{r as n,j as e,g as S}from"./index-x5m31TRy.js";import{E}from"./jspdf.es.min-BxU6MWEF.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as A}from"./index-BhPNdCRX.js";function R(l,h=300){const[m,x]=n.useState(l);return n.useEffect(()=>{const g=setTimeout(()=>x(l),h);return()=>clearTimeout(g)},[l,h]),m}function C({value:l,onChange:h,placeholder:m="Search name, phone or ID…"}){const[x,g]=n.useState(""),[f,o]=n.useState(!1),[j,w]=n.useState([]),[N,d]=n.useState(!1),c=n.useRef(null),i=R(x,250);n.useEffect(()=>{function a(b){c.current&&(c.current.contains(b.target)||o(!1))}return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),n.useEffect(()=>{let a=!1;async function b(){if(!i||i.length<1){w([]);return}d(!0);try{const k=await S._get(`/borrowers/search?q=${encodeURIComponent(i)}`);a||w(Array.isArray(k.data)?k.data:[])}catch{a||w([])}finally{a||d(!1)}}return b(),()=>{a=!0}},[i]);const p=a=>{g(`${a.name} (${a.id})`),o(!1),h==null||h(a.id,a)},v=N?"Searching…":f&&j.length===0&&i?"No matches":"";return e.jsxs("div",{ref:c,className:"relative w-[320px]",children:[e.jsx("input",{value:x,onChange:a=>{g(a.target.value),o(!0)},onFocus:()=>o(!0),placeholder:m,className:"border px-3 py-2 rounded w-full dark:bg-slate-700 dark:border-slate-600"}),v&&e.jsx("div",{className:"absolute right-2 top-2 text-xs text-slate-400",children:v}),f&&j.length>0&&e.jsx("div",{className:"absolute mt-1 z-50 w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded shadow max-h-64 overflow-auto",children:j.map(a=>e.jsxs("button",{className:"w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700",onClick:()=>p(a),type:"button",children:[e.jsx("div",{className:"text-sm font-medium",children:a.name}),e.jsxs("div",{className:"text-xs text-slate-500",children:["ID: ",a.id," • ",a.phone||"—"]})]},a.id))}),l?e.jsx("input",{type:"hidden",value:l}):null]})}const B=()=>{const[l,h]=n.useState([]),[m,x]=n.useState({}),[g,f]=n.useState(0),[o,j]=n.useState({borrowerId:"",type:""}),[w,N]=n.useState(!1),[d,c]=n.useState({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),[i,p]=n.useState(""),v=JSON.parse(localStorage.getItem("user")||"{}"),a=((v==null?void 0:v.role)||"").toLowerCase()==="admin",b=async()=>{var s,r;p("");try{if(!o.borrowerId){h([]),f(0),x({});return}const t=new URLSearchParams;o.type&&t.set("type",o.type);const u=await S._get(`/savings/borrower/${o.borrowerId}?${t.toString()}`);h(u.data.transactions||[]),f(u.data.balance||0),x(u.data.totals||{})}catch(t){p(((r=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:r.error)||(t==null?void 0:t.normalizedMessage)||"Failed to fetch savings")}};n.useEffect(()=>{b()},[o.borrowerId,o.type]);const k=async()=>{var s,r;p("");try{const t={...d};if(!t.borrowerId||!t.type||!t.amount||!t.date){p("Borrower, type, amount and date are required.");return}await S._post("/savings",t),N(!1),c({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),b()}catch(t){p(((r=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:r.error)||(t==null?void 0:t.normalizedMessage)||"Failed to save.")}},I=async s=>{var r,t;if(window.confirm("Reverse this transaction?"))try{await S._patch(`/savings/transactions/${s}/reverse`),b()}catch(u){p(((t=(r=u==null?void 0:u.response)==null?void 0:r.data)==null?void 0:t.error)||(u==null?void 0:u.normalizedMessage)||"Failed to reverse.")}},T=()=>{const s=new E;s.text("Savings Transactions",14,16),s.autoTable({startY:20,head:[["Date","Type","Amount","Notes","Reversed"]],body:l.map(r=>[r.date,r.type,r.amount,r.notes||"-",r.reversed?"Yes":"No"])}),s.save("savings.pdf")},D=[["Date","Type","Amount","Notes","Reversed"],...l.map(s=>[s.date,s.type,s.amount,s.notes||"",s.reversed?"Yes":"No"])],y="bg-white dark:bg-slate-800 rounded-xl shadow p-4";return e.jsxs("div",{className:"p-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Savings"}),e.jsx("button",{onClick:()=>N(!0),className:"bg-blue-600 text-white px-4 py-2 rounded",children:"+ Add Transaction"})]}),e.jsxs("div",{className:`${y} mb-4`,children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Borrower"}),e.jsx(C,{value:o.borrowerId||null,onChange:s=>j(r=>({...r,borrowerId:s}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Type"}),e.jsxs("select",{value:o.type,onChange:s=>j({...o,type:s.target.value}),className:"border px-3 py-2 rounded w-48 dark:bg-slate-700 dark:border-slate-600",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]})]})]}),i&&e.jsxs("div",{className:"text-sm text-rose-600 mt-3",children:["Error: ",i]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:y,children:["Balance: ",e.jsx("strong",{children:g})]}),e.jsxs("div",{className:y,children:["Deposits: ",e.jsx("strong",{children:m.deposits||0})]}),e.jsxs("div",{className:y,children:["Withdrawals: ",e.jsx("strong",{children:m.withdrawals||0})]}),e.jsxs("div",{className:y,children:["Charges: ",e.jsx("strong",{children:m.charges||0})]})]}),e.jsxs("div",{className:"flex gap-3 mb-3",children:[e.jsx(A,{data:D,filename:"savings.csv",className:"bg-green-600 text-white px-4 py-2 rounded",children:"Export CSV"}),e.jsx("button",{onClick:T,className:"bg-red-600 text-white px-4 py-2 rounded",children:"Export PDF"})]}),e.jsx("div",{className:"overflow-x-auto bg-white dark:bg-slate-800 border rounded shadow",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-slate-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 border",children:"Date"}),e.jsx("th",{className:"p-2 border",children:"Type"}),e.jsx("th",{className:"p-2 border",children:"Amount"}),e.jsx("th",{className:"p-2 border",children:"Notes"}),e.jsx("th",{className:"p-2 border",children:"Reversed"}),a&&e.jsx("th",{className:"p-2 border",children:"Action"})]})}),e.jsxs("tbody",{children:[l.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:s.date}),e.jsx("td",{className:"border p-2 capitalize",children:s.type}),e.jsx("td",{className:"border p-2",children:s.amount}),e.jsx("td",{className:"border p-2",children:s.notes||"-"}),e.jsx("td",{className:"border p-2",children:s.reversed?"Yes":"No"}),a&&e.jsx("td",{className:"border p-2",children:!s.reversed&&e.jsx("button",{onClick:()=>I(s.id),className:"text-red-500 text-sm",children:"Reverse"})})]},s.id)),!l.length&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-sm text-slate-500",colSpan:a?6:5,children:o.borrowerId?"No transactions found.":"Search and select a borrower to view transactions."})})]})]})}),w&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-6 rounded shadow-md w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Add Transaction"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(C,{value:d.borrowerId||null,onChange:s=>c(r=>({...r,borrowerId:s})),placeholder:"Pick borrower…"}),e.jsxs("select",{value:d.type,onChange:s=>c({...d,type:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700",children:[e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]}),e.jsx("input",{type:"number",placeholder:"Amount",value:d.amount,onChange:s=>c({...d,amount:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"date",value:d.date,onChange:s=>c({...d,date:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"text",placeholder:"Notes",value:d.notes,onChange:s=>c({...d,notes:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>N(!1),className:"px-4 py-2 bg-gray-300 rounded",children:"Cancel"}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"Save"})]}),i&&e.jsxs("div",{className:"text-sm text-rose-600",children:["Error: ",i]})]})]})})]})};export{B as default};

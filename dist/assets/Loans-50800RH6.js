import{u as de,r as o,j as a,L as le,g as T}from"./index-D-uMSrPq.js";import{E as ue}from"./jspdf.es.min-C3annANs.js";import"./jspdf.plugin.autotable-CfO62xhj.js";import{C as me}from"./index-CA-mJXux.js";const R=r=>Array.isArray(r)?r:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.rows)?r.rows:Array.isArray(r==null?void 0:r.data)?r.data:[],g=r=>{const c=Number(r);return Number.isFinite(c)?new Intl.NumberFormat(void 0,{maximumFractionDigits:0}).format(c):r??"—"},q=r=>{const c=Number(r);return Number.isFinite(c)?c.toFixed(2):r??"—"},I=r=>{if(!r)return"—";const c=new Date(r);return Number.isNaN(+c)?String(r).slice(0,10):c.toLocaleDateString()};function G(r,c){if(!r)return"";const[w,m,y]=String(r).split("-").map(Number);if(!w||!m||!y)return r;const b=new Date(Date.UTC(w,m-1,y)),D=b.getUTCMonth()+Number(c||0),j=new Date(Date.UTC(b.getUTCFullYear(),D,b.getUTCDate()));return j.getUTCMonth()!==((m-1+Number(c||0))%12+12)%12&&j.setUTCDate(0),j.toISOString().slice(0,10)}const ge=()=>{const r=de(),[c,w]=o.useState([]),[m,y]=o.useState([]),[b,D]=o.useState([]),[j,E]=o.useState(!1),[P,J]=o.useState(""),[A,K]=o.useState("all"),[C,Q]=o.useState(""),[L,W]=o.useState(""),[v,X]=o.useState(""),[f,Z]=o.useState(""),ee=async()=>{var e,t;E(!0);try{const s=await T.get("/loans",{params:{page:1,pageSize:500,include:"aggregates"}});w(R(s.data))}catch(s){console.error(s),alert(`Failed to load loans${(t=(e=s==null?void 0:s.response)==null?void 0:e.data)!=null&&t.error?`: ${s.response.data.error}`:""}`),w([])}finally{E(!1)}},te=async()=>{try{const e=await T.get("/branches",{params:{page:1,pageSize:500}});y(R(e.data))}catch{y([])}},ae=async()=>{try{const e=await T.get("/loan-products",{params:{page:1,pageSize:500}});D(R(e.data))}catch{D([])}};o.useEffect(()=>{ee(),te(),ae()},[]);const M=o.useMemo(()=>Object.fromEntries((b||[]).map(e=>[String(e.id),e])),[b]),B=o.useMemo(()=>Object.fromEntries((m||[]).map(e=>[String(e.id),e])),[m]),re=e=>{const t=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at;if(!t||!v&&!f)return!0;const s=new Date(t);if(v&&s<new Date(v))return!1;if(f){const n=new Date(f);if(n.setHours(23,59,59,999),s>n)return!1}return!0},i=o.useMemo(()=>{const e=P.trim().toLowerCase();return(c||[]).filter(t=>{var l,h,x;const s=(t.status||t.loanStatus||"").toLowerCase(),n=A==="all"||s===A,d=(((l=t.Borrower)==null?void 0:l.name)||t.borrowerName||t.borrower_name||((h=t.borrower)==null?void 0:h.name)||"").toLowerCase().includes(e)||String(t.id||t.loanId||"").toLowerCase().includes(e),p=String(t.branchId||((x=t.branch)==null?void 0:x.id)||t.branch_id||""),S=!C||p===String(C),u=!L||String(t.productId)===String(L);return n&&d&&S&&u&&re(t)})},[c,A,P,C,L,v,f]);o.useMemo(()=>{const e=i.reduce((s,n)=>s+Number(n.amount||n.principal||0),0),t=s=>i.filter(n=>(n.status||n.loanStatus||"").toLowerCase()===s).length;return{total:i.length,totalPrincipal:e,pending:t("pending"),approved:t("approved"),disbursed:t("disbursed"),active:t("active"),closed:t("closed"),rejected:t("rejected")}},[i]);const _=o.useMemo(()=>i.map(e=>{var u,l,h,x,F;const t=Number(e.amount??e.principal??0),s=Number(e.totalInterest??0),n=e.outstanding??e.outstandingAmount??e.remainingAmount??void 0;let k="";if(Number.isFinite(n)){const N=Number.isFinite(s)?t+s:t;k=Math.max(0,N-Number(n))}const d=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at||"",p=e.termMonths??e.durationMonths??e.term_months??null,S=e.endDate||(d&&p?G(String(d).slice(0,10),p):"");return{id:e.id,borrower:((u=e.Borrower)==null?void 0:u.name)||e.borrowerName||e.borrower_name||((l=e.borrower)==null?void 0:l.name)||"",branch:((h=e.branch)==null?void 0:h.name)||((x=B[String(e.branchId||"")])==null?void 0:x.name)||"",product:((F=M[String(e.productId)])==null?void 0:F.name)||"",amount:t,rate:e.interestRate??e.rate??"",termMonths:p??"",startDate:d,endDate:S,paidAmount:k,outstanding:Number.isFinite(n)?Number(n):"",status:e.status||e.loanStatus||""}}),[i,M,B]),se=[{label:"Loan ID",key:"id"},{label:"Borrower",key:"borrower"},{label:"Branch",key:"branch"},{label:"Product",key:"product"},{label:"Principal",key:"amount"},{label:"Rate (%)",key:"rate"},{label:"Term (months)",key:"termMonths"},{label:"Start Date",key:"startDate"},{label:"End Date",key:"endDate"},{label:"Paid Amount",key:"paidAmount"},{label:"Outstanding Amount",key:"outstanding"},{label:"Status",key:"status"}],ne=()=>{const e=new ue;e.text("Loans Report",14,16),e.autoTable({startY:20,head:[["ID","Borrower","Branch","Product","Principal","Rate (%)","Term","Start Date","End Date","Paid","Outstanding","Status"]],body:_.map(t=>[t.id,t.borrower,t.branch,t.product,g(t.amount),q(t.rate),t.termMonths,I(t.startDate),I(t.endDate),g(t.paidAmount),g(t.outstanding),t.status])}),e.save("loans.pdf")},oe=e=>{const t=(e||"").toLowerCase(),s="px-2 py-1 rounded text-xs font-semibold";switch(t){case"pending":return`${s} bg-yellow-100 text-yellow-800`;case"approved":return`${s} bg-emerald-100 text-emerald-800`;case"rejected":return`${s} bg-rose-100 text-rose-800`;case"disbursed":case"active":return`${s} bg-blue-100 text-blue-800`;case"closed":return`${s} bg-gray-100 text-gray-900`;default:return`${s} bg-gray-200 text-gray-900`}};return a.jsxs("div",{className:"p-4 md:p-6 lg:p-8 space-y-6 text-black dark:text-white",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-2xl md:text-3xl font-extrabold tracking-tight",children:"All Loans"}),a.jsx(le,{className:"text-black font-semibold underline",to:"/loans/applications",children:"New Application"})]}),a.jsx("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[{label:"Total",value:i.length},{label:"Principal",value:g(i.reduce((e,t)=>e+Number(t.amount||t.principal||0),0))},{label:"Pending",value:i.filter(e=>(e.status||e.loanStatus||"").toLowerCase()==="pending").length},{label:"Approved",value:i.filter(e=>(e.status||e.loanStatus||"").toLowerCase()==="approved").length},{label:"Disbursed",value:i.filter(e=>(e.status||e.loanStatus||"").toLowerCase()==="disbursed").length},{label:"Active",value:i.filter(e=>(e.status||e.loanStatus||"").toLowerCase()==="active").length}].map((e,t)=>a.jsxs("div",{className:"card p-4 ring-2 ring-black/10 border-2 border-black/20 text-black dark:text-white",children:[a.jsxs("p",{className:"text-xs",children:[" ",e.label," "]}),a.jsx("p",{className:"text-lg font-bold",children:e.value})]},t))}),a.jsxs("div",{className:"card p-4 grid grid-cols-1 md:grid-cols-6 gap-3 ring-2 ring-black/10 border-2 border-black/20 text-black dark:text-white",children:[a.jsx("input",{type:"text",placeholder:"Search borrower or loan ID…",value:P,onChange:e=>J(e.target.value),className:"input md:col-span-2 text-black"}),a.jsxs("select",{value:A,onChange:e=>K(e.target.value),className:"input text-black",children:[a.jsx("option",{value:"all",children:"All Statuses"}),a.jsx("option",{value:"pending",children:"Pending"}),a.jsx("option",{value:"approved",children:"Approved"}),a.jsx("option",{value:"disbursed",children:"Disbursed"}),a.jsx("option",{value:"active",children:"Active"}),a.jsx("option",{value:"rejected",children:"Rejected"}),a.jsx("option",{value:"closed",children:"Closed"})]}),a.jsxs("select",{value:C,onChange:e=>Q(e.target.value),className:"input text-black",children:[a.jsx("option",{value:"",children:"All Branches"}),m.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),a.jsxs("select",{value:L,onChange:e=>W(e.target.value),className:"input text-black",children:[a.jsx("option",{value:"",children:"All Products"}),b.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),a.jsx("input",{type:"date",value:v,onChange:e=>X(e.target.value),className:"input text-black"}),a.jsx("input",{type:"date",value:f,onChange:e=>Z(e.target.value),className:"input text-black"}),a.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[a.jsx(me,{data:_,headers:se,filename:"loans.csv",className:"px-4 py-2 rounded bg-black text-white hover:opacity-90",children:"Export CSV"}),a.jsx("button",{onClick:ne,className:"px-4 py-2 rounded bg-black text-white hover:opacity-90",children:"Export PDF"})]})]}),a.jsx("div",{className:"card overflow-x-auto ring-2 ring-black/10 border-2 border-black/20",children:j?a.jsx("p",{className:"p-4",children:"Loading loans…"}):i.length===0?a.jsx("p",{className:"p-4",children:"No loans found."}):a.jsxs("table",{className:"min-w-full text-sm border-2 border-black/30",children:[a.jsx("thead",{className:"bg-white text-black",children:a.jsx("tr",{children:["ID","Borrower","Branch","Product","Principal","Interest Rate (%)","Loan term","Start Date","End Date","Paid Amount","Outstanding Amount","Status","Action"].map(e=>a.jsx("th",{className:"p-2 border-2 border-black/30 text-left",children:e},e))})}),a.jsx("tbody",{children:i.map(e=>{var U,z,V,H,Y;const t=(e.status||e.loanStatus||"").toLowerCase(),s=((U=e.Borrower)==null?void 0:U.name)||e.borrowerName||e.borrower_name||((z=e.borrower)==null?void 0:z.name)||"N/A",n=((V=M[String(e.productId)])==null?void 0:V.name)||"—",k=((H=e.branch)==null?void 0:H.name)||((Y=B[String(e.branchId||"")])==null?void 0:Y.name)||"—",d=Number(e.amount??e.principal??0),p=g(d),S=q(e.interestRate??e.rate),u=e.termMonths??e.durationMonths??e.term_months??"—",l=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at,h=I(l),x=e.endDate||(l&&u?G(String(l).slice(0,10),u):""),F=I(x),N=e.outstanding??e.outstandingAmount??e.remainingAmount??null,ce=N==null?"—":g(N),$=Number(e.totalInterest??NaN);let O="—";if(Number.isFinite(Number(N))){const ie=Number.isFinite($)?d+$:d;O=g(Math.max(0,ie-Number(N)))}return a.jsxs("tr",{className:"hover:bg-gray-50",children:[a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:e.id}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:s}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:k}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:n}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:p}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:S}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:u}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:h}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:F}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:O}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:ce}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:a.jsx("span",{className:oe(t),children:t})}),a.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:a.jsx("button",{onClick:()=>r(`/loans/${e.id}`),className:"text-black underline",children:"View loan"})})]},e.id)})})]})})]})};export{ge as default};

import{k as ie,u as le,r as u,h as S,j as a,L as ce}from"./index-CM-KCFgk.js";import{B as de}from"./BorrowerAutoComplete-CfQg0_P-.js";const w=e=>e?{headers:{"x-tenant-id":e}}:{},ue=e=>e||(typeof S.getTenantId=="function"?S.getTenantId():null),me="00000000-0000-0000-0000-000000000000",fe=e=>!!e&&e!==me&&e!=="null"&&e!=="undefined";function pe(){var n,r,c;const e=((r=(n=S)==null?void 0:n.defaults)==null?void 0:r.baseURL)||((c=S)==null?void 0:c.baseURL)||"",t=new Set;if(e){const l=e.replace(/\/+$/,"/");t.add(l);const p=l.replace(/\/api(?:\/v\d+)?\/$/i,"/");t.add(p)}return Array.from(t)}function he(e){const t=e.replace(/^\//,""),n=pe();if(n.length===0&&typeof window<"u"){const c=window.location.origin.replace(/\/+$/,"/");n.push(c)}const r=new Set;for(const c of n){const l=c.replace(/\/+$/,"/");r.add(`${l}${t}`),r.add(`${l}api/${t}`),r.add(`${l}api/v1/${t}`),r.add(`${l}v1/${t}`)}return r.add(`/${t}`),r.add(`/api/${t}`),r.add(`/api/v1/${t}`),r.add(`/v1/${t}`),Array.from(r)}async function E(e){let t;for(const n of e)try{const r=await n();return(r==null?void 0:r.data)??r}catch(r){t=r}throw t||new Error("No endpoint succeeded")}function I(e,t=[],n,r){const c=[];for(const l of t){if(!l)continue;let p=l.startsWith("/")?l.slice(1):l;p=p.replace(/^api\/v\d+\//i,"").replace(/^api\//i,"").replace(/^v\d+\//i,"");const x=he(p);for(const d of x)c.push(()=>e==="get"||e==="delete"?S[e](d,r):S[e](d,n,r))}return c}async function A(e=[],t={}){return E(I("get",e,void 0,t))}async function Q(e=[],t={},n={}){return E(I("post",e,t,n))}async function be(e=[],t={},n={}){const r=I("patch",e,t,n),c=I("put",e,t,n),l=I("post",e,t,n);return E([...r,...c,...l])}async function ge(e=[],t={}){return E(I("delete",e,void 0,t))}const q=(e,t,n="No options")=>e==="loading"?"Loading…":e==="error"?"Failed to load — Retry":e==="empty"?n:t;function xe(e){return{id:e.id??e._id??e.borrowerId??e.memberId,name:e.name||`${e.firstName||""} ${e.lastName||""}`.trim()||e.fullName||e.id,phone:e.phone??e.msisdn??e.mobile,role:e.role||e.memberRole}}function U(e){var n,r,c,l,p;if(!e||typeof e!="object")return null;const t=Array.isArray(e.members)?e.members:e.groupMembers||e.items||[];return{id:e.id??e._id??e.groupId??e.code,name:e.name??e.groupName??e.title??"—",branchId:e.branchId??e.branch_id??((n=e.branch)==null?void 0:n.id)??null,branchName:e.branchName??((r=e.branch)==null?void 0:r.name)??"—",loanOfficerId:e.loanOfficerId??e.loan_officer_id??((c=e.officer)==null?void 0:c.id)??null,officerName:e.officerName??((l=e.officer)==null?void 0:l.name)??"—",meetingDay:e.meetingDay??((p=e.meeting)==null?void 0:p.day)??"",status:e.status??"active",members:t.map(xe)}}async function ve(e,t){const n=encodeURIComponent(e),r=await A([`groups/${n}`,`borrowers/groups/${n}`,`loan-groups/${n}`,`/groups/${n}`,`/borrowers/groups/${n}`,`/loan-groups/${n}`],{signal:t}).catch(()=>null);if(r)return U((r==null?void 0:r.data)??r);const c=await A([`groups?id=${n}`,`groups?groupId=${n}`,`groups?code=${n}`,`groups?name=${n}`,`borrowers/groups?id=${n}`,`borrowers/groups?groupId=${n}`,`borrowers/groups?code=${n}`,`borrowers/groups?name=${n}`,`loan-groups?id=${n}`,`loan-groups?groupId=${n}`,`loan-groups?code=${n}`,`loan-groups?name=${n}`],{signal:t}).catch(()=>null);if(c){const p=Array.isArray(c)?c:c.items||c.rows||c.data||[];if(p!=null&&p.length){const x=p.find(d=>[d.id,d._id,d.groupId,d.code,d.slug,d.uuid,d.name,d.groupName].filter(Boolean).map(String).includes(String(e)))||p[0];if(x)return U(x)}}const l=await A(["groups?include=members","groups","borrowers/groups?include=members","borrowers/groups","loan-groups?include=members","loan-groups","/groups?include=members","/groups","/borrowers/groups?include=members","/borrowers/groups","/loan-groups?include=members","/loan-groups"],{signal:t}).catch(()=>null);if(l){const x=(Array.isArray(l)?l:l.items||l.rows||l.data||[]).find(d=>[d.id,d._id,d.groupId,d.code,d.slug,d.uuid,d.name,d.groupName].filter(Boolean).map(String).includes(String(e)))||null;if(x)return U(x)}return null}const i={container:"w-full px-4 md:px-6 lg:px-8 py-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-3xl font-extrabold tracking-tight",h1Muted:"font-medium text-[var(--muted)]",card:"rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",btn:"inline-flex items-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 hover:bg-[var(--kpi-bg)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",primary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-4 py-2 font-semibold hover:bg-indigo-700 disabled:opacity-60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",input:"h-10 rounded-lg border-2 px-3 outline-none focus:ring-2 focus:ring-[var(--ring)] bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)]",tableWrap:"rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow overflow-x-auto",th:"bg-[var(--kpi-bg)] text-left text-[13px] uppercase tracking-wide text-[var(--muted)] font-semibold px-3 py-2 border-2 border-[var(--border)]",td:"px-3 py-2 border-2 border-[var(--border)] text-sm",chip:"ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-bold bg-[var(--chip-soft)] text-[var(--fg)] ring-1 ring-[var(--border)]",label:"text-[12px] font-semibold uppercase tracking-wider text-[var(--muted)] mb-1",muted:"text-[var(--muted)]"},ye=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],je=[{value:"active",label:"Active"},{value:"inactive",label:"Inactive"}];function we(){const{groupId:e}=ie();le();const t=u.useMemo(()=>ue(),[]),n=fe(t)?t:null,[r,c]=u.useState(null),[l,p]=u.useState(!0),[x,d]=u.useState(""),[v,F]=u.useState(!1),[P,G]=u.useState(!1),[b,y]=u.useState({name:"",branchId:"",loanOfficerId:"",meetingDay:"",status:"active"}),[N,V]=u.useState(null),[z,K]=u.useState(!1),[D,L]=u.useState([]),[_,B]=u.useState([]),[W,k]=u.useState("loading"),[H,O]=u.useState("loading"),[J,X]=u.useState(0),[Y,Z]=u.useState(0),$=async s=>{try{p(!0),d("");const f=await ve(e,s);f?(c(f),y({name:f.name||"",branchId:f.branchId||"",loanOfficerId:f.loanOfficerId||"",meetingDay:f.meetingDay||"",status:f.status||"active"})):(d("Group not found."),c(null))}catch{d("Failed to load group."),c(null)}finally{p(!1)}};u.useEffect(()=>{const s=new AbortController;return $(s.signal),()=>s.abort()},[e]),u.useEffect(()=>{if(!v)return;const s=n,f=[s?`tenants/${s}/branches`:null,"branches","loan-branches","/branches","/loan-branches","v1/branches","v1/loan-branches","/v1/branches","/v1/loan-branches","organization/branches","org/branches","/organization/branches","/org/branches"].filter(Boolean);let g=!1;return k("loading"),(async()=>{try{const h=await A(f,w(s)),j=(Array.isArray(h)&&h||(h==null?void 0:h.items)||(h==null?void 0:h.data)||(h==null?void 0:h.rows)||[]||[]).map(m=>({id:m.id??m.code??m.uuid??m.branchId??m.slug,name:m.name??m.branchName??m.title??(m.code?String(m.code):"—")}));g||(L(j),k(j.length?"ok":"empty"))}catch{g||(L([]),k("error"))}})(),()=>{g=!0}},[v,n,J]),u.useEffect(()=>{if(!v)return;const s=n,f=[s?`tenants/${s}/officers`:null,"officers","loan-officers","users?role=loan_officer","users?role=officer","/officers","/loan-officers","/users?role=loan_officer","/users?role=officer","v1/officers","v1/users?role=officer","/v1/officers","/v1/users?role=officer","employees?role=loan_officer","staff?role=loan_officer","/employees?role=loan_officer","/staff?role=loan_officer"].filter(Boolean);let g=!1;return O("loading"),(async()=>{try{const h=await A(f,w(s)),m=((o=>Array.isArray(o)&&o||(o==null?void 0:o.items)||(o==null?void 0:o.data)||(o==null?void 0:o.rows)||(o==null?void 0:o.results)||(o==null?void 0:o.officers)||(o==null?void 0:o.users)||[])(h)||[]).map(o=>({id:o.loanOfficerId??o.id??o.userId??o.uuid??o.code??o.employeeId,name:o.name||o.fullName||[o.firstName,o.lastName].filter(Boolean).join(" ")||o.email||String(o.id??o.userId??"")}));g||(B(m),O(m.length?"ok":"empty"))}catch{g||(B([]),O("error"))}})(),()=>{g=!0}},[v,n,Y]),u.useEffect(()=>{v&&r!=null&&r.branchId&&!D.length&&(L([{id:r.branchId,name:r.branchName||String(r.branchId)}]),k("ok"))},[v,r,D.length]),u.useEffect(()=>{v&&r!=null&&r.loanOfficerId&&!_.length&&(B([{id:r.loanOfficerId,name:r.officerName||String(r.loanOfficerId)}]),O("ok"))},[v,r,_.length]);const ee=async()=>{G(!0);try{const s={name:b.name||null,branchId:b.branchId||null,loanOfficerId:b.loanOfficerId||null,meetingDay:b.meetingDay||null,status:b.status||"active"};await be([`borrowers/groups/${e}`,`groups/${e}`,`loan-groups/${e}`,`/borrowers/groups/${e}`,`/groups/${e}`,`/loan-groups/${e}`],s,w(n)),await $(),F(!1)}catch{alert("Failed to save changes.")}finally{G(!1)}},re=async()=>{if(N!=null&&N.id)try{K(!0),await Q([`borrowers/groups/${e}/members`,`groups/${e}/members`,`loan-groups/${e}/members`,`/borrowers/groups/${e}/members`,`/groups/${e}/members`,`/loan-groups/${e}/members`],{borrowerId:N.id},w(n)),V(null),await $()}catch{alert("Failed to add member.")}finally{K(!1)}},ae=async s=>{try{await ge([`borrowers/groups/${e}/members/${s}`,`groups/${e}/members/${s}`,`loan-groups/${e}/members/${s}`,`/borrowers/groups/${e}/members/${s}`,`/groups/${e}/members/${s}`,`/loan-groups/${e}/members/${s}`],w(n)),await $()}catch{alert("Failed to remove member.")}},T=u.useRef(null),se=async s=>{var g;const f=(g=s.target.files)==null?void 0:g[0];if(f)try{const h=new FormData;h.append("file",f),await Q([`borrowers/groups/${e}/members/import`,`groups/${e}/members/import`,`loan-groups/${e}/members/import`,`/borrowers/groups/${e}/members/import`,`/groups/${e}/members/import`,`/loan-groups/${e}/members/import`],h,{...w(n),headers:{...n?{"x-tenant-id":n}:{},"Content-Type":"multipart/form-data"}}),alert("Import complete"),await $()}catch{alert("Failed to import CSV.")}finally{T.current&&(T.current.value="")}},ne=()=>{const s=((r==null?void 0:r.members)||[]).map(m=>({borrowerId:m.id,name:m.name,phone:m.phone||"",role:m.role||""})),f=["borrowerId","name","phone","role"],g=[f.join(","),...s.map(m=>f.map(o=>`"${String(m[o]??"").replace(/"/g,'""')}"`).join(","))].join(`
`),h=new Blob([g],{type:"text/csv;charset=utf-8"}),R=URL.createObjectURL(h),j=document.createElement("a");j.href=R,j.download=`group-${e}-members.csv`,j.click(),URL.revokeObjectURL(R)},M=Array.isArray(r==null?void 0:r.members)?r.members:[],te=q(H,"Select loan officer…","No officers"),oe=q(W,"Select branch…","No branches");return a.jsxs("div",{className:i.container,children:[a.jsxs("div",{className:"mb-4 flex flex-wrap items-end justify-between gap-3",children:[a.jsxs("h1",{className:i.h1,children:["Group #",e,r!=null&&r.name?a.jsxs("span",{className:`ml-2 ${i.h1Muted}`,children:["• ",r.name]}):null]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:()=>$(),className:i.btn,children:"Refresh"}),v?a.jsxs(a.Fragment,{children:[a.jsx("button",{disabled:P,onClick:ee,className:i.primary,children:P?"Saving…":"Save Changes"}),a.jsx("button",{onClick:()=>{F(!1),y({name:(r==null?void 0:r.name)||"",branchId:(r==null?void 0:r.branchId)||"",loanOfficerId:(r==null?void 0:r.loanOfficerId)||"",meetingDay:(r==null?void 0:r.meetingDay)||"",status:(r==null?void 0:r.status)||"active"})},className:i.btn,children:"Cancel"})]}):a.jsx("button",{onClick:()=>F(!0),className:i.primary,children:"Edit"})]})]}),l&&a.jsx("div",{className:`${i.card} px-4 py-3`,children:"Loading…"}),x&&a.jsx("div",{className:"rounded-2xl border-2 px-4 py-3",style:{borderColor:"var(--danger-border)",background:"var(--danger-bg)",color:"var(--danger-fg)"},children:x}),!l&&!x&&a.jsxs("div",{className:"grid grid-cols-1 gap-5 lg:grid-cols-3",children:[a.jsxs("section",{className:`${i.card} p-4`,children:[a.jsx("h3",{className:"mb-3 text-lg font-semibold",children:v?"Edit Group":"Overview"}),v?a.jsxs("div",{className:"grid gap-3",children:[a.jsx(C,{label:"Name",children:a.jsx("input",{className:i.input,value:b.name,onChange:s=>y({...b,name:s.target.value})})}),a.jsx(C,{label:"Branch",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("select",{className:i.input,value:b.branchId,onChange:s=>y({...b,branchId:s.target.value}),children:[a.jsx("option",{value:"",children:oe}),D.map(s=>a.jsxs("option",{value:s.id,children:[s.name," (",s.id,")"]},s.id))]}),W==="error"&&a.jsx("button",{type:"button",className:i.btn,onClick:()=>X(s=>s+1),children:"Retry"})]})}),a.jsx(C,{label:"Loan Officer",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("select",{className:i.input,value:b.loanOfficerId,onChange:s=>y({...b,loanOfficerId:s.target.value}),children:[a.jsx("option",{value:"",children:te}),_.map(s=>a.jsx("option",{value:s.id,children:s.name},s.id))]}),H==="error"&&a.jsx("button",{type:"button",className:i.btn,onClick:()=>Z(s=>s+1),children:"Retry"})]})}),a.jsx(C,{label:"Meeting Day",children:a.jsx("select",{className:i.input,value:b.meetingDay,onChange:s=>y({...b,meetingDay:s.target.value}),children:ye.map(s=>a.jsx("option",{value:s,children:s||"—"},s||"_"))})}),a.jsx(C,{label:"Status",children:a.jsx("select",{className:i.input,value:b.status,onChange:s=>y({...b,status:s.target.value}),children:je.map(s=>a.jsx("option",{value:s.value,children:s.label},s.value))})})]}):a.jsxs("ul",{className:"space-y-1 text-[15px]",children:[a.jsxs("li",{children:[a.jsx("b",{children:"Name:"})," ",(r==null?void 0:r.name)??"—"]}),a.jsxs("li",{children:[a.jsx("b",{children:"Branch:"})," ",(r==null?void 0:r.branchName)??"—"]}),a.jsxs("li",{children:[a.jsx("b",{children:"Officer:"})," ",(r==null?void 0:r.officerName)??"—"]}),a.jsxs("li",{children:[a.jsx("b",{children:"Meeting Day:"})," ",(r==null?void 0:r.meetingDay)||"—"]}),a.jsxs("li",{children:[a.jsx("b",{children:"Status:"})," ",(r==null?void 0:r.status)||"active"]})]})]}),a.jsxs("section",{className:`${i.card} p-4 lg:col-span-2`,children:[a.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"Members"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("label",{className:i.btn,children:["Import CSV",a.jsx("input",{ref:T,type:"file",accept:".csv,text/csv",className:"hidden",onChange:se})]}),a.jsx("button",{className:i.btn,onClick:ne,children:"Export CSV"})]})]}),a.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[a.jsx("div",{className:"flex-1",children:a.jsx(de,{value:N,onChange:(s,f)=>V(f),placeholder:"Add borrower…"})}),a.jsx("button",{onClick:re,disabled:!N||z,className:i.primary,children:z?"Adding…":"Add"})]}),a.jsx("div",{className:i.tableWrap,children:a.jsxs("table",{className:"min-w-full table-auto",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{className:i.th,children:"Borrower"}),a.jsx("th",{className:i.th,children:"Phone"}),a.jsx("th",{className:i.th,children:"Role"}),a.jsx("th",{className:i.th,children:"Actions"})]})}),a.jsx("tbody",{children:(Array.isArray(M)?M:[]).length===0?a.jsx("tr",{children:a.jsx("td",{className:i.td,colSpan:4,children:a.jsx("span",{className:i.muted,children:"No members yet."})})}):M.map(s=>a.jsxs("tr",{children:[a.jsx("td",{className:i.td,children:a.jsx(ce,{to:`/borrowers/${encodeURIComponent(s.id)}`,className:"font-semibold underline decoration-2 underline-offset-2 hover:opacity-90 text-[var(--fg)]",children:s.name})}),a.jsx("td",{className:i.td,children:s.phone||"—"}),a.jsx("td",{className:i.td,children:s.role?a.jsx("span",{className:i.chip,children:String(s.role).toUpperCase()}):"—"}),a.jsx("td",{className:i.td,children:a.jsx("button",{className:i.btn,onClick:()=>ae(s.id),children:"Remove"})})]},s.id))})]})})]})]})]})}function C({label:e,children:t}){return a.jsxs("div",{className:"min-w-0",children:[a.jsx("div",{className:i.label,children:e}),a.jsx("div",{className:"min-w-0",children:t})]})}export{we as default};

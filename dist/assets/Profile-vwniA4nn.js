import{u as Z,r as i,j as e,b as h}from"./index-Y30r8o2M.js";const M=()=>{var r;try{const t=((r=Intl.supportedValuesOf)==null?void 0:r.call(Intl,"timeZone"))||[];return t.length?t:[Intl.DateTimeFormat().resolvedOptions().timeZone]}catch{return[Intl.DateTimeFormat().resolvedOptions().timeZone]}},R=()=>{try{const r=localStorage.getItem("tenant");if(r)return JSON.parse(r);const t=localStorage.getItem("tenantId"),l=localStorage.getItem("tenantName");if(t||l)return{id:t||null,name:l||""}}catch{}return null},G=r=>{try{r&&(localStorage.setItem("tenant",JSON.stringify(r)),r.id&&localStorage.setItem("tenantId",String(r.id)),r.name&&localStorage.setItem("tenantName",r.name))}catch{}},E=()=>{const r=R();return r!=null&&r.id?h.defaults.headers.common["x-tenant-id"]=r.id:delete h.defaults.headers.common["x-tenant-id"],r};async function q(){const r=["/account/profile","/auth/me","/users/me","/me"];for(const t of r)try{const{data:l}=await h.get(t);return l}catch{}throw new Error("No profile endpoint available")}async function H(r){const t=async(l,c)=>{try{return await h[l](c,r)}catch{}};return await t("patch","/account/profile")||await t("put","/account/profile")||await t("patch","/users/me")||await t("put","/users/me")||await t("patch","/auth/me")||await t("put","/auth/me")||await t("post","/profile")}async function K(r){const t=new FormData;t.append("avatar",r);const l=["/account/profile/avatar","/users/me/avatar","/auth/me/avatar","/profile/avatar"];for(const c of l)try{const{data:b}=await h.post(c,t,{headers:{"Content-Type":"multipart/form-data"}});return b}catch{}throw new Error("Avatar upload failed")}async function V(){const r=["/tenants","/auth/tenants","/account/tenants"];for(const t of r)try{const{data:l}=await h.get(t),c=Array.isArray(l)?l:l==null?void 0:l.data;if(Array.isArray(c))return c;if(Array.isArray(l==null?void 0:l.tenants))return l.tenants}catch{}return[]}function Q(){const r=Z(),[t,l]=i.useState(()=>E()),[c,b]=i.useState([]),[B,y]=i.useState(!0),[f,N]=i.useState(!1),[j,v]=i.useState(""),[k,p]=i.useState(""),[T,F]=i.useState([]),[S,I]=i.useState(null),[C,A]=i.useState(""),[n,w]=i.useState({displayName:"",name:"",email:"",phone:"",defaultBranchId:"",timezone:"",locale:"",avatarUrl:""}),O=i.useMemo(M,[]),P=(n.displayName||n.name||n.email||"U").charAt(0).toUpperCase(),x=(a,d)=>w(s=>({...s,[a]:d})),U=async()=>{var a,d,s;y(!0),p(""),v("");try{const u=await V();b(u);const o=await q(),g={displayName:o.displayName||o.fullName||o.name||"",name:o.name||o.fullName||"",email:o.email||"",phone:o.phone||o.phoneNumber||"",defaultBranchId:String(o.defaultBranchId??o.branchId??"")||"",timezone:o.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,locale:o.locale||navigator.language||"en-US",avatarUrl:o.avatarUrl||o.photoUrl||""};w(g),A(g.avatarUrl||"");try{const m=await h.get("/branches"),J=Array.isArray(m.data)?m.data:((a=m.data)==null?void 0:a.data)||[];F(J)}catch{}}catch(u){p(((s=(d=u==null?void 0:u.response)==null?void 0:d.data)==null?void 0:s.message)||u.message||"Failed to load profile")}finally{y(!1)}};i.useEffect(()=>{U()},[t==null?void 0:t.id]),i.useEffect(()=>{const a=d=>l(d.detail||E());return window.addEventListener("ms:tenant-changed",a),()=>window.removeEventListener("ms:tenant-changed",a)},[]);const z=a=>{var s;const d=(s=a.target.files)==null?void 0:s[0];if(d){if(d.size>2*1024*1024){p("Avatar must be 2MB or smaller.");return}p(""),I(d),A(URL.createObjectURL(d))}},L=async()=>{var a,d;N(!0),p(""),v("");try{let s=n.avatarUrl;if(S){const m=await K(S);s=(m==null?void 0:m.avatarUrl)||(m==null?void 0:m.url)||s}const u={displayName:n.displayName,name:n.name,phone:n.phone,defaultBranchId:n.defaultBranchId||null,timezone:n.timezone,locale:n.locale,avatarUrl:s},{data:o}=await H(u),g={...JSON.parse(localStorage.getItem("user")||"{}"),...u,email:n.email};localStorage.setItem("user",JSON.stringify(g)),window.dispatchEvent(new CustomEvent("ms:profile-updated",{detail:g})),n.defaultBranchId&&(localStorage.setItem("activeBranchId",String(n.defaultBranchId)),window.dispatchEvent(new CustomEvent("ms:branch-changed",{detail:{id:String(n.defaultBranchId)}}))),v((o==null?void 0:o.message)||"Profile saved."),I(null),s&&x("avatarUrl",s)}catch(s){p(((d=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:d.message)||s.message||"Failed to save profile")}finally{N(!1)}},D=async a=>{const d=c.find(s=>String(s.id)===String(a))||{id:a,name:a};G(d),h.defaults.headers.common["x-tenant-id"]=d.id,l(d),window.dispatchEvent(new CustomEvent("ms:tenant-changed",{detail:d})),localStorage.removeItem("activeBranchId"),w(s=>({...s,defaultBranchId:""}))};return B?e.jsx("div",{className:"p-4 text-sm text-slate-500 dark:text-slate-400",children:"Loading…"}):e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[1fr_320px]",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:"Profile"}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:"Update your personal info and preferences."})]}),(t==null?void 0:t.name)&&e.jsx("span",{className:"px-2 py-0.5 text-[11px] rounded-full border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800",children:t.name})]}),j&&e.jsx("div",{className:"mt-3 text-sm text-emerald-600 dark:text-emerald-400",children:j}),k&&e.jsx("div",{className:"mt-3 text-sm text-rose-600 dark:text-rose-400",children:k}),Array.isArray(c)&&c.length>1&&e.jsxs("div",{className:"mt-4 p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/40",children:[e.jsx("label",{className:"text-xs text-slate-600 dark:text-slate-300",children:"Organization"}),e.jsx("select",{className:"mt-1 w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:String((t==null?void 0:t.id)||""),onChange:a=>D(a.target.value),children:c.map(a=>e.jsx("option",{value:a.id,children:a.name||a.id},a.id))}),e.jsx("div",{className:"text-[11px] text-slate-500 mt-1",children:"Switch organization. Data below will reload."})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm",children:[e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Display name"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.displayName,onChange:a=>x("displayName",a.target.value),placeholder:"Shown in the app"})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Full name"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.name,onChange:a=>x("name",a.target.value),placeholder:"Legal / full name"})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Email"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300",value:n.email,disabled:!0,readOnly:!0}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"Email is managed by your admin."})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Phone"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.phone,onChange:a=>x("phone",a.target.value),placeholder:"+2547…"})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Default branch"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.defaultBranchId,onChange:a=>x("defaultBranchId",a.target.value),children:[e.jsx("option",{value:"",children:"—"}),T.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"Used for filtering & quick actions."})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Time zone"}),e.jsx("select",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.timezone,onChange:a=>x("timezone",a.target.value),children:O.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("label",{children:[e.jsx("div",{className:"mb-1 text-slate-700 dark:text-slate-300",children:"Locale"}),e.jsx("input",{className:"w-full border rounded px-3 py-2 bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",value:n.locale,onChange:a=>x("locale",a.target.value),placeholder:"e.g. en-US, sw-KE"})]}),e.jsx("div",{className:"sm:col-span-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:L,disabled:f,className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:f?"Saving…":"Save Changes"}),e.jsx("button",{onClick:U,disabled:f,className:"px-3 py-2 rounded border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:"Refresh"}),e.jsx("button",{onClick:()=>r("/change-password"),className:"px-3 py-2 rounded border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:"Change Password"}),e.jsx("button",{onClick:()=>r("/2fa"),className:"px-3 py-2 rounded border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:"Two-Factor"})]})})]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 h-fit",children:[e.jsx("div",{className:"text-sm font-medium text-slate-900 dark:text-slate-100",children:"Avatar"}),e.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[C?e.jsx("img",{src:C,alt:"Avatar preview",className:"w-16 h-16 rounded-full object-cover border border-slate-200 dark:border-slate-700"}):e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-lg font-bold",children:P}),e.jsxs("div",{children:[e.jsxs("label",{className:"inline-block px-3 py-2 rounded border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer",children:[e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:z}),"Choose image"]}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"PNG/JPG up to 2MB."})]})]})]})]})}export{Q as default};

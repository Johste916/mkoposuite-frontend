import{r as c,j as e,a as E}from"./index-S3kNQbO-.js";import{E as J}from"./jspdf.es.min-BLDCQ6Cb.js";import K from"./html2canvas.esm-CBrSDip1.js";const i=p=>Number(p||0).toLocaleString();function te(){var Z,B,F;const[p,L]=c.useState(""),[g,P]=c.useState(()=>new Date(new Date().setDate(new Date().getDate()-30)).toISOString().slice(0,10)),[u,T]=c.useState(()=>new Date().toISOString().slice(0,10)),[y,H]=c.useState([]),[S,U]=c.useState(0),[j,N]=c.useState(1),[f,A]=c.useState(20),[w,I]=c.useState(!1),[W,R]=c.useState(!1),[t,_]=c.useState(null),C=c.useRef(null),k=c.useMemo(()=>Math.max(1,Math.ceil(S/f)),[S,f]),v=async()=>{I(!0);try{const s={page:j,pageSize:f};p.trim()&&(s.q=p.trim()),g&&(s.dateFrom=g),u&&(s.dateTo=u);const{data:a}=await E.get("/api/repayments",{params:s});H((a==null?void 0:a.items)||[]),U(Number((a==null?void 0:a.total)||0))}catch(s){console.error(s),alert("Failed to load receipts")}finally{I(!1)}};c.useEffect(()=>{v()},[j,f,g,u]);const G=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),N(1),v()},V=async s=>{try{const{data:a}=await E.get(`/api/repayments/${s.id}`);_(a||null),R(!0)}catch(a){console.error(a),alert("Failed to load receipt")}},q=()=>{if(!y.length)return alert("Nothing to export");const a=[["Receipt No","Date","Loan Ref","Borrower","Method","Amount","Reference"].join(","),...y.map(r=>{var d,m,x,b;return[r.receiptNo||`RCPT-${r.id}`,r.date,((d=r.Loan)==null?void 0:d.reference)||`L-${((m=r.Loan)==null?void 0:m.id)||""}`,`"${(((b=(x=r.Loan)==null?void 0:x.Borrower)==null?void 0:b.fullName)||"").replace(/"/g,'""')}"`,r.method||"cash",r.amount,r.reference||""].join(",")})].join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),h=URL.createObjectURL(n),l=document.createElement("a");l.href=h,l.download=`repayment-receipts_${g}_to_${u}.csv`,l.click(),URL.revokeObjectURL(h)},Q=async()=>{if(!C.current)return;const s=C.current,a=s.style.backgroundColor;s.style.backgroundColor="#ffffff";const n=await K(s,{scale:2,backgroundColor:"#ffffff",useCORS:!0,windowWidth:s.scrollWidth,windowHeight:s.scrollHeight});s.style.backgroundColor=a||"";const h=n.toDataURL("image/png"),l=new J("p","mm","a4"),r=l.internal.pageSize.getWidth(),d=l.internal.pageSize.getHeight(),m=r,x=n.height*m/n.width;let b=0;if(x<=d)l.addImage(h,"PNG",0,0,m,x);else{let $=x;const D=n.width*d/r,o=document.createElement("canvas"),M=o.getContext("2d");o.width=n.width,o.height=D;let O=0;for(;$>0;){M.clearRect(0,0,o.width,o.height),M.drawImage(n,0,O,n.width,D,0,0,o.width,o.height);const z=o.toDataURL("image/png");b===0||l.addPage(),l.addImage(z,"PNG",0,0,m,d),O+=D,$-=d,b+=d}}const Y=`receipt_${(t==null?void 0:t.receiptNo)||(t==null?void 0:t.id)}.pdf`;l.save(Y)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Receipts"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Browse, filter, export, and print receipts."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:v,disabled:w,className:"px-3 py-2 rounded border",children:w?"Refreshing…":"Refresh"}),e.jsx("button",{onClick:q,className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Export CSV"})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5",children:e.jsxs("form",{onSubmit:G,className:"grid md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Search"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Borrower / Loan Ref / Receipt",value:p,onChange:s=>L(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"From"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:g,onChange:s=>P(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"To"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:u,onChange:s=>T(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Page size"}),e.jsx("select",{className:"w-full border rounded px-3 py-2",value:f,onChange:s=>{A(Number(s.target.value)),N(1)},children:[20,50,100].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"md:col-span-2 flex items-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border",onClick:()=>{L(""),P(new Date(new Date().setDate(new Date().getDate()-30)).toISOString().slice(0,10)),T(new Date().toISOString().slice(0,10)),N(1),v()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Search"})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-0 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Receipt No"}),e.jsx("th",{className:"p-3",children:"Date"}),e.jsx("th",{className:"p-3",children:"Loan Ref"}),e.jsx("th",{className:"p-3",children:"Borrower"}),e.jsx("th",{className:"p-3",children:"Method"}),e.jsx("th",{className:"p-3",children:"Amount"}),e.jsx("th",{className:"p-3 text-right",children:"Action"})]})}),e.jsxs("tbody",{children:[!w&&y.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-gray-500",colSpan:7,children:"No data."})}),y.map(s=>{var a,n,h,l;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.receiptNo||`RCPT-${s.id}`}),e.jsx("td",{className:"p-3",children:s.date}),e.jsx("td",{className:"p-3",children:((a=s.Loan)==null?void 0:a.reference)||`L-${((n=s.Loan)==null?void 0:n.id)||""}`}),e.jsx("td",{className:"p-3",children:((l=(h=s.Loan)==null?void 0:h.Borrower)==null?void 0:l.fullName)||"—"}),e.jsx("td",{className:"p-3 capitalize",children:s.method||"cash"}),e.jsxs("td",{className:"p-3",children:[s.currency||"TZS"," ",i(s.amount)]}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>V(s),children:"View"})})]},s.id)}),w&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:7,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 border-t",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Page ",j," of ",k," • ",S," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:j<=1,onClick:()=>N(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:j>=k,onClick:()=>N(s=>Math.min(k,s+1)),children:"Next"})]})]})]}),W&&t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>R(!1)}),e.jsxs("div",{ref:C,className:"relative bg-white w-full max-w-2xl rounded-lg shadow-lg p-6 print:bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Receipt #",t.receiptNo||t.id]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>window.print(),children:"Print"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:Q,children:"Download PDF"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white",onClick:()=>R(!1),children:"Close"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"})," ",t.date]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Method:"})," ",t.method||"cash"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Reference:"})," ",t.reference||"—"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Notes:"})," ",t.notes||"—"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-gray-500",children:"Amount"}),e.jsxs("p",{className:"text-xl font-semibold",children:[t.currency||"TZS"," ",i(t.amount)]})]})]}),e.jsxs("div",{className:"my-4 border-t pt-4 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Loan:"})," ",(Z=t.loan)==null?void 0:Z.reference]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Borrower:"})," ",(B=t.loan)==null?void 0:B.borrowerName]})]}),!!((F=t.allocation)!=null&&F.length)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 text-left",children:[e.jsx("th",{className:"p-2",children:"Period"}),e.jsx("th",{className:"p-2",children:"Principal"}),e.jsx("th",{className:"p-2",children:"Interest"}),e.jsx("th",{className:"p-2",children:"Fees"}),e.jsx("th",{className:"p-2",children:"Penalties"})]})}),e.jsx("tbody",{children:t.allocation.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.penalties)]})]},a))}),t.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t font-medium",children:[e.jsx("td",{className:"p-2",children:"Totals"}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.penalties)]})]})})]})})]})]})]})]})}export{te as default};

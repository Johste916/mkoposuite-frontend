import{r as o,j as t,y as $,h as b}from"./index-p3hQqlDS.js";const n={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",card:"rounded-2xl border-2 border-slate-300 bg-white shadow",th:"bg-slate-50 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-b border-slate-200",td:"px-3 py-2 border-b border-slate-200 text-sm",btn:"inline-flex items-center rounded-lg border-2 border-slate-300 px-3 py-2 hover:bg-slate-50 font-semibold"};function L(){const[j,f]=o.useState(!1),[k,u]=o.useState(!1),[d,w]=o.useState([]),[c,N]=o.useState([]),[g,m]=o.useState({}),[h,v]=o.useState(""),y=async()=>{var s,a;f(!0);try{const{data:e}=await b.get("/permissions/matrix");w(Array.isArray(e==null?void 0:e.catalog)?e.catalog:[]),N(Array.isArray(e==null?void 0:e.roles)?e.roles:[]),m(typeof(e==null?void 0:e.matrix)=="object"&&(e!=null&&e.matrix)?e.matrix:{})}catch(e){console.error(e),alert(((a=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:a.error)||"Failed to load permission matrix")}finally{f(!1)}};o.useEffect(()=>{y()},[]),o.useMemo(()=>c.map(s=>s.name),[c]);const p=o.useMemo(()=>{const s=h.trim().toLowerCase();return s?d.map(a=>({...a,actions:a.actions.filter(e=>e.key.toLowerCase().includes(s)||e.label.toLowerCase().includes(s))})).filter(a=>a.actions.length):d},[d,h]),S=(s,a)=>{m(e=>{const l=new Set(e[s]||[]);return l.has(a)?l.delete(a):l.add(a),{...e,[s]:Array.from(l)}})},C=(s,a)=>{m(e=>{const l={...e};for(const r of p)for(const i of r.actions){const x=new Set(l[i.key]||[]);a?x.add(s):x.delete(s),l[i.key]=Array.from(x)}return l})},A=async s=>{var e,l;const a=[];for(const r of d)for(const i of r.actions)new Set(g[i.key]||[]).has(s.name)&&a.push(i.key);u(!0);try{await b.put(`/permissions/role/${s.id}`,{actions:a,mode:"replace"}),alert(`Saved permissions for role: ${s.name}`)}catch(r){console.error(r),alert(((l=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:l.error)||"Failed to save")}finally{u(!1)}};return t.jsxs("div",{className:n.page,children:[t.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4",children:[t.jsx("h1",{className:n.h1,children:"Permission Matrix"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:h,onChange:s=>v(s.target.value),placeholder:"Filter actions…",className:"h-10 w-64 rounded-lg border-2 border-slate-300 bg-white text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600"}),t.jsx("button",{onClick:y,className:n.btn,children:"Refresh"})]})]}),t.jsx("div",{className:`${n.card} overflow-auto`,children:t.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[t.jsx("thead",{className:"sticky top-0 z-10",children:t.jsxs("tr",{children:[t.jsx("th",{className:n.th,style:{position:"sticky",left:0,zIndex:11,background:"white"},children:"Feature / Action"}),c.map(s=>t.jsx("th",{className:`${n.th} text-center`,children:t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[t.jsx("div",{className:"font-bold",children:s.name}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("label",{className:"text-[11px] opacity-70",children:[t.jsx("input",{type:"checkbox",onChange:a=>C(s.name,a.target.checked)})," All"]}),t.jsx("button",{className:"text-[11px] underline",onClick:()=>A(s),disabled:k,title:"Save only this role",children:"Save"})]})]})},s.id))]})}),t.jsx("tbody",{children:j?t.jsx("tr",{children:t.jsx("td",{className:n.td,colSpan:1+c.length,children:"Loading…"})}):p.length===0?t.jsx("tr",{children:t.jsx("td",{className:n.td,colSpan:1+c.length,children:"No actions match your filter."})}):p.map(s=>t.jsxs($.Fragment,{children:[t.jsx("tr",{children:t.jsx("td",{className:`${n.td} font-semibold text-slate-700`,style:{position:"sticky",left:0,zIndex:10,background:"white"},colSpan:1+c.length,children:s.group})}),s.actions.map(a=>t.jsxs("tr",{className:"hover:bg-slate-50",children:[t.jsxs("td",{className:n.td,style:{position:"sticky",left:0,zIndex:9,background:"white"},title:a.key,children:[t.jsx("div",{className:"font-medium",children:a.label}),t.jsx("div",{className:"text-xs opacity-70",children:a.key})]}),c.map(e=>{const r=new Set(g[a.key]||[]).has(e.name);return t.jsx("td",{className:`${n.td} text-center`,children:t.jsx("input",{type:"checkbox",checked:r,onChange:()=>S(a.key,e.name)})},`${a.key}:${e.id}`)})]},a.key))]},s.group))})]})}),t.jsx("div",{className:"mt-4 flex items-center gap-2",children:t.jsx("span",{className:"text-sm opacity-80",children:"Tip: use the “All” checkbox under each role to toggle the whole column; then click “Save” for that role."})})]})}export{L as default};

import{r as n,g,j as e,L as Z}from"./index-B-WhzGsb.js";import{F as ue,S as me}from"./search-BmirtnFt.js";import{c as G}from"./createLucideIcon-DlqGWHbL.js";import{X}from"./x-CAQITeGB.js";import{C as pe,a as ve}from"./chevron-right-DL0WE8mH.js";import{C as xe}from"./chevron-down-CmI2iXb2.js";/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],be=G("check",ge);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]],fe=G("corner-up-left",he);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],q=G("loader-circle",je),$=10,Ne=[{value:"submitted",label:"Submitted (New)"},{value:"manager_review",label:"Manager Review"},{value:"compliance_review",label:"Compliance Review"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"returned_with_comment",label:"Returned with Comment"}],Y=(o,r="TZS")=>`‎${r} ${Number(o||0).toLocaleString()}`,we=o=>o?new Date(o).toLocaleDateString():"—",s={wrap:"w-full px-4 md:px-6 lg:px-8 py-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-[var(--muted)]",card:"rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",btn:"inline-flex items-center justify-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 bg-[var(--card)] hover:bg-[var(--kpi-bg)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",btnIcon:"w-4 h-4",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide text-[var(--muted)] font-semibold px-3 py-2 border border-[var(--border)] select-none",td:"px-3 py-2 border border-[var(--border)] text-sm",chip:"px-2 py-0.5 text-[11px] rounded-full border",fieldBase:"h-11 w-full rounded-lg border-2 text-sm outline-none px-3 bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)] placeholder:text-[var(--input-placeholder)] focus:ring-2 focus:ring-[var(--ring)]",fieldIcon:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--muted)]"},ye=o=>{const r=(o||"").toLowerCase();return r==="approved"?{background:"var(--success, #22c55e)",color:"var(--on-success, #06230f)",borderColor:"var(--success-border, #16a34a)"}:r==="rejected"?{background:"var(--danger, #ef4444)",color:"var(--on-danger, #2b0a0a)",borderColor:"var(--danger-border, #dc2626)"}:r==="returned_with_comment"?{background:"var(--warn, #f59e0b)",color:"var(--on-warn, #231803)",borderColor:"var(--warn-border, #d97706)"}:{background:"var(--chip-soft)",color:"var(--fg)",borderColor:"var(--border)"}},I=({className:o="",children:r,...l})=>e.jsxs("div",{className:`relative ${o}`,children:[e.jsx("select",{...l,className:`${s.fieldBase} pr-9 appearance-none bg-none ms-select`,style:{backgroundImage:"none"},children:r}),e.jsx(xe,{className:"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--muted)]"})]}),Se=({className:o="",leadingIcon:r=null,...l})=>e.jsxs("div",{className:`relative ${o}`,children:[r,e.jsx("input",{...l,className:`${s.fieldBase} ${r?"pl-10":""}`})]});function Be(){const[o,r]=n.useState([]),[l,u]=n.useState(0),[f,j]=n.useState([]),[M,F]=n.useState([]),[A,T]=n.useState([]),[N,L]=n.useState(""),[R,E]=n.useState(""),[v,w]=n.useState("manager_review"),[y,W]=n.useState(""),[O,H]=n.useState(""),[D,J]=n.useState(""),[p,ee]=n.useState("createdAt"),[x,U]=n.useState("desc"),[b,m]=n.useState(1),[ae,V]=n.useState(!0),[te,k]=n.useState(!1),[K,B]=n.useState(null),z=n.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},[]),c=((z==null?void 0:z.role)||"").toLowerCase();n.useEffect(()=>{c==="compliance"?w("compliance_review"):c==="branch_manager"&&w("manager_review")},[c]),n.useEffect(()=>{const a=setTimeout(()=>E(N.trim()),300);return()=>clearTimeout(a)},[N]),n.useEffect(()=>{(async()=>{try{const[a,t,i]=await Promise.all([g.get("/loan-products").catch(()=>({data:[]})),g.get("/branches").catch(()=>({data:[]})),g.get("/users",{params:{role:"loan_officer"}}).catch(()=>({data:[]}))]);j(Array.isArray(a.data)?a.data:a.data.items||[]),F(Array.isArray(t.data)?t.data:t.data.items||[]),T(Array.isArray(i.data)?i.data:i.data.items||[])}catch{}})()},[]),n.useEffect(()=>{const a=new AbortController;return(async()=>{var t,i;V(!0);try{const d=await g.get("/loans",{signal:a.signal,params:{q:R||void 0,stage:v||void 0,status:v==="approved"||v==="rejected"?v:void 0,productId:y||void 0,branchId:O||void 0,officerId:D||void 0,page:b,pageSize:$,sort:p,dir:x}}),h=((t=d.data)==null?void 0:t.items)||(Array.isArray(d.data)?d.data:[]);r(h),u(((i=d.data)==null?void 0:i.total)??h.length??0)}catch{r([]),u(0)}finally{V(!1)}})(),()=>a.abort()},[R,v,y,O,D,b,p,x]);const re=a=>c==="branch_manager"?"compliance_review":c==="compliance"||c==="admin"||c==="director"?"approved":a==="manager_review"?"compliance_review":"approved",P=a=>{const t=(a.stage||a.status||"").toLowerCase();return c==="branch_manager"?t==="manager_review"||t==="submitted"||!t:c==="compliance"?t==="compliance_review":c==="admin"||c==="director"?t==="manager_review"||t==="compliance_review"||t==="submitted":!1},Q=async(a,t)=>{try{return await g.patch(`/loans/${a}/stage`,t),!0}catch{try{if(t.action==="approve"){const d=t.nextStage==="approved";await g.patch(`/loans/${a}/status`,{status:d?"approved":"pending"})}else t.action==="reject"?await g.patch(`/loans/${a}/status`,{status:"rejected"}):t.action==="return"&&await g.patch(`/loans/${a}/status`,{status:"pending"});return t.comment&&await g.post("/comments",{loanId:a,content:t.comment}),!0}catch{return!1}}},se=async(a,t)=>{if(!P(a))return;k(!0);const i={action:"approve",fromStage:a.stage||a.status||"submitted",nextStage:re(a.stage),suggestedAmount:t||void 0},d=await Q(a.id,i);if(k(!1),!d)return alert("Failed to approve.");m(1),r(h=>h.filter(_=>_.id!==a.id))},ne=async(a,t)=>{if(!P(a))return;if(!(t!=null&&t.trim()))return alert("Please enter a short reason.");k(!0);const i={action:"reject",fromStage:a.stage||a.status||"submitted",nextStage:"rejected",comment:t},d=await Q(a.id,i);if(k(!1),!d)return alert("Failed to reject.");m(1),r(h=>h.filter(_=>_.id!==a.id))},oe=async(a,t,i)=>{if(!P(a))return;if(!(t!=null&&t.trim()))return alert("Please enter a comment.");k(!0);const d={action:"return",fromStage:a.stage||a.status||"submitted",nextStage:"returned_with_comment",comment:t,suggestedAmount:i||void 0},h=await Q(a.id,d);if(k(!1),!h)return alert("Failed to return with comment.");m(1),r(_=>_.filter(de=>de.id!==a.id))},S=a=>{p===a?U(t=>t==="asc"?"desc":"asc"):(ee(a),U("asc"))},ce=n.useMemo(()=>l===0?0:(b-1)*$+1,[b,l]),ie=n.useMemo(()=>Math.min(b*$,l),[b,l]),le=()=>{L(""),w(c==="compliance"?"compliance_review":c==="branch_manager"?"manager_review":"submitted"),W(""),H(""),J(""),m(1)};return e.jsxs("div",{className:s.wrap,children:[e.jsx("style",{children:`
        select.ms-select {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: none !important;
        }
        select.ms-select::-ms-expand { display: none; }
      `}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:s.h1,children:"Loan Review Queue"}),e.jsx("p",{className:s.sub,children:c==="branch_manager"?"Approve/return applications to Compliance.":c==="compliance"?"Compliance checks for policy/legal, then approve or return.":"Review and route loan applications by stage."})]}),e.jsx(Z,{to:"/loans",className:s.btn,title:"Back to Loans",children:"Back to Loans"})]}),e.jsxs("div",{className:`${s.card} p-4 mb-5`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 text-[var(--muted)] font-semibold",children:[e.jsx(ue,{className:"w-4 h-4"})," Filters"]}),e.jsx("button",{onClick:le,className:"text-sm underline decoration-[var(--border)] hover:decoration-[var(--fg)]",children:"Clear all"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3",children:[e.jsx(Se,{value:N,onChange:a=>{L(a.target.value),m(1)},placeholder:"Search borrower, phone, product, loan #",leadingIcon:e.jsx(me,{className:s.fieldIcon}),className:"xl:col-span-2"}),e.jsx(I,{value:v,onChange:a=>{w(a.target.value),m(1)},"aria-label":"Stage",children:Ne.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsxs(I,{value:y,onChange:a=>{W(a.target.value),m(1)},"aria-label":"Product",children:[e.jsx("option",{value:"",children:"All Products"}),f.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(I,{value:O,onChange:a=>{H(a.target.value),m(1)},"aria-label":"Branch",children:[e.jsx("option",{value:"",children:"All Branches"}),M.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsxs(I,{value:D,onChange:a=>{J(a.target.value),m(1)},"aria-label":"Officer",children:[e.jsx("option",{value:"",children:"All Officers"}),A.map(a=>e.jsx("option",{value:a.id,children:a.name||a.email},a.id))]})]})]})]}),e.jsxs("div",{className:s.card,children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(C,{label:"Submitted",sortKey:"createdAt",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Borrower",sortKey:"borrowerName",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Product",sortKey:"productName",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Principal",sortKey:"amount",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Officer",sortKey:"officerName",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Branch",sortKey:"branchName",sort:p,dir:x,onSort:S}),e.jsx(C,{label:"Stage",sortKey:"stage",sort:p,dir:x,onSort:S}),e.jsx("th",{className:`${s.th} text-right`,children:"Actions"})]})}),e.jsx("tbody",{children:ae?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:`${s.td} text-center py-10 text-[var(--muted)]`,children:"Loading…"})}):o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:`${s.td} text-center py-10 text-[var(--muted)]`,children:"No applications found."})}):o.map(a=>{var t,i;return e.jsxs("tr",{className:"hover:bg-[var(--kpi-bg)]",children:[e.jsx("td",{className:s.td,children:we(a.createdAt)}),e.jsxs("td",{className:s.td,children:[e.jsx(Z,{to:`/borrowers/${a.borrowerId}`,className:"underline decoration-2 underline-offset-2 text-[var(--fg)] hover:opacity-90",children:((t=a.Borrower)==null?void 0:t.name)||a.borrowerName||"—"}),e.jsx("div",{className:"text-xs text-[var(--muted)]",children:a.loanNumber?`Loan #${a.loanNumber}`:""})]}),e.jsx("td",{className:s.td,children:((i=a.Product)==null?void 0:i.name)||a.productName||"—"}),e.jsx("td",{className:s.td,children:Y(a.amount,a.currency||"TZS")}),e.jsx("td",{className:s.td,children:a.officerName||"—"}),e.jsx("td",{className:s.td,children:a.branchName||"—"}),e.jsx("td",{className:s.td,children:e.jsx("span",{className:s.chip,style:ye(a.stage||a.status),children:(a.stage||a.status||"—").replaceAll("_"," ")})}),e.jsx("td",{className:`${s.td} text-right`,children:e.jsxs("div",{className:"inline-flex gap-1",children:[e.jsx(Z,{to:`/loans/${a.id}`,className:s.btn+" text-xs px-2 py-1",children:"View"}),P(a)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:`px-2 py-1 text-xs rounded border-2 inline-flex items-center gap-1
                                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,style:{background:"var(--success, #22c55e)",color:"var(--on-success, var(--primary-contrast))",borderColor:"var(--success-strong, var(--success-border, #16a34a))"},onClick:()=>B({type:"approve",row:a}),children:[e.jsx(be,{className:"w-3.5 h-3.5"})," Approve"]}),e.jsxs("button",{className:`px-2 py-1 text-xs rounded border-2 inline-flex items-center gap-1
                                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,style:{background:"var(--warn, #f59e0b)",color:"var(--on-warn, var(--primary-contrast))",borderColor:"var(--warn-strong, var(--warn-border, #d97706))"},onClick:()=>B({type:"return",row:a}),children:[e.jsx(fe,{className:"w-3.5 h-3.5"})," Return"]}),e.jsxs("button",{className:`px-2 py-1 text-xs rounded border-2 inline-flex items-center gap-1
                                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,style:{background:"var(--danger, #ef4444)",color:"var(--on-danger, var(--primary-contrast))",borderColor:"var(--danger-strong, var(--danger-border, #dc2626))"},onClick:()=>B({type:"reject",row:a}),children:[e.jsx(X,{className:"w-3.5 h-3.5"})," Reject"]})]})]})})]},a.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-t-2 border-[var(--border-strong)] text-sm",children:[e.jsxs("div",{className:"text-[var(--muted)]",children:[ce,"–",ie," of ",l]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>m(a=>Math.max(1,a-1)),disabled:b===1,className:`p-1 border-2 border-[var(--border-strong)] bg-[var(--card)] rounded disabled:opacity-50
                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,title:"Previous page",children:e.jsx(pe,{className:s.btnIcon})}),e.jsx("button",{onClick:()=>m(a=>a*$<l?a+1:a),disabled:b*$>=l,className:`p-1 border-2 border-[var(--border-strong)] bg-[var(--card)] rounded disabled:opacity-50
                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,title:"Next page",children:e.jsx(ve,{className:s.btnIcon})})]})]})]}),K&&e.jsx(Ce,{type:K.type,row:K.row,role:c,busy:te,onClose:()=>B(null),onApprove:se,onReject:ne,onReturn:oe})]})}const C=({label:o,sortKey:r,sort:l,dir:u,onSort:f})=>{const j=l===r;return e.jsx("th",{className:`${s.th} cursor-pointer`,onClick:()=>f(r),title:"Sort","aria-sort":j?u==="asc"?"ascending":"descending":"none",children:e.jsxs("span",{className:`inline-flex items-center gap-1 ${j?"text-[var(--ring)]":""}`,children:[o,j?u==="asc"?"▲":"▼":""]})})};function Ce({type:o,row:r,role:l,busy:u,onClose:f,onApprove:j,onReject:M,onReturn:F}){var v,w;const[A,T]=n.useState(""),[N,L]=n.useState(""),R=o==="approve"?"Approve Application":o==="reject"?"Reject Application":"Return with Comment",E=l==="branch_manager"&&(o==="approve"||o==="return");return e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0",onClick:f,style:{background:"var(--overlay, rgba(0,0,0,.40))"}}),e.jsxs("div",{className:`relative ${s.card} w-[95%] max-w-lg p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"font-semibold text-lg",children:[" ",R," "]}),e.jsx("button",{onClick:f,className:"p-1 rounded hover:bg-[var(--kpi-bg)]",title:"Close",children:e.jsx(X,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--muted)]",children:"Borrower:"})," ",((v=r.Borrower)==null?void 0:v.name)||r.borrowerName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--muted)]",children:"Product:"})," ",((w=r.Product)==null?void 0:w.name)||r.productName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--muted)]",children:"Amount:"})," ",Y(r.amount,r.currency||"TZS")]})]}),E&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted)]",children:"Suggested Amount (optional)"}),e.jsx("input",{type:"number",className:s.fieldBase,placeholder:"e.g. 500000",value:N,onChange:y=>L(y.target.value)}),e.jsx("p",{className:"text-[11px] text-[var(--muted)] mt-1",children:"Branch Manager can suggest a different principal before forwarding to Compliance."})]}),o!=="approve"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted)]",children:"Comment"}),e.jsx("textarea",{className:`${s.fieldBase} min-h-[96px]`,placeholder:o==="reject"?"Reason for rejection…":"What needs to be updated…",value:A,onChange:y=>T(y.target.value)})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:f,className:s.btn,children:"Cancel"}),o==="approve"&&e.jsxs("button",{disabled:u,onClick:()=>j(r,N),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg disabled:opacity-60",style:{background:"var(--success, #22c55e)",color:"var(--on-success, var(--primary-contrast))",border:"2px solid var(--success-strong, var(--success-border, #16a34a))"},children:[u&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Approve"]}),o==="return"&&e.jsxs("button",{disabled:u,onClick:()=>F(r,A,N),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg disabled:opacity-60",style:{background:"var(--warn, #f59e0b)",color:"var(--on-warn, var(--primary-contrast))",border:"2px solid var(--warn-strong, var(--warn-border, #d97706))"},children:[u&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Return"]}),o==="reject"&&e.jsxs("button",{disabled:u,onClick:()=>M(r,A),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg disabled:opacity-60",style:{background:"var(--danger, #ef4444)",color:"var(--on-danger, var(--primary-contrast))",border:"2px solid var(--danger-strong, var(--danger-border, #dc2626))"},children:[u&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Reject"]})]})]})]})}export{Be as default};

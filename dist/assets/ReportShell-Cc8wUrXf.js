import{r as d,h as L,j as s,H as ce,Q as ae,n as ie}from"./index-DFzTBWzb.js";const g=e=>String(e||"").replace(/[_\-]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,c=>c.toUpperCase()),Q=(e,c="TZS")=>`${c} ${Number(e||0).toLocaleString()}`,Y=e=>typeof e=="number"?`${(e>1?e:e*100).toFixed(2)}%`:String(e??""),q=e=>Object.prototype.toString.call(e)==="[object Object]";function F(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function de(e){if(!e||!e.length)return"";const c=Array.from(e.reduce((l,i)=>(Object.keys(i||{}).forEach(u=>l.add(u)),l),new Set)),r=l=>{const i=F(l);return/[,"\n]/.test(i)?`"${i.replace(/"/g,'""')}"`:i};return[c.join(","),...e.map(l=>c.map(i=>r(l[i])).join(","))].join(`
`)}function ue(e){var r;const c=(e==null?void 0:e.columns)||((r=e==null?void 0:e.table)==null?void 0:r.columns);return c&&Array.isArray(c)?c.map(l=>typeof l=="string"?{key:l,label:g(l)}:{key:l.key,label:l.label??g(l.key),currency:!!l.currency,percent:!!l.percent,fmt:l.fmt}):null}function be(e={}){const c=[];for(const[r,l]of Object.entries(e)){const i={metric:g(r),value:l},u=r.toLowerCase();/(amount|total|balance|olp|deferred|accrued|received|disbursed)/.test(u)&&typeof l=="number"&&(i.currency=!0),/(par|ratio|yield|efficiency|achievement)/.test(u)&&typeof l=="number"&&(i.percent=!0),c.push(i)}return{columns:[{key:"metric",label:"Metric"},{key:"value",label:"Value"}],rows:c}}function pe(e=[]){const c=e.map(r=>({metric:(r==null?void 0:r.title)??"—",value:(r==null?void 0:r.value)??0,currency:!!(r!=null&&r.currency),percent:!!(r!=null&&r.percent)}));return{columns:[{key:"metric",label:"Metric"},{key:"value",label:"Value"}],rows:c}}function xe(e,c){var j,v,k,N,O,f;let r=[],l={},i=ue(e)||(Array.isArray(c)?c.slice():[]);const u=((j=e==null?void 0:e.table)==null?void 0:j.period)??(e==null?void 0:e.period),A=((v=e==null?void 0:e.table)==null?void 0:v.scope)??(e==null?void 0:e.scope),I=((k=e==null?void 0:e.table)==null?void 0:k.welcome)??(e==null?void 0:e.welcome),C=((N=e==null?void 0:e.table)==null?void 0:N.asOf)??(e==null?void 0:e.asOf),$=((O=e==null?void 0:e.table)==null?void 0:O.totals)??(e==null?void 0:e.totals);if(l={...e,period:u,scope:A,welcome:I,asOf:C,totals:$},Array.isArray((f=e==null?void 0:e.table)==null?void 0:f.rows))r=e.table.rows;else if(Array.isArray(e==null?void 0:e.cards)){const p=pe(e.cards);r=p.rows,i.length||(i=p.columns)}else if(q(e==null?void 0:e.summary)){const p=be(e.summary);r=p.rows,i.length||(i=p.columns)}else if(Array.isArray(e==null?void 0:e.rows))r=e.rows;else if(Array.isArray(e==null?void 0:e.items))r=e.items;else if(Array.isArray(e==null?void 0:e.buckets))r=e.buckets;else if(e&&typeof e=="object"){const p=new Set(["rows","items","buckets","table","columns","summary","period","scope","welcome","asOf","cards","trends","totals","ratios"]);r=Object.entries(e).filter(([x])=>!p.has(x)).map(([x,S])=>({metric:g(x),value:S})),i.length||(i=[{key:"metric",label:"Metric"},{key:"value",label:"Value",fmt:x=>typeof x=="number"?Q(x):F(x)}])}return!i.length&&(r!=null&&r.length)&&q(r[0])&&(i=Object.keys(r[0]).slice(0,12).map(m=>({key:m,label:g(m)}))),{rows:Array.isArray(r)?r:[],columns:i,meta:l}}function me(e,c){if(c!=null&&c.scope&&String(c.scope).trim())return String(c.scope);const r=[];if(r.push(e.branchId?`Branch #${e.branchId}`:"All branches"),r.push(e.officerId?`Officer #${e.officerId}`:"All officers"),r.push(e.borrowerId?`Borrower #${e.borrowerId}`:"All borrowers"),e.startDate||e.endDate){const l=e.startDate||"…",i=e.endDate||"…";r.push(`${l} → ${i}`)}else r.push("All time");return r.join(" · ")}function he({title:e="Report",endpoint:c,columns:r=[],exportCsvPath:l="",mode:i="auto",filters:u={date:!0,branch:!0,officer:!0,borrower:!0},extraParams:A={},onAfterLoad:I}){const[C,$]=d.useState(!1),[j,v]=d.useState(""),[k,N]=d.useState(null),O=new Date().toISOString().slice(0,10),[f,p]=d.useState(""),[m,x]=d.useState(""),[S,P]=d.useState(""),[T,H]=d.useState(""),[J,W]=d.useState(""),[D,M]=d.useState(""),[w,ee]=d.useState([]),[X,te]=d.useState([]),[G,V]=d.useState([]),E=d.useRef(!0);d.useEffect(()=>()=>{E.current=!1},[]),d.useEffect(()=>{(async()=>{try{const{data:t}=await L.get("/reports/filters");ee((t==null?void 0:t.branches)||[]),te((t==null?void 0:t.officers)||[])}catch{}})()},[]),d.useEffect(()=>{const t=D.trim();if(!t){V([]);return}const a=setTimeout(async()=>{try{const{data:n}=await L.get("/borrowers/search",{params:{q:t}});V(Array.isArray(n)?n.slice(0,8):[])}catch{V([])}},250);return()=>clearTimeout(a)},[D]);const b=d.useMemo(()=>({...A,startDate:u.date&&f||void 0,endDate:u.date&&m||void 0,branchId:u.branch&&S||void 0,officerId:u.officer&&T||void 0,borrowerId:u.borrower&&J||void 0}),[A,f,m,S,T,J,u]),R=async()=>{var t,a;if(c){$(!0),v("");try{const{data:n}=await L.get(c,{params:b});if(!E.current)return;N(n),typeof I=="function"&&I(n)}catch(n){if(!E.current)return;console.error("Report load error:",n),v(((a=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:a.error)||(n==null?void 0:n.message)||"Failed to load report"),N({table:{rows:[]}})}finally{E.current&&$(!1)}}};d.useEffect(()=>{R()},[c]);const{rows:U,columns:Z,meta:o}=d.useMemo(()=>xe(k,r),[k,r]),se=d.useMemo(()=>me(b,o),[b,o]),re=(t,a)=>{const n=a==null?void 0:a[t.key],h=!!t.currency,y=!!t.percent,B=(a==null?void 0:a.currency)&&t.key==="value",_=(a==null?void 0:a.percent)&&t.key==="value";if(t.fmt)return t.fmt(n,a);if((y||_)&&typeof n=="number")return Y(n);if((h||B)&&typeof n=="number"){const z=(a==null?void 0:a.currencyCode)||(a==null?void 0:a.currency)||"TZS";return Q(n,z)}return F(n)},oe=()=>{var h,y;if(l){const B=((y=(h=L).getTenantId)==null?void 0:y.call(h))||"",_=new URLSearchParams({...b.startDate?{startDate:b.startDate}:{},...b.endDate?{endDate:b.endDate}:{},...b.branchId?{branchId:b.branchId}:{},...b.officerId?{officerId:b.officerId}:{},...b.borrowerId?{borrowerId:b.borrowerId}:{},...B?{tenantId:B}:{}}),z="https://mkoposuite-backend-42w2.onrender.com/api".replace(/\/+$/,""),ne=l.startsWith("/")?l:`/${l}`,le=`${z}${ne}?${_.toString()}`;window.open(le,"_blank","noopener,noreferrer");return}const t=de(U),a=new Blob([t],{type:"text/csv"}),n=document.createElement("a");n.href=URL.createObjectURL(a),n.download=`${e.replace(/\s+/g,"_").toLowerCase()}_${new Date().toISOString().slice(0,10)}.csv`,n.click()},K=()=>{p(""),x(""),P(""),H(""),W(""),M("")};return s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-bold",children:e}),s.jsx("div",{className:"text-[12px] text-slate-500",children:se}),(o==null?void 0:o.welcome)&&s.jsx("div",{className:"text-[12px] text-emerald-700 dark:text-emerald-400 mt-1",children:o.welcome}),((o==null?void 0:o.asOf)||(o==null?void 0:o.period))&&s.jsxs("div",{className:"text-[12px] text-slate-500 mt-1",children:[o!=null&&o.asOf?`As Of: ${String(o.asOf).slice(0,10)}`:"",o!=null&&o.asOf&&(o!=null&&o.period)?" · ":"",o!=null&&o.period?`Period: ${o.period}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:R,className:"inline-flex items-center gap-2 h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",title:"Refresh",children:[s.jsx(ce,{className:C?"animate-spin":""}),"Refresh"]}),s.jsxs("button",{onClick:oe,className:"inline-flex items-center gap-2 h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export CSV",children:[s.jsx(ae,{})," Export"]})]})]})}),i!=="snapshot"&&s.jsxs("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3",children:[u.date&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Start"}),s.jsx("input",{type:"date",value:f,onChange:t=>p(t.target.value),max:m||new Date().toISOString().slice(0,10),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"End"}),s.jsx("input",{type:"date",value:m,onChange:t=>x(t.target.value),min:f||"",max:O,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]})]}),u.branch&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Branch"}),s.jsxs("select",{value:S,onChange:t=>P(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),w.map(t=>s.jsx("option",{value:t.id,children:t.name||`#${t.id}`},t.id))]})]}),u.officer&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Officer"}),s.jsxs("select",{value:T,onChange:t=>H(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),(Array.isArray(X)?X:[]).map(t=>s.jsx("option",{value:t.id,children:t.name||t.email||`#${t.id}`},t.id))]})]}),u.borrower&&s.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Borrower"}),s.jsxs("div",{className:"relative flex-1",children:[s.jsx(ie,{className:"absolute left-3 top-3 text-slate-400"}),s.jsx("input",{value:D,onChange:t=>M(t.target.value),placeholder:"Type to search borrowers…",className:"w-full pl-9 pr-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"}),D&&G.length>0&&s.jsx("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-slate-900 border rounded shadow max-h-56 overflow-auto",children:G.map(t=>s.jsxs("button",{type:"button",onClick:()=>{W(String(t.id)),M(t.name||t.phone||t.email||`Borrower #${t.id}`)},className:"w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800",children:[t.name||`Borrower #${t.id}`," ",s.jsx("span",{className:"opacity-60",children:t.phone||t.email||""})]},t.id))})]}),s.jsx("button",{onClick:()=>R(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),s.jsx("button",{onClick:K,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]}),!u.borrower&&s.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[s.jsx("button",{onClick:()=>R(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),s.jsx("button",{onClick:K,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]}),s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:j?s.jsx("div",{className:"text-red-600 text-sm",children:j}):C?s.jsx("div",{className:"text-slate-500 text-sm",children:"Loading…"}):U.length===0?s.jsx("div",{className:"text-slate-500 text-sm",children:"No data."}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200",children:s.jsx("tr",{children:Z.map(t=>s.jsx("th",{className:"px-3 py-2 text-left font-semibold",children:t.label||g(t.key)},t.key))})}),s.jsx("tbody",{children:U.map((t,a)=>s.jsx("tr",{className:"border-t border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/40",children:Z.map(n=>s.jsx("td",{className:"px-3 py-2",children:re(n,t)},n.key))},a))}),q(o==null?void 0:o.totals)&&s.jsx("tfoot",{children:s.jsx("tr",{children:Z.map((t,a)=>{const n=o.totals[t.key],h=typeof n=="number",y=n==null?"":t.percent&&h?Y(n):t.currency&&h?Q(n):F(n);return s.jsx("td",{className:`px-3 py-2 font-semibold ${a===0?"":"text-right"}`,children:a===0?"Totals":y},t.key)})})})]})})}),((o==null?void 0:o.period)||(o==null?void 0:o.scope))&&s.jsxs("div",{className:"text-[12px] text-slate-500",children:[o!=null&&o.period?`Period: ${o.period}`:""," ",o!=null&&o.scope?`· Scope: ${o.scope}`:""]})]})}export{he as R};

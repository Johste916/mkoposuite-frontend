import{r as b,j as e,C as E,P as $,Q as _,S as q,g as c}from"./index-DUtn1vUj.js";const A="00000000-0000-0000-0000-000000000000";function u({label:S,value:v,muted:r}){return e.jsxs("div",{className:"p-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900",children:[e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:S}),e.jsx("div",{className:`mt-1 text-sm ${r?"text-slate-500 dark:text-slate-400":"text-slate-800 dark:text-slate-100"}`,children:v??"—"})]})}function G(){var T,C,O,L,z;const[S,v]=b.useState(!0),[r,p]=b.useState(null),[k,N]=b.useState(""),[d,F]=b.useState(null),[h,D]=b.useState(null),[f,P]=b.useState([]),[j,J]=b.useState([]),I=()=>{var t,l,i;try{const o=(l=(t=c).getTenantId)==null?void 0:l.call(t);if(o)return String(o);const s=localStorage.getItem("activeTenantId");if(s)return String(s);const n=localStorage.getItem("tenantId");if(n)return String(n);const x=localStorage.getItem("tenant");if(x){const g=JSON.parse(x);if(g!=null&&g.id)return String(g.id)}const a=JSON.parse(localStorage.getItem("user")||"{}"),m=(a==null?void 0:a.tenantId)||((i=a==null?void 0:a.tenant)==null?void 0:i.id)||(a==null?void 0:a.orgId)||(a==null?void 0:a.companyId);if(m)return String(m)}catch{}return""},U=async()=>{var l,i,o,s,n,x;let t=I();if(!t)try{const{data:a}=await c.get("/tenants/me"),m=a||{},g=m.id||m.tenantId||m.orgId||"";if(g){t=String(g),(i=(l=c).setTenantId)==null||i.call(l,t);try{localStorage.setItem("tenant",JSON.stringify({id:t,name:m.name||"Organization"})),localStorage.setItem("tenantId",t)}catch{}return p({id:t,name:m.name||"Organization",planCode:m.planCode,status:m.status}),t}}catch{}if(!t){t=A,(s=(o=c).setTenantId)==null||s.call(o,t);try{localStorage.setItem("tenant",JSON.stringify({id:t,name:"Organization"})),localStorage.setItem("tenantId",t)}catch{}return p({id:t,name:"Organization"}),t}(x=(n=c).setTenantId)==null||x.call(n,t);try{const{data:a}=await c.get("/tenants/me");p({id:t,name:(a==null?void 0:a.name)||"Organization",planCode:a==null?void 0:a.planCode,status:a==null?void 0:a.status})}catch{p({id:t,name:"Organization"})}return t},y=async()=>{var l,i,o;v(!0),N("");const t=await U();try{const[s,n,x,a]=await Promise.all([c.get("/org/limits").catch(()=>({data:null})),c.get("/billing").catch(()=>({data:null})),c.get("/plans").catch(async()=>(await c.get("/billing/plans")).data).catch(()=>({data:[]})),c.get(`/tenants/${t}/invoices`).catch(()=>({data:{invoices:[]}}))]);F((s==null?void 0:s.data)||null),D((n==null?void 0:n.data)||null),P((x==null?void 0:x.data)||[]),J((((l=a==null?void 0:a.data)==null?void 0:l.invoices)||[]).slice().sort((m,g)=>String(g.date||"").localeCompare(String(m.date||""))))}catch(s){const n=((o=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:o.error)||(s==null?void 0:s.normalizedMessage)||(s==null?void 0:s.message)||"Failed to load subscription.";N(n)}finally{v(!1)}};b.useEffect(()=>{y()},[]);const B=async()=>{var l,i,o,s;N("");const t=((i=(l=c).getTenantId)==null?void 0:i.call(l))||I()||A;try{await c.post(`/tenants/${t}/invoices/sync`,{}),await y()}catch(n){const x=((s=(o=n==null?void 0:n.response)==null?void 0:o.data)==null?void 0:s.error)||(n==null?void 0:n.normalizedMessage)||(n==null?void 0:n.message)||"Failed to sync invoices.";N(x)}},w=async t=>{var i,o;t.preventDefault();const l=String(new FormData(t.currentTarget).get("tenantId")||"").trim();if(l){(o=(i=c).setTenantId)==null||o.call(i,l);try{localStorage.setItem("tenant",JSON.stringify({id:l,name:"Organization"})),localStorage.setItem("tenantId",l)}catch{}p(s=>({...s||{},id:l})),await y()}},M=({plan:t})=>e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800",children:String(t||"basic").toUpperCase()});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h1",{className:"text-xl font-bold tracking-tight",children:"Subscription"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:y,className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm",title:"Refresh",children:[e.jsx(E,{})," Refresh"]}),e.jsxs("button",{onClick:B,className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm",title:"Sync invoices from billing provider",children:[e.jsx($,{})," Sync Invoices"]})]})]}),!(r!=null&&r.id)&&e.jsxs("div",{className:"p-3 rounded-lg border border-amber-300 bg-amber-50 text-amber-900 dark:bg-amber-900/20 dark:border-amber-800 dark:text-amber-200 flex items-center gap-2",children:[e.jsx(_,{className:"shrink-0"}),e.jsx("div",{className:"flex-1 text-sm",children:"Tenant is not selected. Some subscription details require a tenant id."}),e.jsxs("form",{onSubmit:w,className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",name:"tenantId",placeholder:"Enter Tenant ID",className:"px-2 py-1 rounded border border-amber-300 bg-white dark:bg-slate-900 dark:border-amber-800 text-sm"}),e.jsx("button",{className:"px-2.5 py-1 rounded bg-amber-600 text-white text-sm hover:bg-amber-700",type:"submit",children:"Set"})]})]}),k&&e.jsx("div",{className:"p-3 rounded-lg border border-rose-300 bg-rose-50 text-rose-800 dark:bg-rose-900/20 dark:border-rose-800 dark:text-rose-200 text-sm",children:k}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"Current Subscription"}),(r==null?void 0:r.planCode)&&e.jsx(M,{plan:r.planCode})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(u,{label:"Tenant",value:(r==null?void 0:r.name)||"Organization"}),e.jsx(u,{label:"Tenant ID",value:(r==null?void 0:r.id)||"—",muted:!0}),e.jsx(u,{label:"Status",value:(h==null?void 0:h.status)||(r==null?void 0:r.status)||"—"}),e.jsx(u,{label:"Plan",value:(h==null?void 0:h.plan)||(r==null?void 0:r.planCode)||((T=d==null?void 0:d.plan)==null?void 0:T.code)||"—"})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(u,{label:"Borrowers Limit",value:((C=d==null?void 0:d.limits)==null?void 0:C.borrowers)??"—"}),e.jsx(u,{label:"Loans Limit",value:((O=d==null?void 0:d.limits)==null?void 0:O.loans)??"—"}),e.jsx(u,{label:"Borrowers Used",value:((L=d==null?void 0:d.usage)==null?void 0:L.borrowers)??"—",muted:!0}),e.jsx(u,{label:"Loans Used",value:((z=d==null?void 0:d.usage)==null?void 0:z.loans)??"—",muted:!0})]})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"Invoices"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[(j==null?void 0:j.length)||0," items"]})]}),e.jsxs("div",{className:"divide-y divide-slate-200 dark:divide-slate-800",children:[(j||[]).length===0&&e.jsx("div",{className:"px-4 py-8 text-sm text-slate-500 dark:text-slate-400",children:"No invoices yet."}),(j||[]).map((t,l)=>e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-100",children:t.number||t.id||"Invoice"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:[t.date||t.createdAt||"—"," · ",t.status||"—"]})]}),e.jsx("div",{className:"text-sm font-semibold",children:typeof t.amount=="number"?t.amount.toLocaleString():t.amount||"—"})]},t.id||l))]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold",children:[e.jsx(q,{})," Plans"]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[(Array.isArray(f)?f:[]).map(t=>e.jsxs("div",{className:"p-2 rounded border border-slate-200 dark:border-slate-800",children:[e.jsx("div",{className:"text-sm font-medium",children:t.name||(t.code||"").toUpperCase()}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:t.description||"—"})]},t.code||t.id)),(!f||f.length===0)&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:"No plans available."})]})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Troubleshooting"}),e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-400",children:"If you still see “Missing tenant id”, set a tenant id manually below."}),e.jsxs("form",{onSubmit:w,className:"mt-3 flex items-center gap-2",children:[e.jsx("input",{name:"tenantId",placeholder:"Enter Tenant ID",className:"px-2 py-1 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-slate-800 text-white text-sm hover:bg-slate-900",type:"submit",children:"Set Tenant"})]})]})]})]}),S&&e.jsx("div",{className:"fixed inset-x-0 bottom-4 flex justify-center pointer-events-none",children:e.jsxs("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 text-white text-xs shadow-lg",children:[e.jsx(E,{className:"animate-spin"})," Loading…"]})})]})}export{G as default};

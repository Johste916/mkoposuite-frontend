import{k as Ge,u as Ke,r as o,j as e,L as X,h as c}from"./index-DYDSVKWX.js";import{c as Qe,f,d as P,e as Xe,g as Ye,h as et,S as tt,n as st,i as we}from"./ScheduleTable-DWt3eNDW.js";const n={page:"w-full px-4 md:px-6 py-6 space-y-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-4xl font-extrabold tracking-tight",sub:"text-sm text-[var(--muted)]",card:"card rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",cardHead:"px-6 py-4 border-b-2 border-[var(--border)] bg-[var(--table-head-bg)] flex items-center justify-between rounded-t-2xl",cardBody:"px-6 py-6",cardBodyDense:"px-6 py-4",label:"text-[12px] uppercase tracking-wide text-[var(--muted)] font-semibold",actionLink:"inline-flex items-center gap-1 font-extrabold text-[var(--primary)] underline underline-offset-4 decoration-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",chip:"inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-[11px] font-extrabold uppercase ring-2 ring-[var(--border)] bg-[var(--badge-bg)] text-[var(--badge-fg)]",btn:"inline-flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-semibold border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--chip-soft)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",primary:"inline-flex items-center gap-2 px-3 md:px-4 py-2 rounded-lg font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-0 disabled:opacity-60",input:"w-full rounded-lg border-2 px-3 py-2 outline-none bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)] placeholder:text-[var(--input-placeholder)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",tableWrap:"overflow-x-auto rounded-xl border-2 border-[var(--border-strong)] bg-[var(--card)]",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide font-semibold px-3 py-2 border border-[var(--border)] text-[var(--fg)]/90",td:"px-3 py-2 border border-[var(--border)] text-sm text-[var(--fg)]"},V=({title:r,subtitle:g,right:s,children:H,dense:u=!1})=>e.jsxs("div",{className:n.card,children:[(r||g||s)&&e.jsxs("div",{className:n.cardHead,children:[e.jsxs("div",{className:"min-w-0",children:[r&&e.jsx("h3",{className:"text-xl md:text-2xl font-extrabold tracking-tight",children:r}),g&&e.jsx("p",{className:n.sub,children:g})]}),s]}),e.jsx("div",{className:u?n.cardBodyDense:n.cardBody,children:H})]}),N=({children:r})=>e.jsx("div",{className:n.label,children:r}),at=()=>{try{return(JSON.parse(localStorage.getItem("user")||"{}").role||"").toLowerCase()}catch{return""}},D=r=>r==="admin"||r==="director"||r==="superadmin",nt=r=>["branch_manager","manager","bm"].includes(r)||D(r),rt=r=>["compliance","compliance_officer","legal"].includes(r)||D(r),lt=r=>["accountant","finance"].includes(r)||D(r),it=r=>["loan_officer","officer"].includes(r)&&!D(r);function ot(r){if(!r)return"";const g=String(r).toLowerCase();return g==="pending"?"submitted":g==="approved"?"accounting":""}function mt(){var je,Ne;const{id:r}=Ge(),g=Ke(),[s,H]=o.useState(null),[u,Y]=o.useState(null),[y,ee]=o.useState([]),[te,E]=o.useState([]),[x,O]=o.useState(null),[Se,se]=o.useState(!0),[ke,ae]=o.useState(!0),[Ce,ne]=o.useState(!0),[Re,re]=o.useState(!1),[le,ie]=o.useState(null),[d,A]=o.useState(""),[S,oe]=o.useState(""),[h,k]=o.useState(!1),[J,Z]=o.useState(""),[Le,T]=o.useState(!1),[ce,de]=o.useState(!1),[C,M]=o.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[De,G]=o.useState(!1),[Ae,_]=o.useState(!1),[p,$]=o.useState({amount:"",interestRate:"",termMonths:"",startDate:""}),[me,ue]=o.useState(!1),[Me,I]=o.useState(!1),[v,B]=o.useState({termMonths:"",startDate:"",previewOnly:!1}),[xe,he]=o.useState(!1),m=(s==null?void 0:s.currency)||"TZS",$e=n.chip,R=at(),K=nt(R),pe=rt(R),Fe=lt(R),Pe=it(R),Ee=D(R)||K||pe,Oe=D(R)||K,L=(s==null?void 0:s.workflowStage)||ot(s==null?void 0:s.status),be=Pe&&["changes_requested","bm_changes_requested","compliance_changes_requested","returned_to_officer","request_changes"].includes(L),q=K&&["submitted","bm_review","changes_resubmitted"].includes(L),fe=pe&&["compliance","compliance_review"].includes(L),ge=Fe&&((s==null?void 0:s.status)==="approved"||L==="accounting"),ve=o.useRef(null),b=async()=>{se(!0),ie(null);try{const{data:t}=await c.get(`/loans/${r}`);H(t),oe(String((t==null?void 0:t.amount)??""));const a=[c.get(`/repayments/loan/${r}`).then(l=>ee(l.data||[])).catch(()=>ee([])).finally(()=>ae(!1)),c.get(`/comments/loan/${r}`).then(l=>E(Array.isArray(l.data)?l.data:[])).catch(()=>E([])).finally(()=>ne(!1))];t!=null&&t.productId&&a.push(c.get(`/loan-products/${t.productId}`).then(l=>Y(l.data)).catch(()=>Y(null))),re(!0),a.push(c.get(`/loans/${r}/schedule`).then(l=>O(st(l.data))).catch(()=>O(null)).finally(()=>re(!1))),await Promise.all(a)}catch(t){console.error(t),ie("Failed to fetch loan.")}finally{se(!1)}};o.useEffect(()=>{ve.current!==r&&(ve.current=r,O(null),A(""),Z(""),ae(!0),ne(!0),b())},[r]),o.useEffect(()=>{const t=()=>b();return window.addEventListener("focus",t),()=>window.removeEventListener("focus",t)},[]),o.useEffect(()=>{const t=a=>{var l;String((l=a==null?void 0:a.detail)==null?void 0:l.id)===String(r)&&b()};return window.addEventListener("loan:updated",t),()=>window.removeEventListener("loan:updated",t)},[r]);async function F(t){try{await c.post("/comments",{loanId:r,content:t});const a=await c.get(`/comments/loan/${r}`);E(Array.isArray(a.data)?a.data:[])}catch{}}async function W(t,a={}){k(!0);try{await c.post(`/loans/${r}/workflow`,{action:t,comment:(d==null?void 0:d.trim())||void 0,suggestedAmount:a.suggestedAmount!=null&&a.suggestedAmount!==""?Number(a.suggestedAmount):void 0}),await b(),A(""),alert("Action applied.")}catch{try{t==="bm_approve"||t==="compliance_approve"?(await c.patch(`/loans/${r}/status`,{status:"approved"}),d.trim()&&await F(d.trim())):t==="reject"?(await c.patch(`/loans/${r}/status`,{status:"rejected"}),d.trim()&&await F(d.trim())):t==="request_changes"?d.trim()&&await F(`Changes requested: ${d.trim()}`):t==="resubmit"&&(await c.patch(`/loans/${r}/status`,{status:"pending"}),d.trim()&&await F(`Resubmitted: ${d.trim()}`)),await b(),A(""),alert("Action applied (fallback).")}catch(i){console.error(i),alert("Failed to apply action.")}}finally{k(!1)}}async function Te(){var t,a;k(!0);try{try{await c.post(`/loans/${r}/disburse`)}catch{try{await c.patch(`/loans/${r}/status`,{status:"disbursed"})}catch{await c.put(`/loans/${r}/status`,{status:"disbursed"})}}await b(),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:r}})),alert("Loan disbursed.")}catch(l){console.error(l),alert(((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to disburse loan.")}finally{k(!1)}}async function _e(){if(!S||Number(S)<=0){alert("Enter a valid amount.");return}k(!0);try{await c.patch(`/loans/${r}`,{amount:Number(S)}),d.trim()&&await F(`Suggested amount: ${f(S,m)} — ${d.trim()}`),await b(),alert("Suggestion saved.")}catch(t){console.error(t),alert("Failed to save suggestion.")}finally{k(!1)}}const Ie=async()=>{const t=Number(z||0);if(!(t>0&&!window.confirm("Outstanding > 0. Close anyway?")))try{await c.patch(`/loans/${r}/status`,{status:"closed",override:t>0}),await b(),alert("Loan closed.")}catch(a){console.error(a),alert("Failed to close loan.")}},Be=async()=>{if(J.trim())try{const t=await c.post("/comments",{loanId:r,content:J});E(a=>[t.data,...a]),Z("")}catch(t){console.error(t),alert("Failed to add comment.")}},qe=async()=>{const t=Number(C.amount);if(!t||t<=0)return alert("Enter a valid amount.");de(!0);try{if(await c.post("/repayments",{loanId:r,...C,amount:t}),s!=null&&s.status&&!["active","closed"].includes(String(s.status).toLowerCase()))try{await c.patch(`/loans/${r}/status`,{status:"active"})}catch{}await b(),T(!1),M({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:r}})),alert("Repayment posted.")}catch(a){console.error(a),alert("Failed to post repayment.")}finally{de(!1)}},We=()=>{$({amount:(s==null?void 0:s.amount)??"",interestRate:(s==null?void 0:s.interestRate)??"",termMonths:(s==null?void 0:s.termMonths)??(s==null?void 0:s.durationMonths)??"",startDate:we((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate))}),_(!0)},ze=async()=>{var a,l;const t={amount:p.amount===""?void 0:Number(p.amount),interestRate:p.interestRate===""?void 0:Number(p.interestRate),termMonths:p.termMonths===""?void 0:Number(p.termMonths),startDate:p.startDate||void 0};if(Number.isFinite(t.amount)&&t.amount<=0)return alert("Amount must be > 0");if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");ue(!0);try{await c.patch(`/loans/${r}`,t),_(!1),await b(),alert("Loan updated.")}catch(i){console.error(i),alert(((l=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to update loan.")}finally{ue(!1)}},Ue=async()=>{var t,a;if(window.confirm("This will permanently delete this loan. Continue?"))try{await c.delete(`/loans/${r}`),alert("Loan deleted."),g("/loans")}catch(l){console.error(l),alert(((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to delete loan.")}},Ve=()=>{B({termMonths:(s==null?void 0:s.termMonths)??"",startDate:we((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate)),previewOnly:!1}),I(!0)},He=async()=>{var a,l;const t={termMonths:v.termMonths===""?void 0:Number(v.termMonths),startDate:v.startDate||void 0,previewOnly:!!v.previewOnly};if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");he(!0);try{const{data:i}=await c.post(`/loans/${r}/reschedule`,t);Array.isArray(i==null?void 0:i.schedule)&&O(i.schedule),I(!1),await b(),alert((i==null?void 0:i.message)||"Schedule updated.")}catch(i){console.error(i),alert(((l=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to reschedule.")}finally{he(!1)}},Je=async()=>{var t,a,l;if(window.confirm("Reissue creates a new pending loan cloned from this one. Continue?"))try{const{data:i}=await c.post(`/loans/${r}/reissue`),ye=((t=i==null?void 0:i.loan)==null?void 0:t.id)||(i==null?void 0:i.id);alert("New loan created."),ye&&g(`/loans/${ye}`)}catch(i){console.error(i),alert(((l=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to reissue loan.")}},j=o.useMemo(()=>Qe(x||[],y||[]),[x,y]),Q=Array.isArray(x)&&x.length>0,z=(s==null?void 0:s.status)==="closed"?0:Q?j.outstanding:(s==null?void 0:s.outstanding)??null,w=Q?j.nextDue:null,U=o.useMemo(()=>{const t=y.length||0,a=y.reduce((l,i)=>l+Number(i.amount||0),0);return{count:t,sum:a}},[y]),Ze=(s==null?void 0:s.status)!=="closed"&&Number(z||0)>0;return Se?e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:"Loading loan…"}):le?e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:le}):s?e.jsxs("div",{className:n.page,children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:n.h1,children:"Loan Details"}),e.jsx("span",{className:$e,children:s.status}),L&&e.jsxs("span",{className:n.chip,children:["Stage: ",L.replaceAll("_"," ")]})]}),e.jsx("button",{onClick:()=>g(-1),className:n.actionLink,children:"← Back"})]}),e.jsxs(V,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6",children:[e.jsxs("div",{className:"col-span-2 min-w-0",children:[e.jsx(N,{children:"Borrower"}),e.jsxs(X,{className:`${n.actionLink} text-lg md:text-xl truncate`,to:`/borrowers/${s.borrowerId}`,title:((je=s.Borrower)==null?void 0:je.name)||s.borrowerName||"N/A",children:[((Ne=s.Borrower)==null?void 0:Ne.name)||s.borrowerName||"N/A"," ",e.jsx("span",{children:"›"})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Amount"}),e.jsx("div",{className:"text-2xl font-extrabold",children:f(s.amount,m)})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Interest"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-bold",children:[s.interestRate,"%"]})," ",e.jsxs("span",{children:["· ",s.interestMethod||"—"]})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Term"}),e.jsxs("div",{className:"text-base font-semibold",children:[s.termMonths||s.durationMonths," months"]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Start / Release"}),e.jsx("div",{className:"text-base font-semibold",children:P(s.startDate||s.releaseDate)})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Outstanding"}),e.jsx("div",{className:"text-2xl font-extrabold",children:z==null?"—":f(z,m)})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Next Due"}),e.jsx("div",{className:"text-base font-semibold",children:w?e.jsxs(e.Fragment,{children:[P(w.date)," ·"," ",e.jsx("span",{className:"font-extrabold",children:f(w.amount,m)})]}):"—"})]}),u&&e.jsxs("div",{className:"md:col-span-2 lg:col-span-3 xl:col-span-4",children:[e.jsx(N,{children:"Product"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-extrabold",children:[u.name,u.code?` (${u.code})`:""]}),e.jsxs("div",{className:"text-sm mt-0.5",children:["Defaults: ",u.interestMethod," @"," ",u.interestRate??u.defaultInterestRate,"% · Limits:"," ",f(u.minPrincipal,m)," –"," ",f(u.maxPrincipal,m),", ",u.minTermMonths,"-",u.maxTermMonths," months"]})]})]})]}),e.jsx("div",{className:"mt-6 grid sm:grid-cols-3 lg:grid-cols-6 gap-4 text-sm",children:[["Paid Principal",j.paidPrincipal],["Paid Interest",j.paidInterest],["Paid Penalties",j.paidPenalty],["Paid Fees",j.paidFees],["Total Paid",j.totalPaid],["Total Scheduled",j.scheduledTotal]].map(([t,a])=>e.jsxs("div",{className:"rounded-xl border-2 border-[var(--border-strong)] p-3 bg-[var(--card)] shadow-sm",children:[e.jsx("div",{className:n.label,children:t}),e.jsx("div",{className:"font-bold text-lg",children:Q?f(a,m):"—"})]},t))})]}),(be||q||fe||ge)&&e.jsxs(V,{dense:!0,children:[be&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-extrabold",children:"Changes Requested"}),e.jsxs("p",{className:"text-sm",children:["Update the application and attach missing documents, then"," ",e.jsx("strong",{children:"Resubmit"}),". Add a short note if helpful."]}),e.jsx("label",{className:"block text-xs font-semibold",children:"Comment (optional)"}),e.jsx("textarea",{value:d,onChange:t=>A(t.target.value),className:`${n.input} min-h-[44px]`,placeholder:"What did you fix / add?"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>W("resubmit"),disabled:h,className:n.primary,title:"Send for review again",children:h?"Submitting…":"Resubmit for Review"}),e.jsx(X,{to:"/loans/applications",className:n.btn,title:"Open applications to edit details/attachments",children:"Edit Application"})]})]}),(q||fe)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-extrabold",children:q?"Branch Manager Review":"Compliance Review"})}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold",children:"Suggested Principal"}),e.jsx("input",{type:"number",className:n.input,value:S,onChange:t=>oe(t.target.value),min:"0",step:"0.01"}),e.jsx("p",{className:"text-[11px] text-[var(--muted)] mt-1",children:"Save a suggestion or approve with a different amount."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold",children:"Comment"}),e.jsx("textarea",{className:`${n.input} min-h-[44px]`,placeholder:"Why approving / changes / rejection?",value:d,onChange:t=>A(t.target.value)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{onClick:()=>W(q?"bm_approve":"compliance_approve",{suggestedAmount:S}),disabled:h,className:n.primary,children:h?"Working…":"Approve"}),e.jsx("button",{onClick:()=>W("request_changes"),disabled:h,className:n.btn,title:"Send back to Loan Officer with requested changes",children:h?"Working…":"Request Changes"}),e.jsx("button",{onClick:()=>W("reject"),disabled:h,className:n.btn,children:h?"Working…":"Reject"}),e.jsx("button",{onClick:_e,disabled:h,className:n.btn,children:h?"Saving…":"Save Suggestion"})]})]}),ge&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm",children:"This loan is approved. Proceed to disbursement to finalize payout."}),e.jsx("button",{onClick:Te,className:n.primary,disabled:h,children:h?"Working…":"Disburse"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(X,{to:"/loans",className:n.btn,children:"Back to Loans"}),e.jsx("button",{onClick:()=>G(!0),className:n.btn,children:"View Schedule"}),e.jsx("button",{onClick:()=>Xe({loan:s,schedule:x||[],currency:m}),className:n.btn,disabled:!Array.isArray(x)||!x.length,children:"Export CSV"}),e.jsx("button",{onClick:()=>Ye({loan:s,schedule:x||[],currency:m}),className:n.btn,disabled:!Array.isArray(x)||!x.length,children:"Export PDF"}),Ze&&e.jsx("button",{onClick:()=>T(!0),className:n.btn,children:"Post Repayment"}),Ee&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:We,className:n.btn,children:"Edit Loan"}),e.jsx("button",{onClick:Ve,className:n.btn,children:"Reschedule"})]}),e.jsx("button",{onClick:Je,className:n.btn,children:"Reissue"}),Oe&&e.jsx("button",{onClick:Ue,className:"px-3 md:px-4 py-2 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 shadow-sm",children:"Delete"}),s.status!=="closed"&&e.jsx("button",{onClick:Ie,className:n.btn,children:"Close Loan"})]}),e.jsx(V,{title:"Repayments",right:e.jsxs("div",{className:"text-sm font-semibold",children:[U.count," record",U.count===1?"":"s"," · Total"," ",e.jsx("span",{className:"font-extrabold",children:f(U.sum,m)})]}),children:ke?e.jsx("p",{children:"Loading repayments…"}):y.length===0?e.jsx("div",{className:"text-sm",children:"No repayments found."}):e.jsx("div",{className:n.tableWrap,children:e.jsxs("table",{className:"min-w-full table-fixed",children:[e.jsx("thead",{children:e.jsx("tr",{className:"text-left sticky top-0 z-10",children:["#","Date","Amount","Method","Notes"].map(t=>e.jsx("th",{className:n.th,children:t},t))})}),e.jsx("tbody",{children:y.map((t,a)=>e.jsxs("tr",{className:`${a%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)] transition-colors`,children:[e.jsx("td",{className:n.td,children:a+1}),e.jsx("td",{className:n.td,children:P(t.date)}),e.jsx("td",{className:`${n.td} text-right tabular-nums`,children:f(t.amount,m)}),e.jsx("td",{className:n.td,children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-bold bg-[var(--badge-bg)] text-[var(--badge-fg)] ring-1 ring-[var(--border)]",children:t.method||"—"})}),e.jsx("td",{className:`${n.td} break-words`,children:t.notes||"—"})]},t.id||a))}),e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{className:`${n.td} font-bold`,colSpan:2,children:"Total"}),e.jsx("td",{className:`${n.td} text-right text-base font-extrabold`,children:f(U.sum,m)}),e.jsx("td",{className:n.td,colSpan:2})]})})]})})}),e.jsxs(V,{title:"Comments",children:[Ce?e.jsx("p",{children:"Loading comments…"}):te.length===0?e.jsx("div",{className:"text-sm",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-72 overflow-auto pr-1",children:te.map((t,a)=>{var l,i;return e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-[var(--badge-bg)] text-[var(--badge-fg)] flex items-center justify-center text-xs font-extrabold select-none",children:(((l=t.author)==null?void 0:l.name)||"U").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"flex-1 border-b-2 border-[var(--border)] pb-2",children:[e.jsxs("div",{className:"flex justify-between text-xs text-[var(--muted)]",children:[e.jsx("span",{className:"font-bold text-[var(--fg)]",children:((i=t.author)==null?void 0:i.name)||"User"}),e.jsx("span",{children:et(t.createdAt)})]}),e.jsx("p",{className:"text-sm mt-0.5 break-words",children:t.content})]})]},t.id||a)})}),e.jsxs("div",{className:"mt-4 flex items-start gap-2",children:[e.jsx("textarea",{value:J,onChange:t=>Z(t.target.value),className:`${n.input} min-h-[44px]`,placeholder:"Add a comment"}),e.jsx("button",{onClick:Be,className:n.primary,children:"Post"})]})]}),Le&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"rounded-2xl shadow-2xl w-full max-w-3xl p-6 border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-2xl font-extrabold",children:"Post Repayment"}),e.jsx("button",{onClick:()=>T(!1),className:n.actionLink,children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Amount"}),e.jsx("input",{type:"number",value:C.amount,onChange:t=>M(a=>({...a,amount:t.target.value})),className:n.input,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Date"}),e.jsx("input",{type:"date",value:C.date,onChange:t=>M(a=>({...a,date:t.target.value})),className:n.input})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Method"}),e.jsxs("select",{value:C.method,onChange:t=>M(a=>({...a,method:t.target.value})),className:n.input,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:C.notes,onChange:t=>M(a=>({...a,notes:t.target.value})),className:n.input,placeholder:"Receipt no., reference, etc."})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>T(!1),className:n.btn,children:"Cancel"}),e.jsx("button",{onClick:qe,disabled:ce,className:n.primary,children:ce?"Posting…":"Post"})]})]})}),De&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"rounded-2xl shadow-2xl w-full max-w-6xl p-6 border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-2xl font-extrabold",children:"Repayment Schedule"}),e.jsx("button",{onClick:()=>G(!1),className:n.actionLink,children:"✕"})]}),Re?e.jsx("p",{children:"Loading schedule…"}):!Array.isArray(x)||x.length===0?e.jsx("p",{children:"No schedule available."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 text-sm space-y-1",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Disbursed:"})," ",P((s==null?void 0:s.releaseDate)||(s==null?void 0:s.startDate))||"—"]}),e.jsxs("div",{children:["Next installment: ",w?e.jsxs(e.Fragment,{children:[e.jsxs("b",{children:["#",w.idx]})," on ",P(w.date)," —"," ",e.jsx("b",{children:f(w.amount,m)})]}):"—"]})]}),e.jsx("div",{className:"max-h-[75vh] overflow-auto rounded-xl border-2 border-[var(--border-strong)]",children:e.jsx(tt,{schedule:x||[],currency:m})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{onClick:()=>G(!1),className:n.btn,children:"Close"})})]})}),Ae&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"rounded-2xl shadow-2xl w-full max-w-lg p-6 border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-2xl font-extrabold",children:"Edit Loan"}),e.jsx("button",{onClick:()=>_(!1),className:n.actionLink,children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Amount"}),e.jsx("input",{type:"number",value:p.amount,onChange:t=>$(a=>({...a,amount:t.target.value})),className:n.input,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Interest Rate (%)"}),e.jsx("input",{type:"number",value:p.interestRate,onChange:t=>$(a=>({...a,interestRate:t.target.value})),className:n.input,step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Term (months)"}),e.jsx("input",{type:"number",value:p.termMonths,onChange:t=>$(a=>({...a,termMonths:t.target.value})),className:n.input})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Start Date"}),e.jsx("input",{type:"date",value:p.startDate,onChange:t=>$(a=>({...a,startDate:t.target.value})),className:n.input})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>_(!1),className:n.btn,children:"Cancel"}),e.jsx("button",{onClick:ze,disabled:me,className:n.primary,children:me?"Saving…":"Save"})]})]})}),Me&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"rounded-2xl shadow-2xl w-full max-w-lg p-6 border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-2xl font-extrabold",children:"Reschedule Loan"}),e.jsx("button",{onClick:()=>I(!1),className:n.actionLink,children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"New Term (months)"}),e.jsx("input",{type:"number",value:v.termMonths,onChange:t=>B(a=>({...a,termMonths:t.target.value})),className:n.input,min:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold",children:"New Start Date"}),e.jsx("input",{type:"date",value:v.startDate,onChange:t=>B(a=>({...a,startDate:t.target.value})),className:n.input})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm font-semibold",children:[e.jsx("input",{type:"checkbox",checked:v.previewOnly,onChange:t=>B(a=>({...a,previewOnly:t.target.checked}))}),"Preview only (don’t save)"]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>I(!1),className:n.btn,children:"Cancel"}),e.jsx("button",{onClick:He,disabled:xe,className:n.primary,children:xe?"Working…":v.previewOnly?"Preview":"Reschedule"})]})]})})]}):e.jsx("div",{className:"w-full px-6 py-6 text-[var(--fg)]",children:"Loan not found."})}export{mt as default};

import{r as n,b as C,j as s,E as te,G as se,F as re}from"./index-nRfDEWc-.js";const y=e=>String(e||"").replace(/[_\-]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,o=>o.toUpperCase()),Q=e=>`TZS ${Number(e||0).toLocaleString()}`,ae=e=>typeof e=="number"?`${(e>1?e:e*100).toFixed(2)}%`:String(e??""),P=e=>Object.prototype.toString.call(e)==="[object Object]";function q(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function le(e){if(!e||!e.length)return"";const o=Array.from(e.reduce((c,d)=>(Object.keys(d||{}).forEach(u=>c.add(u)),c),new Set)),a=c=>{const d=c==null?"":String(c);return/[,"\n]/.test(d)?`"${d.replace(/"/g,'""')}"`:d};return[o.join(","),...e.map(c=>o.map(d=>a(c[d])).join(","))].join(`
`)}function oe(e){var a;const o=(e==null?void 0:e.columns)||((a=e==null?void 0:e.table)==null?void 0:a.columns);return o&&Array.isArray(o)?o.map(c=>typeof c=="string"?{key:c,label:y(c)}:c):null}function ne(e,o){var u;let a=[],c=P(e)?e:{},d=oe(e)||(Array.isArray(o)?o.slice():[]);return Array.isArray((u=e==null?void 0:e.table)==null?void 0:u.rows)?a=e.table.rows:Array.isArray(e==null?void 0:e.rows)?a=e.rows:Array.isArray(e==null?void 0:e.items)?a=e.items:Array.isArray(e==null?void 0:e.buckets)?a=e.buckets:e&&typeof e=="object"&&(a=Object.entries(e).filter(([x])=>!["rows","items","buckets","table","columns"].includes(x)).map(([x,p])=>({metric:y(x),value:p})),d.length||(d=[{key:"metric",label:"Metric"},{key:"value",label:"Value",fmt:x=>typeof x=="number"?Q(x):q(x)}])),!d.length&&(a!=null&&a.length)&&P(a[0])&&(d=Object.keys(a[0]).slice(0,12).map(x=>({key:x,label:y(x)}))),{rows:Array.isArray(a)?a:[],columns:d,meta:c}}function ce(e,o){if(o!=null&&o.scope&&String(o.scope).trim())return String(o.scope);const a=[];if(a.push(e.branchId?`Branch #${e.branchId}`:"All branches"),a.push(e.officerId?`Officer #${e.officerId}`:"All officers"),a.push(e.borrowerId?`Borrower #${e.borrowerId}`:"All borrowers"),e.startDate||e.endDate){const c=e.startDate||"…",d=e.endDate||"…";a.push(`${c} → ${d}`)}else a.push("All time");return a.join(" · ")}function de({title:e="Report",endpoint:o,columns:a=[],exportCsvPath:c="",mode:d="auto",filters:u={date:!0,branch:!0,officer:!0,borrower:!0},extraParams:h={},onAfterLoad:x}){const[p,O]=n.useState(!1),[I,D]=n.useState(""),[E,B]=n.useState(null),G=new Date().toISOString().slice(0,10),[b,R]=n.useState(""),[f,F]=n.useState(""),[j,L]=n.useState(""),[v,M]=n.useState(""),[T,V]=n.useState(""),[m,k]=n.useState(""),[J,H]=n.useState([]),[_,K]=n.useState([]),[z,N]=n.useState([]),g=n.useRef(!0);n.useEffect(()=>()=>{g.current=!1},[]),n.useEffect(()=>{(async()=>{try{const{data:t}=await C.get("/reports/filters");H((t==null?void 0:t.branches)||[]),K((t==null?void 0:t.officers)||[])}catch{}})()},[]),n.useEffect(()=>{const t=m.trim();if(!t){N([]);return}const i=setTimeout(async()=>{try{const{data:l}=await C.get("/borrowers/search",{params:{q:t}});N(Array.isArray(l)?l.slice(0,8):[])}catch{N([])}},250);return()=>clearTimeout(i)},[m]);const S=n.useMemo(()=>({...h,startDate:u.date&&b||void 0,endDate:u.date&&f||void 0,branchId:u.branch&&j||void 0,officerId:u.officer&&v||void 0,borrowerId:u.borrower&&T||void 0}),[h,b,f,j,v,T,u]),w=async()=>{var t,i;if(o){O(!0),D("");try{const{data:l}=await C.get(o,{params:S});if(!g.current)return;B(l),typeof x=="function"&&x(l)}catch(l){if(!g.current)return;console.error("Report load error:",l),D(((i=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:i.error)||(l==null?void 0:l.message)||"Failed to load report"),B({table:{rows:[]}})}finally{g.current&&O(!1)}}};n.useEffect(()=>{w()},[o]);const{rows:A,columns:U,meta:r}=n.useMemo(()=>ne(E,a),[E,a]),W=n.useMemo(()=>ce(S,r),[S,r]),X=()=>{if(c){const $=`https://mkoposuite-backend-42w2.onrender.com/api${c}`;window.open($,"_blank","noopener,noreferrer");return}const t=le(A),i=new Blob([t],{type:"text/csv"}),l=document.createElement("a");l.href=URL.createObjectURL(i),l.download=`${e.replace(/\s+/g,"_").toLowerCase()}_${new Date().toISOString().slice(0,10)}.csv`,l.click()},Y=()=>{R(""),F(""),L(""),M(""),V(""),k("")},ee=(t,i)=>{const l=i==null?void 0:i[t.key],Z=(i==null?void 0:i.currency)&&(t.key==="value"||/amount|total|balance|olp/i.test(t.key)),$=(i==null?void 0:i.percent)&&(t.key==="value"||/par|ratio|yield|efficiency|achievement/i.test(t.key));return t.fmt?t.fmt(l,i):$?ae(Number(l||0)):Z&&typeof l=="number"?Q(l):q(l)};return s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-bold",children:e}),s.jsx("div",{className:"text-[12px] text-slate-500",children:W}),(r==null?void 0:r.welcome)&&s.jsx("div",{className:"text-[12px] text-emerald-700 dark:text-emerald-400 mt-1",children:r.welcome}),((r==null?void 0:r.asOf)||(r==null?void 0:r.period))&&s.jsxs("div",{className:"text-[12px] text-slate-500 mt-1",children:[r!=null&&r.asOf?`As Of: ${String(r.asOf).slice(0,10)}`:"",r!=null&&r.asOf&&(r!=null&&r.period)?" · ":"",r!=null&&r.period?`Period: ${r.period}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:w,className:"inline-flex items-center gap-2 h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",title:"Refresh",children:[s.jsx(te,{className:p?"animate-spin":""}),"Refresh"]}),s.jsxs("button",{onClick:X,className:"inline-flex items-center gap-2 h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export CSV",children:[s.jsx(se,{})," Export"]})]})]})}),d!=="snapshot"&&s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3",children:[u.date&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Start"}),s.jsx("input",{type:"date",value:b,onChange:t=>R(t.target.value),max:f||new Date().toISOString().slice(0,10),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"End"}),s.jsx("input",{type:"date",value:f,onChange:t=>F(t.target.value),min:b||"",max:G,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]})]}),u.branch&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Branch"}),s.jsxs("select",{value:j,onChange:t=>L(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),J.map(t=>s.jsx("option",{value:t.id,children:t.name||`#${t.id}`},t.id))]})]}),u.officer&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Officer"}),s.jsxs("select",{value:v,onChange:t=>M(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),(Array.isArray(_)?_:[]).map(t=>s.jsx("option",{value:t.id,children:t.name||t.email||`#${t.id}`},t.id))]})]}),u.borrower&&s.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Borrower"}),s.jsxs("div",{className:"relative flex-1",children:[s.jsx(re,{className:"absolute left-3 top-3 text-slate-400"}),s.jsx("input",{value:m,onChange:t=>k(t.target.value),placeholder:"Type to search borrowers…",className:"w-full pl-9 pr-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"}),m&&z.length>0&&s.jsx("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-slate-900 border rounded shadow max-h-56 overflow-auto",children:z.map(t=>s.jsxs("button",{type:"button",onClick:()=>{V(String(t.id)),k(t.name||t.phone||t.email||`Borrower #${t.id}`)},className:"w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800",children:[t.name||`Borrower #${t.id}`," ",s.jsx("span",{className:"opacity-60",children:t.phone||t.email||""})]},t.id))})]}),s.jsx("button",{onClick:()=>w(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),s.jsx("button",{onClick:Y,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]})}),s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:I?s.jsx("div",{className:"text-red-600 text-sm",children:I}):p?s.jsx("div",{className:"text-slate-500 text-sm",children:"Loading…"}):A.length===0?s.jsx("div",{className:"text-slate-500 text-sm",children:"No data."}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200",children:s.jsx("tr",{children:U.map(t=>s.jsx("th",{className:"px-3 py-2 text-left font-semibold",children:t.label||y(t.key)},t.key))})}),s.jsx("tbody",{children:A.map((t,i)=>s.jsx("tr",{className:"border-t border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/40",children:U.map(l=>s.jsx("td",{className:"px-3 py-2",children:ee(l,t)},l.key))},i))})]})})}),((r==null?void 0:r.period)||(r==null?void 0:r.scope))&&s.jsxs("div",{className:"text-[12px] text-slate-500",children:[r!=null&&r.period?`Period: ${r.period}`:""," ",r!=null&&r.scope?`· Scope: ${r.scope}`:""]})]})}export{de as R};

import{r as n,g,j as e,L as Z}from"./index-CeHYLxUd.js";import{F as me,S as ue}from"./search-DgGR5bNH.js";import{c as G}from"./createLucideIcon-BzVCG4Pe.js";import{X}from"./x-EU6SNyB5.js";import{C as pe,a as xe}from"./chevron-right-CCD3R2_J.js";import{C as he}from"./chevron-down-YDxWsvkA.js";/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],be=G("check",ge);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]],fe=G("corner-up-left",je);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],q=G("loader-circle",ve),$=10,Ne=[{value:"submitted",label:"Submitted (New)"},{value:"manager_review",label:"Manager Review"},{value:"compliance_review",label:"Compliance Review"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"returned_with_comment",label:"Returned with Comment"}],we=r=>r==="approved"?"bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200":r==="rejected"?"bg-rose-100 text-rose-700 ring-1 ring-rose-200":r==="returned_with_comment"?"bg-amber-100 text-amber-700 ring-1 ring-amber-200":"bg-slate-100 text-slate-700 ring-1 ring-slate-200",Y=(r,l="TZS")=>`‎${l} ${Number(r||0).toLocaleString()}`,ye=r=>r?new Date(r).toLocaleDateString():"—",s={wrap:"w-full px-4 md:px-6 lg:px-8 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-slate-700",card:"rounded-2xl border-2 border-slate-300 bg-white shadow",btn:"inline-flex items-center justify-center rounded-lg border-2 border-slate-300 px-3 py-2 hover:bg-slate-50",btnIcon:"w-4 h-4",th:"bg-slate-100 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-2 border-slate-200 select-none",td:"px-3 py-2 border-2 border-slate-200 text-sm",chip:"px-2 py-0.5 text-[11px] rounded-full",fieldBase:"h-11 w-full rounded-lg border-2 border-slate-300 text-sm outline-none focus:ring-2 focus:ring-indigo-500/40 bg-white",fieldIcon:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"},I=({className:r="",children:l,...o})=>e.jsxs("div",{className:`relative ${r}`,children:[e.jsx("select",{...o,className:`${s.fieldBase} pr-9 appearance-none bg-none ms-select`,style:{backgroundImage:"none"},children:l}),e.jsx(he,{className:"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"})]}),Se=({className:r="",leadingIcon:l=null,...o})=>e.jsxs("div",{className:`relative ${r}`,children:[l,e.jsx("input",{...o,className:`${s.fieldBase} ${l?"pl-10":""}`})]});function Be(){const[r,l]=n.useState([]),[o,m]=n.useState(0),[f,v]=n.useState([]),[M,F]=n.useState([]),[_,T]=n.useState([]),[N,L]=n.useState(""),[R,E]=n.useState(""),[x,w]=n.useState("manager_review"),[y,W]=n.useState(""),[O,H]=n.useState(""),[D,J]=n.useState(""),[p,ee]=n.useState("createdAt"),[h,U]=n.useState("desc"),[b,u]=n.useState(1),[te,V]=n.useState(!0),[ae,A]=n.useState(!1),[K,B]=n.useState(null),z=n.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},[]),c=((z==null?void 0:z.role)||"").toLowerCase();n.useEffect(()=>{c==="compliance"?w("compliance_review"):c==="branch_manager"&&w("manager_review")},[c]),n.useEffect(()=>{const t=setTimeout(()=>E(N.trim()),300);return()=>clearTimeout(t)},[N]),n.useEffect(()=>{(async()=>{try{const[t,a,i]=await Promise.all([g.get("/loan-products").catch(()=>({data:[]})),g.get("/branches").catch(()=>({data:[]})),g.get("/users",{params:{role:"loan_officer"}}).catch(()=>({data:[]}))]);v(Array.isArray(t.data)?t.data:t.data.items||[]),F(Array.isArray(a.data)?a.data:a.data.items||[]),T(Array.isArray(i.data)?i.data:i.data.items||[])}catch{}})()},[]),n.useEffect(()=>{const t=new AbortController;return(async()=>{var a,i;V(!0);try{const d=await g.get("/loans",{signal:t.signal,params:{q:R||void 0,stage:x||void 0,status:x==="approved"||x==="rejected"?x:void 0,productId:y||void 0,branchId:O||void 0,officerId:D||void 0,page:b,pageSize:$,sort:p,dir:h}}),j=((a=d.data)==null?void 0:a.items)||(Array.isArray(d.data)?d.data:[]);l(j),m(((i=d.data)==null?void 0:i.total)??j.length??0)}catch{l([]),m(0)}finally{V(!1)}})(),()=>t.abort()},[R,x,y,O,D,b,p,h]);const se=t=>c==="branch_manager"?"compliance_review":c==="compliance"||c==="admin"||c==="director"?"approved":t==="manager_review"?"compliance_review":"approved",P=t=>{const a=(t.stage||t.status||"").toLowerCase();return c==="branch_manager"?a==="manager_review"||a==="submitted"||!a:c==="compliance"?a==="compliance_review":c==="admin"||c==="director"?a==="manager_review"||a==="compliance_review"||a==="submitted":!1},Q=async(t,a)=>{try{return await g.patch(`/loans/${t}/stage`,a),!0}catch{try{if(a.action==="approve"){const d=a.nextStage==="approved";await g.patch(`/loans/${t}/status`,{status:d?"approved":"pending"})}else a.action==="reject"?await g.patch(`/loans/${t}/status`,{status:"rejected"}):a.action==="return"&&await g.patch(`/loans/${t}/status`,{status:"pending"});return a.comment&&await g.post("/comments",{loanId:t,content:a.comment}),!0}catch{return!1}}},re=async(t,a)=>{if(!P(t))return;A(!0);const i={action:"approve",fromStage:t.stage||t.status||"submitted",nextStage:se(t.stage),suggestedAmount:a||void 0},d=await Q(t.id,i);if(A(!1),!d)return alert("Failed to approve.");u(1),l(j=>j.filter(k=>k.id!==t.id))},ne=async(t,a)=>{if(!P(t))return;if(!(a!=null&&a.trim()))return alert("Please enter a short reason.");A(!0);const i={action:"reject",fromStage:t.stage||t.status||"submitted",nextStage:"rejected",comment:a},d=await Q(t.id,i);if(A(!1),!d)return alert("Failed to reject.");u(1),l(j=>j.filter(k=>k.id!==t.id))},le=async(t,a,i)=>{if(!P(t))return;if(!(a!=null&&a.trim()))return alert("Please enter a comment.");A(!0);const d={action:"return",fromStage:t.stage||t.status||"submitted",nextStage:"returned_with_comment",comment:a,suggestedAmount:i||void 0},j=await Q(t.id,d);if(A(!1),!j)return alert("Failed to return with comment.");u(1),l(k=>k.filter(de=>de.id!==t.id))},S=t=>{p===t?U(a=>a==="asc"?"desc":"asc"):(ee(t),U("asc"))},ce=n.useMemo(()=>o===0?0:(b-1)*$+1,[b,o]),ie=n.useMemo(()=>Math.min(b*$,o),[b,o]),oe=()=>{L(""),w(c==="compliance"?"compliance_review":c==="branch_manager"?"manager_review":"submitted"),W(""),H(""),J(""),u(1)};return e.jsxs("div",{className:s.wrap,children:[e.jsx("style",{children:`
        select.ms-select {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: none !important;
        }
        select.ms-select::-ms-expand { display: none; }
      `}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:s.h1,children:"Loan Review Queue"}),e.jsx("p",{className:s.sub,children:c==="branch_manager"?"Approve/return applications to Compliance.":c==="compliance"?"Compliance checks for policy/legal, then approve or return.":"Review and route loan applications by stage."})]}),e.jsx(Z,{to:"/loans",className:s.btn,title:"Back to Loans",children:"Back to Loans"})]}),e.jsxs("div",{className:`${s.card} p-4 mb-5`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 text-slate-700 font-semibold",children:[e.jsx(me,{className:"w-4 h-4"})," Filters"]}),e.jsx("button",{onClick:oe,className:"text-sm underline decoration-slate-300 hover:decoration-slate-600",children:"Clear all"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3",children:[e.jsx(Se,{value:N,onChange:t=>{L(t.target.value),u(1)},placeholder:"Search borrower, phone, product, loan #",leadingIcon:e.jsx(ue,{className:s.fieldIcon}),className:"xl:col-span-2"}),e.jsx(I,{value:x,onChange:t=>{w(t.target.value),u(1)},"aria-label":"Stage",children:Ne.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs(I,{value:y,onChange:t=>{W(t.target.value),u(1)},"aria-label":"Product",children:[e.jsx("option",{value:"",children:"All Products"}),f.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(I,{value:O,onChange:t=>{H(t.target.value),u(1)},"aria-label":"Branch",children:[e.jsx("option",{value:"",children:"All Branches"}),M.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs(I,{value:D,onChange:t=>{J(t.target.value),u(1)},"aria-label":"Officer",children:[e.jsx("option",{value:"",children:"All Officers"}),_.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]})]})]})]}),e.jsxs("div",{className:s.card,children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(C,{label:"Submitted",sortKey:"createdAt",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Borrower",sortKey:"borrowerName",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Product",sortKey:"productName",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Principal",sortKey:"amount",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Officer",sortKey:"officerName",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Branch",sortKey:"branchName",sort:p,dir:h,onSort:S}),e.jsx(C,{label:"Stage",sortKey:"stage",sort:p,dir:h,onSort:S}),e.jsx("th",{className:`${s.th} text-right`,children:"Actions"})]})}),e.jsx("tbody",{children:te?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:`${s.td} text-center py-10 text-slate-600`,children:"Loading…"})}):r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:`${s.td} text-center py-10 text-slate-600`,children:"No applications found."})}):r.map(t=>{var a,i;return e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:s.td,children:ye(t.createdAt)}),e.jsxs("td",{className:s.td,children:[e.jsx(Z,{to:`/borrowers/${t.borrowerId}`,className:"text-indigo-600 hover:underline",children:((a=t.Borrower)==null?void 0:a.name)||t.borrowerName||"—"}),e.jsx("div",{className:"text-xs text-slate-600",children:t.loanNumber?`Loan #${t.loanNumber}`:""})]}),e.jsx("td",{className:s.td,children:((i=t.Product)==null?void 0:i.name)||t.productName||"—"}),e.jsx("td",{className:s.td,children:Y(t.amount,t.currency||"TZS")}),e.jsx("td",{className:s.td,children:t.officerName||"—"}),e.jsx("td",{className:s.td,children:t.branchName||"—"}),e.jsx("td",{className:s.td,children:e.jsx("span",{className:`${s.chip} ${we((t.stage||t.status||"").toLowerCase())}`,children:(t.stage||t.status||"—").replaceAll("_"," ")})}),e.jsx("td",{className:`${s.td} text-right`,children:e.jsxs("div",{className:"inline-flex gap-1",children:[e.jsx(Z,{to:`/loans/${t.id}`,className:"px-2 py-1 text-xs rounded border-2 border-slate-300 hover:bg-slate-50",children:"View"}),P(t)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"px-2 py-1 text-xs rounded border-2 border-emerald-700 bg-emerald-600 text-white hover:bg-emerald-700 inline-flex items-center gap-1",onClick:()=>B({type:"approve",row:t}),children:[e.jsx(be,{className:"w-3.5 h-3.5"})," Approve"]}),e.jsxs("button",{className:"px-2 py-1 text-xs rounded border-2 border-amber-700 bg-amber-600 text-white hover:bg-amber-700 inline-flex items-center gap-1",onClick:()=>B({type:"return",row:t}),children:[e.jsx(fe,{className:"w-3.5 h-3.5"})," Return"]}),e.jsxs("button",{className:"px-2 py-1 text-xs rounded border-2 border-rose-700 bg-rose-600 text-white hover:bg-rose-700 inline-flex items-center gap-1",onClick:()=>B({type:"reject",row:t}),children:[e.jsx(X,{className:"w-3.5 h-3.5"})," Reject"]})]})]})})]},t.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-t-2 border-slate-300 text-sm",children:[e.jsxs("div",{className:"text-slate-600",children:[ce,"–",ie," of ",o]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(t=>Math.max(1,t-1)),disabled:b===1,className:"p-1 border-2 border-slate-300 rounded disabled:opacity-50",title:"Previous page",children:e.jsx(pe,{className:s.btnIcon})}),e.jsx("button",{onClick:()=>u(t=>t*$<o?t+1:t),disabled:b*$>=o,className:"p-1 border-2 border-slate-300 rounded disabled:opacity-50",title:"Next page",children:e.jsx(xe,{className:s.btnIcon})})]})]})]}),K&&e.jsx(Ce,{type:K.type,row:K.row,role:c,busy:ae,onClose:()=>B(null),onApprove:re,onReject:ne,onReturn:le})]})}const C=({label:r,sortKey:l,sort:o,dir:m,onSort:f})=>{const v=o===l;return e.jsx("th",{className:`${s.th} cursor-pointer`,onClick:()=>f(l),title:"Sort","aria-sort":v?m==="asc"?"ascending":"descending":"none",children:e.jsxs("span",{className:`inline-flex items-center gap-1 ${v?"text-indigo-700":""}`,children:[r,v?m==="asc"?"▲":"▼":""]})})};function Ce({type:r,row:l,role:o,busy:m,onClose:f,onApprove:v,onReject:M,onReturn:F}){var x,w;const[_,T]=n.useState(""),[N,L]=n.useState(""),R=r==="approve"?"Approve Application":r==="reject"?"Reject Application":"Return with Comment",E=o==="branch_manager"&&(r==="approve"||r==="return");return e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:f}),e.jsxs("div",{className:`relative ${s.card} w-[95%] max-w-lg p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:R}),e.jsx("button",{onClick:f,className:"p-1 rounded hover:bg-slate-50",title:"Close",children:e.jsx(X,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Borrower:"})," ",((x=l.Borrower)==null?void 0:x.name)||l.borrowerName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Product:"})," ",((w=l.Product)==null?void 0:w.name)||l.productName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Amount:"})," ",Y(l.amount,l.currency||"TZS")]})]}),E&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-600",children:"Suggested Amount (optional)"}),e.jsx("input",{type:"number",className:s.fieldBase,placeholder:"e.g. 500000",value:N,onChange:y=>L(y.target.value)}),e.jsx("p",{className:"text-[11px] text-slate-600 mt-1",children:"Branch Manager can suggest a different principal before forwarding to Compliance."})]}),r!=="approve"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-slate-600",children:"Comment"}),e.jsx("textarea",{className:`${s.fieldBase} min-h-[96px]`,placeholder:r==="reject"?"Reason for rejection…":"What needs to be updated…",value:_,onChange:y=>T(y.target.value)})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:f,className:s.btn,children:"Cancel"}),r==="approve"&&e.jsxs("button",{disabled:m,onClick:()=>v(l,N),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:[m&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Approve"]}),r==="return"&&e.jsxs("button",{disabled:m,onClick:()=>F(l,_,N),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700 disabled:opacity-60",children:[m&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Return"]}),r==="reject"&&e.jsxs("button",{disabled:m,onClick:()=>M(l,_),className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60",children:[m&&e.jsx(q,{className:"w-4 h-4 animate-spin"})," Reject"]})]})]})]})}export{Be as default};

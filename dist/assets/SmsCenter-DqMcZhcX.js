import{r as o,g as Y,j as s}from"./index-Bh87i4em.js";const W=new Intl.NumberFormat,X=u=>u?new Date(u).toLocaleString():"—",w=u=>Y.getFirst(u),S=(u,x)=>Y.postFirst(u,x);function ke(){const[u,x]=o.useState(!1),[k,d]=o.useState(""),[h,B]=o.useState({allowBodySender:!1,defaultSender:""}),[m,I]=o.useState(null),[F,T]=o.useState([]),Z=["Single","Borrowers","CRM Groups","CSV Upload"],[b,ee]=o.useState(0),[$,se]=o.useState(""),[M,A]=o.useState(""),[D,te]=o.useState(""),[y,ae]=o.useState(""),[E,C]=o.useState([]),[g,R]=o.useState([]),[V,ne]=o.useState("Hello {{name}}, …"),[L,re]=o.useState(""),[q,oe]=o.useState(""),[O,le]=o.useState(""),[U,ie]=o.useState(!1),[P,ce]=o.useState(""),[H,de]=o.useState("Dear {{name}}, …"),[G,me]=o.useState(""),[Q,_]=o.useState(null),[z,ue]=o.useState("Hello {{name}}, …"),[J,xe]=o.useState("");async function pe(){try{const e=await w(["/sms/capabilities","/communications/sms/capabilities","/notifications/sms/capabilities"]);B(e||{allowBodySender:!1,defaultSender:""})}catch{B({allowBodySender:!1,defaultSender:""})}}async function K(){d("");try{const e=await w(["/sms/balance","/billing/sms/balance","/notifications/sms/balance"]);I(e||null)}catch{I(null)}}async function f(){try{const e=await w(["/sms/messages","/notifications/sms/messages","/communications/sms"]),t=Array.isArray(e)?e:e.items||e.messages||[];T(t.slice(0,100))}catch{T([])}}o.useEffect(()=>{pe(),K(),f()},[]),o.useEffect(()=>{const e=setTimeout(async()=>{const t=y.trim();if(!t)return C([]);try{const a=await w([`/sms/recipients/borrowers?q=${encodeURIComponent(t)}&limit=20`,`/borrowers/search?q=${encodeURIComponent(t)}&limit=20`,`/borrowers?search=${encodeURIComponent(t)}&limit=20`])||{},c=(a.items||a.results||a.rows||[]).map(r=>({id:r.id??r.borrowerId??r._id??`${r.phone||r.msisdn}-${r.id||""}`,name:r.name||[r.firstName,r.lastName].filter(Boolean).join(" ")||r.fullName||"—",phone:r.phone||r.msisdn||r.mobile||r.phoneNumber||"",branchId:r.branchId??null}));C(c.filter(r=>r.phone))}catch{C([])}},300);return()=>clearTimeout(e)},[y]);const he=o.useMemo(()=>{if(!m)return"—";if(m.ok===!1)return m.error||"N/A";const e=m.creditsRounded??m.credits??(()=>{const n=m.raw||"",c=String(n).split(","),r=Number(c[1]);return Number.isFinite(r)?r:null})();if(e==null)return"Unknown";const t=m.estSegmentsLeft!=null?` (~${W.format(Math.floor(m.estSegmentsLeft))} SMS)`:"",a=m.unit||"credits";return`${W.format(Number(e.toFixed?e.toFixed(2):e))} ${a}${t}`},[m]),ge=(e,t={})=>String(e||"").replace(/\{\{(\w+)\}\}/g,(a,n)=>n in t?String(t[n]):"");async function fe(){const e=$.trim(),t=M.trim();if(!e||!t)return d("Phone and message are required.");x(!0),d("");try{const a=h.allowBodySender&&D||void 0,n=await S(["/sms/send","/communications/sms/send","/notifications/sms"],{to:e,message:t,text:t,from:a,senderId:a});if(n&&n.ok===!1)throw new Error(n.error||"Send failed");A(""),await f()}catch(a){d((a==null?void 0:a.message)||"Failed to send SMS.")}finally{x(!1)}}async function ve(){if(!g.length)return d("Pick at least one borrower.");const e=V.trim();if(!e)return d("Message is required.");x(!0),d("");try{const t=h.allowBodySender&&L||void 0,a=g.map(c=>{const r=c.name||"",[j,...l]=r.split(" ");return{to:c.phone,vars:{name:r,firstName:j,lastName:l.join(" ")},from:t}}),n=await S(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:a,template:e,defaultFrom:t});if(!n||n.ok===!1)for(const c of a)await S(["/sms/send","/communications/sms/send","/notifications/sms"],{to:c.to,message:ge(e,c.vars||{}),from:t,senderId:t});R([]),await f()}catch(t){d((t==null?void 0:t.message)||"Bulk send failed.")}finally{x(!1)}}async function Se(){const e=H.trim();if(!e)return d("Template is required.");x(!0),d("");const t={branchId:q||void 0,loanStatus:O||void 0,overdueOnly:!!U,officerId:P||void 0,limit:500},a=h.allowBodySender&&G||void 0;try{try{const i=await S(["/sms/to-segment"],{filter:t,template:e,from:a});if(i&&i.ok){await f(),x(!1);return}}catch{}const n=new URLSearchParams({limit:"500",branchId:t.branchId||""}).toString(),c=await w([`/sms/recipients/borrowers?${n}`,`/borrowers?${n}`])||{},l=(c.items||c.results||c.rows||[]||[]).map(i=>({name:i.name||[i.firstName,i.lastName].filter(Boolean).join(" "),phone:i.phone||i.msisdn||i.mobile})).filter(i=>i.phone).map(i=>{const[v,...p]=(i.name||"").split(" ");return{to:i.phone,vars:{name:i.name,firstName:v,lastName:p.join(" ")},from:a}});if(!l.length)throw new Error("No recipients matched the selected filters.");await S(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:l,template:e,defaultFrom:a}),await f()}catch(n){d((n==null?void 0:n.message)||"Segment send failed.")}finally{x(!1)}}async function be(){if(!Q)return d("Choose a CSV first.");x(!0),d("");try{const t=(await Q.text()).split(/\r?\n/).filter(l=>l.trim().length);if(t.length===0)throw new Error("Empty CSV.");const a=t[0].split(",").map(l=>l.trim().replace(/^"|"$/g,"")),n=(l,i)=>{const v=a.findIndex(p=>p.toLowerCase()===i.toLowerCase());return v<0?"":(l[v]||"").replace(/^"|"$/g,"").trim()},c=t.slice(1).map(l=>l.split(",")),r=h.allowBodySender&&J||void 0,j=c.map(l=>{const i=n(l,"phone")||n(l,"msisdn")||n(l,"number"),v=n(l,"message"),p=n(l,"name"),we=n(l,"firstName")||(p?p.split(" ")[0]:""),Ne=n(l,"lastName")||(p?p.split(" ").slice(1).join(" "):"");return{to:i,message:v||void 0,vars:{name:p,firstName:we,lastName:Ne},from:r}}).filter(l=>l.to);if(!j.length)throw new Error("No valid rows (need a 'phone' column).");await S(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:j,template:z||void 0,defaultFrom:r}),_(null),await f()}catch(e){d((e==null?void 0:e.message)||"CSV upload failed.")}finally{x(!1)}}function je(){return s.jsx("div",{className:"rounded-2xl border p-4 shadow-sm bg-white",children:s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-500",children:"Balance"}),s.jsx("div",{className:"text-2xl font-semibold",children:he}),(m==null?void 0:m.checkedAt)&&s.jsxs("div",{className:"text-xs text-gray-400",children:["Checked ",X(m.checkedAt)]})]}),s.jsx("button",{onClick:K,className:"px-3 py-2 rounded-xl border hover:bg-gray-50",children:"Refresh"})]})})}const N=({label:e})=>h.allowBodySender?s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:`${e} (optional)`,value:e.includes("Single")?D:e.includes("Borrower")?L:e.includes("CSV")?J:G,onChange:t=>{const a=t.target.value;e.includes("Single")?te(a):e.includes("Borrower")?re(a):e.includes("CSV")?xe(a):me(a)}}):s.jsxs("div",{className:"text-xs text-gray-500",children:["Sender: ",s.jsx("span",{className:"font-medium",children:h.defaultSender||"System"})," (locked)"]});return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 p-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"SMS Center"}),s.jsx(je,{}),s.jsxs("div",{className:"rounded-2xl border bg-white",children:[s.jsx("div",{className:"grid grid-cols-4 text-sm font-medium border-b",children:Z.map((e,t)=>s.jsx("button",{className:`px-4 py-3 text-left ${t===b?"bg-gray-50 border-b-2 border-black":""}`,onClick:()=>ee(t),children:e},e))}),b===0&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:"Phone number (e.g. 0784…, +255…)",value:$,onChange:e=>se(e.target.value)}),s.jsx(N,{label:"Single Sender ID"})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Message text",value:M,onChange:e=>A(e.target.value)}),s.jsx("button",{disabled:u,onClick:fe,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:u?"Sending…":"Send"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Tip: avoid emojis to keep it single-segment (GSM-7)."})]}),b===1&&s.jsxs("div",{className:"p-4 space-y-4",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Search borrowers by name, phone, NID, account…",value:y,onChange:e=>ae(e.target.value)}),s.jsx(N,{label:"Borrower Sender ID"})]}),E.length>0&&s.jsx("div",{className:"max-h-52 overflow-auto border rounded-xl",children:E.map(e=>{const t=g.some(a=>a.id===e.id);return s.jsxs("label",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:()=>R(a=>t?a.filter(n=>n.id!==e.id):[...a,e])}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.phone})]})]},e.id)})}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Hello {{name}}, your loan is due…",value:V,onChange:e=>ne(e.target.value)}),s.jsxs("div",{className:"text-xs text-gray-500",children:["Variables: ","{{name}}"," ","{{firstName}}"," ","{{lastName}}"]}),s.jsxs("button",{disabled:u||g.length===0,onClick:ve,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:["Send to ",g.length," borrower",g.length===1?"":"s"]})]}),b===2&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-5 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Branch ID",value:q,onChange:e=>oe(e.target.value)}),s.jsxs("select",{className:"rounded-xl border p-2",value:O,onChange:e=>le(e.target.value),children:[s.jsx("option",{value:"",children:"Any status"}),s.jsx("option",{value:"active",children:"Active"}),s.jsx("option",{value:"closed",children:"Closed"}),s.jsx("option",{value:"defaulted",children:"Defaulted"})]}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:U,onChange:e=>ie(e.target.checked)}),"In arrears"]}),s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Loan officer (ID/name)",value:P,onChange:e=>ce(e.target.value)}),s.jsx(N,{label:"Segment Sender ID"})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Dear {{name}}, …",value:H,onChange:e=>de(e.target.value)}),s.jsx("button",{disabled:u,onClick:Se,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Send to group"}),s.jsx("div",{className:"text-xs text-gray-500",children:"Server tries to honor CRM filters (status, arrears, officer). If not supported in this environment, the app falls back to a basic borrower list."})]}),b===3&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 items-center",children:[s.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var t;return _(((t=e.target.files)==null?void 0:t[0])||null)}}),s.jsx(N,{label:"CSV Sender ID"})]}),s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-24",placeholder:"Optional template (uses CSV column names: Hello {{name}})",value:z,onChange:e=>ue(e.target.value)}),s.jsxs("div",{className:"text-xs text-gray-500",children:["CSV columns: ",s.jsx("code",{children:"phone"}),", ",s.jsx("code",{children:"message"})," (optional), ",s.jsx("code",{children:"name"}),", ",s.jsx("code",{children:"firstName"}),", ",s.jsx("code",{children:"lastName"}),"…"]}),s.jsx("button",{disabled:u,onClick:be,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Upload & Send"})]})]}),k?s.jsx("div",{className:"rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm",children:k}):null,s.jsxs("div",{className:"rounded-2xl border bg-white p-4",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Recent Messages"}),F.length===0?s.jsx("div",{className:"text-gray-500 text-sm",children:"No messages yet."}):s.jsx("div",{className:"divide-y",children:F.map((e,t)=>s.jsxs("div",{className:"py-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("div",{className:"font-medium",children:e.to||e.phone||e.msisdn}),s.jsx("div",{className:`text-xs ${(e.status||"").includes("fail")?"text-rose-600":(e.status||"").includes("queued")?"text-emerald-600":"text-gray-500"}`,children:e.status||e.deliveryStatus||"—"})]}),s.jsx("div",{className:"text-gray-600",children:e.message||e.text||e.body||""}),s.jsx("div",{className:"text-xs text-gray-400",children:X(e.at||e.createdAt||e.sentAt||e.timestamp)})]},e.id||e.messageId||t))})]})]})}export{ke as default};

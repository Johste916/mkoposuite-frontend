import{u as Y,r as s,j as t,L as q,g as x}from"./index-DUtn1vUj.js";import{E as z}from"./jspdf.es.min-fFA32OMh.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as G}from"./index-D3JQhLyd.js";const X=()=>{const S=Y(),[j,k]=s.useState([]),[A,D]=s.useState([]),[h,B]=s.useState([]),[C,v]=s.useState(!1),[i,P]=s.useState(""),[u,L]=s.useState("all"),[p,F]=s.useState(""),[m,R]=s.useState(""),[o,$]=s.useState(""),[l,I]=s.useState(""),y=async()=>{var e;v(!0);try{const a=await x.get("/loans");k(Array.isArray(a.data)?a.data:((e=a.data)==null?void 0:e.items)||[])}catch{alert("Failed to load loans")}finally{v(!1)}},M=async()=>{var e;try{const a=await x.get("/branches");D(Array.isArray(a.data)?a.data:((e=a.data)==null?void 0:e.items)||[])}catch{}},E=async()=>{try{const e=await x.get("/loan-products");B(Array.isArray(e.data)?e.data:e.data.items||[])}catch{}};s.useEffect(()=>{y(),M(),E()},[]);const g=s.useMemo(()=>Object.fromEntries((h||[]).map(e=>[String(e.id),e])),[h]),T=e=>{const a=e.startDate||e.createdAt;if(!a||!o&&!l)return!0;const r=new Date(a);if(o&&r<new Date(o))return!1;if(l){const n=new Date(l);if(n.setHours(23,59,59,999),r>n)return!1}return!0},c=s.useMemo(()=>(j||[]).filter(e=>{var f,w;const a=u==="all"||e.status===u,r=(((f=e.Borrower)==null?void 0:f.name)||"").toLowerCase().includes(i.toLowerCase())||String(e.id||"").includes(i.trim()),n=!p||String(e.branchId||((w=e.branch)==null?void 0:w.id))===String(p),U=!m||String(e.productId)===String(m);return a&&r&&n&&U&&T(e)}),[j,u,i,p,m,o,l]),d=s.useMemo(()=>{const e=c.reduce((r,n)=>r+Number(n.amount||0),0),a=r=>c.filter(n=>n.status===r).length;return{total:c.length,totalPrincipal:e,pending:a("pending"),approved:a("approved"),disbursed:a("disbursed"),active:a("active"),closed:a("closed"),rejected:a("rejected")}},[c]),b=async(e,a)=>{try{await x.patch(`/loans/${e}/${a}`),y()}catch{alert(`Failed to ${a} loan`)}},N=s.useMemo(()=>c.map(e=>{var a,r,n;return{id:e.id,borrower:((a=e.Borrower)==null?void 0:a.name)||"",product:((r=g[String(e.productId)])==null?void 0:r.name)||"",amount:e.amount,rate:e.interestRate,termMonths:e.termMonths,branch:((n=e.branch)==null?void 0:n.name)||"",status:e.status,startDate:e.startDate}}),[c,g]),V=[{label:"Loan ID",key:"id"},{label:"Borrower",key:"borrower"},{label:"Product",key:"product"},{label:"Amount",key:"amount"},{label:"Rate (%)",key:"rate"},{label:"Term (months)",key:"termMonths"},{label:"Branch",key:"branch"},{label:"Status",key:"status"},{label:"Start Date",key:"startDate"}],H=()=>{const e=new z;e.text("Loans Report",14,16),e.autoTable({startY:20,head:[["ID","Borrower","Product","Amount","Rate","Term","Branch","Status"]],body:N.map(a=>[a.id,a.borrower,a.product,a.amount,a.rate,a.termMonths,a.branch,a.status])}),e.save("loans.pdf")},O=e=>{const a="px-2 py-1 rounded text-xs font-semibold";switch(e){case"pending":return`${a} bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300`;case"approved":return`${a} bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300`;case"rejected":return`${a} bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300`;case"disbursed":case"active":return`${a} bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300`;case"closed":return`${a} bg-gray-100 text-gray-700 dark:bg-gray-800/60 dark:text-gray-300`;default:return`${a} bg-gray-200 text-gray-600 dark:bg-gray-800/60 dark:text-gray-300`}};return t.jsxs("div",{className:"p-4 space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl font-bold",children:"All Loans"}),t.jsx(q,{className:"text-indigo-600 hover:underline text-sm",to:"/loans/applications",children:"New Application"})]}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Total"}),t.jsx("p",{className:"text-lg font-semibold",children:d.total})]}),t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Principal"}),t.jsx("p",{className:"text-lg font-semibold",children:d.totalPrincipal})]}),t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Pending"}),t.jsx("p",{className:"text-lg font-semibold",children:d.pending})]}),t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Approved"}),t.jsx("p",{className:"text-lg font-semibold",children:d.approved})]}),t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Disbursed"}),t.jsx("p",{className:"text-lg font-semibold",children:d.disbursed})]}),t.jsxs("div",{className:"card p-3",children:[t.jsx("p",{className:"text-xs muted",children:"Active"}),t.jsx("p",{className:"text-lg font-semibold",children:d.active})]})]}),t.jsxs("div",{className:"card p-4 grid grid-cols-1 md:grid-cols-6 gap-3",children:[t.jsx("input",{type:"text",placeholder:"Search borrower or loan ID…",value:i,onChange:e=>P(e.target.value),className:"input md:col-span-2"}),t.jsxs("select",{value:u,onChange:e=>L(e.target.value),className:"input",children:[t.jsx("option",{value:"all",children:"All Statuses"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"approved",children:"Approved"}),t.jsx("option",{value:"disbursed",children:"Disbursed"}),t.jsx("option",{value:"active",children:"Active"}),t.jsx("option",{value:"rejected",children:"Rejected"}),t.jsx("option",{value:"closed",children:"Closed"})]}),t.jsxs("select",{value:p,onChange:e=>F(e.target.value),className:"input",children:[t.jsx("option",{value:"",children:"All Branches"}),A.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:m,onChange:e=>R(e.target.value),className:"input",children:[t.jsx("option",{value:"",children:"All Products"}),h.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("input",{type:"date",value:o,onChange:e=>$(e.target.value),className:"input"}),t.jsx("input",{type:"date",value:l,onChange:e=>I(e.target.value),className:"input"}),t.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[t.jsx(G,{data:N,headers:V,filename:"loans.csv",className:"px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700",children:"Export CSV"}),t.jsx("button",{onClick:H,className:"px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700",children:"Export PDF"})]})]}),t.jsx("div",{className:"card overflow-x-auto",children:C?t.jsx("p",{className:"p-4 muted",children:"Loading loans…"}):c.length===0?t.jsx("p",{className:"p-4 muted",children:"No loans found."}):t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"text-[var(--fg)]",children:t.jsx("tr",{children:["ID","Borrower","Product","Amount","Rate (%)","Term","Branch","Start Date","Status","Actions"].map(e=>t.jsx("th",{className:"p-2 border-b border-[var(--border)] text-left",children:e},e))})}),t.jsx("tbody",{children:c.map(e=>{var a,r,n;return t.jsxs("tr",{className:"border-b border-[var(--border)] hover:bg-gray-50 dark:hover:bg-slate-800",children:[t.jsx("td",{className:"px-2 py-2",children:e.id}),t.jsx("td",{className:"px-2 py-2",children:((a=e.Borrower)==null?void 0:a.name)||"N/A"}),t.jsx("td",{className:"px-2 py-2",children:((r=g[String(e.productId)])==null?void 0:r.name)||"—"}),t.jsx("td",{className:"px-2 py-2",children:e.amount}),t.jsx("td",{className:"px-2 py-2",children:e.interestRate}),t.jsx("td",{className:"px-2 py-2",children:e.termMonths}),t.jsx("td",{className:"px-2 py-2",children:((n=e.branch)==null?void 0:n.name)||"—"}),t.jsx("td",{className:"px-2 py-2",children:e.startDate||"—"}),t.jsx("td",{className:"px-2 py-2",children:t.jsx("span",{className:O(e.status),children:e.status})}),t.jsxs("td",{className:"px-2 py-2 space-x-2",children:[t.jsx("button",{onClick:()=>S(`/loans/${e.id}`),className:"text-indigo-600 hover:underline",children:"View"}),e.status==="pending"&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>b(e.id,"approve"),className:"text-emerald-600 hover:underline",children:"Approve"}),t.jsx("button",{onClick:()=>b(e.id,"reject"),className:"text-rose-600 hover:underline",children:"Reject"})]}),e.status==="approved"&&t.jsx("button",{onClick:()=>b(e.id,"disburse"),className:"text-indigo-600 hover:underline",children:"Disburse"})]})]},e.id)})})]})})]})};export{X as default};

import{r,l as F,u as I,g as p,j as e}from"./index-CYBEjh8Z.js";const $=l=>{var d;return!!l&&(l.role==="admin"||l.role==="director"||((d=l.permissions)==null?void 0:d.includes("payroll:run")))};function Y(){const[l,d]=r.useState(null),[q,E]=r.useState([]),[x,b]=r.useState(""),[h,g]=r.useState(""),[y,N]=r.useState([]),[P,R]=r.useState(!0),[v,c]=r.useState(""),[f,j]=r.useState(!1),[S]=F(),A=I(),w=r.useMemo(()=>l?$(l):!0,[l]);r.useEffect(()=>{let s=!1;return(async()=>{var a,t,o,i;try{const[n,m]=await Promise.allSettled([p.get("/auth/me"),p.get("/hr/employees",{params:{active:1,limit:1e3}})]);if(s)return;n.status==="fulfilled"&&d(n.value.data||null);const C=(m.status==="fulfilled"?((a=m.value.data)==null?void 0:a.items)||[]:[]).map(u=>({employeeId:u.id,name:`${u.firstName} ${u.lastName}`,base:Number(u.baseSalary||0),allowances:0,deductions:0,overtime:0,advances:0,savings:0,loans:0}));E(m.status==="fulfilled"?((t=m.value.data)==null?void 0:t.items)||[]:[]),N(C)}catch(n){c(((i=(o=n==null?void 0:n.response)==null?void 0:o.data)==null?void 0:i.message)||n.message)}finally{R(!1)}})(),()=>s=!0},[]),r.useEffect(()=>{const s=S.get("clone");s&&(async()=>{try{const{data:a}=await p.get(`/hr/payroll/runs/${s}`);b((a==null?void 0:a.periodFrom)||(a==null?void 0:a.periodStart)||""),g((a==null?void 0:a.periodTo)||(a==null?void 0:a.periodEnd)||""),Array.isArray(a==null?void 0:a.lines)&&N(a.lines)}catch{}})()},[S]);const L=s=>Number(s.base||0)+Number(s.allowances||0)+Number(s.overtime||0)-Number(s.deductions||0)-Number(s.advances||0)-Number(s.savings||0)-Number(s.loans||0),T=async()=>{var s,a;if(!w){c("You don't have permission to run payroll.");return}if(!x||!h){c("Select a period");return}j(!0),c("");try{const t={periodFrom:x,periodTo:h,lines:y},{data:o}=await p.post("/hr/payroll/runs",t);A(`/payroll/report?runId=${o.runId}`)}catch(t){c(((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||t.message||"Payroll failed.")}finally{j(!1)}};return P?e.jsx("div",{className:"p-4",children:"Loading…"}):w?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Run Payroll"}),v&&e.jsx("div",{className:"text-sm text-red-600",children:v}),e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Period From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:x,onChange:s=>b(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Period To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:h,onChange:s=>g(s.target.value)})]}),e.jsx("button",{onClick:T,disabled:f,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:f?"Running…":"Run"})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Employee"}),e.jsx("th",{className:"py-2 px-3",children:"Base"}),e.jsx("th",{className:"py-2 px-3",children:"Allowances"}),e.jsx("th",{className:"py-2 px-3",children:"Overtime"}),e.jsx("th",{className:"py-2 px-3",children:"Deductions"}),e.jsx("th",{className:"py-2 px-3",children:"Advances"}),e.jsx("th",{className:"py-2 px-3",children:"Savings"}),e.jsx("th",{className:"py-2 px-3",children:"Loans"}),e.jsx("th",{className:"py-2 px-3",children:"Net"})]})}),e.jsx("tbody",{children:y.map((s,a)=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:s.name}),["base","allowances","overtime","deductions","advances","savings","loans"].map(t=>e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-28",value:s[t],onChange:o=>{const i=[...y];i[a]={...i[a],[t]:Number(o.target.value||0)},N(i)}})},t)),e.jsxs("td",{className:"py-2 px-3 font-medium",children:["TZS ",L(s).toLocaleString()]})]},s.employeeId))})]})})]}):e.jsx("div",{className:"p-4 text-red-600",children:"You don't have permission to run payroll."})}export{Y as default};

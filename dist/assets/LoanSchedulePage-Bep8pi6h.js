const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-Bimy6-v5.js","assets/index-DQxdAjNY.js","assets/index-IEvDIlVn.css"])))=>i.map(i=>d[i]);
import{r as v,j as e,g as $,_ as Y}from"./index-DQxdAjNY.js";const n=(l,j="TZS")=>`‎${j} ${Number(l||0).toLocaleString()}`,V=l=>l?new Date(l).toLocaleDateString():"—",K=l=>l?new Date(l).toISOString().slice(0,10):"";function q(l=[],j=0){let t=Number(j||0),w=0,a=0,E=0,P=0;for(const S of l){const s=Number(S.fee??S.fees??0),C=Number(S.penalty??0),k=Number(S.interest??0),B=Number(S.principal??0);if(t<=0)break;const L=Math.min(t,s);if(P+=L,t-=L,t<=0)break;const _=Math.min(t,C);if(E+=_,t-=_,t<=0)break;const F=Math.min(t,k);if(a+=F,t-=F,t<=0)break;const A=Math.min(t,B);w+=A,t-=A}return{paidPrincipal:w,paidInterest:a,paidPenalty:E,paidFees:P}}async function J(){var j,t;let l={name:"MkopoSuite",address:"",phone:"",email:"",website:"",logoUrl:""};try{const a=(await $.get("/settings")).data||{};return l={name:a.companyName||a.name||l.name,address:a.companyAddress||a.address||l.address,phone:a.companyPhone||a.phone||l.phone,email:a.companyEmail||a.email||l.email,website:a.companyWebsite||a.website||l.website,logoUrl:a.logoUrl||a.companyLogoUrl||l.logoUrl},l}catch{}try{const a=((j=(await $.get("/account")).data)==null?void 0:j.settings)||{};return l={name:a.companyName||a.name||l.name,address:a.companyAddress||a.address||l.address,phone:a.companyPhone||a.phone||l.phone,email:a.companyEmail||a.email||l.email,website:a.companyWebsite||a.website||l.website,logoUrl:a.logoUrl||a.companyLogoUrl||l.logoUrl},l}catch{}try{const a=((t=(await $.get("/settings/sidebar")).data)==null?void 0:t.app)||{};l.name=a.name||l.name,l.logoUrl=a.logoUrl||l.logoUrl}catch{}return l}function ee(){const[l,j]=v.useState(""),[t,w]=v.useState(null),[a,E]=v.useState([]),[P,S]=v.useState(""),[s,C]=v.useState("TZS"),[k,B]=v.useState([]),[L,_]=v.useState(!1),[F,A]=v.useState(!0),[m,W]=v.useState({name:"MkopoSuite",address:"",phone:"",email:"",website:"",logoUrl:""}),T=v.useRef(null);v.useEffect(()=>{J().then(W).catch(()=>{})},[]);const R=async d=>{var b,c;if(d){_(!0);try{const u=(await $.get(`/loans/${d}/schedule`)).data||{},p=Array.isArray(u)?u:u.schedule||[];E(p),S(u.interestMethod||u.method||""),u.currency&&C(u.currency);const y=await $.get(`/loans/${d}`);w(y.data||null),(b=y.data)!=null&&b.currency&&C(y.data.currency);const g=await $.get(`/repayments/loan/${d}`).then(o=>o.data||[]).catch(()=>[]);B(g);const f=((g==null?void 0:g.length)||0)>0,N=(((c=y.data)==null?void 0:c.status)||"").toLowerCase();if(f&&N&&!["active","closed"].includes(N))try{await $.patch(`/loans/${d}/status`,{status:"active"});const o=await $.get(`/loans/${d}`);w(o.data||y.data||null)}catch{}window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:d}}))}catch{E([]),B([]),w(null),S("")}finally{_(!1)}}},G=async d=>{d.preventDefault(),await R(l.trim())};v.useEffect(()=>{const d=()=>l&&R(l.trim());return window.addEventListener("focus",d),()=>window.removeEventListener("focus",d)},[l]),v.useEffect(()=>{if(!(!l||!F))return T.current&&clearInterval(T.current),T.current=setInterval(()=>R(l.trim()),1e4),()=>T.current&&clearInterval(T.current)},[l,F]);const i=v.useMemo(()=>{const d=(h,D)=>h.reduce((O,I)=>O+Number((I==null?void 0:I[D])||0),0),b=d(a,"principal"),c=d(a,"interest"),x=d(a,"penalty"),u=d(a,"fee")+d(a,"fees"),p=d(a,"total")||b+c+x+u,y=k.reduce((h,D)=>h+Number(D.amount||0),0),g=d(a,"paidPrincipal")||0,f=d(a,"paidInterest")||0,N=d(a,"paidPenalty")||0,o=d(a,"paidFees")+d(a,"paidFee")||0,z=g+f+N+o>0?{paidPrincipal:g,paidInterest:f,paidPenalty:N,paidFees:o}:q(a,y),M=Math.max(p-y,0),r=a.find(h=>h.paid||h.settled?!1:Number(h.balance??Number(h.total||0))>0)||null;return{scheduledPrincipal:b,scheduledInterest:c,scheduledPenalty:x,scheduledFees:u,scheduledTotal:p,totalPaid:y,...z,outstandingTotal:M,nextDue:r?{idx:r.installment??r.period??a.indexOf(r)+1,date:r.dueDate||r.date||null,amount:Number(r.total??0)}:null}},[a,k]),H=()=>{var N;if(!a.length)return;const d=[["Company",m.name],["Address",m.address],["Phone",m.phone],["Email",m.email],["Website",m.website],[],["Loan ID",(t==null?void 0:t.id)??l],["Borrower",((N=t==null?void 0:t.Borrower)==null?void 0:N.name)||(t==null?void 0:t.borrowerName)||""],["Status",(t==null?void 0:t.status)||""],["Currency",s],["Interest Method",P],["Generated At",new Date().toLocaleString()],[]],b=["Installment","Due Date","Principal","Interest","Penalty","Fees","Total","Balance","Settled"],c=a.map((o,U)=>[o.installment??o.period??U+1,K(o.dueDate??o.date??""),Number(o.principal??0),Number(o.interest??0),Number(o.penalty??0),Number(o.fee??o.fees??0),Number(o.total??Number(o.principal||0)+Number(o.interest||0)+Number(o.penalty||0)+Number(o.fee??o.fees??0)),o.balance??"",o.paid||o.settled?"YES":"NO"]),x=[[],["Totals","",i.scheduledPrincipal,i.scheduledInterest,i.scheduledPenalty,i.scheduledFees,i.scheduledTotal,"",""],["Paid (alloc.)","",i.paidPrincipal,i.paidInterest,i.paidPenalty,i.paidFees,i.totalPaid,"",""],["Outstanding","","","","","",i.outstandingTotal,"",""]],p=[...d,b,...c,...x].map(o=>o.map(U=>`"${String(U??"").replace(/"/g,'""')}"`).join(",")).join(`
`),y=new Blob([p],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(y),f=document.createElement("a");f.href=g,f.download=`loan_${(t==null?void 0:t.id)??l}_schedule.csv`,f.click(),URL.revokeObjectURL(g)},Z=async()=>{var z,M;if(!a.length)return;let d,b;try{d=(await Y(async()=>{const{default:r}=await import("./jspdf.es.min-Bimy6-v5.js").then(h=>h.j);return{default:r}},__vite__mapDeps([0,1,2]))).default,b=(await Y(async()=>{const{default:r}=await import("./jspdf.plugin.autotable-CfO62xhj.js");return{default:r}},[])).default}catch{return X()}const c=new d({unit:"pt",format:"a4"}),x=c.internal.pageSize.getWidth(),u=40;let p=40;if(m.logoUrl)try{const r=await fetch(m.logoUrl).then(I=>I.blob()),h=new FileReader,D=new Promise(I=>{h.onload=()=>I(h.result)});h.readAsDataURL(r);const O=await D;c.addImage(O,"PNG",u,p,120,40)}catch{}c.setFontSize(14),c.text(m.name||"Company",u,p+65),c.setFontSize(10),[m.address,[m.phone,m.email].filter(Boolean).join("  •  "),m.website].filter(Boolean).forEach((r,h)=>c.text(String(r),u,p+80+h*14)),c.setFontSize(16),c.text("Loan Repayment Schedule",x-40,50,{align:"right"}),c.setFontSize(10),[`Loan ID: ${(t==null?void 0:t.id)??l}`,`Borrower: ${((z=t==null?void 0:t.Borrower)==null?void 0:z.name)||(t==null?void 0:t.borrowerName)||""}`,`Status: ${(t==null?void 0:t.status)||""}`,`Currency: ${s}`,`Interest Method: ${P||""}`,`Generated: ${new Date().toLocaleString()}`].forEach((r,h)=>c.text(r,x-40,68+h*14,{align:"right"}));const f=[{header:"#",dataKey:"idx"},{header:"Due Date",dataKey:"dueDate"},{header:"Principal",dataKey:"principal"},{header:"Interest",dataKey:"interest"},{header:"Penalty",dataKey:"penalty"},{header:"Fees",dataKey:"fees"},{header:"Total",dataKey:"total"},{header:"Balance",dataKey:"balance"},{header:"Settled",dataKey:"settled"}],N=a.map((r,h)=>{const D=r.total??Number(r.principal||0)+Number(r.interest||0)+Number(r.penalty||0)+Number(r.fee??r.fees??0);return{idx:r.installment??r.period??h+1,dueDate:K(r.dueDate??r.date??""),principal:n(r.principal,s),interest:n(r.interest,s),penalty:n(r.penalty||0,s),fees:n(r.fee??r.fees??0,s),total:n(D,s),balance:r.balance!=null?n(r.balance,s):"—",settled:r.paid||r.settled?"YES":"NO"}});b(c,{head:[f.map(r=>r.header)],body:N.map(r=>f.map(h=>r[h.dataKey])),startY:140,styles:{fontSize:9},headStyles:{fillColor:[243,244,246],textColor:20},alternateRowStyles:{fillColor:[250,250,250]},margin:{left:40,right:40},didDrawPage:()=>{const r=`Page ${c.internal.getNumberOfPages()}`;c.setFontSize(9),c.text(r,x-40,c.internal.pageSize.getHeight()-20,{align:"right"})}});let o=((M=c.lastAutoTable)==null?void 0:M.finalY)||140;o+=16,c.setFontSize(11),c.text("Summary",40,o),o+=8,c.setFontSize(10),[["Principal (Sched.)",n(i.scheduledPrincipal,s)],["Interest (Sched.)",n(i.scheduledInterest,s)],["Penalty (Sched.)",n(i.scheduledPenalty,s)],["Fees (Sched.)",n(i.scheduledFees,s)],["Total Payable",n(i.scheduledTotal,s)],["Paid Principal",n(i.paidPrincipal,s)],["Paid Interest",n(i.paidInterest,s)],["Paid Penalties",n(i.paidPenalty,s)],["Paid Fees",n(i.paidFees,s)],["Total Paid",n(i.totalPaid,s)],["Outstanding",n(i.outstandingTotal,s)]].forEach((r,h)=>{c.text(r[0],40,o+16+h*14),c.text(r[1],x-40,o+16+h*14,{align:"right"})}),c.save(`loan_${(t==null?void 0:t.id)??l}_schedule.pdf`)},X=()=>{var u;const d=a.map((p,y)=>{const g=p.total??Number(p.principal||0)+Number(p.interest||0)+Number(p.penalty||0)+Number(p.fee??p.fees??0);return`
          <tr>
            <td>${p.installment??p.period??y+1}</td>
            <td>${K(p.dueDate??p.date??"")}</td>
            <td>${n(p.principal,s)}</td>
            <td>${n(p.interest,s)}</td>
            <td>${n(p.penalty||0,s)}</td>
            <td>${n(p.fee??p.fees??0,s)}</td>
            <td>${n(g,s)}</td>
            <td>${p.balance!=null?n(p.balance,s):"—"}</td>
            <td>${p.paid||p.settled?"YES":"NO"}</td>
          </tr>
        `}).join(""),b=m.logoUrl?`<img src="${m.logoUrl}" style="height:48px;object-fit:contain;margin-right:12px;" />`:"",c=`
      <html>
        <head>
          <meta charset="utf-8" />
          <title>Loan ${(t==null?void 0:t.id)??l} Schedule</title>
          <style>
            body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; color:#111827; }
            .container { max-width: 960px; margin: 24px auto; }
            .header { display:flex; align-items:center; justify-content:space-between; }
            .company { display:flex; align-items:center; }
            .company h1 { margin:0; font-size:18px; }
            .muted { color:#6B7280; font-size:12px; }
            table { width:100%; border-collapse: collapse; margin-top: 16px; }
            th, td { border: 1px solid #E5E7EB; padding: 6px 8px; font-size: 12px; }
            thead { background:#F3F4F6; }
            .summary { margin-top:16px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; }
            .card { border:1px solid #E5E7EB; padding:8px 10px; border-radius:8px; }
            @media print { .no-print { display:none; } }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <div class="company">
                ${b}
                <div>
                  <h1>${m.name||""}</h1>
                  <div class="muted">
                    ${[m.address,m.phone,m.email,m.website].filter(Boolean).join(" • ")}
                  </div>
                </div>
              </div>
              <div>
                <div style="font-weight:600;">Loan Repayment Schedule</div>
                <div class="muted">Generated: ${new Date().toLocaleString()}</div>
              </div>
            </div>

            <div style="margin-top:12px;font-size:12px;">
              <div><b>Loan ID:</b> ${(t==null?void 0:t.id)??l}</div>
              <div><b>Borrower:</b> ${((u=t==null?void 0:t.Borrower)==null?void 0:u.name)||(t==null?void 0:t.borrowerName)||""}</div>
              <div><b>Status:</b> ${(t==null?void 0:t.status)||""}</div>
              <div><b>Currency:</b> ${s} &nbsp; • &nbsp; <b>Interest Method:</b> ${P||""}</div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Due Date</th>
                  <th>Principal</th>
                  <th>Interest</th>
                  <th>Penalty</th>
                  <th>Fees</th>
                  <th>Total</th>
                  <th>Balance</th>
                  <th>Settled</th>
                </tr>
              </thead>
              <tbody>
                ${d}
              </tbody>
            </table>

            <div class="summary">
              <div class="card"><div class="muted">Principal (Sched.)</div><div><b>${n(i.scheduledPrincipal,s)}</b></div></div>
              <div class="card"><div class="muted">Interest (Sched.)</div><div><b>${n(i.scheduledInterest,s)}</b></div></div>
              <div class="card"><div class="muted">Penalty (Sched.)</div><div><b>${n(i.scheduledPenalty,s)}</b></div></div>
              <div class="card"><div class="muted">Fees (Sched.)</div><div><b>${n(i.scheduledFees,s)}</b></div></div>
              <div class="card"><div class="muted">Total Payable</div><div><b>${n(i.scheduledTotal,s)}</b></div></div>
              <div class="card"><div class="muted">Paid Principal</div><div><b>${n(i.paidPrincipal,s)}</b></div></div>
              <div class="card"><div class="muted">Paid Interest</div><div><b>${n(i.paidInterest,s)}</b></div></div>
              <div class="card"><div class="muted">Paid Penalties</div><div><b>${n(i.paidPenalty,s)}</b></div></div>
              <div class="card"><div class="muted">Paid Fees</div><div><b>${n(i.paidFees,s)}</b></div></div>
              <div class="card"><div class="muted">Total Paid</div><div><b>${n(i.totalPaid,s)}</b></div></div>
              <div class="card"><div class="muted">Outstanding</div><div><b>${n(i.outstandingTotal,s)}</b></div></div>
            </div>

            <div class="no-print" style="margin-top:16px;">
              <button onclick="window.print()" style="padding:8px 12px;border:1px solid #E5E7EB;border-radius:8px;background:white;cursor:pointer;">Print / Save as PDF</button>
            </div>
          </div>
        </body>
      </html>
    `,x=window.open("","_blank","noopener,noreferrer,width=1024,height=768");x&&(x.document.open(),x.document.write(c),x.document.close())};return e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between flex-wrap gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Loan Schedule"}),t&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Loan ",e.jsxs("b",{children:["#",t.id]})," — Status: ",e.jsx("span",{className:"inline-block rounded-full px-2 py-0.5 text-xs bg-slate-100 border",children:t.status})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[m.name,m.address?` • ${m.address}`:"",m.phone?` • ${m.phone}`:"",m.email?` • ${m.email}`:""]}),(i==null?void 0:i.nextDue)&&e.jsxs("p",{className:"text-xs text-gray-700 mt-1",children:["Next Installment #",i.nextDue.idx," on ",V(i.nextDue.date)," — ",e.jsx("b",{children:n(i.nextDue.amount,s)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>l&&R(l.trim()),className:"px-3 py-2 rounded border hover:bg-gray-50",children:"Refresh"}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:F,onChange:d=>A(d.target.checked)}),"Auto-refresh"]}),e.jsx("button",{onClick:H,disabled:!a.length,className:"px-3 py-2 rounded border hover:bg-gray-50 disabled:opacity-50",title:"Download as CSV",children:"Download CSV"}),e.jsx("button",{onClick:Z,disabled:!a.length,className:"bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 disabled:opacity-50",title:"Download as PDF",children:"Download PDF"})]})]}),e.jsxs("form",{onSubmit:G,className:"flex gap-2 flex-wrap",children:[e.jsx("input",{className:"border px-3 py-2 rounded w-64",placeholder:"Enter Loan ID",value:l,onChange:d=>j(d.target.value)}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded",children:L?"Loading…":"Load"}),P&&e.jsxs("div",{className:"self-center text-sm text-gray-700",children:["Interest Method: ",e.jsx("b",{children:P})]})]}),!!a.length&&e.jsx("div",{className:"bg-white rounded border shadow p-3",children:e.jsxs("div",{className:"grid sm:grid-cols-3 lg:grid-cols-6 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Principal (Sched.)"}),e.jsx("div",{className:"font-semibold",children:n(i.scheduledPrincipal,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Interest (Sched.)"}),e.jsx("div",{className:"font-semibold",children:n(i.scheduledInterest,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Penalty (Sched.)"}),e.jsx("div",{className:"font-semibold",children:n(i.scheduledPenalty,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Fees (Sched.)"}),e.jsx("div",{className:"font-semibold",children:n(i.scheduledFees,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Total Payable"}),e.jsx("div",{className:"font-semibold",children:n(i.scheduledTotal,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Total Paid"}),e.jsx("div",{className:"font-semibold",children:n(i.totalPaid,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Paid Principal"}),e.jsx("div",{className:"font-semibold",children:n(i.paidPrincipal,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Paid Interest"}),e.jsx("div",{className:"font-semibold",children:n(i.paidInterest,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Paid Penalties"}),e.jsx("div",{className:"font-semibold",children:n(i.paidPenalty,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Paid Fees"}),e.jsx("div",{className:"font-semibold",children:n(i.paidFees,s)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 text-xs",children:"Outstanding"}),e.jsx("div",{className:"font-semibold",children:n(i.outstandingTotal,s)})]})]})}),!!a.length&&e.jsx("div",{className:"overflow-auto rounded border shadow",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100 sticky top-0 z-10",children:e.jsxs("tr",{className:"text-left text-sm",children:[e.jsx("th",{className:"p-2 border",children:"#"}),e.jsx("th",{className:"p-2 border",children:"Due Date"}),e.jsx("th",{className:"p-2 border",children:"Principal"}),e.jsx("th",{className:"p-2 border",children:"Interest"}),e.jsx("th",{className:"p-2 border",children:"Penalty"}),e.jsx("th",{className:"p-2 border",children:"Fees"}),e.jsx("th",{className:"p-2 border",children:"Total"}),e.jsx("th",{className:"p-2 border",children:"Balance"}),e.jsx("th",{className:"p-2 border",children:"Status"})]})}),e.jsx("tbody",{className:"text-sm",children:a.map((d,b)=>{const c=d.installment??d.period??b+1,x=d.total??Number(d.principal||0)+Number(d.interest||0)+Number(d.penalty||0)+Number(d.fee??d.fees??0),u=d.paid||d.settled?"Settled":"Pending";return e.jsxs("tr",{className:b%2?"bg-gray-50":"",children:[e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:c}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:V(d.dueDate||d.date)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:n(d.principal,s)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:n(d.interest,s)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:n(d.penalty||0,s)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:n(d.fee??d.fees??0,s)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:n(x,s)}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:d.balance!=null?n(d.balance,s):"—"}),e.jsx("td",{className:"border px-2 py-1 whitespace-nowrap",children:u==="Settled"?e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200",children:"Settled"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-amber-200",children:"Pending"})})]},b)})})]})}),!L&&l&&!a.length&&e.jsx("p",{className:"text-sm text-gray-600",children:"No schedule found for this loan."})]})}export{ee as default};

import{r as s,g as h,j as e,L as Q}from"./index-DUtn1vUj.js";import{S as ie,F as oe,C as de,a as me}from"./search-BVpAStKI.js";import{c as z}from"./createLucideIcon-ByWNNsya.js";import{X as W}from"./x-tsOP5OyH.js";/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],pe=z("check",ue);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]],he=z("corner-up-left",xe);/**
 * @license lucide-react v0.535.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Z=z("loader-circle",ge),_=10,be=[{value:"submitted",label:"Submitted (New)"},{value:"manager_review",label:"Manager Review"},{value:"compliance_review",label:"Compliance Review"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"returned_with_comment",label:"Returned with Comment"}],ve=r=>r==="approved"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300":r==="rejected"?"bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300":r==="returned_with_comment"?"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300":"bg-slate-100 text-slate-700 dark:bg-slate-800/60 dark:text-slate-300",H=(r,n="TZS")=>`‎${n} ${Number(r||0).toLocaleString()}`,je=r=>r?new Date(r).toLocaleDateString():"—";function Ae(){const[r,n]=s.useState([]),[o,d]=s.useState(0),[v,y]=s.useState([]),[M,$]=s.useState([]),[C,B]=s.useState([]),[j,E]=s.useState(""),[R,F]=s.useState(""),[p,S]=s.useState("manager_review"),[f,J]=s.useState(""),[I,U]=s.useState(""),[T,V]=s.useState(""),[m,X]=s.useState("createdAt"),[x,q]=s.useState("desc"),[g,u]=s.useState(1),[Y,G]=s.useState(!0),[ee,A]=s.useState(!1),[K,L]=s.useState(null),O=s.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},[]),l=((O==null?void 0:O.role)||"").toLowerCase();s.useEffect(()=>{l==="compliance"?S("compliance_review"):l==="branch_manager"&&S("manager_review")},[l]),s.useEffect(()=>{const t=setTimeout(()=>F(j.trim()),300);return()=>clearTimeout(t)},[j]),s.useEffect(()=>{(async()=>{try{const[t,a,c]=await Promise.all([h.get("/loan-products").catch(()=>({data:[]})),h.get("/branches").catch(()=>({data:[]})),h.get("/users",{params:{role:"loan_officer"}}).catch(()=>({data:[]}))]);y(Array.isArray(t.data)?t.data:t.data.items||[]),$(Array.isArray(a.data)?a.data:a.data.items||[]),B(Array.isArray(c.data)?c.data:c.data.items||[])}catch{}})()},[]),s.useEffect(()=>{const t=new AbortController;return(async()=>{var a,c;G(!0);try{const i=await h.get("/loans",{signal:t.signal,params:{q:R||void 0,stage:p||void 0,status:p==="approved"||p==="rejected"?p:void 0,productId:f||void 0,branchId:I||void 0,officerId:T||void 0,page:g,pageSize:_,sort:m,dir:x}}),b=((a=i.data)==null?void 0:a.items)||(Array.isArray(i.data)?i.data:[]);n(b),d(((c=i.data)==null?void 0:c.total)??b.length??0)}catch{n([]),d(0)}finally{G(!1)}})(),()=>t.abort()},[R,p,f,I,T,g,m,x]);const te=t=>l==="branch_manager"?"compliance_review":l==="compliance"||l==="admin"||l==="director"?"approved":t==="manager_review"?"compliance_review":"approved",P=t=>{const a=(t.stage||t.status||"").toLowerCase();return l==="branch_manager"?a==="manager_review"||a==="submitted"||!a:l==="compliance"?a==="compliance_review":l==="admin"||l==="director"?a==="manager_review"||a==="compliance_review"||a==="submitted":!1},D=async(t,a)=>{try{return await h.patch(`/loans/${t}/stage`,a),!0}catch{try{if(a.action==="approve"){const i=a.nextStage==="approved";await h.patch(`/loans/${t}/status`,{status:i?"approved":"pending"})}else a.action==="reject"?await h.patch(`/loans/${t}/status`,{status:"rejected"}):a.action==="return"&&await h.patch(`/loans/${t}/status`,{status:"pending"});return a.comment&&await h.post("/comments",{loanId:t,content:a.comment}),!0}catch{return!1}}},ae=async(t,a)=>{if(!P(t))return;A(!0);const c={action:"approve",fromStage:t.stage||t.status||"submitted",nextStage:te(t.stage),suggestedAmount:a||void 0},i=await D(t.id,c);if(A(!1),!i)return alert("Failed to approve.");u(1),n(b=>b.filter(k=>k.id!==t.id))},se=async(t,a)=>{if(!P(t))return;if(!(a!=null&&a.trim()))return alert("Please enter a short reason.");A(!0);const c={action:"reject",fromStage:t.stage||t.status||"submitted",nextStage:"rejected",comment:a},i=await D(t.id,c);if(A(!1),!i)return alert("Failed to reject.");u(1),n(b=>b.filter(k=>k.id!==t.id))},re=async(t,a,c)=>{if(!P(t))return;if(!(a!=null&&a.trim()))return alert("Please enter a comment.");A(!0);const i={action:"return",fromStage:t.stage||t.status||"submitted",nextStage:"returned_with_comment",comment:a,suggestedAmount:c||void 0},b=await D(t.id,i);if(A(!1),!b)return alert("Failed to return with comment.");u(1),n(k=>k.filter(le=>le.id!==t.id))},N=t=>{m===t?q(a=>a==="asc"?"desc":"asc"):(X(t),q("asc"))},ne=s.useMemo(()=>o===0?0:(g-1)*_+1,[g,o]),ce=s.useMemo(()=>Math.min(g*_,o),[g,o]);return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"Loan Review Queue"}),e.jsx("p",{className:"text-sm muted",children:l==="branch_manager"?"Approve/return applications to Compliance.":l==="compliance"?"Compliance checks for policy/legal, then approve or return.":"Review and route loan applications by stage."})]}),e.jsx(Q,{to:"/loans",className:"text-indigo-600 hover:underline text-sm",children:"Back to Loans"})]}),e.jsx("div",{className:"card p-3 md:p-4 mb-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 lg:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ie,{className:"w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{value:j,onChange:t=>{E(t.target.value),u(1)},placeholder:"Search borrower, phone, product, loan #",className:"input pl-9 pr-3 py-2"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("select",{value:p,onChange:t=>{S(t.target.value),u(1)},className:"input",children:be.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs("select",{value:f,onChange:t=>{J(t.target.value),u(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Products"}),v.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:I,onChange:t=>{U(t.target.value),u(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Branches"}),M.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:T,onChange:t=>{V(t.target.value),u(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Officers"}),C.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]}),e.jsxs("div",{className:"hidden lg:flex items-center muted text-sm px-2",children:[e.jsx(oe,{className:"w-4 h-4 mr-1"})," Filters"]})]})]})}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-[var(--fg)]",children:e.jsxs("tr",{children:[e.jsx(w,{label:"Submitted",sortKey:"createdAt",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Borrower",sortKey:"borrowerName",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Product",sortKey:"productName",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Principal",sortKey:"amount",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Officer",sortKey:"officerName",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Branch",sortKey:"branchName",sort:m,dir:x,onSort:N}),e.jsx(w,{label:"Stage",sortKey:"stage",sort:m,dir:x,onSort:N}),e.jsx("th",{className:"px-3 py-2 text-right pr-4",children:"Actions"})]})}),e.jsx("tbody",{children:Y?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-10 text-center muted",children:"Loading…"})}):r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-10 text-center muted",children:"No applications found."})}):r.map(t=>{var a,c;return e.jsxs("tr",{className:"border-t border-[var(--border)] hover:bg-gray-50 dark:hover:bg-slate-800",children:[e.jsx("td",{className:"px-4 py-2",children:je(t.createdAt)}),e.jsxs("td",{className:"px-4 py-2",children:[e.jsx(Q,{to:`/borrowers/${t.borrowerId}`,className:"text-indigo-600 hover:underline",children:((a=t.Borrower)==null?void 0:a.name)||t.borrowerName||"—"}),e.jsx("div",{className:"text-xs muted",children:t.loanNumber?`Loan #${t.loanNumber}`:""})]}),e.jsx("td",{className:"px-4 py-2",children:((c=t.Product)==null?void 0:c.name)||t.productName||"—"}),e.jsx("td",{className:"px-4 py-2",children:H(t.amount,t.currency||"TZS")}),e.jsx("td",{className:"px-4 py-2",children:t.officerName||"—"}),e.jsx("td",{className:"px-4 py-2",children:t.branchName||"—"}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:`px-2 py-0.5 text-xs rounded ${ve((t.stage||t.status||"").toLowerCase())}`,children:(t.stage||t.status||"—").replaceAll("_"," ")})}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("div",{className:"inline-flex gap-1",children:[e.jsx(Q,{to:`/loans/${t.id}`,className:"px-2 py-1 text-xs rounded border border-[var(--border)] hover:bg-gray-50 dark:hover:bg-slate-800",children:"View"}),P(t)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"px-2 py-1 text-xs rounded border border-[var(--border)] bg-emerald-600 text-white hover:bg-emerald-700 inline-flex items-center gap-1",onClick:()=>L({type:"approve",row:t}),children:[e.jsx(pe,{className:"w-3.5 h-3.5"})," Approve"]}),e.jsxs("button",{className:"px-2 py-1 text-xs rounded border border-[var(--border)] bg-amber-600 text-white hover:bg-amber-700 inline-flex items-center gap-1",onClick:()=>L({type:"return",row:t}),children:[e.jsx(he,{className:"w-3.5 h-3.5"})," Return"]}),e.jsxs("button",{className:"px-2 py-1 text-xs rounded border border-[var(--border)] bg-rose-600 text-white hover:bg-rose-700 inline-flex items-center gap-1",onClick:()=>L({type:"reject",row:t}),children:[e.jsx(W,{className:"w-3.5 h-3.5"})," Reject"]})]})]})})]},t.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-t border-[var(--border)] text-sm",children:[e.jsxs("div",{className:"muted",children:[ne,"–",ce," of ",o]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(t=>Math.max(1,t-1)),disabled:g===1,className:"p-1 border border-[var(--border)] rounded disabled:opacity-50",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>u(t=>t*_<o?t+1:t),disabled:g*_>=o,className:"p-1 border border-[var(--border)] rounded disabled:opacity-50",children:e.jsx(me,{className:"w-4 h-4"})})]})]})]}),K&&e.jsx(fe,{type:K.type,row:K.row,role:l,busy:ee,onClose:()=>L(null),onApprove:ae,onReject:se,onReturn:re})]})}const w=({label:r,sortKey:n,sort:o,dir:d,onSort:v})=>{const y=o===n;return e.jsx("th",{className:"px-3 py-2 cursor-pointer select-none",onClick:()=>v(n),title:"Sort",children:e.jsxs("span",{className:`inline-flex items-center gap-1 ${y?"text-indigo-700":""}`,children:[r,y?d==="asc"?"▲":"▼":""]})})};function fe({type:r,row:n,role:o,busy:d,onClose:v,onApprove:y,onReject:M,onReturn:$}){var p,S;const[C,B]=s.useState(""),[j,E]=s.useState(""),R=r==="approve"?"Approve Application":r==="reject"?"Reject Application":"Return with Comment",F=o==="branch_manager"&&(r==="approve"||r==="return");return e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:v}),e.jsxs("div",{className:"relative card w-[95%] max-w-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold",children:R}),e.jsx("button",{onClick:v,className:"p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-800",children:e.jsx(W,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Borrower:"})," ",((p=n.Borrower)==null?void 0:p.name)||n.borrowerName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Product:"})," ",((S=n.Product)==null?void 0:S.name)||n.productName||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted",children:"Amount:"})," ",H(n.amount,n.currency||"TZS")]})]}),F&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs muted",children:"Suggested Amount (optional)"}),e.jsx("input",{type:"number",className:"input",placeholder:"e.g. 500000",value:j,onChange:f=>E(f.target.value)}),e.jsx("p",{className:"text-[11px] muted mt-1",children:"Branch Manager can suggest a different principal before forwarding to Compliance."})]}),r!=="approve"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs muted",children:"Comment"}),e.jsx("textarea",{className:"input min-h-[96px]",placeholder:r==="reject"?"Reason for rejection…":"What needs to be updated…",value:C,onChange:f=>B(f.target.value)})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:v,className:"px-3 py-2 rounded border border-[var(--border)]",children:"Cancel"}),r==="approve"&&e.jsxs("button",{disabled:d,onClick:()=>y(n,j),className:"inline-flex items-center gap-2 px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",children:[d&&e.jsx(Z,{className:"w-4 h-4 animate-spin"})," Approve"]}),r==="return"&&e.jsxs("button",{disabled:d,onClick:()=>$(n,C,j),className:"inline-flex items-center gap-2 px-3 py-2 rounded bg-amber-600 text-white hover:bg-amber-700 disabled:opacity-60",children:[d&&e.jsx(Z,{className:"w-4 h-4 animate-spin"})," Return"]}),r==="reject"&&e.jsxs("button",{disabled:d,onClick:()=>M(n,C),className:"inline-flex items-center gap-2 px-3 py-2 rounded bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-60",children:[d&&e.jsx(Z,{className:"w-4 h-4 animate-spin"})," Reject"]})]})]})]})}export{Ae as default};

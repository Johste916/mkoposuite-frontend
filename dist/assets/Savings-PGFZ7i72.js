import{r as o,g as y,j as e}from"./index-BVWWaTks.js";import{E as $}from"./jspdf.es.min-DdBstHLu.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as D}from"./index-CneTyOnb.js";const I=({value:l,onChange:p,placeholder:v="Search borrower…",disabled:f=!1})=>{const[b,j]=o.useState(""),[d,g]=o.useState([]),[S,x]=o.useState(!1),[n,h]=o.useState(!1),i=o.useRef(null);return o.useEffect(()=>{if(l&&typeof l=="object"){const t=l.name||[l.firstName,l.lastName].filter(Boolean).join(" ")||l.id;j(`${t}${l.id?` (${l.id})`:""}`)}},[l]),o.useEffect(()=>{if(!b.trim()){g([]);return}h(!0),i.current&&i.current.abort(),i.current=new AbortController;const t=setTimeout(async()=>{var c,w;try{const u=await y.get("/borrowers/search",{signal:i.current.signal,params:{q:b.trim()}}),k=Array.isArray(u.data)?u.data:((c=u.data)==null?void 0:c.items)||((w=u.data)==null?void 0:w.data)||[];g(k)}catch{g([])}finally{h(!1)}},250);return()=>{clearTimeout(t),i.current&&i.current.abort()}},[b]),e.jsxs("div",{className:"relative w-full",children:[e.jsx("input",{className:"w-full border rounded-lg px-3 py-2",placeholder:v,disabled:f,value:b,onFocus:()=>x(!0),onChange:t=>{j(t.target.value),x(!0),t.target.value.trim()||p==null||p(null,null)}}),S&&e.jsx("div",{className:"absolute z-50 mt-1 w-full bg-white border rounded-lg shadow max-h-64 overflow-auto",onMouseDown:t=>t.preventDefault(),children:n?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"Searching…"}):d.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"No results"}):d.map(t=>{const c=t.name||`${t.firstName||""} ${t.lastName||""}`.trim()||t.id||"Borrower";return e.jsxs("button",{type:"button",className:"w-full text-left px-3 py-2 hover:bg-gray-50 text-sm",onClick:()=>{j(`${c}${t.id?` (${t.id})`:""}`),x(!1),p==null||p(t.id,t)},children:[e.jsx("div",{className:"font-medium text-gray-800",children:c}),e.jsxs("div",{className:"text-xs text-gray-500",children:[t.phone||"—"," ",t.branchName?`• ${t.branchName}`:""]})]},t.id||c)})})]})},z=()=>{const[l,p]=o.useState([]),[v,f]=o.useState({}),[b,j]=o.useState(0),[d,g]=o.useState({borrowerId:"",type:""}),[S,x]=o.useState(!1),[n,h]=o.useState({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),[i,t]=o.useState(""),c=JSON.parse(localStorage.getItem("user")||"{}"),w=((c==null?void 0:c.role)||"").toLowerCase()==="admin",u=async()=>{var s,r;t("");try{if(!d.borrowerId){p([]),j(0),f({});return}const a=new URLSearchParams;d.type&&a.set("type",d.type);const m=await y._get(`/savings/borrower/${d.borrowerId}?${a.toString()}`);p(m.data.transactions||[]),j(m.data.balance||0),f(m.data.totals||{})}catch(a){t(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.error)||(a==null?void 0:a.normalizedMessage)||"Failed to fetch savings")}};o.useEffect(()=>{u()},[d.borrowerId,d.type]);const k=async()=>{var s,r;t("");try{const a={...n};if(!a.borrowerId||!a.type||!a.amount||!a.date){t("Borrower, type, amount and date are required.");return}await y._post("/savings",a),x(!1),h({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),u()}catch(a){t(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.error)||(a==null?void 0:a.normalizedMessage)||"Failed to save.")}},T=async s=>{var r,a;if(window.confirm("Reverse this transaction?"))try{await y._patch(`/savings/transactions/${s}/reverse`),u()}catch(m){t(((a=(r=m==null?void 0:m.response)==null?void 0:r.data)==null?void 0:a.error)||(m==null?void 0:m.normalizedMessage)||"Failed to reverse.")}},C=()=>{const s=new $;s.text("Savings Transactions",14,16),s.autoTable({startY:20,head:[["Date","Type","Amount","Notes","Reversed"]],body:l.map(r=>[r.date,r.type,r.amount,r.notes||"-",r.reversed?"Yes":"No"])}),s.save("savings.pdf")},A=[["Date","Type","Amount","Notes","Reversed"],...l.map(s=>[s.date,s.type,s.amount,s.notes||"",s.reversed?"Yes":"No"])],N="bg-white dark:bg-slate-800 rounded-xl shadow p-4";return e.jsxs("div",{className:"p-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Savings"}),e.jsx("button",{onClick:()=>x(!0),className:"bg-blue-600 text-white px-4 py-2 rounded",children:"+ Add Transaction"})]}),e.jsxs("div",{className:`${N} mb-4`,children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Borrower"}),e.jsx(I,{value:d.borrowerId||null,onChange:s=>g(r=>({...r,borrowerId:s}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Type"}),e.jsxs("select",{value:d.type,onChange:s=>g({...d,type:s.target.value}),className:"border px-3 py-2 rounded w-48 dark:bg-slate-700 dark:border-slate-600",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]})]})]}),i&&e.jsxs("div",{className:"text-sm text-rose-600 mt-3",children:["Error: ",i]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:N,children:["Balance: ",e.jsx("strong",{children:b})]}),e.jsxs("div",{className:N,children:["Deposits: ",e.jsx("strong",{children:v.deposits||0})]}),e.jsxs("div",{className:N,children:["Withdrawals: ",e.jsx("strong",{children:v.withdrawals||0})]}),e.jsxs("div",{className:N,children:["Charges: ",e.jsx("strong",{children:v.charges||0})]})]}),e.jsxs("div",{className:"flex gap-3 mb-3",children:[e.jsx(D,{data:A,filename:"savings.csv",className:"bg-green-600 text-white px-4 py-2 rounded",children:"Export CSV"}),e.jsx("button",{onClick:C,className:"bg-red-600 text-white px-4 py-2 rounded",children:"Export PDF"})]}),e.jsx("div",{className:"overflow-x-auto bg-white dark:bg-slate-800 border rounded shadow",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-slate-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 border",children:"Date"}),e.jsx("th",{className:"p-2 border",children:"Type"}),e.jsx("th",{className:"p-2 border",children:"Amount"}),e.jsx("th",{className:"p-2 border",children:"Notes"}),e.jsx("th",{className:"p-2 border",children:"Reversed"}),w&&e.jsx("th",{className:"p-2 border",children:"Action"})]})}),e.jsxs("tbody",{children:[l.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:s.date}),e.jsx("td",{className:"border p-2 capitalize",children:s.type}),e.jsx("td",{className:"border p-2",children:s.amount}),e.jsx("td",{className:"border p-2",children:s.notes||"-"}),e.jsx("td",{className:"border p-2",children:s.reversed?"Yes":"No"}),w&&e.jsx("td",{className:"border p-2",children:!s.reversed&&e.jsx("button",{onClick:()=>T(s.id),className:"text-red-500 text-sm",children:"Reverse"})})]},s.id)),!l.length&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-sm text-slate-500",colSpan:w?6:5,children:d.borrowerId?"No transactions found.":"Search and select a borrower to view transactions."})})]})]})}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-6 rounded shadow-md w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Add Transaction"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(I,{value:n.borrowerId||null,onChange:s=>h(r=>({...r,borrowerId:s})),placeholder:"Pick borrower…"}),e.jsxs("select",{value:n.type,onChange:s=>h({...n,type:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700",children:[e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]}),e.jsx("input",{type:"number",placeholder:"Amount",value:n.amount,onChange:s=>h({...n,amount:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"date",value:n.date,onChange:s=>h({...n,date:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"text",placeholder:"Notes",value:n.notes,onChange:s=>h({...n,notes:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>x(!1),className:"px-4 py-2 bg-gray-300 rounded",children:"Cancel"}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"Save"})]}),i&&e.jsxs("div",{className:"text-sm text-rose-600",children:["Error: ",i]})]})]})})]})};export{z as default};

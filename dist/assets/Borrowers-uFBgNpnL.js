import{u as pe,r as n,g as w,j as e,L as B}from"./index-B1RC7Rfk.js";import{C as je}from"./circle-plus-C09d3Tdc.js";import{U as fe,B as Ne}from"./upload-BOZHd_Hv.js";import{S as ge,F as ve,C as be,a as we}from"./search-C2tZDCoy.js";import{P as ye,I as Se}from"./phone-DquL_aMW.js";import{X as Ae}from"./x-BHBDEW2o.js";import{F as Ce}from"./file-up-B417AVZd.js";import"./createLucideIcon-tkCTfASk.js";const A=10;async function J(a=[],r={}){let x;for(const o of a)try{const m=await w.get(o,r);return m==null?void 0:m.data}catch(m){x=m}throw x||new Error("No endpoint succeeded")}function W(a){return Array.isArray(a)?a:Array.isArray(a==null?void 0:a.items)?a.items:Array.isArray(a==null?void 0:a.rows)?a.rows:Array.isArray(a==null?void 0:a.data)?a.data:[]}const Me=()=>{const a=pe(),[r,x]=n.useState([]),[o,m]=n.useState(0),[h,C]=n.useState(""),[S,ee]=n.useState(""),[L,se]=n.useState(""),[D,ae]=n.useState(""),[O,te]=n.useState(""),[u,re]=n.useState("createdAt"),[p,_]=n.useState("desc"),[j,f]=n.useState(1),[le,K]=n.useState([]),[ne,M]=n.useState([]),[R,V]=n.useState(!0),[T,De]=n.useState(null),[U,ie]=n.useState(!1),[N,ce]=n.useState("overview"),[de,z]=n.useState(!1),[k,I]=n.useState({overview:null,loans:[],savings:[],documents:[]}),[oe,Q]=n.useState([]),E=(s,l="info")=>{const c=Math.random().toString(36).slice(2);Q(i=>[...i,{id:c,msg:s,type:l}]),setTimeout(()=>Q(i=>i.filter(d=>d.id!==c)),3500)};n.useEffect(()=>{const s=setTimeout(()=>ee(h.trim()),300);return()=>clearTimeout(s)},[h]),n.useEffect(()=>{const s=new AbortController;return(async()=>{try{const[l,c]=await Promise.all([J(["/branches","/org/branches","/api/branches"],{signal:s.signal}).catch(()=>[]),J(["/users?role=loan_officer","/staff?role=loan_officer","/api/users?role=loan_officer"],{signal:s.signal}).catch(()=>[])]),i=W(l),d=W(c);K(i.map(t=>t?{id:t.id??t._id??t.branchId??String(t.code??""),name:t.name??t.branchName??`Branch ${t.id??t.code??""}`}:null).filter(Boolean)),M(d.map(t=>t?{id:t.id??t._id??t.userId??t.email??String(Math.random()),name:t.name??t.fullName??t.email??"User",email:t.email}:null).filter(Boolean))}catch{K([]),M([])}})(),()=>s.abort()},[]);const Y=n.useCallback(async s=>{var l,c,i,d;V(!0);try{const t=await w.get("/borrowers",{signal:s,params:{q:S||void 0,branchId:L||void 0,officerId:D||void 0,status:O||void 0,page:j,pageSize:A,sort:u,dir:p}});let $=[],P=0;Array.isArray(t.data)?($=t.data,P=t.data.length):($=((l=t.data)==null?void 0:l.items)||((c=t.data)==null?void 0:c.rows)||((i=t.data)==null?void 0:i.data)||[],P=Number(((d=t.data)==null?void 0:d.total)??$.length??0)),x($),m(P)}catch{E("Failed to load borrowers","error"),x([]),m(0)}finally{V(!1)}},[S,L,D,O,j,u,p]);n.useEffect(()=>{const s=new AbortController;return Y(s.signal),()=>s.abort()},[Y]);const Z=n.useCallback(async(s,l,c)=>{z(!0);try{if(s==="overview"){const i=await w.get(`/borrowers/${l}`,{signal:c});I(d=>({...d,overview:i.data||null}))}else if(s==="loans"){const i=await w.get(`/borrowers/${l}/loans`,{signal:c});I(d=>{var t;return{...d,loans:Array.isArray(i.data)?i.data:((t=i.data)==null?void 0:t.items)||[]}})}else if(s==="savings"){const i=await w.get(`/borrowers/${l}/savings`,{signal:c});I(d=>{var t;return{...d,savings:Array.isArray(i.data)?i.data:((t=i.data)==null?void 0:t.items)||[]}})}else if(s==="documents"){const i=await w.get(`/borrowers/${l}/documents`,{signal:c});I(d=>{var t;return{...d,documents:Array.isArray(i.data)?i.data:((t=i.data)==null?void 0:t.items)||[]}})}}catch{E("Failed to load borrower details","error")}finally{z(!1)}},[]);n.useEffect(()=>{if(!U||!T)return;const s=new AbortController;return Z(N,T,s.signal),()=>s.abort()},[U,N,T,Z]);const g=s=>{u===s?_(l=>l==="asc"?"desc":"asc"):(re(s),_("asc"))},q=s=>`TZS ${Number(s||0).toLocaleString()}`,me=n.useMemo(()=>o===0?0:(j-1)*A+1,[j,o]),xe=n.useMemo(()=>Math.min(j*A,o),[j,o]),G=s=>(s==null?void 0:s.name)||`${(s==null?void 0:s.firstName)||""} ${(s==null?void 0:s.lastName)||""}`.trim()||"â€”",X=s=>{var l,c;return(s==null?void 0:s.branchName)||((l=s==null?void 0:s.Branch)==null?void 0:l.name)||((c=s==null?void 0:s.branch)==null?void 0:c.name)||"â€”"},he=s=>{var l,c;return(s==null?void 0:s.officerName)||((l=s==null?void 0:s.officer)==null?void 0:l.name)||((c=s==null?void 0:s.loanOfficer)==null?void 0:c.name)||"â€”"},ue=s=>{var d,t;const l=(s||"").trim();if(!l)return"U";const c=l.split(/\s+/).filter(Boolean);return((((d=c[0])==null?void 0:d[0])||"")+(((t=c[1])==null?void 0:t[0])||"")).toUpperCase()||l[0].toUpperCase()},H=s=>{const l="text-[11px] px-2 py-0.5 rounded border";switch(s){case"active":return`${l} bg-emerald-50 border-emerald-300 text-emerald-700 dark:bg-emerald-900/20 dark:border-emerald-600 dark:text-emerald-300`;case"pending_kyc":return`${l} bg-amber-50 border-amber-300 text-amber-700 dark:bg-amber-900/20 dark:border-amber-600 dark:text-amber-300`;case"blacklisted":return`${l} bg-rose-50 border-rose-300 text-rose-700 dark:bg-rose-900/20 dark:border-rose-600 dark:text-rose-300`;default:return`${l} bg-gray-50 border-gray-300 text-gray-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300`}};return e.jsxs("div",{className:"p-6 min-h-screen bg-[var(--bg)] text-[var(--fg)]",children:[e.jsx("div",{className:"fixed right-4 top-4 z-50 space-y-2",children:oe.map(s=>e.jsx("div",{className:`px-3 py-2 rounded shadow text-sm text-white ${s.type==="error"?"bg-rose-600":s.type==="success"?"bg-emerald-600":"bg-slate-800"}`,children:s.msg},s.id))}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"ðŸ‘¥ Borrowers"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>a("/borrowers/add"),className:"btn-primary inline-flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4"})," Add Borrower"]}),e.jsxs("button",{onClick:()=>E("CSV import coming soon","info"),className:"btn-ghost inline-flex items-center gap-2",children:[e.jsx(fe,{className:"w-4 h-4"})," Import CSV"]})]})]}),e.jsx("div",{className:"card p-3 md:p-4 mb-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ge,{className:"w-4 h-4 text-[var(--muted)] absolute left-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{value:h,onChange:s=>{C(s.target.value),f(1)},placeholder:"Search by name, phone, national IDâ€¦",className:"input w-full pl-9"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("div",{className:"filter-field min-w-[200px]",children:e.jsxs("select",{value:L,onChange:s=>{se(s.target.value),f(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Branches"}),le.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("div",{className:"filter-field min-w-[200px]",children:e.jsxs("select",{value:D,onChange:s=>{ae(s.target.value),f(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Officers"}),ne.map(s=>e.jsx("option",{value:s.id,children:s.name||s.email},s.id))]})}),e.jsx("div",{className:"filter-field min-w-[180px]",children:e.jsxs("select",{value:O,onChange:s=>{te(s.target.value),f(1)},className:"input",children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"}),e.jsx("option",{value:"pending_kyc",children:"Pending KYC"}),e.jsx("option",{value:"blacklisted",children:"Blacklisted"})]})}),e.jsxs("div",{className:"hidden md:flex items-center text-sm px-2 text-[var(--muted)]",children:[e.jsx(ve,{className:"w-4 h-4 mr-1"})," Filters"]})]})]})}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm hidden md:table",children:[e.jsx("thead",{className:"bg-[var(--table-head-bg)] text-[var(--fg)]/80",children:e.jsxs("tr",{children:[e.jsx(v,{label:"Name",sortKey:"name",sort:u,dir:p,onSort:g}),e.jsx(v,{label:"Phone",sortKey:"phone",sort:u,dir:p,onSort:g}),e.jsx(v,{label:"Branch",sortKey:"branchName",sort:u,dir:p,onSort:g}),e.jsx(v,{label:"Officer",sortKey:"officerName",sort:u,dir:p,onSort:g}),e.jsx(v,{label:"Outstanding",sortKey:"outstanding",sort:u,dir:p,onSort:g}),e.jsx(v,{label:"Status",sortKey:"status",sort:u,dir:p,onSort:g}),e.jsx("th",{className:"px-3 py-2 text-right pr-4",children:"Actions"})]})}),e.jsx("tbody",{children:R?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-10 text-center muted",children:"Loadingâ€¦"})}):r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-10 text-center muted",children:"No borrowers."})}):r.map(s=>e.jsxs("tr",{className:"border-t border-[var(--border)] hover:bg-[var(--hover)]",children:[e.jsx("td",{className:"px-4 py-2",children:G(s)}),e.jsx("td",{className:"px-4 py-2",children:s.phone||"â€”"}),e.jsx("td",{className:"px-4 py-2",children:X(s)}),e.jsx("td",{className:"px-4 py-2",children:he(s)}),e.jsx("td",{className:"px-4 py-2",children:q(s.outstanding)}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:H(s.status),children:s.status||"â€”"})}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(B,{to:`/borrowers/${encodeURIComponent(s.id)}`,className:"link",children:"View"}),e.jsx(B,{to:`/loans/applications?borrowerId=${encodeURIComponent(s.id)}`,className:"link-alt",children:"New Loan"})]})})]},s.id))})]}),e.jsx("div",{className:"md:hidden grid grid-cols-1 gap-3 p-3",children:R?e.jsx("div",{className:"p-6 text-center muted",children:"Loadingâ€¦"}):r.length===0?e.jsx("div",{className:"p-6 text-center muted",children:"No borrowers."}):r.map(s=>{const l=G(s);return e.jsxs("div",{className:"card p-4 hover:shadow-sm transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white flex items-center justify-center text-sm font-semibold shadow-sm",children:ue(l)}),e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:l}),e.jsxs("div",{className:"text-xs muted",children:["ID: ",s.id]})]})]}),e.jsx("span",{className:H(s.status),children:s.status||"â€”"})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4 text-[var(--muted)]"}),e.jsx("span",{children:s.phone||"â€”"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4 text-[var(--muted)]"}),e.jsx("span",{className:"truncate",children:X(s)})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-xs muted",children:"Outstanding"}),e.jsx("div",{className:"text-sm font-medium",children:q(s.outstanding)})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2",children:[e.jsx(B,{to:`/borrowers/${encodeURIComponent(s.id)}`,className:"btn-ghost",children:"View"}),e.jsx(B,{to:`/loans/applications?borrowerId=${encodeURIComponent(s.id)}`,className:"btn-primary",children:"New Loan"})]})]},s.id)})})]}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-t text-sm rounded-b-xl bg-[var(--table-foot-bg)] border-[var(--border)]",children:[e.jsxs("div",{className:"muted",children:[me,"â€“",xe," of ",o]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>f(s=>Math.max(1,s-1)),disabled:j===1,className:"btn-icon disabled:opacity-50","aria-label":"Previous page",children:e.jsx(be,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>f(s=>s*A<o?s+1:s),disabled:j*A>=o,className:"btn-icon disabled:opacity-50","aria-label":"Next page",children:e.jsx(we,{className:"w-4 h-4"})})]})]})]}),U&&e.jsxs(ke,{onClose:()=>ie(!1),title:"Borrower Details",children:[e.jsx("div",{className:"flex gap-2 border-b mb-3 border-[var(--border)]",children:["overview","loans","savings","documents"].map(s=>e.jsx("button",{onClick:()=>ce(s),className:`px-3 py-2 text-sm border-b-2 -mb-px ${N===s?"border-indigo-600 text-indigo-600":"border-transparent muted"}`,children:s[0].toUpperCase()+s.slice(1)},s))}),e.jsx("div",{children:de?e.jsx("div",{className:"muted text-sm",children:"Loadingâ€¦"}):N==="overview"?e.jsx(Ie,{data:k.overview}):N==="loans"?e.jsx($e,{items:k.loans}):N==="savings"?e.jsx(Be,{items:k.savings}):e.jsx(Le,{items:k.documents})})]})]})},v=({label:a,sortKey:r,sort:x,dir:o,onSort:m})=>{const h=x===r;return e.jsx("th",{className:"px-3 py-2 cursor-pointer select-none",onClick:()=>m(r),title:"Sort",children:e.jsxs("span",{className:`inline-flex items-center gap-1 ${h?"text-indigo-600":""}`,children:[a,h?o==="asc"?"â–²":"â–¼":""]})})},ke=({title:a,onClose:r,children:x})=>e.jsxs("div",{className:"fixed inset-0 z-[60]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:r}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full sm:w-[620px] bg-[var(--card)] text-[var(--fg)] shadow-2xl p-4 overflow-y-auto rounded-l-2xl border-l border-[var(--border)]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a}),e.jsx("button",{onClick:r,className:"p-1 rounded hover:bg-[var(--hover)]","aria-label":"Close drawer",children:e.jsx(Ae,{className:"w-5 h-5"})})]}),x]})]}),Ie=({data:a})=>{var m,h,C,S;if(!a)return e.jsx("p",{className:"muted text-sm",children:"No overview data."});const r=a.name||`${a.firstName||""} ${a.lastName||""}`.trim()||"â€”",x=a.branchName||((m=a.Branch)==null?void 0:m.name)||((h=a.branch)==null?void 0:h.name)||"â€”",o=a.officerName||((C=a.officer)==null?void 0:C.name)||((S=a.loanOfficer)==null?void 0:S.name)||"â€”";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsx(b,{label:"Full Name",value:r}),e.jsx(b,{label:"Phone",value:a.phone||"â€”"}),e.jsx(b,{label:"Branch",value:x}),e.jsx(b,{label:"Loan Officer",value:o}),e.jsx(b,{label:"Status",value:a.status||"â€”"}),e.jsx(b,{label:"National ID",value:a.nationalId||"â€”"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsx(F,{label:"Outstanding Loan",value:y(a.outstandingLoan)}),e.jsx(F,{label:"Outstanding Interest",value:y(a.outstandingInterest)}),e.jsx(F,{label:"Net Savings",value:y(a.netSavings)})]})]})},$e=({items:a})=>!Array.isArray(a)||a.length===0?e.jsx("p",{className:"muted text-sm",children:"No loans."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--table-head-bg)] text-[var(--fg)]/80",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Loan #"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Product"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Disbursed"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Outstanding"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Status"})]})}),e.jsx("tbody",{children:a.map(r=>e.jsxs("tr",{className:"border-t border-[var(--border)]",children:[e.jsx("td",{className:"px-3 py-2",children:r.id}),e.jsx("td",{className:"px-3 py-2",children:r.product||"â€”"}),e.jsx("td",{className:"px-3 py-2",children:y(r.disbursed)}),e.jsx("td",{className:"px-3 py-2",children:y(r.outstanding)}),e.jsx("td",{className:"px-3 py-2",children:r.status||"â€”"})]},r.id))})]})}),Be=({items:a})=>!Array.isArray(a)||a.length===0?e.jsx("p",{className:"muted text-sm",children:"No savings accounts."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--table-head-bg)] text-[var(--fg)]/80",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Account #"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Balance"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Status"})]})}),e.jsx("tbody",{children:a.map(r=>e.jsxs("tr",{className:"border-t border-[var(--border)]",children:[e.jsx("td",{className:"px-3 py-2",children:r.id}),e.jsx("td",{className:"px-3 py-2",children:y(r.balance)}),e.jsx("td",{className:"px-3 py-2",children:r.status||"â€”"})]},r.id))})]})}),Le=({items:a})=>e.jsxs("div",{children:[e.jsx("div",{className:"mb-3",children:e.jsxs("button",{onClick:()=>alert("KYC upload coming soon"),className:"btn-ghost inline-flex items-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4"})," Upload Document"]})}),!Array.isArray(a)||a.length===0?e.jsx("p",{className:"muted text-sm",children:"No documents."}):e.jsx("ul",{className:"space-y-2",children:a.map(r=>e.jsxs("li",{className:"card p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Se,{className:"w-4 h-4 text-[var(--muted)]"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:r.fileName||"Document"}),e.jsxs("p",{className:"text-xs muted",children:[r.type||"KYC"," â€¢ ",r.createdAt?new Date(r.createdAt).toLocaleString():""]})]})]}),r.url&&e.jsx("a",{className:"link text-sm",href:r.url,target:"_blank",rel:"noreferrer",children:"Open"})]},r.id))})]}),b=({label:a,value:r})=>e.jsxs("div",{className:"card p-4 shadow-sm",children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wide muted",children:a}),e.jsx("p",{className:"text-base font-semibold mt-1",children:r})]}),F=({label:a,value:r})=>e.jsxs("div",{className:"rounded-2xl p-4 border bg-[var(--kpi-bg)] border-[var(--border)]",children:[e.jsx("p",{className:"text-[11px] uppercase tracking-wide muted",children:a}),e.jsx("p",{className:"text-xl font-semibold mt-1",children:r})]}),y=a=>`TZS ${Number(a||0).toLocaleString()}`;export{Me as default};

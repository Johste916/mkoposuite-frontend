import{r as n,g as N,j as e}from"./index-CYBEjh8Z.js";const C=(s,t)=>s?["admin","director","super_admin","system_admin"].includes((s.role||"").toLowerCase())?!0:Array.isArray(s.permissions)&&s.permissions.includes(t):!1;function D(){const[s,t]=n.useState(null),[a,d]=n.useState("overview");return n.useEffect(()=>{(async()=>{try{const{data:o}=await N.get("/auth/me");t(o)}catch{}})()},[]),s?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Branches"}),e.jsxs("div",{className:"flex gap-1 rounded-lg border bg-white overflow-hidden",children:[e.jsx(A,{label:"Overview",id:"overview",tab:a,setTab:d}),C(s,"branches:manage")&&e.jsx(A,{label:"Add",id:"add",tab:a,setTab:d}),C(s,"branches:assign")&&e.jsx(A,{label:"Assign",id:"assign",tab:a,setTab:d}),e.jsx(A,{label:"Reports",id:"reports",tab:a,setTab:d})]})]}),a==="overview"&&e.jsx($,{canManage:C(s,"branches:manage")}),a==="add"&&C(s,"branches:manage")&&e.jsx(B,{}),a==="assign"&&C(s,"branches:assign")&&e.jsx(I,{}),a==="reports"&&e.jsx(L,{})]}):e.jsx("div",{className:"p-4",children:"Loading…"})}function A({label:s,id:t,tab:a,setTab:d}){const o=a===t;return e.jsx("button",{onClick:()=>d(t),className:`px-3 py-1.5 text-sm ${o?"bg-slate-100":"bg-white hover:bg-slate-50"}`,children:s})}function $({canManage:s}){const[t,a]=n.useState([]),[d,o]=n.useState(""),[y,u]=n.useState(""),[h,m]=n.useState(null),[x,j]=n.useState(null),[g,S]=n.useState(!1),c=async()=>{var i,f;u("");try{const{data:p}=await N.get("/branches",{params:{q:d}}),b=Array.isArray(p==null?void 0:p.items)?p.items:Array.isArray(p)?p:[];a(b)}catch(p){u(((f=(i=p==null?void 0:p.response)==null?void 0:i.data)==null?void 0:f.error)||p.message)}};n.useEffect(()=>{c()},[]);const r=n.useMemo(()=>t.find(i=>String(i.id)===String(h))||null,[t,h]),l=async i=>{var f,p;if(s&&window.confirm("Delete this branch?"))try{await N.delete(`/branches/${i}`),a(b=>b.filter(E=>String(E.id)!==String(i))),h===i&&m(null)}catch(b){alert(((p=(f=b==null?void 0:b.response)==null?void 0:f.data)==null?void 0:p.error)||b.message||"Delete failed")}},v=async i=>{var f,p;if(x){S(!0);try{const b=k(i);await N.put(`/branches/${x.id}`,b),j(null),c()}catch(b){alert(((p=(f=b==null?void 0:b.response)==null?void 0:f.data)==null?void 0:p.error)||b.message||"Update failed")}finally{S(!1)}}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Search"}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm",value:d,onChange:i=>o(i.target.value),placeholder:"name, code…"})]}),e.jsx("button",{onClick:c,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Apply"})]}),y&&e.jsx("div",{className:"text-sm text-red-600",children:y}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Code"}),e.jsx("th",{className:"py-2 px-3",children:"Manager"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"Address"}),e.jsx("th",{className:"py-2 px-3 text-right",children:"Actions"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-3 text-gray-500",children:"No branches yet."})}):t.map(i=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:i.name}),e.jsx("td",{className:"py-2 px-3",children:i.code||"—"}),e.jsx("td",{className:"py-2 px-3",children:i.managerName||i.manager_id||"—"}),e.jsx("td",{className:"py-2 px-3",children:i.phone||"—"}),e.jsx("td",{className:"py-2 px-3",children:i.address||"—"}),e.jsxs("td",{className:"py-2 px-3 text-right space-x-2",children:[e.jsx("button",{className:"text-blue-600 hover:underline",onClick:()=>m(i.id),children:"View"}),s&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-slate-700 hover:underline",onClick:()=>j(i),children:"Edit"}),e.jsx("button",{className:"text-rose-600 hover:underline",onClick:()=>l(i.id),children:"Delete"})]})]})]},i.id))})]})}),h&&r&&e.jsx(T,{branch:r,onClose:()=>m(null)}),x&&e.jsx(R,{title:"Edit Branch",initial:x,saving:g,onCancel:()=>j(null),onSave:v})]})}function B(){const[s,t]=n.useState({name:"",code:"",phone:"",address:""}),[a,d]=n.useState(!1),[o,y]=n.useState(""),[u,h]=n.useState(""),m=async()=>{var x,j;d(!0),h(""),y("");try{const g=k(s);await N.post("/branches",g),y("Branch created."),t({name:"",code:"",phone:"",address:""})}catch(g){h(((j=(x=g==null?void 0:g.response)==null?void 0:x.data)==null?void 0:j.error)||g.message||"Internal server error")}finally{d(!1)}};return e.jsxs("div",{className:"bg-white border rounded-xl p-3 grid gap-2 md:grid-cols-4 items-end",children:[["name","code","phone","address"].map(x=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:x}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:s[x],onChange:j=>t(g=>({...g,[x]:j.target.value})),placeholder:x==="code"?"e.g., 001":""})]},x)),e.jsx("button",{onClick:m,disabled:a||!s.name.trim(),className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:a?"Saving…":"Create"}),o&&e.jsx("div",{className:"text-sm text-emerald-700",children:o}),u&&e.jsx("div",{className:"text-sm text-red-600",children:u})]})}function I(){const[s,t]=n.useState([]),[a,d]=n.useState([]),[o,y]=n.useState(""),[u,h]=n.useState([]),[m,x]=n.useState(""),[j,g]=n.useState("");n.useEffect(()=>{(async()=>{try{const[{data:r},{data:l}]=await Promise.all([N.get("/branches"),N.get("/users",{params:{limit:1e3}})]),v=Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r)?r:[],i=Array.isArray(l==null?void 0:l.items)?l.items:Array.isArray(l==null?void 0:l.rows)?l.rows:Array.isArray(l)?l:[];t(v),d(i)}catch{}})()},[]);const S=r=>{h(l=>l.includes(r)?l.filter(v=>v!==r):[...l,r])},c=async()=>{var r,l;x(""),g("");try{await N.post(`/branches/${o}/assign-staff`,{userIds:u}),x("Assigned successfully.")}catch(v){g(((l=(r=v==null?void 0:v.response)==null?void 0:r.data)==null?void 0:l.error)||v.message)}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:o,onChange:r=>y(r.target.value),children:[e.jsx("option",{value:"",children:"Select branch"}),s.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("button",{onClick:c,disabled:!o||u.length===0,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:["Assign ",u.length?`(${u.length})`:""]}),m&&e.jsx("div",{className:"text-sm text-emerald-700",children:m}),j&&e.jsx("div",{className:"text-sm text-red-600",children:j})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"})]})}),e.jsx("tbody",{children:a.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"p-3 text-gray-500",children:"No users."})}):a.map(r=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:u.includes(r.id),onChange:()=>S(r.id)})}),e.jsx("td",{className:"py-2 px-3",children:r.name||`${r.firstName||""} ${r.lastName||""}`.trim()}),e.jsx("td",{className:"py-2 px-3",children:r.email}),e.jsx("td",{className:"py-2 px-3",children:r.role||(r.Roles||[]).map(l=>l.name).join(", ")||"—"})]},r.id))})]})})]})}function L(){const[s,t]=n.useState([]),[a,d]=n.useState(""),[o,y]=n.useState(""),[u,h]=n.useState(""),[m,x]=n.useState(null),[j,g]=n.useState("");n.useEffect(()=>{(async()=>{try{const{data:c}=await N.get("/branches"),r=Array.isArray(c==null?void 0:c.items)?c.items:Array.isArray(c)?c:[];t(r)}catch{}})()},[]);const S=async()=>{var c,r;g(""),x(null);try{const{data:l}=await N.get(`/branches/${a}/report`,{params:{from:o,to:u}});x((l==null?void 0:l.kpis)||l||null)}catch(l){g(((r=(c=l==null?void 0:l.response)==null?void 0:c.data)==null?void 0:r.error)||l.message)}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:a,onChange:c=>d(c.target.value),children:[e.jsx("option",{value:"",children:"Select"}),s.map(c=>e.jsx("option",{value:c.id,children:c.name},c.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:o,onChange:c=>y(c.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:u,onChange:c=>h(c.target.value)})]}),e.jsx("button",{onClick:S,disabled:!a,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Run"})]}),j&&e.jsx("div",{className:"text-sm text-red-600",children:j}),m&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(w,{title:"Staff",value:m.staffCount,tone:"indigo"}),e.jsx(w,{title:"Expenses",value:`TZS ${Number(m.expenses||0).toLocaleString()}`,tone:"amber"}),e.jsx(w,{title:"Loans Out",value:`TZS ${Number(m.loansOut||m.disbursed||0).toLocaleString()}`,tone:"emerald"}),e.jsx(w,{title:"Collections",value:`TZS ${Number(m.collections||m.collected||0).toLocaleString()}`,tone:"blue"})]})]})}function w({title:s,value:t,tone:a="indigo"}){const d={indigo:"text-indigo-600 bg-indigo-50",amber:"text-amber-600 bg-amber-50",emerald:"text-emerald-600 bg-emerald-50",blue:"text-blue-600 bg-blue-50"}[a]||"text-slate-600 bg-slate-50";return e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex items-center gap-3",children:[e.jsx("div",{className:`px-2 py-1 rounded ${d}`,children:s}),e.jsx("div",{className:"font-semibold",children:t??"—"})]})}function k(s){const t=d=>typeof d=="string"?d.trim():d,a={};if(t(s.name)&&(a.name=t(s.name)),t(s.code)&&(a.code=t(s.code)),t(s.address)&&(a.address=t(s.address)),t(s.phone)){const d=String(s.phone).replace(/[^\d+]/g,"");a.phone=d||void 0}return a}function R({title:s,initial:t,saving:a,onCancel:d,onSave:o}){const[y,u]=n.useState({name:(t==null?void 0:t.name)||"",code:(t==null?void 0:t.code)||"",phone:(t==null?void 0:t.phone)||"",address:(t==null?void 0:t.address)||""});return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl border w-full max-w-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:s}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:["name","code","phone","address"].map(h=>e.jsxs("div",{className:h==="address"?"sm:col-span-2":"",children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:h}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:y[h],onChange:m=>u(x=>({...x,[h]:m.target.value}))})]},h))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 border rounded",onClick:d,disabled:a,children:"Cancel"}),e.jsx("button",{className:"px-3 py-2 bg-blue-600 text-white rounded disabled:opacity-50",onClick:()=>o(y),disabled:a||!y.name.trim(),children:a?"Saving…":"Save"})]})]})})}function T({branch:s,onClose:t}){const[a,d]=n.useState(null);return n.useEffect(()=>{(async()=>{try{const{data:o}=await N.get(`/branches/${s.id}/report`);d((o==null?void 0:o.kpis)||o||null)}catch{}})()},[s.id]),e.jsxs("div",{className:"fixed inset-0 z-40",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:t}),e.jsxs("aside",{className:"absolute right-0 top-0 h-full w-full max-w-md bg-white border-l shadow-xl p-4 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Branch: ",s.name]}),e.jsx("button",{className:"px-2 py-1 border rounded",onClick:t,children:"Close"})]}),e.jsxs("section",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Code:"})," ",s.code||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Phone:"})," ",s.phone||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Address:"})," ",s.address||"—"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Manager:"})," ",s.managerName||s.manager_id||"—"]})]}),a&&e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-2",children:[e.jsx(w,{title:"Staff",value:a.staffCount,tone:"indigo"}),e.jsx(w,{title:"Loans Out",value:`TZS ${Number(a.loansOut||a.disbursed||0).toLocaleString()}`,tone:"emerald"}),e.jsx(w,{title:"Collections",value:`TZS ${Number(a.collections||a.collected||0).toLocaleString()}`,tone:"blue"}),e.jsx(w,{title:"Expenses",value:`TZS ${Number(a.expenses||0).toLocaleString()}`,tone:"amber"})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-sm font-semibold mb-2",children:"Quick actions"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("a",{className:"px-3 py-2 border rounded text-center hover:bg-slate-50",href:`/collections?branchId=${s.id}`,children:"Collections"}),e.jsx("a",{className:"px-3 py-2 border rounded text-center hover:bg-slate-50",href:`/expenses?branchId=${s.id}`,children:"Expenses"}),e.jsx("a",{className:"px-3 py-2 border rounded text-center hover:bg-slate-50",href:`/loans?branchId=${s.id}`,children:"Loans"}),e.jsx("a",{className:"px-3 py-2 border rounded text-center hover:bg-slate-50",href:`/reports/borrowers?branchId=${s.id}`,children:"Borrowers Report"})]})]})]})]})}export{D as default};

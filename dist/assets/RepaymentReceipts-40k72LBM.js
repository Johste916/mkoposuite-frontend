import{r as l,j as e,h as N}from"./index-CF8R0B4H.js";import{E as le}from"./jspdf.es.min-BHgfni5P.js";import ne from"./html2canvas.esm-CBrSDip1.js";const m={posted:"repayment:posted",approved:"repayment:approved",rejected:"repayment:rejected",bulk:"repayment:bulk-posted"},d=a=>Number(a||0).toLocaleString(),E=a=>new Date(a.getTime()-a.getTimezoneOffset()*6e4).toISOString().slice(0,10),G=()=>{const a=new Date;return a.setDate(a.getDate()-30),E(a)},de=(a,h={})=>{var c,b;try{if(typeof N.getUri=="function")return N.getUri({url:a,params:h})}catch{}const n=((b=(c=N)==null?void 0:c.defaults)==null?void 0:b.baseURL)||"",g=new URLSearchParams(h).toString();return`${n}${a}${g?`?${g}`:""}`};function me(){var Z,I,z,U,H;const[a,h]=l.useState(""),[n,g]=l.useState("approved"),[c,b]=l.useState(G()),[u,A]=l.useState(E(new Date)),[$,B]=l.useState([]),[C,F]=l.useState(0),[v,x]=l.useState(1),[f,Y]=l.useState(20),[w,M]=l.useState(!1),[Q,R]=l.useState(!1),[s,J]=l.useState(null),T=l.useRef(null),P=l.useMemo(()=>Math.max(1,Math.ceil(Number(C||0)/Number(f||1))),[C,f]),y=async()=>{M(!0);try{const r={page:v,pageSize:f};a.trim()&&(r.q=a.trim()),c&&(r.dateFrom=c),u&&(r.dateTo=u),n&&n!=="all"&&(r.status=n);const{data:t}=await N.get("/repayments",{params:r});let o=Array.isArray(t)?t:(t==null?void 0:t.items)||[];n&&n!=="all"&&(o=o.filter(j=>String(j.status||"").toLowerCase()===n)),B(o),F(Number((t==null?void 0:t.total)||o.length||0))}catch(r){console.error(r),B([]),F(0),alert("Failed to load receipts")}finally{M(!1)}};l.useEffect(()=>{y()},[v,f,c,u,n]),l.useEffect(()=>{const r=()=>y();return window.addEventListener(m.posted,r),window.addEventListener(m.approved,r),window.addEventListener(m.rejected,r),window.addEventListener(m.bulk,r),()=>{window.removeEventListener(m.posted,r),window.removeEventListener(m.approved,r),window.removeEventListener(m.rejected,r),window.removeEventListener(m.bulk,r)}},[]);const K=r=>{var t;(t=r==null?void 0:r.preventDefault)==null||t.call(r),x(1),y()},X=async r=>{try{const{data:t}=await N.get(`/repayments/${r.id}`);J(t||null),R(!0)}catch(t){console.error(t),alert("Failed to load receipt")}},ee=l.useMemo(()=>de("/repayments/export",{q:a||void 0,dateFrom:c||void 0,dateTo:u||void 0,status:n!=="all"?n:void 0}),[a,c,u,n]),re=async()=>{if(!T.current)return;const r=T.current,t=r.style.backgroundColor;r.style.backgroundColor="#ffffff";const o=await ne(r,{scale:2,backgroundColor:"#ffffff",useCORS:!0,windowWidth:r.scrollWidth,windowHeight:r.scrollHeight});r.style.backgroundColor=t||"";const j=o.toDataURL("image/png"),i=new le("p","mm","a4"),O=i.internal.pageSize.getWidth(),k=i.internal.pageSize.getHeight(),S=O,V=o.height*S/o.width;if(V<=k)i.addImage(j,"PNG",0,0,S,V);else{const L=o.width*k/O,p=document.createElement("canvas"),W=p.getContext("2d");p.width=o.width,p.height=L;let D=0,q=!0;for(;D<o.height;){W.clearRect(0,0,p.width,p.height),W.drawImage(o,0,D,o.width,L,0,0,p.width,p.height);const _=p.toDataURL("image/png");q?(i.addImage(_,"PNG",0,0,S,k),q=!1):(i.addPage(),i.addImage(_,"PNG",0,0,S,k)),D+=L}}const oe=`receipt_${(s==null?void 0:s.receiptNo)||(s==null?void 0:s.id)}.pdf`;i.save(oe)},se=async()=>{if(!(s!=null&&s.id))return;const r=`${window.location.origin}/repayments/receipts?id=${s.id}`;try{await navigator.clipboard.writeText(r),alert("Receipt link copied")}catch{alert(r)}},te=r=>(r.date||r.paymentDate||r.paidAt||r.createdAt||"").slice(0,10),ae=r=>Number(r.amount??r.amountPaid??0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"rounded-lg p-5 flex items-center justify-between",style:{background:"var(--card)",border:"2px solid var(--border-strong)",boxShadow:"0 10px 20px rgba(0,0,0,.08)"},children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Receipts"}),e.jsx("p",{className:"text-sm",style:{color:"var(--muted)"},children:"View, print or export receipts. Export respects your current filters."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:y,disabled:w,className:"px-3 py-2 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},children:w?"Refreshing…":"Refresh"}),e.jsx("a",{href:ee,target:"_blank",rel:"noreferrer",className:"btn-primary px-3 py-2 rounded inline-flex items-center justify-center",title:"Export filtered receipts as CSV",children:"Export CSV"})]})]}),e.jsx("div",{className:"rounded-lg p-5",style:{background:"var(--card)",border:"2px solid var(--border-strong)",boxShadow:"0 10px 20px rgba(0,0,0,.08)"},children:e.jsxs("form",{onSubmit:K,className:"grid md:grid-cols-7 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm mb-1",style:{color:"var(--muted)"},children:"Search"}),e.jsx("input",{className:"w-full rounded px-3 py-2 focus:outline-none focus:ring-2",style:{background:"var(--input-bg)",color:"var(--input-fg)",border:"2px solid var(--input-border)","--tw-ring-color":"var(--ring)"},placeholder:"Borrower / Phone / Loan Ref / Method / Receipt",value:a,onChange:r=>h(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",style:{color:"var(--muted)"},children:"Status"}),e.jsxs("select",{className:"w-full rounded px-3 py-2 focus:outline-none focus:ring-2",style:{background:"var(--input-bg)",color:"var(--input-fg)",border:"2px solid var(--input-border)","--tw-ring-color":"var(--ring)"},value:n,onChange:r=>{g(r.target.value),x(1)},children:[e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",style:{color:"var(--muted)"},children:"From"}),e.jsx("input",{type:"date",className:"w-full rounded px-3 py-2 focus:outline-none focus:ring-2",style:{background:"var(--input-bg)",color:"var(--input-fg)",border:"2px solid var(--input-border)","--tw-ring-color":"var(--ring)"},value:c,onChange:r=>b(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",style:{color:"var(--muted)"},children:"To"}),e.jsx("input",{type:"date",className:"w-full rounded px-3 py-2 focus:outline-none focus:ring-2",style:{background:"var(--input-bg)",color:"var(--input-fg)",border:"2px solid var(--input-border)","--tw-ring-color":"var(--ring)"},value:u,onChange:r=>A(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",style:{color:"var(--muted)"},children:"Page size"}),e.jsx("select",{className:"w-full rounded px-3 py-2 focus:outline-none focus:ring-2",style:{background:"var(--input-bg)",color:"var(--input-fg)",border:"2px solid var(--input-border)","--tw-ring-color":"var(--ring)"},value:f,onChange:r=>{Y(Number(r.target.value)),x(1)},children:[20,50,100].map(r=>e.jsx("option",{value:r,children:r},r))})]}),e.jsxs("div",{className:"md:col-span-2 flex items-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},onClick:()=>{h(""),g("approved"),b(G()),A(E(new Date)),x(1),y()},children:"Reset"}),e.jsx("button",{type:"submit",className:"btn-primary px-3 py-2 rounded inline-flex items-center justify-center",children:"Search"})]})]})}),e.jsxs("div",{className:"rounded-lg overflow-hidden",style:{background:"var(--card)",border:"2px solid var(--border-strong)",boxShadow:"0 10px 20px rgba(0,0,0,.08)"},children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{style:{background:"var(--table-head-bg)",color:"var(--fg)"},children:["Receipt No","Date","Loan Ref","Borrower","Method","Amount","Status","Action"].map((r,t)=>e.jsx("th",{className:`p-3 text-left ${t===7?"text-right":""}`,style:{borderBottom:"1px solid var(--border)"},children:r},r))})}),e.jsxs("tbody",{children:[!w&&$.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",style:{color:"var(--muted)"},colSpan:8,children:"No data."})}),$.map(r=>{const t=r.Loan||r.loan||{},o=t.Borrower||{},j=r.currency||t.currency||"TZS",i=ae(r);return e.jsxs("tr",{style:{borderTop:"1px solid var(--border)"},children:[e.jsx("td",{className:"p-3",children:r.receiptNo||`RCPT-${r.id}`}),e.jsx("td",{className:"p-3",children:te(r)}),e.jsx("td",{className:"p-3",children:t.reference||`L-${t.id||r.loanId||""}`}),e.jsx("td",{className:"p-3",children:o.name||o.fullName||"—"}),e.jsx("td",{className:"p-3 capitalize",children:r.method||"cash"}),e.jsxs("td",{className:"p-3",children:[j," ",d(i)]}),e.jsx("td",{className:"p-3",children:(r.status||"").toUpperCase()||"—"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},onClick:()=>X(r),children:"View"}),e.jsx("a",{className:"px-3 py-1.5 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},href:`/repayments/receipts?id=${r.id}`,target:"_blank",rel:"noreferrer",children:"Open Page"})]})})]},r.id)}),w&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:8,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3",style:{borderTop:"1px solid var(--border)"},children:[e.jsxs("p",{className:"text-xs",style:{color:"var(--muted)"},children:["Page ",v," of ",P," • ",C," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded disabled:opacity-50",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},disabled:v<=1,onClick:()=>x(r=>Math.max(1,r-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded disabled:opacity-50",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},disabled:v>=P,onClick:()=>x(r=>Math.min(P,r+1)),children:"Next"})]})]})]}),Q&&s&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>R(!1)}),e.jsxs("div",{ref:T,className:"relative w-full max-w-2xl rounded-lg p-6 print:bg-white",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)",boxShadow:"0 10px 28px rgba(0,0,0,.12)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Receipt #",s.receiptNo||s.id]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},onClick:()=>window.print(),children:"Print"}),e.jsx("button",{className:"px-3 py-1.5 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},onClick:re,children:"Download PDF"}),e.jsx("button",{className:"px-3 py-1.5 rounded",style:{background:"var(--card)",color:"var(--fg)",border:"2px solid var(--border-strong)"},onClick:se,children:"Copy Link"}),e.jsx("button",{className:"btn-primary px-3 py-1.5 rounded",onClick:()=>R(!1),children:"Close"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Date:"})," ",(s.date||"").slice(0,10)]}),e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Method:"})," ",s.method||"cash"]}),s.reference&&e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Reference:"})," ",s.reference]}),s.notes&&e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Notes:"})," ",s.notes]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{style:{color:"var(--muted)"},children:"Amount"}),e.jsxs("p",{className:"text-xl font-semibold",children:[s.currency||"TZS"," ",d(s.amount)]})]})]}),e.jsxs("div",{className:"my-4 pt-4 text-sm",style:{borderTop:"1px solid var(--border)"},children:[e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Loan:"})," ",(Z=s.loan)==null?void 0:Z.reference]}),e.jsxs("p",{children:[e.jsx("span",{style:{color:"var(--muted)"},children:"Borrower:"})," ",(I=s.loan)==null?void 0:I.borrowerName]})]}),!!((z=s==null?void 0:s.allocation)!=null&&z.length)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto rounded",style:{border:"1px solid var(--border)"},children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{style:{background:"var(--table-head-bg)",color:"var(--fg)"},children:["Period","Principal","Interest","Fees","Penalties"].map(r=>e.jsx("th",{className:"p-2 text-left",style:{borderBottom:"1px solid var(--border)"},children:r},r))})}),e.jsx("tbody",{children:s.allocation.map((r,t)=>e.jsxs("tr",{style:{borderTop:"1px solid var(--border)"},children:[e.jsx("td",{className:"p-2",children:r.period}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(r.principal)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(r.interest)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(r.fees)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(r.penalties)]})]},t))}),s.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"font-medium",style:{borderTop:"1px solid var(--border)"},children:[e.jsx("td",{className:"p-2",children:"Totals"}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(s.totals.principal)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(s.totals.interest)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(s.totals.fees)]}),e.jsxs("td",{className:"p-2",children:[s.currency||"TZS"," ",d(s.totals.penalties)]})]})})]})})]}),e.jsxs("div",{className:"mt-6 text-xs",style:{color:"var(--muted)"},children:[e.jsxs("p",{children:["Posted by: ",((U=s.postedBy)==null?void 0:U.name)||"—"," ",(H=s.postedBy)!=null&&H.email?`(${s.postedBy.email})`:""]}),e.jsx("p",{className:"mt-2",children:"This is a system generated receipt."})]})]})]}),e.jsx("style",{children:`
        @media print {
          body { background: white; }
          @page { margin: 12mm; }
        }
      `})]})}export{me as default};

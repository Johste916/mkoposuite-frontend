import{i as Ze,u as Ge,r as i,j as e,L as U,g as d}from"./index-DSXeOGvG.js";import{c as He,f as h,d as F,e as Ke,g as Qe,h as Xe,S as Ye,n as et,i as fe}from"./ScheduleTable-oaMp2X_c.js";const tt={pending:"bg-yellow-100 text-yellow-800 ring-yellow-200",approved:"bg-blue-100 text-blue-800 ring-blue-200",rejected:"bg-gray-200 text-gray-700 ring-gray-300",disbursed:"bg-indigo-100 text-indigo-800 ring-indigo-200",active:"bg-emerald-100 text-emerald-800 ring-emerald-200",closed:"bg-slate-200 text-slate-700 ring-slate-300"},ve="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-semibold ring-1 ring-inset",Ne="inline-flex items-center gap-1 text-blue-700 font-semibold underline underline-offset-4 decoration-2 hover:text-blue-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 rounded",st=()=>{try{return(JSON.parse(localStorage.getItem("user")||"{}").role||"").toLowerCase()}catch{return""}},R=n=>n==="admin"||n==="director"||n==="superadmin",at=n=>["branch_manager","manager","bm"].includes(n)||R(n),nt=n=>["compliance","compliance_officer","legal"].includes(n)||R(n),lt=n=>["accountant","finance"].includes(n)||R(n),rt=n=>["loan_officer","officer"].includes(n)&&!R(n);function it(n){if(!n)return"";const b=String(n).toLowerCase();return b==="pending"?"submitted":b==="approved"?"accounting":""}const V=({title:n,subtitle:b,right:s,children:J,dense:c=!1})=>e.jsxs("div",{className:"bg-white border-2 border-slate-300 rounded-2xl shadow-md",children:[e.jsxs("div",{className:`px-6 ${c?"py-3":"py-4"} border-b-2 border-slate-200 bg-slate-50 flex items-center justify-between`,children:[e.jsxs("div",{children:[n&&e.jsx("h3",{className:"text-lg md:text-xl font-semibold tracking-tight",children:n}),b&&e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:b})]}),s]}),e.jsx("div",{className:`px-6 ${c?"py-4":"py-6"} text-[15px]`,children:J})]}),f=({children:n})=>e.jsx("div",{className:"text-[12px] uppercase tracking-wide text-gray-600",children:n});function ct(){var ye;const{id:n}=Ze(),b=Ge(),[s,J]=i.useState(null),[c,Q]=i.useState(null),[v,X]=i.useState([]),[Y,$]=i.useState([]),[x,P]=i.useState(null),[we,ee]=i.useState(!0),[Se,te]=i.useState(!0),[Ce,se]=i.useState(!0),[ke,ae]=i.useState(!1),[ne,le]=i.useState(null),[o,D]=i.useState(""),[w,re]=i.useState(""),[p,E]=i.useState(!1),[Z,G]=i.useState(""),[Re,O]=i.useState(!1),[ie,de]=i.useState(!1),[S,L]=i.useState({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),[De,H]=i.useState(!1),[Le,T]=i.useState(!1),[u,M]=i.useState({amount:"",interestRate:"",termMonths:"",startDate:""}),[oe,ce]=i.useState(!1),[Me,_]=i.useState(!1),[y,I]=i.useState({termMonths:"",startDate:"",previewOnly:!1}),[me,xe]=i.useState(!1),m=(s==null?void 0:s.currency)||"TZS",Ae=tt[s==null?void 0:s.status]||"bg-slate-100 text-slate-800 ring-slate-200",C=st(),K=at(C),ue=nt(C),Fe=lt(C),$e=rt(C),Pe=R(C)||K||ue,Ee=R(C)||K,k=(s==null?void 0:s.workflowStage)||it(s==null?void 0:s.status),he=$e&&["changes_requested","bm_changes_requested","compliance_changes_requested","returned_to_officer","request_changes"].includes(k),B=K&&["submitted","bm_review","changes_resubmitted"].includes(k),pe=ue&&["compliance","compliance_review"].includes(k),ge=Fe&&((s==null?void 0:s.status)==="approved"||k==="accounting"),be=i.useRef(null),g=async()=>{ee(!0),le(null);try{const{data:t}=await d.get(`/loans/${n}`);J(t),re(String((t==null?void 0:t.amount)??""));const a=[d.get(`/repayments/loan/${n}`).then(r=>X(r.data||[])).catch(()=>X([])).finally(()=>te(!1)),d.get(`/comments/loan/${n}`).then(r=>$(Array.isArray(r.data)?r.data:[])).catch(r=>{var l;console.warn("Comments fetch failed:",((l=r==null?void 0:r.response)==null?void 0:l.data)||(r==null?void 0:r.message)),$([])}).finally(()=>se(!1))];t!=null&&t.productId&&a.push(d.get(`/loan-products/${t.productId}`).then(r=>Q(r.data)).catch(()=>Q(null))),ae(!0),a.push(d.get(`/loans/${n}/schedule`).then(r=>P(et(r.data))).catch(()=>P(null)).finally(()=>ae(!1))),await Promise.all(a)}catch(t){console.error(t),le("Failed to fetch loan.")}finally{ee(!1)}};i.useEffect(()=>{be.current!==n&&(be.current=n,P(null),D(""),G(""),te(!0),se(!0),g())},[n]),i.useEffect(()=>{const t=()=>g();return window.addEventListener("focus",t),()=>window.removeEventListener("focus",t)},[]),i.useEffect(()=>{const t=a=>{var r;String((r=a==null?void 0:a.detail)==null?void 0:r.id)===String(n)&&g()};return window.addEventListener("loan:updated",t),()=>window.removeEventListener("loan:updated",t)},[n]);async function A(t){try{await d.post("/comments",{loanId:n,content:t});const a=await d.get(`/comments/loan/${n}`);$(Array.isArray(a.data)?a.data:[])}catch{}}async function q(t,a={}){E(!0);try{await d.post(`/loans/${n}/workflow`,{action:t,comment:(o==null?void 0:o.trim())||void 0,suggestedAmount:a.suggestedAmount!=null&&a.suggestedAmount!==""?Number(a.suggestedAmount):void 0}),await g(),D(""),alert("Action applied.")}catch{try{t==="bm_approve"||t==="compliance_approve"?(await d.patch(`/loans/${n}/status`,{status:"approved"}),o.trim()&&await A(o.trim())):t==="reject"?(await d.patch(`/loans/${n}/status`,{status:"rejected"}),o.trim()&&await A(o.trim())):t==="request_changes"?o.trim()&&await A(`Changes requested: ${o.trim()}`):t==="resubmit"&&(await d.patch(`/loans/${n}/status`,{status:"pending"}),o.trim()&&await A(`Resubmitted: ${o.trim()}`)),await g(),D(""),alert("Action applied (fallback).")}catch(l){console.error(l),alert("Failed to apply action.")}}finally{E(!1)}}async function Oe(){if(!w||Number(w)<=0){alert("Enter a valid amount.");return}E(!0);try{await d.patch(`/loans/${n}`,{amount:Number(w)}),o.trim()&&await A(`Suggested amount: ${h(w,m)} — ${o.trim()}`),await g(),alert("Suggestion saved.")}catch(t){console.error(t),alert("Failed to save suggestion.")}finally{E(!1)}}const Te=async()=>{const t=Number(z||0);if(!(t>0&&!window.confirm("Outstanding > 0. Close anyway?")))try{await d.patch(`/loans/${n}/status`,{status:"closed",override:t>0}),await g(),alert("Loan closed.")}catch(a){console.error(a),alert("Failed to close loan.")}},_e=async()=>{if(Z.trim())try{const t=await d.post("/comments",{loanId:n,content:Z});$(a=>[t.data,...a]),G("")}catch(t){console.error(t),alert("Failed to add comment.")}},Ie=async()=>{const t=Number(S.amount);if(!t||t<=0)return alert("Enter a valid amount.");de(!0);try{if(await d.post("/repayments",{loanId:n,...S,amount:t}),s!=null&&s.status&&!["active","closed"].includes(String(s.status).toLowerCase()))try{await d.patch(`/loans/${n}/status`,{status:"active"})}catch{}await g(),O(!1),L({amount:"",date:new Date().toISOString().slice(0,10),method:"cash",notes:""}),window.dispatchEvent(new CustomEvent("loan:updated",{detail:{id:n}})),alert("Repayment posted.")}catch(a){console.error(a),alert("Failed to post repayment.")}finally{de(!1)}},Be=()=>{M({amount:(s==null?void 0:s.amount)??"",interestRate:(s==null?void 0:s.interestRate)??"",termMonths:(s==null?void 0:s.termMonths)??(s==null?void 0:s.durationMonths)??"",startDate:fe((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate))}),T(!0)},qe=async()=>{var a,r;const t={amount:u.amount===""?void 0:Number(u.amount),interestRate:u.interestRate===""?void 0:Number(u.interestRate),termMonths:u.termMonths===""?void 0:Number(u.termMonths),startDate:u.startDate||void 0};if(Number.isFinite(t.amount)&&t.amount<=0)return alert("Amount must be > 0");if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");ce(!0);try{await d.patch(`/loans/${n}`,t),T(!1),await g(),alert("Loan updated.")}catch(l){console.error(l),alert(((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.error)||"Failed to update loan.")}finally{ce(!1)}},ze=async()=>{var t,a;if(window.confirm("This will permanently delete this loan. Continue?"))try{await d.delete(`/loans/${n}`),alert("Loan deleted."),b("/loans")}catch(r){console.error(r),alert(((a=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to delete loan.")}},We=()=>{I({termMonths:(s==null?void 0:s.termMonths)??"",startDate:fe((s==null?void 0:s.startDate)||(s==null?void 0:s.releaseDate)),previewOnly:!1}),_(!0)},Ue=async()=>{var a,r;const t={termMonths:y.termMonths===""?void 0:Number(y.termMonths),startDate:y.startDate||void 0,previewOnly:!!y.previewOnly};if(Number.isFinite(t.termMonths)&&t.termMonths<=0)return alert("Term must be > 0");xe(!0);try{const{data:l}=await d.post(`/loans/${n}/reschedule`,t);Array.isArray(l==null?void 0:l.schedule)&&P(l.schedule),_(!1),await g(),alert((l==null?void 0:l.message)||"Schedule updated.")}catch(l){console.error(l),alert(((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.error)||"Failed to reschedule.")}finally{xe(!1)}},Ve=async()=>{var t,a,r;if(window.confirm("Reissue creates a new pending loan cloned from this one. Continue?"))try{const{data:l}=await d.post(`/loans/${n}/reissue`),je=((t=l==null?void 0:l.loan)==null?void 0:t.id)||(l==null?void 0:l.id);alert("New loan created."),je&&b(`/loans/${je}`)}catch(l){console.error(l),alert(((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.error)||"Failed to reissue loan.")}},j=i.useMemo(()=>He(x||[],v||[]),[x,v]),z=(s==null?void 0:s.status)==="closed"?0:j.outstanding??(s==null?void 0:s.outstanding)??null,N=j.nextDue,W=i.useMemo(()=>{const t=v.length||0,a=v.reduce((r,l)=>r+Number(l.amount||0),0);return{count:t,sum:a}},[v]),Je=(s==null?void 0:s.status)!=="closed"&&Number(z||0)>0;return we?e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6",children:"Loading loan…"}):ne?e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6 text-red-600",children:ne}):s?e.jsxs("div",{className:"max-w-screen-2xl mx-auto px-6 py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Loan Details"}),e.jsx("span",{className:`${ve} ${Ae}`,children:s.status}),k&&e.jsxs("span",{className:`${ve} bg-indigo-50 text-indigo-700 ring-indigo-200`,children:["Stage: ",k.replaceAll("_"," ")]})]}),e.jsx("button",{onClick:()=>b(-1),className:Ne,children:"← Back"})]}),e.jsxs(V,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx(f,{children:"Borrower"}),e.jsxs(U,{className:`${Ne} text-lg md:text-xl`,to:`/borrowers/${s.borrowerId}`,children:[((ye=s.Borrower)==null?void 0:ye.name)||s.borrowerName||"N/A"," ",e.jsx("span",{children:"›"})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Amount"}),e.jsx("div",{className:"text-2xl font-semibold",children:h(s.amount,m)})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Interest"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-medium",children:[s.interestRate,"%"]})," ",e.jsxs("span",{className:"text-gray-600",children:["· ",s.interestMethod||"—"]})]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Term"}),e.jsxs("div",{className:"text-base",children:[s.termMonths||s.durationMonths," months"]})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Start / Release"}),e.jsx("div",{className:"text-base",children:F(s.startDate||s.releaseDate)})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Outstanding"}),e.jsx("div",{className:"text-2xl font-semibold",children:z==null?"—":h(z,m)})]}),e.jsxs("div",{children:[e.jsx(f,{children:"Next Due"}),e.jsx("div",{className:"text-base",children:N?e.jsxs(e.Fragment,{children:[F(N.date)," ·"," ",e.jsx("span",{className:"font-medium",children:h(N.amount,m)})]}):"—"})]}),c&&e.jsxs("div",{className:"md:col-span-2 lg:col-span-3 xl:col-span-4",children:[e.jsx(f,{children:"Product"}),e.jsxs("div",{className:"text-base",children:[e.jsxs("span",{className:"font-semibold",children:[c.name,c.code?` (${c.code})`:""]}),e.jsxs("div",{className:"text-gray-600 text-sm",children:["Defaults: ",c.interestMethod," @"," ",c.interestRate??c.defaultInterestRate,"% · Limits:"," ",h(c.minPrincipal,m)," –"," ",h(c.maxPrincipal,m),", ",c.minTermMonths,"-",c.maxTermMonths," months"]})]})]})]}),e.jsx("div",{className:"mt-6 grid sm:grid-cols-3 lg:grid-cols-6 gap-4 text-sm",children:[["Paid Principal",j.paidPrincipal],["Paid Interest",j.paidInterest],["Paid Penalties",j.paidPenalty],["Paid Fees",j.paidFees],["Total Paid",j.totalPaid],["Total Scheduled",j.scheduledTotal]].map(([t,a])=>e.jsxs("div",{className:"rounded-xl border-2 border-slate-200 p-3",children:[e.jsx("div",{className:"text-gray-500 text-[12px]",children:t}),e.jsx("div",{className:"font-semibold text-base",children:h(a,m)})]},t))})]}),(he||B||pe||ge)&&e.jsxs(V,{dense:!0,children:[he&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Changes Requested"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Update the application and attach missing documents, then"," ",e.jsx("strong",{children:"Resubmit"}),". Add a short note if helpful."]}),e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment (optional)"}),e.jsx("textarea",{value:o,onChange:t=>D(t.target.value),className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"What did you fix / add?"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>q("resubmit"),disabled:p,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",title:"Send for review again",children:p?"Submitting…":"Resubmit for Review"}),e.jsx(U,{to:"/loans/applications",className:"px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",title:"Open applications to edit details/attachments",children:"Edit Application"})]})]}),(B||pe)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-semibold",children:B?"Branch Manager Review":"Compliance Review"})}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Suggested Principal"}),e.jsx("input",{type:"number",className:"border rounded-lg px-3 py-2 w-full",value:w,onChange:t=>re(t.target.value),min:"0",step:"0.01"}),e.jsx("p",{className:"text-[11px] text-gray-500 mt-1",children:"Save a suggestion or approve with a different amount."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600",children:"Comment"}),e.jsx("textarea",{className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"Why approving / changes / rejection?",value:o,onChange:t=>D(t.target.value)})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>q(B?"bm_approve":"compliance_approve",{suggestedAmount:w}),disabled:p,className:"bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 disabled:opacity-60",children:p?"Working…":"Approve"}),e.jsx("button",{onClick:()=>q("request_changes"),disabled:p,className:"bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 disabled:opacity-60",title:"Send back to Loan Officer with requested changes",children:p?"Working…":"Request Changes"}),e.jsx("button",{onClick:()=>q("reject"),disabled:p,className:"bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 disabled:opacity-60",children:p?"Working…":"Reject"}),e.jsx("button",{onClick:Oe,disabled:p,className:"px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50 disabled:opacity-60",children:p?"Saving…":"Save Suggestion"})]})]}),ge&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"This loan is approved. Proceed to disbursement to finalize payout."}),e.jsx(U,{to:`/loans/${n}/disburse`,className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700",children:"Disburse"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 md:gap-3",children:[e.jsx(U,{to:"/loans",className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Back to Loans"}),e.jsx("button",{onClick:()=>H(!0),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"View Schedule"}),e.jsx("button",{onClick:()=>Ke({loan:s,schedule:x||[],currency:m}),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",disabled:!Array.isArray(x)||!x.length,children:"Export CSV"}),e.jsx("button",{onClick:()=>Qe({loan:s,schedule:x||[],currency:m}),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",disabled:!Array.isArray(x)||!x.length,children:"Export PDF"}),Je&&e.jsx("button",{onClick:()=>O(!0),className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Post Repayment"}),Pe&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Be,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Edit Loan"}),e.jsx("button",{onClick:We,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Reschedule"})]}),e.jsx("button",{onClick:Ve,className:"px-3 md:px-4 py-2 rounded-lg border-2 border-slate-300 hover:bg-gray-50",children:"Reissue"}),Ee&&e.jsx("button",{onClick:ze,className:"bg-red-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-700",children:"Delete"}),s.status!=="closed"&&e.jsx("button",{onClick:Te,className:"bg-red-50 text-red-700 px-3 md:px-4 py-2 rounded-lg border-2 border-red-200 hover:bg-red-100",children:"Close Loan"})]}),e.jsx(V,{title:"Repayments",right:e.jsxs("div",{className:"text-xs text-gray-500",children:[W.count," record",W.count===1?"":"s"," · Total"," ",e.jsx("span",{className:"font-semibold",children:h(W.sum,m)})]}),children:Se?e.jsx("p",{children:"Loading repayments…"}):v.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"No repayments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-base",children:[e.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10",children:e.jsxs("tr",{className:"text-left",children:[e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"#"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Date"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200 text-right",children:"Amount"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Method"}),e.jsx("th",{className:"px-3 py-3 border-b-2 border-slate-200",children:"Notes"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:v.map((t,a)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:a+1}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:F(t.date)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:h(t.amount,m)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-700 ring-1 ring-slate-200",children:t.method||"—"})}),e.jsx("td",{className:"px-3 py-2",children:t.notes||"—"})]},t.id||a))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-slate-50",children:[e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200 text-sm font-medium",colSpan:2,children:"Total"}),e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200 text-right text-base font-semibold",children:h(W.sum,m)}),e.jsx("td",{className:"px-3 py-3 border-t-2 border-slate-200",colSpan:2})]})})]})})}),e.jsxs(V,{title:"Comments",children:[Ce?e.jsx("p",{children:"Loading comments…"}):Y.length===0?e.jsx("div",{className:"text-sm text-gray-600",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-72 overflow-auto pr-1",children:Y.map((t,a)=>{var r,l;return e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-semibold select-none",children:(((r=t.author)==null?void 0:r.name)||"U").slice(0,1).toUpperCase()}),e.jsxs("div",{className:"flex-1 border-b pb-2",children:[e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{className:"font-medium text-gray-700",children:((l=t.author)==null?void 0:l.name)||"User"}),e.jsx("span",{children:Xe(t.createdAt)})]}),e.jsx("p",{className:"text-sm mt-0.5",children:t.content})]})]},t.id||a)})}),e.jsxs("div",{className:"mt-4 flex items-start gap-2",children:[e.jsx("textarea",{value:Z,onChange:t=>G(t.target.value),className:"border rounded-lg px-3 py-2 w-full min-h-[44px]",placeholder:"Add a comment"}),e.jsx("button",{onClick:_e,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:"Post"})]})]}),Re&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Post Repayment"}),e.jsx("button",{onClick:()=>O(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:S.amount,onChange:t=>L(a=>({...a,amount:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Date"}),e.jsx("input",{type:"date",value:S.date,onChange:t=>L(a=>({...a,date:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Method"}),e.jsxs("select",{value:S.method,onChange:t=>L(a=>({...a,method:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"mobile",children:"Mobile Money"}),e.jsx("option",{value:"bank",children:"Bank"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:S.notes,onChange:t=>L(a=>({...a,notes:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",placeholder:"Receipt no., reference, etc."})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>O(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:Ie,disabled:ie,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-60",children:ie?"Posting…":"Post"})]})]})}),De&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-5xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Repayment Schedule"}),e.jsx("button",{onClick:()=>H(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),ke?e.jsx("p",{children:"Loading schedule…"}):!Array.isArray(x)||x.length===0?e.jsx("p",{children:"No schedule available."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3 text-sm text-gray-600 space-y-1",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Disbursed:"})," ",F((s==null?void 0:s.releaseDate)||(s==null?void 0:s.startDate))||"—"]}),e.jsxs("div",{children:["Next installment: ",N?e.jsxs(e.Fragment,{children:[e.jsxs("b",{children:["#",N.idx]})," on ",F(N.date)," —"," ",e.jsx("b",{children:h(N.amount,m)})]}):"—"]})]}),e.jsx("div",{className:"max-h-[70vh] overflow-auto",children:e.jsx(Ye,{schedule:x||[],currency:m})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{onClick:()=>H(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Close"})})]})}),Le&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Edit Loan"}),e.jsx("button",{onClick:()=>T(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Amount"}),e.jsx("input",{type:"number",value:u.amount,onChange:t=>M(a=>({...a,amount:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Interest Rate (%)"}),e.jsx("input",{type:"number",value:u.interestRate,onChange:t=>M(a=>({...a,interestRate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Term (months)"}),e.jsx("input",{type:"number",value:u.termMonths,onChange:t=>M(a=>({...a,termMonths:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Start Date"}),e.jsx("input",{type:"date",value:u.startDate,onChange:t=>M(a=>({...a,startDate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>T(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:qe,disabled:oe,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:oe?"Saving…":"Save"})]})]})}),Me&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-xl font-semibold",children:"Reschedule Loan"}),e.jsx("button",{onClick:()=>_(!1),className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"New Term (months)"}),e.jsx("input",{type:"number",value:y.termMonths,onChange:t=>I(a=>({...a,termMonths:t.target.value})),className:"border rounded-lg px-3 py-2 w-full",min:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"New Start Date"}),e.jsx("input",{type:"date",value:y.startDate,onChange:t=>I(a=>({...a,startDate:t.target.value})),className:"border rounded-lg px-3 py-2 w-full"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:y.previewOnly,onChange:t=>I(a=>({...a,previewOnly:t.target.checked}))}),"Preview only (don’t save)"]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>_(!1),className:"px-4 py-2 rounded-lg border-2 border-slate-300",children:"Cancel"}),e.jsx("button",{onClick:Ue,disabled:me,className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:me?"Working…":y.previewOnly?"Preview":"Reschedule"})]})]})})]}):e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6",children:"Loan not found."})}export{ct as default};

import{r as n,j as e,b as f}from"./index-Beh6sWFf.js";import{E as re}from"./jspdf.es.min-DEsxMF7k.js";import ne from"./html2canvas.esm-CBrSDip1.js";const i=l=>Number(l||0).toLocaleString(),L=l=>new Date(l.getTime()-l.getTimezoneOffset()*6e4).toISOString().slice(0,10),G=()=>{const l=new Date;return l.setDate(l.getDate()-30),L(l)},ce=(l,x={})=>{var d,g;try{if(typeof f.getUri=="function")return f.getUri({url:l,params:x})}catch{}const c=((g=(d=f)==null?void 0:d.defaults)==null?void 0:g.baseURL)||"",u=new URLSearchParams(x).toString();return`${c}${l}${u?`?${u}`:""}`};function me(){var M,z,B,E,U;const[l,x]=n.useState(""),[c,u]=n.useState("approved"),[d,g]=n.useState(G()),[h,A]=n.useState(L(new Date)),[$,F]=n.useState([]),[k,Z]=n.useState(0),[j,p]=n.useState(1),[N,_]=n.useState(20),[y,I]=n.useState(!1),[Q,C]=n.useState(!1),[t,Y]=n.useState(null),R=n.useRef(null),P=n.useMemo(()=>Math.max(1,Math.ceil(Number(k||0)/Number(N||1))),[k,N]),w=async()=>{I(!0);try{const s={page:j,pageSize:N};l.trim()&&(s.q=l.trim()),d&&(s.dateFrom=d),h&&(s.dateTo=h),c&&c!=="all"&&(s.status=c);const{data:a}=await f.get("/repayments",{params:s});let r=Array.isArray(a)?a:(a==null?void 0:a.items)||[];c&&c!=="all"&&(r=r.filter(b=>String(b.status||"").toLowerCase()===c)),F(r),Z(Number((a==null?void 0:a.total)||r.length||0))}catch(s){console.error(s),F([]),Z(0),alert("Failed to load receipts")}finally{I(!1)}};n.useEffect(()=>{w()},[j,N,d,h,c]);const J=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),p(1),w()},K=async s=>{try{const{data:a}=await f.get(`/repayments/${s.id}`);Y(a||null),C(!0)}catch(a){console.error(a),alert("Failed to load receipt")}},X=n.useMemo(()=>ce("/repayments/export",{q:l||void 0,dateFrom:d||void 0,dateTo:h||void 0,status:c!=="all"?c:void 0}),[l,d,h,c]),ee=async()=>{if(!R.current)return;const s=R.current,a=s.style.backgroundColor;s.style.backgroundColor="#ffffff";const r=await ne(s,{scale:2,backgroundColor:"#ffffff",useCORS:!0,windowWidth:s.scrollWidth,windowHeight:s.scrollHeight});s.style.backgroundColor=a||"";const b=r.toDataURL("image/png"),o=new re("p","mm","a4"),H=o.internal.pageSize.getWidth(),v=o.internal.pageSize.getHeight(),S=H,O=r.height*S/r.width;if(O<=v)o.addImage(b,"PNG",0,0,S,O);else{const D=r.width*v/H,m=document.createElement("canvas"),W=m.getContext("2d");m.width=r.width,m.height=D;let T=0,q=!0;for(;T<r.height;){W.clearRect(0,0,m.width,m.height),W.drawImage(r,0,T,r.width,D,0,0,m.width,m.height);const V=m.toDataURL("image/png");q?(o.addImage(V,"PNG",0,0,S,v),q=!1):(o.addPage(),o.addImage(V,"PNG",0,0,S,v)),T+=D}}const le=`receipt_${(t==null?void 0:t.receiptNo)||(t==null?void 0:t.id)}.pdf`;o.save(le)},se=async()=>{if(!(t!=null&&t.id))return;const s=`${window.location.origin}/repayments/receipts?id=${t.id}`;try{await navigator.clipboard.writeText(s),alert("Receipt link copied")}catch{alert(s)}},te=s=>(s.date||s.paymentDate||s.paidAt||s.createdAt||"").slice(0,10),ae=s=>Number(s.amount??s.amountPaid??0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Receipts"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"View, print or export receipts. Export respects your current filters."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:w,disabled:y,className:"px-3 py-2 rounded border",children:y?"Refreshing…":"Refresh"}),e.jsx("a",{href:X,target:"_blank",rel:"noreferrer",className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export filtered receipts as CSV",children:"Export CSV"})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5",children:e.jsxs("form",{onSubmit:J,className:"grid md:grid-cols-7 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Search"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Borrower / Phone / Loan Ref / Method / Receipt",value:l,onChange:s=>x(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Status"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:c,onChange:s=>{u(s.target.value),p(1)},children:[e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"From"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:d,onChange:s=>g(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"To"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:h,onChange:s=>A(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Page size"}),e.jsx("select",{className:"w-full border rounded px-3 py-2",value:N,onChange:s=>{_(Number(s.target.value)),p(1)},children:[20,50,100].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"md:col-span-2 flex items-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border",onClick:()=>{x(""),u("approved"),g(G()),A(L(new Date)),p(1),w()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Search"})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-0 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Receipt No"}),e.jsx("th",{className:"p-3",children:"Date"}),e.jsx("th",{className:"p-3",children:"Loan Ref"}),e.jsx("th",{className:"p-3",children:"Borrower"}),e.jsx("th",{className:"p-3",children:"Method"}),e.jsx("th",{className:"p-3",children:"Amount"}),e.jsx("th",{className:"p-3",children:"Status"}),e.jsx("th",{className:"p-3 text-right",children:"Action"})]})}),e.jsxs("tbody",{children:[!y&&$.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-gray-500",colSpan:8,children:"No data."})}),$.map(s=>{const a=s.Loan||s.loan||{},r=a.Borrower||{},b=s.currency||a.currency||"TZS",o=ae(s);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.receiptNo||`RCPT-${s.id}`}),e.jsx("td",{className:"p-3",children:te(s)}),e.jsx("td",{className:"p-3",children:a.reference||`L-${a.id||s.loanId||""}`}),e.jsx("td",{className:"p-3",children:r.name||r.fullName||"—"}),e.jsx("td",{className:"p-3 capitalize",children:s.method||"cash"}),e.jsxs("td",{className:"p-3",children:[b," ",i(o)]}),e.jsx("td",{className:"p-3",children:(s.status||"").toUpperCase()||"—"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>K(s),children:"View"}),e.jsx("a",{className:"px-3 py-1.5 rounded border",href:`/repayments/receipts?id=${s.id}`,target:"_blank",rel:"noreferrer",children:"Open Page"})]})})]},s.id)}),y&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:8,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 border-t",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Page ",j," of ",P," • ",k," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:j<=1,onClick:()=>p(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:j>=P,onClick:()=>p(s=>Math.min(P,s+1)),children:"Next"})]})]})]}),Q&&t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>C(!1)}),e.jsxs("div",{ref:R,className:"relative bg-white w-full max-w-2xl rounded-lg shadow-lg p-6 print:bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Receipt #",t.receiptNo||t.id]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>window.print(),children:"Print"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:ee,children:"Download PDF"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:se,children:"Copy Link"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white",onClick:()=>C(!1),children:"Close"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"})," ",(t.date||"").slice(0,10)]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Method:"})," ",t.method||"cash"]}),t.reference&&e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Reference:"})," ",t.reference]}),t.notes&&e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Notes:"})," ",t.notes]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-gray-500",children:"Amount"}),e.jsxs("p",{className:"text-xl font-semibold",children:[t.currency||"TZS"," ",i(t.amount)]})]})]}),e.jsxs("div",{className:"my-4 border-t pt-4 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Loan:"})," ",(M=t.loan)==null?void 0:M.reference]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Borrower:"})," ",(z=t.loan)==null?void 0:z.borrowerName]})]}),!!((B=t==null?void 0:t.allocation)!=null&&B.length)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 text-left",children:[e.jsx("th",{className:"p-2",children:"Period"}),e.jsx("th",{className:"p-2",children:"Principal"}),e.jsx("th",{className:"p-2",children:"Interest"}),e.jsx("th",{className:"p-2",children:"Fees"}),e.jsx("th",{className:"p-2",children:"Penalties"})]})}),e.jsx("tbody",{children:t.allocation.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(s.penalties)]})]},a))}),t.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t font-medium",children:[e.jsx("td",{className:"p-2",children:"Totals"}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",i(t.totals.penalties)]})]})})]})})]}),e.jsxs("div",{className:"mt-6 text-xs text-gray-500",children:[e.jsxs("p",{children:["Posted by: ",((E=t.postedBy)==null?void 0:E.name)||"—"," ",(U=t.postedBy)!=null&&U.email?`(${t.postedBy.email})`:""]}),e.jsx("p",{className:"mt-2",children:"This is a system generated receipt."})]})]})]}),e.jsx("style",{children:`
        @media print {
          body { background: white; }
          @page { margin: 12mm; }
        }
      `})]})}export{me as default};

import{r as d,j as e}from"./index-Cn4NM1n-.js";import{a as p}from"./index-1suYg9Kl.js";import{A as k}from"./acl-DZ5pzI_B.js";const u={listDefs:()=>p.get("/admin/report-subscriptions/defs").then(n=>n.data),listSubs:()=>p.get("/admin/report-subscriptions").then(n=>n.data),createSub:n=>p.post("/admin/report-subscriptions",n).then(o=>o.data),updateSub:(n,o)=>p.put(`/admin/report-subscriptions/${n}`,o).then(c=>c.data),deleteSub:n=>p.delete(`/admin/report-subscriptions/${n}`).then(o=>o.data),runNow:n=>p.post(`/admin/report-subscriptions/${n}/run-now`).then(o=>o.data)};function T(){const[n,o]=d.useState([]),[c,x]=d.useState([]),[f,N]=d.useState([]),[h,m]=d.useState(""),[y,j]=d.useState(!1),b={name:"",reportKey:"",frequency:"daily",timeOfDay:"09:00",dayOfWeek:1,dayOfMonth:1,monthOfYear:1,cron:"",format:"csv",filters:{},recipientsType:"role",roleId:"",userId:"",emails:[],active:!0},[a,l]=d.useState(b),v=async()=>{var s,t;try{m("");const[r,i,w]=await Promise.all([u.listDefs(),u.listSubs(),k.listRoles()]);o(r||[]),x(i||[]),N(w||[])}catch(r){m(((t=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to load")}};d.useEffect(()=>{v()},[]);const g=async()=>{var s,t;try{j(!0),m("");const r={...a,roleId:a.recipientsType==="role"&&Number(a.roleId)||null,userId:a.recipientsType==="user"&&Number(a.userId)||null},i=await u.createSub(r);x([i,...c]),l(b)}catch(r){m(((t=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to create subscription")}finally{j(!1)}},S=async s=>{confirm("Delete this subscription?")&&(await u.deleteSub(s),x(c.filter(t=>t.id!==s)))},C=async s=>{var t,r;try{await u.runNow(s),alert("Sent!")}catch(i){alert(((r=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:r.error)||"Failed to send")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Staff Email Notifications"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Schedule reports to be emailed to staff by role or recipients."})]}),h&&e.jsx("div",{className:"text-sm text-rose-600",children:h}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"Name",value:a.name,onChange:s=>l(t=>({...t,name:s.target.value}))}),e.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:a.reportKey,onChange:s=>l(t=>({...t,reportKey:s.target.value})),children:[e.jsx("option",{value:"",children:"Select report…"}),n.map(s=>e.jsx("option",{value:s.key,children:s.name},s.key))]}),e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:a.format,onChange:s=>l(t=>({...t,format:s.target.value})),children:[e.jsx("option",{value:"csv",children:"CSV"}),e.jsx("option",{value:"xlsx",disabled:!0,children:"Excel (soon)"}),e.jsx("option",{value:"pdf",disabled:!0,children:"PDF (soon)"})]}),e.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:a.frequency,onChange:s=>l(t=>({...t,frequency:s.target.value})),children:[e.jsx("option",{children:"daily"}),e.jsx("option",{children:"weekly"}),e.jsx("option",{children:"monthly"}),e.jsx("option",{children:"quarterly"}),e.jsx("option",{children:"semiannual"}),e.jsx("option",{children:"annual"}),e.jsx("option",{children:"custom"})]}),e.jsx("input",{className:"rounded border px-3 py-2 text-sm",placeholder:"HH:mm",value:a.timeOfDay,onChange:s=>l(t=>({...t,timeOfDay:s.target.value}))}),a.frequency==="weekly"&&e.jsx("select",{className:"rounded border px-3 py-2 text-sm",value:a.dayOfWeek,onChange:s=>l(t=>({...t,dayOfWeek:Number(s.target.value)})),children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((s,t)=>e.jsx("option",{value:t,children:s},t))}),["monthly","quarterly","semiannual","annual"].includes(a.frequency)&&e.jsx("input",{type:"number",min:"1",max:"28",className:"rounded border px-3 py-2 text-sm",value:a.dayOfMonth,onChange:s=>l(t=>({...t,dayOfMonth:Number(s.target.value)})),placeholder:"Day of month"}),a.frequency==="annual"&&e.jsx("input",{type:"number",min:"1",max:"12",className:"rounded border px-3 py-2 text-sm",value:a.monthOfYear,onChange:s=>l(t=>({...t,monthOfYear:Number(s.target.value)})),placeholder:"Month (1..12)"}),a.frequency==="custom"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"CRON expression",value:a.cron,onChange:s=>l(t=>({...t,cron:s.target.value}))})]}),e.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:a.recipientsType,onChange:s=>l(t=>({...t,recipientsType:s.target.value})),children:[e.jsx("option",{value:"role",children:"By role"}),e.jsx("option",{value:"user",children:"Specific user (ID)"}),e.jsx("option",{value:"emails",children:"Custom emails"})]}),a.recipientsType==="role"&&e.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:a.roleId,onChange:s=>l(t=>({...t,roleId:s.target.value})),children:[e.jsx("option",{value:"",children:"Select role…"}),f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),a.recipientsType==="user"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"User ID",value:a.userId,onChange:s=>l(t=>({...t,userId:s.target.value}))}),a.recipientsType==="emails"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-3",placeholder:"email1@example.com, email2@example.com",value:a.emails.join(", "),onChange:s=>l(t=>({...t,emails:s.target.value.split(",").map(r=>r.trim()).filter(Boolean)}))}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!a.active,onChange:s=>l(t=>({...t,active:s.target.checked}))}),"Active"]}),e.jsx("div",{className:"md:col-span-2 flex justify-end",children:e.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white",disabled:y,onClick:g,children:y?"Saving…":"Create subscription"})})]})]}),e.jsx("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 overflow-auto",children:c.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:"No subscriptions yet."}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-4",children:"Name"}),e.jsx("th",{className:"py-2 pr-4",children:"Report"}),e.jsx("th",{className:"py-2 pr-4",children:"When"}),e.jsx("th",{className:"py-2 pr-4",children:"Recipients"}),e.jsx("th",{className:"py-2 pr-4",children:"Last / Next"}),e.jsx("th",{className:"py-2 pr-4",children:"Ops"})]})}),e.jsx("tbody",{children:c.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-2 pr-4",children:s.name}),e.jsx("td",{className:"py-2 pr-4",children:e.jsx("code",{className:"text-xs",children:s.reportKey})}),e.jsxs("td",{className:"py-2 pr-4",children:[s.frequency," @ ",s.timeOfDay]}),e.jsx("td",{className:"py-2 pr-4",children:s.recipientsType==="role"?`role #${s.roleId}`:s.recipientsType==="user"?`user #${s.userId}`:(s.emails||[]).join(", ")}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"text-xs",children:[e.jsxs("div",{children:["Last: ",s.lastRunAt?new Date(s.lastRunAt).toLocaleString():"—"]}),e.jsxs("div",{children:["Next: ",s.nextRunAt?new Date(s.nextRunAt).toLocaleString():"—"]})]})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 rounded border",onClick:()=>C(s.id),children:"Send now"}),e.jsx("button",{className:"px-2 py-1 rounded border text-rose-700",onClick:()=>S(s.id),children:"Delete"})]})})]},s.id))})]})})]})}export{T as default};

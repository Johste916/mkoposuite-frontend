import{r as d,h as S,j as e}from"./index-_x_s48EO.js";const z={slate:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800 dark:bg-slate-900/40 dark:text-slate-100",blue:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-100",indigo:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-100",emerald:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-100",teal:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-teal-100 text-teal-800 dark:bg-teal-900/40 dark:text-teal-100",violet:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-violet-100 text-violet-800 dark:bg-violet-900/40 dark:text-violet-100",amber:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-100"},P=({tone:x="slate",children:h})=>e.jsx("span",{className:z[x]||z.slate,children:h}),H={auth:"blue",users:"indigo",loans:"emerald",repayments:"teal",permissions:"violet",system:"slate"},W=x=>H[x]||"slate";function Y(){var J,D,I,U,B,F;const[x,h]=d.useState([]),[V,k]=d.useState(0),[u,q]=d.useState(""),[C,L]=d.useState(""),[E,O]=d.useState(!1),[n,R]=d.useState(null),[o,b]=d.useState({category:"",action:"",from:"",to:""}),[j,G]=d.useState(!1),A=d.useRef(null),[g,N]=d.useState(null),y=t=>Array.isArray(t)?t:(t==null?void 0:t.items)||[],v=async()=>{var t,s,r;O(!0),L("");try{const a=await S.get("/admin/audit",{params:{...o,q:u,limit:300}}),i=await S.get("/admin/audit/summary");h(y(a.data)),k(((t=a.data)==null?void 0:t.total)??y(a.data).length??0),R(i.data||null)}catch(a){L(((r=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:r.error)||a.message||"Failed to load audits"),h([]),k(0),R(null)}finally{O(!1)}};d.useEffect(()=>{v()},[]),d.useEffect(()=>{const t=setTimeout(()=>{E||v()},300);return()=>clearTimeout(t)},[u,o.category,o.action,o.from,o.to]),d.useEffect(()=>{var a,i;if(!j){(i=(a=A.current)==null?void 0:a.close)==null||i.call(a);return}const t=(S.defaults.baseURL||"").replace(/\/$/,""),s=new EventSource(`${t}/admin/audit/stream`);A.current=s;const r=l=>h(c=>[...l,...c].slice(0,500));return s.addEventListener("init",l=>{try{const c=JSON.parse(l.data);r(c.items||[])}catch{}}),s.addEventListener("append",l=>{try{const c=JSON.parse(l.data);r(c.items||[])}catch{}}),s.addEventListener("audit",l=>{try{const c=JSON.parse(l.data);r([c])}catch{}}),s.onerror=()=>{},()=>s.close()},[j]);const w=d.useMemo(()=>y(x).map(s=>{var M,$,T;const r=((M=s==null?void 0:s.User)==null?void 0:M.name)||(($=s==null?void 0:s.user)==null?void 0:$.name)||s.userName||s.userEmail||s.userId||"-",a=((T=s==null?void 0:s.Branch)==null?void 0:T.name)||s.branchName||s.branchId||"-";let i,l,c;try{const m=typeof s.message=="string"?JSON.parse(s.message):s.message;m&&typeof m=="object"&&(i=m.before??m.prev??void 0,l=m.after??m.next??void 0,c=m.meta??void 0)}catch{}return{...s,userName:r,branchName:a,before:i,after:l,meta:c}}),[x]),f=d.useMemo(()=>{const t=u.toLowerCase().trim();return t?w.filter(s=>[s.userName,s.branchName,s.category,s.action,s.message,s.entity,s.entityId].some(r=>String(r||"").toLowerCase().includes(t))):w},[w,u]),K=()=>{const t=["time","branch","staff","category","action","message","ip"],s=f.map(l=>[new Date(l.createdAt||Date.now()).toISOString(),l.branchName||"",l.userName||"",l.category||"",l.action||"",(typeof l.message=="string"?l.message:JSON.stringify(l.message||"")).replace(/"/g,'""'),l.ip||""].map(c=>`"${String(c)}"`).join(",")),r=new Blob([[t.join(","),...s].join(`
`)],{type:"text/csv;charset=utf-8"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download="audit.csv",i.click(),URL.revokeObjectURL(a)},p=({label:t,value:s})=>e.jsxs("div",{className:"rounded-2xl border p-3 bg-white dark:bg-slate-900",children:[e.jsx("div",{className:"text-xs text-slate-500",children:t}),e.jsx("div",{className:"text-xl font-semibold",children:s})]}),Q=({r:t})=>e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"py-2 pr-3 whitespace-nowrap",children:new Date(t.createdAt||Date.now()).toLocaleString()}),e.jsx("td",{className:"py-2 pr-3",children:t.branchName||"-"}),e.jsx("td",{className:"py-2 pr-3",children:t.userName||"-"}),e.jsx("td",{className:"py-2 pr-3",children:e.jsx(P,{tone:W(t.category),children:t.category||"—"})}),e.jsx("td",{className:"py-2 pr-3",children:e.jsx(P,{tone:"amber",children:t.action||"—"})}),e.jsxs("td",{className:"py-2 pr-3",children:[t.entity?e.jsx("span",{className:"opacity-80",children:t.entity}):"—"," ",t.entityId?e.jsxs("span",{className:"opacity-60",children:["#",t.entityId]}):""]}),e.jsx("td",{className:"py-2 pr-3",children:(()=>{var s,r;try{const a=typeof t.message=="string"?JSON.parse(t.message):t.message;if(a&&typeof a=="object"){if((s=a==null?void 0:a.meta)!=null&&s.method&&((r=a==null?void 0:a.meta)!=null&&r.path))return`${a.meta.method} ${a.meta.path}`;if(a!=null&&a.body){const i=JSON.stringify(a.body);return i.length>120?i.slice(0,120)+"…":i}}return typeof t.message=="string"?t.message:JSON.stringify(t.message||"-")}catch{return t.message||"-"}})()}),e.jsx("td",{className:"py-2 pr-3",children:t.ip||"-"}),e.jsx("td",{className:"py-2 pr-3",children:t.before||t.after||t.meta?e.jsx("button",{className:"px-2 py-1 rounded border bg-white hover:bg-slate-50 dark:bg-slate-900",onClick:()=>N(t),children:"View"}):e.jsx("span",{className:"opacity-50",children:"—"})})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Audit Management"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Live trail of sensitive changes across the system."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("input",{className:"rounded border px-3 py-2 text-sm w-56",value:u,onChange:t=>q(t.target.value),placeholder:"Search…"}),e.jsxs("select",{className:"rounded border px-2 py-2 text-sm",value:o.category,onChange:t=>b(s=>({...s,category:t.target.value})),children:[e.jsx("option",{value:"",children:"All categories"}),["auth","users","loans","repayments","permissions","system"].map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{className:"rounded border px-2 py-2 text-sm",value:o.action,onChange:t=>b(s=>({...s,action:t.target.value})),children:[e.jsx("option",{value:"",children:"All actions"}),["create","update","delete","login:success","login:failed"].map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{type:"date",className:"rounded border px-2 py-2 text-sm",value:o.from,onChange:t=>b(s=>({...s,from:t.target.value}))}),e.jsx("input",{type:"date",className:"rounded border px-2 py-2 text-sm",value:o.to,onChange:t=>b(s=>({...s,to:t.target.value}))}),e.jsx("button",{className:"px-3 py-2 rounded-lg text-sm border bg-white hover:bg-slate-50",onClick:v,children:"Apply"}),e.jsx("button",{className:"px-3 py-2 rounded-lg text-sm border bg-white hover:bg-slate-50",onClick:K,children:"Export CSV"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm ml-2",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:t=>G(t.target.checked)}),"Live tail"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[e.jsx(p,{label:"Events (30d)",value:((J=n==null?void 0:n.totals)==null?void 0:J.all)??0}),e.jsx(p,{label:"Creates",value:((D=n==null?void 0:n.totals)==null?void 0:D.create)??0}),e.jsx(p,{label:"Updates",value:((I=n==null?void 0:n.totals)==null?void 0:I.update)??0}),e.jsx(p,{label:"Deletes",value:((U=n==null?void 0:n.totals)==null?void 0:U.delete)??0}),e.jsx(p,{label:"Logins (OK)",value:((B=n==null?void 0:n.totals)==null?void 0:B.loginSuccess)??0}),e.jsx(p,{label:"Logins (Failed)",value:((F=n==null?void 0:n.totals)==null?void 0:F.loginFailed)??0})]}),C&&e.jsx("div",{className:"text-sm text-rose-600",children:C}),e.jsx("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4",children:E?e.jsx("div",{className:"text-sm text-slate-500",children:"Loading…"}):f.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:"No entries."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-500 mb-2",children:["Showing ",f.length," of ",V," events"]}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left",children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"py-2 pr-3",children:"Time"}),e.jsx("th",{className:"py-2 pr-3",children:"Branch"}),e.jsx("th",{className:"py-2 pr-3",children:"Staff"}),e.jsx("th",{className:"py-2 pr-3",children:"Category"}),e.jsx("th",{className:"py-2 pr-3",children:"Action"}),e.jsx("th",{className:"py-2 pr-3",children:"Entity"}),e.jsx("th",{className:"py-2 pr-3",children:"Message"}),e.jsx("th",{className:"py-2 pr-3",children:"IP"}),e.jsx("th",{className:"py-2 pr-3",children:"Diff"})]})}),e.jsx("tbody",{children:f.map(t=>e.jsx(Q,{r:t},t.id))})]})})]})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:()=>N(null),children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 border rounded-xl w-full max-w-4xl p-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold",children:"Change details"}),e.jsx("button",{className:"px-2 py-1 rounded border",onClick:()=>N(null),children:"✕"})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-500 mb-1",children:"Before"}),e.jsx("pre",{className:"p-2 rounded border overflow-auto max-h-[50vh]",children:JSON.stringify(g.before??{},null,2)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-slate-500 mb-1",children:"After"}),e.jsx("pre",{className:"p-2 rounded border overflow-auto max-h-[50vh]",children:JSON.stringify(g.after??{},null,2)})]})]}),g.meta&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-slate-500 mb-1 text-xs",children:"Meta"}),e.jsx("pre",{className:"p-2 rounded border overflow-auto text-xs max-h-48",children:JSON.stringify(g.meta,null,2)})]})]})})]})}export{Y as default};

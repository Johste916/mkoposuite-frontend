import{r as f,j as t,h as p}from"./index-CM-KCFgk.js";const L=(e="")=>/.+@.+\..+/.test(e),q=e=>Array.isArray(e)?e:(e==null?void 0:e.items)||(e==null?void 0:e.rows)||(e==null?void 0:e.data)||[],y=e=>String(e||"").replace(/[_\-]+/g," ").replace(/\s+/g," ").trim().replace(/\b\w/g,o=>o.toUpperCase()),D=e=>String(e||"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||null,O=e=>e?!!(e.roleId||e.role&&typeof e.role=="object"&&(e.role.id||e.role.name||e.role.code)||typeof e.role=="string"&&e.role.trim()||e.role_code||e.role_name||Array.isArray(e.roles)&&e.roles.length||Array.isArray(e.roleNames)&&e.roleNames.length||Array.isArray(e.Roles)&&e.Roles.length):!1,z=e=>{const o=[],i=(a,x)=>{const h=D(x||a);h&&(o.some(b=>b.code===h)||o.push({name:a||y(h),code:h}))};return Array.isArray(e==null?void 0:e.Roles)&&e.Roles.forEach(a=>i(a.name,a.code)),Array.isArray(e==null?void 0:e.roles)&&e.roles.forEach(a=>{typeof a=="string"?i(y(a),a):i(a==null?void 0:a.name,a==null?void 0:a.code)}),(e!=null&&e.role_name||e!=null&&e.role_code)&&i(e.role_name,e.role_code),typeof(e==null?void 0:e.role)=="string"&&e.role.trim()&&i(y(e.role),e.role),o},W=(e,o)=>{const a=z(e)[0]||{name:(e==null?void 0:e.role_name)||(e!=null&&e.role?y(e.role):null),code:(e==null?void 0:e.role_code)||D(e==null?void 0:e.role)};let x=null;if(Array.isArray(o)&&o.length){const b=o.find(g=>g.code&&a.code&&String(g.code).toLowerCase()===String(a.code).toLowerCase())||o.find(g=>g.name&&a.name&&String(g.name)===String(a.name));b&&(x=b.id??null)}const h=a.name||(a.code?y(a.code):null);return{id:x,code:a.code||null,name:h||null,display:h||a.code||"â€”"}},X={loan_officer:"emerald",admin:"indigo",manager:"sky",director:"violet",accountant:"amber",user:"slate"},H=(e="slate")=>{const o={indigo:{b:"border-indigo-300",t:"text-indigo-800",bg:"bg-indigo-50"},sky:{b:"border-sky-300",t:"text-sky-800",bg:"bg-sky-50"},violet:{b:"border-violet-300",t:"text-violet-800",bg:"bg-violet-50"},emerald:{b:"border-emerald-300",t:"text-emerald-800",bg:"bg-emerald-50"},amber:{b:"border-amber-300",t:"text-amber-900",bg:"bg-amber-50"},rose:{b:"border-rose-300",t:"text-rose-800",bg:"bg-rose-50"},slate:{b:"border-slate-300",t:"text-slate-800",bg:"bg-slate-50"}};return o[e]||o.slate},Y=({code:e,name:o})=>{const i=X[e]||"slate",{b:a,t:x,bg:h}=H(i);return t.jsx("span",{className:`inline-flex items-center rounded-full ${a} ${x} ${h} px-2 py-[2px] text-[11px] font-semibold`,children:o||y(e)})},Z=({text:e,tone:o="emerald",title:i})=>{const{b:a,t:x,bg:h}=H(o);return t.jsx("span",{title:i,className:`inline-flex items-center rounded-full ${a} ${x} ${h} px-2 py-[2px] text-[11px] font-semibold`,children:e})},n={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-slate-700",card:"rounded-2xl border-2 border-slate-300 bg-white shadow",th:"bg-slate-100 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-2 border-slate-200",td:"px-3 py-2 border-2 border-slate-200 text-sm",field:"h-11 w-full rounded-lg border-2 border-slate-300 bg-white text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600",btn:"inline-flex items-center rounded-lg border-2 border-slate-300 px-3 py-2 hover:bg-slate-50 font-semibold",btnPrimary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-3 py-2 font-semibold hover:bg-indigo-700 disabled:opacity-60",btnDanger:"inline-flex items-center rounded-lg border-2 border-rose-300 text-rose-600 px-3 py-2 hover:bg-rose-50 font-semibold"};async function T(e){let o;for(const i of e)try{return await p[i.m](i.url,i.data)}catch(a){o=a}throw o}async function B(e,o){const i=o==null?null:Number(o)||o;return i==null?(await T([{m:"post",url:`/users/${e}/assign`,data:{roleId:null}},{m:"put",url:`/users/${e}`,data:{roleId:null}},{m:"delete",url:`/users/${e}/role`,data:void 0},{m:"put",url:`/users/${e}/roles`,data:{roleIds:[]}},{m:"post",url:`/users/${e}/roles`,data:{roleIds:[]}},{m:"post",url:"/auth/roles/unassign",data:{userId:e}}]),!0):(await T([{m:"post",url:`/users/${e}/assign`,data:{roleId:i}},{m:"put",url:`/users/${e}`,data:{roleId:i}},{m:"post",url:`/users/${e}/role`,data:{roleId:i}},{m:"put",url:`/users/${e}/role`,data:{roleId:i}},{m:"post",url:`/users/${e}/roles`,data:{roleIds:[i]}},{m:"put",url:`/users/${e}/roles`,data:{roleIds:[i]}},{m:"post",url:`/roles/${i}/assign`,data:{userId:e}},{m:"post",url:"/auth/roles/assign",data:{userId:e,roleId:i}},{m:"put",url:`/auth/users/${e}/role`,data:{roleId:i}}]),!0)}async function I(){const e=[()=>p.get("/roles"),()=>p.get("/v1/roles"),()=>p.get("/auth/roles"),()=>p.get("/iam/roles")];for(const o of e)try{const i=await o();return q(i.data)}catch{}return[]}function ee({title:e,onClose:o,children:i}){return f.useEffect(()=>{const a=x=>{x.key==="Escape"&&o()};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[o]),t.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:o,children:t.jsxs("div",{className:"w-full max-w-md rounded-2xl border-2 border-slate-300 bg-white p-5 shadow",onClick:a=>a.stopPropagation(),children:[t.jsx("h3",{className:"text-lg font-bold tracking-tight mb-3",children:e}),i]})})}const te=()=>{const[e,o]=f.useState([]),[i,a]=f.useState([]),[x,h]=f.useState(""),[b,g]=f.useState(!1),[K,U]=f.useState(!1),[v,P]=f.useState(!1),[m,N]=f.useState({name:"",email:"",password:"",id:null}),[_,M]=f.useState({}),[k,$]=f.useState({}),R=f.useRef(),w=async(s="")=>{var r,c;g(!0);try{const[d,l]=await Promise.all([p.get("/users",{params:{q:s,limit:500}}),I()]);o(q(d.data)),a(l)}catch(d){console.error("Error fetching users/roles:",d),alert(((c=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:c.error)||"Failed to load users/roles")}finally{g(!1)}};f.useEffect(()=>{w()},[]),f.useEffect(()=>(clearTimeout(R.current),R.current=setTimeout(()=>w(x),300),()=>clearTimeout(R.current)),[x]);const C=f.useMemo(()=>e.filter(s=>!O(s)).filter(s=>{const r=x.trim().toLowerCase();return r?(s.name||`${s.firstName||""} ${s.lastName||""}`).toLowerCase().includes(r)||String(s.email||"").toLowerCase().includes(r):!0}),[e,x]),S=f.useMemo(()=>e.filter(s=>O(s)).map(s=>{const r=W(s,i);return{...s,_roleId:r.id,_roleName:r.name||"â€”",_roleCode:r.code||null,_roleDisplay:r.display}}).filter(s=>{const r=x.trim().toLowerCase();return r?(s.name||`${s.firstName||""} ${s.lastName||""}`).toLowerCase().includes(r)||String(s.email||"").toLowerCase().includes(r)||String(s._roleDisplay||"").toLowerCase().includes(r):!0}),[e,i,x]),Q=s=>{const r=(s==null?void 0:s._roleCode)||D(s==null?void 0:s._roleName);return/^loan[_\s-]*officer$/.test(String(r||""))},F=async(s,r)=>{var c,d;if(!r)return alert("Please select a role first.");$(l=>({...l,[s]:!0}));try{await B(s,r);const l=i.find(u=>String(u.id)===String(r));o(u=>u.map(j=>j.id===s?{...j,roleId:Number(r),role:{id:Number(r),name:l==null?void 0:l.name,code:l==null?void 0:l.code},role_code:(l==null?void 0:l.code)||j.role_code||null,role_name:(l==null?void 0:l.name)||j.role_name||null,Roles:l?[{id:l.id,name:l.name,code:l.code}]:j.Roles,roles:l?[l.code||l.name]:j.roles}:j)),M(u=>({...u,[s]:""})),alert("Role assigned")}catch(l){console.error(l),alert(((d=(c=l==null?void 0:l.response)==null?void 0:c.data)==null?void 0:d.error)||(l==null?void 0:l.message)||"Failed to assign role")}finally{$(l=>({...l,[s]:!1}))}},G=async s=>{var r,c;if(window.confirm("Remove this user's role?")){$(d=>({...d,[s]:!0}));try{await B(s,null),o(d=>d.map(l=>l.id===s?{...l,roleId:null,role:null,role_code:null,role_name:null,Roles:[],roles:[]}:l)),alert("Role cleared")}catch(d){console.error(d),alert(((c=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:c.error)||(d==null?void 0:d.message)||"Failed to clear role")}finally{$(d=>({...d,[s]:!1}))}}},A=(s={name:"",email:"",password:"",id:null})=>{N(s),U(!0)},E=()=>{v||(N({name:"",email:"",password:"",id:null}),U(!1))},J=async()=>{var s,r;if(!m.name.trim()||!L(m.email))return alert("Please provide a valid name and email.");if(!m.id&&!m.password.trim())return alert("Please set an initial password for this user.");P(!0);try{m.id?(await p.put(`/users/${m.id}`,{name:m.name.trim(),email:m.email.trim()}),alert("User updated successfully")):(await p.post("/users",{name:m.name.trim(),email:m.email.trim(),password:m.password.trim()}),alert("User created successfully")),E(),w(x)}catch(c){console.error("Submit error:",c),alert(((r=(s=c==null?void 0:c.response)==null?void 0:s.data)==null?void 0:r.error)||"Error saving user")}finally{P(!1)}},V=async s=>{var r,c;if(window.confirm("Delete this user?"))try{await p.delete(`/users/${s}`),alert("User deleted"),w(x)}catch(d){console.error("Delete error:",d),alert(((c=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:c.error)||"Error deleting user")}};return t.jsxs("div",{className:n.page,children:[t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-4",children:[t.jsxs("div",{children:[t.jsx("h1",{className:n.h1,children:"Users / Staff"}),t.jsx("p",{className:n.sub,children:"Assign roles to staff. Staff with roles wonâ€™t appear in the â€œAwaiting role assignmentâ€ listâ€”theyâ€™ll live in the â€œStaff with rolesâ€ table below."})]}),t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-[12px] font-semibold text-slate-600",children:"Search"}),t.jsx("input",{className:`${n.field} w-64 h-10`,placeholder:"name, email, roleâ€¦",value:x,onChange:s=>h(s.target.value)})]}),t.jsx("button",{className:n.btn,onClick:()=>w(x),children:"Refresh"}),t.jsx("button",{className:n.btnPrimary,onClick:()=>A(),children:"+ New User"})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h2",{className:"text-lg font-bold",children:"Awaiting role assignment"}),t.jsxs("div",{className:"text-sm text-slate-600",children:[C.length," ",C.length===1?"user":"users"]})]}),t.jsx("div",{className:`${n.card} overflow-x-auto`,children:t.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[t.jsx("thead",{children:t.jsx("tr",{children:["#","Name","Email","Role to assign","Actions"].map((s,r)=>t.jsx("th",{className:`${n.th} ${r===4?"text-right":""}`,children:s},s))})}),t.jsx("tbody",{children:b?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:`${n.td} text-center py-8 text-slate-600`,children:"Loadingâ€¦"})}):C.length?C.map((s,r)=>t.jsxs("tr",{className:"hover:bg-slate-50",children:[t.jsx("td",{className:n.td,children:r+1}),t.jsx("td",{className:n.td,children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()||"â€”"}),t.jsx("td",{className:n.td,children:s.email||"â€”"}),t.jsx("td",{className:n.td,children:t.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:_[s.id]??"",onChange:c=>M(d=>({...d,[s.id]:c.target.value})),children:[t.jsx("option",{value:"",children:"â€” Select Role â€”"}),i.map(c=>t.jsx("option",{value:c.id,children:c.name},c.id))]})}),t.jsx("td",{className:`${n.td} text-right`,children:t.jsxs("div",{className:"inline-flex gap-2",children:[t.jsx("button",{className:`${n.btnPrimary} disabled:opacity-50`,disabled:!_[s.id]||k[s.id],onClick:()=>F(s.id,_[s.id]),children:k[s.id]?"Assigningâ€¦":"Assign"}),t.jsx("button",{className:n.btn,onClick:()=>A(s),children:"Edit"}),t.jsx("button",{className:n.btnDanger,onClick:()=>V(s.id),children:"Delete"})]})})]},s.id)):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:`${n.td} text-center py-8 text-slate-600`,children:"ðŸŽ‰ All users have roles assigned."})})})]})})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("h2",{className:"text-lg font-bold",children:"Staff with roles"}),t.jsxs("div",{className:"text-sm text-slate-600",children:[S.length," ",S.length===1?"user":"users"]})]}),t.jsx("div",{className:`${n.card} overflow-x-auto`,children:t.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[t.jsx("thead",{children:t.jsx("tr",{children:["#","Name","Email","Role","Actions"].map((s,r)=>t.jsx("th",{className:`${n.th} ${r===4?"text-right":""}`,children:s},s))})}),t.jsx("tbody",{children:b?t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:`${n.td} text-center py-8 text-slate-600`,children:"Loadingâ€¦"})}):S.length?S.map((s,r)=>{const c=z(s),d=c.length?c:s._roleCode||s._roleName?[{code:s._roleCode,name:s._roleName}]:[];return t.jsxs("tr",{className:"hover:bg-slate-50",children:[t.jsx("td",{className:n.td,children:r+1}),t.jsx("td",{className:n.td,children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()||"â€”"}),t.jsx("td",{className:n.td,children:s.email||"â€”"}),t.jsx("td",{className:n.td,children:t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[d.length?d.map((l,u)=>t.jsx(Y,{code:l.code,name:l.name},`${l.code||l.name}-${u}`)):t.jsx("span",{children:"â€”"}),Q(s)&&t.jsx(Z,{text:"Discoverable",tone:"emerald",title:"Appears under /users?role=loan_officer"})]})}),t.jsx("td",{className:`${n.td} text-right`,children:t.jsxs("div",{className:"inline-flex gap-2",children:[t.jsx("button",{className:n.btn,onClick:()=>A(s),children:"Edit"}),t.jsx("button",{className:n.btn,onClick:()=>{const l=window.prompt("Enter new role ID to assign (leave blank to cancel):",s._roleId??"");l&&Number(l)!==Number(s._roleId)&&F(s.id,l)},children:"Change Role"}),t.jsx("button",{className:`${n.btnDanger} disabled:opacity-50`,disabled:k[s.id],onClick:()=>G(s.id),children:"Clear Role"})]})})]},s.id)}):t.jsx("tr",{children:t.jsx("td",{colSpan:5,className:`${n.td} text-center py-8 text-slate-600`,children:"No staff with roles yet."})})})]})}),t.jsxs("div",{className:"text-[12px] text-slate-600 mt-2",children:["Tip: give a user the ",t.jsx("b",{children:"Loan Officer"})," role (exactly â€œloan_officerâ€, â€œloan-officerâ€ or â€œLoan Officerâ€) so theyâ€™re discoverable by pages like Borrower Details which call",t.jsx("code",{className:"mx-1 bg-slate-100 px-1 rounded",children:"/users?role=loan_officer"}),"."]})]}),K&&t.jsx(ee,{title:m.id?"Edit User":"Add New User",onClose:E,children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-[12px] font-semibold text-slate-600",children:"Full name"}),t.jsx("input",{type:"text",value:m.name,onChange:s=>N({...m,name:s.target.value}),className:n.field})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-[12px] font-semibold text-slate-600",children:"Email"}),t.jsx("input",{type:"email",value:m.email,onChange:s=>N({...m,email:s.target.value}),className:`${n.field} ${m.email&&!L(m.email)?"!border-rose-400":""}`}),m.email&&!L(m.email)&&t.jsx("div",{className:"text-[12px] text-rose-600 mt-1",children:"Please enter a valid email."})]}),!m.id&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-[12px] font-semibold text-slate-600",children:"Initial Password"}),t.jsx("input",{type:"password",placeholder:"Enter initial password",value:m.password,onChange:s=>N({...m,password:s.target.value}),className:n.field}),t.jsx("div",{className:"text-[12px] text-slate-500 mt-1",children:"Set an initial password (user can reset later)"})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-3",children:[t.jsx("button",{className:n.btn,onClick:E,disabled:v,children:"Cancel"}),t.jsx("button",{className:`${n.btnPrimary} disabled:opacity-50`,onClick:J,disabled:v,children:v?"Savingâ€¦":m.id?"Update":"Create"})]})]})})]})};export{te as default};

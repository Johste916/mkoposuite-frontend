import{r as j,j as e,i as R,L as y}from"./index-CosGzjM2.js";import{r as b}from"./repayments-BjmOrgrK.js";import"./index-CdU995cR.js";const g=l=>Number(l||0).toLocaleString();function S({loan:l}){var h;if(!l)return null;const c=l.reference||`L-${l.id}`,o=((h=l.Borrower)==null?void 0:h.name)||"",x=async p=>{try{await navigator.clipboard.writeText(p)}catch{}};return e.jsxs("div",{className:"mt-3 text-xs space-y-2 bg-gray-50 dark:bg-gray-900 border rounded p-3",children:[e.jsx("p",{className:"font-medium",children:"Payment Instructions"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{children:"Mobile Money:"}),e.jsxs("code",{className:"block p-2 bg-white dark:bg-black rounded border",children:["Use reference: ",c," (borrower: ",o,")"]}),e.jsx("button",{className:"mt-1 text-blue-600",onClick:()=>x(c),children:"Copy Ref"})]}),e.jsxs("div",{children:[e.jsx("p",{children:"Bank Deposit:"}),e.jsxs("code",{className:"block p-2 bg-white dark:bg-black rounded border",children:['Include narration "',c,'" in the transfer memo']}),e.jsx("button",{className:"mt-1 text-blue-600",onClick:()=>x(c),children:"Copy Ref"})]})]})]})}function C(){const[l,c]=j.useState([]),[o,x]=j.useState(!1),[h,p]=j.useState(null),[f,u]=j.useState({}),N=async()=>{x(!0);try{const{data:s}=await b.pendingApprovals();c(Array.isArray(s)?s:[])}catch{c([]),alert("Failed to fetch pending repayments")}finally{x(!1)}};j.useEffect(()=>{N()},[]);const v=async s=>{var t,n;if(confirm("Approve this repayment?")){p(s);try{await b.approve(s),c(a=>a.filter(r=>r.id!==s))}catch(a){alert(((n=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:n.error)||"Approve failed")}finally{p(null)}}},w=async s=>{var n,a;const t=prompt("Reason (optional):")||"";p(s);try{await b.reject(s,t),c(r=>r.filter(i=>i.id!==s))}catch(r){alert(((a=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:a.error)||"Reject failed")}finally{p(null)}},k=async s=>{var n,a;const t=s.id;if((n=s.allocation)!=null&&n.length){u(r=>({...r,[t]:{allocations:s.allocation,totals:{}}}));return}try{const r=Number(s.amount??s.amountPaid??0),i=(s.date||s.paymentDate||s.paidAt||new Date().toISOString()).slice(0,10),{data:m}=await b.previewAllocation({loanId:s.loanId||((a=s.Loan)==null?void 0:a.id),amount:r,date:i});u(d=>({...d,[t]:{allocations:m.allocations||[],totals:m.totals||{}}}))}catch{alert("Failed to preview allocation")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Approve Repayments"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Review & approve pending repayment entries."})]}),e.jsx("button",{onClick:N,className:"px-3 py-2 rounded border hover:bg-gray-50",disabled:o,children:o?"Refreshing…":"Refresh"})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6",children:e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Amount"}),e.jsx("th",{className:"text-left p-3",children:"Method"}),e.jsx("th",{className:"text-left p-3",children:"Ref"}),e.jsx("th",{className:"text-left p-3",children:"Borrower"}),e.jsx("th",{className:"text-left p-3",children:"Loan"}),e.jsx("th",{className:"text-right p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[!o&&l.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4 text-gray-500",children:"No pending repayments."})}),l.map(s=>{var m;const t=s.Loan||{},n=t.Borrower||{},a=s.date||s.paymentDate||s.paidAt||s.createdAt||"",r=s.currency||t.currency||"TZS",i=f[s.id];return e.jsxs(R.Fragment,{children:[e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:String(a).slice(0,10)}),e.jsxs("td",{className:"p-3",children:[r," ",g(s.amount??s.amountPaid)]}),e.jsx("td",{className:"p-3",children:s.method||"—"}),e.jsx("td",{className:"p-3",children:s.reference||"—"}),e.jsx("td",{className:"p-3",children:n.name||"—"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.reference||`L-${t.id}`}),!!t.id&&e.jsx(y,{to:`/loans/${t.id}`,target:"_blank",className:"text-blue-600 hover:underline",children:"open"})]})}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>k(s),children:"Preview Allocation"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-60",onClick:()=>v(s.id),disabled:h===s.id,children:h===s.id?"Working…":"Approve"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",onClick:()=>w(s.id),disabled:h===s.id,children:"Reject"}),e.jsx(y,{to:`/repayments/receipts?id=${s.id}`,className:"px-3 py-1.5 rounded border hover:bg-gray-50",target:"_blank",children:"View Receipt"})]})})]}),i&&e.jsx("tr",{className:"bg-gray-50/60",children:e.jsx("td",{colSpan:7,className:"p-3",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"p-2 text-left",children:"Period"}),e.jsx("th",{className:"p-2 text-right",children:"Principal"}),e.jsx("th",{className:"p-2 text-right",children:"Interest"}),e.jsx("th",{className:"p-2 text-right",children:"Fees"}),e.jsx("th",{className:"p-2 text-right",children:"Penalties"})]})}),e.jsxs("tbody",{children:[(i.allocations||[]).map((d,A)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:d.period}),e.jsx("td",{className:"p-2 text-right",children:g(d.principal)}),e.jsx("td",{className:"p-2 text-right",children:g(d.interest)}),e.jsx("td",{className:"p-2 text-right",children:g(d.fees)}),e.jsx("td",{className:"p-2 text-right",children:g(d.penalties)})]},A)),!((m=i.allocations)!=null&&m.length)&&e.jsx("tr",{children:e.jsx("td",{className:"p-2",colSpan:5,children:"No allocation needed."})})]})]})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm mb-2",children:"Helper"}),e.jsx(S,{loan:t})]})]})})})]},s.id)}),o&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4",children:"Loading…"})})]})]})})})]})}export{C as default};

import{i as D,u as L,r as o,g as h,j as e,L as g}from"./index-8DtxmKky.js";import{W as B}from"./wallet-C7hc5sXd.js";import{C as E}from"./calendar-q-a_lhl3.js";import{S as I}from"./save-BJCbUXrj.js";import"./createLucideIcon-Dj9MDrjL.js";const c="w-full rounded-lg border border-[var(--border)] bg-white dark:bg-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 transition-all",$="bg-[var(--card)] rounded-2xl border border-[var(--border)] p-5 md:p-6",M=[{value:"cash",label:"Cash"},{value:"bank",label:"Bank"},{value:"mobile_money",label:"Mobile Money"},{value:"other",label:"Other"}],T=s=>Array.isArray(s)?s:Array.isArray(s==null?void 0:s.items)?s.items:Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.results)?s.results:[],w=s=>{var d,u;const r=(d=s==null?void 0:s.response)==null?void 0:d.data;return typeof r=="string"?r:r!=null&&r.message?r.message:r!=null&&r.error?r.error:((u=s==null?void 0:s.response)==null?void 0:u.statusText)||(s==null?void 0:s.message)||"Server error"};function z(){var y;const{id:s}=D(),r=L(),d=o.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},[]),u=((d==null?void 0:d.role)||"").toLowerCase(),f=u==="admin"||u==="accountant",[x,k]=o.useState(null),[S,A]=o.useState([]),[v,j]=o.useState(!1),[N,p]=o.useState(""),b=o.useRef(null),[t,i]=o.useState({method:"cash",bankId:"",reference:"",amount:"",date:new Date().toISOString().slice(0,10),note:""});o.useEffect(()=>{(async()=>{try{const[a,m]=await Promise.all([h.get(`/loans/${s}`),h.get("/banks").catch(()=>({data:[]}))]),l=(a==null?void 0:a.data)||null;k(l),A(T(m==null?void 0:m.data)),l!=null&&l.amount&&!t.amount&&i(n=>({...n,amount:String(l.amount)}))}catch(a){p(w(a))}})()},[s]);const C=async a=>{var m,l;if(a.preventDefault(),!!f){if(!t.amount||Number(t.amount)<=0)return alert("Enter a valid amount to disburse.");j(!0),p("");try{const n=new FormData;n.append("method",t.method),n.append("bankId",t.method==="bank"&&t.bankId||""),n.append("reference",t.reference||""),n.append("amount",t.amount||""),n.append("date",t.date||""),n.append("note",t.note||""),(l=(m=b.current)==null?void 0:m.files)!=null&&l[0]&&n.append("attachment",b.current.files[0]),await h.post(`/loans/${s}/disburse`,n,{headers:{"Content-Type":"multipart/form-data"}}),alert("Loan disbursed"),r(`/loans/${s}`)}catch(n){p(w(n))}finally{j(!1)}}};return f?e.jsxs("div",{className:"p-4 md:p-6 lg:p-8",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight",children:"Disburse Loan"}),x&&e.jsxs("p",{className:"text-sm text-[var(--muted-fg)]",children:["Borrower: ",e.jsx("b",{children:((y=x.Borrower)==null?void 0:y.name)||x.borrowerName||"—"})," • Amount:"," ",e.jsx("b",{children:Number(x.amount||0).toLocaleString()})]})]}),e.jsx(g,{to:`/loans/${s}`,className:"text-indigo-600 hover:underline text-sm",children:"Back to Loan"})]}),N&&e.jsx("div",{className:"max-w-4xl mb-4 rounded-lg border border-rose-200 bg-rose-50 text-rose-700 px-3 py-2 text-sm",children:N}),e.jsxs("form",{onSubmit:C,className:"max-w-4xl",children:[e.jsxs("section",{className:$,children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-indigo-200 text-indigo-700 bg-indigo-50",children:[e.jsx(B,{className:"h-4 w-4"})," Disbursement Details"]})}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Method"}),e.jsx("select",{className:c,value:t.method,onChange:a=>i({...t,method:a.target.value}),children:M.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Amount"}),e.jsx("input",{type:"number",className:c,value:t.amount,onChange:a=>i({...t,amount:a.target.value})})]}),t.method==="bank"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Bank"}),e.jsxs("select",{className:c,value:t.bankId,onChange:a=>i({...t,bankId:a.target.value}),children:[e.jsx("option",{value:"",children:"Select bank…"}),S.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Reference"}),e.jsx("input",{className:c,value:t.reference,onChange:a=>i({...t,reference:a.target.value}),placeholder:"Txn ref / slip #"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-[var(--muted-fg)] flex items-center gap-1",children:[e.jsx(E,{className:"h-3.5 w-3.5"})," Date"]}),e.jsx("input",{type:"date",className:c,value:t.date,onChange:a=>i({...t,date:a.target.value})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Note (optional)"}),e.jsx("textarea",{className:`${c} min-h-[96px]`,value:t.note,onChange:a=>i({...t,note:a.target.value})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-[var(--muted-fg)]",children:"Upload slip / proof (optional)"}),e.jsx("input",{ref:b,type:"file",className:c})]})]})]}),e.jsx("div",{className:"sticky bottom-0 inset-x-0 z-20 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 border-t mt-6",children:e.jsxs("div",{className:"max-w-4xl px-4 py-3 ml-0 flex justify-end gap-3",children:[e.jsx(g,{to:`/loans/${s}`,className:"px-4 py-2 rounded-xl border border-[var(--border)] hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:v,className:"inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm",children:[e.jsx(I,{className:"h-4 w-4"}),v?"Disbursing…":"Disburse"]})]})})]})]}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"max-w-3xl mx-auto bg-[var(--card)] border border-[var(--border)] rounded-2xl p-6",children:[e.jsxs("p",{className:"text-sm text-[var(--fg)]",children:["You don’t have permission to disburse loans. This page is available to ",e.jsx("b",{children:"Admin"})," and ",e.jsx("b",{children:"Accountant"})," roles."]}),e.jsx(g,{to:`/loans/${s}`,className:"text-indigo-600 underline text-sm mt-3 inline-block",children:"Back to loan"})]})})}export{z as default};

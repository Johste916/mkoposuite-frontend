import{r,f as C,u as F,b as m,j as e}from"./index-Iq-s2r8X.js";const I=o=>{var i;return!!o&&(o.role==="admin"||o.role==="director"||((i=o.permissions)==null?void 0:i.includes("payroll:run")))};function M(){const[o,i]=r.useState(null),[$,w]=r.useState([]),[p,y]=r.useState(""),[u,N]=r.useState(""),[x,h]=r.useState([]),[S,E]=r.useState(!0),[b,c]=r.useState(""),[g,v]=r.useState(!1),[j]=C(),P=F(),f=r.useMemo(()=>I(o),[o]);r.useEffect(()=>{let s=!1;return(async()=>{var a,t;try{const[{data:n},{data:l}]=await Promise.all([m.get("/auth/me"),m.get("/hr/employees",{params:{active:1,limit:1e3}})]);if(s)return;i(n);const T=((l==null?void 0:l.items)||[]).map(d=>({employeeId:d.id,name:`${d.firstName} ${d.lastName}`,base:Number(d.baseSalary||0),allowances:0,deductions:0,overtime:0,advances:0,savings:0,loans:0}));w((l==null?void 0:l.items)||[]),h(T)}catch(n){c(((t=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:t.message)||n.message)}finally{E(!1)}})(),()=>s=!0},[]),r.useEffect(()=>{const s=j.get("clone");s&&(async()=>{try{const{data:a}=await m.get(`/hr/payroll/runs/${s}`);y((a==null?void 0:a.periodFrom)||""),N((a==null?void 0:a.periodTo)||""),Array.isArray(a==null?void 0:a.lines)&&h(a.lines)}catch{}})()},[j]);const A=s=>Number(s.base||0)+Number(s.allowances||0)+Number(s.overtime||0)-Number(s.deductions||0)-Number(s.advances||0)-Number(s.savings||0)-Number(s.loans||0),L=async()=>{var s,a;if(!f){c("You don't have permission to run payroll.");return}if(!p||!u){c("Select a period");return}v(!0),c("");try{const t={periodFrom:p,periodTo:u,lines:x},{data:n}=await m.post("/hr/payroll/runs",t);P(`/payroll/report?runId=${n.runId}`)}catch(t){c(((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||t.message||"Payroll failed.")}finally{v(!1)}};return S?e.jsx("div",{className:"p-4",children:"Loading…"}):f?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Run Payroll"}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b}),e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Period From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:p,onChange:s=>y(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Period To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:u,onChange:s=>N(s.target.value)})]}),e.jsx("button",{onClick:L,disabled:g,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:g?"Running…":"Run"})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Employee"}),e.jsx("th",{className:"py-2 px-3",children:"Base"}),e.jsx("th",{className:"py-2 px-3",children:"Allowances"}),e.jsx("th",{className:"py-2 px-3",children:"Overtime"}),e.jsx("th",{className:"py-2 px-3",children:"Deductions"}),e.jsx("th",{className:"py-2 px-3",children:"Advances"}),e.jsx("th",{className:"py-2 px-3",children:"Savings"}),e.jsx("th",{className:"py-2 px-3",children:"Loans"}),e.jsx("th",{className:"py-2 px-3",children:"Net"})]})}),e.jsx("tbody",{children:x.map((s,a)=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:s.name}),["base","allowances","overtime","deductions","advances","savings","loans"].map(t=>e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"number",className:"border rounded px-2 py-1 w-28",value:s[t],onChange:n=>{const l=[...x];l[a]={...l[a],[t]:Number(n.target.value||0)},h(l)}})},t)),e.jsxs("td",{className:"py-2 px-3 font-medium",children:["TZS ",A(s).toLocaleString()]})]},s.employeeId))})]})})]}):e.jsx("div",{className:"p-4 text-red-600",children:"You don't have permission to run payroll."})}export{M as default};

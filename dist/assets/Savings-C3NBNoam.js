import{r as n,j as e,g}from"./index-CecoMAn-.js";import{E as D}from"./jspdf.es.min-TZdunOCb.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as E}from"./index-Bapd5w5D.js";import{B as f}from"./BorrowerAutoComplete-BEX2UUfd.js";const P=()=>{const[h,v]=n.useState([]),[m,w]=n.useState({}),[k,N]=n.useState(0),[r,y]=n.useState({borrowerId:"",type:""}),[C,x]=n.useState(!1),[o,l]=n.useState({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),[p,c]=n.useState(""),u=JSON.parse(localStorage.getItem("user")||"{}"),b=((u==null?void 0:u.role)||"").toLowerCase()==="admin",j=async()=>{var s,t;c("");try{if(!r.borrowerId){v([]),N(0),w({});return}const a=new URLSearchParams;r.type&&a.set("type",r.type);const d=await g._get(`/savings/borrower/${r.borrowerId}?${a.toString()}`);v(d.data.transactions||[]),N(d.data.balance||0),w(d.data.totals||{})}catch(a){c(((t=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:t.error)||(a==null?void 0:a.normalizedMessage)||"Failed to fetch savings")}};n.useEffect(()=>{j()},[r.borrowerId,r.type]);const S=async()=>{var s,t;c("");try{const a={...o};if(!a.borrowerId||!a.type||!a.amount||!a.date){c("Borrower, type, amount and date are required.");return}await g._post("/savings",a),x(!1),l({borrowerId:"",type:"deposit",amount:"",date:"",notes:""}),j()}catch(a){c(((t=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:t.error)||(a==null?void 0:a.normalizedMessage)||"Failed to save.")}},I=async s=>{var t,a;if(window.confirm("Reverse this transaction?"))try{await g._patch(`/savings/transactions/${s}/reverse`),j()}catch(d){c(((a=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:a.error)||(d==null?void 0:d.normalizedMessage)||"Failed to reverse.")}},T=()=>{const s=new D;s.text("Savings Transactions",14,16),s.autoTable({startY:20,head:[["Date","Type","Amount","Notes","Reversed"]],body:h.map(t=>[t.date,t.type,t.amount,t.notes||"-",t.reversed?"Yes":"No"])}),s.save("savings.pdf")},A=[["Date","Type","Amount","Notes","Reversed"],...h.map(s=>[s.date,s.type,s.amount,s.notes||"",s.reversed?"Yes":"No"])],i="bg-white dark:bg-slate-800 rounded-xl shadow p-4";return e.jsxs("div",{className:"p-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Savings"}),e.jsx("button",{onClick:()=>x(!0),className:"bg-blue-600 text-white px-4 py-2 rounded",children:"+ Add Transaction"})]}),e.jsxs("div",{className:`${i} mb-4`,children:[e.jsxs("div",{className:"flex flex-wrap gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Borrower"}),e.jsx(f,{value:r.borrowerId||null,onChange:s=>y(t=>({...t,borrowerId:s}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Type"}),e.jsxs("select",{value:r.type,onChange:s=>y({...r,type:s.target.value}),className:"border px-3 py-2 rounded w-48 dark:bg-slate-700 dark:border-slate-600",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]})]})]}),p&&e.jsxs("div",{className:"text-sm text-rose-600 mt-3",children:["Error: ",p]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:i,children:["Balance: ",e.jsx("strong",{children:k})]}),e.jsxs("div",{className:i,children:["Deposits: ",e.jsx("strong",{children:m.deposits||0})]}),e.jsxs("div",{className:i,children:["Withdrawals: ",e.jsx("strong",{children:m.withdrawals||0})]}),e.jsxs("div",{className:i,children:["Charges: ",e.jsx("strong",{children:m.charges||0})]})]}),e.jsxs("div",{className:"flex gap-3 mb-3",children:[e.jsx(E,{data:A,filename:"savings.csv",className:"bg-green-600 text-white px-4 py-2 rounded",children:"Export CSV"}),e.jsx("button",{onClick:T,className:"bg-red-600 text-white px-4 py-2 rounded",children:"Export PDF"})]}),e.jsx("div",{className:"overflow-x-auto bg-white dark:bg-slate-800 border rounded shadow",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-slate-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 border",children:"Date"}),e.jsx("th",{className:"p-2 border",children:"Type"}),e.jsx("th",{className:"p-2 border",children:"Amount"}),e.jsx("th",{className:"p-2 border",children:"Notes"}),e.jsx("th",{className:"p-2 border",children:"Reversed"}),b&&e.jsx("th",{className:"p-2 border",children:"Action"})]})}),e.jsxs("tbody",{children:[h.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:s.date}),e.jsx("td",{className:"border p-2 capitalize",children:s.type}),e.jsx("td",{className:"border p-2",children:s.amount}),e.jsx("td",{className:"border p-2",children:s.notes||"-"}),e.jsx("td",{className:"border p-2",children:s.reversed?"Yes":"No"}),b&&e.jsx("td",{className:"border p-2",children:!s.reversed&&e.jsx("button",{onClick:()=>I(s.id),className:"text-red-500 text-sm",children:"Reverse"})})]},s.id)),!h.length&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-sm text-slate-500",colSpan:b?6:5,children:r.borrowerId?"No transactions found.":"Search and select a borrower to view transactions."})})]})]})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-6 rounded shadow-md w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Add Transaction"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(f,{value:o.borrowerId||null,onChange:s=>l(t=>({...t,borrowerId:s})),placeholder:"Pick borrowerâ€¦"}),e.jsxs("select",{value:o.type,onChange:s=>l({...o,type:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700",children:[e.jsx("option",{value:"deposit",children:"Deposit"}),e.jsx("option",{value:"withdrawal",children:"Withdrawal"}),e.jsx("option",{value:"charge",children:"Charge"}),e.jsx("option",{value:"interest",children:"Interest"})]}),e.jsx("input",{type:"number",placeholder:"Amount",value:o.amount,onChange:s=>l({...o,amount:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"date",value:o.date,onChange:s=>l({...o,date:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsx("input",{type:"text",placeholder:"Notes",value:o.notes,onChange:s=>l({...o,notes:s.target.value}),className:"border px-3 py-2 w-full rounded dark:bg-slate-800 dark:border-slate-700"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>x(!1),className:"px-4 py-2 bg-gray-300 rounded",children:"Cancel"}),e.jsx("button",{onClick:S,className:"px-4 py-2 bg-blue-600 text-white rounded",children:"Save"})]}),p&&e.jsxs("div",{className:"text-sm text-rose-600",children:["Error: ",p]})]})]})})]})};export{P as default};

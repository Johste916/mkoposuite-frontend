import{r as m,j as e,g as B}from"./index-CGp3nliO.js";const R=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;async function D(l,r){let g=null;for(const b of l)try{const c=await B.get(b,r);if((c==null?void 0:c.data)!==void 0)return c.data}catch(c){g=c}throw g||Object.assign(new Error("Not Found"),{code:404})}async function ee(l,r,g){var c;let b=null;for(const A of l)try{const x=await B.patch(A,r,g);return(x==null?void 0:x.data)??!0}catch(x){const k=(c=x==null?void 0:x.response)==null?void 0:c.status;k!==404&&k!==405&&(b=x)}throw b||Object.assign(new Error("No PATCH endpoint matched"),{code:404})}function G(l=[]){const r=g=>l.includes(g);return{savings:r("savings.view"),loans:r("loans.view"),collections:r("collections.view"),accounting:r("accounting.view"),sms:r("sms.send")||r("sms.view"),esignatures:r("esign.view")||r("esignatures.view"),payroll:r("payroll.view"),investors:r("investors.view"),assets:r("assets.view"),collateral:r("collateral.view"),reports:r("reports.view")}}function M(l={}){return{planCode:l.planCode||l.plan_code||"basic",trialEndsAt:l.trialEndsAt||l.trial_ends_at||"",autoDisableOverdue:(typeof l.autoDisableOverdue<"u"?l.autoDisableOverdue:l.auto_disable_overdue)??!1,graceDays:(typeof l.graceDays<"u"?l.graceDays:l.grace_days)??7,billingEmail:l.billingEmail||l.billing_email||""}}function ae(){const[l,r]=m.useState(null),[g,b]=m.useState(null),[c,A]=m.useState(null),[x,k]=m.useState([]),[d,y]=m.useState(M()),[_,T]=m.useState(M()),[L,w]=m.useState("loading"),[J,C]=m.useState(""),[E,$]=m.useState(!1),[H,P]=m.useState([]),O=(t,s="ok")=>{const o=Math.random().toString(36).slice(2);P(n=>[...n,{id:o,msg:t,type:s}]),setTimeout(()=>P(n=>n.filter(a=>a.id!==o)),2600)},z=m.useMemo(()=>JSON.stringify(d)!==JSON.stringify(_),[d,_]),S=async()=>{var t,s,o,n;w("loading"),C("");try{const a=await D(["/tenants/me","/tenant/me","/account/tenant","/account/organization","/org/tenant","/org/me","/org"],{}).catch(()=>({}));r(a);const u=(a==null?void 0:a.id)||(a==null?void 0:a.tenantId)||null;u&&localStorage.setItem("tenantId",u);const N=(I={})=>u?{...I,headers:{...I.headers||{},"x-tenant-id":u}}:I,h=await D(["/tenants/me/entitlements","/tenant/me/entitlements","/account/tenant/entitlements","/account/organization/entitlements","/org/entitlements"],N()).catch(()=>({}));let j={};h!=null&&h.modules&&typeof h.modules=="object"?j=h:Array.isArray(h)?j={modules:G(h)}:j=h||{},b(j);const i=await D(["/tenants/me/limits","/tenant/me/limits","/account/tenant/limits","/account/organization/limits","/org/limits"],N()).catch(()=>({})),W=i&&typeof i=="object"&&i.limits?i.limits:i||{};A(W||{}),!(j&&j.modules&&Object.keys(j.modules).length>0)&&Array.isArray(i==null?void 0:i.entitlements)&&b({modules:G(i.entitlements),planCode:(((t=i==null?void 0:i.plan)==null?void 0:t.code)||((s=i==null?void 0:i.plan)==null?void 0:s.name)||(a==null?void 0:a.planCode)||(a==null?void 0:a.plan_code)||"basic").toString().toLowerCase(),status:(a==null?void 0:a.status)||"trial"});const v=await D(["/tenants/me/invoices","/tenant/me/invoices","/account/tenant/invoices","/account/organization/invoices","/org/invoices"],N()).catch(()=>[]),Z=Array.isArray(v)?v:Array.isArray(v==null?void 0:v.invoices)?v.invoices:[];k(Z);const F=M(a);y(F),T(F),w("ready")}catch(a){w("error"),C(((n=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:n.error)||a.message||"Unknown error")}};m.useEffect(()=>{S()},[]);const[p,U]=m.useState({}),X=(t=d)=>{const s={};t.billingEmail&&!R.test(t.billingEmail)&&(s.billingEmail="Enter a valid email");const o=Number(t.graceDays??0);return(!Number.isFinite(o)||o<0||o>90)&&(s.graceDays="Grace days must be 0–90"),t.trialEndsAt&&!/^\d{4}-\d{2}-\d{2}$/.test(String(t.trialEndsAt))&&(s.trialEndsAt="Use YYYY-MM-DD"),s},q=async()=>{var s,o;const t=X();if(U(t),Object.keys(t).length){O("Fix validation errors","error");return}$(!0);try{const n=(l==null?void 0:l.id)||(l==null?void 0:l.tenantId)||localStorage.getItem("tenantId")||null,a=(u={})=>n?{...u,headers:{...u.headers||{},"x-tenant-id":n}}:u;await ee(["/tenants/me","/tenant/me","/account/tenant","/account/organization","/org/tenant","/org"],{planCode:d.planCode,trialEndsAt:d.trialEndsAt||null,autoDisableOverdue:!!d.autoDisableOverdue,graceDays:Number(d.graceDays??0),billingEmail:d.billingEmail||""},a()),T(d),O("Saved organization"),await S()}catch(n){w("error"),C(((o=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:o.error)||n.message||"Save failed"),O("Save failed","error")}finally{$(!1)}},K=()=>{y(_),U({})},Y=l||{},f=g||{},Q=d.planCode||Y.planCode||Y.plan_code||f.planCode||"basic",V=t=>{const s=t.hosted_url||t.url||t.pdf_url||t.pdfUrl||t.download_url||null;if(s)try{window.open(s,"_blank","noopener,noreferrer")}catch{}};return L==="loading"?e.jsx("div",{className:"p-4 text-sm text-slate-500 dark:text-slate-400",children:"Loading…"}):L==="error"?e.jsxs("div",{className:"p-4 text-sm text-rose-600 dark:text-rose-400",children:["Error: ",J,e.jsx("div",{className:"mt-3",children:e.jsx("button",{onClick:S,className:"h-9 px-3 rounded ms-btn",children:"Retry"})})]}):e.jsxs("div",{className:"ms-card p-4 space-y-6",children:[e.jsx("div",{className:"fixed right-4 top-4 z-50 space-y-2",children:H.map(t=>e.jsx("div",{className:`px-3 py-2 rounded shadow text-sm text-white ${t.type==="error"?"bg-rose-600":"bg-emerald-600"}`,children:t.msg},t.id))}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:"Organization"}),z&&e.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded bg-amber-100 text-amber-700",children:"Unsaved changes"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("label",{children:[e.jsx("div",{className:"block text-xs text-slate-500 dark:text-slate-400 mb-1",children:"Plan"}),e.jsxs("select",{value:Q,onChange:t=>y(s=>({...s,planCode:t.target.value})),className:"border rounded px-2 py-2 w-full bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",children:[e.jsx("option",{value:"basic",children:"Basic"}),e.jsx("option",{value:"pro",children:"Pro"}),e.jsx("option",{value:"premium",children:"Premium"})]})]}),e.jsxs("label",{children:[e.jsx("div",{className:"block text-xs text-slate-500 dark:text-slate-400 mb-1",children:"Trial ends"}),e.jsx("input",{type:"date",value:d.trialEndsAt||"",onChange:t=>y(s=>({...s,trialEndsAt:t.target.value})),className:`border rounded px-2 py-2 w-full bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200 ${p.trialEndsAt?"border-rose-400":""}`}),p.trialEndsAt&&e.jsx("div",{className:"text-[11px] text-rose-600 mt-1",children:p.trialEndsAt})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!d.autoDisableOverdue,onChange:t=>y(s=>({...s,autoDisableOverdue:t.target.checked})),className:"h-4 w-4"}),e.jsx("span",{children:"Auto suspend overdue"})]}),e.jsxs("label",{children:[e.jsx("div",{className:"block text-xs text-slate-500 dark:text-slate-400 mb-1",children:"Grace days"}),e.jsx("input",{type:"number",min:0,max:90,value:String(d.graceDays??0),onChange:t=>y(s=>({...s,graceDays:Number(t.target.value||0)})),className:`border rounded px-2 py-2 w-full bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200 ${p.graceDays?"border-rose-400":""}`}),p.graceDays&&e.jsx("div",{className:"text-[11px] text-rose-600 mt-1",children:p.graceDays})]}),e.jsxs("label",{className:"md:col-span-2",children:[e.jsx("div",{className:"block text-xs text-slate-500 dark:text-slate-400 mb-1",children:"Billing email"}),e.jsx("input",{type:"email",value:d.billingEmail||"",onChange:t=>y(s=>({...s,billingEmail:t.target.value})),className:`border rounded px-2 py-2 w-full bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200 ${p.billingEmail?"border-rose-400":""}`,placeholder:"billing@company.com"}),p.billingEmail&&e.jsx("div",{className:"text-[11px] text-rose-600 mt-1",children:p.billingEmail})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:q,disabled:!z||E,className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60",children:E?"Saving…":"Save"}),e.jsx("button",{onClick:K,disabled:!z||E,className:"h-9 px-3 rounded border bg-white hover:bg-slate-50 disabled:opacity-60",children:"Reset"}),e.jsx("button",{onClick:S,disabled:E,className:"h-9 px-3 rounded ms-btn",children:"Refresh"})]}),e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-800 pt-3",children:[e.jsx("h3",{className:"font-semibold mb-2 text-slate-900 dark:text-slate-100",children:"Entitlements"}),e.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm",children:Object.entries((f==null?void 0:f.modules)||{}).length===0?e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:"No entitlements available."}):Object.entries(f.modules).map(([t,s])=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-44 capitalize text-slate-700 dark:text-slate-200",children:t.replace(/_/g," ")}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${s?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300":"bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300"}`,children:s?"enabled":"disabled"})]},t))})]}),e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-800 pt-3",children:[e.jsx("h3",{className:"font-semibold mb-2 text-slate-900 dark:text-slate-100",children:"Limits"}),!c||Object.keys(c).length===0?e.jsx("div",{className:"text-sm text-slate-500 dark:text-slate-400",children:"No limits configured."}):e.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm",children:Object.entries(c).map(([t,s])=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-44 capitalize text-slate-700 dark:text-slate-200",children:t.replace(/_/g," ")}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 dark:text-slate-200",children:s===null?"Unlimited":String(s)})]},t))})]}),e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-800 pt-3",children:[e.jsx("h3",{className:"font-semibold mb-2 text-slate-900 dark:text-slate-100",children:"Invoices"}),x.length===0?e.jsx("div",{className:"text-sm text-slate-500 dark:text-slate-400",children:"No invoices yet."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-slate-500 dark:text-slate-400",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-4",children:"Number"}),e.jsx("th",{className:"py-2 pr-4",children:"Amount"}),e.jsx("th",{className:"py-2 pr-4",children:"Due date"}),e.jsx("th",{className:"py-2 pr-4",children:"Status"}),e.jsx("th",{className:"py-2 pr-4"})]})}),e.jsx("tbody",{className:"align-top",children:x.map(t=>{var N;const s=(t.amount_cents??t.amountCents??t.total_cents??0)/100,o=t.currency||t.ccy||"USD",n=((N=t.due_date||t.dueDate||t.due_at||"")==null?void 0:N.toString().slice(0,10))||"-",a=t.status||"open",u=!!(t.hosted_url||t.url||t.pdf_url||t.download_url);return e.jsxs("tr",{className:"border-top border-slate-100 dark:border-slate-800",children:[e.jsx("td",{className:"py-2 pr-4",children:t.number||t.id}),e.jsx("td",{className:"py-2 pr-4",children:Number(s).toLocaleString(void 0,{style:"currency",currency:o})}),e.jsx("td",{className:"py-2 pr-4",children:n}),e.jsx("td",{className:"py-2 pr-4",children:e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${a==="paid"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300":a==="past_due"?"bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300":"bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300"}`,children:a})}),e.jsx("td",{className:"py-2 pr-4",children:u&&e.jsx("button",{onClick:()=>V(t),className:"h-8 px-2 rounded border bg-white hover:bg-slate-50",children:"Open"})})]},t.id||t.number)})})]})})]})]})}export{ae as default};

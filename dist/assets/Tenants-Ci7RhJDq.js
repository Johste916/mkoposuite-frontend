import{r as c,j as s,b as E}from"./index-xa1xRnXx.js";async function _(p,a){let l=null;for(const r of p)try{const{data:i}=await E.get(r,a);return i}catch(i){l=i}throw l||new Error("GET failed")}async function L(p,a,l,r){var u;let i=null;for(const x of a)try{const o=p==="patch"?await E.patch(x,l,r):await E.post(x,l,r);return(o==null?void 0:o.data)??!0}catch(o){const h=(u=o==null?void 0:o.response)==null?void 0:u.status;h!==404&&h!==405&&(i=o)}throw i||new Error(`${p} failed`)}function z(p){var f,k,v,g,w,b,N,m,C,$;const a=p||{},l=a.id??a.tenantId??a.orgId??a.organizationId??a._id??a.uuid??null,r=a.name||a.company||a.company_name||a.organization||a.displayName||a.slug||`Tenant ${l??""}`.trim(),i=(a.planCode||a.plan_code||((f=a.plan)==null?void 0:f.code)||((k=a.subscription)==null?void 0:k.planCode)||((g=(v=a.subscription)==null?void 0:v.plan)==null?void 0:g.code)||a.plan||"").toString().toLowerCase(),u=a.planName||a.plan_name||((w=a.plan)==null?void 0:w.name)||((N=(b=a.subscription)==null?void 0:b.plan)==null?void 0:N.name)||(i?i.replace(/(^|_)(\w)/g,(S,A,T)=>(A?" ":"")+T.toUpperCase()):"—"),x=a.status||(a.active===!0?"active":a.active===!1?"inactive":void 0)||((m=a.subscription)==null?void 0:m.status)||"unknown",o=a.trialEndsAt||a.trial_ends_at||a.trialEnd||a.trial_end||null,h=a.staffCount??a.userCount??a.users_count??a.staff_count??a.membersCount??a.members_count??((C=a.stats)==null?void 0:C.staff)??(($=a.stats)==null?void 0:$.users)??null;return{id:l,name:r,planCode:i,planName:u,status:x,trialEnds:o,staffCount:h,raw:a}}const O=[{code:"basic",name:"Basic",price:0,staffLimit:5},{code:"pro",name:"Pro",price:49,staffLimit:50},{code:"premium",name:"Premium",price:149,staffLimit:250}];function G(){const[p,a]=c.useState(!0),[l,r]=c.useState(null),[i,u]=c.useState(""),[x,o]=c.useState(""),[h,f]=c.useState([]),[k,v]=c.useState(O),[g,w]=c.useState(""),[b,N]=c.useState(""),m=(t,e="ok")=>{N(t),setTimeout(()=>N(""),2500),e==="error"&&console.warn(t)},C=async()=>{try{const t=await _(["/admin/tenants/plans","/admin/plans","/system/plans","/billing/plans","/plans"],{}),d=(Array.isArray(t)?t:Array.isArray(t==null?void 0:t.items)?t.items:Array.isArray(t==null?void 0:t.data)?t.data:[]).map(n=>{var j;return{code:n.code||n.planCode||n.slug||(n.name?n.name.toString().toLowerCase().replace(/\s+/g,"-"):"plan"),name:n.name||n.title||n.displayName||n.code||"Plan",price:n.price??n.priceMonthly??n.amount??(n.amountCents?n.amountCents/100:0),staffLimit:n.staffLimit??n.usersLimit??n.maxUsers??((j=n.limits)==null?void 0:j.users)??null}});d.length&&v(d)}catch{}},$=async()=>{var t;u(""),o("");try{const e=await _(["/admin/tenants","/system/tenants","/tenants","/org/tenants","/organizations","/orgs","/admin/organizations","/admin/orgs"],{}),d=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.items)?e.items:Array.isArray(e==null?void 0:e.data)?e.data:[];if(d.length){f(d.map(z));return}}catch{}try{const e=await _(["/tenants/me","/tenant/me","/account/tenant","/account/organization","/org/tenant","/org/me","/org","/organization"],{}).catch(()=>null)||null;if(e&&Object.keys(e).length){f([z(e)]),u("Showing your current organization only (no list endpoint found).");return}}catch{}try{const{data:e}=await E.get("/auth/me"),d=(e==null?void 0:e.tenant)||(e==null?void 0:e.organization)||(e==null?void 0:e.org)||((t=e==null?void 0:e.account)==null?void 0:t.tenant)||null;if(d){f([z(d)]),u("Showing tenant from your profile (no list endpoint found).");return}}catch{}f([]),u("No compatible tenant endpoints were found on this server.")},S=async()=>{a(!0),await Promise.all([$(),C()]),a(!1)};c.useEffect(()=>{S()},[]);const A=c.useMemo(()=>{const t=g.trim().toLowerCase();return t?h.filter(e=>e.name.toLowerCase().includes(t)||e.planName.toLowerCase().includes(t)||(e.planCode||"").toLowerCase().includes(t)||(e.status||"").toLowerCase().includes(t)):h},[g,h]),T=async(t,e)=>{var d,n,j,P;r(t.id);try{await L("patch",[`/admin/tenants/${t.id}/plan`,`/admin/tenants/${t.id}/subscription`,`/tenants/${t.id}/plan`,`/tenants/${t.id}/assign-plan`,`/orgs/${t.id}/plan`,`/organizations/${t.id}/plan`,`/billing/tenants/${t.id}/plan`],{planCode:e,plan:e,code:e}).catch(async()=>{await L("post",[`/admin/tenants/${t.id}/plan`,`/admin/tenants/${t.id}/subscription`,`/tenants/${t.id}/plan`,`/tenants/${t.id}/assign-plan`,`/orgs/${t.id}/plan`,`/organizations/${t.id}/plan`,`/billing/tenants/${t.id}/plan`],{planCode:e,plan:e,code:e})}),m("Plan updated"),await S()}catch(y){m(((n=(d=y==null?void 0:y.response)==null?void 0:d.data)==null?void 0:n.message)||((P=(j=y==null?void 0:y.response)==null?void 0:j.data)==null?void 0:P.error)||"Failed to change plan","error")}finally{r(null)}},I=async t=>{r(t.id);try{await L("post",[`/admin/tenants/${t.id}/notify`,`/tenants/${t.id}/notify`,`/orgs/${t.id}/notify`,`/organizations/${t.id}/notify`,`/support/tenants/${t.id}/message`],{subject:"Update from your administrator",message:"Hello! This is a notification from the admin console. Reply in your portal if you need help."}),m("Notification sent")}catch{m("No notify endpoint available on this server","error")}finally{r(null)}},M=async t=>{r(t.id);try{await L("post",[`/admin/tenants/${t.id}/invoices/sync`,`/billing/tenants/${t.id}/invoices/sync`,`/tenants/${t.id}/invoices/sync`],{}),m("Invoice sync triggered")}catch{m("No invoice sync endpoint available","error")}finally{r(null)}};return p?s.jsx("div",{className:"p-4 text-sm text-slate-500 dark:text-slate-400",children:"Loading…"}):s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h1",{className:"text-xl font-semibold",children:"Admin · Tenants"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{value:g,onChange:t=>w(t.target.value),placeholder:"Search…",className:"h-9 px-3 rounded border bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200"}),s.jsx("button",{onClick:S,className:"h-9 px-3 rounded ms-btn",children:"Refresh"})]})]}),!!b&&s.jsx("div",{className:"text-sm text-emerald-600 dark:text-emerald-400",children:b}),!!x&&s.jsx("div",{className:"text-sm text-rose-600 dark:text-rose-400",children:x}),!!i&&!x&&s.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:i}),s.jsx("div",{className:"overflow-x-auto bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-xl",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"text-slate-600 dark:text-slate-300",children:s.jsxs("tr",{children:[s.jsx("th",{className:"text-left py-2 px-3",children:"Name"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Plan"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Status"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Trial ends"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Staff"}),s.jsx("th",{className:"text-left py-2 px-3 w-[280px]",children:"Actions"})]})}),s.jsx("tbody",{className:"text-slate-800 dark:text-slate-200",children:A.length===0?s.jsx("tr",{children:s.jsx("td",{className:"py-6 px-3 text-slate-500 dark:text-slate-400",colSpan:6,children:"No tenants found."})}):A.map(t=>s.jsxs("tr",{className:"border-t border-slate-200 dark:border-slate-800",children:[s.jsx("td",{className:"py-2 px-3",children:t.name}),s.jsx("td",{className:"py-2 px-3",children:t.planName}),s.jsx("td",{className:"py-2 px-3",children:s.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${(t.status||"unknown")==="active"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300":(t.status||"").includes("trial")?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":(t.status||"").includes("past_due")?"bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300":"bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300"}`,children:t.status||"unknown"})}),s.jsx("td",{className:"py-2 px-3",children:t.trialEnds?String(t.trialEnds).slice(0,10):"—"}),s.jsx("td",{className:"py-2 px-3",children:t.staffCount??"—"}),s.jsx("td",{className:"py-2 px-3",children:s.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[s.jsxs("select",{defaultValue:t.planCode||"",onChange:e=>T(t,e.target.value),disabled:l===t.id,className:"h-9 px-2 rounded border bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-slate-200",title:"Change plan",children:[s.jsx("option",{value:"",disabled:!0,children:"Assign plan…"}),k.map(e=>s.jsx("option",{value:e.code,children:e.name},e.code))]}),s.jsx("button",{className:"h-9 px-3 rounded border bg-white dark:bg-slate-900 dark:border-slate-700",onClick:()=>I(t),disabled:l===t.id,title:"Send a notification to this tenant",children:"Notify"}),s.jsx("button",{className:"h-9 px-3 rounded border bg-white dark:bg-slate-900 dark:border-slate-700",onClick:()=>M(t),disabled:l===t.id,title:"Trigger invoice sync",children:"Sync Invoices"})]})})]},t.id||t.name))})]})}),s.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"This console is visible only to system administrators/owners (and any roles you allowed in routing)."})]})}export{G as default};

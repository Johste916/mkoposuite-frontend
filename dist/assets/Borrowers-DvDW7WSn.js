import{u as fe,r as i,g as y,j as e,L}from"./index-BVbJtkKt.js";import{C as ge}from"./circle-plus-B82iDwMM.js";import{U as je,B as Ne}from"./upload-CilSWTcA.js";import{S as be,F as we}from"./search-mLzYf8CT.js";import{P as ye,I as Se}from"./phone-BAuURofy.js";import{C as $e,a as Ce}from"./chevron-right-QK1qz-s9.js";import{X as Ae}from"./x-CXs4_1Cl.js";import{F as ke}from"./file-up-Bm9RmnJP.js";import"./createLucideIcon-DYUPA3ji.js";const $=10;async function ee(a=[],t={}){let u;for(const m of a)try{const x=await y.get(m,t);return x==null?void 0:x.data}catch(x){u=x}throw u||new Error("No endpoint succeeded")}function se(a){return Array.isArray(a)?a:Array.isArray(a==null?void 0:a.items)?a.items:Array.isArray(a==null?void 0:a.rows)?a.rows:Array.isArray(a==null?void 0:a.data)?a.data:[]}const r={container:"p-6 min-h-screen bg-[var(--bg)] text-[var(--fg)]",card:"rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",btn:"inline-flex items-center gap-2 px-3 py-2 rounded-md border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--kpi-bg)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",primary:"inline-flex items-center gap-2 px-3 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",input:"w-full h-10 rounded-md px-3 py-2 border-2 bg-[var(--input-bg)] text-[var(--input-fg)] border-[var(--input-border)] placeholder:text-[var(--input-placeholder)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",table:"min-w-full text-[15px] border-separate border-spacing-0",th:"px-3 py-2 text-left text-[13px] uppercase tracking-wide font-semibold bg-[var(--table-head-bg)] text-[var(--fg)] border border-[var(--border)] first:border-l-0 last:border-r-0",td:"px-3 py-2 border border-[var(--border)] first:border-l-0 last:border-r-0",link:"font-semibold underline decoration-2 underline-offset-2 rounded-sm text-[var(--ring)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",chip:"inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full border bg-[var(--badge-bg)] text-[var(--badge-fg)] border-[var(--border)]",muted:"text-[var(--muted)]"},_=r.link,Ve=()=>{const a=fe(),[t,u]=i.useState([]),[m,x]=i.useState(0),[h,C]=i.useState(""),[S,re]=i.useState(""),[B,ae]=i.useState(""),[T,te]=i.useState(""),[D,ne]=i.useState(""),[p,le]=i.useState("createdAt"),[v,M]=i.useState("desc"),[f,g]=i.useState(1),[ie,R]=i.useState([]),[oe,Z]=i.useState([]),[V,z]=i.useState(!0),[O,Oe]=i.useState(null),[U,ce]=i.useState(!1),[j,de]=i.useState("overview"),[me,Q]=i.useState(!1),[A,k]=i.useState({overview:null,loans:[],savings:[],documents:[]}),[xe,Y]=i.useState([]),E=(s,o="info")=>{const c=Math.random().toString(36).slice(2);Y(l=>[...l,{id:c,msg:s,type:o}]),setTimeout(()=>Y(l=>l.filter(d=>d.id!==c)),3500)};i.useEffect(()=>{const s=setTimeout(()=>re(h.trim()),300);return()=>clearTimeout(s)},[h]),i.useEffect(()=>{const s=new AbortController;return(async()=>{try{const[o,c]=await Promise.all([ee(["/branches","/org/branches","/api/branches"],{signal:s.signal}).catch(()=>[]),ee(["/users?role=loan_officer","/staff?role=loan_officer","/api/users?role=loan_officer"],{signal:s.signal}).catch(()=>[])]),l=se(o),d=se(c);R(l.map(n=>n?{id:n.id??n._id??n.branchId??String(n.code??""),name:n.name??n.branchName??`Branch ${n.id??n.code??""}`}:null).filter(Boolean)),Z(d.map(n=>n?{id:n.id??n._id??n.userId??n.email??String(Math.random()),name:n.name??n.fullName??n.email??"User",email:n.email}:null).filter(Boolean))}catch{R([]),Z([])}})(),()=>s.abort()},[]);const q=i.useCallback(async s=>{var o,c,l,d;z(!0);try{const n=await y.get("/borrowers",{signal:s,params:{q:S||void 0,branchId:B||void 0,officerId:T||void 0,status:D||void 0,page:f,pageSize:$,sort:p,dir:v}});let I=[],P=0;Array.isArray(n.data)?(I=n.data,P=n.data.length):(I=((o=n.data)==null?void 0:o.items)||((c=n.data)==null?void 0:c.rows)||((l=n.data)==null?void 0:l.data)||[],P=Number(((d=n.data)==null?void 0:d.total)??I.length??0)),u(I),x(P)}catch{E("Failed to load borrowers","error"),u([]),x(0)}finally{z(!1)}},[S,B,T,D,f,p,v]);i.useEffect(()=>{const s=new AbortController;return q(s.signal),()=>s.abort()},[q]);const G=i.useCallback(async(s,o,c)=>{Q(!0);try{if(s==="overview"){const l=await y.get(`/borrowers/${o}`,{signal:c});k(d=>({...d,overview:l.data||null}))}else if(s==="loans"){const l=await y.get(`/borrowers/${o}/loans`,{signal:c});k(d=>{var n;return{...d,loans:Array.isArray(l.data)?l.data:((n=l.data)==null?void 0:n.items)||[]}})}else if(s==="savings"){const l=await y.get(`/borrowers/${o}/savings`,{signal:c});k(d=>{var n;return{...d,savings:Array.isArray(l.data)?l.data:((n=l.data)==null?void 0:n.items)||[]}})}else if(s==="documents"){const l=await y.get(`/borrowers/${o}/documents`,{signal:c}).catch(()=>({data:[]}));k(d=>{var n;return{...d,documents:Array.isArray(l==null?void 0:l.data)?l.data:((n=l==null?void 0:l.data)==null?void 0:n.items)||[]}})}}catch{E("Failed to load borrower details","error")}finally{Q(!1)}},[]);i.useEffect(()=>{if(!U||!O)return;const s=new AbortController;return G(j,O,s.signal),()=>s.abort()},[U,j,O,G]);const N=s=>{p===s?M(o=>o==="asc"?"desc":"asc"):(le(s),M("asc"))},X=s=>`TZS ${Number(s||0).toLocaleString()}`,ue=i.useMemo(()=>m===0?0:(f-1)*$+1,[f,m]),he=i.useMemo(()=>Math.min(f*$,m),[f,m]),H=s=>(s==null?void 0:s.name)||`${(s==null?void 0:s.firstName)||""} ${(s==null?void 0:s.lastName)||""}`.trim()||"â€”",J=s=>{var o,c;return(s==null?void 0:s.branchName)||((o=s==null?void 0:s.Branch)==null?void 0:o.name)||((c=s==null?void 0:s.branch)==null?void 0:c.name)||"â€”"},pe=s=>{var o,c;return(s==null?void 0:s.officerName)||((o=s==null?void 0:s.officer)==null?void 0:o.name)||((c=s==null?void 0:s.loanOfficer)==null?void 0:c.name)||"â€”"},ve=s=>{var d,n;const o=(s||"").trim();if(!o)return"U";const c=o.split(/\s+/).filter(Boolean);return((((d=c[0])==null?void 0:d[0])||"")+(((n=c[1])==null?void 0:n[0])||"")).toUpperCase()||o[0].toUpperCase()},W=s=>r.chip;return e.jsxs("div",{className:r.container,children:[e.jsx("div",{className:"fixed right-4 top-4 z-50 space-y-2",children:xe.map(s=>e.jsx("div",{className:"px-3 py-2 rounded-md shadow text-sm border-2",style:{background:"var(--card)",color:"var(--fg)",borderColor:"var(--border-strong)"},children:s.msg},s.id))}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-extrabold",children:"ðŸ‘¥ Borrowers"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>a("/borrowers/add"),className:r.primary,children:[e.jsx(ge,{className:"w-4 h-4"})," Add Borrower"]}),e.jsxs("button",{onClick:()=>E("CSV import coming soon","info"),className:r.btn,children:[e.jsx(je,{className:"w-4 h-4"})," Import CSV"]})]})]}),e.jsx("div",{className:`${r.card} p-3 md:p-4 mb-4`,children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:items-center",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(be,{className:`w-4 h-4 ${r.muted} absolute left-3 top-1/2 -translate-y-1/2`}),e.jsx("input",{value:h,onChange:s=>{C(s.target.value),g(1)},placeholder:"Search by name, phone, national IDâ€¦",className:`${r.input} pl-9`})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:B,onChange:s=>{ae(s.target.value),g(1)},className:r.input,children:[e.jsx("option",{value:"",children:"All Branches"}),ie.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("div",{className:"min-w-[200px]",children:e.jsxs("select",{value:T,onChange:s=>{te(s.target.value),g(1)},className:r.input,children:[e.jsx("option",{value:"",children:"All Officers"}),oe.map(s=>e.jsx("option",{value:s.id,children:s.name||s.email},s.id))]})}),e.jsx("div",{className:"min-w-[180px]",children:e.jsxs("select",{value:D,onChange:s=>{ne(s.target.value),g(1)},className:r.input,children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"}),e.jsx("option",{value:"pending_kyc",children:"Pending KYC"}),e.jsx("option",{value:"blacklisted",children:"Blacklisted"})]})}),e.jsxs("div",{className:`hidden md:flex items-center text-sm px-2 ${r.muted}`,children:[e.jsx(we,{className:"w-4 h-4 mr-1"})," Filters"]})]})]})}),e.jsxs("div",{className:`${r.card}`,children:[e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:`${r.table} hidden md:table`,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(b,{label:"Name",sortKey:"name",sort:p,dir:v,onSort:N}),e.jsx(b,{label:"Phone",sortKey:"phone",sort:p,dir:v,onSort:N}),e.jsx(b,{label:"Branch",sortKey:"branchName",sort:p,dir:v,onSort:N}),e.jsx(b,{label:"Officer",sortKey:"officerName",sort:p,dir:v,onSort:N}),e.jsx(b,{label:"Outstanding",sortKey:"outstanding",sort:p,dir:v,onSort:N}),e.jsx(b,{label:"Status",sortKey:"status",sort:p,dir:v,onSort:N}),e.jsx("th",{className:"px-3 py-2 text-right pr-4 font-semibold",children:"Actions"})]})}),e.jsx("tbody",{children:V?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:`px-4 py-10 text-center ${r.muted}`,children:"Loadingâ€¦"})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:`px-4 py-10 text-center ${r.muted}`,children:"No borrowers."})}):t.map(s=>e.jsxs("tr",{className:"border-t border-[var(--border)] hover:bg-[var(--kpi-bg)]",children:[e.jsx("td",{className:r.td,children:H(s)}),e.jsx("td",{className:r.td,children:s.phone||"â€”"}),e.jsx("td",{className:r.td,children:J(s)}),e.jsx("td",{className:r.td,children:pe(s)}),e.jsx("td",{className:r.td,children:X(s.outstanding)}),e.jsx("td",{className:r.td,children:e.jsx("span",{className:W(s.status),children:s.status||"â€”"})}),e.jsx("td",{className:`${r.td} text-right`,children:e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(L,{to:`/borrowers/${encodeURIComponent(s.id)}`,className:_,children:"View"}),e.jsx(L,{to:`/loans/applications?borrowerId=${encodeURIComponent(s.id)}`,className:_,children:"New Loan"})]})})]},s.id))})]}),e.jsx("div",{className:"md:hidden grid grid-cols-1 gap-3 p-3",children:V?e.jsx("div",{className:`p-6 text-center ${r.muted}`,children:"Loadingâ€¦"}):t.length===0?e.jsx("div",{className:`p-6 text-center ${r.muted}`,children:"No borrowers."}):t.map(s=>{const o=H(s);return e.jsxs("div",{className:"rounded-xl border-2 border-[var(--border-strong)] bg-[var(--card)] p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full text-white flex items-center justify-center text-sm font-semibold shadow-sm",style:{background:"linear-gradient(135deg, var(--sb-start), var(--sb-end))"},children:ve(o)}),e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:o}),e.jsxs("div",{className:`text-xs ${r.muted}`,children:["ID: ",s.id]})]})]}),e.jsx("span",{className:W(s.status),children:s.status||"â€”"})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:`w-4 h-4 ${r.muted}`}),e.jsx("span",{children:s.phone||"â€”"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:`w-4 h-4 ${r.muted}`}),e.jsx("span",{className:"truncate",children:J(s)})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:`text-xs ${r.muted}`,children:"Outstanding"}),e.jsx("div",{className:"text-sm font-medium",children:X(s.outstanding)})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-end gap-2",children:[e.jsx(L,{to:`/borrowers/${encodeURIComponent(s.id)}`,className:r.btn,children:"View"}),e.jsx(L,{to:`/loans/applications?borrowerId=${encodeURIComponent(s.id)}`,className:r.primary,children:"New Loan"})]})]},s.id)})})]}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-b-xl border-t",style:{background:"var(--table-foot-bg)",borderColor:"var(--border-strong)"},children:[e.jsxs("div",{className:r.muted,children:[ue,"â€“",he," of ",m]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>g(s=>Math.max(1,s-1)),disabled:f===1,className:`${r.btn} p-2 disabled:opacity-50`,"aria-label":"Previous page",children:e.jsx($e,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>g(s=>s*$<m?s+1:s),disabled:f*$>=m,className:`${r.btn} p-2 disabled:opacity-50`,"aria-label":"Next page",children:e.jsx(Ce,{className:"w-4 h-4"})})]})]})]}),U&&e.jsxs(Ie,{onClose:()=>ce(!1),title:"Borrower Details",children:[e.jsx("div",{className:"flex gap-2 border-b mb-3 border-[var(--border)]",children:["overview","loans","savings","documents"].map(s=>e.jsx("button",{onClick:()=>de(s),className:`px-3 py-2 text-sm border-b-2 -mb-px ${j===s?"border-indigo-600 text-indigo-600 font-semibold":"border-transparent text-[var(--muted)]"} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]`,children:s[0].toUpperCase()+s.slice(1)},s))}),e.jsx("div",{children:me?e.jsx("div",{className:`${r.muted} text-sm`,children:"Loadingâ€¦"}):j==="overview"?e.jsx(Le,{data:A.overview}):j==="loans"?e.jsx(Be,{items:A.loans}):j==="savings"?e.jsx(Te,{items:A.savings}):e.jsx(De,{items:A.documents})})]})]})},b=({label:a,sortKey:t,sort:u,dir:m,onSort:x})=>{const h=u===t;return e.jsx("th",{className:`${r.th} cursor-pointer select-none`,onClick:()=>x(t),title:"Sort",children:e.jsxs("span",{className:`inline-flex items-center gap-1 ${h?"text-indigo-700 font-semibold":""}`,children:[a,h?m==="asc"?"â–²":"â–¼":""]})})},Ie=({title:a,onClose:t,children:u})=>e.jsxs("div",{className:"fixed inset-0 z-[60]",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:t}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full sm:w-[620px] shadow-2xl p-4 overflow-y-auto rounded-l-2xl border-l-2",style:{background:"var(--card)",color:"var(--fg)",borderColor:"var(--border-strong)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:a}),e.jsx("button",{onClick:t,className:"p-1 rounded hover:bg-[var(--kpi-bg)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]","aria-label":"Close drawer",children:e.jsx(Ae,{className:"w-5 h-5"})})]}),u]})]}),Le=({data:a})=>{var x,h,C,S;if(!a)return e.jsx("p",{className:`${r.muted} text-sm`,children:"No overview data."});const t=a.name||`${a.firstName||""} ${a.lastName||""}`.trim()||"â€”",u=a.branchName||((x=a.Branch)==null?void 0:x.name)||((h=a.branch)==null?void 0:h.name)||"â€”",m=a.officerName||((C=a.officer)==null?void 0:C.name)||((S=a.loanOfficer)==null?void 0:S.name)||"â€”";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsx(w,{label:"Full Name",value:t}),e.jsx(w,{label:"Phone",value:a.phone||"â€”"}),e.jsx(w,{label:"Branch",value:u}),e.jsx(w,{label:"Loan Officer",value:m}),e.jsx(w,{label:"Status",value:a.status||"â€”"}),e.jsx(w,{label:"National ID",value:a.nationalId||"â€”"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsx(K,{label:"Outstanding Loan",value:F("outstandingLoan",a)}),e.jsx(K,{label:"Outstanding Interest",value:F("outstandingInterest",a)}),e.jsx(K,{label:"Net Savings",value:F("netSavings",a)})]})]})},F=(a,t)=>`TZS ${Number((t==null?void 0:t[a])||0).toLocaleString()}`,Be=({items:a})=>!Array.isArray(a)||a.length===0?e.jsx("p",{className:`${r.muted} text-sm`,children:"No loans."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:r.th,children:"Loan #"}),e.jsx("th",{className:r.th,children:"Product"}),e.jsx("th",{className:r.th,children:"Disbursed"}),e.jsx("th",{className:r.th,children:"Outstanding"}),e.jsx("th",{className:r.th,children:"Status"})]})}),e.jsx("tbody",{children:a.map(t=>e.jsxs("tr",{className:"border-t border-[var(--border)]",children:[e.jsx("td",{className:r.td,children:t.id}),e.jsx("td",{className:r.td,children:t.product||"â€”"}),e.jsx("td",{className:r.td,children:`TZS ${Number(t.disbursed||0).toLocaleString()}`}),e.jsx("td",{className:r.td,children:`TZS ${Number(t.outstanding||0).toLocaleString()}`}),e.jsx("td",{className:r.td,children:t.status||"â€”"})]},t.id))})]})}),Te=({items:a})=>!Array.isArray(a)||a.length===0?e.jsx("p",{className:`${r.muted} text-sm`,children:"No savings accounts."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:r.th,children:"Account #"}),e.jsx("th",{className:r.th,children:"Balance"}),e.jsx("th",{className:r.th,children:"Status"})]})}),e.jsx("tbody",{children:a.map(t=>e.jsxs("tr",{className:"border-t border-[var(--border)]",children:[e.jsx("td",{className:r.td,children:t.id}),e.jsx("td",{className:r.td,children:`TZS ${Number(t.balance||0).toLocaleString()}`}),e.jsx("td",{className:r.td,children:t.status||"â€”"})]},t.id))})]})}),De=({items:a})=>e.jsxs("div",{children:[e.jsx("div",{className:"mb-3",children:e.jsxs("button",{onClick:()=>alert("KYC upload coming soon"),className:r.btn,children:[e.jsx(ke,{className:"w-4 h-4"})," Upload Document"]})}),!Array.isArray(a)||a.length===0?e.jsx("p",{className:`${r.muted} text-sm`,children:"No documents."}):e.jsx("ul",{className:"space-y-2",children:a.map(t=>e.jsxs("li",{className:"flex items-center justify-between border-2 border-[var(--border-strong)] rounded-md px-3 py-2 bg-[var(--card)]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:`w-4 h-4 ${r.muted}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:t.fileName||t.name||"Document"}),e.jsxs("p",{className:`text-xs ${r.muted}`,children:[t.type||"KYC",t.createdAt?` â€¢ ${new Date(t.createdAt).toLocaleString()}`:""]})]})]}),t.url&&e.jsx("a",{className:_,href:t.url,target:"_blank",rel:"noreferrer",children:"Open"})]},t.id))})]}),w=({label:a,value:t})=>e.jsxs("div",{className:"border-2 border-[var(--border-strong)] rounded-lg p-3 bg-[var(--card)]",children:[e.jsx("p",{className:`text-xs ${r.muted}`,children:a}),e.jsx("p",{className:"text-base font-semibold mt-1",children:t})]}),K=({label:a,value:t})=>e.jsxs("div",{className:"rounded-2xl p-4 border-2 border-[var(--border-strong)] bg-[var(--card)] shadow-sm",children:[e.jsx("p",{className:`text-xs ${r.muted}`,children:a}),e.jsx("p",{className:"text-xl font-semibold mt-1",children:t})]});export{Ve as default};

import{r as n,g as Z,j as s}from"./index-DUtn1vUj.js";const X=new Intl.NumberFormat,Y=c=>c?new Date(c).toLocaleString():"—",N=c=>Z.getFirst(c),y=(c,o)=>Z.postFirst(c,o),Be=`@£$¥èéùìòÇ
Øø\rÅåΔ_ΦΓΛΩΠΨΣΘΞ\x1BÆæßÉ !"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ\`¿abcdefghijklmnopqrstuvwxyzäöñü^{}\\[~]|€`,Me=(c="")=>[...String(c)].some(o=>!Be.includes(o));function $(c){const o=Me(c),x=String(c||"").length;if(x===0)return{uni:o,segs:0,per:o?70:160,left:o?70:160};if(!o){if(x<=160)return{uni:o,segs:1,per:160,left:160-x};const w=Math.ceil(x/153),m=x%153;return{uni:o,segs:w,per:153,left:m===0?0:153-m}}if(x<=70)return{uni:o,segs:1,per:70,left:70-x};const d=Math.ceil(x/67),h=x%67;return{uni:o,segs:d,per:67,left:h===0?0:67-h}}const Fe=(c,o={})=>String(c||"").replace(/\{\{(\w+)\}\}/g,(x,d)=>d in o?String(o[d]):"");function $e(){const[c,o]=n.useState(!1),[x,d]=n.useState(""),[h,w]=n.useState({allowBodySender:!0,defaultSender:""}),[m,R]=n.useState(null),[O,V]=n.useState([]),ee=["Single","Borrowers","Segments/Groups","CSV Upload"],[j,se]=n.useState(0),[P,te]=n.useState(""),[k,G]=n.useState(""),[A,ae]=n.useState(""),[E,ne]=n.useState(""),[H,L]=n.useState([]),[S,Q]=n.useState([]),[C,re]=n.useState("Hello {{name}}, …"),[_,oe]=n.useState(""),[U,le]=n.useState(""),[q,ie]=n.useState(!0),[D,ce]=n.useState(!1),[B,de]=n.useState("Dear {{name}}, …"),[M,me]=n.useState(""),[z,J]=n.useState(null),[F,ue]=n.useState("Hello {{name}}, …"),[K,xe]=n.useState("");async function he(){try{const e=await N(["/sms/capabilities","/communications/sms/capabilities","/notifications/sms/capabilities"]);w(e||{allowBodySender:!0,defaultSender:""})}catch{w({allowBodySender:!0,defaultSender:""})}}async function W(){d("");try{const e=await N(["/sms/balance","/billing/sms/balance","/notifications/sms/balance"]);R(e||null)}catch{R(null)}}async function b(){try{const e=await N(["/sms/messages","/notifications/sms/messages","/communications/sms"]),t=Array.isArray(e)?e:e.items||e.messages||[];V(t.slice(0,100))}catch{V([])}}n.useEffect(()=>{he(),W(),b()},[]),n.useEffect(()=>{const e=setTimeout(async()=>{const t=E.trim();if(!t){L([]);return}try{const r=await N([`/sms/recipients/borrowers?q=${encodeURIComponent(t)}&limit=20`,`/borrowers/search?q=${encodeURIComponent(t)}&limit=20`,`/borrowers?search=${encodeURIComponent(t)}&limit=20`])||{},g=(r.items||r.results||r.rows||[]).map(a=>({id:a.id??a.borrowerId??a._id??`${a.phone||a.msisdn}-${a.id||""}`,name:a.name||[a.firstName,a.lastName].filter(Boolean).join(" ")||a.fullName||"—",phone:a.phone||a.msisdn||a.mobile||a.phoneNumber||"",branchId:a.branchId??null}));L(g.filter(a=>a.phone))}catch{L([])}},300);return()=>clearTimeout(e)},[E]);const ge=n.useMemo(()=>{if(!m)return"—";if(m.error==="Unauthorized"||m.status===401)return"Sign in again";if(m.ok===!1)return m.error||"N/A";const e=m.creditsRounded??m.credits??(()=>{const i=m.raw||"",g=String(i).split(","),a=Number(g[1]);return Number.isFinite(a)?a:null})();if(e==null)return"Unknown";const t=m.estSegmentsLeft!=null?`  (~${X.format(Math.floor(m.estSegmentsLeft))} SMS)`:"",r=m.unit||"credits";return`${X.format(Number(e.toFixed?e.toFixed(2):e))} ${r}${t}`},[m]),pe=n.useMemo(()=>$(k),[k]),fe=n.useMemo(()=>$(C),[C]),ve=n.useMemo(()=>$(B),[B]),Se=n.useMemo(()=>$(F),[F]);async function be(){const e=P.trim(),t=k.trim();if(!e||!t)return d("Phone and message are required.");o(!0),d("");try{const r={to:e,message:t,text:t,senderId:h.allowBodySender&&A||void 0,from:h.allowBodySender&&A||void 0},i=await y(["/sms/send","/communications/sms/send","/notifications/sms"],r);if(i&&i.ok===!1)throw new Error(i.error||"Send failed");G(""),await b()}catch(r){d((r==null?void 0:r.message)||"Failed to send SMS.")}finally{o(!1)}}async function ye(){if(!S.length)return d("Pick at least one borrower.");const e=C.trim();if(!e)return d("Message is required.");o(!0),d("");try{const t=h.allowBodySender&&_||void 0,r=S.map(g=>{const a=g.name||"",[u,...l]=a.split(" "),v=l.join(" "),f={name:a,firstName:u,lastName:v};return{to:g.phone,vars:f,from:t}}),i=await y(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:r,template:e,defaultFrom:t});if(!i||i.ok===!1)for(const g of r){const a={to:g.to,message:Fe(e,g.vars||{}),from:t,senderId:t};await y(["/sms/send","/communications/sms/send","/notifications/sms"],a)}Q([]),await b()}catch(t){d((t==null?void 0:t.message)||"Bulk send failed.")}finally{o(!1)}}async function je(){const e=B.trim();if(!e)return d("Template is required.");o(!0),d("");try{try{const u=await y(["/sms/to-segment"],{filter:{branchId:U||void 0,hasActiveLoan:!!q,overdueOnly:!!D},template:e,from:h.allowBodySender&&M||void 0});if(u&&u.ok){await b(),o(!1);return}}catch{}const t=new URLSearchParams({branchId:U||"",active:String(!!q),overdueOnly:String(!!D),limit:"500"}).toString(),r=await N([`/sms/recipients/borrowers?${t}`,`/borrowers/search?${t}`,`/borrowers?${t}`])||{},a=(r.items||r.results||r.rows||[]||[]).map(u=>({name:u.name||[u.firstName,u.lastName].filter(Boolean).join(" "),phone:u.phone||u.msisdn||u.mobile})).filter(u=>u.phone).map(u=>{const l=u.name||"",[v,...f]=l.split(" "),p=f.join(" ");return{to:u.phone,vars:{name:l,firstName:v,lastName:p},from:h.allowBodySender&&M||void 0}});if(!a.length)throw new Error("No recipients matched the selected filters.");await y(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:a,template:e,defaultFrom:h.allowBodySender&&M||void 0}),await b()}catch(t){d((t==null?void 0:t.message)||"Segment send failed.")}finally{o(!1)}}async function Ne(){if(!z)return d("Choose a CSV first.");o(!0),d("");try{const t=(await z.text()).split(/\r?\n/).filter(l=>l.trim().length);if(t.length===0)throw new Error("Empty CSV.");const r=t[0].split(",").map(l=>l.trim().replace(/^"|"$/g,"")),i=(l,v)=>{const f=r.findIndex(p=>p.toLowerCase()===v.toLowerCase());return f<0?"":(l[f]||"").replace(/^"|"$/g,"").trim()},g=t.slice(1).map(l=>l.split(",")),a=h.allowBodySender&&K||void 0,u=g.map(l=>{const v=i(l,"phone")||i(l,"msisdn")||i(l,"number"),f=i(l,"message"),p=i(l,"name"),ke=i(l,"firstName")||(p?p.split(" ")[0]:""),Ce=i(l,"lastName")||(p?p.split(" ").slice(1).join(" "):"");return{to:v,message:f||void 0,vars:{name:p,firstName:ke,lastName:Ce},from:a}}).filter(l=>l.to);if(!u.length)throw new Error("No valid rows (need a 'phone' column).");await y(["/sms/bulk","/communications/sms/bulk","/notifications/sms/bulk"],{messages:u,template:F||void 0,defaultFrom:a}),J(null),await b()}catch(e){d((e==null?void 0:e.message)||"CSV upload failed.")}finally{o(!1)}}function we(){return s.jsx("div",{className:"rounded-2xl border p-4 shadow-sm bg-white",children:s.jsxs("div",{className:"flex items-center justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"text-sm text-gray-500",children:"Balance"}),s.jsx("div",{className:"text-2xl font-semibold",children:ge}),(m==null?void 0:m.checkedAt)&&s.jsxs("div",{className:"text-xs text-gray-400",children:["Checked ",Y(m.checkedAt)]})]}),s.jsx("button",{onClick:W,className:"px-3 py-2 rounded-xl border hover:bg-gray-50",children:"Refresh"})]})})}const I=({value:e,onChange:t,placeholder:r})=>h.allowBodySender?s.jsx("input",{className:"rounded-xl border p-2",placeholder:r,value:e,onChange:t}):s.jsxs("div",{className:"text-xs text-gray-500",children:["Sender: ",s.jsx("span",{className:"font-medium",children:h.defaultSender||"System"})," (locked)"]}),T=({meta:e})=>s.jsxs("div",{className:"text-xs text-gray-500",children:[e.uni?"Unicode":"GSM-7"," • ",e.segs," segment",e.segs===1?"":"s"," • ",e.left," chars left"]});return s.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 p-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"SMS Console"}),s.jsx(we,{}),s.jsxs("div",{className:"rounded-2xl border bg-white",children:[s.jsx("div",{className:"grid grid-cols-4 text-sm font-medium border-b",children:ee.map((e,t)=>s.jsx("button",{className:`px-4 py-3 text-left ${t===j?"bg-gray-50 border-b-2 border-black":""}`,onClick:()=>se(t),children:e},e))}),j===0&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"w-full rounded-xl border p-2",placeholder:"Phone number (e.g. 0784…, +255…)",value:P,onChange:e=>te(e.target.value)}),s.jsx(I,{value:A,onChange:e=>ae(e.target.value),placeholder:"Sender ID (optional)"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Message text",value:k,onChange:e=>G(e.target.value)}),s.jsx(T,{meta:pe})]}),s.jsx("button",{disabled:c,onClick:be,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:c?"Sending…":"Send"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Tip: GSM-7 texts are cheaper—avoid emojis to keep it single-segment."})]}),j===1&&s.jsxs("div",{className:"p-4 space-y-4",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Search borrowers by name or phone…",value:E,onChange:e=>ne(e.target.value)}),s.jsx(I,{value:_,onChange:e=>oe(e.target.value),placeholder:"Sender ID (optional)"})]}),H.length>0&&s.jsx("div",{className:"max-h-52 overflow-auto border rounded-xl",children:H.map(e=>{const t=S.some(r=>r.id===e.id);return s.jsxs("label",{className:"flex items-center gap-2 p-2 border-b",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:()=>Q(r=>t?r.filter(i=>i.id!==e.id):[...r,e])}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:e.name}),s.jsx("div",{className:"text-xs text-gray-500",children:e.phone})]})]},e.id)})}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Hello {{name}}, your loan is due…",value:C,onChange:e=>re(e.target.value)}),s.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[s.jsxs("span",{children:["Variables: ","{{name}}"," ","{{firstName}}"," ","{{lastName}}"]}),s.jsx(T,{meta:fe})]})]}),s.jsxs("button",{disabled:c||S.length===0,onClick:ye,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:["Send to ",S.length," borrower",S.length===1?"":"s"]})]}),j===2&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-4 gap-3",children:[s.jsx("input",{className:"rounded-xl border p-2",placeholder:"Branch ID (optional)",value:U,onChange:e=>le(e.target.value)}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:q,onChange:e=>ie(e.target.checked)}),"Active loans"]}),s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:D,onChange:e=>ce(e.target.checked)}),"Overdue only"]}),s.jsx(I,{value:M,onChange:e=>me(e.target.value),placeholder:"Sender ID (optional)"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-28",placeholder:"Template e.g. Dear {{name}}, …",value:B,onChange:e=>de(e.target.value)}),s.jsx(T,{meta:ve})]}),s.jsx("button",{disabled:c,onClick:je,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Send to segment"}),s.jsxs("div",{className:"text-xs text-gray-500",children:["If your server doesn’t expose ",s.jsx("code",{children:"/sms/to-segment"}),", this will fetch borrowers client-side then send in bulk."]})]}),j===3&&s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 items-center",children:[s.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var t;return J(((t=e.target.files)==null?void 0:t[0])||null)}}),s.jsx(I,{value:K,onChange:e=>xe(e.target.value),placeholder:"Sender ID (optional)"})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("textarea",{className:"w-full rounded-xl border p-2 h-24",placeholder:"Optional template (uses CSV column names: e.g. Hello {{name}})",value:F,onChange:e=>ue(e.target.value)}),s.jsx(T,{meta:Se})]}),s.jsxs("div",{className:"text-xs text-gray-500",children:["CSV columns: ",s.jsx("code",{children:"phone"}),", ",s.jsx("code",{children:"message"})," (optional),"," ",s.jsx("code",{children:"name"}),", ",s.jsx("code",{children:"firstName"}),", ",s.jsx("code",{children:"lastName"}),"…"]}),s.jsx("button",{disabled:c,onClick:Ne,className:"px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50",children:"Upload & Send"})]})]}),x?s.jsx("div",{className:"rounded-xl border border-rose-200 bg-rose-50 text-rose-700 p-3 text-sm",children:x}):null,s.jsxs("div",{className:"rounded-2xl border bg-white p-4",children:[s.jsx("div",{className:"text-sm font-medium mb-2",children:"Recent Messages"}),O.length===0?s.jsx("div",{className:"text-gray-500 text-sm",children:"No messages yet."}):s.jsx("div",{className:"divide-y",children:O.map((e,t)=>s.jsxs("div",{className:"py-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("div",{className:"font-medium",children:e.to||e.phone||e.msisdn}),s.jsx("div",{className:`text-xs ${(e.status||"").includes("fail")?"text-rose-600":(e.status||"").includes("queued")?"text-emerald-600":"text-gray-500"}`,children:e.status||e.deliveryStatus||"—"})]}),s.jsx("div",{className:"text-gray-600",children:e.message||e.text||e.body||""}),s.jsx("div",{className:"text-xs text-gray-400",children:Y(e.at||e.createdAt||e.sentAt||e.timestamp)})]},e.id||e.messageId||t))})]})]})}export{$e as default};

import{r as n,b as C,j as s,E as te,G as se,F as re}from"./index-BM4plt0o.js";const j=e=>String(e||"").replace(/[_\-]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,o=>o.toUpperCase()),q=e=>`TZS ${Number(e||0).toLocaleString()}`,ae=e=>typeof e=="number"?`${(e>1?e:e*100).toFixed(2)}%`:String(e??""),Q=e=>Object.prototype.toString.call(e)==="[object Object]";function I(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function le(e){if(!e||!e.length)return"";const o=Array.from(e.reduce((c,i)=>(Object.keys(i||{}).forEach(d=>c.add(d)),c),new Set)),a=c=>{const i=I(c);return/[,"\n]/.test(i)?`"${i.replace(/"/g,'""')}"`:i};return[o.join(","),...e.map(c=>o.map(i=>a(c[i])).join(","))].join(`
`)}function oe(e){var a;const o=(e==null?void 0:e.columns)||((a=e==null?void 0:e.table)==null?void 0:a.columns);return o&&Array.isArray(o)?o.map(c=>typeof c=="string"?{key:c,label:j(c)}:c):null}function ne(e,o){var d;let a=[],c=Q(e)?e:{},i=oe(e)||(Array.isArray(o)?o.slice():[]);return Array.isArray((d=e==null?void 0:e.table)==null?void 0:d.rows)?a=e.table.rows:Array.isArray(e==null?void 0:e.rows)?a=e.rows:Array.isArray(e==null?void 0:e.items)?a=e.items:Array.isArray(e==null?void 0:e.buckets)?a=e.buckets:e&&typeof e=="object"&&(a=Object.entries(e).filter(([u])=>!["rows","items","buckets","table","columns"].includes(u)).map(([u,b])=>({metric:j(u),value:b})),i.length||(i=[{key:"metric",label:"Metric"},{key:"value",label:"Value",fmt:u=>typeof u=="number"?q(u):I(u)}])),!i.length&&(a!=null&&a.length)&&Q(a[0])&&(i=Object.keys(a[0]).slice(0,12).map(u=>({key:u,label:j(u)}))),{rows:Array.isArray(a)?a:[],columns:i,meta:c}}function ce(e,o){if(o!=null&&o.scope&&String(o.scope).trim())return String(o.scope);const a=[];if(a.push(e.branchId?`Branch #${e.branchId}`:"All branches"),a.push(e.officerId?`Officer #${e.officerId}`:"All officers"),a.push(e.borrowerId?`Borrower #${e.borrowerId}`:"All borrowers"),e.startDate||e.endDate){const c=e.startDate||"…",i=e.endDate||"…";a.push(`${c} → ${i}`)}else a.push("All time");return a.join(" · ")}function de({title:e="Report",endpoint:o,columns:a=[],exportCsvPath:c="",mode:i="auto",filters:d={date:!0,branch:!0,officer:!0,borrower:!0},extraParams:p={},onAfterLoad:u}){const[b,D]=n.useState(!1),[E,B]=n.useState(""),[R,F]=n.useState(null),G=new Date().toISOString().slice(0,10),[f,L]=n.useState(""),[m,M]=n.useState(""),[v,T]=n.useState(""),[k,V]=n.useState(""),[_,z]=n.useState(""),[g,N]=n.useState(""),[J,H]=n.useState([]),[U,K]=n.useState([]),[Z,S]=n.useState([]),y=n.useRef(!0);n.useEffect(()=>()=>{y.current=!1},[]),n.useEffect(()=>{(async()=>{try{const{data:t}=await C.get("/reports/filters");H((t==null?void 0:t.branches)||[]),K((t==null?void 0:t.officers)||[])}catch{}})()},[]),n.useEffect(()=>{const t=g.trim();if(!t){S([]);return}const x=setTimeout(async()=>{try{const{data:l}=await C.get("/borrowers/search",{params:{q:t}});S(Array.isArray(l)?l.slice(0,8):[])}catch{S([])}},250);return()=>clearTimeout(x)},[g]);const w=n.useMemo(()=>({...p,startDate:d.date&&f||void 0,endDate:d.date&&m||void 0,branchId:d.branch&&v||void 0,officerId:d.officer&&k||void 0,borrowerId:d.borrower&&_||void 0}),[p,f,m,v,k,_,d]),A=async()=>{var t,x;if(o){D(!0),B("");try{const{data:l}=await C.get(o,{params:w});if(!y.current)return;F(l),typeof u=="function"&&u(l)}catch(l){if(!y.current)return;console.error("Report load error:",l),B(((x=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:x.error)||(l==null?void 0:l.message)||"Failed to load report"),F({table:{rows:[]}})}finally{y.current&&D(!1)}}};n.useEffect(()=>{A()},[o]);const{rows:$,columns:P,meta:r}=n.useMemo(()=>ne(R,a),[R,a]),W=n.useMemo(()=>ce(w,r),[w,r]),X=()=>{if(c){const O=`https://mkoposuite-backend-42w2.onrender.com/api${c}`;window.open(O,"_blank","noopener,noreferrer");return}const t=le($),x=new Blob([t],{type:"text/csv"}),l=document.createElement("a");l.href=URL.createObjectURL(x),l.download=`${e.replace(/\s+/g,"_").toLowerCase()}_${new Date().toISOString().slice(0,10)}.csv`,l.click()},Y=()=>{L(""),M(""),T(""),V(""),z(""),N("")};return s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-bold",children:e}),s.jsx("div",{className:"text-[12px] text-slate-500",children:W}),(r==null?void 0:r.welcome)&&s.jsx("div",{className:"text-[12px] text-emerald-700 dark:text-emerald-400 mt-1",children:r.welcome}),((r==null?void 0:r.asOf)||(r==null?void 0:r.period))&&s.jsxs("div",{className:"text-[12px] text-slate-500 mt-1",children:[r!=null&&r.asOf?`As Of: ${String(r.asOf).slice(0,10)}`:"",r!=null&&r.asOf&&(r!=null&&r.period)?" · ":"",r!=null&&r.period?`Period: ${r.period}`:""]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:A,className:"inline-flex items-center gap-2 h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",title:"Refresh",children:[s.jsx(te,{className:b?"animate-spin":""}),"Refresh"]}),s.jsxs("button",{onClick:X,className:"inline-flex items-center gap-2 h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export CSV",children:[s.jsx(se,{})," Export"]})]})]})}),i!=="snapshot"&&s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3",children:[d.date&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Start"}),s.jsx("input",{type:"date",value:f,onChange:t=>L(t.target.value),max:m||new Date().toISOString().slice(0,10),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"End"}),s.jsx("input",{type:"date",value:m,onChange:t=>M(t.target.value),min:f||"",max:G,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]})]}),d.branch&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Branch"}),s.jsxs("select",{value:v,onChange:t=>T(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),J.map(t=>s.jsx("option",{value:t.id,children:t.name||`#${t.id}`},t.id))]})]}),d.officer&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Officer"}),s.jsxs("select",{value:k,onChange:t=>V(t.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[s.jsx("option",{value:"",children:"All"}),(Array.isArray(U)?U:[]).map(t=>s.jsx("option",{value:t.id,children:t.name||t.email||`#${t.id}`},t.id))]})]}),d.borrower&&s.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[s.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Borrower"}),s.jsxs("div",{className:"relative flex-1",children:[s.jsx(re,{className:"absolute left-3 top-3 text-slate-400"}),s.jsx("input",{value:g,onChange:t=>N(t.target.value),placeholder:"Type to search borrowers…",className:"w-full pl-9 pr-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"}),g&&Z.length>0&&s.jsx("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-slate-900 border rounded shadow max-h-56 overflow-auto",children:Z.map(t=>s.jsxs("button",{type:"button",onClick:()=>{z(String(t.id)),N(t.name||t.phone||t.email||`Borrower #${t.id}`)},className:"w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800",children:[t.name||`Borrower #${t.id}`," ",s.jsx("span",{className:"opacity-60",children:t.phone||t.email||""})]},t.id))})]}),s.jsx("button",{onClick:()=>A(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),s.jsx("button",{onClick:Y,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]})}),s.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:E?s.jsx("div",{className:"text-red-600 text-sm",children:E}):b?s.jsx("div",{className:"text-slate-500 text-sm",children:"Loading…"}):$.length===0?s.jsx("div",{className:"text-slate-500 text-sm",children:"No data."}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200",children:s.jsx("tr",{children:P.map(t=>s.jsx("th",{className:"px-3 py-2 text-left font-semibold",children:t.label||j(t.key)},t.key))})}),s.jsx("tbody",{children:$.map((t,x)=>s.jsx("tr",{className:"border-t border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/40",children:P.map(l=>s.jsx("td",{className:"px-3 py-2",children:(()=>{const h=t==null?void 0:t[l.key],O=(t==null?void 0:t.currency)&&(l.key==="value"||/amount|total|balance|olp/i.test(l.key)),ee=(t==null?void 0:t.percent)&&(l.key==="value"||/par|ratio|yield|efficiency|achievement/i.test(l.key));return l.fmt?l.fmt(h,t):ee?ae(Number(h||0)):O&&typeof h=="number"?q(h):I(h)})()},l.key))},x))})]})})}),((r==null?void 0:r.period)||(r==null?void 0:r.scope))&&s.jsxs("div",{className:"text-[12px] text-slate-500",children:[r!=null&&r.period?`Period: ${r.period}`:""," ",r!=null&&r.scope?`· Scope: ${r.scope}`:""]})]})}export{de as R};

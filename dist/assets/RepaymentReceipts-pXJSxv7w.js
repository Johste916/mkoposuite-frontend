import{r as n,j as e,g as w}from"./index-DSXeOGvG.js";import{E as ne}from"./jspdf.es.min-DH1vcNv6.js";import ce from"./html2canvas.esm-CBrSDip1.js";const m={posted:"repayment:posted",approved:"repayment:approved",rejected:"repayment:rejected",bulk:"repayment:bulk-posted"},d=r=>Number(r||0).toLocaleString(),E=r=>new Date(r.getTime()-r.getTimezoneOffset()*6e4).toISOString().slice(0,10),G=()=>{const r=new Date;return r.setDate(r.getDate()-30),E(r)},de=(r,u={})=>{var i,j;try{if(typeof w.getUri=="function")return w.getUri({url:r,params:u})}catch{}const c=((j=(i=w)==null?void 0:i.defaults)==null?void 0:j.baseURL)||"",g=new URLSearchParams(u).toString();return`${c}${r}${g?`?${g}`:""}`};function me(){var I,z,B,U,H;const[r,u]=n.useState(""),[c,g]=n.useState("approved"),[i,j]=n.useState(G()),[h,A]=n.useState(E(new Date)),[$,F]=n.useState([]),[C,M]=n.useState(0),[N,x]=n.useState(1),[b,Y]=n.useState(20),[v,Z]=n.useState(!1),[Q,R]=n.useState(!1),[t,J]=n.useState(null),P=n.useRef(null),T=n.useMemo(()=>Math.max(1,Math.ceil(Number(C||0)/Number(b||1))),[C,b]),f=async()=>{Z(!0);try{const s={page:N,pageSize:b};r.trim()&&(s.q=r.trim()),i&&(s.dateFrom=i),h&&(s.dateTo=h),c&&c!=="all"&&(s.status=c);const{data:a}=await w.get("/repayments",{params:s});let l=Array.isArray(a)?a:(a==null?void 0:a.items)||[];c&&c!=="all"&&(l=l.filter(y=>String(y.status||"").toLowerCase()===c)),F(l),M(Number((a==null?void 0:a.total)||l.length||0))}catch(s){console.error(s),F([]),M(0),alert("Failed to load receipts")}finally{Z(!1)}};n.useEffect(()=>{f()},[N,b,i,h,c]),n.useEffect(()=>{const s=()=>f();return window.addEventListener(m.posted,s),window.addEventListener(m.approved,s),window.addEventListener(m.rejected,s),window.addEventListener(m.bulk,s),()=>{window.removeEventListener(m.posted,s),window.removeEventListener(m.approved,s),window.removeEventListener(m.rejected,s),window.removeEventListener(m.bulk,s)}},[]);const K=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),x(1),f()},X=async s=>{try{const{data:a}=await w.get(`/repayments/${s.id}`);J(a||null),R(!0)}catch(a){console.error(a),alert("Failed to load receipt")}},ee=n.useMemo(()=>de("/repayments/export",{q:r||void 0,dateFrom:i||void 0,dateTo:h||void 0,status:c!=="all"?c:void 0}),[r,i,h,c]),se=async()=>{if(!P.current)return;const s=P.current,a=s.style.backgroundColor;s.style.backgroundColor="#ffffff";const l=await ce(s,{scale:2,backgroundColor:"#ffffff",useCORS:!0,windowWidth:s.scrollWidth,windowHeight:s.scrollHeight});s.style.backgroundColor=a||"";const y=l.toDataURL("image/png"),o=new ne("p","mm","a4"),O=o.internal.pageSize.getWidth(),S=o.internal.pageSize.getHeight(),k=O,V=l.height*k/l.width;if(V<=S)o.addImage(y,"PNG",0,0,k,V);else{const L=l.width*S/O,p=document.createElement("canvas"),W=p.getContext("2d");p.width=l.width,p.height=L;let D=0,q=!0;for(;D<l.height;){W.clearRect(0,0,p.width,p.height),W.drawImage(l,0,D,l.width,L,0,0,p.width,p.height);const _=p.toDataURL("image/png");q?(o.addImage(_,"PNG",0,0,k,S),q=!1):(o.addPage(),o.addImage(_,"PNG",0,0,k,S)),D+=L}}const le=`receipt_${(t==null?void 0:t.receiptNo)||(t==null?void 0:t.id)}.pdf`;o.save(le)},te=async()=>{if(!(t!=null&&t.id))return;const s=`${window.location.origin}/repayments/receipts?id=${t.id}`;try{await navigator.clipboard.writeText(s),alert("Receipt link copied")}catch{alert(s)}},ae=s=>(s.date||s.paymentDate||s.paidAt||s.createdAt||"").slice(0,10),re=s=>Number(s.amount??s.amountPaid??0);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Receipts"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"View, print or export receipts. Export respects your current filters."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:f,disabled:v,className:"px-3 py-2 rounded border",children:v?"Refreshing…":"Refresh"}),e.jsx("a",{href:ee,target:"_blank",rel:"noreferrer",className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export filtered receipts as CSV",children:"Export CSV"})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-5",children:e.jsxs("form",{onSubmit:K,className:"grid md:grid-cols-7 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm mb-1",children:"Search"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Borrower / Phone / Loan Ref / Method / Receipt",value:r,onChange:s=>u(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Status"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:c,onChange:s=>{g(s.target.value),x(1)},children:[e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"From"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:i,onChange:s=>j(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"To"}),e.jsx("input",{type:"date",className:"w-full border rounded px-3 py-2",value:h,onChange:s=>A(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm mb-1",children:"Page size"}),e.jsx("select",{className:"w-full border rounded px-3 py-2",value:b,onChange:s=>{Y(Number(s.target.value)),x(1)},children:[20,50,100].map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"md:col-span-2 flex items-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border",onClick:()=>{u(""),g("approved"),j(G()),A(E(new Date)),x(1),f()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white",children:"Search"})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg p-0 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 dark:bg-gray-700 text-left",children:[e.jsx("th",{className:"p-3",children:"Receipt No"}),e.jsx("th",{className:"p-3",children:"Date"}),e.jsx("th",{className:"p-3",children:"Loan Ref"}),e.jsx("th",{className:"p-3",children:"Borrower"}),e.jsx("th",{className:"p-3",children:"Method"}),e.jsx("th",{className:"p-3",children:"Amount"}),e.jsx("th",{className:"p-3",children:"Status"}),e.jsx("th",{className:"p-3 text-right",children:"Action"})]})}),e.jsxs("tbody",{children:[!v&&$.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"p-4 text-gray-500",colSpan:8,children:"No data."})}),$.map(s=>{const a=s.Loan||s.loan||{},l=a.Borrower||{},y=s.currency||a.currency||"TZS",o=re(s);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.receiptNo||`RCPT-${s.id}`}),e.jsx("td",{className:"p-3",children:ae(s)}),e.jsx("td",{className:"p-3",children:a.reference||`L-${a.id||s.loanId||""}`}),e.jsx("td",{className:"p-3",children:l.name||l.fullName||"—"}),e.jsx("td",{className:"p-3 capitalize",children:s.method||"cash"}),e.jsxs("td",{className:"p-3",children:[y," ",d(o)]}),e.jsx("td",{className:"p-3",children:(s.status||"").toUpperCase()||"—"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>X(s),children:"View"}),e.jsx("a",{className:"px-3 py-1.5 rounded border",href:`/repayments/receipts?id=${s.id}`,target:"_blank",rel:"noreferrer",children:"Open Page"})]})})]},s.id)}),v&&e.jsx("tr",{children:e.jsx("td",{className:"p-4",colSpan:8,children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 border-t",children:[e.jsxs("p",{className:"text-xs text-gray-500",children:["Page ",N," of ",T," • ",C," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:N<=1,onClick:()=>x(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",disabled:N>=T,onClick:()=>x(s=>Math.min(T,s+1)),children:"Next"})]})]})]}),Q&&t&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>R(!1)}),e.jsxs("div",{ref:P,className:"relative bg-white w-full max-w-2xl rounded-lg shadow-lg p-6 print:bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Receipt #",t.receiptNo||t.id]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:()=>window.print(),children:"Print"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:se,children:"Download PDF"}),e.jsx("button",{className:"px-3 py-1.5 rounded border",onClick:te,children:"Copy Link"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white",onClick:()=>R(!1),children:"Close"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"})," ",(t.date||"").slice(0,10)]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Method:"})," ",t.method||"cash"]}),t.reference&&e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Reference:"})," ",t.reference]}),t.notes&&e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Notes:"})," ",t.notes]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-gray-500",children:"Amount"}),e.jsxs("p",{className:"text-xl font-semibold",children:[t.currency||"TZS"," ",d(t.amount)]})]})]}),e.jsxs("div",{className:"my-4 border-t pt-4 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Loan:"})," ",(I=t.loan)==null?void 0:I.reference]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Borrower:"})," ",(z=t.loan)==null?void 0:z.borrowerName]})]}),!!((B=t==null?void 0:t.allocation)!=null&&B.length)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100 text-left",children:[e.jsx("th",{className:"p-2",children:"Period"}),e.jsx("th",{className:"p-2",children:"Principal"}),e.jsx("th",{className:"p-2",children:"Interest"}),e.jsx("th",{className:"p-2",children:"Fees"}),e.jsx("th",{className:"p-2",children:"Penalties"})]})}),e.jsx("tbody",{children:t.allocation.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.period}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(s.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(s.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(s.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(s.penalties)]})]},a))}),t.totals&&e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t font-medium",children:[e.jsx("td",{className:"p-2",children:"Totals"}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(t.totals.principal)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(t.totals.interest)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(t.totals.fees)]}),e.jsxs("td",{className:"p-2",children:[t.currency||"TZS"," ",d(t.totals.penalties)]})]})})]})})]}),e.jsxs("div",{className:"mt-6 text-xs text-gray-500",children:[e.jsxs("p",{children:["Posted by: ",((U=t.postedBy)==null?void 0:U.name)||"—"," ",(H=t.postedBy)!=null&&H.email?`(${t.postedBy.email})`:""]}),e.jsx("p",{className:"mt-2",children:"This is a system generated receipt."})]})]})]}),e.jsx("style",{children:`
        @media print {
          body { background: white; }
          @page { margin: 12mm; }
        }
      `})]})}export{me as default};

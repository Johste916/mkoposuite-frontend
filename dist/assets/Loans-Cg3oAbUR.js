import{u as W,r as o,j as t,L as X,g as v}from"./index-B1RC7Rfk.js";import{E as Z}from"./jspdf.es.min-C0ldvkcn.js";import"./jspdf.plugin.autotable-CtA5BUKo.js";import{C as ee}from"./index-KNYVoFOH.js";const C=r=>Array.isArray(r)?r:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.rows)?r.rows:Array.isArray(r==null?void 0:r.data)?r.data:[],$=r=>{const c=Number(r);return Number.isFinite(c)?new Intl.NumberFormat(void 0,{maximumFractionDigits:0}).format(c):r??"—"},te=r=>{const c=Number(r);return Number.isFinite(c)?c.toFixed(2):r??"—"},ae=r=>{if(!r)return"—";const c=new Date(r);return Number.isNaN(+c)?String(r).slice(0,10):c.toLocaleDateString()},ce=()=>{const r=W(),[c,L]=o.useState([]),[_,F]=o.useState([]),[N,B]=o.useState([]),[E,P]=o.useState(!1),[w,T]=o.useState(""),[x,z]=o.useState("all"),[g,V]=o.useState(""),[j,H]=o.useState(""),[d,O]=o.useState(""),[u,q]=o.useState(""),I=async()=>{P(!0);try{const e=await v.get("/loans",{params:{page:1,pageSize:500}});L(C(e.data))}catch{alert("Failed to load loans"),L([])}finally{P(!1)}},U=async()=>{try{const e=await v.get("/branches",{params:{page:1,pageSize:500}});F(C(e.data))}catch{F([])}},Y=async()=>{try{const e=await v.get("/loan-products",{params:{page:1,pageSize:500}});B(C(e.data))}catch{B([])}};o.useEffect(()=>{I(),U(),Y()},[]);const y=o.useMemo(()=>Object.fromEntries((N||[]).map(e=>[String(e.id),e])),[N]),G=e=>{const a=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at;if(!a||!d&&!u)return!0;const s=new Date(a);if(d&&s<new Date(d))return!1;if(u){const n=new Date(u);if(n.setHours(23,59,59,999),s>n)return!1}return!0},i=o.useMemo(()=>{const e=w.trim().toLowerCase();return(c||[]).filter(a=>{var p,m,h;const s=(a.status||a.loanStatus||"").toLowerCase(),n=x==="all"||s===x,f=(((p=a.Borrower)==null?void 0:p.name)||a.borrowerName||a.borrower_name||((m=a.borrower)==null?void 0:m.name)||"").toLowerCase().includes(e)||String(a.id||a.loanId||"").toLowerCase().includes(e),S=String(a.branchId||((h=a.branch)==null?void 0:h.id)||a.branch_id||""),D=!g||S===String(g),A=!j||String(a.productId)===String(j);return n&&f&&D&&A&&G(a)})},[c,x,w,g,j,d,u]),l=o.useMemo(()=>{const e=i.reduce((s,n)=>s+Number(n.amount||n.principal||0),0),a=s=>i.filter(n=>(n.status||n.loanStatus||"").toLowerCase()===s).length;return{total:i.length,totalPrincipal:e,pending:a("pending"),approved:a("approved"),disbursed:a("disbursed"),active:a("active"),closed:a("closed"),rejected:a("rejected")}},[i]),k=async(e,a)=>{try{await v.patch(`/loans/${e}/${a}`),I()}catch{alert(`Failed to ${a} loan`)}},M=o.useMemo(()=>i.map(e=>{var a,s,n,b;return{id:e.id,borrower:((a=e.Borrower)==null?void 0:a.name)||e.borrowerName||e.borrower_name||((s=e.borrower)==null?void 0:s.name)||"",product:((n=y[String(e.productId)])==null?void 0:n.name)||"",amount:e.amount??e.principal??"",rate:e.interestRate??e.rate??"",termMonths:e.termMonths??e.durationMonths??e.term_months??"",branch:((b=e.branch)==null?void 0:b.name)||"",status:e.status||e.loanStatus||"",startDate:e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at||""}}),[i,y]),J=[{label:"Loan ID",key:"id"},{label:"Borrower",key:"borrower"},{label:"Product",key:"product"},{label:"Amount",key:"amount"},{label:"Rate (%)",key:"rate"},{label:"Term (months)",key:"termMonths"},{label:"Branch",key:"branch"},{label:"Status",key:"status"},{label:"Start Date",key:"startDate"}],K=()=>{const e=new Z;e.text("Loans Report",14,16),e.autoTable({startY:20,head:[["ID","Borrower","Product","Amount","Rate (%)","Term","Branch","Status"]],body:M.map(a=>[a.id,a.borrower,a.product,a.amount,a.rate,a.termMonths,a.branch,a.status])}),e.save("loans.pdf")},Q=e=>{const a=(e||"").toLowerCase(),s="px-2 py-1 rounded text-xs font-semibold";switch(a){case"pending":return`${s} bg-yellow-100 text-yellow-800`;case"approved":return`${s} bg-emerald-100 text-emerald-800`;case"rejected":return`${s} bg-rose-100 text-rose-800`;case"disbursed":case"active":return`${s} bg-blue-100 text-blue-800`;case"closed":return`${s} bg-gray-100 text-gray-900`;default:return`${s} bg-gray-200 text-gray-900`}};return t.jsxs("div",{className:"p-4 md:p-6 lg:p-8 space-y-6 text-black dark:text-white",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-2xl md:text-3xl font-extrabold tracking-tight",children:"All Loans"}),t.jsx(X,{className:"text-black font-semibold underline",to:"/loans/applications",children:"New Application"})]}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[{label:"Total",value:l.total},{label:"Principal",value:$(l.totalPrincipal)},{label:"Pending",value:l.pending},{label:"Approved",value:l.approved},{label:"Disbursed",value:l.disbursed},{label:"Active",value:l.active}].map((e,a)=>t.jsxs("div",{className:"card p-4 ring-2 ring-black/10 border-2 border-black/20 text-black dark:text-white",children:[t.jsxs("p",{className:"text-xs",children:[" ",e.label," "]}),t.jsx("p",{className:"text-lg font-bold",children:e.value})]},a))}),t.jsxs("div",{className:"card p-4 grid grid-cols-1 md:grid-cols-6 gap-3 ring-2 ring-black/10 border-2 border-black/20 text-black dark:text-white",children:[t.jsx("input",{type:"text",placeholder:"Search borrower or loan ID…",value:w,onChange:e=>T(e.target.value),className:"input md:col-span-2 text-black"}),t.jsxs("select",{value:x,onChange:e=>z(e.target.value),className:"input text-black",children:[t.jsx("option",{value:"all",children:"All Statuses"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"approved",children:"Approved"}),t.jsx("option",{value:"disbursed",children:"Disbursed"}),t.jsx("option",{value:"active",children:"Active"}),t.jsx("option",{value:"rejected",children:"Rejected"}),t.jsx("option",{value:"closed",children:"Closed"})]}),t.jsxs("select",{value:g,onChange:e=>V(e.target.value),className:"input text-black",children:[t.jsx("option",{value:"",children:"All Branches"}),_.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:j,onChange:e=>H(e.target.value),className:"input text-black",children:[t.jsx("option",{value:"",children:"All Products"}),N.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("input",{type:"date",value:d,onChange:e=>O(e.target.value),className:"input text-black"}),t.jsx("input",{type:"date",value:u,onChange:e=>q(e.target.value),className:"input text-black"}),t.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[t.jsx(ee,{data:M,headers:J,filename:"loans.csv",className:"px-4 py-2 rounded bg-black text-white hover:opacity-90",children:"Export CSV"}),t.jsx("button",{onClick:K,className:"px-4 py-2 rounded bg-black text-white hover:opacity-90",children:"Export PDF"})]})]}),t.jsx("div",{className:"card overflow-x-auto ring-2 ring-black/10 border-2 border-black/20",children:E?t.jsx("p",{className:"p-4",children:"Loading loans…"}):i.length===0?t.jsx("p",{className:"p-4",children:"No loans found."}):t.jsxs("table",{className:"min-w-full text-sm border-2 border-black/30",children:[t.jsx("thead",{className:"bg-white text-black",children:t.jsx("tr",{children:["ID","Borrower","Product","Amount","Rate (%)","Term","Branch","Start Date","Status","Actions"].map(e=>t.jsx("th",{className:"p-2 border-2 border-black/30 text-left",children:e},e))})}),t.jsx("tbody",{children:i.map(e=>{var p,m,h,R;const a=e.status||e.loanStatus,s=((p=e.Borrower)==null?void 0:p.name)||e.borrowerName||e.borrower_name||((m=e.borrower)==null?void 0:m.name)||"N/A",n=((h=y[String(e.productId)])==null?void 0:h.name)||"—",b=$(e.amount??e.principal),f=te(e.interestRate??e.rate),S=e.termMonths??e.durationMonths??e.term_months??"—",D=((R=e.branch)==null?void 0:R.name)||"—",A=ae(e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at);return t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:e.id}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:s}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:n}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:b}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:f}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:S}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:D}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:A}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:t.jsx("span",{className:Q(a),children:a})}),t.jsx("td",{className:"px-2 py-2 border-2 border-black/20",children:t.jsxs("div",{className:"space-x-3",children:[t.jsx("button",{onClick:()=>r(`/loans/${e.id}`),className:"text-black underline",children:"View"}),(a||"").toLowerCase()==="pending"&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>k(e.id,"approve"),className:"text-black underline",children:"Approve"}),t.jsx("button",{onClick:()=>k(e.id,"reject"),className:"text-black underline",children:"Reject"})]}),(a||"").toLowerCase()==="approved"&&t.jsx("button",{onClick:()=>k(e.id,"disburse"),className:"text-black underline",children:"Disburse"})]})})]},e.id)})})]})})]})};export{ce as default};

import{r as i,j as e,y as J,h as b}from"./index-DF0UeGdD.js";const n={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-slate-600",card:"rounded-2xl border border-slate-200 bg-white shadow-sm",thBase:"text-left text-[11px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-b border-slate-200 bg-slate-50",td:"px-3 py-2 border-b border-slate-200 text-sm",btn:"inline-flex items-center rounded-lg border border-slate-300 px-3 py-2 hover:bg-slate-50 font-semibold text-slate-800",subtle:"text-xs text-slate-500",stickyCell:"sticky left-0 z-10 bg-white",stickyHead:"sticky left-0 z-20 bg-white",moduleRow:"bg-gradient-to-r from-slate-50 to-white border-y border-slate-200",moduleTitle:"text-[13px] font-bold tracking-wide text-slate-800",moduleBadge:"inline-flex items-center gap-1 rounded-full bg-slate-100 text-slate-700 text-[10px] font-semibold px-2 py-0.5 border border-slate-200",collapseBtn:"inline-flex items-center gap-1 text-[11px] font-medium text-slate-600 hover:text-slate-900",actionLabel:"font-medium text-slate-800",actionKey:"font-mono text-[11px] text-slate-500",chip:"inline-flex items-center rounded-md border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700",roleTh:"text-center align-bottom",roleThInner:"flex flex-col items-center gap-1",densityToggle:"inline-flex items-center rounded-md border border-slate-300 bg-white p-1 text-xs"},y={matrix:"/permissions/matrix",matrixApi:"/api/permissions/matrix",role:d=>`/permissions/role/${d}`,roleApi:d=>`/api/permissions/role/${d}`,saveAll:"/permissions/matrix",saveAllApi:"/api/permissions/matrix"};function K({open:d}){return e.jsx("svg",{"aria-hidden":!0,viewBox:"0 0 20 20",className:`h-4 w-4 transition-transform ${d?"rotate-90":""}`,fill:"currentColor",children:e.jsx("path",{d:"M7 6l6 4-6 4V6z"})})}function Y(){const[d,S]=i.useState(!1),[R,C]=i.useState(!1),[p,L]=i.useState([]),[x,B]=i.useState([]),[j,h]=i.useState({}),[w,E]=i.useState(""),[$,u]=i.useState(""),[F,P]=i.useState(new Set),[z,f]=i.useState(null),[k,A]=i.useState("comfortable"),[T,H]=i.useState(!0),W=!1,N=k==="compact"?"py-1.5":"py-2.5",D=async(s,l)=>{var a;try{return await b.get(s)}catch(t){if(((a=t==null?void 0:t.response)==null?void 0:a.status)===404)return await b.get(l);throw t}},G=async(s,l,a)=>{var t;try{return await b.put(s,a)}catch(o){if(((t=o==null?void 0:o.response)==null?void 0:t.status)===404)return await b.put(l,a);throw o}},M=async()=>{var s,l,a;S(!0),u("");try{const{data:t}=await D(y.matrix,y.matrixApi);L(Array.isArray(t==null?void 0:t.catalog)?t.catalog:[]),B(Array.isArray(t==null?void 0:t.roles)?t.roles:[]),h(typeof(t==null?void 0:t.matrix)=="object"&&(t!=null&&t.matrix)?t.matrix:{})}catch(t){console.error(t);const o=((s=t==null?void 0:t.response)==null?void 0:s.status)===404?"Endpoint not found. Ensure your backend route is GET /api/permissions/matrix (or set api.baseURL='/api').":((a=(l=t==null?void 0:t.response)==null?void 0:l.data)==null?void 0:a.error)||"Failed to load permission matrix";u(o)}finally{S(!1)}};i.useEffect(()=>{M()},[]);const g=i.useMemo(()=>x.map(s=>s.name),[x]),v=i.useMemo(()=>{const s=w.trim().toLowerCase();return s?p.map(l=>({...l,actions:l.actions.filter(a=>a.key.toLowerCase().includes(s)||a.label.toLowerCase().includes(s))})).filter(l=>l.actions.length):p},[p,w]),I=(s,l)=>{h(a=>{const t=new Set(a[s]||[]);return t.has(l)?t.delete(l):t.add(l),{...a,[s]:Array.from(t)}})},U=(s,l,a=v)=>{h(t=>{const o={...t};for(const r of a)for(const c of r.actions){const m=new Set(o[c.key]||[]);l?m.add(s):m.delete(s),o[c.key]=Array.from(m)}return o})},q=(s,l)=>{h(a=>{const t=new Set(a[s]||[]);for(const o of g)l?t.add(o):t.delete(o);return{...a,[s]:Array.from(t)}})},O=(s,l)=>{h(a=>{const t={...a};for(const o of s.actions){const r=new Set(t[o.key]||[]);for(const c of g)l?r.add(c):r.delete(c);t[o.key]=Array.from(r)}return t})},Q=async s=>{var a,t,o;const l=[];for(const r of p)for(const c of r.actions)new Set(j[c.key]||[]).has(s.name)&&l.push(c.key);C(!0),u("");try{await G(y.role(s.id),y.roleApi(s.id),{actions:l,mode:"replace"}),alert(`Saved permissions for role: ${s.name}`)}catch(r){console.error(r);const c=((a=r==null?void 0:r.response)==null?void 0:a.status)===404?"Save endpoint not found. Backend should expose PUT /api/permissions/role/:roleId.":((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.error)||"Failed to save this role";u(c)}finally{C(!1)}},V=s=>{P(l=>{const a=new Set(l);return a.has(s)?a.delete(s):a.add(s),a})};return e.jsxs("div",{className:n.page,children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:n.h1,children:"Permission Matrix"}),e.jsx("div",{className:n.sub,children:"Differentiate modules and actions at a glance. Search, collapse, bulk-toggle, then save."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:n.densityToggle,children:[e.jsx("button",{className:`px-2 py-1 rounded ${k==="comfortable"?"bg-slate-100":""}`,onClick:()=>A("comfortable"),title:"Comfortable density",children:"Comfy"}),e.jsx("button",{className:`px-2 py-1 rounded ${k==="compact"?"bg-slate-100":""}`,onClick:()=>A("compact"),title:"Compact density",children:"Compact"})]}),e.jsxs("label",{className:n.chip,children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:T,onChange:s=>H(s.target.checked)}),"Show action keys"]}),e.jsx("input",{type:"text",value:w,onChange:s=>E(s.target.value),placeholder:"Filter actions…",className:"h-10 w-64 rounded-lg border border-slate-300 bg-white text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600"}),e.jsx("button",{onClick:M,className:n.btn,children:"Refresh"}),W]})]}),$&&e.jsx("div",{className:"mb-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:$}),e.jsx("div",{className:`${n.card} overflow-auto`,children:e.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[e.jsx("thead",{className:"sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:`${n.thBase} ${n.stickyHead}`,style:{minWidth:280},children:"Module / Action"}),x.map(s=>e.jsx("th",{className:`${n.thBase} ${n.roleTh}`,onMouseEnter:()=>f(s.name),onMouseLeave:()=>f(null),children:e.jsxs("div",{className:n.roleThInner,children:[e.jsx("div",{className:"font-bold text-[12px]",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"text-[11px] text-slate-500",children:[e.jsx("input",{type:"checkbox",onChange:l=>U(s.name,l.target.checked)})," ","All"]}),e.jsx("button",{className:"text-[11px] underline",onClick:()=>Q(s),disabled:R,title:"Save only this role",children:"Save"})]})]})},s.id)),e.jsx("th",{className:n.thBase,style:{minWidth:120},children:"Row Tools"})]})}),e.jsx("tbody",{children:d?e.jsx("tr",{children:e.jsx("td",{className:n.td,colSpan:2+x.length,children:"Loading…"})}):v.length===0?e.jsx("tr",{children:e.jsx("td",{className:n.td,colSpan:2+x.length,children:"No actions match your filter."})}):v.map(s=>{const l=F.has(s.group);return e.jsxs(J.Fragment,{children:[e.jsx("tr",{className:n.moduleRow,children:e.jsx("td",{className:`${n.td} ${n.stickyCell}`,colSpan:2+x.length,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:n.moduleBadge,children:"MODULE"}),e.jsxs("button",{className:n.collapseBtn,onClick:()=>V(s.group),children:[e.jsx(K,{open:!l}),e.jsx("span",{className:n.moduleTitle,children:s.group})]})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:n.subtle,children:[e.jsx("input",{type:"checkbox",onChange:a=>O(s,a.target.checked)})," ","All roles in module"]})})]})})}),!l&&s.actions.map((a,t)=>e.jsxs("tr",{className:t%2===0?"bg-white":"bg-slate-50/40",children:[e.jsx("td",{className:`${n.td} ${n.stickyCell} ${N}`,title:a.key,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"mt-1 inline-block h-2 w-2 rounded-full bg-slate-300"}),e.jsxs("div",{children:[e.jsx("div",{className:n.actionLabel,children:a.label}),T&&e.jsx("div",{className:n.actionKey,children:a.key})]})]})}),x.map(o=>{const c=new Set(j[a.key]||[]).has(o.name),m=z===o.name?"bg-indigo-50":"";return e.jsx("td",{className:`${n.td} text-center ${N} ${m}`,onMouseEnter:()=>f(o.name),onMouseLeave:()=>f(null),children:e.jsx("input",{type:"checkbox",checked:c,onChange:()=>I(a.key,o.name)})},`${a.key}:${o.id}`)}),e.jsx("td",{className:`${n.td} text-center ${N}`,children:e.jsxs("label",{className:"text-[11px] text-slate-500",children:[e.jsx("input",{type:"checkbox",onChange:o=>q(a.key,o.target.checked),checked:(j[a.key]||[]).length===g.length&&g.length>0})," ","All roles"]})})]},a.key))]},s.group)})})]})}),e.jsx("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:e.jsx("span",{className:"text-sm text-slate-600",children:"Tip: Collapse modules to focus, hover a column header to preview a role’s column, use density & “show keys” to declutter."})})]})}export{Y as default};

import{r as o,h as c,j as s,L as pe}from"./index-p3hQqlDS.js";const ge=["Africa/Nairobi","Africa/Dar_es_Salaam","Africa/Kampala","Africa/Addis_Ababa","Africa/Kigali","UTC"],xe=["en","sw","fr"],Ie=/^\+?\d{7,15}$/;function ze(){var H,W,q,V,X,Q,ee,se,ae,te,le,ne,re,oe,ie;const[i,f]=o.useState(null),[h,C]=o.useState([]),[t,r]=o.useState({displayName:"",name:"",phone:"",branchId:"",timezone:"Africa/Nairobi",locale:"en",title:"",department:"",employeeCode:""}),[y,k]=o.useState(null),[d,j]=o.useState({landingPage:"/dashboard",defaultCurrency:"TZS",dateFormat:"DD/MM/YYYY",numberFormat:"1,234.56",theme:"system",fontScale:"normal",reduceMotion:!1,colorBlindMode:!1}),[F,U]=o.useState(null),[m,u]=o.useState({channels:{inApp:!0,email:!0,sms:!1},events:{loanAssigned:!0,approvalNeeded:!0,largeRepayment:{enabled:!0,threshold:5e5},arrearsDigest:{enabled:!0,days:7,hour:18},kycAssigned:!0}}),[B,O]=o.useState(null),[_,R]=o.useState([]),[w,g]=o.useState(!1),[be,$]=o.useState(!0),J=o.useMemo(()=>{var e;return((e=i==null?void 0:i.user)==null?void 0:e.avatarUrl)||""},[i]),[A,K]=o.useState({}),ve=(e=t)=>{const a={};return e.phone&&!Ie.test(e.phone)&&(a.phone="Use international format, e.g. +2547…"),ge.includes(e.timezone)||(a.timezone="Choose a supported time zone"),xe.includes(e.locale)||(a.locale="Choose a supported locale"),e!=null&&e.employeeCode&&String(e.employeeCode).length>32&&(a.employeeCode="Max 32 characters"),a},P=e=>JSON.stringify(e??{}),Y=y&&P(t)!==P(y),E=F&&P(d)!==P(F),T=B&&P(m)!==P(B),I=!!(Y||E||T);o.useEffect(()=>{const e=a=>{I&&(a.preventDefault(),a.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[I]),o.useEffect(()=>{const e=new AbortController;return(async()=>{var a,l,p,M,D;$(!0);try{const[x,ce,de,Re,z]=await Promise.all([c.get("/account/me",{signal:e.signal}),c.get("/account/preferences",{signal:e.signal}).catch(()=>({data:{}})),c.get("/account/notifications",{signal:e.signal}).catch(()=>({data:{}})),c.get("/account/security/sessions",{signal:e.signal}).catch(()=>({data:{sessions:[]}})),c.get("/branches",{signal:e.signal}).catch(()=>({data:[]}))]);f(x.data);const b=((a=x.data)==null?void 0:a.user)||{},me={displayName:b.displayName||b.name||"",name:b.name||"",phone:b.phone||"",branchId:b.branchId||"",timezone:b.timezone||"Africa/Nairobi",locale:b.locale||"en",title:b.title||"",department:b.department||"",employeeCode:b.employeeCode||""};r(me),k(me);const he={...d,...((l=ce.data)==null?void 0:l.preferences)||ce.data||{}};j(he),U(he);const ue={...m,...((p=de.data)==null?void 0:p.notifications)||de.data||{}};u(ue),O(ue),R(((M=Re.data)==null?void 0:M.sessions)||[]);const Te=Array.isArray(z.data)?z.data:((D=z.data)==null?void 0:D.items)||[];C(Te)}catch(x){console.error("Failed to load profile:",(x==null?void 0:x.message)||x)}finally{$(!1)}})(),()=>e.abort()},[]);const[fe,Z]=o.useState([]);function n(e,a="ok"){const l=Math.random().toString(36).slice(2);Z(p=>[...p,{id:l,msg:e,type:a}]),setTimeout(()=>Z(p=>p.filter(M=>M.id!==l)),2500)}const ye=async()=>{var a;const e=ve();if(K(e),Object.keys(e).length){n("Fix validation errors","error");return}g(!0);try{const l={displayName:t.displayName,name:t.name,phone:t.phone,timezone:t.timezone,locale:t.locale,branchId:t.branchId||null,title:t.title,department:t.department,employeeCode:t.employeeCode},p=await c.put("/account/me",l);f({user:((a=p.data)==null?void 0:a.user)||{}}),k(t),n("Saved profile")}catch{n("Failed to save profile","error")}finally{g(!1)}},je=()=>{y&&r(y),K({})},Ne=e=>{try{window.dispatchEvent(new CustomEvent("app:preferences",{detail:e}))}catch{}try{localStorage.setItem("user:prefs",JSON.stringify(e))}catch{}},we=async()=>{g(!0);try{await c.put("/account/preferences",d),U(d),Ne(d),n("Saved preferences")}catch{n("Failed to save preferences","error")}finally{g(!1)}},Se=()=>j(F||d),Ce=async()=>{g(!0);try{await c.put("/account/notifications",m),O(m),n("Saved notifications")}catch{n("Failed to save notifications","error")}finally{g(!1)}},De=async()=>{try{await c.post("/account/notifications/test").catch(()=>{}),n("Test notification queued")}catch{n("Test send not available on this server","error")}},ke=async()=>{var e;g(!0);try{await c.post("/account/security/sessions/revoke-all");const a=await c.get("/account/security/sessions").catch(()=>({data:{sessions:[]}}));R(((e=a.data)==null?void 0:e.sessions)||[]),n("Signed out from other devices")}catch{n("Failed to revoke sessions","error")}finally{g(!1)}},Pe=async e=>{g(!0);try{await c.delete(`/account/security/sessions/${encodeURIComponent(e)}`).catch(async()=>{await c.post("/account/security/sessions/revoke",{id:e})}),R(a=>a.filter(l=>l.id!==e)),n("Session revoked")}catch{n("Failed to revoke session","error")}finally{g(!1)}},Me=async e=>{var p;const a=(p=e.target.files)==null?void 0:p[0];if(!a)return;if(a.size>2*1024*1024)return n("Image too large (max 2MB)","error");const l=new FormData;l.append("avatar",a);try{const M=await c.post("/account/avatar",l,{headers:{"Content-Type":"multipart/form-data"}});f(D=>{var x;return{...D||{},user:{...(D==null?void 0:D.user)||{},avatarUrl:((x=M.data)==null?void 0:x.avatarUrl)||""}}}),n("Avatar updated")}catch{n("Failed to upload avatar","error")}finally{e.target.value=""}},Ae=async()=>{try{await c.post("/account/security/mute"),n("Profile muted (notifications suppressed)")}catch{n("Mute not available on this server","error")}},Ye=async()=>{if(window.confirm("Disable this profile? You will be signed out and an admin must re-enable it."))try{await c.post("/account/security/disable"),n("Profile disabled")}catch{n("Disable not available on this server","error")}},Ee=async()=>{if(window.prompt("Type DELETE to permanently remove your profile. This cannot be undone.")==="DELETE")try{await c.delete("/account"),n("Profile deleted")}catch{n("Delete not available on this server","error")}},L=(i==null?void 0:i.user)||{},Fe=(L.displayName||L.name||"S").split(" ").map(e=>e[0]).join("").slice(0,2).toUpperCase(),G=o.useRef(null);return o.useEffect(()=>{G.current=(i==null?void 0:i.sessionId)||null},[i]),s.jsxs("div",{className:"p-6",children:[s.jsx("div",{className:"fixed right-4 top-4 z-50 space-y-2",children:fe.map(e=>s.jsx("div",{className:`px-3 py-2 rounded shadow text-sm text-white ${e.type==="error"?"bg-rose-600":"bg-emerald-600"}`,children:e.msg},e.id))}),s.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Profile"}),be?s.jsx("div",{className:"text-sm text-slate-500",children:"Loading…"}):s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-6",children:[s.jsxs("div",{className:"space-y-6",children:[s.jsxs("section",{className:"bg-white border rounded-2xl p-4 shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Identity"}),Y&&s.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded bg-amber-100 text-amber-700",children:"Unsaved changes"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsx(v,{label:"Display name",value:t.displayName,onChange:e=>r(a=>({...a,displayName:e}))}),s.jsx(v,{label:"Full name",value:t.name,onChange:e=>r(a=>({...a,name:e}))}),s.jsx(v,{label:"Email",value:L.email||"",readOnly:!0,helper:"Email is managed by your admin."}),s.jsx(v,{label:"Phone",value:t.phone,onChange:e=>r(a=>({...a,phone:e})),placeholder:"+2547…",error:A.phone}),s.jsx(S,{label:"Default branch",value:String(t.branchId||""),onChange:e=>r(a=>({...a,branchId:e||""})),options:[{value:"",label:"—"},...h.map(e=>({value:String(e.id),label:e.name}))]}),s.jsx(S,{label:"Time zone",value:t.timezone,onChange:e=>r(a=>({...a,timezone:e})),options:ge.map(e=>({value:e,label:e})),error:A.timezone}),s.jsx(S,{label:"Locale",value:t.locale,onChange:e=>r(a=>({...a,locale:e})),options:xe.map(e=>({value:e,label:e})),error:A.locale})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx("h3",{className:"text-sm font-medium text-slate-700 mb-2",children:"Professional"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[s.jsx(v,{label:"Job title",value:t.title,onChange:e=>r(a=>({...a,title:e}))}),s.jsx(v,{label:"Department",value:t.department,onChange:e=>r(a=>({...a,department:e}))}),s.jsx(v,{label:"Employee ID",value:t.employeeCode,onChange:e=>r(a=>({...a,employeeCode:e})),error:A.employeeCode})]})]}),s.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[s.jsx("button",{onClick:ye,disabled:w||!Y,className:"px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:w?"Saving…":"Save Changes"}),s.jsx("button",{onClick:je,disabled:!Y||w,className:"px-3 py-2 rounded-lg border bg-white hover:bg-slate-50 disabled:opacity-60",children:"Reset"})]})]}),s.jsxs("section",{className:"bg-white border rounded-2xl p-4 shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Preferences"}),E&&s.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded bg-amber-100 text-amber-700",children:"Unsaved changes"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsx(S,{label:"Default landing page",value:d.landingPage,onChange:e=>j(a=>({...a,landingPage:e})),options:[{value:"/dashboard",label:"Dashboard"},{value:"/loans",label:"Loans"},{value:"/borrowers",label:"Borrowers"},{value:"/collections",label:"Collections"}]}),s.jsx(S,{label:"Default currency",value:d.defaultCurrency,onChange:e=>j(a=>({...a,defaultCurrency:e})),options:[{value:"TZS",label:"TZS"},{value:"USD",label:"USD"},{value:"KES",label:"KES"}]}),s.jsx(S,{label:"Date format",value:d.dateFormat,onChange:e=>j(a=>({...a,dateFormat:e})),options:[{value:"DD/MM/YYYY",label:"DD/MM/YYYY"},{value:"YYYY-MM-DD",label:"YYYY-MM-DD"},{value:"MM/DD/YYYY",label:"MM/DD/YYYY"}]}),s.jsx(S,{label:"Theme",value:d.theme,onChange:e=>j(a=>({...a,theme:e})),options:[{value:"system",label:"System"},{value:"light",label:"Light"},{value:"dark",label:"Dark"}]}),s.jsx(S,{label:"Font size",value:d.fontScale,onChange:e=>j(a=>({...a,fontScale:e})),options:[{value:"small",label:"Small"},{value:"normal",label:"Normal"},{value:"large",label:"Large"}]})]}),s.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsx(N,{label:"Color-blind friendly palette",checked:!!d.colorBlindMode,onChange:e=>j(a=>({...a,colorBlindMode:e}))}),s.jsx(N,{label:"Reduced motion",checked:!!d.reduceMotion,onChange:e=>j(a=>({...a,reduceMotion:e}))})]}),s.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[s.jsx("button",{onClick:we,disabled:w||!E,className:"px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 disabled:opacity-60",children:w?"Saving…":"Save Preferences"}),s.jsx("button",{onClick:Se,disabled:!E||w,className:"px-3 py-2 rounded-lg border bg-white hover:bg-slate-50 disabled:opacity-60",children:"Reset"})]})]}),s.jsxs("section",{className:"bg-white border rounded-2xl p-4 shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Notifications"}),T&&s.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded bg-amber-100 text-amber-700",children:"Unsaved changes"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[s.jsx(N,{label:"In-app",checked:!!((H=m.channels)!=null&&H.inApp),onChange:e=>u(a=>({...a,channels:{...a.channels,inApp:e}}))}),s.jsx(N,{label:"Email",checked:!!((W=m.channels)!=null&&W.email),onChange:e=>u(a=>({...a,channels:{...a.channels,email:e}}))}),s.jsx(N,{label:"SMS/WhatsApp",checked:!!((q=m.channels)!=null&&q.sms),onChange:e=>u(a=>({...a,channels:{...a.channels,sms:e}}))})]}),s.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsx(N,{label:"New loan assigned to me",checked:!!((V=m.events)!=null&&V.loanAssigned),onChange:e=>u(a=>({...a,events:{...a.events,loanAssigned:e}}))}),s.jsx(N,{label:"Approval needed (maker-checker)",checked:!!((X=m.events)!=null&&X.approvalNeeded),onChange:e=>u(a=>({...a,events:{...a.events,approvalNeeded:e}}))})]}),s.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsxs("div",{className:"border rounded-lg p-3",children:[s.jsx(N,{label:"Large repayment",checked:!!((ee=(Q=m.events)==null?void 0:Q.largeRepayment)!=null&&ee.enabled),onChange:e=>u(a=>{var l;return{...a,events:{...a.events,largeRepayment:{...((l=a.events)==null?void 0:l.largeRepayment)||{},enabled:e}}}})}),s.jsx("div",{className:"mt-2",children:s.jsx(v,{label:"Threshold",type:"number",value:String(((ae=(se=m.events)==null?void 0:se.largeRepayment)==null?void 0:ae.threshold)??5e5),onChange:e=>u(a=>{var l;return{...a,events:{...a.events,largeRepayment:{...((l=a.events)==null?void 0:l.largeRepayment)||{},threshold:Math.max(0,Number(e||0))}}}})})})]}),s.jsxs("div",{className:"border rounded-lg p-3",children:[s.jsx(N,{label:"Arrears digest",checked:!!((le=(te=m.events)==null?void 0:te.arrearsDigest)!=null&&le.enabled),onChange:e=>u(a=>{var l;return{...a,events:{...a.events,arrearsDigest:{...((l=a.events)==null?void 0:l.arrearsDigest)||{},enabled:e}}}})}),s.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[s.jsx(v,{label:"Days",type:"number",value:String(((re=(ne=m.events)==null?void 0:ne.arrearsDigest)==null?void 0:re.days)??7),onChange:e=>u(a=>{var l;return{...a,events:{...a.events,arrearsDigest:{...((l=a.events)==null?void 0:l.arrearsDigest)||{},days:Math.max(1,Number(e||1))}}}})}),s.jsx(v,{label:"Hour (24h)",type:"number",value:String(((ie=(oe=m.events)==null?void 0:oe.arrearsDigest)==null?void 0:ie.hour)??18),onChange:e=>u(a=>{var l;return{...a,events:{...a.events,arrearsDigest:{...((l=a.events)==null?void 0:l.arrearsDigest)||{},hour:Math.min(23,Math.max(0,Number(e||0)))}}}})})]})]})]}),s.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[s.jsx("button",{onClick:Ce,disabled:w||!T,className:"px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 disabled:opacity-60",children:w?"Saving…":"Save Notifications"}),s.jsx("button",{onClick:De,className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Send test"})]})]}),s.jsxs("section",{className:"bg-white border rounded-2xl p-4 shadow-sm",children:[s.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Security"}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.jsx(pe,{to:"/2fa",className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Manage Two-Factor"}),s.jsx(pe,{to:"/change-password",className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Change Password"}),s.jsx("button",{onClick:Ae,className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Mute Profile"}),s.jsx("button",{onClick:Ye,className:"px-3 py-2 rounded-lg border bg-white hover:bg-gray-50",children:"Disable Profile"}),s.jsx("button",{onClick:Ee,className:"px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700",children:"Delete Profile"})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx("h3",{className:"text-sm font-medium text-slate-700 mb-2",children:"Active sessions"}),_.length===0?s.jsx("p",{className:"text-xs text-slate-500 mb-2",children:"Only this device is active."}):s.jsx("div",{className:"space-y-2",children:_.map(e=>{const a=e.id&&e.id===G.current;return s.jsxs("div",{className:"flex items-center justify-between gap-3 border rounded-lg px-3 py-2",children:[s.jsxs("div",{className:"min-w-0",children:[s.jsxs("div",{className:"text-sm font-medium truncate",children:[e.device||e.userAgent||"Device"," ",a&&s.jsx("span",{className:"text-xs text-emerald-600",children:"(current)"})]}),s.jsxs("div",{className:"text-xs text-slate-500 truncate",children:["IP: ",e.ip||"-"," · Last active: ",e.lastActive||e.last_seen||"-"]})]}),!a&&s.jsx("button",{onClick:()=>Pe(e.id),className:"text-xs px-2 py-1 rounded bg-rose-600 text-white hover:bg-rose-700",children:"Revoke"})]},e.id||`${e.ip}-${e.lastActive}`)})}),s.jsx("div",{className:"mt-3",children:s.jsx("button",{onClick:ke,className:"px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700",children:"Sign out of other devices"})})]})]})]}),s.jsxs("aside",{className:"bg-white border rounded-2xl p-4 h-fit shadow-sm",children:[s.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Avatar"}),s.jsxs("div",{className:"flex items-center gap-3",children:[J?s.jsx("img",{src:J,alt:"Avatar",className:"w-14 h-14 rounded-full object-cover border"}):s.jsx("div",{className:"w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center text-lg font-semibold",children:Fe}),s.jsxs("label",{className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 cursor-pointer",children:[s.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:Me}),"Choose image"]})]}),s.jsx("p",{className:"text-xs text-slate-500 mt-2",children:"PNG/JPG/WEBP up to 2MB."}),I&&s.jsx("p",{className:"mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded p-2",children:"You have unsaved changes on this page."})]})]})]})}function v({label:i,value:f,onChange:h,type:C="text",placeholder:t="",readOnly:r=!1,helper:y="",error:k=""}){return s.jsxs("label",{className:"block",children:[s.jsx("span",{className:"text-xs text-slate-600",children:i}),s.jsx("input",{className:`mt-1 w-full border rounded-lg px-3 py-2 outline-none ${r?"bg-gray-50":k?"border-rose-400 focus:ring-2 focus:ring-rose-200":"focus:ring-2 focus:ring-indigo-200"}`,type:C,value:f??"",placeholder:t,onChange:d=>h==null?void 0:h(d.target.value),readOnly:r}),y&&s.jsx("span",{className:"block mt-1 text-[11px] text-slate-500",children:y}),k&&s.jsx("span",{className:"block mt-1 text-[11px] text-rose-600",children:k})]})}function S({label:i,value:f,onChange:h,options:C,error:t=""}){return s.jsxs("label",{className:"block",children:[s.jsx("span",{className:"text-xs text-slate-600",children:i}),s.jsx("select",{className:`mt-1 w-full border rounded-lg px-3 py-2 outline-none ${t?"border-rose-400 focus:ring-2 focus:ring-rose-200":"focus:ring-2 focus:ring-indigo-200"}`,value:f??"",onChange:r=>h==null?void 0:h(r.target.value),children:C.map((r,y)=>s.jsx("option",{value:r.value,children:r.label},y))}),t&&s.jsx("span",{className:"block mt-1 text-[11px] text-rose-600",children:t})]})}function N({label:i,checked:f,onChange:h}){return s.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",className:"w-4 h-4",checked:!!f,onChange:C=>h==null?void 0:h(C.target.checked)}),s.jsx("span",{children:i})]})}export{ze as default};

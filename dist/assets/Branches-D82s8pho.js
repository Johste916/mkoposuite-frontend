import{r as l,g as y,j as e}from"./index-x5m31TRy.js";const N=(t,c)=>t?["admin","director","super_admin","system_admin"].includes((t.role||"").toLowerCase())?!0:Array.isArray(t.permissions)&&t.permissions.includes(c):!1,C=t=>String(t||"").replace(/\D+/g,""),S=t=>{const c=String(t??"").trim();if(!c||!/^-?\d+$/.test(c))return null;const a=Number(c);return Number.isFinite(a)?a:null},w=t=>{const c=String(t??"").trim();return c.length?c:null};function R(){const[t,c]=l.useState(null),[a,o]=l.useState("overview");return l.useEffect(()=>{(async()=>{try{const{data:m}=await y.get("/auth/me");c(m)}catch{}})()},[]),t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Branches"}),e.jsx("p",{className:"text-xs text-slate-500",children:"View branches and perform common operations."})]}),e.jsxs("div",{className:"flex gap-1 rounded-lg border bg-white overflow-hidden",children:[e.jsx(v,{label:"Overview",id:"overview",tab:a,setTab:o}),N(t,"branches:manage")&&e.jsx(v,{label:"Add",id:"add",tab:a,setTab:o}),N(t,"branches:assign")&&e.jsx(v,{label:"Assign",id:"assign",tab:a,setTab:o}),e.jsx(v,{label:"Reports",id:"reports",tab:a,setTab:o})]})]}),a==="overview"&&e.jsx(I,{}),a==="add"&&N(t,"branches:manage")&&e.jsx(B,{}),a==="assign"&&N(t,"branches:assign")&&e.jsx(E,{}),a==="reports"&&e.jsx($,{})]}):e.jsx("div",{className:"p-4",children:"Loading…"})}function v({label:t,id:c,tab:a,setTab:o}){const m=a===c;return e.jsx("button",{onClick:()=>o(c),className:`px-3 py-1.5 text-sm ${m?"bg-slate-100":"bg-white hover:bg-slate-50"}`,children:t})}function I(){const[t,c]=l.useState([]),[a,o]=l.useState(""),[m,g]=l.useState(""),p=async()=>{var i,x;g("");try{const{data:d}=await y.get("/branches",{params:{q:a}}),b=Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d)?d:[];c(b)}catch(d){g(((x=(i=d==null?void 0:d.response)==null?void 0:i.data)==null?void 0:x.error)||d.message)}};return l.useEffect(()=>{p()},[]),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Search"}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm",value:a,onChange:i=>o(i.target.value),placeholder:"name, code, phone…"})]}),e.jsx("button",{onClick:p,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Apply"})]}),m&&e.jsx("div",{className:"text-sm text-red-600",children:m}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Code"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"Address"}),e.jsx("th",{className:"py-2 px-3",children:"Manager"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-gray-500",children:"No branches yet."})}):t.map(i=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:i.name}),e.jsx("td",{className:"py-2 px-3",children:i.code??"—"}),e.jsx("td",{className:"py-2 px-3",children:i.phone??"—"}),e.jsx("td",{className:"py-2 px-3",children:i.address??"—"}),e.jsx("td",{className:"py-2 px-3",children:i.managerName||i.manager_id||"—"})]},i.id))})]})})]})}function B(){const[t,c]=l.useState({name:"",code:"",phone:"",address:""}),[a,o]=l.useState(!1),[m,g]=l.useState(""),[p,i]=l.useState(""),[x,d]=l.useState(""),b=async()=>{var j;o(!0),i(""),g(""),d("");const u={name:w(t.name),code:S(t.code),phone:w(C(t.phone)),address:w(t.address)};try{await y.post("/branches",u),g("Branch created."),c({name:"",code:"",phone:"",address:""})}catch(r){const s=(j=r==null?void 0:r.response)==null?void 0:j.data;d((s==null?void 0:s.requestId)||""),i((s==null?void 0:s.error)||(s==null?void 0:s.message)||r.message||"Failed to create branch")}finally{o(!1)}};return e.jsxs("div",{className:"bg-white border rounded-xl p-3 grid gap-2 md:grid-cols-4 items-end",children:[["name","code","phone","address"].map(u=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:u}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:t[u],onChange:j=>c(r=>({...r,[u]:j.target.value})),placeholder:u==="code"?"e.g. 1":u==="phone"?"digits only":""})]},u)),e.jsx("button",{onClick:b,disabled:a,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm disabled:opacity-60",children:a?"Saving…":"Create"}),m&&e.jsx("div",{className:"text-sm text-emerald-700",children:m}),(p||x)&&e.jsxs("div",{className:"text-sm text-red-600 col-span-full",children:[p,x?e.jsxs(e.Fragment,{children:[" ",e.jsxs("span",{className:"text-xs opacity-80",children:["(requestId: ",x,")"]})]}):null]})]})}function E(){const[t,c]=l.useState([]),[a,o]=l.useState([]),[m,g]=l.useState(""),[p,i]=l.useState([]),[x,d]=l.useState(""),[b,u]=l.useState("");l.useEffect(()=>{(async()=>{try{const[{data:s},{data:n}]=await Promise.all([y.get("/branches"),y.get("/users",{params:{limit:1e3}})]),h=Array.isArray(s==null?void 0:s.items)?s.items:Array.isArray(s)?s:[],A=Array.isArray(n==null?void 0:n.items)?n.items:Array.isArray(n==null?void 0:n.rows)?n.rows:Array.isArray(n)?n:[];c(h),o(A)}catch{}})()},[]);const j=s=>{i(n=>n.includes(s)?n.filter(h=>h!==s):[...n,s])},r=async()=>{var s,n;d(""),u("");try{const h=S(m);await y.post(`/branches/${h}/assign-staff`,{userIds:p}),d("Assigned successfully.")}catch(h){u(((n=(s=h==null?void 0:h.response)==null?void 0:s.data)==null?void 0:n.error)||h.message)}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:m,onChange:s=>g(s.target.value),children:[e.jsx("option",{value:"",children:"Select branch"}),t.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("button",{onClick:r,disabled:!m||p.length===0,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:["Assign ",p.length?`(${p.length})`:""]}),x&&e.jsx("div",{className:"text-sm text-emerald-700",children:x}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"})]})}),e.jsx("tbody",{children:a.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"p-3 text-gray-500",children:"No users."})}):a.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:p.includes(s.id),onChange:()=>j(s.id)})}),e.jsx("td",{className:"py-2 px-3",children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()}),e.jsx("td",{className:"py-2 px-3",children:s.email}),e.jsx("td",{className:"py-2 px-3",children:s.role||(s.Roles||[]).map(n=>n.name).join(", ")||"—"})]},s.id))})]})})]})}function $(){const[t,c]=l.useState([]),[a,o]=l.useState(""),[m,g]=l.useState(""),[p,i]=l.useState(""),[x,d]=l.useState(null),[b,u]=l.useState("");l.useEffect(()=>{(async()=>{try{const{data:r}=await y.get("/branches"),s=Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r)?r:[];c(s)}catch{}})()},[]);const j=async()=>{var r,s;u(""),d(null);try{const n=S(a),{data:h}=await y.get(`/branches/${n}/report`,{params:{from:m,to:p}});d((h==null?void 0:h.kpis)||h||null)}catch(n){u(((s=(r=n==null?void 0:n.response)==null?void 0:r.data)==null?void 0:s.error)||n.message)}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:a,onChange:r=>o(r.target.value),children:[e.jsx("option",{value:"",children:"Select"}),t.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:m,onChange:r=>g(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:p,onChange:r=>i(r.target.value)})]}),e.jsx("button",{onClick:j,disabled:!a,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Run"})]}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b}),x&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(f,{title:"Staff",value:x.staffCount,tone:"indigo"}),e.jsx(f,{title:"Expenses",value:`TZS ${Number(x.expenses||0).toLocaleString()}`,tone:"amber"}),e.jsx(f,{title:"Loans Out",value:`TZS ${Number(x.loansOut||x.disbursed||0).toLocaleString()}`,tone:"emerald"}),e.jsx(f,{title:"Collections",value:`TZS ${Number(x.collections||x.collected||0).toLocaleString()}`,tone:"blue"})]})]})}function f({title:t,value:c,tone:a="indigo"}){const o={indigo:"text-indigo-600 bg-indigo-50",amber:"text-amber-600 bg-amber-50",emerald:"text-emerald-600 bg-emerald-50",blue:"text-blue-600 bg-blue-50"}[a]||"text-slate-600 bg-slate-50";return e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex items-center gap-3",children:[e.jsx("div",{className:`px-2 py-1 rounded ${o}`,children:t}),e.jsx("div",{className:"font-semibold",children:c??"—"})]})}export{R as default};

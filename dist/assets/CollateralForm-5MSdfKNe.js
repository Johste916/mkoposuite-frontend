import{u as J,k as K,r as s,h as p,j as a}from"./index-CF8R0B4H.js";function n({label:d,children:i}){return a.jsxs("label",{className:"block mb-3",children:[a.jsx("span",{className:"block text-sm font-medium mb-1",children:d}),i]})}const h=d=>{var o,l;const i=((l=(o=p)==null?void 0:o.defaults)==null?void 0:l.baseURL)||"";return/\/api\/?$/.test(i)&&d.startsWith("/api/")?d.slice(4):d};function Y({mode:d="create"}){const i=J(),{id:x}=K(),o=x&&x!=="new"?x:null,l=d==="edit"||!!o,[W,b]=s.useState(!1),[y,j]=s.useState(""),[m,N]=s.useState(""),[S,w]=s.useState([]),[c,C]=s.useState(""),[E,I]=s.useState([]),[A,g]=s.useState(""),[f,V]=s.useState(""),[L,D]=s.useState(""),[B,$]=s.useState(""),[k,O]=s.useState(""),[v,R]=s.useState(""),[T,q]=s.useState(""),[M,P]=s.useState(""),[F,Q]=s.useState("ACTIVE");s.useEffect(()=>{!l||!o||(b(!0),p.get(h(`/api/collateral/${o}`)).then(e=>{const t=e.data||{};C(t.borrowerId||""),g(t.loanId||""),V(t.itemName||""),D(t.category||""),$(t.model||""),O(t.serialNumber||""),R(t.estValue??""),q(t.location||""),P(t.notes||""),Q(t.status||"ACTIVE")}).catch(e=>{var t,r;return j(((r=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:r.error)||e.message)}).finally(()=>b(!1)))},[l,o]),s.useEffect(()=>{if(!m||m.length<2){w([]);return}let e=!1;return p.get(h("/api/collateral/helpers/borrower-search"),{params:{q:m}}).then(t=>{var r;e||w(Array.isArray((r=t.data)==null?void 0:r.data)?t.data.data:[])}).catch(()=>{}).finally(()=>{}),()=>{e=!0}},[m]),s.useEffect(()=>{if(!c){I([]),g("");return}let e=!1;return p.get(h("/api/collateral/helpers/open-loans"),{params:{borrowerId:c}}).then(t=>{var u;if(e)return;const r=Array.isArray((u=t.data)==null?void 0:u.data)?t.data.data:[];I(r),r.length===1&&g(r[0].id)}).catch(()=>{}).finally(()=>{}),()=>{e=!0}},[c]);const G=e=>{e.preventDefault(),j(""),b(!0);const t={borrowerId:c||null,loanId:A||null,itemName:f,category:L,model:B,serialNumber:k,estValue:v===""?null:Number(v),location:T,notes:M,status:l?F:"ACTIVE",autoDetectLoan:!0};(l?p.put(h(`/api/collateral/${o}`),t):p.post(h("/api/collateral"),t)).then(()=>i("/collateral")).catch(u=>{var z,U;return j(((U=(z=u==null?void 0:u.response)==null?void 0:z.data)==null?void 0:U.error)||u.message)}).finally(()=>b(!1))},H=s.useMemo(()=>f.trim().length>0&&c,[f,c]);return a.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow p-4 max-w-3xl",children:[a.jsx("h2",{className:"text-lg font-semibold mb-4",children:l?"Edit Collateral":"Register Collateral"}),y&&a.jsxs("div",{className:"text-red-600 text-sm mb-3",children:["Error: ",y]}),a.jsxs("form",{onSubmit:G,className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"sm:col-span-2",children:[a.jsx(n,{label:"Borrower",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Search borrower by name or phone…",value:m,onChange:e=>N(e.target.value)})}),S.length>0&&a.jsx("div",{className:"border rounded mb-2 max-h-48 overflow-auto",children:S.map(e=>a.jsxs("button",{type:"button",onClick:()=>{C(e.id),N(`${e.name}${e.phone?` — ${e.phone}`:""}`)},className:`w-full text-left px-3 py-2 hover:bg-gray-50 ${c===e.id?"bg-gray-50":""}`,children:[a.jsx("div",{className:"font-medium",children:e.name}),a.jsx("div",{className:"text-xs text-gray-500",children:e.phone})]},e.id))})]}),a.jsx(n,{label:"Loan (open)",children:a.jsxs("select",{className:"w-full border rounded px-3 py-2",value:A||"",onChange:e=>g(e.target.value||""),disabled:!c,children:[a.jsxs("option",{value:"",children:["— ",E.length?"Select":"No open loans"," —"]}),E.map(e=>a.jsxs("option",{value:e.id,children:[e.id," • ",e.status||"open"]},e.id))]})}),a.jsx(n,{label:"Item Name *",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:f,onChange:e=>V(e.target.value)})}),a.jsx(n,{label:"Category",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:L,onChange:e=>D(e.target.value),placeholder:"Electronics / Vehicle…"})}),a.jsx(n,{label:"Model",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:B,onChange:e=>$(e.target.value)})}),a.jsx(n,{label:"Serial #",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:k,onChange:e=>O(e.target.value)})}),a.jsx(n,{label:"Est. Value",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:v,onChange:e=>R(e.target.value),type:"number",step:"0.01"})}),a.jsx(n,{label:"Location",children:a.jsx("input",{className:"w-full border rounded px-3 py-2",value:T,onChange:e=>q(e.target.value)})}),a.jsx("div",{className:"sm:col-span-2",children:a.jsx(n,{label:"Notes",children:a.jsx("textarea",{className:"w-full border rounded px-3 py-2",rows:3,value:M,onChange:e=>P(e.target.value)})})}),l&&a.jsx(n,{label:"Status",children:a.jsxs("select",{className:"w-full border rounded px-3 py-2",value:F,onChange:e=>Q(e.target.value),children:[a.jsx("option",{value:"ACTIVE",children:"ACTIVE"}),a.jsx("option",{value:"RELEASED",children:"RELEASED"}),a.jsx("option",{value:"DISPOSED",children:"DISPOSED"})]})}),a.jsxs("div",{className:"sm:col-span-2 flex gap-2 pt-2",children:[a.jsx("button",{type:"submit",disabled:!H||W,className:"px-4 py-2 rounded bg-blue-600 text-white disabled:opacity-50",children:l?"Save Changes":"Register Collateral"}),a.jsx("button",{type:"button",className:"px-4 py-2 rounded border",onClick:()=>i("/collateral"),children:"Cancel"})]})]})]})}export{Y as default};

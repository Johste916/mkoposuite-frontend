import{r,j as e}from"./index-CGp3nliO.js";const _=`@£$¥èéùìòÇ
Øø\rÅåΔ_ΦΓΛΩΠΨΣΘΞ\x1BÆæßÉ !"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ\`¿abcdefghijklmnopqrstuvwxyzäöñü^{}\\[~]|€`;function K(n){for(const a of n)if(!_.includes(a))return!0;return!1}function V(n){const a=K(n),l=n.length;if(l===0)return{isUnicode:a,segments:0,perSegment:a?70:160,charsLeft:a?70:160};if(!a){if(l<=160)return{isUnicode:a,segments:1,perSegment:160,charsLeft:160-l};const N=Math.ceil(l/153),c=l%153;return{isUnicode:a,segments:N,perSegment:153,charsLeft:c===0?0:153-c}}if(l<=70)return{isUnicode:a,segments:1,perSegment:70,charsLeft:70-l};const p=Math.ceil(l/67),d=l%67;return{isUnicode:a,segments:p,perSegment:67,charsLeft:d===0?0:67-d}}function B(...n){return n.filter(Boolean).join(" ")}function ee(n){if(!n)return"";let a=String(n).replace(/[^\d+]/g,"");return a.startsWith("+255")?a=a.slice(1):a.startsWith("0")?a="255"+a.slice(1):a.startsWith("+")&&(a=a.slice(1)),a}const se="",x=n=>`${se.replace(/\/+$/,"")}/api${n}`;function te({kind:n="ok",msg:a,onClose:l}){const p={ok:"bg-emerald-50 text-emerald-800 ring-emerald-200",err:"bg-rose-50 text-rose-800 ring-rose-200",info:"bg-sky-50 text-sky-800 ring-sky-200"}[n];return r.useEffect(()=>{const d=setTimeout(l,4e3);return()=>clearTimeout(d)},[l]),e.jsx("div",{className:B("fixed right-4 top-4 z-50 rounded-xl px-4 py-3 ring-1 shadow",p),children:e.jsx("div",{className:"font-medium",children:a})})}function ne(){const[n,a]=r.useState("single"),[l,p]=r.useState(null),[d,N]=r.useState(""),[c,P]=r.useState(""),[A,F]=r.useState(""),[M,L]=r.useState([]),[h,u]=r.useState(!1),[v,O]=r.useState(null),[j,D]=r.useState(""),[f,S]=r.useState(1),[b,J]=r.useState(25),[g,Q]=r.useState([]),[E,R]=r.useState(0),[m,w]=r.useState(new Set),[I,q]=r.useState(""),[$,G]=r.useState(!0),[z,H]=r.useState(!1),y=r.useMemo(()=>V(c),[c]);r.useEffect(()=>{(async()=>{try{const t=await(await fetch(x("/sms/balance"),{credentials:"include"})).json();p(t)}catch{}})(),(async()=>{try{const t=await(await fetch(x("/sms/messages"),{credentials:"include"})).json();L(Array.isArray(t.items)?t.items:[])}catch{}})()},[]),r.useEffect(()=>{if(n!=="multiple")return;const s=new AbortController;return(async()=>{try{const t=new URLSearchParams;j&&t.set("q",j),t.set("page",String(f)),t.set("limit",String(b));const i=await fetch(x(`/borrowers?${t.toString()}`),{credentials:"include",signal:s.signal}),T=await i.json(),U=Array.isArray(T)?T:T.items||[];Q(U);const Z=Number(i.headers.get("X-Total-Count")||U.length||0);R(Z)}catch{}})(),()=>s.abort()},[n,j,f,b]);function o(s,t){O({kind:s,msg:t})}async function W(){const s=ee(A);if(!s)return o("err","Please enter a valid phone number");if(!c.trim())return o("err","Please type a message");u(!0);try{const t=await fetch(x("/sms/send"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({to:s,message:c,from:d||void 0})}),i=await t.json();if(!t.ok||i.ok===!1)throw new Error(i.error||"Failed");o("ok","Message queued"),P(""),k()}catch(t){o("err",t.message)}finally{u(!1)}}async function Y(){if(m.size===0)return o("err","Select at least one borrower");if(!c.trim())return o("err","Please type a message");u(!0);try{const s=await fetch(x("/sms/to-borrowers"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({borrowerIds:Array.from(m),template:c,from:d||void 0})}),t=await s.json();if(!s.ok||t.ok===!1)throw new Error(t.error||"Failed");o("ok",`Queued ${t.count} messages`),w(new Set),k()}catch(s){o("err",s.message)}finally{u(!1)}}async function X(){if(!c.trim())return o("err","Please type a message");u(!0);try{const s=await fetch(x("/sms/to-segment"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({filter:{branchId:I||null,hasActiveLoan:!!$,overdueOnly:!!z},template:c,from:d||void 0})}),t=await s.json();if(!s.ok||t.ok===!1)throw new Error(t.error||"Failed");o("ok",`Queued ${t.count} messages`),k()}catch(s){o("err",s.message)}finally{u(!1)}}async function k(){try{const t=await(await fetch(x("/sms/messages"),{credentials:"include"})).json();L(Array.isArray(t.items)?t.items:[])}catch{}}const C=m.size;return e.jsxs("div",{className:"p-6 max-w-6xl mx-auto",children:[v&&e.jsx(te,{kind:v.kind,msg:v.msg,onClose:()=>O(null)}),e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold",children:"SMS Console"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Send one-off or bulk SMS via sms.co.tz"})]}),e.jsxs("div",{className:"rounded-xl border bg-white px-4 py-2 text-sm text-slate-700 shadow-sm",children:[e.jsx("div",{className:"font-medium",children:"Balance"}),e.jsx("div",{className:"text-slate-600",children:l?JSON.stringify(l):"…"})]})]}),e.jsx("div",{className:"mb-4 flex gap-2",children:["single","multiple","segment"].map(s=>e.jsxs("button",{onClick:()=>a(s),className:B("rounded-xl px-3 py-2 text-sm font-medium ring-1",n===s?"bg-slate-900 text-white ring-slate-900":"bg-white text-slate-700 ring-slate-200 hover:bg-slate-50"),children:[s==="single"&&"Single Borrower",s==="multiple"&&"Multiple Borrowers",s==="segment"&&"Group / Segment"]},s))}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx("div",{className:"md:col-span-2 rounded-2xl border bg-white p-4 shadow-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Sender ID (optional)"}),e.jsx("input",{className:"w-full rounded-xl border px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-800",placeholder:"Uses default if left blank",value:d,onChange:s=>N(s.target.value)})]}),n==="single"&&e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Recipient phone"}),e.jsx("input",{className:"w-full rounded-xl border px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-800",placeholder:"e.g., 0784 123 456",value:A,onChange:s=>F(s.target.value)})]}),n==="multiple"&&e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"w-64 rounded-lg border px-3 py-2 text-sm",placeholder:"Search borrowers",value:j,onChange:s=>{D(s.target.value),S(1)}}),e.jsx("select",{className:"rounded-lg border px-3 py-2 text-sm",value:b,onChange:s=>J(Number(s.target.value)),children:[10,25,50,100].map(s=>e.jsxs("option",{value:s,children:[s,"/page"]},s))})]}),e.jsxs("div",{className:"text-sm text-slate-600",children:["Selected: ",e.jsx("span",{className:"font-medium",children:C})]})]}),e.jsx("div",{className:"max-h-64 overflow-auto rounded-lg border",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-slate-50",children:e.jsxs("tr",{className:"text-left",children:[e.jsx("th",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",onChange:s=>{const t=new Set(m);s.target.checked?g.forEach(i=>t.add(String(i.id))):g.forEach(i=>t.delete(String(i.id))),w(t)},checked:g.every(s=>m.has(String(s.id)))&&g.length>0})}),e.jsx("th",{className:"px-3 py-2",children:"Name"}),e.jsx("th",{className:"px-3 py-2",children:"Phone"}),e.jsx("th",{className:"px-3 py-2",children:"Branch"})]})}),e.jsxs("tbody",{children:[g.map(s=>e.jsxs("tr",{className:"border-t hover:bg-slate-50",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"checkbox",checked:m.has(String(s.id)),onChange:t=>{const i=new Set(m);t.target.checked?i.add(String(s.id)):i.delete(String(s.id)),w(i)}})}),e.jsx("td",{className:"px-3 py-2",children:s.name||`${s.firstName??""} ${s.lastName??""}`.trim()||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.phone||s.msisdn||"-"}),e.jsx("td",{className:"px-3 py-2",children:s.branchName||s.branch||"-"})]},s.id)),g.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-6 text-center text-slate-500",colSpan:4,children:"No borrowers"})})]})]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:["Total: ",E]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"rounded-lg border px-2 py-1 text-sm",onClick:()=>S(s=>Math.max(1,s-1)),disabled:f<=1,children:"Prev"}),e.jsxs("div",{className:"text-sm",children:["Page ",f]}),e.jsx("button",{className:"rounded-lg border px-2 py-1 text-sm",onClick:()=>S(s=>s+1),disabled:f*b>=E,children:"Next"})]})]})]}),n==="segment"&&e.jsxs("div",{className:"rounded-xl border p-3 grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Branch (optional)"}),e.jsx("input",{className:"mt-1 w-full rounded-lg border px-3 py-2 text-sm",placeholder:"Branch ID or code",value:I,onChange:s=>q(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"hasloan",type:"checkbox",checked:$,onChange:s=>G(s.target.checked)}),e.jsx("label",{htmlFor:"hasloan",className:"text-sm text-slate-700",children:"Has active loan"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"overdue",type:"checkbox",checked:z,onChange:s=>H(s.target.checked)}),e.jsx("label",{htmlFor:"overdue",className:"text-sm text-slate-700",children:"Overdue only"})]}),e.jsx("p",{className:"md:col-span-3 text-xs text-slate-500",children:"Tip: you can start simple. Filters are optional and safely ignored if unsupported by the backend."})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Message"}),e.jsxs("span",{className:"text-xs text-slate-500",children:[y.isUnicode?"Unicode":"GSM-7"," • ",y.segments," segment",y.segments===1?"":"s"," • ",y.charsLeft," chars left in this segment"]})]}),e.jsx("textarea",{className:"min-h-[120px] w-full resize-y rounded-xl border px-3 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-800",placeholder:"Type your message. You can use {{name}} in templates for multiple/segment sends.",value:c,onChange:s=>P(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n==="single"&&e.jsx("button",{onClick:W,disabled:h,className:"rounded-xl bg-slate-900 px-4 py-2 text-white shadow hover:bg-slate-800 disabled:opacity-50",children:h?"Sending…":"Send SMS"}),n==="multiple"&&e.jsx("button",{onClick:Y,disabled:h,className:"rounded-xl bg-slate-900 px-4 py-2 text-white shadow hover:bg-slate-800 disabled:opacity-50",children:h?"Queuing…":`Send to ${C} borrower${C===1?"":"s"}`}),n==="segment"&&e.jsx("button",{onClick:X,disabled:h,className:"rounded-xl bg-slate-900 px-4 py-2 text-white shadow hover:bg-slate-800 disabled:opacity-50",children:h?"Queuing…":"Send to segment"})]})]})}),e.jsxs("div",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-slate-700",children:"Recent Messages"}),e.jsxs("div",{className:"space-y-3 max-h-[360px] overflow-auto",children:[M.slice(-15).reverse().map(s=>e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500",children:[e.jsx("span",{children:new Date(s.at).toLocaleString()}),e.jsx("span",{className:B("rounded px-2 py-0.5 text-[11px]",s.status==="failed"?"bg-rose-50 text-rose-700 ring-1 ring-rose-200":s.status==="dry-run"?"bg-amber-50 text-amber-700 ring-1 ring-amber-200":"bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200"),children:s.status})]}),e.jsx("div",{className:"mt-1 text-sm font-medium",children:s.to}),e.jsx("div",{className:"mt-1 text-sm text-slate-700 whitespace-pre-wrap",children:s.message})]},s.id)),M.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"No messages yet."})]}),e.jsxs("div",{className:"mt-6 rounded-xl bg-slate-50 p-3 text-xs text-slate-600",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Tips"}),e.jsxs("ul",{className:"list-disc pl-5 space-y-1",children:[e.jsxs("li",{children:["Use templates like ",e.jsx("code",{children:"{{name}}"})," on bulk/segment sends."]}),e.jsx("li",{children:"GSM-7 texts are cheaper: avoid emojis to keep it single-segment."}),e.jsx("li",{children:"You can leave “Sender ID” empty to use the default configured one."})]})]})]})]})]})}export{ne as default};

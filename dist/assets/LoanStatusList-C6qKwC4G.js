import{j as r,k as it,u as dt,m as ct,l as ut,r as b,h as U,L as mt}from"./index-DFzTBWzb.js";import{F as lt,S as pt}from"./search-CIYoz30G.js";import{C as ft}from"./chevron-down-Ce_zlr4N.js";import"./createLucideIcon-D4WvWtFN.js";const Se=e=>e==null||e===""?"—":Number(e).toLocaleString(),ht=e=>e==null||e===""?"—":`${Number(e)}%`,Q=e=>{var a;if(!e)return"—";const n=typeof e=="string"||typeof e=="number"?new Date(e):e;return!isNaN((a=n==null?void 0:n.getTime)==null?void 0:a.call(n))?n.toLocaleDateString():"—"},w=(e,n="TZS",d)=>{if(e==null||e==="")return"—";try{return new Intl.NumberFormat(d,{style:"currency",currency:n,maximumFractionDigits:0}).format(Number(e||0))}catch{return`‎${n} ${Number(e||0).toLocaleString()}`}},J=(e="")=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");function bt(e,n){const{rows:d,headers:a,filename:u}=Array.isArray(e)?{rows:e,headers:ne(e),filename:n||"export.csv"}:{rows:(e==null?void 0:e.rows)||[],headers:(e==null?void 0:e.headers)||ne((e==null?void 0:e.rows)||[]),filename:(e==null?void 0:e.filename)||"export.csv"},f=N=>String(N??"").replace(/"/g,'""'),l=a.join(","),h=d.map(N=>a.map(K=>`"${f(N[K])}"`).join(",")).join(`
`),p=`${l}
${h}`;et(new Blob([p],{type:"text/csv;charset=utf-8"}),u)}function yt(e,n){const{rows:d,headers:a,filename:u,title:f}=Array.isArray(e)?{rows:e,headers:ne(e),filename:n||"export.xls"}:{rows:(e==null?void 0:e.rows)||[],headers:(e==null?void 0:e.headers)||ne((e==null?void 0:e.rows)||[]),filename:(e==null?void 0:e.filename)||"export.xls",title:(e==null?void 0:e.title)||"Export"},l=`<h1>${J(f||"")}</h1><table border="1"><thead><tr>${a.map(p=>`<th>${J(p)}</th>`).join("")}</tr></thead><tbody>`+d.map(p=>`<tr>${a.map(N=>`<td>${J(String(p[N]??""))}</td>`).join("")}</tr>`).join("")+"</tbody></table>",h=new Blob([`\uFEFF${l}`],{type:"application/vnd.ms-excel"});et(h,u)}function gt(e){const{rows:n,headers:d,title:a}=Array.isArray(e)?{rows:e,headers:ne(e),title:"Export"}:{rows:(e==null?void 0:e.rows)||[],headers:(e==null?void 0:e.headers)||ne((e==null?void 0:e.rows)||[]),title:(e==null?void 0:e.title)||"Export"},u=`
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; padding: 16px; }
      h1 { font-size: 16px; margin: 0 0 12px 0; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      th, td { border: 1px solid #ccc; padding: 6px; text-align: left; white-space: nowrap; }
      thead { background: #f3f4f6; }
    </style>
  `,f=`<h1>${J(a)}</h1><table><thead><tr>${d.map(h=>`<th>${J(h)}</th>`).join("")}</tr></thead><tbody>`+n.map(h=>`<tr>${d.map(p=>`<td>${J(String(h[p]??""))}</td>`).join("")}</tr>`).join("")+"</tbody></table>",l=window.open("","_blank");l&&(l.document.write(`<html><head><title>${J(a)}</title>${u}</head><body>${f}</body></html>`),l.document.close(),l.focus(),l.print())}function xt(e,n){return bt(e,n)}function wt(e,n){return yt(e,n)}function Nt(e,n){return gt(e)}function ne(e=[]){return e[0]?Object.keys(e[0]):[]}function et(e,n){const d=URL.createObjectURL(e),a=document.createElement("a");a.href=d,a.download=n||"export",document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(d)}function Dt({page:e=1,pageSize:n=25,total:d=0,onPageChange:a,onPageSizeChange:u}){const f=Math.max(1,Math.ceil(d/n));return r.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-2 px-2 py-3",children:[r.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",r.jsx("span",{className:"font-medium",children:e})," of"," ",r.jsx("span",{className:"font-medium",children:f})," •"," ",r.jsx("span",{className:"font-medium",children:d})," rows"]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("select",{className:"border rounded px-2 py-1 text-sm",value:n,onChange:l=>u==null?void 0:u(Number(l.target.value)),"aria-label":"Rows per page",children:[10,25,50,100].map(l=>r.jsxs("option",{value:l,children:[l," / page"]},l))}),r.jsxs("div",{className:"inline-flex rounded border overflow-hidden",children:[r.jsx("button",{className:"px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-50",onClick:()=>a==null?void 0:a(Math.max(1,e-1)),disabled:e<=1,"aria-label":"Previous page",children:"‹ Prev"}),r.jsx("button",{className:"px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-50 border-l",onClick:()=>a==null?void 0:a(Math.min(f,e+1)),disabled:e>=f,"aria-label":"Next page",children:"Next ›"})]})]})]})}function kt({open:e,title:n="Are you sure?",description:d="",confirmText:a="Confirm",cancelText:u="Cancel",destructive:f=!1,onConfirm:l,onClose:h}){return e?r.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:r.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md p-4",children:[r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"mt-1 w-8 h-8 rounded-full flex items-center justify-center text-white "+(f?"bg-rose-600":"bg-indigo-600"),children:"!"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h3",{className:"text-lg font-semibold",children:n}),d&&r.jsx("p",{className:"mt-1 text-sm text-gray-600",children:d})]}),r.jsx("button",{className:"text-gray-500 hover:text-gray-700","aria-label":"Close",onClick:h,children:"✕"})]}),r.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[r.jsx("button",{className:"px-3 py-2 rounded border",onClick:h,children:u}),r.jsx("button",{className:"px-4 py-2 rounded text-white "+(f?"bg-rose-600 hover:bg-rose-700":"bg-indigo-600 hover:bg-indigo-700"),onClick:()=>{l==null||l(),h==null||h()},children:a})]})]})}):null}const g={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",sub:"text-sm text-slate-700",card:"rounded-2xl border border-slate-200 bg-white shadow-sm",th:"bg-slate-50 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-b border-slate-200 select-none",td:"px-3 py-2 border-b border-slate-100 text-sm align-top",btn:"inline-flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50 font-semibold border-slate-300",btnGhost:"inline-flex items-center rounded-lg border px-3 py-2 hover:bg-slate-50 border-slate-300",btnPrimary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-3 py-2 font-semibold hover:bg-indigo-700",fieldBase:"h-11 w-full rounded-lg border border-slate-300 bg-white text-sm outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600 transition",fieldIcon:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"},pe=({className:e="",leadingIcon:n=null,...d})=>r.jsxs("div",{className:`relative ${e}`,children:[n,r.jsx("input",{...d,className:`${g.fieldBase} ${n?"pl-10":""}`})]}),Fe=({className:e="",children:n,...d})=>r.jsxs("div",{className:`relative ${e}`,children:[r.jsx("select",{...d,className:`${g.fieldBase} pr-9 appearance-none bg-none ms-select`,style:{backgroundImage:"none"},children:n}),r.jsx(ft,{className:"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"})]}),We=e=>e?new Date(e):null,Pt=(e,n)=>e&&n&&e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate(),jt=(e,n)=>e&&n?e.getTime()<n.getTime():!1,i=(e,n=0)=>Number.isFinite(Number(e))?Number(e):n,ke=e=>String(e||"").toLowerCase(),Xe={due:"Due Loans",missed:"Missed Repayments",arrears:"Loans in Arrears","no-repayments":"No Repayments Made","past-maturity":"Past Maturity Loans","principal-outstanding":"Principal Outstanding","1-month-late":"1 Month Late","3-months-late":"3+ Months Late",disbursed:"Disbursed Loans"},R={active:e=>{const n=ke(e.status||e.state);return["disbursed","active"].includes(n)||n==="closed"&&i(e.outstanding)>0},disbursed:e=>ke(e.status||e.state)==="disbursed"||!!(e.disbursementDate||e.disbursement_date||e.releaseDate),due:(e,n)=>{if(!R.active(e))return!1;const d=We(e.nextDueDate||e.upcomingDueDate);return ke(e.nextDueStatus||e.dueStatus)==="due"||d&&Pt(d,n.todayStart)},missed:e=>R.active(e)&&i(e.dpd||e.daysPastDue)>0,arrears:e=>R.active(e)&&(ke(e.nextDueStatus||e.dueStatus)==="overdue"||i(e.arrears||e.totalArrears||e.outstandingArrears)>0||i(e.dpd||e.daysPastDue)>0),"no-repayments":e=>R.active(e)?!(i(e.totalPaid||e.amountPaid||e.repaymentsTotal||e.totalCollections)>0||i(e.paidPrincipal)+i(e.paidInterest)+i(e.paidFees)+i(e.paidPenalty)>0):!1,"past-maturity":(e,n)=>{if(!R.active(e))return!1;const d=We(e.maturityDate||e.endDate||e.expectedMaturityDate),a=e.outstanding!=null?i(e.outstanding,0):i(e.outstandingPrincipal)+i(e.outstandingInterest)+i(e.outstandingFees)+i(e.outstandingPenalty);return d&&jt(d,n.todayStart)&&a>0},"principal-outstanding":e=>R.active(e)&&i(e.outstandingPrincipal)>0,"1-month-late":e=>R.active(e)&&i(e.dpd||e.daysPastDue)>=30&&i(e.dpd||e.daysPastDue)<60,"3-months-late":e=>R.active(e)&&i(e.dpd||e.daysPastDue)>=90},vt={disbursed:{columns:[{key:"disbDate",header:"Date of Dsb"},{key:"borrower",header:"Borrower name"},{key:"phone",header:"Phone number"},{key:"product",header:"Loan product"},{key:"principal",header:"Principal amount",align:"right"},{key:"interest",header:"Interest amount",align:"right"},{key:"outPrin",header:"Outstanding principal",align:"right"},{key:"outInt",header:"Outstanding Interest",align:"right"},{key:"outFee",header:"Outstanding fee",align:"right"},{key:"outPen",header:"Outstanding penalty",align:"right"},{key:"outstanding",header:"Total outstanding",align:"right"},{key:"rateYear",header:"Interest rate/year %"},{key:"duration",header:"Loan Duration"},{key:"dueDate",header:"Due date"},{key:"officer",header:"Loan officer"},{key:"branch",header:"Branch"},{key:"status",header:"Status"}],totalKeys:["principal","interest","outPrin","outInt","outFee","outPen","outstanding"],rowMap:(e,n={})=>{var H,O,ge,xe,E,_,we,Ne,W,D,X,De,ee,B;const d=e.currency||"TZS",a=x=>Number.isFinite(Number(x))?Number(x):0,u=x=>Math.max(0,a(x)),f=a(e.principalAmount??e.amount??e.principal??e.expectedPrincipal),l=e.loanDurationMonths??e.termMonths??e.durationMonths??e.tenureMonths??e.periodMonths??null,h=e.termDays??e.durationDays??null,p=e.installmentCount??e.numberOfInstallments??null,N=e.repaymentFrequency||e.frequency||e.installmentFrequency||null,K=typeof N=="string"?N.replace(/_/g," "):N;let C="—";l?C=`${l} mo`:h?C=`${h} days`:p&&K?C=`${p} × ${K}`:p&&(C=`${p} installments`);const Pe=e.nextDueDate||e.firstDueDate||e.upcomingDueDate||e.dueDate||e.firstRepaymentDate||e.firstInstallmentDate||e.repaymentStartDate||e.expectedFirstRepaymentDate||null,ae=a(e.paidPrincipal??e.totalPrincipalPaid),oe=a(e.paidInterest??e.totalInterestPaid),se=a(e.paidFees??e.totalFeesPaid),ie=a(e.paidPenalty??e.totalPenaltyPaid);let $=a(e.interestAmount??e.totalInterest??e.expectedInterest??e.interest);const F=Number.isFinite(Number(e.outstandingPrincipal))?Number(e.outstandingPrincipal):u(f-ae),Z=Number.isFinite(Number(e.outstandingInterest))?Number(e.outstandingInterest):u($-oe),P=Number.isFinite(Number(e.outstandingFees))?Number(e.outstandingFees):u(a(e.totalFees)-se),z=Number.isFinite(Number(e.outstandingPenalty))?Number(e.outstandingPenalty):u(a(e.totalPenalty)-ie),I=e.totalOutstanding!=null?a(e.totalOutstanding):e.outstanding!=null?a(e.outstanding):u(F+Z+P+z),de=x=>{if(x==null)return null;if(typeof x=="string"){const ue=x.replace(/\s*%$/,"").trim();return Number.isFinite(Number(ue))?Number(ue):null}return Number.isFinite(Number(x))?Number(x):null},j=[e.annualInterestRate,e.interestRateYear,e.interestRateAnnual,e.interestRate,e.ratePerYear,e.rateAnnual,e.rate].map(de).find(x=>x!=null),Y=[e.monthlyInterestRate,e.interestRateMonth,e.ratePerMonth,e.rate_month].map(de).find(x=>x!=null);let k=null;if(j!=null)k=j>1?j/100:j;else if(Y!=null)k=(Y>1?Y/100:Y)*12;else if(f&&l&&$){const x=$/f/(l/12);Number.isFinite(x)&&x>=0&&(k=x)}!$&&f&&l&&k!=null&&($=Math.round(f*k*(l/12)));const ce=e.officerId||e.loanOfficerId||e.assignedOfficerId||e.disbursedBy||e.disbursed_by||((H=e.officer)==null?void 0:H.id)||null,M=ce&&n.officersById?n.officersById[String(ce)]:null,fe=e.officerName||e.loanOfficerName||e.disbursedByName||e.disbursed_by_name||((O=e.officer)==null?void 0:O.name)||M||"—",v=e.branchId||e.branch_id||((ge=e.Branch)==null?void 0:ge.id)||((xe=e.branch)==null?void 0:xe.id)||null,he=v&&n.branchesById?n.branchesById[String(v)]:null,A=e.branchName||((E=e.Branch)==null?void 0:E.name)||((_=e.branch)==null?void 0:_.name)||he||e.branchCode||"—",be=e.borrowerName??((we=e.Borrower)==null?void 0:we.name)??((Ne=e.borrower)==null?void 0:Ne.name)??"—",je=e.borrowerId??((W=e.Borrower)==null?void 0:W.id)??((D=e.borrower)==null?void 0:D.id)??void 0,ye=e.borrowerPhone??e.phone??((X=e.Borrower)==null?void 0:X.phone)??((De=e.borrower)==null?void 0:De.phone)??"—",T=e.productName??((ee=e.Product)==null?void 0:ee.name)??((B=e.product)==null?void 0:B.name)??"—";return{id:e.id,disbDate:Q(e.disbursementDate||e.disbursement_date||e.releaseDate||e.startDate||e.createdAt),borrower:be,borrowerId:je,phone:ye,product:T,principal:f,principalFmt:f?w(f,d):"—",interest:$,interestFmt:$?w($,d):"—",outPrin:F,outPrinFmt:F?w(F,d):"—",outInt:Z,outIntFmt:Z?w(Z,d):"—",outFee:P,outFeeFmt:P?w(P,d):"—",outPen:z,outPenFmt:z?w(z,d):"—",outstanding:I,outstandingFmt:I?w(I,d):"—",rateYear:k==null?"—":ht(k),duration:C,dueDate:Q(Pe),officer:fe,branch:A,status:(e.status||e.state||"—").toString(),currency:d}}},due:{columns:[{key:"date",header:"Due Date"},{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"installment",header:"Inst. #"},{key:"dueAmount",header:"Amount Due",align:"right"},{key:"dpd",header:"DPD",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["dueAmount"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=e.nextDueDate||e.upcomingDueDate;return{id:e.id,date:Q(u),borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",installment:i(e.nextInstallment||e.upcomingInstallment||null)||"—",dueAmount:i(e.nextDueAmount||e.upcomingDueAmount||0),dueAmountFmt:e.nextDueAmount||e.upcomingDueAmount?w(e.nextDueAmount||e.upcomingDueAmount,a):"—",dpd:i(e.dpd||e.daysPastDue||0),officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},missed:{columns:[{key:"lastDueDate",header:"Last Due"},{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"dpd",header:"DPD",align:"right"},{key:"arrears",header:"Arrears",align:"right"},{key:"outstanding",header:"Outstanding",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["arrears","outstanding"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.outstandingPrincipal),f=i(e.outstandingInterest),l=i(e.outstandingFees),h=i(e.outstandingPenalty),p=e.outstanding!=null?i(e.outstanding):u+f+l+h;return{id:e.id,lastDueDate:Q(e.lastDueDate||e.nextDueDate),borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",dpd:i(e.dpd||e.daysPastDue||0),arrears:i(e.arrears||e.totalArrears||e.outstandingArrears||0),outstanding:p,arrearsFmt:i(e.arrears||e.totalArrears||e.outstandingArrears||0)?w(i(e.arrears||e.totalArrears||e.outstandingArrears||0),a):"—",outstandingFmt:p?w(p,a):"—",officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},arrears:{columns:[{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"dpd",header:"DPD",align:"right"},{key:"arrears",header:"Arrears",align:"right"},{key:"penalty",header:"Penalty",align:"right"},{key:"outstanding",header:"Outstanding",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["arrears","penalty","outstanding"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.outstandingPrincipal),f=i(e.outstandingInterest),l=i(e.outstandingFees),h=i(e.outstandingPenalty),p=e.outstanding!=null?i(e.outstanding):u+f+l+h,N=i(e.arrears||e.totalArrears||e.outstandingArrears||0);return{id:e.id,borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",dpd:i(e.dpd||e.daysPastDue||0),arrears:N,penalty:h,outstanding:p,arrearsFmt:N?w(N,a):"—",penaltyFmt:h?w(h,a):"—",outstandingFmt:p?w(p,a):"—",officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},"no-repayments":{columns:[{key:"disbDate",header:"Disbursed"},{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"principal",header:"Principal",align:"right"},{key:"firstDue",header:"1st Due"},{key:"officer",header:"Officer"}],totalKeys:["principal"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.amount??e.principal??0);return{id:e.id,disbDate:Q(e.disbursementDate||e.releaseDate||e.startDate||e.createdAt),borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",principal:u,principalFmt:u?w(u,a):"—",firstDue:Q(e.firstDueDate||e.nextDueDate),officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},"past-maturity":{columns:[{key:"maturity",header:"Maturity"},{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"outstanding",header:"Outstanding",align:"right"},{key:"dpd",header:"DPD",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["outstanding"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.outstandingPrincipal),f=i(e.outstandingInterest),l=i(e.outstandingFees),h=i(e.outstandingPenalty),p=e.outstanding!=null?i(e.outstanding):u+f+l+h;return{id:e.id,maturity:Q(e.maturityDate||e.endDate||e.expectedMaturityDate),borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",outstanding:p,outstandingFmt:p?w(p,a):"—",dpd:i(e.dpd||e.daysPastDue||0),officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},"principal-outstanding":{columns:[{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"outPrin",header:"Outstanding Principal",align:"right"},{key:"outstanding",header:"Total Outstanding",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["outPrin","outstanding"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.outstandingPrincipal),f=i(e.outstandingInterest),l=i(e.outstandingFees),h=i(e.outstandingPenalty),p=e.outstanding!=null?i(e.outstanding):u+f+l+h;return{id:e.id,borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",outPrin:u,outstanding:p,outPrinFmt:u?w(u,a):"—",outstandingFmt:p?w(p,a):"—",officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},"1-month-late":{columns:[{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"dpd",header:"DPD",align:"right"},{key:"arrears",header:"Arrears",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["arrears"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.arrears||e.totalArrears||e.outstandingArrears||0);return{id:e.id,borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",dpd:i(e.dpd||e.daysPastDue||0),arrears:u,arrearsFmt:u?w(u,a):"—",officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}},"3-months-late":{columns:[{key:"borrower",header:"Borrower"},{key:"loanNumber",header:"Loan #"},{key:"product",header:"Product"},{key:"dpd",header:"DPD",align:"right"},{key:"arrears",header:"Arrears",align:"right"},{key:"outstanding",header:"Outstanding",align:"right"},{key:"officer",header:"Officer"}],totalKeys:["arrears","outstanding"],rowMap:e=>{const n=e.Borrower||e.borrower||{},d=e.Product||e.product||{},a=e.currency||"TZS",u=i(e.outstandingPrincipal),f=i(e.outstandingInterest),l=i(e.outstandingFees),h=i(e.outstandingPenalty),p=e.outstanding!=null?i(e.outstanding):u+f+l+h,N=i(e.arrears||e.totalArrears||e.outstandingArrears||0);return{id:e.id,borrower:n.name||e.borrowerName||"—",borrowerId:n.id,loanNumber:e.loanNumber||e.id,product:d.name||e.productName||"—",dpd:i(e.dpd||e.daysPastDue||0),arrears:N,outstanding:p,arrearsFmt:N?w(N,a):"—",outstandingFmt:p?w(p,a):"—",officer:e.officerName||e.officer&&e.officer.name||"—",currency:a}}}};function $t(){var Re;const e=it(),n=e.scope||e.status,d=dt(),{error:a}=ct(),[u,f]=ut(),[l,h]=b.useState([]),[p,N]=b.useState(0),[K,C]=b.useState(!1),[Pe,ae]=b.useState([]),[oe,se]=b.useState([]),[ie,$]=b.useState([]),[F,Z]=b.useState(u.get("q")||""),[P,z]=b.useState(u.get("productId")||""),[I,de]=b.useState(u.get("officerId")||""),[j,Y]=b.useState(u.get("branchId")||""),[k,ce]=b.useState(u.get("startDate")||""),[M,fe]=b.useState(u.get("endDate")||""),[v,he]=b.useState(u.get("minAmt")||""),[A,be]=b.useState(u.get("maxAmt")||""),je=Number(u.get("page")||1),ye=Number(u.get("pageSize")||25),[T,H]=b.useState(Math.max(1,je)),[O,ge]=b.useState([10,25,50,100].includes(ye)?ye:25),[xe,E]=b.useState(null),[_,we]=b.useState({open:!1,title:"",description:"",destructive:!1,onConfirm:null}),Ne=Xe[n]||"Loan Report",W=b.useRef(null),D=vt[n],X=new Date,De=new Date(X.getFullYear(),X.getMonth(),X.getDate());b.useEffect(()=>{(async()=>{var t,m,c;try{const y=(await U.get("/reports/filters")).data||{};ae(Array.isArray(y.products)?y.products:[]),se(Array.isArray(y.officers)?y.officers:[]),$(Array.isArray(y.branches)?y.branches:[]);return}catch{}try{const s=await U.get("/loan-products"),y=Array.isArray(s.data)?s.data:((t=s.data)==null?void 0:t.items)||[];ae(y)}catch{ae([])}try{const s=await U.get("/users",{params:{role:"loan_officer",pageSize:500}}),y=Array.isArray(s.data)?s.data:((m=s.data)==null?void 0:m.items)||[];se(y)}catch{se([])}try{const s=await U.get("/branches",{params:{pageSize:500}}),y=Array.isArray(s.data)?s.data:((c=s.data)==null?void 0:c.items)||[];$(y)}catch{$([])}})()},[]);const ee=async(t={})=>{var m;C(!0);try{const c={page:T,pageSize:O,scope:n};n==="disbursed"&&(c.status="disbursed");const s=F.trim();s&&(c.q=s),P&&(c.productId=P),I&&(c.officerId=I),j&&(c.branchId=j),k&&(c.startDate=k),M&&(c.endDate=M);const y=Number.isFinite(Number(v))&&`${v}`!="",S=Number.isFinite(Number(A))&&`${A}`!="";y&&(c.minAmount=Number(v)),S&&(c.maxAmount=Number(A));const re=await U.get("/loans",{params:c}),le=(Array.isArray(re.data)?re.data:Array.isArray((m=re.data)==null?void 0:m.items)?re.data.items:[]).map(o=>{var L,Ce,Te,Ee,_e,qe,Ue,Ke,Ze,ze,Ye,He,Ve,Ge,Qe,Je;return{...o,borrowerId:o.borrowerId??((L=o.Borrower)==null?void 0:L.id)??((Ce=o.borrower)==null?void 0:Ce.id)??o.clientId??null,borrowerName:o.borrowerName??((Te=o.Borrower)==null?void 0:Te.name)??((Ee=o.borrower)==null?void 0:Ee.name)??o.clientName??null,borrowerPhone:o.borrowerPhone??o.phone??((_e=o.Borrower)==null?void 0:_e.phone)??((qe=o.borrower)==null?void 0:qe.phone)??null,productId:o.productId??o.product_id??((Ue=o.Product)==null?void 0:Ue.id)??((Ke=o.product)==null?void 0:Ke.id)??null,productName:o.productName??((Ze=o.Product)==null?void 0:Ze.name)??((ze=o.product)==null?void 0:ze.name)??null,officerId:o.officerId??o.loanOfficerId??o.assignedOfficerId??o.disbursedBy??o.disbursed_by??((Ye=o.officer)==null?void 0:Ye.id)??null,officerName:o.officerName??((He=o.officer)==null?void 0:He.name)??null,branchId:o.branchId??((Ve=o.Branch)==null?void 0:Ve.id)??((Ge=o.branch)==null?void 0:Ge.id)??null,branchName:o.branchName??((Qe=o.Branch)==null?void 0:Qe.name)??((Je=o.branch)==null?void 0:Je.name)??null,nextDueDate:o.nextDueDate??o.firstDueDate??o.upcomingDueDate??o.dueDate??null,principalAmount:o.principalAmount??o.amount??o.principal??o.expectedPrincipal??null,interestAmount:o.interestAmount??o.totalInterest??o.expectedInterest??o.interest??null,totalOutstanding:o.totalOutstanding!=null?o.totalOutstanding:o.outstanding!=null?o.outstanding:null}}),G=new Map;for(const o of le){const L=o.id??o.loanId??o.loan_id;L&&(G.has(L)||G.set(L,o))}const q=(G.size?Array.from(G.values()):le).filter(o=>{const L=R[n];return L?L(o,{todayStart:De}):!0});h(q),N(q.length)}catch(c){console.error(c),a("Failed to load report."),h([]),N(0)}finally{C(!1)}if(!t.skipSyncUrl){const c=new URLSearchParams;F&&c.set("q",F),P&&c.set("productId",P),I&&c.set("officerId",I),j&&c.set("branchId",j),k&&c.set("startDate",k),M&&c.set("endDate",M),v&&c.set("minAmt",v),A&&c.set("maxAmt",A),c.set("page",String(T)),c.set("pageSize",String(O)),f(c)}};b.useEffect(()=>{ee({skipSyncUrl:!0}),E(null)},[n,T,O]);const B=b.useMemo(()=>{const t=k?new Date(k):null,m=M?new Date(M):null;m&&m.setHours(23,59,59,999);const c=F.trim().toLowerCase();return l.filter(s=>{var Ie,le,G,Ae;if(t||m){const q=s.disbursementDate||s.disbursement_date||s.releaseDate||s.startDate||s.createdAt||null,o=q?new Date(q):null;if(t&&(!o||o<t)||m&&(!o||o>m))return!1}if(P&&String(s.productId??s.product_id??((Ie=s.Product)==null?void 0:Ie.id)??((le=s.product)==null?void 0:le.id))!==String(P)||I&&String(s.officerId||s.loanOfficerId||s.disbursedBy||s.disbursed_by)!==String(I)||j&&String(s.branchId||((G=s.Branch)==null?void 0:G.id)||((Ae=s.branch)==null?void 0:Ae.id))!==String(j))return!1;const y=Number(s.principalAmount??s.amount??s.principal??0),S=Number.isFinite(Number(v))&&`${v}`!="",re=Number.isFinite(Number(A))&&`${A}`!="";if(S&&!(y>=Number(v))||re&&!(y<=Number(A)))return!1;if(c){const q=s.Borrower||s.borrower||{},o=s.Product||s.product||{};if(![q.name,q.phone,s.borrowerName,s.borrowerPhone,s.phone,o.name,s.productName,s.loanNumber,s.id].filter(Boolean).join(" ").toLowerCase().includes(c))return!1}return!0})},[l,F,P,I,j,k,M,v,A]),x=b.useMemo(()=>{const t={};for(const m of oe||[])t[String(m.id)]=m.name||m.email||m.phone||`Officer ${m.id}`;return t},[oe]),ue=b.useMemo(()=>{const t={};for(const m of ie||[])t[String(m.id)]=m.name||m.code||`Branch ${m.id}`;return t},[ie]),me=b.useMemo(()=>({officersById:x,branchesById:ue}),[x,ue]),$e=b.useMemo(()=>{if(p>l.length)return B;const t=(T-1)*O;return B.slice(t,t+O)},[B,T,O,l.length,p]),V=b.useMemo(()=>D?$e.map(t=>D.rowMap(t,me)):[],[$e,D,me]),tt=b.useMemo(()=>{if(!D)return{};const t={};for(const m of D.totalKeys||[])t[m]=0;for(const m of B.map(c=>D.rowMap(c,me)))for(const c of D.totalKeys||[])t[c]+=i(m[c]);return t},[B,D,me]),te=b.useMemo(()=>{if(!D)return[];const t=[...D.columns||[]],m=s=>V.length?V.every(y=>{const S=y[s];return S==null||S===""?!0:typeof S=="number"?S===0:!1}):!1,c=new Set(["disbDate","date","borrower","phone","product","rateYear","duration","dueDate","officer","branch","status","loanNumber","maturity"]);return t.filter(s=>c.has(s.key)?!0:!m(s.key))},[D,V]),ve=()=>D?B.map(t=>D.rowMap(t,me)).map(t=>{const m={};for(const c of te){const s=t[`${c.key}Fmt`]!=null?t[`${c.key}Fmt`]:t[c.key]!=null?t[c.key]:"";m[c.header]=s===0||s==="0"?"0":s||""}return m}):[],Me=(Xe[n]||"loan-report").toLowerCase().replace(/\s+/g,"-"),Be=()=>{const t=new URLSearchParams;return F.trim()&&t.set("q",F.trim()),P&&t.set("productId",P),I&&t.set("officerId",I),j&&t.set("branchId",j),k&&t.set("startDate",k),M&&t.set("endDate",M),v&&t.set("minAmount",String(v)),A&&t.set("maxAmount",String(A)),t.set("scope",n),t.toString()},Oe=async t=>{try{return await(U.head?U.head(t):U.get(t,{method:"HEAD"})),window.open(t,"_blank","noopener,noreferrer"),!0}catch{return!1}},rt=async()=>{const m=`/reports/loans/export/csv?${Be()}`;await Oe(m)||xt(ve(),Me)},nt=()=>{wt(ve(),Me)},at=async()=>{const m=`/reports/loans/export/pdf?${Be()}`;await Oe(m)||Nt(ve())},ot=t=>d(`/loans/${t}`),st=t=>d(`/repayments/new?loanId=${t}`),Le=()=>{Z(""),z(""),de(""),Y(""),ce(""),fe(""),he(""),be(""),H(1),f(new URLSearchParams),setTimeout(()=>ee({skipSyncUrl:!0}),0)};return b.useEffect(()=>{const t=m=>{W.current&&(W.current.contains(m.target)||E(null))};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),D?r.jsxs("div",{className:g.page,children:[r.jsx("style",{children:`
        select.ms-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; }
        select.ms-select::-ms-expand { display: none; }
      `}),r.jsxs("div",{className:"mb-5 flex flex-col gap-2 md:flex-row md:items-end md:justify-between",children:[r.jsxs("div",{children:[r.jsx("h2",{className:g.h1,children:Ne}),r.jsxs("div",{className:g.sub,children:["Showing ",Se(B.length)," of ",Se(p)]})]}),r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("button",{onClick:rt,className:g.btnGhost,children:"Export CSV"}),r.jsx("button",{onClick:nt,className:g.btnGhost,children:"Export Excel"}),r.jsx("button",{onClick:at,className:g.btnGhost,children:"Export PDF"})]})]}),r.jsxs("div",{className:`${g.card} p-4 mb-6`,children:[r.jsxs("div",{className:"flex items-center justify-between mb-3",children:[r.jsxs("div",{className:"inline-flex items-center gap-2 text-slate-800 font-semibold",children:[r.jsx(lt,{className:"w-4 h-4"})," Report Filters"]}),r.jsx("button",{onClick:Le,className:"text-sm underline decoration-slate-300 hover:decoration-slate-600",children:"Clear all"})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-3",children:[r.jsx(pe,{className:"lg:col-span-2",leadingIcon:r.jsx(pt,{className:g.fieldIcon}),placeholder:"Search borrower / phone / product / loan #",value:F,onChange:t=>Z(t.target.value)}),r.jsxs(Fe,{value:P,onChange:t=>z(t.target.value),children:[r.jsx("option",{value:"",children:"Product: All"}),Pe.map(t=>r.jsxs("option",{value:t.id,children:[t.name,t.code?` (${t.code})`:""]},t.id))]}),r.jsxs(Fe,{value:I,onChange:t=>de(t.target.value),children:[r.jsx("option",{value:"",children:"Officer: All"}),oe.map(t=>r.jsx("option",{value:t.id,children:t.name||t.email},t.id))]}),r.jsxs(Fe,{value:j,onChange:t=>Y(t.target.value),children:[r.jsx("option",{value:"",children:"Branch: All"}),ie.map(t=>r.jsx("option",{value:t.id,children:t.name||t.code},t.id))]}),r.jsx(pe,{type:"date",value:k,onChange:t=>ce(t.target.value)}),r.jsx(pe,{type:"date",value:M,onChange:t=>fe(t.target.value)}),r.jsx(pe,{type:"number",placeholder:"Min Amount",value:v,onChange:t=>he(t.target.value)}),r.jsx(pe,{type:"number",placeholder:"Max Amount",value:A,onChange:t=>be(t.target.value)})]}),r.jsxs("div",{className:"mt-3 flex gap-2",children:[r.jsx("button",{onClick:()=>{H(1),ee()},className:g.btnPrimary,children:"Apply Filters"}),r.jsx("button",{onClick:Le,className:g.btn,children:"Reset"})]})]}),r.jsx("div",{className:`${g.card} overflow-x-auto`,ref:W,children:r.jsxs("table",{className:"min-w-full text-sm",children:[r.jsx("thead",{children:r.jsxs("tr",{children:[te.map(t=>r.jsx("th",{className:`${g.th} ${t.align==="right"?"text-right":""}`,children:t.header},t.key)),r.jsx("th",{className:g.th,children:"Action"})]})}),r.jsx("tbody",{children:K?r.jsx("tr",{children:r.jsx("td",{colSpan:te.length+1,className:`${g.td} text-center py-10 text-slate-600`,children:"Loading…"})}):V.length===0?r.jsx("tr",{children:r.jsx("td",{colSpan:te.length+1,className:`${g.td} text-center py-10 text-slate-600`,children:"No records match this report."})}):V.map(t=>r.jsxs("tr",{className:"hover:bg-slate-50",children:[te.map(m=>{const c=t[m.key],s=t[`${m.key}Fmt`],y=s??(c==null||c===""||typeof c=="number"&&c===0?"—":c);let S=y;return m.key==="borrower"&&t.borrowerId&&(S=r.jsx(mt,{to:`/borrowers/${t.borrowerId}`,className:"text-indigo-700 hover:underline font-semibold",children:y})),r.jsx("td",{className:`${g.td} ${m.align==="right"?"text-right":""}`,children:S},m.key)}),r.jsx("td",{className:`${g.td} whitespace-nowrap`,children:r.jsxs("div",{className:"relative inline-block",children:[r.jsx("button",{className:"px-2 py-1 rounded border border-slate-300 hover:bg-slate-50 font-medium",onClick:()=>E(m=>m===t.id?null:t.id),children:"Actions ▾"}),xe===t.id&&r.jsxs("div",{className:"absolute right-0 mt-1 w-56 bg-white border border-slate-200 rounded-lg shadow z-10 overflow-hidden",children:[r.jsx("button",{className:"w-full text-left px-3 py-2 hover:bg-slate-50",onClick:()=>{E(null),ot(t.id)},children:"View Loan"}),r.jsx("button",{className:"w-full text-left px-3 py-2 hover:bg-slate-50",onClick:()=>{E(null),st(t.id)},children:"Record Repayment"})]})]})})]},t.id))}),!K&&B.length>0&&((Re=D.totalKeys)==null?void 0:Re.length)>0&&r.jsx("tfoot",{children:r.jsxs("tr",{className:"bg-slate-50",children:[te.map((t,m)=>{var S;if(m===0)return r.jsx("td",{className:`${g.td} font-semibold`,children:"Totals:"},t.key);const c=(D.totalKeys||[]).includes(t.key),s=c?tt[t.key]:"",y=s!=null&&s!==""?(S=V[0])!=null&&S.currency?w(s,V[0].currency):Se(s):"";return r.jsx("td",{className:`${g.td} ${t.align==="right"?"text-right":""} font-semibold`,children:c?y:""},t.key)}),r.jsx("td",{className:g.td})]})})]})}),r.jsx(Dt,{page:T,pageSize:O,total:p||B.length,onPageChange:t=>H(t),onPageSizeChange:t=>{ge(t),H(1)}}),r.jsx(kt,{open:_.open,title:_.title,description:_.description,destructive:_.destructive,onConfirm:_.onConfirm,onClose:()=>we(t=>({...t,open:!1}))})]}):r.jsxs("div",{className:g.page,children:[r.jsx("h2",{className:g.h1,children:"Unknown Report"}),r.jsxs("p",{className:"text-slate-600 mt-2",children:["The report “",n,"” is not configured."]})]})}export{$t as default};

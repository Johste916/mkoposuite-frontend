import{r as y,j as e,y as R,L as f}from"./index-CM-KCFgk.js";import{r as u}from"./repayments-B1myxGdw.js";import"./index-Cjud5Sml.js";const l={posted:"repayment:posted",approved:"repayment:approved",rejected:"repayment:rejected",bulk:"repayment:bulk-posted"},N=(r,d)=>{try{window.dispatchEvent(new CustomEvent(r,{detail:d}))}catch{}},b=r=>Number(r||0).toLocaleString();function I({loan:r}){var m;if(!r)return null;const d=r.reference||`L-${r.id}`,h=((m=r.Borrower)==null?void 0:m.name)||"",j=async x=>{try{await navigator.clipboard.writeText(x)}catch{}};return e.jsxs("div",{className:"mt-3 text-xs space-y-2 bg-gray-50 dark:bg-gray-900 border rounded p-3",children:[e.jsx("p",{className:"font-medium",children:"Payment Instructions"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{children:"Mobile Money:"}),e.jsxs("code",{className:"block p-2 bg-white dark:bg-black rounded border",children:["Use reference: ",d," (borrower: ",h,")"]}),e.jsx("button",{className:"mt-1 text-blue-600",onClick:()=>j(d),children:"Copy Ref"})]}),e.jsxs("div",{children:[e.jsx("p",{children:"Bank Deposit:"}),e.jsxs("code",{className:"block p-2 bg-white dark:bg-black rounded border",children:['Include narration "',d,'" in the transfer memo']}),e.jsx("button",{className:"mt-1 text-blue-600",onClick:()=>j(d),children:"Copy Ref"})]})]})]})}function D(){const[r,d]=y.useState([]),[h,j]=y.useState(!1),[m,x]=y.useState(null),[w,v]=y.useState({}),g=async()=>{j(!0);try{const{data:t}=await u.pendingApprovals();d(Array.isArray(t)?t:[])}catch{d([]),alert("Failed to fetch pending repayments")}finally{j(!1)}};y.useEffect(()=>{g();const t=()=>g();return window.addEventListener(l.posted,t),window.addEventListener(l.approved,t),window.addEventListener(l.rejected,t),window.addEventListener(l.bulk,t),()=>{window.removeEventListener(l.posted,t),window.removeEventListener(l.approved,t),window.removeEventListener(l.rejected,t),window.removeEventListener(l.bulk,t)}},[]);const k=async t=>{var a,c,i;if(confirm("Approve this repayment?")){x(t);try{const s=r.find(n=>n.id===t);if(await u.approve(t),d(n=>n.filter(o=>o.id!==t)),s!=null&&s.loanId||(a=s==null?void 0:s.Loan)!=null&&a.id){const n=s.loanId||s.Loan.id;N(l.approved,{loanId:n,repaymentId:t})}else N(l.approved,{repaymentId:t})}catch(s){alert(((i=(c=s==null?void 0:s.response)==null?void 0:c.data)==null?void 0:i.error)||"Approve failed")}finally{x(null)}}},A=async t=>{var c,i;const a=prompt("Reason (optional):")||"";x(t);try{await u.reject(t,a),d(s=>s.filter(n=>n.id!==t)),N(l.rejected,{repaymentId:t})}catch(s){alert(((i=(c=s==null?void 0:s.response)==null?void 0:c.data)==null?void 0:i.error)||"Reject failed")}finally{x(null)}},L=async t=>{var c,i;const a=t.id;if((c=t.allocation)!=null&&c.length){v(s=>({...s,[a]:{allocations:t.allocation,totals:{}}}));return}try{const s=Number(t.amount??t.amountPaid??0),n=(t.date||t.paymentDate||t.paidAt||new Date().toISOString()).slice(0,10),{data:o}=await u.previewAllocation({loanId:t.loanId||((i=t.Loan)==null?void 0:i.id),amount:s,date:n});v(p=>({...p,[a]:{allocations:o.allocations||[],totals:o.totals||{}}}))}catch{alert("Failed to preview allocation")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Approve Repayments"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Review & approve pending repayment entries."})]}),e.jsx("button",{onClick:g,className:"px-3 py-2 rounded border hover:bg-gray-50",disabled:h,children:h?"Refreshing…":"Refresh"})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6",children:e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Amount"}),e.jsx("th",{className:"text-left p-3",children:"Method"}),e.jsx("th",{className:"text-left p-3",children:"Ref"}),e.jsx("th",{className:"text-left p-3",children:"Borrower"}),e.jsx("th",{className:"text-left p-3",children:"Loan"}),e.jsx("th",{className:"text-right p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[!h&&r.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4 text-gray-500",children:"No pending repayments."})}),r.map(t=>{var o;const a=t.Loan||{},c=a.Borrower||{},i=t.date||t.paymentDate||t.paidAt||t.createdAt||"",s=t.currency||a.currency||"TZS",n=w[t.id];return e.jsxs(R.Fragment,{children:[e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:String(i).slice(0,10)}),e.jsxs("td",{className:"p-3",children:[s," ",b(t.amount??t.amountPaid)]}),e.jsx("td",{className:"p-3",children:t.method||"—"}),e.jsx("td",{className:"p-3",children:t.reference||"—"}),e.jsx("td",{className:"p-3",children:c.name||"—"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:a.reference||`L-${a.id}`}),!!a.id&&e.jsx(f,{to:`/loans/${a.id}`,target:"_blank",className:"text-blue-600 hover:underline",children:"open"})]})}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>L(t),children:"Preview Allocation"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-60",onClick:()=>k(t.id),disabled:m===t.id,children:m===t.id?"Working…":"Approve"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",onClick:()=>A(t.id),disabled:m===t.id,children:"Reject"}),e.jsx(f,{to:`/repayments/receipts?id=${t.id}`,className:"px-3 py-1.5 rounded border hover:bg-gray-50",target:"_blank",children:"View Receipt"})]})})]}),n&&e.jsx("tr",{className:"bg-gray-50/60",children:e.jsx("td",{colSpan:7,className:"p-3",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm mb-2",children:"Allocation"}),e.jsx("div",{className:"overflow-x-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"p-2 text-left",children:"Period"}),e.jsx("th",{className:"p-2 text-right",children:"Principal"}),e.jsx("th",{className:"p-2 text-right",children:"Interest"}),e.jsx("th",{className:"p-2 text-right",children:"Fees"}),e.jsx("th",{className:"p-2 text-right",children:"Penalties"})]})}),e.jsxs("tbody",{children:[(n.allocations||[]).map((p,E)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:p.period}),e.jsx("td",{className:"p-2 text-right",children:b(p.principal)}),e.jsx("td",{className:"p-2 text-right",children:b(p.interest)}),e.jsx("td",{className:"p-2 text-right",children:b(p.fees)}),e.jsx("td",{className:"p-2 text-right",children:b(p.penalties)})]},E)),!((o=n.allocations)!=null&&o.length)&&e.jsx("tr",{children:e.jsx("td",{className:"p-2",colSpan:5,children:"No allocation needed."})})]})]})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm mb-2",children:"Helper"}),e.jsx(I,{loan:a})]})]})})})]},t.id)}),h&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4",children:"Loading…"})})]})]})})})]})}export{D as default};

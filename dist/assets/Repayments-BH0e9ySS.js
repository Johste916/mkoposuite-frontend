import{u as se,r as t,j as e,c as g}from"./index-BRummDuu.js";const d=n=>Number(n||0).toLocaleString(),ae=({title:n,desc:c,control:f})=>e.jsxs("div",{className:"flex items-center justify-between border rounded-xl p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n}),c&&e.jsx("p",{className:"text-sm text-gray-500",children:c})]}),f]}),q=({status:n})=>{const c=n==="overdue"?"bg-red-600 text-white":n==="paid"||n==="closed"?"bg-green-100 text-green-800 border border-green-300":n==="partial"?"bg-yellow-50 text-yellow-800 border border-yellow-300":"bg-gray-100 text-gray-800 border";return e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs capitalize ${c}`,children:n||"—"})},te=["pending","approved","rejected","disbursed","closed"];function re(){var F;const n=se(),[c,f]=t.useState(!1),[U,A]=t.useState(!1),[J,K]=t.useState([]),[Q,V]=t.useState([]),[y,k]=t.useState(""),[b,R]=t.useState(""),[x,D]=t.useState("active"),[h,$]=t.useState(""),[m,P]=t.useState("next_30_days"),[p,T]=t.useState(!1),[B,I]=t.useState([]),[u,j]=t.useState(1),[w,_]=t.useState(0),[N,G]=t.useState(10),[H,C]=t.useState(!1),[r,W]=t.useState(null),[Z,M]=t.useState([]),[O,E]=t.useState([]),[v,z]=t.useState(!1),L=t.useMemo(()=>Math.max(1,Math.ceil(Number(w||0)/Number(N||1))),[w,N]),X=async()=>{var s,a;A(!0);try{const[l,o]=await Promise.all([g.get("/branches"),g.get("/users",{params:{role:"loan_officer",pageSize:500}})]);K(Array.isArray(l.data)?l.data:((s=l.data)==null?void 0:s.items)||[]),V(Array.isArray(o.data)?o.data:((a=o.data)==null?void 0:a.items)||[])}catch{}finally{A(!1)}},S=async()=>{f(!0);try{const s={page:u,pageSize:N};y&&(s.branchId=y),b&&(s.officerId=b),h!=null&&h.trim()&&(s.q=h.trim()),m&&m!=="all"&&(s.dueRange=m),!p&&te.includes(String(x))&&(s.status=x);const{data:a}=await g.get("/loans",{params:s});let l=Array.isArray(a)?a:(a==null?void 0:a.items)||[];if(!p){const o=String(x).toLowerCase();o==="active"?l=l.filter(i=>String(i.status||i.state||"").toLowerCase()==="disbursed"):o==="delinquent"?l=l.filter(i=>String(i.nextDueStatus||"").toLowerCase()==="overdue"||Number(i.dpd||0)>0||Number(i.arrears||0)>0):o==="closed"&&(l=l.filter(i=>String(i.status||"").toLowerCase()==="closed"))}I(l),_(Number((a==null?void 0:a.total)||l.length||0))}catch{I([]),_(0)}finally{f(!1)}},Y=async s=>{W(s),C(!0),z(!0);try{const[a,l]=await Promise.all([g.get(`/loans/${s.id}/schedule`),g.get(`/loans/${s.id}/repayments`)]);M(Array.isArray(a.data)?a.data:[]),E(Array.isArray(l.data)?l.data:[])}catch{M([]),E([])}finally{z(!1)}};t.useEffect(()=>{X()},[]),t.useEffect(()=>{S()},[u,N,y,b,x,m,p]);const ee=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),j(1),S()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Schedule"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Browse upcoming installments, see overdue items, and post manual repayments."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50 disabled:opacity-60",onClick:()=>S(),disabled:c||U,children:c?"Refreshing…":"Refresh"}),e.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n("/repayments/new"),children:"Manual Repayment"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Filters"}),e.jsxs("form",{onSubmit:ee,className:"grid md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"space-y-1 md:col-span-2",children:[e.jsx("label",{className:"text-sm",children:"Search (Borrower / Loan Ref)"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"e.g., Juma / L-000123",value:h,onChange:s=>$(s.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Branch"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:y,onChange:s=>k(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),J.map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Loan Officer"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:b,onChange:s=>R(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),Q.map(s=>e.jsx("option",{value:String(s.id),children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()||s.email},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Due Range"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:m,onChange:s=>P(s.target.value),children:[e.jsx("option",{value:"next_7_days",children:"Next 7 days"}),e.jsx("option",{value:"next_30_days",children:"Next 30 days"}),e.jsx("option",{value:"overdue",children:"Overdue only"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{className:`${p?"opacity-60 pointer-events-none":""} space-y-1`,children:[e.jsx("label",{className:"text-sm",children:"Status"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:x,onChange:s=>D(s.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"delinquent",children:"Delinquent"}),e.jsx("option",{value:"closed",children:"Closed"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(ae,{title:"Include Closed",control:e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",checked:p,onChange:s=>T(s.target.checked)})})})}),e.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>{k(""),R(""),D("active"),P("next_30_days"),T(!1),$(""),j(1),S()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Search"})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loans"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Page size"}),e.jsx("select",{className:"border rounded px-2 py-1 text-sm",value:String(N),onChange:s=>{G(Number(s.target.value)),j(1)},children:[10,20,50].map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Loan Ref"}),e.jsx("th",{className:"text-left p-3",children:"Borrower"}),e.jsx("th",{className:"text-left p-3",children:"Outstanding"}),e.jsx("th",{className:"text-left p-3",children:"Next Due"}),e.jsx("th",{className:"text-left p-3",children:"Officer"}),e.jsx("th",{className:"text-left p-3",children:"Status"}),e.jsx("th",{className:"text-right p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[!c&&B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4 text-gray-500",children:"No loans found."})}),B.map(s=>{var a,l;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.reference||`L-${s.id}`}),e.jsx("td",{className:"p-3",children:s.borrowerName||((a=s.Borrower)==null?void 0:a.name)}),e.jsxs("td",{className:"p-3",children:[s.currency||"TZS"," ",d(s.outstanding??s.balance??0)]}),e.jsx("td",{className:"p-3",children:s.nextDueDate?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.nextDueDate}),s.nextDueStatus&&e.jsx(q,{status:s.nextDueStatus})]}):"—"}),e.jsx("td",{className:"p-3",children:s.officerName||((l=s.officer)==null?void 0:l.name)||"—"}),e.jsx("td",{className:"p-3",children:s.state||s.status||"active"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>Y(s),children:"View Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${s.id}`),children:"Add Repayment"})]})})]},s.id)}),c&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4",children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Page ",u," of ",L," • ",w," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:u<=1,onClick:()=>j(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:u>=L,onClick:()=>j(s=>Math.min(L,s+1)),children:"Next"})]})]})]}),H&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>C(!1)}),e.jsxs("div",{className:"absolute inset-y-0 right-0 w-full sm:max-w-3xl bg-white dark:bg-gray-900 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loan Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>C(!1),children:"Close"})]}),r?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-lg font-semibold",children:r.reference||`L-${r.id}`}),e.jsxs("p",{className:"text-sm text-gray-600",children:[r.borrowerName||((F=r.Borrower)==null?void 0:F.name)," •"," ",r.currency||"TZS"," ",d(r.principal||r.amount||0)]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${r.id}`),children:"Add Repayment"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>window.open(`/loans/${r.id}`,"_blank"),children:"Open Loan"})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Installments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"#"}),e.jsx("th",{className:"text-left p-3",children:"Due Date"}),e.jsx("th",{className:"text-left p-3",children:"Principal"}),e.jsx("th",{className:"text-left p-3",children:"Interest"}),e.jsx("th",{className:"text-left p-3",children:"Fees"}),e.jsx("th",{className:"text-left p-3",children:"Total"}),e.jsx("th",{className:"text-left p-3",children:"Paid"}),e.jsx("th",{className:"text-left p-3",children:"Penalty"}),e.jsx("th",{className:"text-left p-3",children:"Status"})]})}),e.jsxs("tbody",{children:[v&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4",children:"Loading…"})}),!v&&Z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500",children:"No schedule entries."})}),Z.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.period??a+1}),e.jsx("td",{className:"p-3",children:s.dueDate}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.principal)]}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.interest)]}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.fees)]}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.total)]}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.paid)]}),e.jsx("td",{className:"p-3",children:s.penalty?`${r.currency||"TZS"} ${d(s.penalty)}`:"—"}),e.jsx("td",{className:"p-3",children:e.jsx(q,{status:s.status||"upcoming"})})]},`${s.period}-${s.dueDate}`))]})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Repayments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Amount"}),e.jsx("th",{className:"text-left p-3",children:"Method"}),e.jsx("th",{className:"text-left p-3",children:"Reference"}),e.jsx("th",{className:"text-left p-3",children:"Posted By"})]})}),e.jsxs("tbody",{children:[v&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4",children:"Loading…"})}),!v&&O.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-gray-500",children:"No repayments yet."})}),O.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.date}),e.jsxs("td",{className:"p-3",children:[r.currency||"TZS"," ",d(s.amount||0)]}),e.jsx("td",{className:"p-3",children:s.method||"—"}),e.jsx("td",{className:"p-3",children:s.ref||s.reference||"—"}),e.jsx("td",{className:"p-3",children:s.postedBy||"—"})]},s.id))]})]})})]})]}):e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"No loan selected."})]})]})]})}export{re as default};

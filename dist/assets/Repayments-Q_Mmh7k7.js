import{u as ee,r as t,j as e,c as p}from"./index-CNQNOAHr.js";const d=n=>Number(n||0).toLocaleString(),se=({title:n,desc:c,control:u})=>e.jsxs("div",{className:"flex items-center justify-between border rounded-xl p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n}),c&&e.jsx("p",{className:"text-sm text-gray-500",children:c})]}),u]}),z=({status:n})=>{const c=n==="overdue"?"bg-red-600 text-white":n==="paid"||n==="closed"?"bg-green-100 text-green-800 border border-green-300":n==="partial"?"bg-yellow-50 text-yellow-800 border border-yellow-300":"bg-gray-100 text-gray-800 border";return e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs capitalize ${c}`,children:n||"—"})};function te(){var M;const n=ee(),[c,u]=t.useState(!1),[E,L]=t.useState(!1),[F,q]=t.useState([]),[J,Q]=t.useState([]),[j,k]=t.useState(""),[N,R]=t.useState(""),[f,A]=t.useState("active"),[i,D]=t.useState(""),[o,$]=t.useState("next_30_days"),[g,P]=t.useState(!1),[I,V]=t.useState([]),[x,h]=t.useState(1),[v,G]=t.useState(0),[m,H]=t.useState(10),[K,S]=t.useState(!1),[l,U]=t.useState(null),[B,T]=t.useState([]),[_,Z]=t.useState([]),[y,O]=t.useState(!1),w=t.useMemo(()=>Math.max(1,Math.ceil(Number(v||0)/Number(m||1))),[v,m]),W=async()=>{var s,a;L(!0);try{const[r,C]=await Promise.all([p.get("/branches"),p.get("/users",{params:{role:"loan_officer",pageSize:500}})]);q(Array.isArray(r.data)?r.data:((s=r.data)==null?void 0:s.items)||[]),Q(Array.isArray(C.data)?C.data:((a=C.data)==null?void 0:a.items)||[])}catch{}finally{L(!1)}},b=async()=>{u(!0);try{const s={page:x,pageSize:m};j&&(s.branchId=j),N&&(s.officerId=N),i!=null&&i.trim()&&(s.q=i.trim()),o&&o!=="all"&&(s.dueRange=o),s.status=g?"all":f;const{data:a}=await p.get("/loans",{params:s}),r=Array.isArray(a)?a:(a==null?void 0:a.items)||[];V(r),G(Number((a==null?void 0:a.total)||r.length||0))}catch{}finally{u(!1)}},X=async s=>{U(s),S(!0),O(!0);try{const[a,r]=await Promise.all([p.get(`/loans/${s.id}/schedule`),p.get(`/loans/${s.id}/repayments`)]);T(Array.isArray(a.data)?a.data:[]),Z(Array.isArray(r.data)?r.data:[])}catch{T([]),Z([])}finally{O(!1)}};t.useEffect(()=>{W()},[]),t.useEffect(()=>{b()},[x,m,j,N,f,o,g]);const Y=s=>{var a;(a=s==null?void 0:s.preventDefault)==null||a.call(s),h(1),b()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Repayment Schedule"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Browse upcoming installments, see overdue items, and post manual repayments."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border hover:bg-gray-50 disabled:opacity-60",onClick:()=>b(),disabled:c||E,children:c?"Refreshing…":"Refresh"}),e.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n("/repayments/new"),children:"Manual Repayment"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Filters"}),e.jsxs("form",{onSubmit:Y,className:"grid md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"space-y-1 md:col-span-2",children:[e.jsx("label",{className:"text-sm",children:"Search (Borrower / Loan Ref)"}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"e.g., Juma / L-000123",value:i,onChange:s=>D(s.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Branch"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:j,onChange:s=>k(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),F.map(s=>e.jsx("option",{value:String(s.id),children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Loan Officer"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:N,onChange:s=>R(s.target.value),children:[e.jsx("option",{value:"",children:"All"}),J.map(s=>e.jsx("option",{value:String(s.id),children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()||s.email},s.id))]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Due Range"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:o,onChange:s=>$(s.target.value),children:[e.jsx("option",{value:"next_7_days",children:"Next 7 days"}),e.jsx("option",{value:"next_30_days",children:"Next 30 days"}),e.jsx("option",{value:"overdue",children:"Overdue only"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsxs("div",{className:`${g?"opacity-60 pointer-events-none":""} space-y-1`,children:[e.jsx("label",{className:"text-sm",children:"Status"}),e.jsxs("select",{className:"w-full border rounded px-3 py-2",value:f,onChange:s=>A(s.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"delinquent",children:"Delinquent"}),e.jsx("option",{value:"closed",children:"Closed"}),e.jsx("option",{value:"all",children:"All"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(se,{title:"Include Closed",control:e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",checked:g,onChange:s=>P(s.target.checked)})})})}),e.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-2 rounded border hover:bg-gray-50",onClick:()=>{k(""),R(""),A("active"),$("next_30_days"),P(!1),D(""),h(1),b()},children:"Reset"}),e.jsx("button",{type:"submit",className:"px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Search"})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loans"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Page size"}),e.jsx("select",{className:"border rounded px-2 py-1 text-sm",value:String(m),onChange:s=>{H(Number(s.target.value)),h(1)},children:[10,20,50].map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Loan Ref"}),e.jsx("th",{className:"text-left p-3",children:"Borrower"}),e.jsx("th",{className:"text-left p-3",children:"Outstanding"}),e.jsx("th",{className:"text-left p-3",children:"Next Due"}),e.jsx("th",{className:"text-left p-3",children:"Officer"}),e.jsx("th",{className:"text-left p-3",children:"Status"}),e.jsx("th",{className:"text-right p-3",children:"Actions"})]})}),e.jsxs("tbody",{children:[!c&&I.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4 text-gray-500",children:"No loans found."})}),I.map(s=>{var a,r;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.reference||`L-${s.id}`}),e.jsx("td",{className:"p-3",children:s.borrowerName||((a=s.Borrower)==null?void 0:a.name)}),e.jsxs("td",{className:"p-3",children:[s.currency||"TZS"," ",d(s.outstanding??s.balance??0)]}),e.jsx("td",{className:"p-3",children:s.nextDueDate?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.nextDueDate}),s.nextDueStatus&&e.jsx(z,{status:s.nextDueStatus})]}):"—"}),e.jsx("td",{className:"p-3",children:s.officerName||((r=s.officer)==null?void 0:r.name)||"—"}),e.jsx("td",{className:"p-3",children:s.state||s.status||"active"}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>X(s),children:"View Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${s.id}`),children:"Add Repayment"})]})})]},s.id)}),c&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-4",children:"Loading…"})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Page ",x," of ",w," • ",v," total"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:x<=1,onClick:()=>h(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50 disabled:opacity-60",disabled:x>=w,onClick:()=>h(s=>Math.min(w,s+1)),children:"Next"})]})]})]}),K&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>S(!1)}),e.jsxs("div",{className:"absolute inset-y-0 right-0 w-full sm:max-w-3xl bg-white dark:bg-gray-900 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Loan Schedule"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>S(!1),children:"Close"})]}),l?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-lg font-semibold",children:l.reference||`L-${l.id}`}),e.jsxs("p",{className:"text-sm text-gray-600",children:[l.borrowerName||((M=l.Borrower)==null?void 0:M.name)," •"," ",l.currency||"TZS"," ",d(l.principal||l.amount||0)]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:()=>n(`/repayments/new?loanId=${l.id}`),children:"Add Repayment"}),e.jsx("button",{className:"px-3 py-1.5 rounded border hover:bg-gray-50",onClick:()=>window.open(`/loans/${l.id}`,"_blank"),children:"Open Loan"})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Installments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"#"}),e.jsx("th",{className:"text-left p-3",children:"Due Date"}),e.jsx("th",{className:"text-left p-3",children:"Principal"}),e.jsx("th",{className:"text-left p-3",children:"Interest"}),e.jsx("th",{className:"text-left p-3",children:"Fees"}),e.jsx("th",{className:"text-left p-3",children:"Total"}),e.jsx("th",{className:"text-left p-3",children:"Paid"}),e.jsx("th",{className:"text-left p-3",children:"Penalty"}),e.jsx("th",{className:"text-left p-3",children:"Status"})]})}),e.jsxs("tbody",{children:[y&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4",children:"Loading…"})}),!y&&B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500",children:"No schedule entries."})}),B.map((s,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.period??a+1}),e.jsx("td",{className:"p-3",children:s.dueDate}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.principal)]}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.interest)]}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.fees)]}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.total)]}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.paid)]}),e.jsx("td",{className:"p-3",children:s.penalty?`${l.currency||"TZS"} ${d(s.penalty)}`:"—"}),e.jsx("td",{className:"p-3",children:e.jsx(z,{status:s.status||"upcoming"})})]},`${s.period}-${s.dueDate}`))]})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium",children:"Repayments"}),e.jsx("div",{className:"overflow-x-auto border rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"text-left p-3",children:"Date"}),e.jsx("th",{className:"text-left p-3",children:"Amount"}),e.jsx("th",{className:"text-left p-3",children:"Method"}),e.jsx("th",{className:"text-left p-3",children:"Reference"}),e.jsx("th",{className:"text-left p-3",children:"Posted By"})]})}),e.jsxs("tbody",{children:[y&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4",children:"Loading…"})}),!y&&_.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-4 text-gray-500",children:"No repayments yet."})}),_.map(s=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:s.date}),e.jsxs("td",{className:"p-3",children:[l.currency||"TZS"," ",d(s.amount||0)]}),e.jsx("td",{className:"p-3",children:s.method||"—"}),e.jsx("td",{className:"p-3",children:s.ref||s.reference||"—"}),e.jsx("td",{className:"p-3",children:s.postedBy||"—"})]},s.id))]})]})})]})]}):e.jsx("div",{className:"p-4 text-sm text-gray-500",children:"No loan selected."})]})]})]})}export{te as default};

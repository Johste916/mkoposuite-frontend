import{u as me,r as i,j as t,L as pe,g as _}from"./index-CGp3nliO.js";import{E as be}from"./jspdf.es.min-CrbPyhzb.js";import"./jspdf.plugin.autotable-CfO62xhj.js";import{C as ge}from"./index-LC14GhOs.js";const s={page:"p-4 md:p-6 lg:p-8 space-y-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-2xl md:text-3xl font-extrabold tracking-tight",card:"card rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)] shadow",kpi:"p-4 rounded-xl border-2 border-[var(--border-strong)] bg-[var(--card)]",input:"input",primary:"inline-flex items-center gap-2 px-3 py-2 rounded-lg font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]",tableWrap:"overflow-x-auto rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)]",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide font-semibold px-3 py-2 border border-[var(--border)] text-[var(--fg)]/90",td:"px-3 py-2 border border-[var(--border)] text-sm",actionLink:"inline-flex items-center gap-1 font-extrabold text-[var(--primary)] underline underline-offset-4 decoration-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]"},O=r=>Array.isArray(r)?r:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.rows)?r.rows:Array.isArray(r==null?void 0:r.data)?r.data:[],x=r=>{const c=Number(r);return Number.isFinite(c)?new Intl.NumberFormat(void 0,{maximumFractionDigits:0}).format(c):r??"—"},J=r=>{const c=Number(r);return Number.isFinite(c)?c.toFixed(2):r??"—"},M=r=>{if(!r)return"—";const c=new Date(r);return Number.isNaN(+c)?String(r).slice(0,10):c.toLocaleDateString()};function K(r,c){if(!r)return"";const[f,p,j]=String(r).split("-").map(Number);if(!f||!p||!j)return r;const b=new Date(Date.UTC(f,p-1,j)),C=b.getUTCMonth()+Number(c||0),w=new Date(Date.UTC(b.getUTCFullYear(),C,b.getUTCDate()));return w.getUTCMonth()!==((p-1+Number(c||0))%12+12)%12&&w.setUTCDate(0),w.toISOString().slice(0,10)}const fe=()=>{const r=me(),[c,f]=i.useState([]),[p,j]=i.useState([]),[b,C]=i.useState([]),[w,U]=i.useState(!1),[B,Q]=i.useState(""),[k,X]=i.useState("all"),[L,Z]=i.useState(""),[F,ee]=i.useState(""),[y,te]=i.useState(""),[D,ae]=i.useState(""),re=async()=>{var e,a;U(!0);try{const n=await _.get("/loans",{params:{page:1,pageSize:500,include:"aggregates"}});f(O(n.data))}catch(n){console.error(n),alert(`Failed to load loans${(a=(e=n==null?void 0:n.response)==null?void 0:e.data)!=null&&a.error?`: ${n.response.data.error}`:""}`),f([])}finally{U(!1)}},se=async()=>{try{const e=await _.get("/branches",{params:{page:1,pageSize:500}});j(O(e.data))}catch{j([])}},ne=async()=>{try{const e=await _.get("/loan-products",{params:{page:1,pageSize:500}});C(O(e.data))}catch{C([])}};i.useEffect(()=>{re(),se(),ne()},[]);const R=i.useMemo(()=>Object.fromEntries((b||[]).map(e=>[String(e.id),e])),[b]),T=i.useMemo(()=>Object.fromEntries((p||[]).map(e=>[String(e.id),e])),[p]),oe=e=>{const a=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at;if(!a||!y&&!D)return!0;const n=new Date(a);if(y&&n<new Date(y))return!1;if(D){const o=new Date(D);if(o.setHours(23,59,59,999),n>o)return!1}return!0},m=i.useMemo(()=>{const e=B.trim().toLowerCase();return(c||[]).filter(a=>{var l,u,h;const n=(a.status||a.loanStatus||"").toLowerCase(),o=k==="all"||n===k,g=(((l=a.Borrower)==null?void 0:l.name)||a.borrowerName||a.borrower_name||((u=a.borrower)==null?void 0:u.name)||"").toLowerCase().includes(e)||String(a.id||a.loanId||"").toLowerCase().includes(e),d=String(a.branchId||((h=a.branch)==null?void 0:h.id)||a.branch_id||""),A=!L||d===String(L),N=!F||String(a.productId)===String(F);return o&&g&&A&&N&&oe(a)})},[c,k,B,L,F,y,D]),v=i.useMemo(()=>{const e=m.reduce((n,o)=>n+Number(o.amount||o.principal||0),0),a=n=>m.filter(o=>(o.status||o.loanStatus||"").toLowerCase()===n).length;return{total:m.length,totalPrincipal:e,pending:a("pending"),approved:a("approved"),disbursed:a("disbursed"),active:a("active"),closed:a("closed"),rejected:a("rejected")}},[m]),$=i.useMemo(()=>m.map(e=>{var N,l,u,h,I;const a=Number(e.amount??e.principal??0),n=Number(e.totalInterest??0),o=e.outstanding??e.outstandingAmount??e.remainingAmount??void 0;let S="";if(Number.isFinite(o)){const E=Number.isFinite(n)?a+n:a;S=Math.max(0,E-Number(o))}const g=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at||"",d=e.termMonths??e.durationMonths??e.term_months??null,A=e.endDate||(g&&d?K(String(g).slice(0,10),d):"");return{id:e.id,borrower:((N=e.Borrower)==null?void 0:N.name)||e.borrowerName||e.borrower_name||((l=e.borrower)==null?void 0:l.name)||"",branch:((u=e.branch)==null?void 0:u.name)||((h=T[String(e.branchId||"")])==null?void 0:h.name)||"",product:((I=R[String(e.productId)])==null?void 0:I.name)||"",amount:a,rate:e.interestRate??e.rate??"",termMonths:d??"",startDate:g,endDate:A,paidAmount:S,outstanding:Number.isFinite(o)?Number(o):"",status:e.status||e.loanStatus||""}}),[m,R,T]),ie=[{label:"Loan ID",key:"id"},{label:"Borrower",key:"borrower"},{label:"Branch",key:"branch"},{label:"Product",key:"product"},{label:"Principal",key:"amount"},{label:"Rate (%)",key:"rate"},{label:"Term (months)",key:"termMonths"},{label:"Start Date",key:"startDate"},{label:"End Date",key:"endDate"},{label:"Paid Amount",key:"paidAmount"},{label:"Outstanding Amount",key:"outstanding"},{label:"Status",key:"status"}],ce=()=>{const e=new be;e.text("Loans Report",14,16),e.autoTable({startY:20,head:[["ID","Borrower","Branch","Product","Principal","Rate (%)","Term","Start Date","End Date","Paid","Outstanding","Status"]],body:$.map(a=>[a.id,a.borrower,a.branch,a.product,x(a.amount),J(a.rate),a.termMonths,M(a.startDate),M(a.endDate),x(a.paidAmount),x(a.outstanding),a.status])}),e.save("loans.pdf")},de=e=>"px-2 py-1 rounded text-xs font-semibold bg-[var(--badge-bg)] text-[var(--badge-fg)] ring-1 ring-[var(--border)]";return t.jsxs("div",{className:s.page,children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:s.h1,children:"All Loans"}),t.jsx(pe,{className:s.actionLink,to:"/loans/applications",children:"New Application"})]}),t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-3",children:[{label:"Total",value:v.total},{label:"Principal",value:x(v.totalPrincipal)},{label:"Pending",value:v.pending},{label:"Approved",value:v.approved},{label:"Disbursed",value:v.disbursed},{label:"Active",value:v.active}].map((e,a)=>t.jsxs("div",{className:s.kpi,children:[t.jsx("p",{className:"text-xs text-[var(--muted)]",children:e.label}),t.jsx("p",{className:"text-lg font-bold",children:e.value})]},a))}),t.jsxs("div",{className:`${s.card} p-4 grid grid-cols-1 md:grid-cols-6 gap-3`,children:[t.jsx("input",{type:"text",placeholder:"Search borrower or loan ID…",value:B,onChange:e=>Q(e.target.value),className:`${s.input} md:col-span-2`}),t.jsxs("select",{value:k,onChange:e=>X(e.target.value),className:s.input,children:[t.jsx("option",{value:"all",children:"All Statuses"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"approved",children:"Approved"}),t.jsx("option",{value:"disbursed",children:"Disbursed"}),t.jsx("option",{value:"active",children:"Active"}),t.jsx("option",{value:"rejected",children:"Rejected"}),t.jsx("option",{value:"closed",children:"Closed"})]}),t.jsxs("select",{value:L,onChange:e=>Z(e.target.value),className:s.input,children:[t.jsx("option",{value:"",children:"All Branches"}),p.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:F,onChange:e=>ee(e.target.value),className:s.input,children:[t.jsx("option",{value:"",children:"All Products"}),b.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("input",{type:"date",value:y,onChange:e=>te(e.target.value),className:s.input}),t.jsx("input",{type:"date",value:D,onChange:e=>ae(e.target.value),className:s.input}),t.jsxs("div",{className:"md:col-span-6 flex justify-end gap-2",children:[t.jsx(ge,{data:$,headers:ie,filename:"loans.csv",className:s.primary,children:"Export CSV"}),t.jsx("button",{onClick:ce,className:s.primary,children:"Export PDF"})]})]}),t.jsx("div",{className:s.tableWrap,children:w?t.jsx("p",{className:"p-4",children:"Loading loans…"}):m.length===0?t.jsx("p",{className:"p-4 text-[var(--muted)]",children:"No loans found."}):t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{children:t.jsx("tr",{children:["ID","Borrower","Branch","Product","Principal","Interest Rate (%)","Loan term","Start Date","End Date","Paid Amount","Outstanding Amount","Status","Action"].map(e=>t.jsx("th",{className:s.th,children:e},e))})}),t.jsx("tbody",{children:m.map((e,a)=>{var H,W,Y,q,G;const n=(e.status||e.loanStatus||"").toLowerCase(),o=((H=e.Borrower)==null?void 0:H.name)||e.borrowerName||e.borrower_name||((W=e.borrower)==null?void 0:W.name)||"N/A",S=((Y=R[String(e.productId)])==null?void 0:Y.name)||"—",g=((q=e.branch)==null?void 0:q.name)||((G=T[String(e.branchId||"")])==null?void 0:G.name)||"—",d=Number(e.amount??e.principal??0),A=x(d),N=J(e.interestRate??e.rate),l=e.termMonths??e.durationMonths??e.term_months??"—",u=e.startDate||e.disbursementDate||e.releaseDate||e.createdAt||e.created_at,h=M(u),I=e.endDate||(u&&l?K(String(u).slice(0,10),l):""),E=M(I),P=e.outstanding??e.outstandingAmount??e.remainingAmount??null,le=P==null?"—":x(P),z=Number(e.totalInterest??NaN);let V="—";if(Number.isFinite(Number(P))){const ue=Number.isFinite(z)?d+z:d;V=x(Math.max(0,ue-Number(P)))}return t.jsxs("tr",{className:`${a%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)] transition-colors`,children:[t.jsx("td",{className:s.td,children:e.id}),t.jsx("td",{className:s.td,children:o}),t.jsx("td",{className:s.td,children:g}),t.jsx("td",{className:s.td,children:S}),t.jsx("td",{className:s.td,children:A}),t.jsx("td",{className:s.td,children:N}),t.jsx("td",{className:s.td,children:l}),t.jsx("td",{className:s.td,children:h}),t.jsx("td",{className:s.td,children:E}),t.jsx("td",{className:s.td,children:V}),t.jsx("td",{className:s.td,children:le}),t.jsx("td",{className:s.td,children:t.jsx("span",{className:de(),children:n})}),t.jsx("td",{className:s.td,children:t.jsx("button",{onClick:()=>r(`/loans/${e.id}`),className:s.actionLink,children:"View loan"})})]},e.id)})})]})})]})};export{fe as default};

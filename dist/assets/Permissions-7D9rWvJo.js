import{r as o,j as e,g as h}from"./index-B-WhzGsb.js";const r={page:"w-full px-4 md:px-6 lg:px-10 py-6 text-slate-900",h1:"text-3xl font-extrabold tracking-tight",card:"rounded-2xl border-2 border-slate-300 bg-white shadow",th:"bg-slate-100 text-left text-[12px] uppercase tracking-wide text-slate-700 font-semibold px-3 py-2 border-2 border-slate-200",td:"px-3 py-2 border-2 border-slate-200 text-sm",field:"h-10 w-full rounded-lg border-2 border-slate-300 bg-white text-sm px-3 outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-600",btnPrimary:"inline-flex items-center rounded-lg bg-indigo-600 text-white px-3 py-2 font-semibold hover:bg-indigo-700",btnDanger:"inline-flex items-center rounded-lg bg-rose-600 text-white px-3 py-2 font-semibold hover:bg-rose-700",tabs:"inline-flex rounded-xl overflow-hidden border-2 border-slate-300 bg-white",tab:"px-4 py-2 text-sm font-semibold",tabActive:"bg-slate-900 text-white"};function H(){const[m,N]=o.useState("matrix"),[b,R]=o.useState([]),[x,v]=o.useState([]),[d,y]=o.useState(""),[f,E]=o.useState(""),[C,p]=o.useState(!1),[S,$]=o.useState(!1),[L,D]=o.useState([]),[k,A]=o.useState(""),[P,F]=o.useState(!1),u=async()=>{var s,t,a,i,n,c;p(!0);try{const l=await h.get("/permissions/matrix");R(((s=l.data)==null?void 0:s.roles)||[]),v(((t=l.data)==null?void 0:t.matrix)||[]),!d&&((i=(a=l.data)==null?void 0:a.roles)!=null&&i.length)&&y(l.data.roles[0].id)}catch(l){console.error(l),alert(((c=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:c.error)||"Failed to load permission matrix")}finally{p(!1)}},g=o.useMemo(()=>{const s=new Map;return b.forEach(t=>s.set(t.id,t)),s},[b]),I=s=>{const t=g.get(d);if(!t)return!1;const a=x.flatMap(i=>i.actions).find(i=>i.action===s);return a?(a.roles||[]).map(i=>i.toLowerCase()).includes(t.name.toLowerCase()):!1},q=(s,t)=>{const a=g.get(d);if(!a)return;const i=a.name.toLowerCase();v(n=>n.map(c=>({...c,actions:c.actions.map(l=>{if(l.action!==s)return l;const w=new Set((l.roles||[]).map(z=>z.toLowerCase()));return t?w.add(i):w.delete(i),{...l,roles:Array.from(w)}})})))},B=async()=>{var a,i;const s=g.get(d);if(!s)return;const t=x.flatMap(n=>n.actions).filter(n=>(n.roles||[]).map(c=>c.toLowerCase()).includes(s.name.toLowerCase())).map(n=>n.action);$(!0);try{await h.put(`/permissions/role/${s.id}`,{actions:t,mode:"replace"}),alert("Permissions saved")}catch(n){console.error(n),alert(((i=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:i.error)||"Failed to save permissions")}finally{$(!1)}},M=o.useMemo(()=>{const s=f.trim().toLowerCase();return s?x.map(t=>({...t,actions:t.actions.filter(a=>a.action.toLowerCase().includes(s)||a.label.toLowerCase().includes(s))})).filter(t=>t.actions.length):x},[x,f]),j=async()=>{var s,t;try{p(!0);const a=await h.get("/permissions");D(Array.isArray(a.data)?a.data:[])}catch(a){console.error("Failed to load permissions",a),alert(((t=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to load permissions")}finally{p(!1)}},T=async()=>{var t,a;const s=k.trim();if(s){F(!0);try{await h.post("/permissions",{name:s}),A(""),j(),u()}catch(i){console.error("Failed to add permission",i),alert(((a=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:a.error)||"Error adding permission")}finally{F(!1)}}},V=async s=>{var t,a;if(window.confirm("Delete this permission?"))try{await h.delete(`/permissions/${s}`),j(),u()}catch(i){console.error("Failed to delete permission",i),alert(((a=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:a.error)||"Error deleting permission")}};return o.useEffect(()=>{m==="matrix"?u():j()},[m]),e.jsxs("div",{className:r.page,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:r.h1,children:"Permissions"}),e.jsxs("div",{className:r.tabs,children:[e.jsx("button",{className:`${r.tab} ${m==="matrix"?r.tabActive:""}`,onClick:()=>N("matrix"),children:"Matrix"}),e.jsx("button",{className:`${r.tab} ${m==="raw"?r.tabActive:""}`,onClick:()=>N("raw"),children:"Raw list"})]})]}),m==="matrix"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("select",{className:`${r.field} w-56`,value:d,onChange:s=>y(s.target.value),children:b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}),e.jsx("input",{className:`${r.field} w-72`,placeholder:"Filter actions…",value:f,onChange:s=>E(s.target.value)})]}),e.jsx("button",{onClick:B,className:`${r.btnPrimary} disabled:opacity-60`,disabled:S||!d,children:S?"Saving…":"Save"})]}),e.jsx("div",{className:`${r.card} overflow-hidden`,children:C?e.jsx("div",{className:"p-8 text-center text-slate-600",children:"Loading…"}):M.length===0?e.jsx("div",{className:"p-8 text-center text-slate-600",children:"No actions"}):M.map(s=>e.jsxs("div",{className:"border-b last:border-b-0",children:[e.jsx("div",{className:"px-4 py-3 bg-slate-50 font-semibold text-slate-700",children:s.group}),e.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:r.th,children:"Action"}),e.jsx("th",{className:r.th,children:"Verbs"}),e.jsx("th",{className:`${r.th} w-36`,children:"Allowed"})]})}),e.jsx("tbody",{children:s.actions.map(t=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsxs("td",{className:r.td,children:[e.jsx("div",{className:"font-medium",children:t.label}),e.jsx("div",{className:"text-xs text-slate-500",children:t.action})]}),e.jsx("td",{className:r.td,children:e.jsx("div",{className:"text-xs text-slate-600",children:(t.verbs||[]).join(", ")})}),e.jsx("td",{className:r.td,children:e.jsx("input",{type:"checkbox",checked:I(t.action),onChange:a=>q(t.action,a.target.checked),disabled:!d})})]},t.action))})]})]},s.group))})]}):e.jsxs("div",{className:`${r.card} overflow-x-auto`,children:[e.jsxs("div",{className:"flex gap-2 p-3 border-b",children:[e.jsx("input",{type:"text",className:`${r.field} w-72`,placeholder:"New permission (e.g., loans.approve)",value:k,onChange:s=>A(s.target.value)}),e.jsx("button",{onClick:T,className:`${r.btnPrimary} disabled:opacity-60`,disabled:P,children:P?"Saving…":"Add"})]}),e.jsxs("table",{className:"min-w-full border-separate border-spacing-0",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:r.th,children:"ID"}),e.jsx("th",{className:r.th,children:"Action"}),e.jsx("th",{className:`${r.th} text-right`,children:"Actions"})]})}),e.jsx("tbody",{children:C?e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:`${r.td} text-center py-8 text-slate-600`,children:"Loading…"})}):L.length?L.map(s=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:r.td,children:s.id}),e.jsx("td",{className:r.td,children:s.action||s.name}),e.jsx("td",{className:`${r.td} text-right`,children:e.jsx("button",{onClick:()=>V(s.id),className:r.btnDanger,children:"Delete"})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:`${r.td} text-center py-8 text-slate-600`,children:"No permissions found"})})})]})]})]})}export{H as default};

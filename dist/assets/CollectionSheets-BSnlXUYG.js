import{r as a,j as e,L as B,b as le,C as re}from"./index-XcKfUCi2.js";import{u as ne}from"./usePaginatedFetch-BekSEsfj.js";import{L as oe}from"./ListShell-B7J2IH6-.js";function ce(){const{pathname:s}=re();return s.endsWith("/daily")?"daily":s.endsWith("/missed")?"missed":s.endsWith("/past-maturity")?"past-maturity":""}function ie(){var s;try{const c=localStorage.getItem("auth")||localStorage.getItem("user")||"",n=c?JSON.parse(c):{};return(n==null?void 0:n.role)||((s=n==null?void 0:n.user)==null?void 0:s.role)||"user"}catch{return"user"}}const de=new Set(["admin","director","branch_manager"]),ue=new Set(["admin","director","branch_manager","comms"]),me=s=>(s==null?void 0:s.id)??(s==null?void 0:s.ID)??(s==null?void 0:s._id)??(s==null?void 0:s.uuid)??null;function xe({summary:s}){if(!s)return null;const{total:c=0,byStatus:n={},byType:d={}}=s;return e.jsxs("div",{className:"mb-3 grid gap-2 sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Total sheets"}),e.jsx("div",{className:"text-xl font-semibold",children:c})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"By status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.keys(n).length===0&&e.jsx("span",{className:"text-xs text-slate-400",children:"n/a"}),Object.entries(n).map(([o,b])=>e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border",children:[o,": ",b]},o))]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"By type"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[Object.keys(d).length===0&&e.jsx("span",{className:"text-xs text-slate-400",children:"n/a"}),Object.entries(d).map(([o,b])=>e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border",children:[o,": ",b]},o))]})]})]})}function pe({open:s,onClose:c,children:n,title:d="Dialog"}){return s?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:c}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 w/full max-w-lg rounded-xl shadow-xl border",children:[e.jsx("div",{className:"p-3 border-b font-semibold",children:d}),e.jsx("div",{className:"p-4",children:n}),e.jsx("div",{className:"p-3 border-t text-right",children:e.jsx("button",{onClick:c,className:"px-3 py-1 text-sm border rounded hover:bg-gray-50",children:"Close"})})]})})]}):null}function je(){const s=ce(),c=ie(),n=de.has(c),d=ue.has(c),[o,b]=a.useState(""),[u,E]=a.useState(""),[m,I]=a.useState(""),[x,P]=a.useState(""),[p,R]=a.useState(""),[h,D]=a.useState(""),[g,O]=a.useState({}),[_,f]=a.useState(""),[j,A]=a.useState("collector"),[v,w]=a.useState(""),[M,L]=a.useState(""),[W,S]=a.useState(!1),[F,T]=a.useState(!1),$=a.useMemo(()=>{switch(s){case"daily":return"Showing today’s collection sheets.";case"missed":return"Sheets scheduled before today and not completed.";case"past-maturity":return"Sheets older than 30 days and not completed.";default:return"All collection sheets. Use filters to narrow results."}},[s]),U=a.useMemo(()=>{const t=new URLSearchParams;t.set("withSummary","1"),s&&t.set("scope",s),o&&t.set("status",o),u&&t.set("type",u),m&&t.set("dateFrom",m),x&&t.set("dateTo",x),p&&t.set("collector",p),h&&t.set("loanOfficer",h);const r=t.toString();return r?`/api/collections?${r}`:"/api/collections"},[s,o,u,m,x,p,h]),{rows:N,total:Y,page:q,setPage:G,limit:z,setLimit:H,q:y,setQ:J,loading:Q,error:V,summary:K}=ne({url:U}),X=a.useMemo(()=>(Array.isArray(N)?N.filter(Boolean):[]).map((r,l)=>{const i=me(r);return{...r,__rid:i||`tmp-${l}`}}),[N]),Z=a.useMemo(()=>{const t=[{key:"__select__",title:"",width:30,render:r=>{if(!r)return null;const l=r.__rid,i=l&&!String(l).startsWith("tmp-");return e.jsx("input",{type:"checkbox",disabled:!i,checked:!!g[l],onChange:k=>O(ae=>({...ae,[l]:k.target.checked}))})}},{key:"date",title:"Date"},{key:"type",title:"Type"},{key:"collector",title:"Collector"},{key:"loanOfficer",title:"Loan Officer"},{key:"status",title:"Status"}];return n&&t.push({key:"__actions__",title:"Actions",render:r=>{if(!r)return null;const l=r.__rid;return l&&!String(l).startsWith("tmp-")?e.jsx(B,{to:`/collections/${l}/edit`,className:"text-blue-600 hover:underline text-sm",children:"Edit"}):e.jsx("span",{className:"text-slate-400 text-xs",children:"No ID"})}}),t},[n,g]),ee=a.useMemo(()=>{const t=new URLSearchParams;return s&&t.set("scope",s),y&&t.set("q",y),o&&t.set("status",o),u&&t.set("type",u),m&&t.set("dateFrom",m),x&&t.set("dateTo",x),p&&t.set("collector",p),h&&t.set("loanOfficer",h),t.set("export","csv"),`/api/collections?${t.toString()}`},[s,y,o,u,m,x,p,h]),te=a.useMemo(()=>{switch(s){case"daily":return"Daily Collection Sheet";case"missed":return"Missed Repayment Sheet";case"past-maturity":return"Past Maturity Loans";default:return"Collection Sheets"}},[s]),C=a.useMemo(()=>Object.entries(g).filter(([t,r])=>r&&!String(t).startsWith("tmp-")).map(([t])=>t),[g]),se=async()=>{var t,r;if(!d){f("You do not have permission to send SMS.");return}if(j!=="custom"&&C.length===0){f("Select at least one row.");return}if(!v.trim()){f("Message cannot be empty.");return}T(!0);try{const l={ids:C,to:j,message:v,customPhones:j==="custom"?M.split(/[,\s;]+/).map(k=>k.trim()).filter(Boolean):void 0},i=await le.post("/api/collections/bulk-sms",l);f(`Sent: ${i.data.sent} / ${i.data.total}${i.data.failed?`, failed: ${i.data.failed}`:""}`),S(!1),O({}),w(""),L("")}catch(l){f(((r=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:r.error)||l.message)}finally{T(!1)}};return e.jsxs(e.Fragment,{children:[_&&e.jsx("div",{className:"mb-2 text-sm p-2 rounded border bg-emerald-50 text-emerald-700",children:_}),e.jsx(xe,{summary:K}),e.jsx(oe,{title:te,subtitle:e.jsx("span",{className:"text-xs text-slate-500",children:$}),q:y,setQ:J,columns:Z,rows:X,loading:Q,error:V,page:q,setPage:G,limit:z,setLimit:H,total:Y,toolbar:e.jsxs("div",{className:"flex flex-wrap items-center gap-2 w-full",children:[n&&e.jsx(B,{to:"/collections/new",className:"mr-3 border rounded px-3 py-1 text-sm bg-blue-600 text-white hover:bg-blue-700",children:"+ New Collection Sheet"}),e.jsx("label",{className:"text-sm",children:"Status"}),e.jsxs("select",{className:"border rounded px-2 py-1",value:o,onChange:t=>b(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"pending",children:"pending"}),e.jsx("option",{value:"completed",children:"completed"}),e.jsx("option",{value:"cancelled",children:"cancelled"})]}),e.jsx("label",{className:"text-sm ml-3",children:"Type"}),e.jsxs("select",{className:"border rounded px-2 py-1",value:u,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"FIELD",children:"FIELD"}),e.jsx("option",{value:"OFFICE",children:"OFFICE"}),e.jsx("option",{value:"AGENCY",children:"AGENCY"})]}),e.jsx("label",{className:"text-sm ml-3",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:m,onChange:t=>I(t.target.value)}),e.jsx("label",{className:"text-sm",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1",value:x,onChange:t=>P(t.target.value)}),e.jsx("input",{placeholder:"Collector",className:"border rounded px-2 py-1 ml-3",value:p,onChange:t=>R(t.target.value)}),e.jsx("input",{placeholder:"Loan Officer",className:"border rounded px-2 py-1",value:h,onChange:t=>D(t.target.value)}),e.jsx("a",{href:ee,className:"ml-auto inline-flex items-center border rounded px-3 py-1 text-sm hover:bg-gray-50",children:"Export CSV"}),d&&e.jsx("button",{type:"button",onClick:()=>S(!0),className:"border rounded px-3 py-1 text-sm bg-emerald-600 text-white hover:bg-emerald-700",children:"Bulk SMS"})]})}),e.jsx(pe,{open:W,onClose:()=>S(!1),title:"Send Bulk SMS",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:["Selected rows: ",e.jsx("b",{children:C.length})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Recipients"}),e.jsxs("select",{className:"border rounded w-full px-2 py-1",value:j,onChange:t=>A(t.target.value),children:[e.jsx("option",{value:"collector",children:"Collectors (from selected rows)"}),e.jsx("option",{value:"loanOfficer",children:"Loan Officers (from selected rows)"}),e.jsx("option",{value:"custom",children:"Custom phone numbers…"})]})]}),j==="custom"&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Phone numbers (comma/space separated, E.164 or local)"}),e.jsx("textarea",{className:"border rounded w-full px-2 py-1 h-20",value:M,onChange:t=>L(t.target.value),placeholder:"+2557..., 0712..., 2557..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm block mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded w-full px-2 py-1 h-28",value:v,onChange:t=>w(t.target.value),placeholder:"Your message…"})]}),e.jsx("div",{className:"text-right",children:e.jsx("button",{disabled:F,onClick:se,className:"border rounded px-3 py-1 text-sm bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50",children:F?"Sending…":"Send SMS"})})]})})]})}export{je as default};

import{r as i,g as S,j as e}from"./index-CSL_HVM5.js";const N=(t,c)=>t?["admin","director","super_admin","system_admin"].includes((t.role||"").toLowerCase())?!0:Array.isArray(t.permissions)&&t.permissions.includes(c):!1;async function y(t=[],c={}){let n;for(const o of t)try{const d=await S.get(o,c);return d==null?void 0:d.data}catch(d){n=d}throw n||new Error("No GET endpoint succeeded")}async function E(t=[],c={},n={}){let o;for(const d of t)try{const u=await S.post(d,c,n);return u==null?void 0:u.data}catch(u){o=u}throw o||new Error("No POST endpoint succeeded")}const $=t=>String(t||"").replace(/\D+/g,""),A=t=>{const c=String(t??"").trim();if(!c||!/^-?\d+$/.test(c))return null;const n=Number(c);return Number.isFinite(n)?n:null},w=t=>{const c=String(t??"").trim();return c.length?c:null};function R(){const[t,c]=i.useState(null),[n,o]=i.useState("overview");return i.useEffect(()=>{(async()=>{try{const{data:d}=await S.get("/auth/me");c(d)}catch{}})()},[]),t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Branches"}),e.jsx("p",{className:"text-xs text-slate-500",children:"View branches and perform common operations."})]}),e.jsxs("div",{className:"flex gap-1 rounded-lg border bg-white overflow-hidden",children:[e.jsx(f,{label:"Overview",id:"overview",tab:n,setTab:o}),N(t,"branches:manage")&&e.jsx(f,{label:"Add",id:"add",tab:n,setTab:o}),N(t,"branches:assign")&&e.jsx(f,{label:"Assign",id:"assign",tab:n,setTab:o}),e.jsx(f,{label:"Reports",id:"reports",tab:n,setTab:o})]})]}),n==="overview"&&e.jsx(I,{}),n==="add"&&N(t,"branches:manage")&&e.jsx(B,{}),n==="assign"&&N(t,"branches:assign")&&e.jsx(T,{}),n==="reports"&&e.jsx(k,{})]}):e.jsx("div",{className:"p-4",children:"Loading…"})}function f({label:t,id:c,tab:n,setTab:o}){const d=n===c;return e.jsx("button",{onClick:()=>o(c),className:`px-3 py-1.5 text-sm ${d?"bg-slate-100":"bg-white hover:bg-slate-50"}`,children:t})}function I(){const[t,c]=i.useState([]),[n,o]=i.useState(""),[d,u]=i.useState(""),g=async()=>{var h,m;u("");try{const l=await y(["/branches","/api/branches","/org/branches","/api/org/branches"],{params:{q:n}}),b=Array.isArray(l==null?void 0:l.items)?l.items:Array.isArray(l)?l:(l==null?void 0:l.rows)||(l==null?void 0:l.data)||[];c(b)}catch(l){u(((m=(h=l==null?void 0:l.response)==null?void 0:h.data)==null?void 0:m.error)||(l==null?void 0:l.message)||"Failed to load branches.")}};return i.useEffect(()=>{g()},[]),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Search"}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm",value:n,onChange:h=>o(h.target.value),placeholder:"name, code, phone…"})]}),e.jsx("button",{onClick:g,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Apply"})]}),d&&e.jsx("div",{className:"text-sm text-red-600",children:d}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Code"}),e.jsx("th",{className:"py-2 px-3",children:"Phone"}),e.jsx("th",{className:"py-2 px-3",children:"Address"}),e.jsx("th",{className:"py-2 px-3",children:"Manager"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"p-3 text-gray-500",children:"No branches yet."})}):t.map(h=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:h.name}),e.jsx("td",{className:"py-2 px-3",children:h.code??"—"}),e.jsx("td",{className:"py-2 px-3",children:h.phone??"—"}),e.jsx("td",{className:"py-2 px-3",children:h.address??"—"}),e.jsx("td",{className:"py-2 px-3",children:h.managerName||h.manager_id||"—"})]},h.id??h.code??Math.random()))})]})})]})}function B(){const[t,c]=i.useState({name:"",code:"",phone:"",address:""}),[n,o]=i.useState(!1),[d,u]=i.useState(""),[g,h]=i.useState(""),[m,l]=i.useState(""),b=async()=>{var j;o(!0),h(""),u(""),l("");const p={name:w(t.name),code:A(t.code),phone:w($(t.phone)),address:w(t.address)};try{await E(["/branches","/api/branches","/org/branches","/api/org/branches"],p),u("Branch created."),c({name:"",code:"",phone:"",address:""})}catch(r){const s=(j=r==null?void 0:r.response)==null?void 0:j.data;l((s==null?void 0:s.requestId)||""),h((s==null?void 0:s.error)||(s==null?void 0:s.message)||(r==null?void 0:r.message)||"Failed to create branch")}finally{o(!1)}};return e.jsxs("div",{className:"bg-white border rounded-xl p-3 grid gap-2 md:grid-cols-4 items-end",children:[["name","code","phone","address"].map(p=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 capitalize",children:p}),e.jsx("input",{className:"border rounded px-2 py-1 text-sm w-full",value:t[p],onChange:j=>c(r=>({...r,[p]:j.target.value})),placeholder:p==="code"?"e.g. 1":p==="phone"?"digits only":""})]},p)),e.jsx("button",{onClick:b,disabled:n,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm disabled:opacity-60",children:n?"Saving…":"Create"}),d&&e.jsx("div",{className:"text-sm text-emerald-700",children:d}),(g||m)&&e.jsxs("div",{className:"text-sm text-red-600 col-span-full",children:[g,m?e.jsxs(e.Fragment,{children:[" ",e.jsxs("span",{className:"text-xs opacity-80",children:["(requestId: ",m,")"]})]}):null]})]})}function T(){const[t,c]=i.useState([]),[n,o]=i.useState([]),[d,u]=i.useState(""),[g,h]=i.useState([]),[m,l]=i.useState(""),[b,p]=i.useState("");i.useEffect(()=>{(async()=>{try{const[s,a]=await Promise.all([y(["/branches","/api/branches","/org/branches","/api/org/branches"]),y(["/users?limit=1000","/api/users?limit=1000"])]),x=Array.isArray(s==null?void 0:s.items)?s.items:Array.isArray(s)?s:(s==null?void 0:s.rows)||(s==null?void 0:s.data)||[],C=Array.isArray(a==null?void 0:a.items)?a.items:Array.isArray(a==null?void 0:a.rows)?a.rows:Array.isArray(a)?a:(a==null?void 0:a.data)||[];c(x),o(C)}catch{}})()},[]);const j=s=>{h(a=>a.includes(s)?a.filter(x=>x!==s):[...a,s])},r=async()=>{var s,a;l(""),p("");try{const x=A(d);if(x==null){p("Invalid branch selected.");return}await E([`/branches/${x}/assign-staff`,`/api/branches/${x}/assign-staff`,`/org/branches/${x}/assign-staff`,`/api/org/branches/${x}/assign-staff`],{userIds:g}),l("Assigned successfully.")}catch(x){p(((a=(s=x==null?void 0:x.response)==null?void 0:s.data)==null?void 0:a.error)||(x==null?void 0:x.message)||"Failed to assign staff.")}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:d,onChange:s=>u(s.target.value),children:[e.jsx("option",{value:"",children:"Select branch"}),t.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id??s.code))]})]}),e.jsxs("button",{onClick:r,disabled:!d||g.length===0,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:["Assign ",g.length?`(${g.length})`:""]}),m&&e.jsx("div",{className:"text-sm text-emerald-700",children:m}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b})]}),e.jsx("div",{className:"bg-white border rounded-xl overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-600 border-b",children:[e.jsx("th",{className:"py-2 px-3",children:"Assign"}),e.jsx("th",{className:"py-2 px-3",children:"Name"}),e.jsx("th",{className:"py-2 px-3",children:"Email"}),e.jsx("th",{className:"py-2 px-3",children:"Role"})]})}),e.jsx("tbody",{children:n.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"p-3 text-gray-500",children:"No users."})}):n.map(s=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"py-2 px-3",children:e.jsx("input",{type:"checkbox",checked:g.includes(s.id),onChange:()=>j(s.id)})}),e.jsx("td",{className:"py-2 px-3",children:s.name||`${s.firstName||""} ${s.lastName||""}`.trim()}),e.jsx("td",{className:"py-2 px-3",children:s.email}),e.jsx("td",{className:"py-2 px-3",children:s.role||(s.Roles||[]).map(a=>a.name).join(", ")||"—"})]},s.id))})]})})]})}function k(){const[t,c]=i.useState([]),[n,o]=i.useState(""),[d,u]=i.useState(""),[g,h]=i.useState(""),[m,l]=i.useState(null),[b,p]=i.useState("");i.useEffect(()=>{(async()=>{try{const r=await y(["/branches","/api/branches","/org/branches","/api/org/branches"]),s=Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r)?r:(r==null?void 0:r.rows)||(r==null?void 0:r.data)||[];c(s)}catch{}})()},[]);const j=async()=>{var r,s;p(""),l(null);try{const a=A(n);if(a==null){p("Invalid branch selected.");return}const x=await y([`/branches/${a}/report`,`/api/branches/${a}/report`,`/org/branches/${a}/report`,`/api/org/branches/${a}/report`],{params:{from:d,to:g}});l((x==null?void 0:x.kpis)||x||null)}catch(a){p(((s=(r=a==null?void 0:a.response)==null?void 0:r.data)==null?void 0:s.error)||(a==null?void 0:a.message)||"Failed to load report.")}};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"Branch"}),e.jsxs("select",{className:"border rounded px-2 py-1 text-sm min-w-[220px]",value:n,onChange:r=>o(r.target.value),children:[e.jsx("option",{value:"",children:"Select"}),t.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id??r.code))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"From"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:d,onChange:r=>u(r.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500",children:"To"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 text-sm",value:g,onChange:r=>h(r.target.value)})]}),e.jsx("button",{onClick:j,disabled:!n,className:"px-3 py-2 border rounded-lg bg-white hover:bg-gray-50 text-sm",children:"Run"})]}),b&&e.jsx("div",{className:"text-sm text-red-600",children:b}),m&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(v,{title:"Staff",value:m.staffCount,tone:"indigo"}),e.jsx(v,{title:"Expenses",value:`TZS ${Number(m.expenses||0).toLocaleString()}`,tone:"amber"}),e.jsx(v,{title:"Loans Out",value:`TZS ${Number(m.loansOut||m.disbursed||0).toLocaleString()}`,tone:"emerald"}),e.jsx(v,{title:"Collections",value:`TZS ${Number(m.collections||m.collected||0).toLocaleString()}`,tone:"blue"})]})]})}function v({title:t,value:c,tone:n="indigo"}){const o={indigo:"text-indigo-600 bg-indigo-50",amber:"text-amber-600 bg-amber-50",emerald:"text-emerald-600 bg-emerald-50",blue:"text-blue-600 bg-blue-50"}[n]||"text-slate-600 bg-slate-50";return e.jsxs("div",{className:"bg-white border rounded-xl p-3 flex items-center gap-3",children:[e.jsx("div",{className:`px-2 py-1 rounded ${o}`,children:t}),e.jsx("div",{className:"font-semibold",children:c??"—"})]})}export{R as default};

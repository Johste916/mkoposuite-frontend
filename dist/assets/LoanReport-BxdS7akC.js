import{a as X,u as Y,l as B,r as l,j as r,h as R}from"./index-DFzTBWzb.js";import{C as K}from"./index-C7NWTBPz.js";const s={page:"p-4 md:p-6 lg:p-8 space-y-6 bg-[var(--bg)] text-[var(--fg)]",h1:"text-2xl font-extrabold tracking-tight",sub:"text-sm text-[var(--muted)]",row:"flex flex-col gap-2 md:flex-row md:items-end md:justify-between",card:"card p-4 rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)]",input:"h-10 rounded-lg border-2 border-[var(--border-strong)] bg-[var(--card)] px-3 text-[var(--fg)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",btn:"inline-flex items-center justify-center rounded-lg border-2 border-[var(--border-strong)] px-3 py-2 bg-[var(--card)] text-[var(--fg)] hover:bg-[var(--chip-soft)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",primary:"inline-flex items-center justify-center rounded-lg px-3 py-2 font-semibold bg-[var(--primary)] text-[var(--primary-contrast)] hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]",alert:"rounded-md border-2 border-[var(--border-strong)] bg-[var(--card)] text-[var(--fg)] px-3 py-2 text-sm",tableWrap:"overflow-x-auto rounded-2xl border-2 border-[var(--border-strong)] bg-[var(--card)]",th:"bg-[var(--table-head-bg)] text-left text-[12px] uppercase tracking-wide font-semibold px-3 py-2 border border-[var(--border)] text-[var(--fg)]/90",td:"px-3 py-2 border border-[var(--border)] text-sm",tdRight:"px-3 py-2 border border-[var(--border)] text-sm text-right tabular-nums",foot:"px-3 py-2 border-t-2 border-[var(--border-strong)] text-sm flex items-center justify-between"},q=e=>Array.isArray(e)?e:Array.isArray(e==null?void 0:e.items)?e.items:Array.isArray(e==null?void 0:e.rows)?e.rows:Array.isArray(e==null?void 0:e.results)?e.results:Array.isArray(e==null?void 0:e.data)?e.data:[],M=(e,n="TZS")=>`‎${n} ${Number(e||0).toLocaleString()}`,ee=e=>{if(!e)return"—";const n=String(e);if(/^\d{4}-\d{2}-\d{2}/.test(n))return n.slice(0,10);const i=new Date(n);return isNaN(+i)?"—":i.toISOString().slice(0,10)},te=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"",re=(e,n)=>{const i=e.match(/\/loans\/status\/([^/?#]+)/i);return i?decodeURIComponent(i[1].toLowerCase()):"disbursed"},T=e=>e.reference||e.ref||e.code||`LN-${e.id}`,I=e=>{var n,i;return((n=e.borrower)==null?void 0:n.name)||((i=e.Borrower)==null?void 0:i.name)||e.borrowerName||e.borrower_name||"—"},V=e=>{var n,i;return((n=e.product)==null?void 0:n.name)||((i=e.Product)==null?void 0:i.name)||e.productName||e.product_name||"—"},Z=e=>{var n,i,h;return((n=e.officer)==null?void 0:n.name)||((i=e.loanOfficer)==null?void 0:i.name)||((h=e.Officer)==null?void 0:h.name)||e.officerName||e.officer_name||e.officerFullName||"—"},se=e=>Number(e.amount??e.principal??e.principalAmount??0),ae=e=>e.currency||"TZS",ne=e=>e.disbursementDate||e.disbursedAt||e.disbursed_on||e.updatedAt||e.createdAt,oe=[{key:"ref",label:"Ref"},{key:"borrower",label:"Borrower"},{key:"product",label:"Product"},{key:"principalAmount",label:"Principal",currency:!0},{key:"totalOutstanding",label:"Total Outstanding",currency:!0},{key:"currency",label:"Currency"},{key:"officerName",label:"Officer"},{key:"disbursementDate",label:"Disbursed On"}];function ie(e){const[n]=B(),[i,h]=l.useState(n.get("q")||""),[y,k]=l.useState(n.get("startDate")||""),[C,E]=l.useState(n.get("endDate")||""),[L,A]=l.useState([]),[O,f]=l.useState(null),[v,u]=l.useState(null),[U,D]=l.useState(!0),[$,j]=l.useState(""),[N,F]=l.useState(null);async function g(){var p,b,S;D(!0),j("");try{const d={q:i||void 0,startDate:y||void 0,endDate:C||void 0,pageSize:1e3};let c;try{c=(await R.get(`/loans/status/${encodeURIComponent(e)}`,{params:d})).data}catch{if(e==="disbursed"){try{c=(await R.get("/reports/loans/disbursements/list",{params:d})).data}catch{}if(!c)try{c=(await R.get("/loans/disbursements",{params:d})).data}catch{}}c||(c=(await R.get("/loans",{params:{...d,status:e}})).data)}const P=q(c),m=q((p=c==null?void 0:c.table)==null?void 0:p.rows),w=m.length?m:P;A(w),f((S=(b=c==null?void 0:c.table)==null?void 0:b.columns)!=null&&S.length?c.table:null),u((c==null?void 0:c.summary)||null)}catch(d){console.error(d),A([]),f(null),u(null),j((d==null?void 0:d.normalizedMessage)||"Failed to load data")}finally{D(!1),F(new Date)}}return l.useEffect(()=>{g()},[e]),{q:i,setQ:h,startDate:y,setStartDate:k,endDate:C,setEndDate:E,rows:L,table:O,summary:v,loading:U,err:$,lastUpdated:N,reload:g}}function de(){var _;const e=X(),n=Y(),i=re(e.pathname),[h]=B(),y=(h.get("status")||i||"disbursed").toLowerCase(),{q:k,setQ:C,startDate:E,setStartDate:L,endDate:A,setEndDate:O,rows:f,table:v,summary:u,loading:U,err:D,lastUpdated:$,reload:j}=ie(y),[N,F]=l.useState(20),[g,p]=l.useState(1);l.useEffect(()=>{p(1)},[f]);const b=l.useMemo(()=>{const t=(k||"").trim().toLowerCase();return t?f.filter(a=>JSON.stringify(a).toLowerCase().includes(t)||I(a).toLowerCase().includes(t)||V(a).toLowerCase().includes(t)||Z(a).toLowerCase().includes(t)||String(T(a)).toLowerCase().includes(t)):f},[f,k]),S=Math.max(1,Math.ceil(b.length/N)),d=(g-1)*N,c=d+N,P=b.slice(d,c),m=(_=v==null?void 0:v.columns)!=null&&_.length?v.columns:oe,w=b[0]||{},x=w.currency||w.Currency||w.currencyCode||w.CurrencyCode||"TZS",z=(t,a)=>{let o=t[a.key];return o==null&&(a.key==="ref"&&(o=T(t)),a.key==="borrower"&&(o=I(t)),a.key==="product"&&(o=V(t)),a.key==="officerName"&&(o=Z(t)),a.key==="principalAmount"&&(o=se(t)),a.key==="totalOutstanding"&&(o=t.totalOutstanding??0),a.key==="currency"&&(o=ae(t)),a.key==="disbursementDate"&&(o=ne(t))),a.currency?M(o,x):a.percent?`${Number(o||0).toFixed(2)}%`:/date/i.test(a.key)||/Date$/.test(a.key)?ee(o):o==null||o===""?"—":String(o)},Q=m.map(t=>({label:t.label,key:t.key})),W=b.map(t=>Object.fromEntries(m.map(a=>[a.key,z(t,a)]))),H=`Loans — ${te(y.replace(/-/g," "))}`;return r.jsxs("div",{className:s.page,children:[r.jsxs("div",{className:"space-y-1",children:[r.jsx("h2",{className:s.h1,children:H}),r.jsxs("p",{className:s.sub,children:["Status-specific register with filters, pagination, and export.",$&&r.jsxs(r.Fragment,{children:[" · Last updated ",$.toLocaleString()]})]})]}),r.jsx("div",{className:s.card,children:r.jsxs("div",{className:s.row,children:[r.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.jsx("input",{className:s.input,placeholder:"Search borrower / product / officer / ref…",value:k,onChange:t=>C(t.target.value),onKeyDown:t=>t.key==="Enter"&&j()}),r.jsx("input",{type:"date",className:s.input,value:E,onChange:t=>L(t.target.value)}),r.jsx("input",{type:"date",className:s.input,value:A,onChange:t=>O(t.target.value)}),r.jsx("select",{className:s.input,value:N,onChange:t=>{F(Number(t.target.value)||20),p(1)},children:[10,20,50,100].map(t=>r.jsxs("option",{value:t,children:["Page size: ",t]},t))})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{className:s.btn,onClick:j,children:"Apply Filters"}),r.jsx("button",{className:s.btn,onClick:()=>{C(""),L(""),O(""),p(1),j()},children:"Reset"}),r.jsx(K,{data:W,headers:Q,filename:`${y}-loans.csv`,className:s.primary,children:"Export CSV"})]})]})}),r.jsxs("div",{className:s.card,children:[D&&r.jsx("div",{className:`${s.alert} mb-3`,children:D}),r.jsx("div",{className:s.tableWrap,children:r.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[r.jsx("thead",{children:r.jsxs("tr",{className:"text-left",children:[m.map(t=>r.jsx("th",{className:s.th,children:t.label},t.key)),r.jsx("th",{className:s.th,children:"Actions"})]})}),r.jsx("tbody",{children:U?r.jsx("tr",{children:r.jsx("td",{className:`${s.td} text-center py-6 text-[var(--muted)]`,colSpan:m.length+1,children:"Loading…"})}):P.length===0?r.jsx("tr",{children:r.jsx("td",{className:`${s.td} text-center py-6 text-[var(--muted)]`,colSpan:m.length+1,children:"No results match your filters."})}):P.map((t,a)=>r.jsxs("tr",{className:`${a%2===0?"bg-[var(--table-row-even)]":"bg-[var(--table-row-odd)]"} hover:bg-[var(--chip-soft)] transition-colors`,children:[m.map(o=>{const J=z(t,o),G=o.currency||o.percent?s.tdRight:s.td;return r.jsx("td",{className:G,children:J},o.key)}),r.jsx("td",{className:s.td,children:r.jsx("button",{className:s.btn,onClick:()=>n(`/loans/${t.id}`),children:"View"})})]},t.id||`${T(t)}-${a}`))})]})}),r.jsxs("div",{className:s.foot,children:[r.jsxs("span",{children:[b.length.toLocaleString()," item(s)"]}),r.jsxs("div",{className:"flex items-center gap-4",children:[(u==null?void 0:u.principalSum)!=null&&r.jsxs("span",{children:["Principal ",M(u.principalSum,x)]}),(u==null?void 0:u.outstandingSum)!=null&&r.jsx("span",{children:r.jsxs("strong",{children:["Outstanding ",M(u.outstandingSum,x)]})})]})]}),r.jsxs("div",{className:"flex items-center justify-between mt-2",children:[r.jsx("button",{className:s.btn,disabled:g<=1,onClick:()=>p(t=>Math.max(1,t-1)),children:"Previous"}),r.jsxs("span",{className:s.sub,children:["Page ",g," of ",S]}),r.jsx("button",{className:s.btn,disabled:g>=S,onClick:()=>p(t=>Math.min(S,t+1)),children:"Next"})]})]})]})}export{de as default,ie as useLoanStatusData};

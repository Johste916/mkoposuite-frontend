import{r as u,j as e}from"./index-uOcrLdeq.js";import{a as c}from"./index-CFNP_T3E.js";import{A as I}from"./acl-3zmP2x4e.js";const d="/admin/report-subscriptions";function N(r){const s=r==null?void 0:r.data;if(Array.isArray(s))return{rows:s,meta:{total:s.length,page:1,limit:s.length}};const i=(s==null?void 0:s.data)??[],x=(s==null?void 0:s.meta)??{total:i.length,page:1,limit:i.length};return{rows:i,meta:x}}const m=r=>encodeURIComponent(String(r)),h={listDefs:()=>c.get(`${d}/defs`).then(r=>{const s=r==null?void 0:r.data;return Array.isArray(s)?s:(s==null?void 0:s.data)??[]}),listSubs:(r={})=>c.get(`${d}`,{params:r}).then(s=>{const i=N(s);return Array.isArray(s==null?void 0:s.data)?(i.rows.meta=i.meta,i.rows):s.data}),createSub:r=>c.post(`${d}`,r).then(s=>s.data),deleteSub:r=>c.delete(`${d}/${m(r)}`).then(s=>s.data??{ok:!0}),runNow:r=>c.post(`${d}/${m(r)}/run`).then(s=>s.data),listSubscriptions:(r={})=>c.get(`${d}`,{params:r}).then(s=>N(s)),getSubscription:r=>c.get(`${d}/${m(r)}`).then(s=>s.data),createSubscription:r=>c.post(`${d}`,r).then(s=>s.data),updateSubscription:(r,s)=>c.put(`${d}/${m(r)}`,s).then(i=>i.data),deleteSubscription:r=>c.delete(`${d}/${m(r)}`).then(s=>s.data??{ok:!0}),listTemplates:()=>c.get(`${d}/defs`).then(r=>{const s=r==null?void 0:r.data;return Array.isArray(s)?s:(s==null?void 0:s.data)??[]}),testSend:r=>c.post(`${d}/${m(r)}/test`).then(s=>s.data)};function R(){const[r,s]=u.useState([]),[i,x]=u.useState([]),[v,S]=u.useState([]),[j,y]=u.useState(""),[g,f]=u.useState(!1),b={name:"",reportKey:"",frequency:"daily",timeOfDay:"09:00",dayOfWeek:1,dayOfMonth:1,monthOfYear:1,cron:"",format:"csv",filters:{},recipientsType:"role",roleId:"",userId:"",emails:[],active:!0},[n,o]=u.useState(b),w=async()=>{var t,a;try{y("");const[l,p,A]=await Promise.all([h.listDefs(),h.listSubs(),I.listRoles()]);s(l||[]),x(p||[]),S(A||[])}catch(l){y(((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to load")}};u.useEffect(()=>{w()},[]);const C=async()=>{var t,a;try{f(!0),y("");const l={...n,roleId:n.recipientsType==="role"&&Number(n.roleId)||null,userId:n.recipientsType==="user"&&Number(n.userId)||null},p=await h.createSub(l);x([p,...i]),o(b)}catch(l){y(((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to create subscription")}finally{f(!1)}},$=async t=>{confirm("Delete this subscription?")&&(await h.deleteSub(t),x(i.filter(a=>a.id!==t)))},k=async t=>{var a,l;try{await h.runNow(t),alert("Sent!")}catch(p){alert(((l=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:l.error)||"Failed to send")}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("header",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Staff Email Notifications"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Schedule reports to be emailed to staff by role or recipients."})]}),j&&e.jsx("div",{className:"text-sm text-rose-600",children:j}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"Name",value:n.name,onChange:t=>o(a=>({...a,name:t.target.value}))}),e.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:n.reportKey,onChange:t=>o(a=>({...a,reportKey:t.target.value})),children:[e.jsx("option",{value:"",children:"Select report…"}),r.map(t=>e.jsx("option",{value:t.key,children:t.name},t.key))]}),e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:n.format,onChange:t=>o(a=>({...a,format:t.target.value})),children:[e.jsx("option",{value:"csv",children:"CSV"}),e.jsx("option",{value:"xlsx",disabled:!0,children:"Excel (soon)"}),e.jsx("option",{value:"pdf",disabled:!0,children:"PDF (soon)"})]}),e.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:n.frequency,onChange:t=>o(a=>({...a,frequency:t.target.value})),children:[e.jsx("option",{children:"daily"}),e.jsx("option",{children:"weekly"}),e.jsx("option",{children:"monthly"}),e.jsx("option",{children:"quarterly"}),e.jsx("option",{children:"semiannual"}),e.jsx("option",{children:"annual"}),e.jsx("option",{children:"custom"})]}),e.jsx("input",{className:"rounded border px-3 py-2 text-sm",placeholder:"HH:mm",value:n.timeOfDay,onChange:t=>o(a=>({...a,timeOfDay:t.target.value}))}),n.frequency==="weekly"&&e.jsx("select",{className:"rounded border px-3 py-2 text-sm",value:n.dayOfWeek,onChange:t=>o(a=>({...a,dayOfWeek:Number(t.target.value)})),children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((t,a)=>e.jsx("option",{value:a,children:t},a))}),["monthly","quarterly","semiannual","annual"].includes(n.frequency)&&e.jsx("input",{type:"number",min:"1",max:"28",className:"rounded border px-3 py-2 text-sm",value:n.dayOfMonth,onChange:t=>o(a=>({...a,dayOfMonth:Number(t.target.value)})),placeholder:"Day of month"}),n.frequency==="annual"&&e.jsx("input",{type:"number",min:"1",max:"12",className:"rounded border px-3 py-2 text-sm",value:n.monthOfYear,onChange:t=>o(a=>({...a,monthOfYear:Number(t.target.value)})),placeholder:"Month (1..12)"}),n.frequency==="custom"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"CRON expression",value:n.cron,onChange:t=>o(a=>({...a,cron:t.target.value}))})]}),e.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-2",children:[e.jsxs("select",{className:"rounded border px-3 py-2 text-sm",value:n.recipientsType,onChange:t=>o(a=>({...a,recipientsType:t.target.value})),children:[e.jsx("option",{value:"role",children:"By role"}),e.jsx("option",{value:"user",children:"Specific user (ID)"}),e.jsx("option",{value:"emails",children:"Custom emails"})]}),n.recipientsType==="role"&&e.jsxs("select",{className:"rounded border px-3 py-2 text-sm md:col-span-2",value:n.roleId,onChange:t=>o(a=>({...a,roleId:t.target.value})),children:[e.jsx("option",{value:"",children:"Select role…"}),v.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),n.recipientsType==="user"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-2",placeholder:"User ID",value:n.userId,onChange:t=>o(a=>({...a,userId:t.target.value}))}),n.recipientsType==="emails"&&e.jsx("input",{className:"rounded border px-3 py-2 text-sm md:col-span-3",placeholder:"email1@example.com, email2@example.com",value:n.emails.join(", "),onChange:t=>o(a=>({...a,emails:t.target.value.split(",").map(l=>l.trim()).filter(Boolean)}))}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:!!n.active,onChange:t=>o(a=>({...a,active:t.target.checked}))}),"Active"]}),e.jsx("div",{className:"md:col-span-2 flex justify-end",children:e.jsx("button",{className:"px-3 py-2 rounded bg-blue-600 text-white",disabled:g,onClick:C,children:g?"Saving…":"Create subscription"})})]})]}),e.jsx("div",{className:"bg-white dark:bg-slate-900 border rounded-2xl p-4 overflow-auto",children:i.length===0?e.jsx("div",{className:"text-sm text-slate-500",children:"No subscriptions yet."}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-slate-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-4",children:"Name"}),e.jsx("th",{className:"py-2 pr-4",children:"Report"}),e.jsx("th",{className:"py-2 pr-4",children:"When"}),e.jsx("th",{className:"py-2 pr-4",children:"Recipients"}),e.jsx("th",{className:"py-2 pr-4",children:"Last / Next"}),e.jsx("th",{className:"py-2 pr-4",children:"Ops"})]})}),e.jsx("tbody",{children:i.map(t=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-2 pr-4",children:t.name}),e.jsx("td",{className:"py-2 pr-4",children:e.jsx("code",{className:"text-xs",children:t.reportKey})}),e.jsxs("td",{className:"py-2 pr-4",children:[t.frequency," @ ",t.timeOfDay]}),e.jsx("td",{className:"py-2 pr-4",children:t.recipientsType==="role"?`role #${t.roleId}`:t.recipientsType==="user"?`user #${t.userId}`:(t.emails||[]).join(", ")}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"text-xs",children:[e.jsxs("div",{children:["Last: ",t.lastRunAt?new Date(t.lastRunAt).toLocaleString():"—"]}),e.jsxs("div",{children:["Next: ",t.nextRunAt?new Date(t.nextRunAt).toLocaleString():"—"]})]})}),e.jsx("td",{className:"py-2 pr-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-2 py-1 rounded border",onClick:()=>k(t.id),children:"Send now"}),e.jsx("button",{className:"px-2 py-1 rounded border text-rose-700",onClick:()=>$(t.id),children:"Delete"})]})})]},t.id))})]})})]})}export{R as default};

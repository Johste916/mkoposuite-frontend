import{r as o,b as g,j as t,E as H,G as J,F as K}from"./index-BB9e1N5T.js";const A=s=>String(s||"").replace(/[_\-]+/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\s+/g," ").trim().replace(/^./,n=>n.toUpperCase()),P=s=>`TZS ${Number(s||0).toLocaleString()}`;function W(s){if(!s||!s.length)return"";const n=Array.from(s.reduce((l,x)=>(Object.keys(x||{}).forEach(h=>l.add(h)),l),new Set)),r=l=>{const x=l==null?"":String(l);return/[,"\n]/.test(x)?`"${x.replace(/"/g,'""')}"`:x};return[n.join(","),...s.map(l=>n.map(x=>r(l[x])).join(","))].join(`
`)}function X(s,n){let r=[],l=Array.isArray(n)?n.slice():[],x=typeof s=="object"&&s&&!Array.isArray(s)?s:{};return Array.isArray(s)?r=s:Array.isArray(s==null?void 0:s.rows)?r=s.rows:Array.isArray(s==null?void 0:s.items)?r=s.items:Array.isArray(s==null?void 0:s.buckets)?r=s.buckets:s&&typeof s=="object"&&(r=Object.entries(s).filter(([d])=>!["rows","items","buckets"].includes(d)).map(([d,u])=>({metric:A(d),value:u})),l.length||(l=[{key:"metric",label:"Metric"},{key:"value",label:"Value",fmt:d=>typeof d=="number"?P(d):String(d??"")}])),!l.length&&r&&r.length&&typeof r[0]=="object"&&(l=Object.keys(r[0]).slice(0,10).map(d=>({key:d,label:A(d)}))),{rows:Array.isArray(r)?r:[],columns:l,meta:x}}function Y(s,n){if(n!=null&&n.scope&&String(n.scope).trim())return String(n.scope);const r=[];if(r.push(s.branchId?`Branch #${s.branchId}`:"All branches"),r.push(s.officerId?`Officer #${s.officerId}`:"All officers"),r.push(s.borrowerId?`Borrower #${s.borrowerId}`:"All borrowers"),s.startDate||s.endDate){const l=s.startDate||"…",x=s.endDate||"…";r.push(`${l} → ${x}`)}else r.push("All time");return r.join(" · ")}function te({title:s="Report",endpoint:n,columns:r=[],exportCsvPath:l="",mode:x="auto"}){const[h,d]=o.useState(!1),[u,$]=o.useState(""),[I,C]=o.useState(null),D=new Date().toISOString().slice(0,10),[p,E]=o.useState(""),[b,B]=o.useState(""),[j,O]=o.useState(""),[y,R]=o.useState(""),[L,F]=o.useState(""),[f,v]=o.useState(""),[M,V]=o.useState([]),[z,U]=o.useState([]),[T,k]=o.useState([]);o.useEffect(()=>{(async()=>{try{const[{data:e},{data:i}]=await Promise.allSettled([g.get("/branches"),g.get("/users",{params:{role:"loan_officer",limit:200}})]).then(a=>a.map(m=>m.status==="fulfilled"?m.value:{data:[]}));V(Array.isArray(e)?e:(e==null?void 0:e.data)||[]),U(Array.isArray(i)?i:(i==null?void 0:i.data)||[])}catch{}})()},[]),o.useEffect(()=>{const e=f.trim();if(!e){k([]);return}const i=setTimeout(async()=>{try{const{data:a}=await g.get("/borrowers/search",{params:{q:e}});k(Array.isArray(a)?a.slice(0,8):[])}catch{k([])}},250);return()=>clearTimeout(i)},[f]);const N=o.useMemo(()=>({startDate:p||void 0,endDate:b||void 0,branchId:j||void 0,officerId:y||void 0,borrowerId:L||void 0}),[p,b,j,y,L]),S=async()=>{var e,i;if(n){d(!0),$("");try{const{data:a}=await g.get(n,{params:N});C(a)}catch(a){console.error("Report load error:",a),$(((i=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:i.error)||(a==null?void 0:a.message)||"Failed to load report"),C([])}finally{d(!1)}}};o.useEffect(()=>{S()},[n]);const{rows:w,columns:_,meta:c}=o.useMemo(()=>X(I,r),[I,r]),Z=o.useMemo(()=>Y(N,c),[N,c]),Q=()=>{if(l){const G=`https://mkoposuite-backend-42w2.onrender.com/api${l}`;window.open(G,"_blank","noopener,noreferrer");return}const e=W(w),i=new Blob([e],{type:"text/csv"}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=`${s.replace(/\s+/g,"_").toLowerCase()}_${new Date().toISOString().slice(0,10)}.csv`,a.click()},q=()=>{E(""),B(""),O(""),R(""),F(""),v("")};return t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold",children:s}),t.jsx("div",{className:"text-[12px] text-slate-500",children:Z})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:S,className:"inline-flex items-center gap-2 h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",title:"Refresh",children:[t.jsx(H,{className:h?"animate-spin":""}),"Refresh"]}),t.jsxs("button",{onClick:Q,className:"inline-flex items-center gap-2 h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",title:"Export CSV",children:[t.jsx(J,{})," Export"]})]})]})}),t.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Start"}),t.jsx("input",{type:"date",value:p,onChange:e=>E(e.target.value),max:b||D,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"End"}),t.jsx("input",{type:"date",value:b,onChange:e=>B(e.target.value),min:p||"",max:D,className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Branch"}),t.jsxs("select",{value:j,onChange:e=>O(e.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[t.jsx("option",{value:"",children:"All"}),M.map(e=>t.jsx("option",{value:e.id,children:e.name||`#${e.id}`},e.id))]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Officer"}),t.jsxs("select",{value:y,onChange:e=>R(e.target.value),className:"flex-1 px-3 py-2 text-sm rounded border bg-white dark:bg-slate-800",children:[t.jsx("option",{value:"",children:"All"}),z.map(e=>t.jsx("option",{value:e.id,children:e.name||e.email||`#${e.id}`},e.id))]})]}),t.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[t.jsx("label",{className:"w-24 text-sm text-slate-600 dark:text-slate-300",children:"Borrower"}),t.jsxs("div",{className:"relative flex-1",children:[t.jsx(K,{className:"absolute left-3 top-3 text-slate-400"}),t.jsx("input",{value:f,onChange:e=>v(e.target.value),placeholder:"Type to search borrowers…",className:"w-full pl-9 pr-3 py-2 text-sm rounded border bg-white dark:bg-slate-800"}),f&&T.length>0&&t.jsx("div",{className:"absolute z-10 mt-1 w-full bg-white dark:bg-slate-900 border rounded shadow max-h-56 overflow-auto",children:T.map(e=>t.jsxs("button",{type:"button",onClick:()=>{F(String(e.id)),v(e.name||e.phone||e.email||`Borrower #${e.id}`)},className:"w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800",children:[e.name||`Borrower #${e.id}`," ",t.jsx("span",{className:"opacity-60",children:e.phone||e.email||""})]},e.id))})]}),t.jsx("button",{onClick:()=>S(),className:"h-9 px-3 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Apply"}),t.jsx("button",{onClick:q,className:"h-9 px-3 rounded border hover:bg-slate-100 dark:hover:bg-slate-800",children:"Clear"})]})]})}),t.jsx("div",{className:"bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm",children:u?t.jsx("div",{className:"text-red-600 text-sm",children:u}):h?t.jsx("div",{className:"text-slate-500 text-sm",children:"Loading…"}):w.length===0?t.jsx("div",{className:"text-slate-500 text-sm",children:"No data."}):t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200",children:t.jsx("tr",{children:_.map(e=>t.jsx("th",{className:"px-3 py-2 text-left font-semibold",children:e.label||A(e.key)},e.key))})}),t.jsx("tbody",{children:w.map((e,i)=>t.jsx("tr",{className:"border-t border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/40",children:_.map(a=>{const m=e==null?void 0:e[a.key];return t.jsx("td",{className:"px-3 py-2",children:a.fmt?a.fmt(m,e):String(m??"")},a.key)})},i))})]})})}),((c==null?void 0:c.period)||(c==null?void 0:c.scope))&&t.jsxs("div",{className:"text-[12px] text-slate-500",children:[c!=null&&c.period?`Period: ${c.period}`:""," ",c!=null&&c.scope?`· Scope: ${c.scope}`:""]})]})}export{te as R};
